# 民泊予約・清掃管理 Webアプリ

Google Apps Script とスプレッドシートをバックエンドにした、民泊の予約・清掃管理 Webアプリです。スマホのブラウザから閲覧・操作できます。

## セットアップ手順

### 1. スプレッドシートの準備

1. Google スプレッドシートを開く
2. シート名を **「フォームの回答 1」** に設定
3. 1行目に以下のヘッダーが含まれていることを確認：
   - `チェックイン / Check-in`
   - `チェックアウト / Check-out`
   - `氏名 / Full Name`
   - `どこでこのホテルを予約しましたか？`
   - `バーベキューセットをご利用されますか？`
   - `宿泊人数` を含む列（例: `宿泊人数 / Number of Guests ※ 3才以下は除く...`）
   - `3才以下の乳幼児` を含む列（例: `3才以下の乳幼児の人数 / Number of infants under 3 years old`）
   - `清掃担当`（フォーム回答時は空欄、アプリで手入力・募集選定で反映）
   - 「有料駐車場」を含む列（例: `徒歩15分、有料駐車場を利用する方はお読みください`。回答: 利用しない / 有料駐車場 1台利用 / 有料駐車場 2台利用 → カレンダーに1台/2台/不要と表示）

### 2. GASプロジェクトの作成

1. スプレッドシートのメニューから **拡張機能** → **Apps Script**
2. デフォルトの `Code.gs` を、このフォルダの `Code.gs` の内容で置き換え
3. **+** をクリック → **HTML** を選択
4. ファイル名を `index` に設定
5. `index.html` の内容を、このフォルダの `index.html` の内容で置き換え

### 3. デプロイ

スタッフに権限承認を求めない場合は、**2つのデプロイ**を作成することを推奨します。

#### スタッフ用URL（権限承認不要）の作り方
1. Apps Scriptエディタで **デプロイ** → **新しいデプロイ**
2. 種類で **ウェブアプリ** を選択
3. 説明: 「スタッフ用」など
4. **次のユーザーとして実行**: **自分**
5. **アクセスできるユーザー**: **「Google アカウントを持つ全員」**
6. **デプロイ** をクリック
7. **ウェブアプリのURL** が表示されます（例: `https://script.google.com/macros/s/xxxxx/exec`）
8. このURLの**末尾に `?staff=1` を付けたもの**をスタッフに共有してください
   - 例: `https://script.google.com/macros/s/xxxxx/exec` → `https://script.google.com/macros/s/xxxxx/exec?staff=1`
   - スタッフは画面上部で名前を選択してから立候補できます（権限同意画面は表示されません）
9. 設定タブの「スタッフ用URL」欄に上記URLを貼り付け「保存」→「コピー」でLINE等に共有できます
10. **重要**: スタッフが立候補するには、あらかじめオーナーが設定タブで「清掃スタッフ」に登録しておく必要があります

**「?staff=1」は必要ですか？** はい。スタッフ用デプロイのURLには `?staff=1` を付けてください。これがないとスタッフがオーナー画面として表示され、立候補ボタンが出ない場合があります。

#### オーナー・サブオーナー用URL（設定画面用）
1. もう1つ **デプロイ** → **新しいデプロイ** を作成
2. 種類で **ウェブアプリ** を選択
3. 説明: 「オーナー用」など
4. **次のユーザーとして実行**: **アクセスしているユーザー**
5. **アクセスできるユーザー**: 「自分」または組織内のみ
6. **デプロイ** をクリック
7. このURLをオーナー・サブオーナーが使用。初回のみ権限承認が必要です。

※1つのデプロイのみで運用する場合は「アクセスしているユーザー」にしてください。スタッフにも初回の権限承認が必要になります。

### 4. コードを更新したときの反映方法

コード（`Code.gs` や `index.html`）を変更したあと、次のどちらかで反映できます。

---

#### 方法A: 手動で更新する（ツール不要・おすすめ）

**Node.js や clasp などの追加ツールは一切不要**です。ブラウザとメモ帳だけで更新できます。

1. **Code.gs を更新する場合**
   - ローカルの `Code.gs` をメモ帳などで開き、内容をすべて選択（Ctrl+A）してコピー
   - スプレッドシート → **拡張機能** → **Apps Script** を開く
   - 左の一覧で `Code.gs` をクリック
   - エディタ内をすべて選択して、コピーした内容で貼り付け
   - Ctrl+S（Mac: ⌘+S）で保存

2. **index.html を更新する場合**
   - ローカルの `index.html` を開き、同様にすべてコピー
   - Apps Script で左の一覧の `index.html` をクリック
   - 内容を貼り付けて保存

3. **デプロイを更新する**
   - 画面上部の **デプロイ** → **デプロイを管理** をクリック
   - オーナー用の行の右側にある **編集**（ペンアイコン）をクリック
   - **バージョン** で「新バージョン」を選び、説明（例: 更新日）を入力して **デプロイ**
   - 同様にスタッフ用の行でも「編集」→「新バージョン」→「デプロイ」
   - ※ 既存デプロイの「編集」で新バージョンを選ぶと、**URLは変わりません**。スタッフに共有したURLはずっと使えます。「新しいデプロイ」で新規作成するとURLが変わってしまうので注意

4. **スタッフ用URL（?staff=1 付き）**
   - デプロイ管理画面でスタッフ用の「ウェブアプリのURL」をコピー
   - 末尾に `?staff=1` がなければ付けて、オーナー画面の **設定** タブ「スタッフ用URL」に貼り付けて保存

---

#### 方法B: 自動デプロイ（Node.js と clasp を使用）

Node.js などのツールを入れて、コマンド一発で更新したい場合のみ。**必須ではありません**。

<details>
<summary>▶ 自動デプロイの手順（クリックで展開）</summary>

#### 初回セットアップ（1回だけ）

##### ステップ 1: Node.js のインストールと確認

**インストール手順**

1. ブラウザで https://nodejs.org/ を開く
2. **LTS**（推奨版）の「ダウンロード」ボタンをクリック  
   - 例: 「22.x.x LTS」や「20.x.x LTS」
3. ダウンロードした `.msi`（Windows）または `.pkg`（Mac）を実行
4. インストーラーの指示に従い、デフォルト設定のまま「次へ」で進め、最後に「インストール」
5. インストール完了後、一度 PC を再起動するか、開いているターミナルを閉じて開き直す

**動作確認**

1. **コマンドプロンプト** または **PowerShell** を開く  
   - Windows: スタートメニューで「cmd」または「PowerShell」と入力して起動  
   - フォルダ内で開く: エクスプローラーで任意のフォルダを開き、アドレス欄に `cmd` と入力して Enter
2. 次のコマンドを入力して Enter:
   ```
   node -v
   ```
3. `v22.11.0` のようにバージョン番号が表示されれば成功  
   - 「'node' は認識されていません」と出る場合は、再起動してもう一度試すか、インストールをやり直す
4. あわせて `npm` も確認:
   ```
   npm -v
   ```
   - `10.x.x` のように番号が表示されればOK（npm は Node.js に同梱されています）

##### ステップ 2: clasp のログイン

**用語の説明**

| 用語 | 意味 |
|------|------|
| **clasp** | パソコンから Google Apps Script を操作するためのツール。「コマンド」で Google のサービスに接続し、コードのアップロードなどができる |
| **ログイン** | ここでは「clasp をあなたの Google アカウントに紐づける」こと。紐づけることで、このパソコンからあなたの GAS プロジェクトを操作できるようになる |
| **フォルダ** | ファイルをまとめて入れておく場所。エクスプローラー（Windows）や Finder（Mac）で開く「箱」のこと |
| **コマンド** | パソコンに文字で指示を出す方法。例: `node -v` は「Node.js のバージョンを教えて」という指示 |
| **ターミナル** | コマンドを入力するための画面。Windows では「コマンドプロンプト」や「PowerShell」、Mac では「ターミナル」という名前 |
| **npm install** | このフォルダに書かれた「必要なツール」をインターネットからダウンロードして用意するコマンド |
| **npx clasp login** | clasp を使って、Google アカウントと接続する（ログインする）コマンド |

---

**手順**

**2-1. minpaku-gas-app フォルダを開く**

1. エクスプローラー（Windows）または Finder（Mac）を開く
2. 次のような場所にある **minpaku-gas-app** フォルダを探して開く:
   - 例（Windows）: `C:\Users\あなたの名前\AndroidStudioProjects\NotifyInbox\minpaku-gas-app`
   - 中に `Code.gs` や `index.html` というファイルがあるはずです
3. そのフォルダを開いた状態にする（フォルダの中身が見えている状態）

**2-2. ターミナル（コマンド入力画面）を開く**

このフォルダに対してコマンドを実行するため、**このフォルダの場所で**ターミナルを開きます。

- **方法A（Windows）**: エクスプローラーで minpaku-gas-app フォルダを開いた状態で、画面上部のアドレス欄（パスが表示されているところ）をクリックして `cmd` と入力し、Enter を押す。黒い画面（コマンドプロンプト）が開く
- **方法B（VS Code / Cursor を使っている場合）**: minpaku-gas-app フォルダを開いた状態で、メニュー「ターミナル」→「新しいターミナル」をクリック
- **方法C（Mac）**: Finder でフォルダを開いた状態で、メニュー「サービス」→「ターミナルで開く」（または、ターミナルを開いて `cd` コマンドでそのフォルダに移動）

開いたターミナルに、フォルダのパスが表示されていればOKです。

**2-3. 必要なツールをインストールする**

1. ターミナルに次のように入力し、Enter を押す:
   ```
   npm install
   ```
2. 数十秒〜数分かかることがあります。途中でいろいろな文字が流れますが、そのまま待つ
3. 最後まで完了すると、またコマンドを入力できる状態（`>` や `$` が表示されている）に戻る
4. エラーが出ずに終わっていれば成功

**2-4. clasp で Google にログインする**

1. ターミナルに次のように入力し、Enter を押す:
   ```
   npx clasp login
   ```
2. 自動でブラウザが開き、Google のログイン画面が表示される
3. この民泊アプリを管理している **Google アカウント**でログインする
4. 「このアプリは確認されていません」と出た場合は「詳細」→「〇〇（安全ではないページ）に移動」をクリック
5. 「〇〇が次の権限をリクエストしています」の画面で **許可** をクリック
6. ブラウザに「認証が完了しました。このウィンドウは閉じてかまいません。」と表示される
7. ターミナルに戻ると、「Authorization successful.」（認証成功）と表示されていれば完了

##### ステップ 3: スクリプトIDの取得と .clasp.json の作成

1. スプレッドシートから **拡張機能** → **Apps Script** を開く
2. ブラウザのアドレスバーを確認。URL は以下のような形式:
   ```
   https://script.google.com/home/projects/【ここがスクリプトID】/edit
   ```
3. `projects/` と `/edit` の間の英数字の文字列が **スクリプトID**（例: `1A2B3c4D5e6F...`）
4. minpaku-gas-app フォルダ内の `.clasp.json.sample` をコピーし、`.clasp.json` という名前で保存
5. `.clasp.json` を開き、`"ここにスクリプトIDを貼り付け"` の部分を、コピーしたスクリプトIDに書き換える  
   例: `"scriptId": "1A2B3c4D5e6F..."`
6. 保存して閉じる

##### ステップ 4: デプロイIDの取得と deploy-config.json の作成

1. Apps Script エディタで **デプロイ** → **デプロイを管理** をクリック
2. 一覧にオーナー用・スタッフ用のデプロイがあることを確認
3. 各行の **デプロイID** をコピー:
   - 「ウェブアプリ」と書かれた行の右側に **ID** 列がある
   - オーナー用（実行: アクセスしているユーザー）の ID をコピー
   - スタッフ用（実行: 自分）の ID をコピー
4. **別の方法**: minpaku-gas-app フォルダで `npx clasp deployments` を実行すると、ターミナルにデプロイ一覧が表示される
5. `deploy-config.sample.json` をコピーし、`deploy-config.json` という名前で保存
6. `deploy-config.json` を開き、次のように編集:
   - `"ownerDeploymentId"`: オーナー用のデプロイID（ダブルクォートで囲む）
   - `"staffDeploymentId"`: スタッフ用のデプロイID（ダブルクォートで囲む）
7. 例:
   ```json
   {
     "ownerDeploymentId": "AKfycbx1234...",
     "staffDeploymentId": "AKfycbx5678..."
   }
   ```
8. 保存して閉じる

##### ステップ 5: （任意）スタッフURL自動反映のためのシークレット設定

デプロイのたびにスタッフ用URLをオーナー画面に自動反映するには、次のどちらかを行います。

**方法A（推奨）: シークレットを設定する（セキュリティ向上）**

1. Apps Script エディタで `Code.gs` を開く
2. `setupDeploySecret` 関数内の `'mySecret123'` を任意の文字列（例: `'abcXYZ99'`）に変更
3. メニュー **実行** → **関数を実行** → `setupDeploySecret` を選択して実行
4. 実行ログに「urlUpdateSecret を設定しました」と出ればOK
5. `deploy-config.json` に `urlUpdateSecret` を追加（`setupDeploySecret` で設定したのと同じ値）:
   ```json
   {
     "ownerDeploymentId": "AKfycbx1234...",
     "staffDeploymentId": "AKfycbx5678...",
     "urlUpdateSecret": "abcXYZ99"
   }
   ```

**方法B: シークレットを設定しない**

- そのままでも、`npm run deploy` 実行時にスタッフURLの自動反映を試みます（GAS 側でシークレットが未設定の場合は成功します）

##### ステップ 6: 動作確認

1. minpaku-gas-app フォルダで以下を実行:
   ```
   npm run deploy
   ```
2. 「コードをプッシュしています...」「オーナー用デプロイを更新...」「スタッフ用デプロイを更新...」の順に進行する
3. 「スタッフ用URLを設定タブに反映しました。」と表示されれば成功
4. オーナー用URLでアプリを開き、**設定** タブ → 「スタッフ用URL」欄にスタッフ用URL（`?staff=1` 付き）が入っているか確認

#### デプロイの実行

コードを変更したあと、次のコマンドで両方のデプロイを更新します:

```
npm run deploy
```

1. ローカルの Code.gs と index.html が GAS にプッシュされる  
2. オーナー用デプロイが更新される  
3. スタッフ用デプロイが更新される  
4. スタッフ用URL（末尾 `?staff=1` 付き）がオーナー画面の設定タブに自動で反映される

**URLは変わりません**: `deploy-config.json` に同じデプロイIDを指定している限り、`npm run deploy` は既存のデプロイを**更新**するだけです。URLは初回デプロイ時と同じままなので、スタッフに共有したURLはずっと使えます。新規デプロイを作らず、常に同じIDへ上書きするためです。

</details>

---

### 5. オーナー・スタッフ・設定（すべてWebアプリで編集）

1. 初回は **設定** タブでオーナーメールとパスワード（6文字以上）を入力し「登録」してください。以降はそのメールでログインしたユーザーのみ設定画面にアクセスできます。
2. オーナーメールの変更には、現在のパスワード入力が必要です。
3. オーナー・清掃スタッフ・仕事内容・報酬・募集設定は、すべてWebアプリの **設定** タブから追加・編集・削除できます。

### 6. 募集の自動告知・リマインド用トリガー（任意）

予約が入ったときの「4週間前から募集開始」と「立候補が少ないときの1週間おきリマインド」を自動で行うには、時間ベースのトリガーを設定してください。

1. Apps Script エディタで **トリガー**（時計アイコン）を開く
2. **トリガーを追加**
3. 関数: **`checkAndCreateRecruitments`**、イベント: **時間主導型**、時間: **日タイマー**、時刻: 例 6:00〜7:00
4. もう1つ追加: 関数 **`checkAndSendReminders`**、イベント: **時間主導型**、時間: **日タイマー**、時刻: 例 7:00〜8:00
5. 保存すると、毎日その時刻に「4週間後のチェックアウト」の募集作成・告知と、リマインド送信が実行されます。
6. **予約連携の自動同期（任意）**: 設定でiCal URLを登録している場合、トリガーで **`syncFromICal`** を日次実行すると、Airbnb・Booking.comの予約を自動取り込みできます。

### 7. ホーム画面に追加（スマホ）

- **iPhone**: SafariでURLを開く → 共有 → 「ホーム画面に追加」
- **Android**: ChromeでURLを開く → メニュー → 「ホーム画面に追加」

## ファイル構成

| ファイル | 説明 |
|---------|------|
| `Code.gs` | バックエンド（予約取得・清掃更新・オーナー設定・募集・告知・リマインド） |
| `index.html` | フロントエンド（FullCalendar + Bootstrap 5、カレンダー／募集／設定） |
| `package.json` | clasp とデプロイスクリプト用 |
| `deploy.js` | オーナー用・スタッフ用デプロイを一括実行するスクリプト |
| `.clasp.json` | clasp 設定（scriptId）。※ `.clasp.json.sample` をコピーして作成 |
| `deploy-config.json` | デプロイID（owner / staff）。※ `deploy-config.sample.json` をコピーして作成 |
| `README.md` | このファイル |

## 機能

- **カレンダー**: 月表示で宿泊（青）・清掃（緑）を色分け。宿泊人数は「大○名,3歳以下○名」、清掃はフルネーム（カンマ区切り）で表示。
- **イベントタップ**: 詳細モーダル表示。オーナーは「清掃担当を編集」で手入力・保存可能。
- **募集タブ**: 募集中の清掃日一覧。スタッフは「立候補する」、オーナーは「選定」で担当者を選びカレンダーに反映。
- **設定タブ（オーナー・サブオーナーのみ）**  
  - オーナーメールの設定  
  - サブオーナーの追加・削除（オーナーと同等の権限、複数可。表示名で現在のアカウントを判別）  
  - 清掃スタッフの追加・削除（名前・住所・メール・振込先：金融機関・支店・口座種類・口座番号・口座名義）  
  - 仕事内容の追加・削除（1名で清掃、2名で清掃、コインランドリー交通費／実費、直前点検など）  
  - スタッフごと・仕事内容ごとの報酬設定  
  - 募集設定（募集開始週数・最少回答者数・リマインド間隔週・選定人数）
- **自動告知**: フォーム送信時および日次トリガーで、4週間後のチェックアウト日に対する募集を作成し、スタッフにメール告知。立候補が設定「最少回答者数」未満のとき、設定「リマインド間隔週」ごとにリマインドメールを送信。
- **予約連携（Airbnb・Booking.com）**  
  - 設定タブの「予約連携」でiCal URLを登録し、「今すぐ同期」で予約を取り込み。宿泊日程・人数・氏名・サイトをカレンダーに反映。  
  - 宿泊者がフォームで詳細入力（大人人数・3歳以下人数・BBQ・有料駐車場）すると、同じチェックイン・チェックアウトの既存予約に自動マージ。  
  - カレンダー上の「予約を追加」で手動登録も可能。
- **スマホ対応**: viewport・タッチ最適化済み。
