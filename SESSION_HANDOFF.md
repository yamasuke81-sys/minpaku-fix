# セッション引き継ぎファイル

> **最終更新**: 2026-02-16
> **作業ブランチ**: `claude/setup-deployment-rules-EbLOg`
> **最新コミット**: `6fef543 docs: 引き継ぎ資料を最新状態に更新（要補充タブ改善・バグ修正）`
> **前回の開発ブランチ**: `claude/update-handoff-docs-897D8`

---

## 必須ルール（全セッション共通・厳守）

### ルール1: 変更プッシュ後は毎回デプロイ手順を表示すること

コードを変更してプッシュしたら、**必ず毎回**以下のデプロイコマンドを表示する。
ブランチ名は、**現在の作業ブランチに合わせて随時書き換えること**。
チェックアプリ（`checklist-app/`）に変更がある場合も `deploy-all.js` で両方デプロイされるので同じコマンドでOK。

```
cd C:\Users\yamas\minpaku-fix && git fetch origin && git checkout -f <現在の作業ブランチ名> && git reset --hard origin/<現在の作業ブランチ名> && node deploy-all.js
```

**現時点のコマンド:**
```
cd C:\Users\yamas\minpaku-fix && git fetch origin && git checkout -f claude/setup-deployment-rules-EbLOg && git reset --hard origin/claude/setup-deployment-rules-EbLOg && node deploy-all.js
```

### ルール2: チャット行数が5000行を超えたら移行を提案すること

チャットの行数が **5000行を超えた時点** で、次のチャットへの移行をユーザーに提案する。
移行時には以下を実行：
1. `SESSION_HANDOFF.md` を最新状態に更新（完了作業・未完了事項・コミット履歴）
2. `HANDOFF.md` も必要に応じて更新
3. コミット＆プッシュ

### ルール3: 常に日本語で応答すること

---

## チャット移行の手順

### 旧チャット側（移行前）がやること

1. 作業中のコードをすべてコミット＆プッシュ
2. `SESSION_HANDOFF.md` を以下の内容で更新：
   - 完了した作業の一覧
   - 未完了・作業中のタスク
   - 最新コミットハッシュとブランチ名
   - 注意点・ハマったポイント
3. `HANDOFF.md` のコミット履歴・完了作業セクションを最新化
4. 更新をコミット＆プッシュ

### 新チャット側がやること

**ステップ1: 引き継ぎ資料を読む**
```
SESSION_HANDOFF.md を読んでください
HANDOFF.md を読んでください
```

**ステップ2: ブランチとコードの状態を確認**
```
git fetch origin <作業ブランチ>
git log origin/<作業ブランチ> --oneline -10
```

**ステップ3: 疑問点を洗い出し、前のチャットへの質問プロンプトを作成**

引き継ぎ資料を読んだ後、不明点や確認事項があれば、以下のような形式で **前のチャットに貼り付けるための質問プロンプト** を書き出す：

```
前のチャットで以下を確認してください：

1. 「〇〇の実装」について、△△の部分はこの理解で合っていますか？
2. □□の機能は完了していますか？テスト済みですか？
3. ××のエラーが出ていましたが、解決済みですか？
4. この部分を変更しても他に影響はありませんか？
```

ユーザーはこのプロンプトをコピーして前のチャットに貼り付け、回答を得てから新チャットに戻って開発を継続する。

**ステップ4: 開発を開始**

疑問が解消されたら、通常の開発作業を開始する。

---

## 必須デプロイコマンド（ユーザーのWindows PCで実行）

```
cd C:\Users\yamas\minpaku-fix && git fetch origin && git checkout -f claude/setup-deployment-rules-EbLOg && git reset --hard origin/claude/setup-deployment-rules-EbLOg && node deploy-all.js
```

---

## 今回のセッションで完了した作業

（このセッションではまだコード変更なし。ブランチ統合のみ実施。）

---

## 過去セッションで完了した主な作業

### メインアプリ

1. **清掃ステータスマーク修正** - スタッフ確定後にカレンダーのステータスドットが即座に緑に変わるよう修正。`applyConfirmOptimistic()` による楽観的キャッシュ更新（4回の修正を経た最終版）
2. **宿泊人数編集機能** - オーナー宿泊詳細画面に宿泊人数の編集ボタンを追加
3. **凡例マーク変更** - 「日付背景-募集中」を「赤丸」の凡例に統合

### チェックリストアプリ

1. **UI全面改修** - タブ上部移動、漏れチェック統合、メモ自動保存、項目名タッチ、見本写真サムネイル
2. **カテゴリ操作** - 4階層対応、カテゴリ名変更(✎)、カテゴリ削除(✕)、全展開/全折りたたみ
3. **並び替え機能** - 項目のドラッグ並び替え（長押し600ms）、カテゴリ間移動、UNDO機能
4. **要補充タブ改善** - 大カテゴリ名バッジ+「表示」ボタン、要補充解除時のタブ連動削除
5. **メモ機能** - チェック項目ごとのメモ入力・保存
6. **バグ修正多数** - GAS同時実行数制御、チェック復活バグ、カテゴリ順序維持など

---

## 未完了・要確認事項

### 要テスト（デプロイ後）

1. **清掃ステータスマーク修正の実機テスト**
   - 特に「スタッフ一覧にない名前を手入力」→「スタッフ確定」のフロー
   - カレンダーのドットが即座に赤→緑に変わるか

2. **チェックリスト新機能の動作確認**
   - 全展開/全折りたたみボタン
   - カテゴリ名変更（✎）
   - カテゴリ削除（✕）：中身削除 or 親に移動

### 未解決の既存問題

3. **2/23 日付の黄色背景問題** - スプレッドシートのデータ問題の可能性
4. **見本写真の日付非依存** - 実装済みだが実環境テスト未了

### 将来の課題
- 条件分岐対応（BBQ利用あり/なし、宿泊人数による表示切替）
- 在庫管理リスト機能
- リネン洗濯フロー管理

---

## 主要ファイル構成

| ファイル | 行数（概算） | 役割 |
|----------|-------------|------|
| `Code.gs` | ~6927行 | メインアプリ（予約管理）サーバー |
| `index.html` | ~6530行 | メインアプリ フロントエンド |
| `checklist-app/Code.gs` | ~2176行 | チェックリストアプリ サーバー |
| `checklist-app/checklist.html` | ~3860行 | チェックリストアプリ フロントエンド |
| `deploy-all.js` | ~219行 | 一括デプロイスクリプト |
| `HANDOFF.md` | ~460行 | プロジェクト全体の技術資料 |

---

## 技術的な注意点

### 清掃ステータスマークの仕組み（重要）
```
カレンダーのステータスドット色:
- 赤(recruiting): 募集中で未確定
- 緑(decided): スタッフ確定済み or 選定済 or cleaningStaff設定済み

データフロー:
1. loadAndRender() → getRecruitmentStatusMap() → window._recruitFullMap
2. buildCalendarEvents() で recruitMap[b.rowNumber].status をチェック
3. 確定時に applyConfirmOptimistic() で楽観的にキャッシュ更新＋カレンダー再描画
```

### カテゴリの区切り文字
- 全角コロン `：`（U+FF1A）を使用
- 例: `テラス：次の予約がBBQ利用あり：↓セット内容↓`

### レンダリングの仕組み
- `buildCategoryTree()` が全アイテムをツリー構造に変換
- `renderCategoryNode()` が再帰的にHTMLを生成
- レベル0=`.section`（濃紺）、1=`.sub-section`（薄青）、2=`.sub-sub-section`（オレンジ）、3=`.sub-sub-sub-section`（紫）
