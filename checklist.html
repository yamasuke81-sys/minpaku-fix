<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>æ¸…æƒãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      background: #f5f5f5;
      color: #333;
      padding-bottom: 80px;
      -webkit-tap-highlight-color: transparent;
    }

    /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
    .header {
      background: #2c3e50;
      color: white;
      padding: 12px 16px;
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .header-title { font-size: 18px; font-weight: bold; margin-bottom: 4px; }
    .header-date { font-size: 14px; opacity: 0.9; }
    .progress-bar {
      height: 6px;
      background: rgba(255,255,255,0.2);
      border-radius: 3px;
      margin-top: 8px;
      overflow: hidden;
    }
    .progress-fill {
      height: 100%;
      background: #27ae60;
      transition: width 0.3s;
      border-radius: 3px;
    }

    /* æ¬¡å›äºˆç´„æƒ…å ± */
    .booking-info {
      background: white;
      margin: 12px;
      padding: 16px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .booking-info h3 {
      font-size: 16px;
      color: #2c3e50;
      margin-bottom: 12px;
      padding-bottom: 8px;
      border-bottom: 2px solid #3498db;
    }
    .booking-row {
      display: flex;
      padding: 6px 0;
      font-size: 14px;
    }
    .booking-label {
      font-weight: bold;
      min-width: 100px;
      color: #555;
    }
    .booking-value {
      flex: 1;
      color: #333;
    }

    /* ã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆéƒ¨å±‹ã”ã¨ï¼‰ */
    .section {
      background: white;
      margin: 8px 12px;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 4px rgba(0,0,0,0.08);
    }
    .section-header {
      padding: 14px 16px;
      background: #ecf0f1;
      display: flex;
      align-items: center;
      cursor: pointer;
      user-select: none;
      -webkit-user-select: none;
      transition: background 0.2s;
    }
    .section-header:active {
      background: #d5dbdd;
    }
    .section-header.has-missing {
      background: #ffe6e6;
    }
    .section-icon {
      font-size: 20px;
      margin-right: 8px;
      transition: transform 0.3s;
    }
    .section-header.collapsed .section-icon {
      transform: rotate(-90deg);
    }
    .section-title {
      flex: 1;
      font-size: 16px;
      font-weight: bold;
      color: #2c3e50;
    }
    .section-title.missing {
      color: #e74c3c;
    }
    .section-count {
      font-size: 13px;
      color: #7f8c8d;
      margin-left: 8px;
    }
    .section-body {
      max-height: 2000px;
      overflow: hidden;
      transition: max-height 0.3s ease-out;
    }
    .section-body.collapsed {
      max-height: 0;
    }

    /* ãƒã‚§ãƒƒã‚¯é …ç›® */
    .checklist-item {
      padding: 12px 16px;
      border-bottom: 1px solid #ecf0f1;
      display: flex;
      align-items: flex-start;
      gap: 12px;
    }
    .checklist-item:last-child {
      border-bottom: none;
    }
    .item-checkbox {
      width: 24px;
      height: 24px;
      min-width: 24px;
      cursor: pointer;
      margin-top: 2px;
    }
    .item-content {
      flex: 1;
    }
    .item-name {
      font-size: 15px;
      color: #333;
      line-height: 1.5;
    }
    .item-name.missing {
      color: #e74c3c;
      font-weight: bold;
    }
    .supply-checkbox-container {
      margin-top: 6px;
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 13px;
      color: #7f8c8d;
    }
    .supply-checkbox {
      width: 18px;
      height: 18px;
      cursor: pointer;
    }

    /* æ’®å½±ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
    .photo-section {
      background: white;
      margin: 8px 12px;
      padding: 16px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.08);
    }
    .photo-section h3 {
      font-size: 16px;
      color: #2c3e50;
      margin-bottom: 12px;
      padding-bottom: 8px;
      border-bottom: 2px solid #e67e22;
    }
    .photo-spot {
      margin-bottom: 16px;
      padding: 12px;
      background: #fafafa;
      border-radius: 6px;
    }
    .photo-spot-name {
      font-size: 14px;
      font-weight: bold;
      margin-bottom: 8px;
      color: #2c3e50;
    }
    .photo-spot-name.missing {
      color: #e74c3c;
    }
    .photo-timing-group {
      margin-bottom: 12px;
    }
    .photo-timing-label {
      font-size: 13px;
      color: #555;
      margin-bottom: 6px;
      font-weight: bold;
    }
    .photo-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
      gap: 8px;
      margin-bottom: 8px;
    }
    .photo-thumb {
      width: 100%;
      padding-bottom: 100%;
      background-size: cover;
      background-position: center;
      border-radius: 4px;
      border: 1px solid #ddd;
    }
    .photo-upload-btn {
      padding: 8px 12px;
      background: #3498db;
      color: white;
      border: none;
      border-radius: 4px;
      font-size: 13px;
      cursor: pointer;
      width: 100%;
    }
    .photo-upload-btn:active {
      background: #2980b9;
    }

    /* è¦è£œå……ãƒªã‚¹ãƒˆ */
    .supply-list {
      background: #fff3cd;
      margin: 8px 12px;
      padding: 16px;
      border-radius: 8px;
      border-left: 4px solid #ffc107;
    }
    .supply-list h3 {
      font-size: 16px;
      color: #856404;
      margin-bottom: 12px;
    }
    .supply-item {
      padding: 6px 0;
      font-size: 14px;
      color: #856404;
    }
    .supply-item:before {
      content: "âš ï¸ ";
    }

    /* ãƒ¡ãƒ¢ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
    .memo-section {
      background: white;
      margin: 8px 12px;
      padding: 16px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.08);
    }
    .memo-section h3 {
      font-size: 16px;
      color: #2c3e50;
      margin-bottom: 12px;
    }
    .memo-list {
      margin-bottom: 12px;
    }
    .memo-item {
      background: #f8f9fa;
      padding: 10px;
      border-radius: 4px;
      margin-bottom: 8px;
      font-size: 14px;
    }
    .memo-meta {
      font-size: 12px;
      color: #7f8c8d;
      margin-top: 4px;
    }
    .memo-input-group {
      display: flex;
      gap: 8px;
    }
    .memo-input {
      flex: 1;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
    }
    .memo-btn {
      padding: 10px 16px;
      background: #3498db;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      white-space: nowrap;
    }

    /* ãƒœãƒˆãƒ ãƒãƒ¼ */
    .bottom-bar {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: white;
      padding: 12px;
      box-shadow: 0 -2px 8px rgba(0,0,0,0.1);
      display: flex;
      gap: 8px;
      z-index: 99;
    }
    .btn {
      flex: 1;
      padding: 14px;
      border: none;
      border-radius: 6px;
      font-size: 15px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s;
    }
    .btn-check {
      background: #e67e22;
      color: white;
    }
    .btn-check:active {
      background: #d35400;
    }
    .btn-complete {
      background: #27ae60;
      color: white;
    }
    .btn-complete:active {
      background: #229954;
    }
    .btn-complete:disabled {
      background: #95a5a6;
      cursor: not-allowed;
    }

    /* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° */
    .loading {
      text-align: center;
      padding: 40px 20px;
      color: #7f8c8d;
    }

    /* ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ */
    .hidden { display: none !important; }

    input[type="file"] {
      display: none;
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="header-title">æ¸…æƒãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ</div>
    <div class="header-date" id="headerDate"></div>
    <div class="progress-bar">
      <div class="progress-fill" id="progressFill" style="width: 0%"></div>
    </div>
  </div>

  <div id="loadingArea" class="loading">èª­ã¿è¾¼ã¿ä¸­...</div>

  <div id="contentArea" class="hidden">
    <!-- æ¬¡å›äºˆç´„æƒ…å ± -->
    <div id="bookingInfo" class="booking-info hidden"></div>

    <!-- è¦è£œå……ãƒªã‚¹ãƒˆ -->
    <div id="supplyList" class="supply-list hidden"></div>

    <!-- ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ -->
    <div id="checklistContainer"></div>

    <!-- æ’®å½±ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
    <div id="photoSection" class="photo-section hidden"></div>

    <!-- ãƒ¡ãƒ¢ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
    <div id="memoSection" class="memo-section">
      <h3>ğŸ“ ç‰¹è¨˜äº‹é …ãƒ»å‚™å“ä¸è¶³ãªã©</h3>
      <div id="memoList" class="memo-list"></div>
      <div class="memo-input-group">
        <input type="text" id="memoInput" class="memo-input" placeholder="å‚™å“ä¸è¶³ã‚„ãƒ¡ãƒ¢ã‚’å…¥åŠ›...">
        <button id="memoBtn" class="memo-btn">é€ä¿¡</button>
      </div>
    </div>
  </div>

  <!-- ãƒœãƒˆãƒ ãƒãƒ¼ -->
  <div class="bottom-bar">
    <button id="btnCheckMissing" class="btn btn-check">æ¼ã‚Œãƒã‚§ãƒƒã‚¯</button>
    <button id="btnComplete" class="btn btn-complete">æ¸…æƒå®Œäº†</button>
  </div>

  <!-- éè¡¨ç¤ºã®ãƒ•ã‚¡ã‚¤ãƒ«å…¥åŠ› -->
  <input type="file" id="photoInput" accept="image/*" capture="environment">

  <script>
    // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
    var checkoutDate = '<?= checkoutDate ?>' || '';
    var staffName = '<?= staffName ?>' || '';
    var checklistData = null;
    var bookingData = null;
    var missingCheckActive = false;

    // åˆæœŸåŒ–
    window.onload = function() {
      if (!checkoutDate) {
        alert('ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆæ—¥ãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“');
        return;
      }
      document.getElementById('headerDate').textContent = checkoutDate;
      loadData();

      // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
      document.getElementById('btnCheckMissing').addEventListener('click', toggleMissingCheck);
      document.getElementById('btnComplete').addEventListener('click', completeChecklist);
      document.getElementById('memoBtn').addEventListener('click', addMemo);
      document.getElementById('photoInput').addEventListener('change', handlePhotoUpload);
    };

    function loadData() {
      Promise.all([
        callGAS('getNextBookingDetails', [checkoutDate]),
        callGAS('getChecklistForDate', [checkoutDate])
      ]).then(function(results) {
        var bookingRes = results[0];
        var checklistRes = results[1];

        if (bookingRes.success) {
          bookingData = bookingRes.booking;
          renderBookingInfo();
        }

        if (checklistRes.success) {
          checklistData = checklistRes;
          renderChecklist();
          renderPhotoSection();
          renderMemos();
          renderSupplyList();
          updateProgress();
        } else {
          alert('ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + checklistRes.error);
        }

        document.getElementById('loadingArea').classList.add('hidden');
        document.getElementById('contentArea').classList.remove('hidden');
      }).catch(function(err) {
        alert('ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + err);
      });
    }

    function renderBookingInfo() {
      if (!bookingData) return;
      var html = '<h3>ğŸ“… æ¬¡å›äºˆç´„è©³ç´°</h3>';
      html += '<div class="booking-row"><span class="booking-label">ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³</span><span class="booking-value">' + escapeHtml(bookingData.checkIn) + '</span></div>';
      html += '<div class="booking-row"><span class="booking-label">ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ</span><span class="booking-value">' + escapeHtml(bookingData.checkOut) + '</span></div>';
      if (bookingData.guestName) html += '<div class="booking-row"><span class="booking-label">å®¿æ³Šè€…å</span><span class="booking-value">' + escapeHtml(bookingData.guestName) + '</span></div>';
      if (bookingData.guestCount) html += '<div class="booking-row"><span class="booking-label">äººæ•°</span><span class="booking-value">' + escapeHtml(bookingData.guestCount) + 'å</span></div>';
      if (bookingData.bookingSite) html += '<div class="booking-row"><span class="booking-label">äºˆç´„ã‚µã‚¤ãƒˆ</span><span class="booking-value">' + escapeHtml(bookingData.bookingSite) + '</span></div>';
      if (bookingData.bbq) html += '<div class="booking-row"><span class="booking-label">BBQåˆ©ç”¨</span><span class="booking-value">' + escapeHtml(bookingData.bbq) + '</span></div>';
      if (bookingData.linen) html += '<div class="booking-row"><span class="booking-label">ãƒªãƒãƒ³</span><span class="booking-value">' + escapeHtml(bookingData.linen) + '</span></div>';
      if (bookingData.bed) html += '<div class="booking-row"><span class="booking-label">ãƒ™ãƒƒãƒ‰</span><span class="booking-value">' + escapeHtml(bookingData.bed) + '</span></div>';

      document.getElementById('bookingInfo').innerHTML = html;
      document.getElementById('bookingInfo').classList.remove('hidden');
    }

    function renderChecklist() {
      var items = checklistData.items;
      var checked = checklistData.checked;
      var supplyNeeded = checklistData.supplyNeeded;

      // ã‚«ãƒ†ã‚´ãƒªã”ã¨ã«ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
      var categories = {};
      items.forEach(function(item) {
        var cat = item.category || 'ãã®ä»–';
        if (!categories[cat]) categories[cat] = [];
        categories[cat].push(item);
      });

      var html = '';
      Object.keys(categories).forEach(function(cat) {
        var catItems = categories[cat];
        var checkedInCat = catItems.filter(function(item) { return checked[item.id]; }).length;

        html += '<div class="section" data-category="' + escapeHtml(cat) + '">';
        html += '<div class="section-header" onclick="toggleSection(this)">';
        html += '<span class="section-icon">â–¼</span>';
        html += '<span class="section-title">' + escapeHtml(cat) + '</span>';
        html += '<span class="section-count">(' + checkedInCat + '/' + catItems.length + ')</span>';
        html += '</div>';
        html += '<div class="section-body">';

        catItems.forEach(function(item) {
          var isChecked = !!checked[item.id];
          var isSupplyNeeded = !!supplyNeeded[item.id];

          html += '<div class="checklist-item">';
          html += '<input type="checkbox" class="item-checkbox" data-item-id="' + escapeHtml(item.id) + '" ' + (isChecked ? 'checked' : '') + ' onchange="toggleItem(this)">';
          html += '<div class="item-content">';
          html += '<div class="item-name">' + escapeHtml(item.name) + '</div>';

          if (item.supplyItem) {
            html += '<div class="supply-checkbox-container">';
            html += '<input type="checkbox" class="supply-checkbox" data-item-id="' + escapeHtml(item.id) + '" data-item-name="' + escapeHtml(item.name) + '" ' + (isSupplyNeeded ? 'checked' : '') + ' onchange="toggleSupply(this)">';
            html += '<label>è¦è£œå……</label>';
            html += '</div>';
          }

          html += '</div>';
          html += '</div>';
        });

        html += '</div>';
        html += '</div>';
      });

      document.getElementById('checklistContainer').innerHTML = html;
    }

    function renderPhotoSection() {
      var spots = checklistData.spots;
      var photos = checklistData.photos;

      if (spots.length === 0) return;

      // ã‚«ãƒ†ã‚´ãƒªã”ã¨ã«ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
      var categories = {};
      spots.forEach(function(spot) {
        var cat = spot.category || 'ãã®ä»–';
        if (!categories[cat]) categories[cat] = [];
        categories[cat].push(spot);
      });

      var html = '<h3>ğŸ“· æ’®å½±</h3>';

      Object.keys(categories).forEach(function(cat) {
        var catSpots = categories[cat];

        catSpots.forEach(function(spot) {
          var spotPhotos = photos[spot.id] || { before: [], after: [] };

          html += '<div class="photo-spot">';
          html += '<div class="photo-spot-name">' + escapeHtml(spot.name) + '</div>';

          // ãƒ“ãƒ•ã‚©ãƒ¼å†™çœŸ
          html += '<div class="photo-timing-group">';
          html += '<div class="photo-timing-label">ãƒ“ãƒ•ã‚©ãƒ¼</div>';
          if (spotPhotos.before.length > 0) {
            html += '<div class="photo-grid">';
            spotPhotos.before.forEach(function(photo) {
              html += '<div class="photo-thumb" style="background-image: url(https://drive.google.com/uc?id=' + photo.fileId + ')"></div>';
            });
            html += '</div>';
          }
          html += '<button class="photo-upload-btn" onclick="openPhotoUpload(\'' + spot.id + '\', \'ãƒ“ãƒ•ã‚©ãƒ¼\')">ãƒ“ãƒ•ã‚©ãƒ¼å†™çœŸã‚’æ’®å½±</button>';
          html += '</div>';

          // ã‚¢ãƒ•ã‚¿ãƒ¼å†™çœŸ
          html += '<div class="photo-timing-group">';
          html += '<div class="photo-timing-label">ã‚¢ãƒ•ã‚¿ãƒ¼</div>';
          if (spotPhotos.after.length > 0) {
            html += '<div class="photo-grid">';
            spotPhotos.after.forEach(function(photo) {
              html += '<div class="photo-thumb" style="background-image: url(https://drive.google.com/uc?id=' + photo.fileId + ')"></div>';
            });
            html += '</div>';
          }
          html += '<button class="photo-upload-btn" onclick="openPhotoUpload(\'' + spot.id + '\', \'ã‚¢ãƒ•ã‚¿ãƒ¼\')">ã‚¢ãƒ•ã‚¿ãƒ¼å†™çœŸã‚’æ’®å½±</button>';
          html += '</div>';

          html += '</div>';
        });
      });

      document.getElementById('photoSection').innerHTML = html;
      document.getElementById('photoSection').classList.remove('hidden');
    }

    function renderMemos() {
      var memos = checklistData.memos;
      var html = '';
      memos.forEach(function(memo) {
        html += '<div class="memo-item">';
        html += escapeHtml(memo.text);
        html += '<div class="memo-meta">' + escapeHtml(memo.by) + ' - ' + formatDateTime(memo.at) + '</div>';
        html += '</div>';
      });
      document.getElementById('memoList').innerHTML = html;
    }

    function renderSupplyList() {
      var supplyNeeded = checklistData.supplyNeeded;
      var items = Object.values(supplyNeeded);

      if (items.length === 0) {
        document.getElementById('supplyList').classList.add('hidden');
        return;
      }

      var html = '<h3>âš ï¸ è¦è£œå……ãƒªã‚¹ãƒˆ</h3>';
      items.forEach(function(item) {
        html += '<div class="supply-item">' + escapeHtml(item.name) + '</div>';
      });

      document.getElementById('supplyList').innerHTML = html;
      document.getElementById('supplyList').classList.remove('hidden');
    }

    function toggleSection(header) {
      var section = header.parentElement;
      var body = section.querySelector('.section-body');
      header.classList.toggle('collapsed');
      body.classList.toggle('collapsed');
    }

    function toggleItem(checkbox) {
      var itemId = checkbox.getAttribute('data-item-id');
      var checked = checkbox.checked;

      callGAS('toggleChecklistItem', [checkoutDate, itemId, checked, staffName]).then(function(res) {
        if (res.success) {
          if (checked) {
            checklistData.checked[itemId] = { checked: true, by: staffName, at: new Date() };
          } else {
            delete checklistData.checked[itemId];
          }
          updateProgress();
          updateSectionCounts();
          if (missingCheckActive) {
            highlightMissing();
          }
        } else {
          alert('ã‚¨ãƒ©ãƒ¼: ' + res.error);
          checkbox.checked = !checked;
        }
      });
    }

    function toggleSupply(checkbox) {
      var itemId = checkbox.getAttribute('data-item-id');
      var itemName = checkbox.getAttribute('data-item-name');
      var needed = checkbox.checked;

      callGAS('toggleSupplyNeeded', [checkoutDate, itemId, itemName, needed, staffName]).then(function(res) {
        if (res.success) {
          if (needed) {
            checklistData.supplyNeeded[itemId] = { name: itemName, by: staffName, at: new Date() };
          } else {
            delete checklistData.supplyNeeded[itemId];
          }
          renderSupplyList();
        } else {
          alert('ã‚¨ãƒ©ãƒ¼: ' + res.error);
          checkbox.checked = !needed;
        }
      });
    }

    function updateProgress() {
      var total = checklistData.totalItems;
      var checked = Object.keys(checklistData.checked).length;
      var percent = total > 0 ? Math.round((checked / total) * 100) : 0;

      document.getElementById('progressFill').style.width = percent + '%';
      document.getElementById('btnComplete').disabled = checked < total;
    }

    function updateSectionCounts() {
      var sections = document.querySelectorAll('.section');
      sections.forEach(function(section) {
        var items = section.querySelectorAll('.item-checkbox');
        var checked = Array.from(items).filter(function(cb) { return cb.checked; }).length;
        var total = items.length;
        var count = section.querySelector('.section-count');
        if (count) {
          count.textContent = '(' + checked + '/' + total + ')';
        }
      });
    }

    function toggleMissingCheck() {
      missingCheckActive = !missingCheckActive;
      var btn = document.getElementById('btnCheckMissing');

      if (missingCheckActive) {
        btn.textContent = 'é€šå¸¸è¡¨ç¤º';
        btn.style.background = '#c0392b';
        highlightMissing();
      } else {
        btn.textContent = 'æ¼ã‚Œãƒã‚§ãƒƒã‚¯';
        btn.style.background = '#e67e22';
        clearMissingHighlight();
      }
    }

    function highlightMissing() {
      // ãƒã‚§ãƒƒã‚¯é …ç›®ã®èµ¤å­—è¡¨ç¤º
      var items = document.querySelectorAll('.checklist-item');
      items.forEach(function(item) {
        var checkbox = item.querySelector('.item-checkbox');
        var nameEl = item.querySelector('.item-name');
        if (!checkbox.checked) {
          nameEl.classList.add('missing');
        } else {
          nameEl.classList.remove('missing');
        }
      });

      // ã‚»ã‚¯ã‚·ãƒ§ãƒ³ãƒ˜ãƒƒãƒ€ãƒ¼ã®èµ¤å­—è¡¨ç¤º
      var sections = document.querySelectorAll('.section');
      sections.forEach(function(section) {
        var items = section.querySelectorAll('.item-checkbox');
        var hasMissing = Array.from(items).some(function(cb) { return !cb.checked; });
        var header = section.querySelector('.section-header');
        var title = section.querySelector('.section-title');

        if (hasMissing) {
          header.classList.add('has-missing');
          title.classList.add('missing');
        } else {
          header.classList.remove('has-missing');
          title.classList.remove('missing');
        }
      });

      // æ’®å½±ç®‡æ‰€ã®èµ¤å­—è¡¨ç¤º
      var spots = document.querySelectorAll('.photo-spot');
      spots.forEach(function(spot) {
        var beforePhotos = spot.querySelectorAll('.photo-timing-group:nth-of-type(1) .photo-thumb');
        var afterPhotos = spot.querySelectorAll('.photo-timing-group:nth-of-type(2) .photo-thumb');
        var nameEl = spot.querySelector('.photo-spot-name');

        if (beforePhotos.length === 0 || afterPhotos.length === 0) {
          nameEl.classList.add('missing');
        } else {
          nameEl.classList.remove('missing');
        }
      });
    }

    function clearMissingHighlight() {
      document.querySelectorAll('.missing').forEach(function(el) {
        el.classList.remove('missing');
      });
      document.querySelectorAll('.has-missing').forEach(function(el) {
        el.classList.remove('has-missing');
      });
    }

    var currentPhotoSpotId = null;
    var currentPhotoTiming = null;

    function openPhotoUpload(spotId, timing) {
      currentPhotoSpotId = spotId;
      currentPhotoTiming = timing;
      document.getElementById('photoInput').click();
    }

    function handlePhotoUpload(event) {
      var file = event.target.files[0];
      if (!file) return;

      var reader = new FileReader();
      reader.onload = function(e) {
        var base64 = e.target.result.split(',')[1];

        callGAS('uploadChecklistPhoto', [checkoutDate, currentPhotoSpotId, currentPhotoTiming, base64, staffName]).then(function(res) {
          if (res.success) {
            // å†™çœŸã‚’è¿½åŠ 
            if (!checklistData.photos[currentPhotoSpotId]) {
              checklistData.photos[currentPhotoSpotId] = { before: [], after: [] };
            }
            var photoData = { fileId: res.fileId, by: staffName, at: new Date() };
            if (currentPhotoTiming === 'ãƒ“ãƒ•ã‚©ãƒ¼') {
              checklistData.photos[currentPhotoSpotId].before.push(photoData);
            } else {
              checklistData.photos[currentPhotoSpotId].after.push(photoData);
            }
            renderPhotoSection();
            if (missingCheckActive) {
              highlightMissing();
            }
          } else {
            alert('å†™çœŸã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + res.error);
          }
        });
      };
      reader.readAsDataURL(file);

      // ãƒªã‚»ãƒƒãƒˆ
      event.target.value = '';
    }

    function addMemo() {
      var input = document.getElementById('memoInput');
      var text = input.value.trim();
      if (!text) return;

      callGAS('addChecklistMemo', [checkoutDate, text, staffName]).then(function(res) {
        if (res.success) {
          checklistData.memos.push({ text: text, by: staffName, at: new Date() });
          renderMemos();
          input.value = '';
        } else {
          alert('ãƒ¡ãƒ¢ã®è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + res.error);
        }
      });
    }

    function completeChecklist() {
      if (!confirm('æ¸…æƒã‚’å®Œäº†ã—ã¦ã‚ªãƒ¼ãƒŠãƒ¼ã«é€šçŸ¥ã—ã¾ã™ã‹ï¼Ÿ')) return;

      callGAS('notifyCleaningComplete', [checkoutDate, staffName]).then(function(res) {
        if (res.success) {
          alert('æ¸…æƒå®Œäº†é€šçŸ¥ã‚’é€ä¿¡ã—ã¾ã—ãŸï¼ãŠç–²ã‚Œæ§˜ã§ã—ãŸï¼');
        } else {
          alert('é€šçŸ¥ã®é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + res.error);
        }
      });
    }

    // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°
    function callGAS(functionName, args) {
      return new Promise(function(resolve, reject) {
        google.script.run
          .withSuccessHandler(function(jsonStr) {
            try {
              resolve(JSON.parse(jsonStr));
            } catch (e) {
              reject(e);
            }
          })
          .withFailureHandler(reject)
          [functionName].apply(null, args);
      });
    }

    function escapeHtml(text) {
      var div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function formatDateTime(dateStr) {
      if (!dateStr) return '';
      var d = new Date(dateStr);
      return d.getMonth() + 1 + '/' + d.getDate() + ' ' +
             String(d.getHours()).padStart(2, '0') + ':' +
             String(d.getMinutes()).padStart(2, '0');
    }
  </script>
</body>
</html>
