<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>民泊予約・清掃管理</title>
  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Bootstrap Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
  <!-- FullCalendar -->
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.css" rel="stylesheet">
  <style>
    :root {
      --booking-color: #0d6efd;
      --booking-bg: rgba(13, 110, 253, 0.15);
      --cleaning-color: #198754;
      --cleaning-bg: rgba(25, 135, 84, 0.2);
      --invalid-color: #6c757d;
      --fc-border-color: #adb5bd;
    }
    .fc-theme-standard td, .fc-theme-standard th {
      border: 1px solid #adb5bd !important;
    }
    .fc-scrollgrid td, .fc-scrollgrid th {
      border: 1px solid #adb5bd !important;
    }
    .fc-daygrid-day {
      border: 1px solid #adb5bd !important;
    }
    .fc-col-header-cell {
      border: 1px solid #adb5bd !important;
    }
    body {
      font-size: 14px;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
    }
    .fc {
      font-size: 12px;
    }
    .fc-toolbar-title {
      font-size: 1.1rem !important;
    }
    .fc-button {
      padding: 0.35em 0.65em;
      font-size: 0.85rem;
    }
    .fc-event {
      cursor: pointer;
      border-radius: 4px;
      padding: 1px 3px;
    }
    .fc-event-booking {
      background-color: var(--booking-bg);
      border-color: var(--booking-color);
      color: var(--booking-color);
    }
    .fc-event-cleaning,
    .fc-event-cleaning-decided,
    .fc-event-cleaning-recruiting,
    .fc-event-cleaning-undecided {
      background-color: #198754 !important;
      color: #fff !important;
      border: none !important;
    }
    .fc-event-cleaning .fc-event-main,
    .fc-event-cleaning-decided .fc-event-main,
    .fc-event-cleaning-recruiting .fc-event-main,
    .fc-event-cleaning-undecided .fc-event-main {
      color: #fff !important;
    }
    .fc-day-recruiting {
      background-color: #ffff00 !important;
    }
    @media (prefers-color-scheme: dark) {
      :root {
        --fc-border-color: #495057;
      }
      body, html {
        background-color: #000 !important;
        color: #e0e0e0 !important;
      }
      .container-fluid {
        background-color: #000 !important;
        color: #e0e0e0 !important;
      }
      h1, h2, h3, h4, h5, h6, .h1, .h2, .h3, .h4, .h5, .h6 {
        color: #fff !important;
      }
      a { color: #7eb8ff !important; }
      a:hover { color: #a8d0ff !important; }
      .text-muted { color: #adb5bd !important; }
      .fc-theme-standard td, .fc-theme-standard th,
      .fc-scrollgrid td, .fc-scrollgrid th,
      .fc-daygrid-day, .fc-col-header-cell {
        border-color: #495057 !important;
      }
      .fc-theme-standard .fc-scrollgrid {
        border-color: #495057 !important;
      }
      .fc .fc-view-harness {
        background-color: #1a1a1a !important;
      }
      .fc .fc-daygrid-day-frame {
        background-color: #1a1a1a !important;
      }
      .fc .fc-day-other .fc-daygrid-day-frame {
        background-color: #0d0d0d !important;
      }
      .fc .fc-col-header-cell-cushion,
      .fc .fc-daygrid-day-number {
        color: #e0e0e0 !important;
      }
      .fc .fc-toolbar-title { color: #fff !important; }
      .fc .fc-button {
        background-color: #2d2d2d !important;
        border-color: #495057 !important;
        color: #e0e0e0 !important;
      }
      .fc .fc-button:hover {
        background-color: #3d3d3d !important;
        border-color: #6c757d !important;
        color: #fff !important;
      }
      .fc .fc-button-active {
        background-color: #198754 !important;
        border-color: #198754 !important;
      }
      .fc-day-recruiting,
      .fc-day-recruiting .fc-daygrid-day-frame {
        background-color: #9a8a00 !important;
      }
      .fc-event-cleaning,
      .fc-event-cleaning-decided,
      .fc-event-cleaning-recruiting,
      .fc-event-cleaning-undecided {
        background-color: #198754 !important;
        color: #fff !important;
      }
      .fc-event-cleaning-volunteered-by-me,
      .fc-event-cleaning-selected-by-me {
        border-color: #dc3545 !important;
      }
      #calendarStatusLegend { color: #adb5bd !important; }
      .fc-list-event:hover td {
        background-color: rgba(255,255,255,0.08) !important;
      }
      .fc-list-event-title, .fc-list-event-time {
        color: #e0e0e0 !important;
      }
      .fc-event {
        border-color: inherit !important;
      }
      .modal-content {
        background-color: #1a1a1a !important;
        border-color: #495057 !important;
        color: #e0e0e0 !important;
      }
      .modal-header {
        background-color: #242424 !important;
        border-bottom-color: #495057 !important;
        color: #fff !important;
      }
      .modal-footer {
        background-color: #242424 !important;
        border-top-color: #495057 !important;
      }
      .modal-body {
        background-color: #1a1a1a !important;
        color: #e0e0e0 !important;
      }
      .modal .btn-close {
        filter: invert(1);
      }
      .detail-row {
        border-bottom-color: #333 !important;
      }
      .detail-label { color: #b0b0b0 !important; }
      .detail-value { color: #e0e0e0 !important; }
      .form-control, .form-select, .form-control:focus, .form-select:focus {
        background-color: #2d2d2d !important;
        border-color: #495057 !important;
        color: #e0e0e0 !important;
      }
      .form-control::placeholder {
        color: #6c757d !important;
      }
      .form-control:disabled, .form-select:disabled {
        background-color: #1f1f1f !important;
      }
      .form-label {
        color: #d0d0d0 !important;
      }
      #jobCompFormModal .form-control, #jobCompFormModal .form-select {
        border-color: #495057 !important;
      }
      .card {
        background-color: #1a1a1a !important;
        border-color: #495057 !important;
        color: #e0e0e0 !important;
      }
      .card-body { color: #e0e0e0 !important; }
      .border, .border-top, .border-bottom, .border-start, .border-end {
        border-color: #495057 !important;
      }
      .bg-light, .border.bg-light {
        background-color: #2d2d2d !important;
        border-color: #495057 !important;
        color: #e0e0e0 !important;
      }
      .nav-tabs {
        border-bottom-color: #495057 !important;
      }
      .nav-tabs .nav-link {
        background-color: transparent !important;
        border-color: transparent !important;
        color: #adb5bd !important;
      }
      .nav-tabs .nav-link:hover {
        border-color: #495057 !important;
        color: #e0e0e0 !important;
      }
      .nav-tabs .nav-link.active {
        background-color: #1a1a1a !important;
        border-color: #495057 #495057 #1a1a1a !important;
        color: #fff !important;
      }
      .alert {
        background-color: #242424 !important;
        border-color: #495057 !important;
        color: #e0e0e0 !important;
      }
      .alert-info {
        background-color: #1a2a3a !important;
        border-color: #2d4a5e !important;
      }
      .alert-warning {
        background-color: #3a3020 !important;
        border-color: #5d4e37 !important;
      }
      .alert-danger {
        background-color: #3a2020 !important;
        border-color: #5d3737 !important;
      }
      .alert-success {
        background-color: #1a2a20 !important;
        border-color: #2d4a37 !important;
      }
      .alert-link { color: #7eb8ff !important; }
      .loading-overlay {
        background: rgba(0,0,0,0.85) !important;
      }
      .loading-overlay .spinner-border {
        color: #0d6efd !important;
      }
      #staffSelectOverlay .bg-white {
        background-color: #1a1a1a !important;
        border: 1px solid #495057 !important;
        color: #e0e0e0 !important;
      }
      #staffSelectOverlay h6 { color: #fff !important; }
      .recruit-status-badge { font-size: 0.95rem; font-weight: 600; }
      .recruit-status-badge.status-undecided { background: #dc3545; color: #fff; }
      .recruit-status-badge.status-recruiting { background: #ffc107; color: #000; }
      .recruit-status-badge.status-decided { background: #0d6efd; color: #fff; }
      .table {
        color: #e0e0e0 !important;
      }
      .table td, .table th {
        border-color: #495057 !important;
      }
      code {
        background-color: #2d2d2d !important;
        color: #e0e0e0 !important;
        border-color: #495057 !important;
      }
      textarea.form-control {
        background-color: #2d2d2d !important;
        color: #e0e0e0 !important;
      }
      .btn-outline-primary, .btn-outline-secondary, .btn-outline-danger, .btn-outline-info, .btn-outline-success, .btn-outline-warning {
        border-color: #495057 !important;
        color: #adb5bd !important;
      }
      .btn-outline-primary:hover, .btn-outline-primary:focus {
        background-color: #0d6efd !important;
        border-color: #0d6efd !important;
        color: #fff !important;
      }
      .btn-outline-secondary:hover {
        background-color: #6c757d !important;
        border-color: #6c757d !important;
        color: #fff !important;
      }
      .btn-link.text-muted {
        color: #adb5bd !important;
      }
      .btn-link.text-muted:hover {
        color: #fff !important;
      }
      input[type="month"], input[type="date"], input[type="datetime-local"] {
        color-scheme: dark;
      }
      .form-check-input {
        background-color: #2d2d2d !important;
        border-color: #495057 !important;
      }
      .form-check-input:checked {
        background-color: #0d6efd !important;
        border-color: #0d6efd !important;
      }
      .form-check-label {
        color: #e0e0e0 !important;
      }
      .dropdown-menu {
        background-color: #1a1a1a !important;
        border-color: #495057 !important;
      }
      .dropdown-item {
        color: #e0e0e0 !important;
      }
      .dropdown-item:hover {
        background-color: #2d2d2d !important;
        color: #fff !important;
      }
      .dropdown-divider {
        border-color: #495057 !important;
      }
      label:not(.form-check-label):not(.badge) {
        color: #d0d0d0 !important;
      }
      .small, .small * {
        color: inherit;
      }
      .badge.bg-secondary {
        background-color: #495057 !important;
      }
      .modal-backdrop {
        background-color: #000 !important;
      }
      .fc .fc-popover {
        background-color: #1a1a1a !important;
        border-color: #495057 !important;
      }
      .fc .fc-popover-header {
        background-color: #242424 !important;
        color: #fff !important;
      }
      .fc .fc-more-link {
        color: #7eb8ff !important;
      }
    }
    .fc-event-invalid {
      background-color: rgba(108, 117, 125, 0.15);
      border-color: var(--invalid-color);
      color: var(--invalid-color);
    }
    /* 宿泊イベント: 枠線なし（全ステータス共通） */
    .fc-event-booking,
    .fc-event-booking .fc-event-main,
    .fc-event-roster-answered,
    .fc-event-roster-answered .fc-event-main,
    .fc-event-roster-unanswered,
    .fc-event-roster-unanswered .fc-event-main {
      border: none !important;
      box-shadow: none !important;
    }
    /* フォーム未回答: 枠線・枠なし */
    .fc-event.fc-event-roster-unanswered {
      border: none !important;
      box-shadow: none !important;
      outline: none !important;
    }
    .fc-event.fc-event-roster-unanswered .fc-event-main,
    .fc-event.fc-event-roster-unanswered .fc-event-main-frame {
      border: none !important;
      box-shadow: none !important;
      outline: none !important;
    }
    /* スタッフ画面: 自分が立候補した清掃＝赤破線、正式決定＝赤実線 */
    .fc-event-cleaning-volunteered-by-me {
      border-color: #dc3545 !important;
      border-style: dashed !important;
      border-width: 2px !important;
    }
    .fc-event-cleaning-selected-by-me {
      border-color: #dc3545 !important;
      border-style: solid !important;
      border-width: 2px !important;
    }
    .fc-event-status-dot {
      border: 1px solid #fff !important;
      box-shadow: 0 0 0 1px rgba(255,255,255,0.9) !important;
    }
    #calendar {
      max-width: 100%;
      overflow-x: auto;
    }
    /* スマホ: 1日の枠を縦長に（Googleカレンダー風） */
    @media (max-width: 768px) {
      .fc-daygrid-day {
        min-height: 5.5rem;
      }
      .fc-daygrid-day-frame {
        min-height: 5rem;
      }
      .fc-daygrid-day-events {
        min-height: 4rem;
      }
      .fc-daygrid-day-top {
        padding: 2px 0;
      }
      .fc .fc-toolbar {
        gap: 0.5rem;
        flex-wrap: wrap;
      }
      .fc .fc-toolbar-title {
        font-size: 1rem !important;
      }
      .fc .fc-button {
        padding: 0.4em 0.5em;
        font-size: 0.8rem;
      }
      /* リスト表示: 縦長のイベント行 */
      .fc-list-event:hover td {
        background: rgba(0,0,0,0.04);
      }
      .fc-list-event-dot {
        margin-right: 0.5rem;
      }
    }
    .modal-content {
      border-radius: 12px;
    }
    #jobCompFormModal .form-control, #jobCompFormModal .form-select {
      border: 1px solid #adb5bd;
    }
    .modal-header {
      border-bottom: 1px solid #dee2e6;
    }
    .detail-row {
      padding: 0.5rem 0;
      border-bottom: 1px solid #f0f0f0;
      display: flex;
      gap: 0.5rem;
      align-items: flex-start;
    }
    .detail-row:last-child {
      border-bottom: none;
    }
    .detail-label {
      flex-shrink: 0;
      min-width: 6.5em;
    }
    .detail-value {
      flex: 1;
      word-break: break-word;
    }
    /* --- モーダル リデザイン --- */
    .modal-type-icon {
      font-size: 1.3rem;
      margin-right: 0.4rem;
      vertical-align: middle;
    }
    .modal-header-cleaning {
      background: linear-gradient(135deg, #d4edda 0%, #f8f9fa 100%);
      border-bottom: 2px solid #198754;
    }
    .modal-header-booking {
      background: linear-gradient(135deg, #cce5ff 0%, #f8f9fa 100%);
      border-bottom: 2px solid #0d6efd;
    }
    .modal-prominent-date {
      font-size: 1.25rem;
      font-weight: 700;
      color: #333;
      padding: 0.6rem 0 0.3rem;
    }
    .modal-prominent-date .bi {
      color: #6c757d;
      margin-right: 0.3rem;
    }
    .modal-date-pair {
      display: flex;
      gap: 0.75rem;
      padding: 0.5rem 0;
    }
    .modal-date-pair .date-item {
      flex: 1;
      background: #f8f9fa;
      border-radius: 8px;
      padding: 0.5rem 0.75rem;
      text-align: center;
    }
    .modal-date-pair .date-item .date-label {
      font-size: 0.7rem;
      color: #6c757d;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 0.15rem;
    }
    .modal-date-pair .date-item .date-val {
      font-size: 0.95rem;
      font-weight: 600;
      color: #333;
    }
    .modal-info-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 0.5rem;
      padding: 0.5rem 0;
    }
    .modal-info-item {
      display: flex;
      align-items: center;
      gap: 0.4rem;
      font-size: 0.9rem;
    }
    .modal-info-item .bi {
      color: #6c757d;
      font-size: 1rem;
    }
    .modal-info-item .info-label {
      color: #6c757d;
      font-size: 0.8rem;
    }
    .modal-info-item .info-value {
      font-weight: 600;
      color: #333;
    }
    .modal-badge-row {
      display: flex;
      gap: 0.5rem;
      padding: 0.4rem 0;
      flex-wrap: wrap;
    }
    .modal-badge {
      display: inline-flex;
      align-items: center;
      gap: 0.3rem;
      padding: 0.25rem 0.65rem;
      border-radius: 20px;
      font-size: 0.82rem;
      font-weight: 600;
    }
    .modal-badge-yes {
      background: #d4edda;
      color: #155724;
    }
    .modal-badge-no {
      background: #f0f0f0;
      color: #6c757d;
    }
    .modal-badge .bi {
      font-size: 0.9rem;
    }
    .modal-staff-label {
      display: flex;
      align-items: center;
      gap: 0.4rem;
      padding: 0.5rem 0 0.2rem;
      font-weight: 700;
      font-size: 0.9rem;
    }
    .modal-staff-label.staff-set {
      color: #0d6efd;
    }
    .modal-staff-label.staff-unset {
      color: #dc3545;
    }
    .modal-staff-name {
      font-size: 0.95rem;
      padding-left: 1.4rem;
      margin-bottom: 0.3rem;
    }
    .modal-next-res-card {
      background: #f8f9fa;
      border: 1px solid #e9ecef;
      border-radius: 10px;
      padding: 0.75rem;
      margin: 0.5rem 0;
    }
    .modal-next-res-card .card-title-sm {
      font-size: 0.8rem;
      font-weight: 700;
      color: #6c757d;
      margin-bottom: 0.5rem;
      display: flex;
      align-items: center;
      gap: 0.3rem;
    }
    .modal-next-res-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 0.3rem 0.75rem;
    }
    .modal-next-res-grid .nres-item {
      display: flex;
      align-items: center;
      gap: 0.3rem;
      font-size: 0.85rem;
    }
    .modal-next-res-grid .nres-label {
      color: #6c757d;
      font-size: 0.78rem;
      min-width: 3.5em;
    }
    .modal-next-res-grid .nres-value {
      font-weight: 600;
      color: #333;
    }
    .modal-section-divider {
      border-top: 1px solid #e9ecef;
      margin: 0.5rem 0;
    }
    .modal-btn-full {
      width: 100%;
      margin-top: 0.3rem;
    }
    .modal-btn-row {
      display: flex;
      gap: 0.5rem;
      padding: 0.3rem 0;
    }
    .modal-btn-row .btn {
      flex: 1;
    }
    .modal-memo-area {
      padding: 0.4rem 0;
    }
    .modal-memo-area label {
      font-size: 0.82rem;
      font-weight: 600;
      color: #6c757d;
      margin-bottom: 0.2rem;
    }
    .modal-footer-redesign {
      flex-direction: column;
      gap: 0.4rem;
      padding: 0.75rem 1rem;
      border-top: 1px solid #e9ecef;
    }
    .modal-footer-redesign .footer-btn-row {
      display: flex;
      gap: 0.5rem;
      width: 100%;
    }
    .modal-footer-redesign .footer-btn-row .btn {
      flex: 1;
    }
    .modal-footer-redesign .footer-center {
      display: flex;
      justify-content: center;
      width: 100%;
    }
    /* --- モーダル リデザイン END --- */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(255,255,255,0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }
    .btn-edit-staff {
      margin-top: 0.5rem;
    }
    @media (max-width: 576px) {
      .fc-toolbar {
        flex-direction: column;
        gap: 0.5rem;
      }
      .fc-toolbar-chunk {
        display: flex;
        justify-content: center;
      }
    }
  </style>
</head>
<body>
  <div class="container-fluid py-2 py-md-3 px-2">
<? if (isStaffMode) { ?>
    <div id="staffSelectOverlay" class="position-fixed top-0 start-0 w-100 h-100 align-items-center justify-content-center" style="display:none !important; background:rgba(0,0,0,0.5); z-index:9999;">
      <div class="bg-white rounded shadow p-4 m-2" style="max-width:320px;">
        <h6 class="mb-3">スタッフのお名前を選択してください</h6>
        <select class="form-select mb-3" id="staffSelectModalSelect">
          <option value="">-- 選択 --</option>
        </select>
        <button type="button" class="btn btn-primary w-100" id="staffSelectModalConfirm">決定</button>
      </div>
    </div>
<? } ?>
    <div id="staffSelectorBar" class="alert alert-info py-2 mb-2" style="display:none;">
      <div class="d-flex gap-2 align-items-center flex-wrap align-items-center">
        <span class="small">スタッフ: <strong id="staffDisplayName"></strong></span>
        <button type="button" class="btn btn-sm btn-outline-secondary py-0" id="btnStaffChange">変更</button>
        <select class="form-select form-select-sm" id="staffNameSelect" style="max-width:200px; display:none;">
          <option value="">-- 選択 --</option>
        </select>
      </div>
    </div>
    <div class="d-flex justify-content-between align-items-center mb-2 flex-wrap gap-1">
      <div class="d-flex align-items-center gap-2">
        <h5 class="mb-0">民泊予約・清掃管理</h5>
        <span id="currentAccountBadge" class="badge bg-secondary" style="font-size:0.7rem; font-weight:normal; display:none;" title="ログイン中のアカウント"></span>
      </div>
      <a href="#" id="btnAccountSwitch" class="btn btn-sm btn-link text-muted p-0" style="display:none; font-size:0.85rem;">アカウント切り替え</a>
    </div>
    <div id="notificationBanner" class="alert alert-info py-2 mb-2 small" style="display:none;">
      <div class="d-flex justify-content-between align-items-center">
        <span class="fw-bold">新着通知:</span>
        <button type="button" class="btn btn-sm btn-outline-danger py-0" id="btnClearAllNotifBanner">一括削除</button>
      </div>
      <div id="notificationBannerList" class="mt-1"></div>
      <a href="#" id="notificationBannerLink" class="alert-link mt-1 d-block">すべて見る</a>
    </div>
    <ul class="nav nav-tabs mb-2" id="mainTabs">
      <li class="nav-item"><a class="nav-link active" href="#" data-tab="calendar">カレンダー</a></li>
      <li class="nav-item" id="navRecruit"><a class="nav-link" href="#" data-tab="recruit">清掃募集</a></li>
      <li class="nav-item" id="navStaffSchedule" style="display:none;"><a class="nav-link" href="#" data-tab="staffSchedule">出勤一覧</a></li>
      <li class="nav-item" id="navNotifications" style="display:none;"><a class="nav-link" href="#" data-tab="notifications">通知</a></li>
      <li class="nav-item" id="navSettings"><a class="nav-link" href="#" data-tab="settings">設定</a></li>
      <li class="nav-item" id="navStaffTest" style="display:none;"><a class="nav-link" href="#" data-tab="staffTest">スタッフ画面のテスト</a></li>
    </ul>
    <div id="panelCalendar">
      <div id="calendarStatusLegend" class="small text-muted mb-2 d-flex flex-column gap-1">
        <div class="d-flex flex-wrap gap-3 align-items-center">
          <span>【宿泊】</span>
          <span><span class="d-inline-block rounded-circle me-1 fc-status-dot" style="width:6px;height:6px;background:#dc3545;border:1px solid #fff;"></span>フォーム入力なし</span>
          <span><span class="d-inline-block rounded-circle me-1 fc-status-dot" style="width:6px;height:6px;background:#28a745;border:1px solid #fff;"></span>フォーム入力あり</span>
        </div>
        <div class="d-flex flex-wrap gap-3 align-items-center">
          <span>【清掃】</span>
          <span><span class="d-inline-block rounded-circle me-1 fc-status-dot" style="width:6px;height:6px;background:#dc3545;border:1px solid #fff;"></span>未募集</span>
          <span><span class="d-inline-block rounded-circle me-1 fc-status-dot" style="width:6px;height:6px;background:#ffc107;border:1px solid #fff;"></span>募集中</span>
          <span><span class="d-inline-block rounded-circle me-1 fc-status-dot" style="width:6px;height:6px;background:#0d6efd;border:1px solid #fff;"></span>決定済み</span>
        </div>
      </div>
      <div id="calendarAddBookingArea" class="mb-2" style="display:none;"><button type="button" class="btn btn-sm btn-outline-primary" id="btnAddBooking">予約を追加</button></div>
      <div id="calendar"></div>
    </div>
    <div id="panelRecruit" style="display:none;">
      <div id="recruitList"></div>
      <div id="recruitAddListArea" class="mb-3 mt-3"></div>
      <div id="recruitAddBtnArea" class="mt-2" style="display:none;"><button type="button" class="btn btn-sm btn-outline-primary" id="btnAddRecruit">募集を手動で追加</button></div>
    </div>
    <div id="panelStaffSchedule" style="display:none;">
      <div class="mb-2"><label class="form-label small">表示月</label><input type="month" class="form-control form-control-sm" id="staffScheduleMonth" style="max-width:160px;"></div>
      <div id="staffScheduleList"></div>
      <div class="mt-3 p-2 border rounded bg-light">
        <p class="small fw-bold mb-1">請求書</p>
        <p class="small text-muted mb-2">月末にオーナーが設定で指定したGoogleドライブのフォルダに請求書を保存できます。オーナーに保存先フォルダの設定を依頼してください。</p>
        <button type="button" class="btn btn-sm btn-outline-secondary" id="btnCreateInvoice">今月の請求書を作成</button>
        <span id="invoiceCreateResult" class="small ms-2" style="display:none;"></span>
      </div>
    </div>
    <div id="panelNotifications" style="display:none;">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <span class="fw-bold small">通知一覧</span>
        <button type="button" class="btn btn-sm btn-outline-danger py-0" id="btnClearAllNotifList">一括削除</button>
      </div>
      <div id="notificationListMain"></div>
    </div>
    <div id="panelStaffTest" style="display:none;">
      <div class="alert alert-info small mb-2">スタッフ画面のテスト表示です。スタッフが実際に見る画面を確認できます。実際の権限は変わりません。</div>
      <ul class="nav nav-tabs mb-2" id="staffTestSubTabs">
        <li class="nav-item"><a class="nav-link active staff-test-sub" href="#" data-stafftest-tab="calendar">カレンダー</a></li>
        <li class="nav-item"><a class="nav-link staff-test-sub" href="#" data-stafftest-tab="schedule">出勤一覧</a></li>
      </ul>
      <div id="staffTestCalendarSection" style="display:block;"></div>
      <div id="staffTestScheduleSection" style="display:none;"></div>
    </div>
    <div id="panelSettings" style="display:none;">
      <p class="small text-muted" id="settingsDescription">オーナーのみ閲覧・編集可能です。</p>
      <!-- スタッフ用URL -->
      <div id="staffUrlSection" class="mb-3 p-2 border rounded bg-light">
        <label class="form-label small fw-bold">スタッフ用URL（?staff=1付き）</label>
        <p class="small text-muted mb-1">スタッフに共有するURL。claspで <code>npm run deploy</code> 実行時に自動で最新のスタッフ用URLがここに反映されます。手動で入力・保存も可能。コピーしてLINE等で共有できます。</p>
        <div class="d-flex gap-2 flex-wrap align-items-center">
          <input type="url" class="form-control form-control-sm flex-grow-1" id="staffDeployUrlInput" placeholder="https://script.../exec?staff=1" style="min-width:200px;">
          <button type="button" class="btn btn-sm btn-outline-primary" id="btnSaveStaffUrl">保存</button>
          <button type="button" class="btn btn-sm btn-primary" id="btnCopyStaffUrl">コピー</button>
        </div>
        <div id="staffUrlSaveResult" class="small mt-1" style="display:none;"></div>
      </div>
      <!-- 請求書保存フォルダ（スタッフの請求書出力先） -->
      <div id="invoiceFolderSection" class="mb-3 p-2 border rounded bg-light">
        <label class="form-label small fw-bold">請求書保存フォルダ（スタッフ用）</label>
        <p class="small text-muted mb-1">スタッフが「請求書を作成」したときに保存するGoogleドライブのフォルダ。フォルダを開き、URLの <code>/folders/</code> の後のIDを貼り付けてください。</p>
        <div class="d-flex gap-2 flex-wrap align-items-center">
          <input type="text" class="form-control form-control-sm" id="invoiceFolderIdInput" placeholder="1abc...xyz" style="max-width:300px;">
          <button type="button" class="btn btn-sm btn-outline-primary" id="btnSaveInvoiceFolder">保存</button>
        </div>
        <div id="invoiceFolderSaveResult" class="small mt-1" style="display:none;"></div>
      </div>
      <!-- 初回セットアップ（オーナー未設定時） -->
      <div id="ownerSetupForm" class="mb-3" style="display:none;">
        <div class="alert alert-info small">初回のみオーナー登録を行います。登録後はオーナーのみ設定画面にアクセスできます。</div>
        <div class="mb-2"><label class="form-label">オーナーメールアドレス</label><input type="email" class="form-control" id="ownerSetupEmail" placeholder="your@email.com"></div>
        <div class="mb-2"><label class="form-label">パスワード（6文字以上）</label><input type="password" class="form-control" id="ownerSetupPassword" placeholder="パスワード"></div>
        <div class="mb-2"><label class="form-label">パスワード（確認）</label><input type="password" class="form-control" id="ownerSetupPasswordConfirm" placeholder="パスワード確認"></div>
        <button type="button" class="btn btn-primary" id="btnOwnerSetup">登録</button>
        <div id="ownerSetupError" class="text-danger small mt-2" style="display:none;"></div>
      </div>
      <!-- パスワード未設定時の初回パスワード設定（オーナー登録済み・パスワード未設定） -->
      <div id="ownerPasswordSetupForm" class="mb-3" style="display:none;">
        <div class="alert alert-warning small">パスワードが未設定です。メール変更時に必要になるため、パスワードを設定してください。</div>
        <div class="mb-2"><label class="form-label">パスワード（6文字以上）</label><input type="password" class="form-control" id="ownerPasswordSetup" placeholder="パスワード"></div>
        <div class="mb-2"><label class="form-label">パスワード（確認）</label><input type="password" class="form-control" id="ownerPasswordSetupConfirm" placeholder="パスワード確認"></div>
        <button type="button" class="btn btn-primary" id="btnOwnerPasswordSetup">設定</button>
        <div id="ownerPasswordSetupError" class="text-danger small mt-2" style="display:none;"></div>
      </div>
      <!-- オーナー設定済み時のメール表示・変更 -->
      <div id="ownerEmailSection" class="mb-3" style="display:none;">
        <label class="form-label">オーナーメールアドレス</label>
        <div class="d-flex gap-2 align-items-center">
          <span id="ownerEmailDisplay" class="text-muted"></span>
          <button type="button" class="btn btn-sm btn-outline-secondary" id="btnChangeOwnerEmail">変更</button>
        </div>
      </div>
      <ul class="nav nav-tabs nav-tabs-sm mb-2" id="settingsSubTabs">
        <li class="nav-item"><a class="nav-link active" href="#" data-subtab="staff">清掃スタッフ</a></li>
        <li class="nav-item"><a class="nav-link" href="#" data-subtab="subOwners">サブオーナー</a></li>
        <li class="nav-item"><a class="nav-link" href="#" data-subtab="jobs">仕事内容</a></li>
        <li class="nav-item"><a class="nav-link" href="#" data-subtab="recruitSettings">募集設定</a></li>
        <li class="nav-item"><a class="nav-link" href="#" data-subtab="sync">予約連携</a></li>
        <li class="nav-item"><a class="nav-link" href="#" data-subtab="notifications">通知履歴</a></li>
      </ul>
      <div id="settingsStaff">
        <button type="button" class="btn btn-sm btn-primary mb-2" id="btnAddStaff">スタッフ追加</button>
        <div id="staffList"></div>
      </div>
      <div id="settingsSubOwners" style="display:none;">
        <p class="small text-muted mb-2">サブオーナーはオーナーと同様に設定の閲覧・編集ができます。複数追加可能。表示名はカレンダー上部に表示されます。</p>
        <button type="button" class="btn btn-sm btn-primary mb-2" id="btnAddSubOwner">サブオーナー追加</button>
        <div id="subOwnerList"></div>
      </div>
      <div id="settingsJobs" style="display:none;">
        <p class="small text-muted mb-2">仕事内容ごとに、共通またはスタッフ別の報酬を設定できます。</p>
        <button type="button" class="btn btn-sm btn-primary mb-2" id="btnAddJob">仕事内容追加</button>
        <div id="jobList"></div>
      </div>
      <div id="settingsRecruitSettings" style="display:none;">
        <div class="mb-2"><label>募集開始（チェックアウト何週間前から）</label><input type="number" class="form-control form-control-sm" id="recruitStartWeeks" min="1" value="4"></div>
        <div class="mb-2"><label>最少回答者数（これ未満でリマインド）</label><input type="number" class="form-control form-control-sm" id="minRespondents" min="1" value="2"></div>
        <div class="mb-2"><label>リマインド間隔（週）</label><input type="number" class="form-control form-control-sm" id="reminderIntervalWeeks" min="1" value="1"></div>
        <div class="mb-2"><label>選定人数（基本何人選ぶか）</label><input type="number" class="form-control form-control-sm" id="selectCount" min="1" value="2"></div>
        <button type="button" class="btn btn-sm btn-primary" id="btnSaveRecruitSettings">募集設定を保存</button>
      </div>
      <div id="settingsSync" style="display:none;">
        <p class="small text-muted">Airbnb・Booking.comなどのiCal URLを登録すると、予約を自動取り込みできます。宿泊者がフォームで詳細入力すると、既存予約にマージされます。</p>
        <button type="button" class="btn btn-sm btn-outline-primary mb-2" id="btnAddSync">連携を追加</button>
        <button type="button" class="btn btn-sm btn-primary mb-2 ms-1" id="btnRunSync">今すぐ同期</button>
        <button type="button" class="btn btn-sm btn-outline-danger mb-2 ms-1" id="btnClearSynced">iCal紐付けを一括解除</button>
        <button type="button" class="btn btn-sm btn-outline-secondary mb-2 ms-1" id="btnImportSpreadsheet">別スプシから読み込み</button>
        <button type="button" class="btn btn-sm btn-outline-secondary mb-2 ms-1" id="btnReloadDataSync" title="スプシの内容を再読み込みしてカレンダーを更新">スプシを再読み込み</button>
        <div id="syncList"></div>
        <div id="syncResult" class="small mt-2" style="display:none;"></div>
      </div>
      <div id="settingsNotifications" style="display:none;">
        <p class="small text-muted mb-2">立候補・立候補取消・予約追加・予約削除・フォーム回答などの通知履歴です。</p>
        <div id="notificationList"></div>
      </div>
    </div>
  </div>

  <!-- 予約手動追加モーダル -->
  <div class="modal fade" id="addBookingModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header"><h6 class="modal-title">予約を追加</h6><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body">
          <p class="small text-muted">プラットフォームの予約情報を手動で登録。宿泊者がフォーム入力すると詳細が反映されます。</p>
          <div class="mb-2"><label class="form-label">チェックイン</label><input type="date" class="form-control" id="addBookingCheckIn"></div>
          <div class="mb-2"><label class="form-label">チェックアウト</label><input type="date" class="form-control" id="addBookingCheckOut"></div>
          <div class="mb-2"><label class="form-label">宿泊者名（任意）</label><input type="text" class="form-control" id="addBookingGuestName" placeholder="未入力可"></div>
          <div class="mb-2"><label class="form-label">予約サイト</label><input type="text" class="form-control" id="addBookingSite" placeholder="Airbnb, Booking.com など"></div>
          <div class="mb-2"><label class="form-label">宿泊人数（任意）</label><input type="text" class="form-control" id="addBookingGuestCount" placeholder="例: 4"></div>
          <div id="addBookingError" class="text-danger small mt-2" style="display:none;"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
          <button type="button" class="btn btn-primary" id="btnConfirmAddBooking">追加</button>
        </div>
      </div>
    </div>
  </div>

  <!-- 募集手動追加モーダル -->
  <div class="modal fade" id="addRecruitModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header"><h6 class="modal-title">募集を追加</h6><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body">
          <p class="small text-muted">募集がまだない予約から選択してください。追加後、一覧でタップして告知方法（メール/LINE）を選び送信します。</p>
          <div id="addRecruitBookingsList"></div>
          <div id="addRecruitEmpty" class="text-muted small" style="display:none;">追加できる予約はありません。（すべて募集済みか、チェックアウト日が取得できない予約のみです）</div>
          <div id="addRecruitError" class="text-danger small mt-2" style="display:none;"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">閉じる</button>
        </div>
      </div>
    </div>
  </div>

  <!-- オーナーメール変更モーダル -->
  <div class="modal fade" id="ownerEmailChangeModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header"><h6 class="modal-title">オーナーメールの変更</h6><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body">
          <div class="mb-2"><label class="form-label">新しいメールアドレス</label><input type="email" class="form-control" id="ownerEmailNew" placeholder="new@email.com"></div>
          <div class="mb-2"><label class="form-label">現在のパスワード（確認用）</label><input type="password" class="form-control" id="ownerEmailPassword" placeholder="パスワード"></div>
          <div id="ownerEmailChangeError" class="text-danger small mt-2" style="display:none;"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
          <button type="button" class="btn btn-primary" id="btnConfirmOwnerEmailChange">変更</button>
        </div>
      </div>
    </div>
  </div>

  <!-- イベント詳細モーダル -->
  <div class="modal fade" id="eventModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header" id="eventModalHeader">
          <h6 class="modal-title" id="eventModalTitle">予約詳細</h6>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body" id="eventModalBody"></div>
        <div class="modal-footer modal-footer-redesign" id="eventModalFooter">
          <div class="footer-btn-row" id="eventModalActionBtns"></div>
          <div id="eventModalVolunteerCenter" class="d-flex flex-wrap justify-content-center gap-1 w-100"></div>
          <div class="footer-center" id="eventModalDeleteArea" style="display:none;">
            <button type="button" class="btn btn-danger btn-sm" id="btnDeleteBooking">予約を削除</button>
          </div>
          <div class="footer-center">
            <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">閉じる</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 清掃担当編集モーダル（カレンダー用） -->
  <div class="modal fade" id="staffEditModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h6 class="modal-title">清掃担当者の編集</h6>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <p class="small text-muted mb-2">一人一行で表示。削除ボタンでその行を削除。全削除時は募集中に戻ります。</p>
          <div id="staffEditList" class="mb-2"></div>
          <div class="d-flex gap-2 align-items-center mb-2">
            <select class="form-select form-select-sm flex-grow-1" id="staffEditAddSelect" style="max-width:200px;">
              <option value="">追加するスタッフを選択</option>
            </select>
            <button type="button" class="btn btn-sm btn-outline-primary" id="btnStaffEditAdd">追加</button>
          </div>
          <input type="hidden" id="staffEditRowNumber">
          <div id="staffEditError" class="text-danger small mt-2" style="display:none;"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
          <button type="button" class="btn btn-primary" id="btnSaveStaff">保存</button>
        </div>
      </div>
    </div>
  </div>

  <!-- サブオーナー編集モーダル -->
  <div class="modal fade" id="subOwnerFormModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header"><h6 class="modal-title">サブオーナー</h6><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body">
          <input type="hidden" id="subOwnerFormRowIndex">
          <div class="mb-2"><label class="form-label">メールアドレス</label><input type="email" class="form-control" id="subOwnerFormEmail" placeholder="subowner@example.com"></div>
          <div class="mb-2"><label class="form-label">表示名（任意・未入力時はメールの@前を表示）</label><input type="text" class="form-control" id="subOwnerFormDisplayName" placeholder="例: yamasuke81"></div>
          <div id="subOwnerFormError" class="text-danger small" style="display:none;"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
          <button type="button" class="btn btn-primary" id="btnSaveSubOwnerForm">保存</button>
        </div>
      </div>
    </div>
  </div>

  <!-- 仕事内容追加・編集モーダル -->
  <div class="modal fade" id="jobFormModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header"><h6 class="modal-title">仕事内容</h6><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body">
          <input type="hidden" id="jobFormRowIndex"><input type="hidden" id="jobFormSortOrder">
          <div class="mb-2"><label class="form-label">仕事内容名</label><input type="text" class="form-control" id="jobFormName" placeholder="例: 1名で清掃"></div>
          <div id="jobFormError" class="text-danger small" style="display:none;"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
          <button type="button" class="btn btn-primary" id="btnSaveJobForm">保存</button>
        </div>
      </div>
    </div>
  </div>

  <!-- 仕事内容の報酬設定モーダル -->
  <div class="modal fade" id="jobCompFormModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content">
        <div class="modal-header"><h6 class="modal-title">報酬設定</h6><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body">
          <input type="hidden" id="jobCompFormJobName">
          <div class="mb-3"><label class="form-label">仕事内容</label><div id="jobCompFormJobNameDisplay" class="fw-bold"></div></div>
          <div class="mb-2"><label class="form-label">報酬額（円）未設定は空欄、共通は全スタッフに適用</label></div>
          <div id="jobCompFormTable" class="mb-2"></div>
          <hr class="my-3">
          <div class="mb-2"><label class="form-label">特別料金（年末年始等・全員共通）対象日の作業に追加されます</label></div>
          <div id="jobCompFormSpecialRates" class="mb-2"></div>
          <button type="button" class="btn btn-sm btn-outline-secondary mb-2" id="btnAddSpecialRate">行を追加</button>
          <div id="jobCompFormError" class="text-danger small" style="display:none;"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
          <button type="button" class="btn btn-primary" id="btnSaveJobCompForm">保存</button>
        </div>
      </div>
    </div>
  </div>

  <!-- 別スプシ読み込みモーダル -->
  <div class="modal fade" id="importSpreadsheetModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header"><h6 class="modal-title">別スプシから読み込み</h6><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body">
          <p class="small text-muted">削除したフォームの回答スプシやバックアップから予約データを読み込みます。URLを貼り付けてください。</p>
          <div class="mb-2"><label class="form-label">スプレッドシートのURL</label><input type="url" class="form-control" id="importSpreadsheetUrl" placeholder="https://docs.google.com/spreadsheets/d/..."></div>
          <div class="form-check mb-2">
            <input type="checkbox" class="form-check-input" id="importSkipDuplicates" checked>
            <label class="form-check-label small" for="importSkipDuplicates">既存の同じチェックイン・チェックアウトの行はスキップ</label>
          </div>
          <div id="importSpreadsheetError" class="text-danger small mt-2" style="display:none;"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
          <button type="button" class="btn btn-primary" id="btnConfirmImportSpreadsheet">読み込み</button>
        </div>
      </div>
    </div>
  </div>

  <!-- 予約連携追加モーダル -->
  <div class="modal fade" id="syncFormModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header"><h6 class="modal-title">予約連携</h6><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body">
          <input type="hidden" id="syncFormRowIndex">
          <div class="mb-2"><label class="form-label">プラットフォーム名</label><input type="text" class="form-control" id="syncFormPlatformName" placeholder="例: Airbnb"></div>
          <div class="mb-2"><label class="form-label">iCal URL</label><input type="url" class="form-control" id="syncFormIcalUrl" placeholder="https://..."></div>
          <div id="syncFormError" class="text-danger small" style="display:none;"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
          <button type="button" class="btn btn-primary" id="btnSaveSyncForm">保存</button>
        </div>
      </div>
    </div>
  </div>

  <!-- スタッフ編集モーダル（設定用） -->
  <div class="modal fade" id="staffFormModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content">
        <div class="modal-header"><h6 class="modal-title">清掃スタッフ</h6><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body">
          <input type="hidden" id="staffFormRowIndex">
          <div class="mb-2"><label class="form-label">名前</label><input type="text" class="form-control" id="staffFormName"></div>
          <div class="mb-2"><label class="form-label">住所</label><input type="text" class="form-control" id="staffFormAddress"></div>
          <div class="mb-2"><label class="form-label">メール</label><input type="email" class="form-control" id="staffFormEmail"></div>
          <div class="mb-2"><label class="form-label">金融機関名</label><input type="text" class="form-control" id="staffFormBankName"></div>
          <div class="mb-2"><label class="form-label">支店名</label><input type="text" class="form-control" id="staffFormBankBranch"></div>
          <div class="mb-2"><label class="form-label">口座種類</label><input type="text" class="form-control" id="staffFormAccountType" placeholder="普通・当座など"></div>
          <div class="mb-2"><label class="form-label">口座番号</label><input type="text" class="form-control" id="staffFormAccountNumber"></div>
          <div class="mb-2"><label class="form-label">口座名義</label><input type="text" class="form-control" id="staffFormAccountHolder"></div>
          <div id="staffFormError" class="text-danger small" style="display:none;"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
          <button type="button" class="btn btn-primary" id="btnSaveStaffForm">保存</button>
        </div>
      </div>
    </div>
  </div>

  <!-- 予約削除確認モーダル -->
  <div class="modal fade" id="deleteBookingConfirmModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header"><h6 class="modal-title">予約の削除</h6><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body">
          <p class="mb-2">この予約を削除しますか？キャンセルや誤登録の削除に使います。</p>
          <div id="deleteBookingConfirmInfo" class="small text-muted mb-3"></div>
          <p class="small text-danger">削除すると元に戻せません。</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
          <button type="button" class="btn btn-danger" id="btnConfirmDeleteBooking">削除する</button>
        </div>
      </div>
    </div>
  </div>

  <!-- LINE用コピーテキストモーダル -->
  <div class="modal fade" id="lineCopyModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header"><h6 class="modal-title">LINE用テキスト（コピーしてLINEグループに投稿）</h6><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body">
          <textarea id="lineCopyText" class="form-control font-monospace small" rows="6"></textarea>
          <button type="button" class="btn btn-sm btn-outline-primary mt-2" id="btnCopyLineText">コピー</button>
        </div>
      </div>
    </div>
  </div>

  <!-- 募集編集モーダル -->
  <div class="modal fade" id="recruitEditModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content">
        <div class="modal-header"><h6 class="modal-title" id="recruitEditModalTitle">募集内容</h6><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body">
          <p class="small fw-bold mb-1">清掃日</p>
          <p class="small text-muted mb-2" id="recruitEditCleaningDate"></p>
          <p class="small fw-bold mb-1">次回予約の情報（変更の可能性あり）</p>
          <div class="mb-2">
            <label class="form-label small">日付</label><input type="text" class="form-control form-control-sm mb-1" id="recruitEditReserveDate" placeholder="例: 2026-02-01 ～ 2026-02-05">
            <label class="form-label small">人数</label><input type="text" class="form-control form-control-sm mb-1" id="recruitEditReserveGuestCount" placeholder="例: 大人4名、3歳以下1名">
            <label class="form-label small">BBQ</label><input type="text" class="form-control form-control-sm mb-1" id="recruitEditReserveBBQ" placeholder="有/無など">
            <label class="form-label small">国籍</label><input type="text" class="form-control form-control-sm mb-1" id="recruitEditReserveNationality" placeholder="例: 日本">
            <label class="form-label small">ベッド数</label><input type="text" class="form-control form-control-sm mb-1" id="recruitEditReserveBedCount" placeholder="例: 1人1台ずつ">
            <label class="form-label small">メモ</label><textarea class="form-control form-control-sm mb-1" id="recruitEditReserveMemo" rows="2" placeholder="自由記入"></textarea>
          </div>
          <p class="small mb-2" id="recruitEditStatus"></p>
          <p class="small mb-2" id="recruitEditVolunteers"></p>
          <div class="d-flex flex-wrap gap-2 mb-2">
            <button type="button" class="btn btn-sm btn-primary recruit-edit-owner-only" id="btnRecruitEditSave">保存</button>
            <button type="button" class="btn btn-sm btn-primary recruit-edit-owner-only" id="btnRecruitEditMail">メール送信</button>
            <button type="button" class="btn btn-sm btn-info text-white recruit-edit-owner-only" id="btnRecruitEditCopy">テキストコピー</button>
            <button type="button" class="btn btn-sm btn-danger" id="btnRecruitEditCancel" style="display:none;">募集取消</button>
          </div>
          <div id="recruitEditSelectArea" class="mb-2" style="display:none;"><button type="button" class="btn btn-sm btn-primary" id="btnRecruitEditSelect">選定</button></div>
          <div id="recruitEditVolunteerArea" class="mb-2" style="display:none;">
            <button type="button" class="btn btn-sm btn-success" id="btnRecruitEditVolunteer">立候補する</button>
            <button type="button" class="btn btn-sm btn-warning" id="btnRecruitEditCancelVolunteer" style="display:none;">立候補を取り消す</button>
          </div>
          <div id="recruitEditLineCopyArea" class="mb-2 mt-2 p-2 border rounded bg-light" style="display:none;">
            <p class="small fw-bold mb-1">LINE用テキスト（コピーしてLINEグループに投稿）</p>
            <textarea id="recruitEditLineCopyText" class="form-control font-monospace small mb-2" rows="6"></textarea>
            <button type="button" class="btn btn-sm btn-primary" id="btnRecruitEditCopyToClipboard">コピー</button>
          </div>
          <div id="recruitEditError" class="text-danger small mt-2" style="display:none;"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- 募集・選定モーダル -->
  <div class="modal fade" id="recruitSelectModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header"><h6 class="modal-title" id="recruitSelectModalTitle">清掃担当を選定</h6><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body">
          <p class="small text-muted" id="recruitSelectDate"></p>
          <label class="form-label">選定スタッフ</label>
          <div id="recruitSelectStaffList" class="mb-2"></div>
          <div class="d-flex gap-2 align-items-center mb-2">
            <select class="form-select form-select-sm flex-grow-1" id="recruitSelectStaffDropdown"></select>
            <button type="button" class="btn btn-sm btn-outline-secondary" id="btnAddSelectStaff" title="追加">＋</button>
          </div>
          <input type="hidden" id="recruitSelectRowIndex">
          <div id="recruitSelectError" class="text-danger small mt-2" style="display:none;"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
          <button type="button" class="btn btn-primary" id="btnConfirmSelect">選定して保存</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ローディング -->
  <div class="loading-overlay" id="loadingOverlay" style="display:none;">
    <div class="spinner-border text-primary" role="status"></div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/locales/ja.global.min.js"></script>
  <script>
    (function() {
      'use strict';
      var staffParam = (typeof location !== 'undefined' && location.search) ? location.search : '';
      window.staffMode = <?= isStaffMode ?> || (staffParam.indexOf('staff=1') >= 0 || staffParam.indexOf('staff=true') >= 0);

      let calendar;
      let allBookings = [];
      const CLEANING_COLOR = '#198754';
      const INVALID_COLOR = '#6c757d';
      var PLATFORM_COLORS = {
        'booking.com': '#003b95',
        'airbnb': '#ff5a5f',
        '楽天': '#00A04A',
        '楽天トラベル': '#00A04A',
        'rakuten': '#00A04A'
      };
      var DEFAULT_BOOKING_COLOR = '#6c757d';

      function getPlatformColor(bookingSite) {
        if (!bookingSite) return DEFAULT_BOOKING_COLOR;
        var s = String(bookingSite).toLowerCase().trim();
        var icalPart = '', formPart = '';
        if (s.indexOf('（') >= 0) {
          icalPart = s.substring(0, s.indexOf('（')).trim();
          formPart = s.substring(s.indexOf('（') + 1).replace(/）$/, '').trim();
        } else {
          icalPart = s;
        }
        var forColor = (icalPart && icalPart !== '-') ? icalPart : formPart;
        if (forColor && forColor.indexOf('booking') >= 0) return PLATFORM_COLORS['booking.com'];
        if (forColor && forColor.indexOf('airbnb') >= 0) return PLATFORM_COLORS['airbnb'];
        if (forColor && (forColor.indexOf('楽天') >= 0 || forColor.indexOf('rakuten') >= 0)) return PLATFORM_COLORS['楽天'];
        return DEFAULT_BOOKING_COLOR;
      }

      function isRosterAnswered(b) {
        var name = String(b.guestName || '').trim();
        if (!name) return false;
        var lower = name.toLowerCase();
        if (/not available|reserved|closed|不明/i.test(name)) return false;
        if (lower === 'airbnb' || lower === 'booking.com') return false;
        return name.length > 0;
      }

      // BBQフラグ判定
      function getBBQFlag(bbqVal) {
        if (!bbqVal || typeof bbqVal !== 'string') return '?';
        const v = bbqVal.trim().toLowerCase();
        if (v.indexOf('yes') > -1 || v.indexOf('はい') > -1) return '有';
        if (v.indexOf('no') > -1 || v.indexOf('いいえ') > -1) return '無';
        return '?';
      }
      function getParkingFlag(parkingVal) {
        if (parkingVal == null || parkingVal === '') return '';
        const v = String(parkingVal).trim();
        if (!v) return '';
        if (v.indexOf('利用しない') > -1) return '不要';
        if (v.indexOf('2台') > -1 || v.indexOf('2台利用') > -1) return '2台';
        if (v.indexOf('1台') > -1 || v.indexOf('1台利用') > -1) return '1台';
        return '';
      }

      // 宿泊人数表示: 大人〇名、3歳以下〇名
      function formatGuestCount(b) {
        const adults = (b.guestCountAdults != null && b.guestCountAdults !== '') ? b.guestCountAdults : '?';
        const infants = (b.guestCountInfants != null && b.guestCountInfants !== '') ? b.guestCountInfants : '?';
        return '大人' + adults + '名、3歳以下' + infants + '名';
      }

      function formatDateTimeDisplay(val) {
        if (val == null || val === '') return '-';
        var d;
        if (val instanceof Date) {
          d = val;
        } else {
          d = new Date(val);
          if (isNaN(d.getTime())) return escapeHtml(String(val));
        }
        var y = d.getFullYear();
        var m = d.getMonth() + 1;
        var day = d.getDate();
        var h = d.getHours();
        var min = d.getMinutes();
        return y + '年' + m + '月' + day + '日 ' + (h < 10 ? '0' : '') + h + ':' + (min < 10 ? '0' : '') + min;
      }

      // 宿泊イベントタイトル
      function formatBookingTitle(b) {
        const nights = b.nights || 0;
        const guests = formatGuestCount(b);
        const bbq = getBBQFlag(b.bbq);
        const parking = getParkingFlag(b.parking);
        const name = b.guestName || '(不明)';
        const site = b.bookingSite || '';
        var s = nights + '泊' + guests + 'BQ' + bbq;
        if (parking) s += parking;
        return s + ' ' + name + (site ? ' ' + site : '');
      }

      // 清掃イベントタイトル（フルネーム、カンマ区切り、省略なし）
      function formatCleaningTitle(b) {
        const staff = (b.cleaningStaff && String(b.cleaningStaff).trim()) ? String(b.cleaningStaff).trim() : '未定';
        return '掃/' + staff;
      }

      // データ取得
      function fetchData() {
        document.getElementById('loadingOverlay').style.display = 'flex';
        return new Promise(function(resolve) {
          google.script.run
            .withSuccessHandler(function(jsonStr) {
              try {
                const res = JSON.parse(jsonStr);
                resolve(res);
              } catch (e) {
                resolve({ success: false, error: 'レスポンスの解析に失敗しました。' });
              }
            })
            .withFailureHandler(function(err) {
              resolve({ success: false, error: err.message || '通信エラー' });
            })
            .getData();
        }).finally(function() {
          document.getElementById('loadingOverlay').style.display = 'none';
        });
      }

      // FullCalendar用イベント生成
      function buildCalendarEvents(data, recruitMap) {
        const events = [];
        recruitMap = recruitMap || {};
        if (!data || !Array.isArray(data)) return events;

        // 同一予約の重複排除マージ（iCal行 + Googleフォーム行）
        // マッチ条件: チェックイン日が同じ、かつチェックアウト日が同じ or 片方が空
        var merged = [];
        var ciKeyMap = {}; // checkInParsed → merged配列のindex

        function mergeBookingData(existing, b) {
          var fields = ['guestName','bbq','guestCountAdults','guestCountInfants','cleaningStaff','parking','bedChoice','tel1','tel2','email','email2','passportUrls','carDisplay','nationality','purpose','memo','cleaningNotice'];
          fields.forEach(function(f) {
            if (!existing[f] && b[f]) existing[f] = b[f];
          });
          // checkOutが片方だけある場合は補完
          if (!existing.checkOutParsed && b.checkOutParsed) {
            existing.checkOut = b.checkOut;
            existing.checkOutParsed = b.checkOutParsed;
            existing.isValidDates = true;
            existing.nights = b.nights;
          }
          // guestCountDisplayをスマートマージ
          if (b.guestCountDisplay && b.guestCountDisplay !== existing.guestCountDisplay) {
            var extractCnt = function(s) {
              var m = s.match(/^(.+?)（(.+?)）$/);
              return m ? { ical: m[1].trim(), form: m[2].trim() } : { ical: s, form: '-' };
            };
            var exC = extractCnt(existing.guestCountDisplay || '-（-）');
            var nwC = extractCnt(b.guestCountDisplay || '-（-）');
            existing.guestCountDisplay = ((exC.ical !== '-') ? exC.ical : nwC.ical) + '（' + ((exC.form !== '-') ? exC.form : nwC.form) + '）';
          }
          // bookingSiteをスマートマージ
          if (b.bookingSite && b.bookingSite !== existing.bookingSite) {
            var extractParts = function(bs) {
              var m = bs.match(/^(.+?)（(.+?)）$/);
              return m ? { ical: m[1].trim(), form: m[2].trim() } : { ical: bs, form: '-' };
            };
            var ex = extractParts(existing.bookingSite);
            var nw = extractParts(b.bookingSite);
            existing.bookingSite = ((ex.ical !== '-') ? ex.ical : nw.ical) + '（' + ((ex.form !== '-') ? ex.form : nw.form) + '）';
          }
          if (b.guestNames && b.guestNames.length && (!existing.guestNames || !existing.guestNames.length)) {
            existing.guestNames = b.guestNames;
          }
          if (!existing.mergedRowNumbers) existing.mergedRowNumbers = [existing.rowNumber];
          existing.mergedRowNumbers.push(b.rowNumber);
        }

        data.forEach(function(b) {
          if (!b.checkInParsed) { merged.push(b); return; }
          var ci = b.checkInParsed;
          var co = b.checkOutParsed || '';
          // 同一チェックイン日の既存エントリを探す
          if (ciKeyMap[ci] !== undefined) {
            var existIdx = ciKeyMap[ci];
            var existing = merged[existIdx];
            var existCo = existing.checkOutParsed || '';
            // チェックアウト日が一致、または片方が空ならマージ
            if (!co || !existCo || co === existCo) {
              mergeBookingData(existing, b);
              return;
            }
          }
          ciKeyMap[ci] = merged.length;
          merged.push(b);
        });

        merged.forEach(function(b) {
          const checkIn = b.checkInParsed;
          const checkOut = b.checkOutParsed;
          const isValid = b.isValidDates;

          // 宿泊イベント（チェックイン日〜チェックアウト前日まで跨ぐ）
          if (checkIn) {
            var rosterAnswered = isRosterAnswered(b);
            var evtClasses = isValid ? ['fc-event-booking'] : ['fc-event-invalid'];
            if (rosterAnswered) evtClasses.push('fc-event-roster-answered');
            else evtClasses.push('fc-event-roster-unanswered');
            var bookingStatus = rosterAnswered ? 'form-answered' : 'form-unanswered';
            events.push({
              id: 'b-' + b.rowNumber,
              title: formatBookingTitle(b),
              start: checkIn,
              end: checkOut || undefined,
              allDay: true,
              extendedProps: {
                type: 'booking',
                rowNumber: b.rowNumber,
                data: b,
                rosterAnswered: rosterAnswered,
                statusDot: bookingStatus
              },
              backgroundColor: isValid ? getPlatformColor(b.bookingSite) : INVALID_COLOR,
              borderColor: 'transparent',
              classNames: evtClasses
            });
          }

          // 清掃イベント（チェックアウト日）
          if (checkOut) {
            var rec = recruitMap[b.rowNumber] || {};
            var recStatus = rec.status || '';
            var recStaff = (rec.staff || '').trim();
            var bookStaff = (b.cleaningStaff || '').trim();
            var isDecided = !!(recStaff || bookStaff);
            var isRecruiting = (recStatus === '募集中');
            var cleaningClasses = ['fc-event-cleaning', isDecided ? 'fc-event-cleaning-decided' : isRecruiting ? 'fc-event-cleaning-recruiting' : 'fc-event-cleaning-undecided'];
            var curStaff = (window.currentUserName || '').trim().toLowerCase();
            var curEmail = (window.currentUserEmail || '').trim().toLowerCase();
            var volunteers = rec.volunteers || [];
            var selectedNames = (recStaff || bookStaff || '').split(/[,、]/).map(function(s) { return s.trim().toLowerCase(); }).filter(Boolean);
            var isVolunteeredByMe = curStaff && volunteers.some(function(v) {
              return (v.staffName || '').trim().toLowerCase() === curStaff || (v.email || '').trim().toLowerCase() === curEmail;
            });
            var isSelectedByMe = curStaff && selectedNames.some(function(s) { return s === curStaff; });
            if (window.staffMode && isVolunteeredByMe) cleaningClasses.push(isSelectedByMe ? 'fc-event-cleaning-selected-by-me' : 'fc-event-cleaning-volunteered-by-me');
            var cleaningStatus = isDecided ? 'cleaning-decided' : (isRecruiting ? 'cleaning-recruiting' : 'cleaning-not-recruiting');
            events.push({
              id: 'c-' + b.rowNumber,
              title: formatCleaningTitle(b),
              start: checkOut,
              allDay: true,
              extendedProps: {
                type: 'cleaning',
                rowNumber: b.rowNumber,
                data: b,
                recruitStatus: recStatus,
                statusDot: cleaningStatus
              },
              backgroundColor: '#198754',
              borderColor: 'transparent',
              classNames: cleaningClasses
            });
          }
        });

        return events;
      }

      // イベント詳細モーダル表示
      function showEventModal(event) {
        const props = event.extendedProps;
        const d = props.data;
        const type = props.type;
        const title = type === 'booking' ? '宿泊詳細' : '清掃詳細';
        var titleIcon = type === 'booking' ? '<i class="bi bi-house-door-fill modal-type-icon"></i>' : '<i class="bi bi-brush-fill modal-type-icon"></i>';
        var headerEl = document.getElementById('eventModalHeader');
        document.getElementById('eventModalTitle').innerHTML = titleIcon + escapeHtml(title);
        headerEl.className = 'modal-header ' + (type === 'cleaning' ? 'modal-header-cleaning' : 'modal-header-booking');

        // 非同期コールバックの競合防止用世代ID
        var modalGen = (window._eventModalGen = (window._eventModalGen || 0) + 1);

        function fmt(val) { var s = (val != null && val !== '') ? String(val) : '-'; return escapeHtml(s); }
        // 日付表示ヘルパー: "2026-02-13 ～ 2026-02-15" → "2026/2/13 ～ 2026/2/15"
        // メモ保存（宿泊詳細）
        window.saveBookingMemoUI = function() {
          var ta = document.getElementById('bookingMemoTextarea');
          if (!ta) return;
          var btn = document.getElementById('btnSaveMemo');
          if (btn) { btn.disabled = true; btn.textContent = '保存中...'; }
          google.script.run.withSuccessHandler(function(res) {
            var r = JSON.parse(res);
            if (r.success) {
              if (btn) { btn.textContent = '保存しました'; btn.classList.replace('btn-primary', 'btn-success'); }
              setTimeout(function() { if (btn) { btn.disabled = false; btn.textContent = 'メモを保存'; btn.classList.replace('btn-success', 'btn-primary'); } }, 2000);
            } else {
              alert(r.error || '保存に失敗しました。');
              if (btn) { btn.disabled = false; btn.textContent = 'メモを保存'; }
            }
          }).withFailureHandler(function(e) {
            alert('保存に失敗しました: ' + e.message);
            if (btn) { btn.disabled = false; btn.textContent = 'メモを保存'; }
          }).saveBookingMemo(parseInt(ta.dataset.row), ta.value);
        };

        // 連絡事項保存（清掃詳細）
        window.saveCleaningNoticeUI = function() {
          var ta = document.getElementById('cleaningNoticeTextarea');
          if (!ta) return;
          var btn = document.getElementById('btnSaveNotice');
          if (btn) { btn.disabled = true; btn.textContent = '保存中...'; }
          google.script.run.withSuccessHandler(function(res) {
            var r = JSON.parse(res);
            if (r.success) {
              if (btn) { btn.textContent = '保存しました'; btn.classList.replace('btn-primary', 'btn-success'); }
              setTimeout(function() { if (btn) { btn.disabled = false; btn.textContent = '連絡事項を保存'; btn.classList.replace('btn-success', 'btn-primary'); } }, 2000);
            } else {
              alert(r.error || '保存に失敗しました。');
              if (btn) { btn.disabled = false; btn.textContent = '連絡事項を保存'; }
            }
          }).withFailureHandler(function(e) {
            alert('保存に失敗しました: ' + e.message);
            if (btn) { btn.disabled = false; btn.textContent = '連絡事項を保存'; }
          }).saveCleaningNotice(parseInt(ta.dataset.row), ta.value);
        };

        function fmtDateRange(raw) {
          if (!raw) return '-';
          var s = String(raw);
          return s.replace(/(\d{4})-(\d{1,2})-(\d{1,2})/g, function(_, y, m, d) {
            return y + '/' + parseInt(m, 10) + '/' + parseInt(d, 10);
          }) || s;
        }
        var staffBarEl = document.getElementById('staffSelectorBar');
        var staffBarVisible = staffBarEl && staffBarEl.style.display !== 'none';
        var isStaffView = window.staffMode || !window.isOwnerUser || staffBarVisible;
        var hideForStaff = (type === 'cleaning' && isStaffView);
        var hideGuestInfoForStaff = isStaffView;
        var hideForOwnerCleaning = (type === 'cleaning' && !isStaffView);

        // BBQバッジ判定
        function bbqBadge(val) {
          var flag = getBBQFlag(val);
          if (flag === '有') return '<span class="modal-badge modal-badge-yes"><i class="bi bi-fire"></i>BBQ あり</span>';
          if (flag === '無') return '<span class="modal-badge modal-badge-no"><i class="bi bi-x-circle"></i>BBQ なし</span>';
          return '<span class="modal-badge modal-badge-no"><i class="bi bi-question-circle"></i>BBQ ' + fmt(val) + '</span>';
        }
        // 駐車場バッジ判定
        function parkingBadge(val) {
          var flag = getParkingFlag(val) || '';
          if (flag === '不要') return '<span class="modal-badge modal-badge-no"><i class="bi bi-p-circle"></i>有料駐車場 不要</span>';
          if (flag === '1台' || flag === '2台') return '<span class="modal-badge modal-badge-yes"><i class="bi bi-p-circle-fill"></i>有料駐車場 ' + flag + '</span>';
          if (val) return '<span class="modal-badge modal-badge-no"><i class="bi bi-p-circle"></i>有料駐車場 ' + fmt(val) + '</span>';
          return '';
        }

        let html = '';
        if (d) {
          // === 清掃詳細 ===
          if (type === 'cleaning') {
            // チェックアウト日（目立つ表示）
            html += '<div class="modal-prominent-date"><i class="bi bi-calendar-event"></i>' + formatDateTimeDisplay(d.checkOut) + '</div>';

            // 人数
            var guestDisp = d.guestCountDisplay != null ? d.guestCountDisplay : formatGuestCount(d);
            html += '<div class="detail-row"><span class="detail-label"><strong><i class="bi bi-people-fill"></i> 宿泊人数:</strong></span><span class="detail-value">' + fmt(guestDisp) + '</span></div>';

            // BBQ・駐車場バッジ
            html += '<div class="modal-badge-row">';
            html += bbqBadge(d.bbq);
            var pBadge = parkingBadge(d.parking);
            if (pBadge) html += pBadge;
            html += '</div>';

            // 次回予約の情報カード
            html += '<div id="eventModalStaffNextResArea" class="modal-next-res-card">';
            html += '<div class="card-title-sm"><i class="bi bi-info-circle"></i>次回予約の情報（変更の可能性あり）</div>';
            html += '<div class="modal-next-res-grid" id="eventModalStaffNextResContent"><div class="nres-item" style="grid-column:1/-1; text-align:center; padding:0.5rem 0;"><span class="spinner-border spinner-border-sm text-secondary me-2" role="status"></span><span class="text-muted">読み込み中…</span></div></div>';
            html += '<div class="mt-2"><span id="eventModalStaffRecruitStatus" class="recruit-status-badge px-2 py-1 rounded text-muted" style="background:#e9ecef;">読み込み中…</span></div>';
            html += '<div id="eventModalVolunteersArea" class="mt-2" style="display:none;"><span class="detail-label"><strong>立候補者:</strong></span> <span id="eventModalVolunteersList"></span></div>';
            html += '</div>';

            // 清掃担当（次回予約の下、連絡事項の上）
            var staffVal = (d.cleaningStaff || '').trim();
            var staffUndecided = !staffVal;
            html += '<div class="modal-section-divider"></div>';
            html += '<div class="modal-staff-label ' + (staffUndecided ? 'staff-unset' : 'staff-set') + '"><i class="bi bi-person-badge"></i>清掃担当:</div>';
            html += '<div class="modal-staff-name" id="eventModalStaffDisplay">' + fmt(staffVal || '(未設定)') + '</div>';

            // 連絡事項（オーナー: 編集可, スタッフ: 閲覧のみ）
            {
              html += '<div class="modal-section-divider"></div>';
              html += '<div class="modal-memo-area"><label><i class="bi bi-chat-left-text"></i> 連絡事項</label>';
              if (!isStaffView) {
                html += '<textarea id="cleaningNoticeTextarea" class="form-control form-control-sm" rows="3" data-row="' + props.rowNumber + '">' + fmt(d.cleaningNotice || '') + '</textarea>';
                html += '<div class="text-end mt-1"><button id="btnSaveNotice" class="btn btn-sm btn-primary" onclick="saveCleaningNoticeUI()">連絡事項を保存</button></div>';
              } else {
                html += '<div class="form-control form-control-sm" style="min-height:2.5rem;background:#f8f9fa;white-space:pre-wrap;">' + fmt(d.cleaningNotice || '') + '</div>';
              }
              html += '</div>';
            }

            // スタッフ用: 立候補エリア（条件欄+ボタン、body内に配置）
            html += '<div id="eventModalVolunteerBodyArea" class="mt-3"></div>';

            // LINE用テキスト（オーナーのみ）
            if (!isStaffView) {
              html += '<div id="eventModalLineCopyArea" class="mb-2 mt-2 p-2 border rounded bg-light" style="display:none;"><p class="small fw-bold mb-1">LINE用テキスト（コピーしてLINEグループに投稿）</p><textarea id="eventModalLineCopyText" class="form-control font-monospace small mb-2" rows="6"></textarea><button type="button" class="btn btn-sm btn-primary" id="eventModalCopyToClipboard">コピー</button></div>';
            }
          }

          // === 宿泊詳細 ===
          if (type === 'booking') {
            // チェックイン・チェックアウト 横並び
            html += '<div class="modal-date-pair">';
            html += '<div class="date-item"><div class="date-label"><i class="bi bi-box-arrow-in-right"></i> チェックイン</div><div class="date-val">' + formatDateTimeDisplay(d.checkIn) + '</div></div>';
            html += '<div class="date-item"><div class="date-label"><i class="bi bi-box-arrow-right"></i> チェックアウト</div><div class="date-val">' + formatDateTimeDisplay(d.checkOut) + '</div></div>';
            html += '</div>';

            // 宿泊者名（折りたたみ表示、代表者は常時表示）
            if (!hideGuestInfoForStaff) {
              var gnList = d.guestNames && d.guestNames.length ? d.guestNames : (d.guestName ? [{ name: d.guestName, age: '' }] : []);
              if (gnList.length > 0) {
                var rep = gnList[0];
                var repDisp = fmt(rep.name) + (rep.age ? ' <span class="text-muted small">(' + fmt(rep.age) + ')</span>' : '');
                html += '<div class="detail-row"><span class="detail-label"><strong><i class="bi bi-person"></i> 宿泊者名:</strong></span><span class="detail-value">' + repDisp;
                if (gnList.length > 1) {
                  html += ' <a href="#" class="small text-decoration-none" data-bs-toggle="collapse" data-bs-target="#guestListCollapse" role="button">...他' + (gnList.length - 1) + '名 <i class="bi bi-chevron-down"></i></a>';
                  html += '<div class="collapse mt-1" id="guestListCollapse">';
                  for (var gni = 1; gni < gnList.length; gni++) {
                    html += '<div>' + fmt(gnList[gni].name) + (gnList[gni].age ? ' <span class="text-muted small">(' + fmt(gnList[gni].age) + ')</span>' : '') + '</div>';
                  }
                  html += '</div>';
                }
                html += '</span></div>';
              }
            }

            // 人数
            var guestDisp = d.guestCountDisplay != null ? d.guestCountDisplay : formatGuestCount(d);
            html += '<div class="detail-row"><span class="detail-label"><strong><i class="bi bi-people-fill"></i> 宿泊人数:</strong></span><span class="detail-value">' + fmt(guestDisp) + '</span></div>';
            // ベッド（2名の場合のみ）
            var totalGuests = (parseInt(d.guestCountAdults, 10) || 0) + (parseInt(d.guestCountInfants, 10) || 0);
            if (totalGuests === 2 && d.bedChoice && !hideForStaff && !hideForOwnerCleaning) {
              html += '<div class="detail-row"><span class="detail-label"><strong><i class="bi bi-lamp"></i> ベッド:</strong></span><span class="detail-value">' + fmt(d.bedChoice) + '</span></div>';
            }

            // 予約サイト（オーナーのみ）
            if (!isStaffView) {
              html += '<div class="detail-row"><span class="detail-label"><strong><i class="bi bi-globe2"></i> 予約サイト:</strong></span><span class="detail-value">' + fmt(d.bookingSite) + '</span></div>';
            }

            // 交通手段
            var carValAll = (d.carDisplay || '-').toString().split('\n').map(function(p){ return escapeHtml(p); }).join('<br>');
            html += '<div class="detail-row"><span class="detail-label"><strong><i class="bi bi-car-front"></i> 交通手段:</strong></span><span class="detail-value">' + (carValAll || '-') + '</span></div>';

            // 国籍
            html += '<div class="detail-row"><span class="detail-label"><strong><i class="bi bi-globe"></i> 国籍:</strong></span><span class="detail-value">' + fmt(d.nationality || '日本') + '</span></div>';

            // BBQ・有料駐車場（国籍の下）
            html += '<div class="detail-row"><span class="detail-label"><strong><i class="bi bi-fire"></i> BBQ:</strong></span><span class="detail-value">' + fmt(getBBQFlag(d.bbq) || '-') + '</span></div>';
            var parkFlag = getParkingFlag(d.parking) || '';
            if (d.parking || parkFlag) {
              html += '<div class="detail-row"><span class="detail-label"><strong><i class="bi bi-p-circle"></i> 有料駐車場:</strong></span><span class="detail-value">' + fmt(parkFlag || d.parking || '-') + '</span></div>';
            }

            // 連絡先情報（オーナーのみ）
            if (!isStaffView) {
              if (d.tel1 || d.tel2) {
                html += '<div class="modal-section-divider"></div>';
                if (d.tel1) html += '<div class="detail-row"><span class="detail-label"><strong><i class="bi bi-telephone"></i> TEL1:</strong></span><span class="detail-value" style="padding-left:0.5rem;">' + fmt(d.tel1) + '</span></div>';
                if (d.tel2) html += '<div class="detail-row"><span class="detail-label"><strong><i class="bi bi-telephone"></i> TEL2:</strong></span><span class="detail-value" style="padding-left:0.5rem;">' + fmt(d.tel2) + '</span></div>';
              }
              var emailVal = (d.email || d.email2 || '').trim();
              html += '<div class="detail-row"><span class="detail-label"><strong><i class="bi bi-envelope"></i> メール:</strong></span><span class="detail-value">' + fmt(emailVal || '-') + '</span></div>';
            }

            // 目的（オーナーのみ）
            if (!isStaffView && d.purpose) {
              html += '<div class="detail-row"><span class="detail-label"><strong><i class="bi bi-signpost-2"></i> 目的:</strong></span><span class="detail-value">' + fmt(d.purpose) + '</span></div>';
            }

            // パスポート（オーナーのみ）
            if (!isStaffView && d.passportUrls && d.passportUrls.length) {
              html += '<div class="detail-row"><span class="detail-label"><strong><i class="bi bi-card-image"></i> パスポート:</strong></span><span class="detail-value">';
              d.passportUrls.forEach(function(url, idx) {
                if (url) html += '<a href="' + escapeHtml(url) + '" target="_blank" rel="noopener">写真' + (idx + 1) + '</a> ';
              });
              html += '</span></div>';
            }

            // 清掃担当
            var staffVal = (d.cleaningStaff || '').trim();
            var staffUndecided = !staffVal;
            html += '<div class="modal-section-divider"></div>';
            html += '<div class="modal-staff-label ' + (staffUndecided ? 'staff-unset' : 'staff-set') + '"><i class="bi bi-person-badge"></i>清掃担当:</div>';
            html += '<div class="modal-staff-name" id="eventModalStaffDisplay">' + fmt(staffVal || '(未設定)') + '</div>';

            // 募集状況バッジ（オーナーのみ）
            if (!isStaffView) {
              var recruitRec = (window._recruitFullMap || {})[props.rowNumber];
              var rStatus = recruitRec ? (recruitRec.status || '') : '';
              var rLabel = rStatus === '募集中' ? '清掃募集中' : (rStatus === '選定済' ? '選定済' : '未募集');
              var rClass = rStatus === '募集中' ? 'status-recruiting' : (rStatus === '選定済' ? 'status-decided' : 'status-undecided');
              html += '<div class="mt-1"><span class="recruit-status-badge px-2 py-1 rounded ' + rClass + '">' + rLabel + '</span></div>';
            }

            // メモ（オーナー: 編集可, スタッフ: 閲覧のみ）
            if (d.memo || !isStaffView) {
              html += '<div class="modal-memo-area"><label><i class="bi bi-journal-text"></i> メモ</label>';
              if (!isStaffView) {
                html += '<textarea id="bookingMemoTextarea" class="form-control form-control-sm" rows="3" data-row="' + props.rowNumber + '">' + fmt(d.memo || '') + '</textarea>';
                html += '<div class="text-end mt-1"><button id="btnSaveMemo" class="btn btn-sm btn-primary" onclick="saveBookingMemoUI()">メモを保存</button></div>';
              } else {
                html += '<div class="form-control form-control-sm" style="min-height:2.5rem;background:#f8f9fa;white-space:pre-wrap;">' + fmt(d.memo || '') + '</div>';
              }
              html += '</div>';
            }
          }
        }
        document.getElementById('eventModalBody').innerHTML = html || '<p>データがありません。</p>';

        var isStaff = isStaffView;
        // フッターボタン設定
        var actionBtns = document.getElementById('eventModalActionBtns');
        if (actionBtns) actionBtns.innerHTML = '';
        var deleteArea = document.getElementById('eventModalDeleteArea');
        var btnDel = document.getElementById('btnDeleteBooking');
        if (btnDel) {
          var showDel = (type === 'booking' && !isStaffView);
          if (showDel) {
            deleteArea.style.display = '';
            btnDel.dataset.rowNumber = props.rowNumber;
            if (d) {
              btnDel.dataset.checkIn = (d.checkIn || '').toString();
              btnDel.dataset.checkOut = (d.checkOut || '').toString();
              btnDel.dataset.guestName = (d.guestName || '').toString();
            }
          } else {
            deleteArea.style.display = 'none';
          }
        }
        var centerArea = document.getElementById('eventModalVolunteerCenter');
        if (centerArea) {
          centerArea.innerHTML = '';
          if (type === 'booking') {
            centerArea.style.display = 'none';
          } else {
            centerArea.style.display = '';
          }
        }

        const modal = new bootstrap.Modal(document.getElementById('eventModal'));
        modal.show();

        // キャッシュから次回予約情報を即時表示（サーバー応答を待たずに表示）
        if (type === 'cleaning') {
          var cachedRec = (window._recruitFullMap || {})[props.rowNumber];
          var cachedNextRes = cachedRec ? cachedRec.nextReservation : ((window._nextResCache || {})[props.rowNumber] || null);
          if (cachedNextRes || cachedRec) {
            var nextEl = document.getElementById('eventModalStaffNextResContent');
            var statusEl = document.getElementById('eventModalStaffRecruitStatus');
            var volArea = document.getElementById('eventModalVolunteersArea');
            var volList = document.getElementById('eventModalVolunteersList');
            if (nextEl && cachedNextRes) {
              var nr = cachedNextRes;
              var dateDisp = fmtDateRange(nr.date);
              nextEl.innerHTML = '<div class="nres-item"><span class="nres-label">日付:</span><span class="nres-value">' + escapeHtml(dateDisp) + '</span></div><div class="nres-item"><span class="nres-label">人数:</span><span class="nres-value">' + fmt(nr.guestCount) + '</span></div><div class="nres-item"><span class="nres-label">BBQ:</span><span class="nres-value">' + fmt(nr.bbq) + '</span></div><div class="nres-item"><span class="nres-label">国籍:</span><span class="nres-value">' + fmt(nr.nationality || '日本') + '</span></div><div class="nres-item"><span class="nres-label">ベッド数:</span><span class="nres-value">' + fmt(nr.bedCount) + '</span></div>';
            }
            if (statusEl && cachedRec) {
              var cachedStaffAssigned = (d.cleaningStaff || '').trim();
              var cStatus = cachedStaffAssigned ? '選定済' : (cachedRec.status || '');
              statusEl.textContent = cStatus === '募集中' ? '清掃募集中' : (cStatus === '選定済' ? '選定済' : '未募集');
              statusEl.className = 'recruit-status-badge px-2 py-1 rounded ' + (cStatus === '募集中' ? 'status-recruiting' : (cStatus === '選定済' ? 'status-decided' : 'status-undecided'));
            }
            if (volArea && volList && cachedRec && cachedRec.volunteers) {
              if (!((d.cleaningStaff || '').trim()) && (cachedRec.status || '') === '募集中') {
                volArea.style.display = 'block';
                volList.textContent = cachedRec.volunteers.length ? cachedRec.volunteers.map(function(v) { return v.staffName; }).join(', ') : 'なし';
              }
            }
          }
        }

        if (isStaff && type === 'cleaning') {
          google.script.run.withSuccessHandler(function(rStr) {
            if (modalGen !== window._eventModalGen) return; // 古いコールバックを無視
            try {
              var r = JSON.parse(rStr);
              var nextEl = document.getElementById('eventModalStaffNextResContent');
              var statusEl = document.getElementById('eventModalStaffRecruitStatus');
              var volArea = document.getElementById('eventModalVolunteersArea');
              var volList = document.getElementById('eventModalVolunteersList');
              if (nextEl && r.success) {
                var nr = r.nextReservation || {};
                if (nr.date) {
                  var dateDisp = fmtDateRange(nr.date);
                  nextEl.innerHTML = '<div class="nres-item"><span class="nres-label">日付:</span><span class="nres-value">' + escapeHtml(dateDisp) + '</span></div><div class="nres-item"><span class="nres-label">人数:</span><span class="nres-value">' + fmt(nr.guestCount) + '</span></div><div class="nres-item"><span class="nres-label">BBQ:</span><span class="nres-value">' + fmt(nr.bbq) + '</span></div><div class="nres-item"><span class="nres-label">国籍:</span><span class="nres-value">' + fmt(nr.nationality || '日本') + '</span></div><div class="nres-item"><span class="nres-label">ベッド数:</span><span class="nres-value">' + fmt(nr.bedCount) + '</span></div>';
                } else {
                  nextEl.innerHTML = '<div class="nres-item" style="grid-column:1/-1;"><span class="text-muted">次回予約なし</span></div>';
                }
              } else if (nextEl) {
                nextEl.innerHTML = '<div class="nres-item" style="grid-column:1/-1;"><span class="text-muted">取得できませんでした</span></div>';
              }
              var volBodyArea = document.getElementById('eventModalVolunteerBodyArea');
              var staffAssigned = (d.cleaningStaff || '').trim();
              // cleaningStaff設定済みなら実質「選定済」として扱う
              var effectiveStatus = staffAssigned ? '選定済' : r.status;
              if (statusEl && r.success) {
                statusEl.textContent = effectiveStatus === '募集中' ? '清掃募集中' : (effectiveStatus === '選定済' ? '選定済' : '未募集');
                statusEl.className = 'recruit-status-badge px-2 py-1 rounded ' + (effectiveStatus === '募集中' ? 'status-recruiting' : (effectiveStatus === '選定済' ? 'status-decided' : 'status-undecided'));
              }
              if (volArea && volList && r.success) {
                if (effectiveStatus === '募集中') {
                  volArea.style.display = 'block';
                  volList.textContent = (r.volunteers && r.volunteers.length) ? r.volunteers.map(function(v) { return v.staffName; }).join(', ') : 'なし';
                } else {
                  volArea.style.display = 'none';
                }
              }
              // キャンセル申請: 選定済 or cleaningStaffが設定済みの場合、本人にのみ表示
              if (r.success && r.recruitRowIndex && (r.status === '選定済' || staffAssigned) && centerArea) {
                var assignedStaff = r.selectedStaff || staffAssigned;
                var curName2 = (window.currentUserName || '').trim();
                var curEmail2 = (window.currentUserEmail || '').trim().toLowerCase();
                var selectedParts = (assignedStaff || '').split(/[,、]/).map(function(s) { return s.trim(); }).filter(Boolean);
                var isSelected = selectedParts.some(function(part) {
                  var p = part.toLowerCase();
                  return (curName2 && curName2.toLowerCase() === p) || (curEmail2 && p.indexOf('@') >= 0 && p === curEmail2);
                });
                if (isSelected) {
                  // キャンセル否認チェック
                  var wasRejected = r.cancelRejected && r.cancelRejected.some(function(cr) {
                    return (curName2 && cr.staffName === curName2) || (curEmail2 && cr.email === curEmail2);
                  });
                  // 既にキャンセル申請済みかチェック
                  var alreadyRequested = r.cancelRequested && r.cancelRequested.some(function(cr) {
                    return (curName2 && cr.staffName === curName2) || (curEmail2 && cr.email === curEmail2);
                  });
                  if (wasRejected) {
                    // 否認通知 + 確認ボタン → 確認後にキャンセル申請ボタン復活
                    var rejWrap = document.createElement('div');
                    rejWrap.className = 'mb-1';
                    var rejBadge = document.createElement('div');
                    rejBadge.className = 'alert alert-danger py-1 px-2 small mb-1';
                    rejBadge.innerHTML = '<i class="bi bi-x-circle"></i> キャンセル申請が否認されました';
                    rejWrap.appendChild(rejBadge);
                    var rejConfirmBtn = document.createElement('button');
                    rejConfirmBtn.type = 'button';
                    rejConfirmBtn.className = 'btn btn-sm btn-outline-secondary';
                    rejConfirmBtn.textContent = '確認';
                    rejConfirmBtn.onclick = function() {
                      rejConfirmBtn.disabled = true;
                      rejConfirmBtn.textContent = '処理中...';
                      google.script.run.withSuccessHandler(function(j) {
                        // モーダルを再読み込み
                        bootstrap.Modal.getInstance(document.getElementById('eventModal')).hide();
                        loadAndRender();
                        if (window.staffMode) loadStaffSchedule();
                      }).withFailureHandler(function(e) {
                        rejConfirmBtn.disabled = false;
                        rejConfirmBtn.textContent = '確認';
                      }).clearCancelRejection(r.recruitRowIndex, window.currentUserName || '', window.currentUserEmail || '');
                    };
                    rejWrap.appendChild(rejConfirmBtn);
                    centerArea.appendChild(rejWrap);
                  } else if (alreadyRequested) {
                    var pendingBadge = document.createElement('div');
                    pendingBadge.className = 'alert alert-warning py-1 px-2 small mb-0';
                    pendingBadge.innerHTML = '<i class="bi bi-hourglass-split"></i> キャンセル申請中（オーナーの承認待ち）';
                    centerArea.appendChild(pendingBadge);
                  } else {
                    var cancelReqBtn = document.createElement('button');
                    cancelReqBtn.type = 'button';
                    cancelReqBtn.className = 'btn btn-sm btn-danger me-1';
                    cancelReqBtn.textContent = 'キャンセル申請';
                    cancelReqBtn.onclick = function() {
                      if (!confirm('出勤キャンセルの要望を提出します。\n\nよろしいですか？（OK=はい、キャンセル=いいえ）')) return;
                      // 即座にUIフィードバック（サーバー応答を待たない）
                      cancelReqBtn.disabled = true;
                      cancelReqBtn.textContent = '申請中...';
                      cancelReqBtn.className = 'btn btn-sm btn-secondary me-1';
                      google.script.run.withSuccessHandler(function(j) {
                        var res = JSON.parse(j);
                        if (res.success) {
                          bootstrap.Modal.getInstance(document.getElementById('eventModal')).hide();
                          loadAndRender();
                          if (window.staffMode) loadStaffSchedule();
                        } else { alert(res.error || '失敗'); cancelReqBtn.disabled = false; cancelReqBtn.textContent = 'キャンセル申請'; cancelReqBtn.className = 'btn btn-sm btn-danger me-1'; }
                      }).withFailureHandler(function(e) { alert(e.message); cancelReqBtn.disabled = false; cancelReqBtn.textContent = 'キャンセル申請'; cancelReqBtn.className = 'btn btn-sm btn-danger me-1'; }).submitStaffCancelRequest(r.recruitRowIndex, props.rowNumber, r.checkoutDate || '', window.currentUserName || '', window.currentUserEmail || '');
                    };
                    centerArea.appendChild(cancelReqBtn);
                  }
                }
              }
              if (r.success && r.status === '募集中' && r.recruitRowIndex && !staffAssigned) {
                var curName = (window.currentUserName || '').trim().toLowerCase();
                var curEmail = (window.currentUserEmail || '').trim().toLowerCase();
                var hasVol = r.volunteers && r.volunteers.some(function(v) {
                  return (v.staffName || '').trim().toLowerCase() === curName || (v.email || '').trim().toLowerCase() === curEmail;
                });
                if (volBodyArea) {
                  if (!hasVol) {
                    var memoWrap = document.createElement('div');
                    memoWrap.className = 'mb-2';
                    memoWrap.innerHTML = '<label class="form-label small fw-bold">対応可能な条件（例：時間帯：10:00～、午後から可、13:00～可など）</label><input type="text" class="form-control form-control-sm" id="eventModalVolunteerMemo" placeholder="時間帯：10:00～" value="時間帯：10:00～">';
                    volBodyArea.appendChild(memoWrap);
                  }
                  var btn = document.createElement('button');
                  btn.type = 'button';
                  btn.className = 'btn btn-sm btn-' + (hasVol ? 'warning' : 'success') + ' w-100';
                  btn.textContent = hasVol ? '立候補の取消' : '立候補';
                  btn.onclick = function() {
                    if (hasVol) {
                      if (!confirm('立候補を取り消しますか？')) return;
                      google.script.run.withSuccessHandler(function(j) {
                        var res = JSON.parse(j);
                        if (res.success) {
                          bootstrap.Modal.getInstance(document.getElementById('eventModal')).hide();
                          loadAndRender();
                          if (window.staffMode) loadStaffSchedule();
                          else loadRecruitList();
                        } else alert(res.error || '失敗');
                      }).withFailureHandler(function(e) { alert(e.message); }).cancelVolunteerForRecruitment('r' + r.recruitRowIndex, window.currentUserName || '', window.currentUserEmail || '');
                    } else {
                      if (!confirm('立候補しますか？\n\nはい／いいえ')) return;
                      var memoEl = document.getElementById('eventModalVolunteerMemo');
                      var memoVal = (memoEl && memoEl.value) ? String(memoEl.value).trim() : '';
                      volunteer('r' + r.recruitRowIndex, memoVal);
                      bootstrap.Modal.getInstance(document.getElementById('eventModal')).hide();
                      loadAndRender();
                      loadRecruitList();
                    }
                  };
                  volBodyArea.appendChild(btn);
                }
              }
            } catch (e) {}
          }).withFailureHandler(function() {
            if (modalGen !== window._eventModalGen) return;
            var nEl = document.getElementById('eventModalStaffNextResContent');
            if (nEl) nEl.innerHTML = '<div class="nres-item" style="grid-column:1/-1;"><span class="text-muted">取得できませんでした</span></div>';
            var sEl = document.getElementById('eventModalStaffRecruitStatus');
            if (sEl) { sEl.textContent = '－'; sEl.className = 'recruit-status-badge px-2 py-1 rounded status-undecided'; }
          }).getRecruitmentForBooking(props.rowNumber);
        }

        if (type === 'cleaning' && !isStaff) {
          google.script.run.withSuccessHandler(function(rStr) {
            if (modalGen !== window._eventModalGen) return; // 古いコールバックを無視
            try {
              var r = JSON.parse(rStr);
              var nextEl = document.getElementById('eventModalStaffNextResContent');
              var statusEl = document.getElementById('eventModalStaffRecruitStatus');
              var volArea = document.getElementById('eventModalVolunteersArea');
              var volList = document.getElementById('eventModalVolunteersList');
              var ownerCenterArea = centerArea;
              if (nextEl && r.success) {
                var nr = r.nextReservation || {};
                if (nr.date) {
                  var dateDisp = fmtDateRange(nr.date);
                  nextEl.innerHTML = '<div class="nres-item"><span class="nres-label">日付:</span><span class="nres-value">' + escapeHtml(dateDisp) + '</span></div><div class="nres-item"><span class="nres-label">人数:</span><span class="nres-value">' + fmt(nr.guestCount) + '</span></div><div class="nres-item"><span class="nres-label">BBQ:</span><span class="nres-value">' + fmt(nr.bbq) + '</span></div><div class="nres-item"><span class="nres-label">国籍:</span><span class="nres-value">' + fmt(nr.nationality || '日本') + '</span></div><div class="nres-item"><span class="nres-label">ベッド数:</span><span class="nres-value">' + fmt(nr.bedCount) + '</span></div>';
                } else {
                  nextEl.innerHTML = '<div class="nres-item" style="grid-column:1/-1;"><span class="text-muted">次回予約なし</span></div>';
                }
              } else if (nextEl) {
                nextEl.innerHTML = '<div class="nres-item" style="grid-column:1/-1;"><span class="text-muted">取得できませんでした</span></div>';
              }
              var ownerStaffAssigned = (d.cleaningStaff || '').trim();
              var ownerEffectiveStatus = ownerStaffAssigned ? '選定済' : r.status;
              if (statusEl && r.success) {
                statusEl.textContent = ownerEffectiveStatus === '募集中' ? '清掃募集中' : (ownerEffectiveStatus === '選定済' ? '選定済' : '未募集');
                statusEl.className = 'recruit-status-badge px-2 py-1 rounded ' + (ownerEffectiveStatus === '募集中' ? 'status-recruiting' : (ownerEffectiveStatus === '選定済' ? 'status-decided' : 'status-undecided'));
              }
              if (volArea && volList && r.success) {
                if (ownerEffectiveStatus === '募集中') {
                  volArea.style.display = 'block';
                  volList.textContent = (r.volunteers && r.volunteers.length) ? r.volunteers.map(function(v) { return v.staffName; }).join(', ') : 'なし';
                } else {
                  volArea.style.display = r.volunteers && r.volunteers.length ? 'block' : 'none';
                  if (r.volunteers && r.volunteers.length) volList.textContent = r.volunteers.map(function(v) { return v.staffName; }).join(', ');
                }
              }
              if (!ownerStaffAssigned && ownerCenterArea && r.success) {
                var rowNum = props.rowNumber;
                var checkoutDate = (d && d.checkOut) ? (d.checkOutParsed || String(d.checkOut).slice(0,10)) : '';
                if (!r.recruitRowIndex) {
                  var startBtn = document.createElement('button');
                  startBtn.type = 'button';
                  startBtn.className = 'btn btn-sm btn-primary me-1';
                  startBtn.id = 'eventModalBtnStartRecruit';
                  startBtn.textContent = '募集開始';
                  if (startBtn)                   startBtn.onclick = function() {
                    var detail = { date:'', guestCount:'', bbq:'', nationality:'日本', memo:'', cleaningStaff:'', notifyMethod:'メール' };
                    google.script.run.withSuccessHandler(function(j) {
                      var res = JSON.parse(j);
                      if (res.success && !res.alreadyExists && res.rowIndex) {
                        ownerCenterArea.innerHTML = '';
                        var emPopMail = document.createElement('button');
                        emPopMail.type = 'button';
                        emPopMail.className = 'btn btn-sm btn-primary me-1';
                        emPopMail.textContent = 'メール送信';
                        emPopMail.onclick = function() {
                          if (!confirm('登録者全員に一斉送信します。よろしいですか？')) return;
                          google.script.run.withSuccessHandler(function(a) {
                            var ann = JSON.parse(a);
                            if (ann.success) { alert('募集を開始しました。メールで送信しました。'); bootstrap.Modal.getInstance(document.getElementById('eventModal')).hide(); loadAndRender(); loadRecruitList(); }
                            else alert(ann.error || '失敗');
                          }).announceRecruitment(res.rowIndex);
                        };
                        var emPopCopy = document.createElement('button');
                        emPopCopy.type = 'button';
                        emPopCopy.className = 'btn btn-sm btn-info text-white me-1';
                        emPopCopy.textContent = 'テキストコピー';
                        emPopCopy.onclick = function() {
                          google.script.run.withSuccessHandler(function(t) {
                            var jt = JSON.parse(t);
                            var lineArea = document.getElementById('eventModalLineCopyArea');
                            var txtEl = document.getElementById('eventModalLineCopyText');
                            var btnCopy = document.getElementById('eventModalCopyToClipboard');
                            if (jt.success && jt.copyText && lineArea && txtEl) {
                              txtEl.value = jt.copyText;
                              lineArea.style.display = 'block';
                              lineArea.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                              if (btnCopy) btnCopy.onclick = function() {
                                if (navigator.clipboard && navigator.clipboard.writeText) {
                                  navigator.clipboard.writeText(jt.copyText).then(function() {
                                    bootstrap.Modal.getInstance(document.getElementById('eventModal')).hide();
                                    loadAndRender();
                                    loadRecruitList();
                                  }).catch(function() { txtEl.select(); document.execCommand('copy'); bootstrap.Modal.getInstance(document.getElementById('eventModal')).hide(); loadAndRender(); loadRecruitList(); });
                                } else {
                                  txtEl.select();
                                  document.execCommand('copy');
                                  bootstrap.Modal.getInstance(document.getElementById('eventModal')).hide();
                                  loadAndRender();
                                  loadRecruitList();
                                }
                              };
                            } else if (!jt.success) alert(jt.error || 'コピーに失敗しました');
                          }).getRecruitmentCopyText(checkoutDate, rowNum, detail);
                        };
                        ownerCenterArea.appendChild(emPopMail);
                        ownerCenterArea.appendChild(emPopCopy);
                      } else if (res.alreadyExists) {
                        alert('この予約は既に募集済みです。');
                      }
                    }).saveRecruitmentDetail(null, rowNum, checkoutDate, detail);
                  };
                  ownerCenterArea.appendChild(startBtn);
                } else {
                  var hasVol = r.volunteers && r.volunteers.length > 0;
                  var emBtnMail = document.createElement('button');
                  emBtnMail.type = 'button';
                  emBtnMail.className = 'btn btn-sm btn-primary me-1';
                  emBtnMail.textContent = 'メール送信';
                  emBtnMail.onclick = function() {
                    if (!confirm('登録者全員に一斉送信します。よろしいですか？')) return;
                    google.script.run.withSuccessHandler(function(a) {
                      var ann = JSON.parse(a);
                      if (ann.success) { alert('メールで送信しました。'); bootstrap.Modal.getInstance(document.getElementById('eventModal')).hide(); loadAndRender(); loadRecruitList(); }
                      else alert(ann.error || '失敗');
                    }).announceRecruitment(r.recruitRowIndex);
                  };
                  var emBtnCopy = document.createElement('button');
                  emBtnCopy.type = 'button';
                  emBtnCopy.className = 'btn btn-sm btn-info text-white me-1';
                  emBtnCopy.textContent = 'テキストコピー';
                  emBtnCopy.onclick = function() {
                    google.script.run.withSuccessHandler(function(t) {
                      var jt = JSON.parse(t);
                      var lineArea = document.getElementById('eventModalLineCopyArea');
                      var txtEl = document.getElementById('eventModalLineCopyText');
                      var btnCopy = document.getElementById('eventModalCopyToClipboard');
                      if (jt.success && jt.copyText && lineArea && txtEl) {
                        txtEl.value = jt.copyText;
                        lineArea.style.display = 'block';
                        lineArea.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                        if (btnCopy) {
                          btnCopy.onclick = function() {
                            if (navigator.clipboard && navigator.clipboard.writeText) navigator.clipboard.writeText(jt.copyText).then(function() { alert('コピーしました。LINEに貼り付けてください。'); }).catch(function() { txtEl.select(); document.execCommand('copy'); alert('コピーしました。'); });
                            else { txtEl.select(); document.execCommand('copy'); alert('コピーしました。'); }
                          };
                        }
                      } else if (!jt.success) alert(jt.error || 'コピーに失敗しました');
                    }).getRecruitmentCopyText(r.checkoutDate || checkoutDate, rowNum, { date:'', guestCount:'', bbq:'', nationality:'日本', memo:'' });
                  };
                  var emBtnCancel = document.createElement('button');
                  emBtnCancel.type = 'button';
                  emBtnCancel.className = 'btn btn-sm btn-danger me-1';
                  emBtnCancel.textContent = '募集取消';
                  emBtnCancel.onclick = function() {
                    var volCount = r.volunteers && r.volunteers.length ? r.volunteers.length : 0;
                    if (volCount > 0 && !confirm('立候補者が' + volCount + '名います。募集を取消しますか？')) return;
                    if (volCount === 0 && !confirm('募集を取消しますか？')) return;
                    google.script.run.withSuccessHandler(function(j) {
                      var res = JSON.parse(j);
                      if (res.success) { bootstrap.Modal.getInstance(document.getElementById('eventModal')).hide(); loadAndRender(); loadRecruitList(); }
                      else alert(res.error);
                    }).deleteRecruitment(r.recruitRowIndex);
                  };
                  ownerCenterArea.appendChild(emBtnMail);
                  ownerCenterArea.appendChild(emBtnCopy);
                  if (hasVol) {
                    var emBtnSelect = document.createElement('button');
                    emBtnSelect.type = 'button';
                    emBtnSelect.className = 'btn btn-sm btn-success me-1';
                    emBtnSelect.textContent = 'スタッフ選定';
                    emBtnSelect.onclick = function() {
                      bootstrap.Modal.getInstance(document.getElementById('eventModal')).hide();
                      openRecruitSelectModal({ rowIndex: r.recruitRowIndex, volunteers: r.volunteers || [], checkoutDate: r.checkoutDate || checkoutDate, selectedStaff: r.selectedStaff || (d.cleaningStaff || '') });
                    };
                    ownerCenterArea.appendChild(emBtnSelect);
                  }
                  ownerCenterArea.appendChild(emBtnCancel);
                }
              }
              if ((d.cleaningStaff || '').trim() && ownerCenterArea) {
                var btnEditStaff = document.createElement('button');
                btnEditStaff.type = 'button';
                btnEditStaff.className = 'btn btn-sm btn-secondary me-1';
                btnEditStaff.textContent = '清掃担当を編集';
                btnEditStaff.onclick = function() {
                  bootstrap.Modal.getInstance(document.getElementById('eventModal')).hide();
                  openStaffEditModal(props.rowNumber, (d.cleaningStaff || '').trim());
                };
                ownerCenterArea.appendChild(btnEditStaff);
              }
              // キャンセル申請がある場合、承認ボタンを表示
              if (r.cancelRequested && r.cancelRequested.length && r.recruitRowIndex && ownerCenterArea) {
                r.cancelRequested.forEach(function(cr) {
                  var approveWrap = document.createElement('div');
                  approveWrap.className = 'w-100 mt-2 p-2 border border-warning rounded bg-warning bg-opacity-10';
                  approveWrap.innerHTML = '<div class="small fw-bold text-warning mb-1"><i class="bi bi-exclamation-triangle"></i> キャンセル申請: ' + escapeHtml(cr.staffName) + '</div>';
                  var btnApprove = document.createElement('button');
                  btnApprove.type = 'button';
                  btnApprove.className = 'btn btn-sm btn-warning me-1';
                  btnApprove.textContent = 'キャンセル承認';
                  btnApprove.onclick = function() {
                    if (!confirm(cr.staffName + ' のキャンセルを承認しますか？\n\n承認すると清掃担当が解除され、再度募集状態に戻ります。')) return;
                    btnApprove.disabled = true;
                    btnApprove.textContent = '処理中...';
                    google.script.run.withSuccessHandler(function(j) {
                      var res = JSON.parse(j);
                      if (res.success) {
                        alert('キャンセルを承認しました。清掃担当が解除され、募集状態に戻りました。');
                        bootstrap.Modal.getInstance(document.getElementById('eventModal')).hide();
                        loadAndRender();
                        loadRecruitList();
                      } else {
                        alert(res.error || '失敗');
                        btnApprove.disabled = false;
                        btnApprove.textContent = 'キャンセル承認';
                      }
                    }).withFailureHandler(function(e) {
                      alert(e.message);
                      btnApprove.disabled = false;
                      btnApprove.textContent = 'キャンセル承認';
                    }).approveCancelRequest(r.recruitRowIndex, cr.staffName, cr.email);
                  };
                  var btnReject = document.createElement('button');
                  btnReject.type = 'button';
                  btnReject.className = 'btn btn-sm btn-outline-secondary';
                  btnReject.textContent = '却下';
                  btnReject.onclick = function() {
                    if (!confirm(cr.staffName + ' のキャンセル申請を却下しますか？')) return;
                    google.script.run.withSuccessHandler(function(j) {
                      var res = JSON.parse(j);
                      if (res.success) {
                        approveWrap.remove();
                        loadAndRender();
                      } else alert(res.error || '失敗');
                    }).withFailureHandler(function(e) { alert(e.message); }).rejectCancelRequest(r.recruitRowIndex, cr.staffName, cr.email);
                  };
                  approveWrap.appendChild(btnApprove);
                  approveWrap.appendChild(btnReject);
                  ownerCenterArea.appendChild(approveWrap);
                });
              }
            } catch (e) {}
          }).withFailureHandler(function() {
            if (modalGen !== window._eventModalGen) return;
            var nEl = document.getElementById('eventModalStaffNextResContent');
            if (nEl) nEl.innerHTML = '<div class="nres-item" style="grid-column:1/-1;"><span class="text-muted">取得できませんでした</span></div>';
            var sEl = document.getElementById('eventModalStaffRecruitStatus');
            if (sEl) { sEl.textContent = '－'; sEl.className = 'recruit-status-badge px-2 py-1 rounded status-undecided'; }
          }).getRecruitmentForBooking(props.rowNumber);
          setTimeout(function() {
            var addBtn = document.getElementById('eventModalAddStaff');
            var confirmBtn = document.getElementById('eventModalConfirmSelect');
            function renderSelList() {
              var listEl = document.getElementById('eventModalStaffSelectedList');
              if (!listEl) return;
              var names = window._eventModalSelectNames || [];
              listEl.innerHTML = names.map(function(n, i) {
                return '<span class="badge bg-secondary me-1 mb-1 d-inline-flex align-items-center">' + escapeHtml(n) + ' <button type="button" class="btn btn-link btn-sm p-0 ms-1 text-white event-modal-staff-rm" data-i="' + i + '">×</button></span>';
              }).join('');
              listEl.querySelectorAll('.event-modal-staff-rm').forEach(function(b) {
                b.onclick = function() {
                  var i = parseInt(this.getAttribute('data-i'), 10);
                  window._eventModalSelectNames.splice(i, 1);
                  renderSelList();
                };
              });
            }
            if (addBtn) addBtn.onclick = function() {
              var sel = document.getElementById('eventModalStaffDropdown');
              var v = (sel && sel.value || '').trim();
              if (!v) return;
              window._eventModalSelectNames = window._eventModalSelectNames || [];
              if (window._eventModalSelectNames.indexOf(v) < 0) window._eventModalSelectNames.push(v);
              renderSelList();
            };
            if (confirmBtn) confirmBtn.onclick = function() {
              var names = window._eventModalSelectNames || [];
              var staffStr = names.join(', ');
              var errEl = document.getElementById('eventModalSelectError');
              if (!staffStr) { if (errEl) { errEl.textContent = 'スタッフを選択してください。'; errEl.style.display = 'block'; } return; }
              if (errEl) errEl.style.display = 'none';
              confirmBtn.disabled = true;
              var rowNum = window._eventModalRowNumber;
              var recruitIdx = window._eventModalRecruitRowIndex || 0;
              function onOk() {
                bootstrap.Modal.getInstance(document.getElementById('eventModal')).hide();
                loadAndRender();
              }
              if (recruitIdx > 0) {
                google.script.run.withSuccessHandler(function(j) {
                  var r = JSON.parse(j);
                  if (r.success) onOk(); else { if (errEl) { errEl.textContent = r.error || '失敗'; errEl.style.display = 'block'; } }
                  confirmBtn.disabled = false;
                }).withFailureHandler(function(e) { if (errEl) { errEl.textContent = e.message; errEl.style.display = 'block'; } confirmBtn.disabled = false; }).selectStaffForRecruitment(recruitIdx, staffStr);
              } else {
                google.script.run.withSuccessHandler(function(j) {
                  var r = JSON.parse(j);
                  if (r.success) onOk(); else { if (errEl) { errEl.textContent = r.error || '失敗'; errEl.style.display = 'block'; } }
                  confirmBtn.disabled = false;
                }).withFailureHandler(function(e) { if (errEl) { errEl.textContent = e.message; errEl.style.display = 'block'; } confirmBtn.disabled = false; }).updateCleaningStaff(rowNum, staffStr);
              }
            };
          }, 100);
        }
      }

      function escapeHtml(s) {
        if (s == null) return '';
        const div = document.createElement('div');
        div.textContent = s;
        return div.innerHTML;
      }

      // 清掃担当編集モーダルを開く
      function openStaffEditModal(rowNumber, currentStaff) {
        document.getElementById('staffEditRowNumber').value = rowNumber;
        document.getElementById('staffEditError').style.display = 'none';
        document.getElementById('staffEditError').textContent = '';
        var names = (currentStaff || '').split(/[,、]/).map(function(s) { return s.trim(); }).filter(Boolean);
        window._staffEditNames = names;
        renderStaffEditList();
        google.script.run.withSuccessHandler(function(sStr) {
          try {
            var s = JSON.parse(sStr);
            var sel = document.getElementById('staffEditAddSelect');
            if (sel && s.success && s.list && s.list.length) {
              sel.innerHTML = '<option value="">追加するスタッフを選択</option>';
              s.list.forEach(function(st) {
                var label = (st.name || st.email) + (st.email ? ' (' + st.email + ')' : '');
                sel.innerHTML += '<option value="' + escapeHtml(st.name || '') + '">' + escapeHtml(label) + '</option>';
              });
            }
          } catch (e) {}
        }).getStaffNamesForSelection();
        var addBtn = document.getElementById('btnStaffEditAdd');
        if (addBtn && !addBtn.dataset.listen) {
          addBtn.dataset.listen = '1';
          addBtn.onclick = function() {
            var sel = document.getElementById('staffEditAddSelect');
            var v = (sel && sel.value || '').trim();
            if (!v) return;
            if (!window._staffEditNames) window._staffEditNames = [];
            if (window._staffEditNames.indexOf(v) >= 0) return;
            window._staffEditNames.push(v);
            renderStaffEditList();
          };
        }
        new bootstrap.Modal(document.getElementById('staffEditModal')).show();
      }
      function renderStaffEditList() {
        var list = document.getElementById('staffEditList');
        if (!list) return;
        var names = window._staffEditNames || [];
        list.innerHTML = names.map(function(n, i) {
          return '<div class="d-flex align-items-center gap-2 mb-1"><span class="flex-grow-1">' + escapeHtml(n) + '</span><button type="button" class="btn btn-sm btn-outline-danger py-0" data-index="' + i + '">削除</button></div>';
        }).join('');
        list.querySelectorAll('[data-index]').forEach(function(btn) {
          btn.onclick = function() {
            var i = parseInt(this.getAttribute('data-index'), 10);
            window._staffEditNames.splice(i, 1);
            renderStaffEditList();
          };
        });
      }

      // 清掃担当を保存
      function saveCleaningStaff() {
        const rowNumber = parseInt(document.getElementById('staffEditRowNumber').value, 10);
        const staffName = (window._staffEditNames || []).join(', ');
        const errEl = document.getElementById('staffEditError');

        if (isNaN(rowNumber) || rowNumber < 2) {
          errEl.textContent = '無効な行番号です。';
          errEl.style.display = 'block';
          return;
        }

        document.getElementById('btnSaveStaff').disabled = true;
        errEl.style.display = 'none';

        google.script.run
          .withSuccessHandler(function(jsonStr) {
            try {
              const res = JSON.parse(jsonStr);
              if (res.success) {
                bootstrap.Modal.getInstance(document.getElementById('staffEditModal')).hide();
                loadAndRender();
                loadRecruitList();
              } else {
                errEl.textContent = res.error || '保存に失敗しました。';
                errEl.style.display = 'block';
              }
            } catch (e) {
              errEl.textContent = 'レスポンスの解析に失敗しました。';
              errEl.style.display = 'block';
            }
            document.getElementById('btnSaveStaff').disabled = false;
          })
          .withFailureHandler(function(err) {
            errEl.textContent = err.message || '通信エラー';
            errEl.style.display = 'block';
            document.getElementById('btnSaveStaff').disabled = false;
          })
          .updateCleaningStaff(rowNumber, staffName);
      }

      function loadAndRender() {
        Promise.all([
          fetchData(),
          new Promise(function(res) {
            google.script.run.withSuccessHandler(function(j) {
              try { var r = JSON.parse(j); res(r.success ? r.map : {}); }
              catch (e) { res({}); }
            }).withFailureHandler(function() { res({}); }).getRecruitmentStatusMap();
          })
        ]).then(function(results) {
          var res = results[0];
          var recruitMap = results[1] || {};
          if (!res.success) {
            alert(res.error || 'データの取得に失敗しました。');
            return;
          }
          allBookings = res.data || [];
          // 拡張された recruitMap をグローバルにキャッシュ（nextReservation含む）
          window._recruitFullMap = recruitMap;
          // 清掃担当が設定済み or 選定済みのチェックアウト日を収集（重複行対策）
          var staffSetDates = {};
          (res.data || []).forEach(function(b) {
            var hasStaff = (b.cleaningStaff || '').trim();
            var rec = recruitMap[b.rowNumber] || {};
            var isDecided = (rec.status === '選定済') || (rec.staff && rec.staff.trim());
            if ((hasStaff || isDecided) && b.checkOutParsed) {
              var d2 = new Date(b.checkOutParsed);
              staffSetDates[d2.getFullYear() + '-' + (d2.getMonth()+1) + '-' + d2.getDate()] = true;
            }
          });
          var recruitDates = {};
          (res.data || []).forEach(function(b) {
            var rec = recruitMap[b.rowNumber] || {};
            if ((rec.status || '') === '募集中' && b.checkOutParsed) {
              var d = new Date(b.checkOutParsed);
              var key = d.getFullYear() + '-' + (d.getMonth()+1) + '-' + d.getDate();
              if (!staffSetDates[key]) recruitDates[key] = true;
            }
          });
          window._recruitDates = recruitDates;
          const events = buildCalendarEvents(allBookings, recruitMap);
          if (calendar) {
            const sources = calendar.getEventSources();
            sources.forEach(function(s) { s.remove(); });
            calendar.addEventSource(events);
            calendar.render();
          }
          updateNotificationBanner();

          // 募集エントリのない清掃イベントの次回予約を一括プリロード
          var nonRecruitRows = [];
          (res.data || []).forEach(function(b) {
            if (b.checkOutParsed && !recruitMap[b.rowNumber]) {
              nonRecruitRows.push(b.rowNumber);
            }
          });
          if (nonRecruitRows.length > 0) {
            if (!window._nextResCache) window._nextResCache = {};
            google.script.run.withSuccessHandler(function(j) {
              try {
                var r = JSON.parse(j);
                if (r.success && r.map) {
                  for (var rn in r.map) {
                    window._nextResCache[rn] = r.map[rn];
                  }
                }
              } catch (e) {}
            }).getNextReservationsForRows(nonRecruitRows);
          }
        });
      }

      function init() {
        if (window.staffMode) {
          var bar = document.getElementById('staffSelectorBar');
          if (bar) {
            bar.style.display = 'block';
            var saved = null;
            try { saved = JSON.parse(sessionStorage.getItem('staffSelected') || 'null'); } catch (e) {}
            if (saved && (saved.name || saved.email)) {
              applyStaffSelection(saved.name, saved.email);
            } else {
              showStaffSelectOverlay();
            }
          }
        }
        const calendarEl = document.getElementById('calendar');
        var isMobile = window.innerWidth <= 768;
        calendar = new FullCalendar.Calendar(calendarEl, {
          locale: 'ja',
          initialView: 'dayGridMonth',
          headerToolbar: {
            left: 'prev,next today',
            center: 'title',
            right: 'listWeek,dayGridMonth'
          },
          buttonText: {
            today: '今日',
            listWeek: '週',
            dayGridMonth: '月'
          },
          height: 'auto',
          contentHeight: isMobile ? 480 : 'auto',
          events: [],
          dayCellClassNames: function(arg) {
            var ds = window._recruitDates || {};
            var d = arg.date;
            var key = d.getFullYear() + '-' + (d.getMonth()+1) + '-' + d.getDate();
            return ds[key] ? ['fc-day-recruiting'] : [];
          },
          eventClick: function(info) {
            info.jsEvent.preventDefault();
            showEventModal(info.event);
          },
          eventDidMount: function(arg) {
            arg.el.style.border = 'none';
            arg.el.style.boxShadow = 'none';
            var main = arg.el.querySelector('.fc-event-main');
            if (main) { main.style.border = 'none'; main.style.boxShadow = 'none'; }
            var sd = arg.event.extendedProps && arg.event.extendedProps.statusDot;
            var dotColor = sd === 'form-answered' ? '#28a745' : sd === 'form-unanswered' ? '#dc3545' : sd === 'cleaning-recruiting' ? '#ffc107' : sd === 'cleaning-decided' ? '#0d6efd' : sd === 'cleaning-not-recruiting' ? '#dc3545' : null;
            if (dotColor) {
              var dot = document.createElement('span');
              dot.className = 'fc-event-status-dot';
              dot.style.cssText = 'display:inline-block;width:6px;height:6px;border-radius:50%;background:' + dotColor + ';border:1px solid #fff;box-shadow:0 0 0 1px rgba(255,255,255,0.8);margin-right:4px;flex-shrink:0;';
              var titleEl = arg.el.querySelector('.fc-event-title') || arg.el.querySelector('.fc-event-main');
              if (titleEl) {
                if (titleEl.firstChild) titleEl.insertBefore(dot, titleEl.firstChild);
                else titleEl.appendChild(dot);
              }
            }
          },
          windowResize: function() {}
        });
        calendar.render();

        document.getElementById('btnDeleteBooking').addEventListener('click', function() {
          var row = this.dataset.rowNumber;
          var checkIn = this.dataset.checkIn || '';
          var checkOut = this.dataset.checkOut || '';
          var guestName = this.dataset.guestName || '';
          document.getElementById('deleteBookingConfirmInfo').innerHTML = 'チェックイン: ' + escapeHtml(checkIn) + '<br>チェックアウト: ' + escapeHtml(checkOut) + (guestName ? '<br>宿泊者: ' + escapeHtml(guestName) : '');
          document.getElementById('btnConfirmDeleteBooking').dataset.rowNumber = row;
          bootstrap.Modal.getInstance(document.getElementById('eventModal')).hide();
          new bootstrap.Modal(document.getElementById('deleteBookingConfirmModal')).show();
        });
        document.getElementById('btnConfirmDeleteBooking').addEventListener('click', function() {
          var row = this.dataset.rowNumber;
          bootstrap.Modal.getInstance(document.getElementById('deleteBookingConfirmModal')).hide();
          google.script.run.withSuccessHandler(function(jsonStr) {
            var r = JSON.parse(jsonStr);
            if (r.success) loadAndRender();
            else alert(r.error || '削除に失敗しました。');
          }).withFailureHandler(function(e) { alert(e.message || 'エラー'); }).deleteBooking(row);
        });

        document.getElementById('btnSaveStaff').addEventListener('click', saveCleaningStaff);

        document.getElementById('btnCopyLineText').addEventListener('click', function() {
          var ta = document.getElementById('lineCopyText');
          var text = ta.value || '';
          if (navigator.clipboard && navigator.clipboard.writeText) {
            navigator.clipboard.writeText(text).then(function() { alert('コピーしました。LINEに貼り付けて投稿してください。'); }).catch(function() { ta.select(); document.execCommand('copy'); alert('コピーしました。LINEに貼り付けて投稿してください。'); });
          } else {
            ta.select();
            document.execCommand('copy');
            ta.blur();
            alert('コピーしました。LINEに貼り付けて投稿してください。');
          }
        });

        // タブ切り替え
        document.querySelectorAll('#mainTabs [data-tab]').forEach(function(a) {
          a.addEventListener('click', function(e) {
            e.preventDefault();
            var tab = this.getAttribute('data-tab');
            document.querySelectorAll('#mainTabs .nav-link').forEach(function(l) { l.classList.remove('active'); });
            this.classList.add('active');
            if (tab !== 'staffTest') restoreStaffTestPanels();
            document.getElementById('panelCalendar').style.display = tab === 'calendar' ? 'block' : 'none';
            document.getElementById('panelRecruit').style.display = tab === 'recruit' ? 'block' : 'none';
            document.getElementById('panelStaffSchedule').style.display = tab === 'staffSchedule' ? 'block' : 'none';
            document.getElementById('panelNotifications').style.display = tab === 'notifications' ? 'block' : 'none';
            document.getElementById('panelSettings').style.display = tab === 'settings' ? 'block' : 'none';
            document.getElementById('panelStaffTest').style.display = tab === 'staffTest' ? 'block' : 'none';
            if (tab === 'calendar') {
              setTimeout(function() { if (calendar) calendar.updateSize(); }, 50);
            }
            if (tab === 'recruit') loadRecruitList();
            if (tab === 'staffSchedule') loadStaffSchedule();
            if (tab === 'notifications') loadNotificationListMain();
            if (tab === 'settings') loadSettings();
            if (tab === 'staffTest') loadStaffTestContent();
          });
        });

        function loadStaffTestContent() {
          var staffBar = document.getElementById('staffSelectorBar');
          if (staffBar) staffBar.style.display = 'block';
          var calendarSec = document.getElementById('staffTestCalendarSection');
          var scheduleSec = document.getElementById('staffTestScheduleSection');
          var calPanel = document.getElementById('panelCalendar');
          var schedPanel = document.getElementById('panelStaffSchedule');
          if (!calendarSec || !scheduleSec) return;
          if (!window._staffTestMoved) {
            window._staffTestMoved = true;
            window._staffTestCalNext = calPanel.nextSibling;
            window._staffTestSchedNext = schedPanel.nextSibling;
            window._staffTestCalParent = calPanel.parentNode;
            window._staffTestSchedParent = schedPanel.parentNode;
          }
          calendarSec.innerHTML = '';
          scheduleSec.innerHTML = '';
          calendarSec.appendChild(calPanel);
          scheduleSec.appendChild(schedPanel);
          document.querySelectorAll('#staffTestSubTabs .staff-test-sub').forEach(function(l) { l.classList.remove('active'); });
          var activeSub = (window._staffTestActiveSubTab || 'calendar');
          window._staffTestActiveSubTab = activeSub;
          var calLink = document.querySelector('#staffTestSubTabs [data-stafftest-tab="calendar"]');
          var schedLink = document.querySelector('#staffTestSubTabs [data-stafftest-tab="schedule"]');
          if (activeSub === 'calendar') {
            if (calLink) calLink.classList.add('active');
            calendarSec.style.display = 'block';
            scheduleSec.style.display = 'none';
            calPanel.style.display = 'block';
            schedPanel.style.display = 'none';
            setTimeout(function() { if (calendar) calendar.updateSize(); }, 50);
          } else {
            if (schedLink) schedLink.classList.add('active');
            calendarSec.style.display = 'none';
            scheduleSec.style.display = 'block';
            calPanel.style.display = 'none';
            schedPanel.style.display = 'block';
            loadStaffSchedule();
          }
        }
        function restoreStaffTestPanels() {
          if (!window._staffTestMoved) return;
          var calPanel = document.getElementById('panelCalendar');
          var schedPanel = document.getElementById('panelStaffSchedule');
          var calendarSec = document.getElementById('staffTestCalendarSection');
          var scheduleSec = document.getElementById('staffTestScheduleSection');
          if (calendarSec && calPanel && calPanel.parentNode === calendarSec) {
            if (window._staffTestCalNext && window._staffTestCalParent) {
              window._staffTestCalParent.insertBefore(calPanel, window._staffTestCalNext);
            } else if (window._staffTestCalParent) {
              window._staffTestCalParent.appendChild(calPanel);
            }
          }
          if (scheduleSec && schedPanel && schedPanel.parentNode === scheduleSec) {
            if (window._staffTestSchedNext && window._staffTestSchedParent) {
              window._staffTestSchedParent.insertBefore(schedPanel, window._staffTestSchedNext);
            } else if (window._staffTestSchedParent) {
              window._staffTestSchedParent.appendChild(schedPanel);
            }
          }
          window._staffTestMoved = false;
        }
        document.querySelectorAll('#staffTestSubTabs .staff-test-sub').forEach(function(a) {
          a.addEventListener('click', function(e) {
            e.preventDefault();
            var subTab = this.getAttribute('data-stafftest-tab');
            window._staffTestActiveSubTab = subTab;
            document.querySelectorAll('#staffTestSubTabs .staff-test-sub').forEach(function(l) { l.classList.remove('active'); });
            this.classList.add('active');
            var calendarSec = document.getElementById('staffTestCalendarSection');
            var scheduleSec = document.getElementById('staffTestScheduleSection');
            var calPanel = document.getElementById('panelCalendar');
            var schedPanel = document.getElementById('panelStaffSchedule');
            if (subTab === 'calendar') {
              if (calendarSec) calendarSec.style.display = 'block';
              if (scheduleSec) scheduleSec.style.display = 'none';
              if (calPanel) calPanel.style.display = 'block';
              if (schedPanel) schedPanel.style.display = 'none';
              setTimeout(function() { if (calendar) calendar.updateSize(); }, 50);
            } else {
              if (calendarSec) calendarSec.style.display = 'none';
              if (scheduleSec) scheduleSec.style.display = 'block';
              if (calPanel) calPanel.style.display = 'none';
              if (schedPanel) schedPanel.style.display = 'block';
              loadStaffSchedule();
            }
          });
        });

        // オーナー判定＋アカウント切り替えボタン（設定タブ表示・切り替えURL）
        google.script.run.withSuccessHandler(function(jsonStr) {
          try {
            var r = JSON.parse(jsonStr);
            if (r.success) {
              var staffBar = document.getElementById('staffSelectorBar');
              var staffBarVisible = staffBar && staffBar.style.display !== 'none';
              // オーナーURL（ANYONE_ANONYMOUS）ではSession.getActiveUser()が空のためisOwner()がfalseを返す
              // オーナーURLではURLそのものが認証の役割を果たすため、非スタッフモードなら常にオーナーとして扱う
              var effectiveOwner = r.isOwner || (!window.staffMode && !staffBarVisible);
              if (window.staffMode || staffBarVisible) {
                window.isOwnerUser = false;
              } else {
                window.isOwnerUser = effectiveOwner;
              }
              window.ownerNotSet = r.ownerNotSet;
              var showOwnerTabs = effectiveOwner && !staffBarVisible;
              var navSettings = document.getElementById('navSettings');
              if (navSettings) navSettings.style.display = showOwnerTabs ? '' : 'none';
              var navNotif = document.getElementById('navNotifications');
              if (navNotif) navNotif.style.display = showOwnerTabs ? '' : 'none';
              var navStaffTest = document.getElementById('navStaffTest');
              if (navStaffTest) navStaffTest.style.display = showOwnerTabs ? '' : 'none';
              var navStaffSched = document.getElementById('navStaffSchedule');
              if (navStaffSched) navStaffSched.style.display = (window.staffMode || staffBarVisible) ? '' : 'none';
              var navRecruit = document.getElementById('navRecruit');
              if (navRecruit) navRecruit.style.display = (window.staffMode || staffBarVisible) ? 'none' : '';
              var btnSwitch = document.getElementById('btnAccountSwitch');
              if (btnSwitch && r.switchUrl && effectiveOwner && !window.staffMode) {
                btnSwitch.href = r.switchUrl;
                btnSwitch.textContent = '別のアカウントに切り替える';
                btnSwitch.style.display = '';
              } else if (btnSwitch) btnSwitch.style.display = 'none';
              var addBookingArea = document.getElementById('calendarAddBookingArea');
              if (addBookingArea) addBookingArea.style.display = (effectiveOwner && !window.staffMode) ? '' : 'none';
              updateNotificationBanner();
              var badge = document.getElementById('currentAccountBadge');
              if (badge && r.currentAccountName) {
                badge.textContent = r.currentAccountName;
                badge.style.display = '';
              }
            }
          } catch (e) {}
        }).withFailureHandler(function() {}).getOwnerAndSwitchUrl();

        loadAndRender();

        var bannerLink = document.getElementById('notificationBannerLink');
        if (bannerLink) bannerLink.addEventListener('click', function(e) {
          e.preventDefault();
          document.querySelectorAll('#mainTabs .nav-link').forEach(function(l) { l.classList.remove('active'); });
          var notifTab = document.querySelector('#mainTabs [data-tab="notifications"]');
          if (notifTab) {
            notifTab.classList.add('active');
            document.getElementById('panelCalendar').style.display = 'none';
            document.getElementById('panelRecruit').style.display = 'none';
            if (document.getElementById('panelStaffSchedule')) document.getElementById('panelStaffSchedule').style.display = 'none';
            document.getElementById('panelNotifications').style.display = 'block';
            document.getElementById('panelSettings').style.display = 'none';
            document.getElementById('panelStaffTest').style.display = 'none';
            loadNotificationListMain();
          }
        });
      }

      window.recruitAddSortOrder = window.recruitAddSortOrder || 'desc';
      function loadRecruitList() {
        document.getElementById('loadingOverlay').style.display = 'flex';
        var addBtnArea = document.getElementById('recruitAddBtnArea');
        if (addBtnArea) addBtnArea.style.display = window.isOwnerUser ? '' : 'none';
        var addListArea = document.getElementById('recruitAddListArea');
        var sortOrder = window.recruitAddSortOrder || 'desc';
        google.script.run.withSuccessHandler(function(jsonStr) {
          try {
            var res = JSON.parse(jsonStr);
            var today = new Date().toISOString().slice(0, 10);
            var hidePast = window.hidePastRecruitments !== false;
            var list = (res.success && res.list && res.list.length) ? res.list : [];
            var pastCount = list.filter(function(r) { return (r.checkoutDate || '') < today; }).length;
            var html = '<div class="d-flex justify-content-between align-items-center mb-2 flex-wrap gap-1">';
            html += '<p class="small fw-bold mb-0">募集一覧（タップで' + (window.isOwnerUser ? '内容編集' : '詳細・立候補') + '）</p>';
            if (pastCount > 0) {
              html += '<button type="button" class="btn btn-sm btn-outline-secondary" id="btnTogglePastRecruit">' + (hidePast ? '経過済みを表示' : '経過済みを非表示') + '</button>';
            }
            html += '</div>';
            if (list.length) {
              var shownCount = 0;
              list.forEach(function(r) {
                var isPast = (r.checkoutDate || '') < today;
                if (hidePast && isPast) return;
                shownCount++;
                html += '<div class="card mb-2 recruit-card" style="cursor:pointer;" data-row="' + r.rowIndex + '" data-id="' + escapeHtml(r.id) + '" data-date="' + escapeHtml(r.checkoutDate) + '" data-booking="' + r.bookingRowNumber + '" data-status="' + escapeHtml(r.status) + '" data-staff="' + escapeHtml(r.selectedStaff) + '" data-notify="' + escapeHtml(r.notifyMethod || 'メール') + '" data-volunteers="' + escapeHtml(JSON.stringify(r.volunteers || [])) + '" data-reserve-date="' + escapeHtml(r.reserveDate || '') + '" data-reserve-guest="' + escapeHtml(r.reserveGuestCount || '') + '" data-reserve-bbq="' + escapeHtml(r.reserveBBQ || '') + '" data-reserve-nationality="' + escapeHtml(r.reserveNationality || '') + '" data-reserve-bed="' + escapeHtml(r.reserveBedCount || '') + '" data-reserve-memo="' + escapeHtml(r.reserveMemo || '') + '">';
                html += '<div class="card-body py-2">';
                html += '<strong>' + escapeHtml(r.checkoutDate) + '</strong>';
                if (isPast) html += ' <span class="badge bg-secondary">経過済</span>';
                html += ' 予約行' + r.bookingRowNumber + ' ';
                html += r.status === '選定済' ? '<span class="badge bg-success">選定済</span> ' + escapeHtml(r.selectedStaff) : '<span class="badge bg-warning">募集中</span>';
                html += '<br><small>立候補: ' + (r.volunteers && r.volunteers.length ? r.volunteers.map(function(v) { return v.staffName; }).join(', ') : 'なし') + '</small>';
                html += '</div></div>';
              });
              if (shownCount === 0) html += '<p class="text-muted small">経過済み以外の案件はありません。</p>';
            } else {
              html += '<p class="text-muted">募集中の案件はありません。</p>';
            }
            document.getElementById('recruitList').innerHTML = html;
            var btnTogglePast = document.getElementById('btnTogglePastRecruit');
            if (btnTogglePast) btnTogglePast.onclick = function() { window.hidePastRecruitments = !window.hidePastRecruitments; loadRecruitList(); };
            document.querySelectorAll('.recruit-card').forEach(function(card) {
              card.addEventListener('click', function() {
                var volStr = this.getAttribute('data-volunteers') || '[]';
                var volunteers = [];
                try { volunteers = JSON.parse(volStr); } catch(e) {}
                var r = {
                  rowIndex: parseInt(this.getAttribute('data-row'), 10),
                  id: this.getAttribute('data-id') || '',
                  checkoutDate: this.getAttribute('data-date') || '',
                  bookingRowNumber: parseInt(this.getAttribute('data-booking'), 10) || 0,
                  status: this.getAttribute('data-status') || '募集中',
                  selectedStaff: this.getAttribute('data-staff') || '',
                  notifyMethod: this.getAttribute('data-notify') || 'メール',
                  volunteers: volunteers,
                  reserveDate: this.getAttribute('data-reserve-date') || '',
                  reserveGuestCount: this.getAttribute('data-reserve-guest') || '',
                  reserveBBQ: this.getAttribute('data-reserve-bbq') || '',
                  reserveNationality: this.getAttribute('data-reserve-nationality') || '',
                  reserveBedCount: this.getAttribute('data-reserve-bed') || '',
                  reserveMemo: this.getAttribute('data-reserve-memo') || '',
                  isNew: false
                };
                openRecruitEditModal(r);
              });
            });
          } catch (e) {
            document.getElementById('recruitList').innerHTML = '<p class="text-danger">読み込みに失敗しました。</p>';
          }
          document.getElementById('loadingOverlay').style.display = 'none';
        }).withFailureHandler(function() {
          document.getElementById('loadingOverlay').style.display = 'none';
        }).getRecruitmentList();
        if (window.isOwnerUser && !window.staffMode) {
        google.script.run.withSuccessHandler(function(addJsonStr) {
          try {
            var addRes = JSON.parse(addJsonStr);
            var addHtml = '';
            if (addRes.success && addRes.list && addRes.list.length && window.isOwnerUser) {
              var addToday = new Date().toISOString().slice(0, 10);
              var addHidePast = window.hidePastAddRecruit !== false;
              var addList = addRes.list;
              var addPastCount = addList.filter(function(b) { return (b.checkoutDate || '') < addToday; }).length;
              addHtml = '<div class="d-flex justify-content-between align-items-center mb-2 flex-wrap gap-1">';
              addHtml += '<p class="small fw-bold mb-0">追加できる予約（タップで内容編集）</p>';
              addHtml += '<div class="d-flex gap-1 align-items-center">';
              if (addPastCount > 0) {
                addHtml += '<button type="button" class="btn btn-sm btn-outline-secondary" id="btnTogglePastAddRecruit">' + (addHidePast ? '経過済みを表示' : '経過済みを非表示') + '</button>';
              }
              addHtml += '<select class="form-select form-select-sm" id="recruitAddSortOrder" style="width:auto;"><option value="desc"' + (sortOrder==='desc'?' selected':'') + '>日付降順</option><option value="asc"' + (sortOrder==='asc'?' selected':'') + '>日付昇順</option></select></div></div>';
              var addShownCount = 0;
              addList.forEach(function(b) {
                var addIsPast = (b.checkoutDate || '') < addToday;
                if (addHidePast && addIsPast) return;
                addShownCount++;
                addHtml += '<div class="card mb-2 recruit-add-card" style="cursor:pointer;" data-row="' + b.rowNumber + '" data-date="' + escapeHtml(b.checkoutDate) + '" data-name="' + escapeHtml(b.guestName || '') + '" data-reserve-date="' + escapeHtml(b.reserveDate || '') + '" data-reserve-guest="' + escapeHtml(b.reserveGuestCount || '') + '" data-reserve-bbq="' + escapeHtml(b.reserveBBQ || '') + '" data-reserve-nationality="' + escapeHtml(b.reserveNationality || '') + '" data-reserve-bed="' + escapeHtml(b.reserveBedCount || '') + '">';
                addHtml += '<div class="card-body py-2"><strong>' + escapeHtml(b.checkoutDate) + '</strong>';
                if (addIsPast) addHtml += ' <span class="badge bg-secondary">経過済</span>';
                addHtml += ' 予約行' + b.rowNumber + ' ' + escapeHtml(b.guestName || '') + '</div></div>';
              });
              if (addShownCount === 0) addHtml += '<p class="text-muted small">経過済み以外の予約はありません。</p>';
            } else if (addRes.success && (!addRes.list || !addRes.list.length) && window.isOwnerUser) {
              addHtml = '<p class="small text-muted mb-2">追加できる予約はありません。</p>';
            }
            if (addListArea) addListArea.innerHTML = addHtml || '';
            var btnTogglePastAdd = document.getElementById('btnTogglePastAddRecruit');
            if (btnTogglePastAdd) btnTogglePastAdd.onclick = function() { window.hidePastAddRecruit = !window.hidePastAddRecruit; loadRecruitList(); };
            var sortEl = document.getElementById('recruitAddSortOrder');
            if (sortEl) sortEl.addEventListener('change', function() { window.recruitAddSortOrder = this.value; loadRecruitList(); });
            document.querySelectorAll('.recruit-add-card').forEach(function(card) {
              card.addEventListener('click', function() {
                var b = {
                  rowNumber: parseInt(this.getAttribute('data-row'), 10),
                  checkoutDate: this.getAttribute('data-date'),
                  guestName: this.getAttribute('data-name'),
                  reserveDate: this.getAttribute('data-reserve-date') || '',
                  reserveGuestCount: this.getAttribute('data-reserve-guest') || '',
                  reserveBBQ: this.getAttribute('data-reserve-bbq') || '',
                  reserveNationality: this.getAttribute('data-reserve-nationality') || ''
                };
                openRecruitEditModal({ bookingRowNumber: b.rowNumber, checkoutDate: b.checkoutDate, isNew: true, reserveDate: b.reserveDate, reserveGuestCount: b.reserveGuestCount, reserveBBQ: b.reserveBBQ, reserveNationality: b.reserveNationality, reserveBedCount: b.reserveBedCount || '' });
              });
            });
          } catch (e) {}
        }).withFailureHandler(function() {}).getBookingsWithoutRecruitment(sortOrder);
        } else {
          if (addListArea) addListArea.innerHTML = '';
        }
        var addRecruitBtn = document.getElementById('btnAddRecruit');
        if (addRecruitBtn && !addRecruitBtn._bound) {
          addRecruitBtn._bound = true;
          addRecruitBtn.addEventListener('click', openAddRecruitModal);
        }
      }

      function loadRecruitListStaffTest() {
        var container = document.getElementById('recruitListStaffTest');
        if (!container) return;
        document.getElementById('loadingOverlay').style.display = 'flex';
        var today = new Date().toISOString().slice(0, 10);
        var hidePast = window.hidePastRecruitments !== false;
        google.script.run.withSuccessHandler(function(jsonStr) {
          try {
            var res = JSON.parse(jsonStr);
            var list = (res.success && res.list && res.list.length) ? res.list : [];
            var pastCount = list.filter(function(r) { return (r.checkoutDate || '') < today; }).length;
            var html = '<div class="d-flex justify-content-between align-items-center mb-2 flex-wrap gap-1">';
            html += '<p class="small fw-bold mb-0">募集一覧（タップで詳細・立候補）</p>';
            if (pastCount > 0) {
              html += '<button type="button" class="btn btn-sm btn-outline-secondary" id="btnTogglePastRecruitStaffTest">' + (hidePast ? '経過済みを表示' : '経過済みを非表示') + '</button>';
            }
            html += '</div>';
            if (list.length) {
              var shownCount = 0;
              list.forEach(function(r) {
                var isPast = (r.checkoutDate || '') < today;
                if (hidePast && isPast) return;
                shownCount++;
                html += '<div class="card mb-2 recruit-card-staff-test" style="cursor:pointer;" data-row="' + r.rowIndex + '" data-id="' + escapeHtml(r.id) + '" data-date="' + escapeHtml(r.checkoutDate) + '" data-booking="' + r.bookingRowNumber + '" data-status="' + escapeHtml(r.status) + '" data-staff="' + escapeHtml(r.selectedStaff) + '" data-notify="' + escapeHtml(r.notifyMethod || 'メール') + '" data-volunteers="' + escapeHtml(JSON.stringify(r.volunteers || [])) + '" data-reserve-date="' + escapeHtml(r.reserveDate || '') + '" data-reserve-guest="' + escapeHtml(r.reserveGuestCount || '') + '" data-reserve-bbq="' + escapeHtml(r.reserveBBQ || '') + '" data-reserve-nationality="' + escapeHtml(r.reserveNationality || '') + '" data-reserve-bed="' + escapeHtml(r.reserveBedCount || '') + '" data-reserve-memo="' + escapeHtml(r.reserveMemo || '') + '">';
                html += '<div class="card-body py-2">';
                html += '<strong>' + escapeHtml(r.checkoutDate) + '</strong>';
                if (isPast) html += ' <span class="badge bg-secondary">経過済</span>';
                html += ' 予約行' + r.bookingRowNumber + ' ';
                html += r.status === '選定済' ? '<span class="badge bg-success">選定済</span> ' + escapeHtml(r.selectedStaff) : '<span class="badge bg-warning">募集中</span>';
                html += '<br><small>立候補: ' + (r.volunteers && r.volunteers.length ? r.volunteers.map(function(v) { return v.staffName; }).join(', ') : 'なし') + '</small>';
                html += '</div></div>';
              });
              if (shownCount === 0) html += '<p class="text-muted small">経過済み以外の案件はありません。</p>';
            } else {
              html += '<p class="text-muted">募集中の案件はありません。</p>';
            }
            container.innerHTML = html;
            var btnToggle = document.getElementById('btnTogglePastRecruitStaffTest');
            if (btnToggle) btnToggle.onclick = function() { window.hidePastRecruitments = !window.hidePastRecruitments; loadRecruitListStaffTest(); };
            container.querySelectorAll('.recruit-card-staff-test').forEach(function(card) {
              card.addEventListener('click', function() {
                var volStr = this.getAttribute('data-volunteers') || '[]';
                var volunteers = [];
                try { volunteers = JSON.parse(volStr); } catch(e) {}
                var r = {
                  rowIndex: parseInt(this.getAttribute('data-row'), 10),
                  id: this.getAttribute('data-id') || '',
                  checkoutDate: this.getAttribute('data-date') || '',
                  bookingRowNumber: parseInt(this.getAttribute('data-booking'), 10) || 0,
                  status: this.getAttribute('data-status') || '募集中',
                  selectedStaff: this.getAttribute('data-staff') || '',
                  notifyMethod: this.getAttribute('data-notify') || 'メール',
                  volunteers: volunteers,
                  reserveDate: this.getAttribute('data-reserve-date') || '',
                  reserveGuestCount: this.getAttribute('data-reserve-guest') || '',
                  reserveBBQ: this.getAttribute('data-reserve-bbq') || '',
                  reserveNationality: this.getAttribute('data-reserve-nationality') || '',
                  reserveMemo: this.getAttribute('data-reserve-memo') || '',
                  isNew: false,
                  asStaffTest: true
                };
                openRecruitEditModal(r);
              });
            });
          } catch (e) {
            container.innerHTML = '<p class="text-danger">読み込みに失敗しました。</p>';
          }
          document.getElementById('loadingOverlay').style.display = 'none';
        }).withFailureHandler(function() {
          document.getElementById('loadingOverlay').style.display = 'none';
          if (container) container.innerHTML = '<p class="text-danger">読み込みに失敗しました。</p>';
        }).getRecruitmentList();
      }

      function openRecruitEditModal(r) {
        r.isNew = r.isNew || false;
        var lineCopyArea = document.getElementById('recruitEditLineCopyArea');
        if (lineCopyArea) lineCopyArea.style.display = 'none';
        document.getElementById('recruitEditModalTitle').textContent = r.isNew ? '募集内容（新規）' : '募集内容';
        var btnSave = document.getElementById('btnRecruitEditSave');
        if (btnSave) btnSave.textContent = r.isNew ? '募集開始' : '保存';
        document.getElementById('recruitEditCleaningDate').textContent = r.checkoutDate || '－';
        document.getElementById('recruitEditReserveDate').value = r.reserveDate || '';
        document.getElementById('recruitEditReserveGuestCount').value = r.reserveGuestCount || '';
        document.getElementById('recruitEditReserveBBQ').value = r.reserveBBQ || '';
        document.getElementById('recruitEditReserveNationality').value = r.reserveNationality || '';
        document.getElementById('recruitEditReserveMemo').value = r.reserveMemo || '';
        window._recruitEditStaffNames = (r.selectedStaff || r.cleaningStaff || '').split(/[,、]/).map(function(s) { return s.trim(); }).filter(Boolean);
        document.getElementById('recruitEditStatus').innerHTML = (r.status === '選定済' ? '選定済: ' + escapeHtml(r.selectedStaff || '') : '募集中');
        document.getElementById('recruitEditVolunteers').textContent = '立候補: ' + (r.volunteers && r.volunteers.length ? r.volunteers.map(function(v) { return v.staffName; }).join(', ') : 'なし');
        document.getElementById('recruitEditError').style.display = 'none';
        var staffBar = document.getElementById('staffSelectorBar');
        var staffBarVisible = staffBar && staffBar.style.display !== 'none';
        var asStaff = r.asStaffTest || !window.isOwnerUser || window.staffMode || staffBarVisible;
        document.querySelectorAll('#recruitEditModal .recruit-edit-owner-only').forEach(function(el) { el.style.display = asStaff ? 'none' : ''; });
        ['recruitEditReserveDate','recruitEditReserveGuestCount','recruitEditReserveBBQ','recruitEditReserveNationality','recruitEditReserveBedCount','recruitEditReserveMemo'].forEach(function(id) {
          var el = document.getElementById(id);
          if (el) el.readOnly = asStaff;
        });
        document.getElementById('btnRecruitEditCancel').style.display = (r.isNew || asStaff ? 'none' : (window.isOwnerUser ? '' : 'none'));
        var selectArea = document.getElementById('recruitEditSelectArea');
        selectArea.style.display = ((r.status === '募集中' || r.status === '選定済') && !asStaff && !r.isNew && !r.asStaffTest) ? 'block' : 'none';
        var volunteerArea = document.getElementById('recruitEditVolunteerArea');
        var btnVol = document.getElementById('btnRecruitEditVolunteer');
        var btnCancelVol = document.getElementById('btnRecruitEditCancelVolunteer');
        var hasVolunteered = false;
        if (asStaff && r.status === '募集中' && !r.isNew && r.volunteers && r.volunteers.length) {
          var curName = (window.currentUserName || '').trim().toLowerCase();
          var curEmail = (window.currentUserEmail || '').trim().toLowerCase();
          hasVolunteered = r.volunteers.some(function(v) {
            return (v.staffName || '').trim().toLowerCase() === curName || (v.email || '').trim().toLowerCase() === curEmail;
          });
        }
        if (volunteerArea) volunteerArea.style.display = (r.status === '募集中' && asStaff && !r.isNew) ? 'block' : 'none';
        if (btnVol) btnVol.style.display = hasVolunteered ? 'none' : 'inline-block';
        if (btnCancelVol) btnCancelVol.style.display = hasVolunteered ? 'inline-block' : 'none';
        window._recruitEditCurrent = r;
        if (!r.isNew) {
          google.script.run.withSuccessHandler(function(jsonStr) {
            try {
              var det = JSON.parse(jsonStr);
              if (det.success) {
                document.getElementById('recruitEditCleaningDate').textContent = det.cleaningDate || '－';
                var nr = det.nextReservation || {};
                if (!r.reserveDate) document.getElementById('recruitEditReserveDate').value = nr.date || '';
                if (!r.reserveGuestCount) document.getElementById('recruitEditReserveGuestCount').value = nr.guestCount || '';
                if (!r.reserveBBQ) document.getElementById('recruitEditReserveBBQ').value = nr.bbq || '';
                if (!r.reserveNationality) document.getElementById('recruitEditReserveNationality').value = nr.nationality || '';
                if (!r.reserveBedCount) document.getElementById('recruitEditReserveBedCount').value = nr.bedCount || '';
                if (!r.reserveMemo) document.getElementById('recruitEditReserveMemo').value = nr.memo || '';
                if (det.cleaningStaff) window._recruitEditStaffNames = (det.cleaningStaff || '').split(/[,、]/).map(function(s) { return s.trim(); }).filter(Boolean);
              }
            } catch (e) {}
          }).getBookingDetailsForRecruit(r.bookingRowNumber, r.rowIndex);
        } else {
          if (r.reserveDate) document.getElementById('recruitEditReserveDate').value = r.reserveDate;
          if (r.reserveGuestCount) document.getElementById('recruitEditReserveGuestCount').value = r.reserveGuestCount;
          if (r.reserveBBQ) document.getElementById('recruitEditReserveBBQ').value = r.reserveBBQ;
          if (r.reserveNationality) document.getElementById('recruitEditReserveNationality').value = r.reserveNationality;
          if (r.reserveBedCount) document.getElementById('recruitEditReserveBedCount').value = r.reserveBedCount;
          google.script.run.withSuccessHandler(function(jsonStr) {
            try {
              var det = JSON.parse(jsonStr);
              if (det.success) {
                document.getElementById('recruitEditCleaningDate').textContent = det.cleaningDate || r.checkoutDate || '－';
                var nr = det.nextReservation || {};
                if (nr.date) document.getElementById('recruitEditReserveDate').value = nr.date;
                if (nr.guestCount) document.getElementById('recruitEditReserveGuestCount').value = nr.guestCount;
                if (nr.bbq) document.getElementById('recruitEditReserveBBQ').value = nr.bbq;
                if (nr.nationality) document.getElementById('recruitEditReserveNationality').value = nr.nationality;
                if (nr.memo) document.getElementById('recruitEditReserveMemo').value = nr.memo;
                if (det.cleaningStaff) window._recruitEditStaffNames = (det.cleaningStaff || '').split(/[,、]/).map(function(s) { return s.trim(); }).filter(Boolean);
              }
            } catch (e) {}
          }).getBookingDetailsForRecruit(r.bookingRowNumber);
        }
        function collectDetail() {
          return {
            date: document.getElementById('recruitEditReserveDate').value.trim(),
            guestCount: document.getElementById('recruitEditReserveGuestCount').value.trim(),
            bbq: document.getElementById('recruitEditReserveBBQ').value.trim(),
            nationality: document.getElementById('recruitEditReserveNationality').value.trim() || '日本',
            bedCount: document.getElementById('recruitEditReserveBedCount').value.trim(),
            memo: document.getElementById('recruitEditReserveMemo').value.trim(),
            cleaningStaff: (window._recruitEditStaffNames || []).join(', '),
            notifyMethod: 'メール'
          };
        }
        document.getElementById('btnRecruitEditSave').onclick = function() {
          document.getElementById('recruitEditError').style.display = 'none';
          var detail = collectDetail();
          if (r.isNew) {
            google.script.run.withSuccessHandler(function(resStr) {
              var ok = JSON.parse(resStr);
              if (ok.success && !ok.alreadyExists && ok.rowIndex) {
                var popupArea = document.getElementById('recruitEditLineCopyArea');
                if (popupArea) {
                  popupArea.innerHTML = '<p class="small fw-bold mb-2">スタッフに共有してください</p><button type="button" class="btn btn-sm btn-primary me-1" id="recNewMail">メール送信</button><button type="button" class="btn btn-sm btn-info text-white" id="recNewCopy">テキストコピー</button><div id="recNewCopyArea" class="mt-2" style="display:none;"><p class="small fw-bold mb-1">LINE用テキスト（コピーしてLINEグループに投稿）</p><textarea id="recNewCopyText" class="form-control font-monospace small mb-2" rows="6"></textarea><button type="button" class="btn btn-sm btn-primary" id="recNewCopyBtn">コピー</button></div>';
                  popupArea.style.display = 'block';
                  document.getElementById('recNewMail').onclick = function() {
                    if (!confirm('登録者全員に一斉送信します。よろしいですか？')) return;
                    google.script.run.withSuccessHandler(function(a) {
                      var ann = JSON.parse(a);
                      if (ann.success) { alert('募集を開始しました。メールで送信しました。'); bootstrap.Modal.getInstance(document.getElementById('recruitEditModal')).hide(); loadRecruitList(); loadAndRender(); }
                      else document.getElementById('recruitEditError').textContent = ann.error || '失敗';
                    }).announceRecruitment(ok.rowIndex);
                  };
                  document.getElementById('recNewCopy').onclick = function() {
                    google.script.run.withSuccessHandler(function(t) {
                      var jt = JSON.parse(t);
                      if (jt.success && jt.copyText) {
                        var copyArea = document.getElementById('recNewCopyArea');
                        var txtEl = document.getElementById('recNewCopyText');
                        var btnEl = document.getElementById('recNewCopyBtn');
                        if (copyArea) copyArea.style.display = 'block';
                        if (txtEl) txtEl.value = jt.copyText;
                        if (btnEl) btnEl.onclick = function() {
                          if (navigator.clipboard && navigator.clipboard.writeText) navigator.clipboard.writeText(jt.copyText).then(function() { alert('コピーしました。'); }).catch(function() { if (txtEl) { txtEl.select(); document.execCommand('copy'); alert('コピーしました。'); } });
                          else if (txtEl && document.execCommand) { txtEl.select(); document.execCommand('copy'); alert('コピーしました。'); }
                        };
                        alert('募集を開始しました。下記テキストをコピーしてLINEなどで共有してください。');
                      }
                    }).getRecruitmentCopyText(r.checkoutDate, r.bookingRowNumber, detail);
                  };
                } else {
                  bootstrap.Modal.getInstance(document.getElementById('recruitEditModal')).hide();
                  loadRecruitList();
                  loadAndRender();
                }
              } else if (ok.alreadyExists) {
                document.getElementById('recruitEditError').textContent = 'この予約は既に募集済みです。';
                document.getElementById('recruitEditError').style.display = 'block';
              } else {
                document.getElementById('recruitEditError').textContent = ok.error || '失敗';
                document.getElementById('recruitEditError').style.display = 'block';
              }
            }).withFailureHandler(function(err) {
              document.getElementById('recruitEditError').textContent = err.message || 'エラー';
              document.getElementById('recruitEditError').style.display = 'block';
            }).saveRecruitmentDetail(null, r.bookingRowNumber, r.checkoutDate, detail);
          } else {
            google.script.run.withSuccessHandler(function(resStr) {
              var ok = JSON.parse(resStr);
              if (ok.success) {
                alert('保存しました。');
                bootstrap.Modal.getInstance(document.getElementById('recruitEditModal')).hide();
                loadRecruitList();
              } else {
                document.getElementById('recruitEditError').textContent = ok.error || '失敗';
                document.getElementById('recruitEditError').style.display = 'block';
              }
            }).withFailureHandler(function(err) {
              document.getElementById('recruitEditError').textContent = err.message || 'エラー';
              document.getElementById('recruitEditError').style.display = 'block';
            }).saveRecruitmentDetail(r.rowIndex, r.bookingRowNumber, r.checkoutDate, detail);
          }
        };
        document.getElementById('btnRecruitEditMail').onclick = function() {
          if (!confirm('登録者全員に一斉送信します。よろしいですか？')) return;
          document.getElementById('recruitEditError').style.display = 'none';
          var detail = collectDetail();
          detail.notifyMethod = 'メール';
          function doAnnounce(rowIdx) {
            google.script.run.withSuccessHandler(function(annStr) {
              var ann = JSON.parse(annStr);
              if (ann.success) {
                alert('メールで送信しました。');
                bootstrap.Modal.getInstance(document.getElementById('recruitEditModal')).hide();
                loadRecruitList();
              } else {
                document.getElementById('recruitEditError').textContent = ann.error || '失敗';
                document.getElementById('recruitEditError').style.display = 'block';
              }
            }).withFailureHandler(function(err) {
              document.getElementById('recruitEditError').textContent = err.message || 'エラー';
              document.getElementById('recruitEditError').style.display = 'block';
            }).announceRecruitment(rowIdx);
          }
          if (r.isNew) {
            google.script.run.withSuccessHandler(function(resStr) {
              var ok = JSON.parse(resStr);
              if (ok.success && ok.rowIndex) {
                if (ok.alreadyExists) {
                  google.script.run.withSuccessHandler(function() { doAnnounce(ok.rowIndex); }).saveRecruitmentDetail(ok.rowIndex, r.bookingRowNumber, r.checkoutDate, detail);
                } else {
                  doAnnounce(ok.rowIndex);
                }
              }
            }).saveRecruitmentDetail(null, r.bookingRowNumber, r.checkoutDate, detail);
          } else {
            google.script.run.withSuccessHandler(function(resStr) {
              var ok = JSON.parse(resStr);
              if (ok.success) doAnnounce(r.rowIndex);
            }).saveRecruitmentDetail(r.rowIndex, r.bookingRowNumber, r.checkoutDate, detail);
          }
        };
        document.getElementById('btnRecruitEditCopy').onclick = function() {
          document.getElementById('recruitEditError').style.display = 'none';
          var lineArea = document.getElementById('recruitEditLineCopyArea');
          var detail = collectDetail();
          var nextRes = { date: detail.date, guestCount: detail.guestCount, bbq: detail.bbq, nationality: detail.nationality, memo: detail.memo };
          function showCopyText(copyText) {
            var txtEl = document.getElementById('recruitEditLineCopyText');
            var btnEl = document.getElementById('btnRecruitEditCopyToClipboard');
            if (txtEl) txtEl.value = copyText;
            if (lineArea) lineArea.style.display = 'block';
            if (lineArea) lineArea.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            function doCopy() {
              if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(copyText).catch(function() {});
              } else if (txtEl && document.execCommand) {
                txtEl.select();
                document.execCommand('copy');
              }
            }
            doCopy();
            if (btnEl) btnEl.onclick = function() { doCopy(); };
          }
          google.script.run.withSuccessHandler(function(txtStr) {
            var j = JSON.parse(txtStr);
            if (j.success && j.copyText) showCopyText(j.copyText);
          }).getRecruitmentCopyText(r.checkoutDate, r.bookingRowNumber, nextRes);
        };
        document.getElementById('btnRecruitEditCancel').onclick = function() {
          if (!r.isNew && r.rowIndex) {
            var volCount = r.volunteers && r.volunteers.length ? r.volunteers.length : 0;
            var msg = volCount > 0 ? '立候補者が' + volCount + '名います。募集を取消しますか？' : '募集を取消しますか？';
            if (!confirm(msg)) return;
            google.script.run.withSuccessHandler(function(resStr) {
              var ok = JSON.parse(resStr);
              if (ok.success) {
                bootstrap.Modal.getInstance(document.getElementById('recruitEditModal')).hide();
                loadRecruitList();
                loadAndRender();
              } else alert(ok.error || '失敗');
            }).deleteRecruitment(r.rowIndex);
          }
          if (r.isNew) {
            bootstrap.Modal.getInstance(document.getElementById('recruitEditModal')).hide();
          }
        };
        document.getElementById('btnRecruitEditSelect').onclick = function() {
          bootstrap.Modal.getInstance(document.getElementById('recruitEditModal')).hide();
          openRecruitSelectModal(r);
        };
        var volBtn = document.getElementById('btnRecruitEditVolunteer');
        if (volBtn) volBtn.onclick = function() {
          volunteer(r.id);
          bootstrap.Modal.getInstance(document.getElementById('recruitEditModal')).hide();
          loadRecruitList();
          if (r.asStaffTest) loadRecruitListStaffTest();
        };
        var cancelVolBtn = document.getElementById('btnRecruitEditCancelVolunteer');
        if (cancelVolBtn) cancelVolBtn.onclick = function() {
          if (!confirm('立候補を取り消しますか？')) return;
          google.script.run.withSuccessHandler(function(jsonStr) {
            try {
              var res = JSON.parse(jsonStr);
              if (res.success) {
                alert('立候補を取り消しました。');
                bootstrap.Modal.getInstance(document.getElementById('recruitEditModal')).hide();
                loadRecruitList();
                if (r.asStaffTest) loadRecruitListStaffTest();
              } else alert(res.error || '失敗');
            } catch (e) { alert('エラー'); }
          }).withFailureHandler(function(err) { alert(err.message || 'エラー'); }).cancelVolunteerForRecruitment(r.id, window.currentUserName || '', window.currentUserEmail || '');
        };
        new bootstrap.Modal(document.getElementById('recruitEditModal')).show();
      }

      function openRecruitSelectModal(r) {
        var volList = (r.volunteers || []);
        if (!volList.length) {
          alert('立候補者がいません。立候補者が出るまでお待ちください。');
          return;
        }
        document.getElementById('recruitSelectRowIndex').value = r.rowIndex;
        document.getElementById('recruitSelectModalTitle').textContent = '清掃担当を選定';
        document.getElementById('recruitSelectDate').textContent = 'チェックアウト日: ' + (r.checkoutDate || '');
        window._recruitSelectStaffNames = (r.selectedStaff || '').split(/[,、]/).map(function(s) { return s.trim(); }).filter(Boolean);
        document.getElementById('recruitSelectStaffList').innerHTML = '';
        document.getElementById('recruitSelectError').style.display = 'none';
        var sel = document.getElementById('recruitSelectStaffDropdown');
        sel.innerHTML = '<option value="">立候補者を選択</option>';
        volList.forEach(function(v) {
          var name = (v.staffName || v.email || '').trim();
          if (name) sel.innerHTML += '<option value="' + escapeHtml(name) + '">' + escapeHtml(name) + '</option>';
        });
        renderRecruitSelectStaffList();
        new bootstrap.Modal(document.getElementById('recruitSelectModal')).show();
      }

      function renderRecruitSelectStaffList() {
        var list = document.getElementById('recruitSelectStaffList');
        var names = window._recruitSelectStaffNames || [];
        list.innerHTML = names.map(function(n, i) {
          return '<span class="badge bg-secondary me-1 mb-1 d-inline-flex align-items-center">' + escapeHtml(n) + ' <button type="button" class="btn btn-link btn-sm p-0 ms-1 text-white" data-index="' + i + '" style="font-size:0.9em;">×</button></span>';
        }).join('');
        list.querySelectorAll('[data-index]').forEach(function(btn) {
          btn.addEventListener('click', function() {
            var i = parseInt(this.getAttribute('data-index'), 10);
            window._recruitSelectStaffNames.splice(i, 1);
            renderRecruitSelectStaffList();
          });
        });
      }

      function openAddRecruitModal() {
        document.getElementById('addRecruitBookingsList').innerHTML = '';
        document.getElementById('addRecruitEmpty').style.display = 'none';
        document.getElementById('addRecruitError').style.display = 'none';
        document.getElementById('loadingOverlay').style.display = 'flex';
        google.script.run.withSuccessHandler(function(jsonStr) {
          try {
            var res = JSON.parse(jsonStr);
            var listEl = document.getElementById('addRecruitBookingsList');
            var emptyEl = document.getElementById('addRecruitEmpty');
            if (res.success && res.list && res.list.length) {
              res.list.forEach(function(b) {
                var div = document.createElement('div');
                div.className = 'border rounded p-2 mb-2';
                div.innerHTML = '<strong>' + escapeHtml(b.checkoutDate) + '</strong> 予約行' + b.rowNumber + ' ' + escapeHtml(b.guestName || '') + ' <button type="button" class="btn btn-sm btn-primary ms-2 btnAddRecruitItem" data-row="' + b.rowNumber + '" data-date="' + escapeHtml(b.checkoutDate) + '" data-reserve-date="' + escapeHtml(b.reserveDate || '') + '" data-reserve-guest="' + escapeHtml(b.reserveGuestCount || '') + '" data-reserve-bbq="' + escapeHtml(b.reserveBBQ || '') + '" data-reserve-nationality="' + escapeHtml(b.reserveNationality || '') + '">追加</button>';
                listEl.appendChild(div);
              });
              listEl.querySelectorAll('.btnAddRecruitItem').forEach(function(btn) {
                btn.addEventListener('click', function() {
                  bootstrap.Modal.getInstance(document.getElementById('addRecruitModal')).hide();
                  openRecruitEditModal({
                    bookingRowNumber: parseInt(this.getAttribute('data-row'), 10),
                    checkoutDate: this.getAttribute('data-date'),
                    isNew: true,
                    reserveDate: this.getAttribute('data-reserve-date') || '',
                    reserveGuestCount: this.getAttribute('data-reserve-guest') || '',
                    reserveBBQ: this.getAttribute('data-reserve-bbq') || '',
                    reserveNationality: this.getAttribute('data-reserve-nationality') || ''
                  });
                });
              });
              emptyEl.style.display = 'none';
            } else {
              listEl.innerHTML = '';
              emptyEl.style.display = 'block';
            }
          } catch (e) {
            document.getElementById('addRecruitError').textContent = e.message || '読み込みに失敗しました。';
            document.getElementById('addRecruitError').style.display = 'block';
          }
          document.getElementById('loadingOverlay').style.display = 'none';
        }).withFailureHandler(function(err) {
          document.getElementById('addRecruitError').textContent = err.message || 'エラー';
          document.getElementById('addRecruitError').style.display = 'block';
          document.getElementById('loadingOverlay').style.display = 'none';
        }).getBookingsWithoutRecruitment();
        new bootstrap.Modal(document.getElementById('addRecruitModal')).show();
      }

      function addRecruitmentManually(rowNumber, checkoutDate) {
        document.getElementById('addRecruitError').style.display = 'none';
        google.script.run.withSuccessHandler(function(jsonStr) {
          try {
            var r = JSON.parse(jsonStr);
            if (r.success) {
              bootstrap.Modal.getInstance(document.getElementById('addRecruitModal')).hide();
              loadRecruitList();
              loadAndRender();
              if (r.alreadyExists) {
                alert('この予約は既に募集済みです。');
              } else {
                alert('募集を追加しました。一覧でタップして告知方法を選び送信してください。');
              }
            } else {
              document.getElementById('addRecruitError').textContent = r.error || '失敗';
              document.getElementById('addRecruitError').style.display = 'block';
            }
          } catch (e) {
            document.getElementById('addRecruitError').textContent = 'エラー';
            document.getElementById('addRecruitError').style.display = 'block';
          }
        }).withFailureHandler(function(err) {
          document.getElementById('addRecruitError').textContent = err.message || 'エラー';
          document.getElementById('addRecruitError').style.display = 'block';
        }).addRecruitmentManually(rowNumber, checkoutDate);
      }

      function volunteer(recruitId, memoToSend) {
        var staffBar = document.getElementById('staffSelectorBar');
        var barVisible = staffBar && staffBar.style.display !== 'none';
        if (barVisible && !window.currentUserName && !window.currentUserEmail) {
          alert('立候補するには、上部でお名前を選択してください。');
          return;
        }
        var nameToSend = window.currentUserName || '';
        var emailToSend = window.currentUserEmail || '';
        if (!nameToSend && !emailToSend) {
          alert('立候補するには、お名前を選択するかログインしてください。');
          return;
        }
        var memo = (memoToSend != null) ? String(memoToSend).trim() : '';
        google.script.run.withSuccessHandler(function(jsonStr) {
          try {
            var r = JSON.parse(jsonStr);
            if (r.success) {
              alert(r.already ? 'すでに立候補済みです。' : '立候補しました。');
              loadRecruitList();
              loadAndRender();
            } else {
              alert(r.error || '失敗しました。');
            }
          } catch (e) { alert('エラー'); }
        }).withFailureHandler(function(err) { alert(err.message || 'エラー'); }).volunteerForRecruitment(recruitId, nameToSend, emailToSend, memo);
      }

      function loadSyncList() {
        google.script.run.withSuccessHandler(function(jsonStr) {
          try {
            var res = JSON.parse(jsonStr);
            var html = '';
            if (res.success && res.list && res.list.length) {
              res.list.forEach(function(s) {
                html += '<div class="border rounded p-2 mb-2"><div class="d-flex justify-content-between align-items-start">';
                html += '<div><strong>' + escapeHtml(s.platformName) + '</strong><br><small class="text-muted">' + escapeHtml(s.icalUrl || '(未設定)') + '</small>';
                if (s.lastSync) html += '<br><small class="text-success">' + escapeHtml(s.lastSync) + '</small>';
                html += '</div>';
                html += '<div><button type="button" class="btn btn-sm btn-outline-secondary btnEditSync" data-row="' + s.rowIndex + '" data-name="' + escapeHtml(s.platformName) + '" data-url="' + escapeHtml(s.icalUrl) + '">編集</button> ';
                html += '<button type="button" class="btn btn-sm btn-outline-danger btnDelSync" data-row="' + s.rowIndex + '">削除</button></div></div></div>';
              });
            } else {
              html = '<p class="text-muted small">連携がありません。「連携を追加」でiCal URLを登録してください。</p>';
            }
            document.getElementById('syncList').innerHTML = html;
            document.getElementById('syncResult').style.display = 'none';
            document.querySelectorAll('.btnEditSync').forEach(function(btn) {
              btn.addEventListener('click', function() {
                var row = parseInt(this.getAttribute('data-row'), 10);
                var name = this.getAttribute('data-name');
                var url = this.getAttribute('data-url');
                openSyncFormModal(row, name, url);
              });
            });
            document.querySelectorAll('.btnDelSync').forEach(function(btn) {
              btn.addEventListener('click', function() {
                var row = parseInt(this.getAttribute('data-row'), 10);
                if (confirm('この連携を削除しますか？')) {
                  google.script.run.withSuccessHandler(function(j) {
                    var r = JSON.parse(j);
                    if (r.success) loadSyncList(); else alert(r.error);
                  }).withFailureHandler(function(e) { alert(e.message); }).deleteSyncSetting(row);
                }
              });
            });
          } catch (e) { document.getElementById('syncList').innerHTML = '<p class="text-danger">読み込み失敗</p>'; }
        }).withFailureHandler(function() { document.getElementById('syncList').innerHTML = '<p class="text-danger">エラー</p>'; }).getSyncSettings();
      }

      function formatNotificationDate(atStr) {
        if (!atStr || typeof atStr !== 'string') return atStr || '';
        var m = atStr.match(/(\d{4})-(\d{1,2})-(\d{1,2})[T\s]+(\d{1,2}):(\d{1,2})/);
        if (!m) {
          var d = new Date(atStr);
          if (!isNaN(d.getTime())) {
            return d.getFullYear() + '/' + (d.getMonth()+1) + '/' + d.getDate() + ' ' + d.getHours() + ':' + String(d.getMinutes()).padStart(2,'0');
          }
          return atStr;
        }
        return m[1] + '/' + parseInt(m[2],10) + '/' + parseInt(m[3],10) + ' ' + parseInt(m[4],10) + ':' + m[5].padStart(2,'0');
      }
      function loadNotificationList() {
        var el = document.getElementById('notificationList');
        if (!el) return;
        google.script.run.withSuccessHandler(function(jsonStr) {
          try {
            var r = JSON.parse(jsonStr);
            if (r.success && r.list && r.list.length) {
              var html = r.list.map(function(n) {
                var kindClass = (n.kind === '立候補') ? 'primary' : (n.kind === '立候補取消') ? 'warning' : (n.kind === '予約追加') ? 'success' : (n.kind === '予約削除') ? 'danger' : (n.kind === '出勤キャンセル要望') ? 'danger' : (n.kind === 'キャンセル承認') ? 'info' : (n.kind === 'キャンセル却下') ? 'secondary' : 'secondary';
                return '<div class="border rounded p-2 mb-2 small"><span class="badge bg-' + kindClass + ' me-2">' + escapeHtml(n.kind) + '</span><span class="text-muted">' + escapeHtml(formatNotificationDate(n.at)) + '</span> ' + escapeHtml(n.message) + '</div>';
              }).join('');
              el.innerHTML = html;
            } else {
              el.innerHTML = '<p class="text-muted small">通知はまだありません。</p>';
            }
          } catch (e) { el.innerHTML = '<p class="text-danger small">読み込み失敗</p>'; }
        }).withFailureHandler(function() { if (el) el.innerHTML = '<p class="text-danger small">エラー</p>'; }).getNotifications();
      }
      function loadStaffSchedule() {
        var el = document.getElementById('staffScheduleList');
        var monthInp = document.getElementById('staffScheduleMonth');
        if (!el) return;
        if (monthInp && !monthInp.dataset.init) {
          monthInp.dataset.init = '1';
          var d = new Date();
          monthInp.value = d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0');
          monthInp.addEventListener('change', loadStaffSchedule);
        }
        var staffId = (window.currentUserName || window.currentUserEmail || '').trim();
        if (!staffId) {
          el.innerHTML = '<p class="text-muted small">スタッフを選択してください。</p>';
          return;
        }
        var ym = monthInp && monthInp.value ? monthInp.value : (function() {
          var d = new Date();
          return d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0');
        })();
        google.script.run.withSuccessHandler(function(jsonStr) {
          try {
            var r = JSON.parse(jsonStr);
            if (r.success && r.list && r.list.length) {
              el.innerHTML = r.list.map(function(item) {
                var partners = (item.partners || []).length ? ' 相方: ' + item.partners.join(', ') : '';
                return '<div class="border rounded p-2 mb-2 small d-flex justify-content-between align-items-center"><div><strong>' + escapeHtml(item.checkoutDisplay) + '</strong>' + escapeHtml(partners) + (item.guestName ? ' <span class="text-muted">' + escapeHtml(item.guestName) + '</span>' : '') + '</div><button type="button" class="btn btn-sm btn-outline-danger py-0" data-row="' + item.rowNumber + '">取り消し</button></div>';
              }).join('');
              el.querySelectorAll('[data-row]').forEach(function(btn) {
                btn.onclick = function() {
                  var row = this.getAttribute('data-row');
                  if (!confirm('この日の出勤を取り消しますか？')) return;
                  google.script.run.withSuccessHandler(function(j) {
                    var res = JSON.parse(j);
                    if (res.success) { loadStaffSchedule(); loadAndRender(); }
                    else alert(res.error || '失敗');
                  }).withFailureHandler(function(e) { alert(e.message); }).cancelStaffFromCleaning(row, staffId);
                };
              });
            } else {
              el.innerHTML = '<p class="text-muted small">' + ym + ' の出勤予定はありません。</p>';
            }
          } catch (e) { el.innerHTML = '<p class="text-danger small">読み込み失敗</p>'; }
        }).withFailureHandler(function() { el.innerHTML = '<p class="text-danger small">エラー</p>'; }).getStaffSchedule(staffId, ym);
      }
      function loadNotificationListMain() {
        var el = document.getElementById('notificationListMain');
        if (!el) return;
        var clearListBtn = document.getElementById('btnClearAllNotifList');
        if (clearListBtn) {
          clearListBtn.onclick = function() {
            if (!confirm('全ての通知を削除しますか？')) return;
            clearListBtn.disabled = true;
            clearListBtn.textContent = '削除中...';
            google.script.run.withSuccessHandler(function(j) {
              var res = JSON.parse(j);
              clearListBtn.disabled = false;
              clearListBtn.textContent = '一括削除';
              if (res.success) { loadNotificationListMain(); updateNotificationBanner(); }
            }).withFailureHandler(function() { clearListBtn.disabled = false; clearListBtn.textContent = '一括削除'; }).clearAllNotifications();
          };
        }
        google.script.run.withSuccessHandler(function(jsonStr) {
          try {
            var r = JSON.parse(jsonStr);
            if (r.success && r.list && r.list.length) {
              var html = r.list.map(function(n) {
                var kindClass = (n.kind === '立候補') ? 'primary' : (n.kind === '立候補取消') ? 'warning' : (n.kind === '予約追加') ? 'success' : (n.kind === '予約削除') ? 'danger' : 'secondary';
                var readBtn = n.read ? '' : ' <button type="button" class="btn btn-sm btn-outline-secondary py-0 ms-1 btn-notif-read" data-row="' + n.rowIndex + '">既読</button>';
                return '<div class="border rounded p-2 mb-2 small"><span class="badge bg-' + kindClass + ' me-2">' + escapeHtml(n.kind) + '</span><span class="text-muted">' + escapeHtml(formatNotificationDate(n.at)) + '</span>\u3000' + escapeHtml(n.message) + readBtn + '</div>';
              }).join('');
              el.innerHTML = html;
              el.querySelectorAll('.btn-notif-read').forEach(function(btn) {
                btn.onclick = function() {
                  var row = parseInt(this.getAttribute('data-row'), 10);
                  google.script.run.withSuccessHandler(function(j) {
                    var res = JSON.parse(j);
                    if (res.success) { loadNotificationListMain(); updateNotificationBanner(); }
                  }).withFailureHandler(function() {}).markNotificationAsRead(row);
                };
              });
            } else {
              el.innerHTML = '<p class="text-muted small">通知はまだありません。</p>';
            }
          } catch (e) { el.innerHTML = '<p class="text-danger small">読み込み失敗</p>'; }
        }).withFailureHandler(function() { if (el) el.innerHTML = '<p class="text-danger small">エラー</p>'; }).getNotifications(false);
      }
      function updateNotificationBanner() {
        google.script.run.withSuccessHandler(function(jsonStr) {
          try {
            var r = JSON.parse(jsonStr);
            var banner = document.getElementById('notificationBanner');
            var listEl = document.getElementById('notificationBannerList');
            if (!banner || !listEl) return;
            if (r.success && r.list && r.list.length) {
              var filtered = r.list.filter(function(n) { return (n.message || '').trim() !== ''; });
              if (filtered.length === 0) { listEl.innerHTML = ''; banner.style.display = 'none'; return; }
              listEl.innerHTML = filtered.map(function(n) {
                var line = '<div class="d-flex align-items-center justify-content-between gap-2 mb-1 notif-banner-row">';
                line += '<span>' + escapeHtml(formatNotificationDate(n.at)) + '\u3000' + escapeHtml(n.message) + '</span>';
                line += '<span class="d-flex gap-1 flex-shrink-0">';
                if (n.data && n.data.bookingRowNumber) {
                  line += '<button type="button" class="btn btn-sm btn-outline-primary py-0 btn-notif-open" data-brn="' + n.data.bookingRowNumber + '" data-codate="' + escapeHtml(n.data.checkoutDate || '') + '">開く</button>';
                }
                line += '<button type="button" class="btn btn-sm btn-outline-secondary py-0 btn-notif-banner-read" data-row="' + n.rowIndex + '">既読</button>';
                line += '</span></div>';
                return line;
              }).join('');
              listEl.querySelectorAll('.btn-notif-open').forEach(function(btn) {
                btn.onclick = function() {
                  var brn = parseInt(this.getAttribute('data-brn'), 10);
                  var coDate = this.getAttribute('data-codate') || '';
                  // カレンダーイベントから該当する清掃イベントを探して開く
                  var found = false;
                  if (calendar) {
                    var allEvents = calendar.getEvents();
                    for (var ei = 0; ei < allEvents.length; ei++) {
                      var ev = allEvents[ei];
                      var ep = ev.extendedProps || {};
                      if (ep.type === 'cleaning' && ep.data) {
                        var rn = ep.data.rowNumber;
                        var mrn = ep.data.mergedRowNumbers || [];
                        if (rn === brn || mrn.indexOf(brn) >= 0) {
                          showEventModal(ev);
                          found = true;
                          break;
                        }
                      }
                    }
                  }
                  if (!found) alert('該当する清掃イベントが見つかりません。カレンダーを確認してください。');
                };
              });
              listEl.querySelectorAll('.btn-notif-banner-read').forEach(function(btn) {
                btn.onclick = function() {
                  var row = parseInt(this.getAttribute('data-row'), 10);
                  google.script.run.withSuccessHandler(function(j) {
                    var res = JSON.parse(j);
                    if (res.success) updateNotificationBanner();
                  }).withFailureHandler(function() {}).markNotificationAsRead(row);
                };
              });
              banner.style.display = 'block';
              var clearBtn = document.getElementById('btnClearAllNotifBanner');
              if (clearBtn) {
                clearBtn.onclick = function() {
                  if (!confirm('全ての通知を削除しますか？')) return;
                  clearBtn.disabled = true;
                  clearBtn.textContent = '削除中...';
                  google.script.run.withSuccessHandler(function(j) {
                    var res = JSON.parse(j);
                    if (res.success) { updateNotificationBanner(); loadNotificationListMain(); }
                    else { clearBtn.disabled = false; clearBtn.textContent = '一括削除'; }
                  }).withFailureHandler(function() { clearBtn.disabled = false; clearBtn.textContent = '一括削除'; }).clearAllNotifications();
                };
              }
            } else {
              listEl.innerHTML = '';
              banner.style.display = 'none';
            }
          } catch (e) {}
        }).withFailureHandler(function() {}).getNotifications(true);
      }

      function openSyncFormModal(rowIndex, platformName, icalUrl) {
        document.getElementById('syncFormRowIndex').value = rowIndex || '';
        document.getElementById('syncFormPlatformName').value = platformName || '';
        document.getElementById('syncFormIcalUrl').value = icalUrl || '';
        document.getElementById('syncFormError').style.display = 'none';
        document.getElementById('btnSaveSyncForm').textContent = rowIndex ? '保存' : '追加';
        new bootstrap.Modal(document.getElementById('syncFormModal')).show();
      }

      function loadSettings() {
        google.script.run.withSuccessHandler(function(jsonStr) {
          try {
            var r = JSON.parse(jsonStr);
            var inp = document.getElementById('staffDeployUrlInput');
            if (inp && r.success && r.url) inp.value = r.url;
          } catch (e) {}
        }).getStaffDeployUrl();
        google.script.run.withSuccessHandler(function(jsonStr) {
          try {
            var r = JSON.parse(jsonStr);
            var inp = document.getElementById('invoiceFolderIdInput');
            if (inp && r.success && r.folderId) inp.value = r.folderId || '';
          } catch (e) {}
        }).getInvoiceFolderId();
        google.script.run.withSuccessHandler(function(jsonStr) {
          try {
            var r = JSON.parse(jsonStr);
            if (!r.success) return;
            var setupForm = document.getElementById('ownerSetupForm');
            var emailSection = document.getElementById('ownerEmailSection');
            var subTabs = document.getElementById('settingsSubTabs');
            var desc = document.getElementById('settingsDescription');
            var pwdSetupForm = document.getElementById('ownerPasswordSetupForm');
            if (r.ownerNotSet) {
              if (setupForm) setupForm.style.display = 'block';
              if (pwdSetupForm) pwdSetupForm.style.display = 'none';
              if (emailSection) emailSection.style.display = 'none';
              if (subTabs) subTabs.style.display = 'none';
              if (desc) desc.textContent = '初回のみオーナー登録を行ってください。登録後はオーナーのみ設定画面にアクセスできます。';
            } else {
              if (setupForm) setupForm.style.display = 'none';
              if (!r.hasPassword) {
                if (pwdSetupForm) pwdSetupForm.style.display = 'block';
                if (emailSection) emailSection.style.display = 'block';
                if (subTabs) subTabs.style.display = 'none';
              } else {
                if (pwdSetupForm) pwdSetupForm.style.display = 'none';
                if (emailSection) emailSection.style.display = 'block';
                if (subTabs) subTabs.style.display = '';
                loadStaffList();
                loadSubOwnerList();
              }
              var disp = document.getElementById('ownerEmailDisplay');
              if (disp) disp.textContent = r.email || '(未設定)';
              if (desc) desc.textContent = 'オーナーのみ閲覧・編集可能です。';
            }
          } catch (e) {}
        }).getOwnerStatus();
      }

      document.getElementById('btnOwnerSetup').addEventListener('click', function() {
        var email = document.getElementById('ownerSetupEmail').value.trim();
        var pw = document.getElementById('ownerSetupPassword').value;
        var pw2 = document.getElementById('ownerSetupPasswordConfirm').value;
        var errEl = document.getElementById('ownerSetupError');
        if (!email) { errEl.textContent = 'メールアドレスを入力してください。'; errEl.style.display = 'block'; return; }
        if (pw.length < 6) { errEl.textContent = 'パスワードは6文字以上で入力してください。'; errEl.style.display = 'block'; return; }
        if (pw !== pw2) { errEl.textContent = 'パスワードが一致しません。'; errEl.style.display = 'block'; return; }
        errEl.style.display = 'none';
        google.script.run.withSuccessHandler(function(jsonStr) {
          var r = JSON.parse(jsonStr);
          if (r.success) { alert('登録しました。'); window.isOwnerUser = true; window.ownerNotSet = false; loadSettings(); }
          else { errEl.textContent = r.error || '失敗'; errEl.style.display = 'block'; }
        }).withFailureHandler(function(err) { errEl.textContent = err.message || 'エラー'; errEl.style.display = 'block'; }).setOwnerWithPassword(email, pw);
      });

      document.getElementById('btnOwnerPasswordSetup').addEventListener('click', function() {
        var pw = document.getElementById('ownerPasswordSetup').value;
        var pw2 = document.getElementById('ownerPasswordSetupConfirm').value;
        var errEl = document.getElementById('ownerPasswordSetupError');
        if (pw.length < 6) { errEl.textContent = 'パスワードは6文字以上で入力してください。'; errEl.style.display = 'block'; return; }
        if (pw !== pw2) { errEl.textContent = 'パスワードが一致しません。'; errEl.style.display = 'block'; return; }
        errEl.style.display = 'none';
        google.script.run.withSuccessHandler(function(jsonStr) {
          var r = JSON.parse(jsonStr);
          if (r.success) { alert('設定しました。'); loadSettings(); }
          else { errEl.textContent = r.error || '失敗'; errEl.style.display = 'block'; }
        }).withFailureHandler(function(err) { errEl.textContent = err.message || 'エラー'; errEl.style.display = 'block'; }).setInitialPassword(pw);
      });

      document.getElementById('btnSaveInvoiceFolder').addEventListener('click', function() {
        var folderId = document.getElementById('invoiceFolderIdInput').value.trim();
        var resEl = document.getElementById('invoiceFolderSaveResult');
        google.script.run.withSuccessHandler(function(jsonStr) {
          try {
            var r = JSON.parse(jsonStr);
            if (r.success) {
              resEl.textContent = '保存しました。';
              resEl.className = 'small mt-1 text-success';
              resEl.style.display = 'block';
              setTimeout(function() { resEl.style.display = 'none'; }, 2000);
            } else {
              resEl.textContent = r.error || '失敗';
              resEl.className = 'small mt-1 text-danger';
              resEl.style.display = 'block';
            }
          } catch (e) { resEl.textContent = 'エラー'; resEl.className = 'small mt-1 text-danger'; resEl.style.display = 'block'; }
        }).withFailureHandler(function(err) {
          resEl.textContent = err.message || 'エラー';
          resEl.className = 'small mt-1 text-danger';
          resEl.style.display = 'block';
        }).setInvoiceFolderId(folderId);
      });
      document.getElementById('btnCreateInvoice').addEventListener('click', function() {
        var staffId = (window.currentUserName || window.currentUserEmail || '').trim();
        var monthInp = document.getElementById('staffScheduleMonth');
        var ym = monthInp && monthInp.value ? monthInp.value : (function() {
          var d = new Date();
          return d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0');
        })();
        var resEl = document.getElementById('invoiceCreateResult');
        if (!staffId) { resEl.textContent = 'スタッフを選択してください'; resEl.className = 'small ms-2 text-danger'; resEl.style.display = 'inline'; return; }
        resEl.textContent = '作成中...';
        resEl.className = 'small ms-2 text-muted';
        resEl.style.display = 'inline';
        google.script.run.withSuccessHandler(function(jsonStr) {
          try {
            var r = JSON.parse(jsonStr);
            if (r.success) {
              resEl.textContent = '保存しました: ' + (r.fileName || '');
              resEl.className = 'small ms-2 text-success';
              setTimeout(function() { resEl.style.display = 'none'; }, 4000);
            } else {
              resEl.textContent = r.error || '失敗';
              resEl.className = 'small ms-2 text-danger';
            }
          } catch (e) { resEl.textContent = 'エラー'; resEl.className = 'small ms-2 text-danger'; }
        }).withFailureHandler(function(err) {
          resEl.textContent = err.message || 'エラー';
          resEl.className = 'small ms-2 text-danger';
        }).createStaffInvoice(ym, staffId, null);
      });
      document.getElementById('btnSaveStaffUrl').addEventListener('click', function() {
        var url = document.getElementById('staffDeployUrlInput').value.trim();
        var resEl = document.getElementById('staffUrlSaveResult');
        google.script.run.withSuccessHandler(function(jsonStr) {
          try {
            var r = JSON.parse(jsonStr);
            if (r.success) {
              resEl.textContent = '保存しました。';
              resEl.className = 'small mt-1 text-success';
              resEl.style.display = 'block';
              setTimeout(function() { resEl.style.display = 'none'; }, 2000);
            } else {
              resEl.textContent = r.error || '失敗';
              resEl.className = 'small mt-1 text-danger';
              resEl.style.display = 'block';
            }
          } catch (e) { resEl.textContent = 'エラー'; resEl.className = 'small mt-1 text-danger'; resEl.style.display = 'block'; }
        }).withFailureHandler(function(err) {
          resEl.textContent = err.message || 'エラー';
          resEl.className = 'small mt-1 text-danger';
          resEl.style.display = 'block';
        }).setStaffDeployUrl(url);
      });
      document.getElementById('btnCopyStaffUrl').addEventListener('click', function() {
        var url = document.getElementById('staffDeployUrlInput').value.trim();
        if (!url) { alert('URLが入力されていません。スタッフ用デプロイのURLを入力して保存してください。'); return; }
        if (navigator.clipboard && navigator.clipboard.writeText) {
          navigator.clipboard.writeText(url).then(function() { alert('コピーしました。'); }).catch(function() {});
        } else {
          var inp = document.getElementById('staffDeployUrlInput');
          inp.select();
          if (document.execCommand) document.execCommand('copy');
          alert('コピーしました。');
        }
      });
      document.getElementById('btnChangeOwnerEmail').addEventListener('click', function() {
        document.getElementById('ownerEmailNew').value = '';
        document.getElementById('ownerEmailPassword').value = '';
        document.getElementById('ownerEmailChangeError').style.display = 'none';
        new bootstrap.Modal(document.getElementById('ownerEmailChangeModal')).show();
      });

      document.getElementById('btnConfirmOwnerEmailChange').addEventListener('click', function() {
        var newEmail = document.getElementById('ownerEmailNew').value.trim();
        var pw = document.getElementById('ownerEmailPassword').value;
        var errEl = document.getElementById('ownerEmailChangeError');
        if (!newEmail) { errEl.textContent = '新しいメールアドレスを入力してください。'; errEl.style.display = 'block'; return; }
        if (!pw) { errEl.textContent = 'パスワードを入力してください。'; errEl.style.display = 'block'; return; }
        errEl.style.display = 'none';
        google.script.run.withSuccessHandler(function(jsonStr) {
          var r = JSON.parse(jsonStr);
          if (r.success) { bootstrap.Modal.getInstance(document.getElementById('ownerEmailChangeModal')).hide(); loadSettings(); alert('変更しました。'); }
          else { errEl.textContent = r.error || '失敗'; errEl.style.display = 'block'; }
        }).withFailureHandler(function(err) { errEl.textContent = err.message || 'エラー'; errEl.style.display = 'block'; }).changeOwnerEmail(newEmail, pw);
      });

      function loadStaffList() {
        google.script.run.withSuccessHandler(function(jsonStr) {
          try {
            var res = JSON.parse(jsonStr);
            var html = '';
            if (res.success && res.list && res.list.length) {
              res.list.forEach(function(s) {
                html += '<div class="border rounded p-2 mb-2"><strong>' + escapeHtml(s.name) + '</strong> ' + escapeHtml(s.email);
                html += ' <button type="button" class="btn btn-sm btn-outline-secondary btnEditStaff" data-row="' + s.rowIndex + '" data-name="' + escapeHtml(s.name) + '" data-address="' + escapeHtml(s.address) + '" data-email="' + escapeHtml(s.email) + '" data-bank="' + escapeHtml(s.bankName) + '" data-branch="' + escapeHtml(s.bankBranch) + '" data-atype="' + escapeHtml(s.accountType) + '" data-anum="' + escapeHtml(s.accountNumber) + '" data-holder="' + escapeHtml(s.accountHolder) + '">編集</button>';
                html += ' <button type="button" class="btn btn-sm btn-outline-danger btnDelStaff" data-row="' + s.rowIndex + '">削除</button></div>';
              });
            }
            document.getElementById('staffList').innerHTML = html || '<p class="text-muted">スタッフがいません。</p>';
            document.querySelectorAll('.btnEditStaff').forEach(function(btn) {
              btn.addEventListener('click', function() {
                document.getElementById('staffFormRowIndex').value = this.getAttribute('data-row');
                document.getElementById('staffFormName').value = this.getAttribute('data-name') || '';
                document.getElementById('staffFormAddress').value = this.getAttribute('data-address') || '';
                document.getElementById('staffFormEmail').value = this.getAttribute('data-email') || '';
                document.getElementById('staffFormBankName').value = this.getAttribute('data-bank') || '';
                document.getElementById('staffFormBankBranch').value = this.getAttribute('data-branch') || '';
                document.getElementById('staffFormAccountType').value = this.getAttribute('data-atype') || '';
                document.getElementById('staffFormAccountNumber').value = this.getAttribute('data-anum') || '';
                document.getElementById('staffFormAccountHolder').value = this.getAttribute('data-holder') || '';
                new bootstrap.Modal(document.getElementById('staffFormModal')).show();
              });
            });
            document.querySelectorAll('.btnDelStaff').forEach(function(btn) {
              btn.addEventListener('click', function() {
                if (!confirm('このスタッフを削除しますか？')) return;
                var row = parseInt(this.getAttribute('data-row'), 10);
                google.script.run.withSuccessHandler(function(jsonStr) {
                  var r = JSON.parse(jsonStr);
                  if (r.success) loadStaffList();
                }).deleteStaff(row);
              });
            });
          } catch (e) {}
        }).getStaffList();
      }

      document.getElementById('btnAddStaff').addEventListener('click', function() {
        document.getElementById('staffFormRowIndex').value = '';
        document.getElementById('staffFormName').value = '';
        document.getElementById('staffFormAddress').value = '';
        document.getElementById('staffFormEmail').value = '';
        document.getElementById('staffFormBankName').value = '';
        document.getElementById('staffFormBankBranch').value = '';
        document.getElementById('staffFormAccountType').value = '';
        document.getElementById('staffFormAccountNumber').value = '';
        document.getElementById('staffFormAccountHolder').value = '';
        new bootstrap.Modal(document.getElementById('staffFormModal')).show();
      });

      document.getElementById('btnSaveStaffForm').addEventListener('click', function() {
        var btn = this;
        if (btn.disabled) return;
        var row = document.getElementById('staffFormRowIndex').value;
        var data = {
          name: document.getElementById('staffFormName').value.trim(),
          address: document.getElementById('staffFormAddress').value.trim(),
          email: document.getElementById('staffFormEmail').value.trim(),
          bankName: document.getElementById('staffFormBankName').value.trim(),
          bankBranch: document.getElementById('staffFormBankBranch').value.trim(),
          accountType: document.getElementById('staffFormAccountType').value.trim(),
          accountNumber: document.getElementById('staffFormAccountNumber').value.trim(),
          accountHolder: document.getElementById('staffFormAccountHolder').value.trim()
        };
        btn.disabled = true;
        google.script.run.withSuccessHandler(function(jsonStr) {
          btn.disabled = false;
          var r = JSON.parse(jsonStr);
          if (r.success) { bootstrap.Modal.getInstance(document.getElementById('staffFormModal')).hide(); loadStaffList(); }
          else { document.getElementById('staffFormError').textContent = r.error || '失敗'; document.getElementById('staffFormError').style.display = 'block'; }
        }).withFailureHandler(function() { btn.disabled = false; }).saveStaff(row ? parseInt(row, 10) : null, data);
      });

      function loadSubOwnerList() {
        google.script.run.withSuccessHandler(function(jsonStr) {
          try {
            var res = JSON.parse(jsonStr);
            var html = '';
            if (res.success && res.list && res.list.length) {
              res.list.forEach(function(s) {
                html += '<div class="border rounded p-2 mb-2"><strong>' + escapeHtml(s.displayName) + '</strong> <small class="text-muted">' + escapeHtml(s.email) + '</small>';
                html += ' <button type="button" class="btn btn-sm btn-outline-secondary btnEditSubOwner" data-row="' + s.rowIndex + '" data-email="' + escapeHtml(s.email) + '" data-display="' + escapeHtml(s.displayName) + '">編集</button>';
                html += ' <button type="button" class="btn btn-sm btn-outline-danger btnDelSubOwner" data-row="' + s.rowIndex + '">削除</button></div>';
              });
            }
            document.getElementById('subOwnerList').innerHTML = html || '<p class="text-muted">サブオーナーがいません。</p>';
            document.querySelectorAll('.btnEditSubOwner').forEach(function(btn) {
              btn.addEventListener('click', function() {
                document.getElementById('subOwnerFormRowIndex').value = this.getAttribute('data-row');
                document.getElementById('subOwnerFormEmail').value = this.getAttribute('data-email') || '';
                document.getElementById('subOwnerFormDisplayName').value = this.getAttribute('data-display') || '';
                document.getElementById('subOwnerFormError').style.display = 'none';
                new bootstrap.Modal(document.getElementById('subOwnerFormModal')).show();
              });
            });
            document.querySelectorAll('.btnDelSubOwner').forEach(function(btn) {
              btn.addEventListener('click', function() {
                if (!confirm('このサブオーナーを削除しますか？')) return;
                var row = parseInt(this.getAttribute('data-row'), 10);
                google.script.run.withSuccessHandler(function(jsonStr) {
                  var r = JSON.parse(jsonStr);
                  if (r.success) loadSubOwnerList();
                }).deleteSubOwner(row);
              });
            });
          } catch (e) {}
        }).getSubOwnerList();
      }

      document.getElementById('btnAddSubOwner').addEventListener('click', function() {
        document.getElementById('subOwnerFormRowIndex').value = '';
        document.getElementById('subOwnerFormEmail').value = '';
        document.getElementById('subOwnerFormDisplayName').value = '';
        document.getElementById('subOwnerFormError').style.display = 'none';
        new bootstrap.Modal(document.getElementById('subOwnerFormModal')).show();
      });

      document.getElementById('btnSaveSubOwnerForm').addEventListener('click', function() {
        var btn = this;
        if (btn.disabled) return;
        var row = document.getElementById('subOwnerFormRowIndex').value;
        var email = document.getElementById('subOwnerFormEmail').value.trim();
        var displayName = document.getElementById('subOwnerFormDisplayName').value.trim();
        var errEl = document.getElementById('subOwnerFormError');
        if (!email) { errEl.textContent = 'メールアドレスを入力してください。'; errEl.style.display = 'block'; return; }
        errEl.style.display = 'none';
        btn.disabled = true;
        google.script.run.withSuccessHandler(function(jsonStr) {
          btn.disabled = false;
          var r = JSON.parse(jsonStr);
          if (r.success) {
            bootstrap.Modal.getInstance(document.getElementById('subOwnerFormModal')).hide();
            loadSubOwnerList();
          } else {
            errEl.textContent = r.error || '失敗';
            errEl.style.display = 'block';
          }
        }).withFailureHandler(function(err) {
          btn.disabled = false;
          errEl.textContent = err.message || 'エラー';
          errEl.style.display = 'block';
        }).saveSubOwner(row ? parseInt(row, 10) : null, email, displayName);
      });

      function loadJobList() {
        google.script.run.withSuccessHandler(function(jobStr) {
          var jobRes = JSON.parse(jobStr);
          if (!jobRes.success || !jobRes.list) {
            document.getElementById('jobList').innerHTML = '<p class="text-muted">仕事内容がありません。</p>';
            return;
          }
          google.script.run.withSuccessHandler(function(compStr) {
            try {
              var compRes = JSON.parse(compStr);
              var byJob = {};
              if (compRes.success && compRes.list) {
                compRes.list.forEach(function(c) {
                  if (!byJob[c.jobName]) byJob[c.jobName] = {};
                  byJob[c.jobName][c.staffName] = c.amount;
                });
              }
              google.script.run.withSuccessHandler(function(specStr) {
                var specRes = JSON.parse(specStr);
                var specialByJob = (specRes.success && specRes.byJob) ? specRes.byJob : {};
                google.script.run.withSuccessHandler(function(optStr) {
                  var opt = JSON.parse(optStr);
                  var staffOrder = ['共通'];
                  if (opt.success && opt.staffList) {
                    opt.staffList.forEach(function(s) {
                      if (s.name) staffOrder.push(s.name);
                    });
                  }
                  var html = '';
                  jobRes.list.forEach(function(j) {
                    var comps = byJob[j.name] || {};
                    var specials = specialByJob[j.name] || [];
                    html += '<div class="border rounded p-3 mb-3">';
                    html += '<div class="d-flex justify-content-between align-items-center mb-2">';
                    html += '<strong>' + escapeHtml(j.name) + '</strong>';
                    html += '<div><button type="button" class="btn btn-sm btn-outline-secondary btnEditJob" data-row="' + j.rowIndex + '" data-name="' + escapeHtml(j.name) + '" data-sort="' + (j.sortOrder || 99) + '">仕事内容を編集</button> ';
                    html += '<button type="button" class="btn btn-sm btn-outline-primary btnEditJobComp" data-name="' + escapeHtml(j.name) + '">報酬を編集</button> ';
                    html += '<button type="button" class="btn btn-sm btn-outline-danger btnDelJob" data-row="' + j.rowIndex + '">削除</button></div>';
                    html += '</div>';
                    html += '<div class="ms-2 small text-muted">';
                    staffOrder.forEach(function(staff) {
                      var amt = comps[staff];
                      html += '<span class="me-3">' + escapeHtml(staff) + ': ' + (amt ? escapeHtml(amt) + '円' : '未設定') + '</span>';
                    });
                    html += '</div>';
                    if (specials.length) {
                      html += '<div class="ms-2 small text-muted mt-1">特別: ';
                      html += specials.map(function(s) {
                        var range = s.startDate === (s.endDate || s.startDate) ? s.startDate : s.startDate + '～' + (s.endDate || s.startDate);
                        return escapeHtml(s.itemName) + ' ' + range + ' +' + escapeHtml(s.amount) + '円';
                      }).join(' / ');
                      html += '</div>';
                    }
                    html += '</div>';
                  });
                document.getElementById('jobList').innerHTML = html || '<p class="text-muted">仕事内容がありません。</p>';
                document.querySelectorAll('.btnEditJob').forEach(function(btn) {
                  btn.addEventListener('click', function() {
                    document.getElementById('jobFormRowIndex').value = this.getAttribute('data-row') || '';
                    document.getElementById('jobFormSortOrder').value = this.getAttribute('data-sort') || '99';
                    document.getElementById('jobFormName').value = this.getAttribute('data-name') || '';
                    document.getElementById('jobFormError').style.display = 'none';
                    new bootstrap.Modal(document.getElementById('jobFormModal')).show();
                  });
                });
                document.querySelectorAll('.btnEditJobComp').forEach(function(btn) {
                  btn.addEventListener('click', function() {
                    openJobCompFormModal(this.getAttribute('data-name'));
                  });
                });
                document.querySelectorAll('.btnDelJob').forEach(function(btn) {
                  btn.addEventListener('click', function() {
                    if (!confirm('削除しますか？')) return;
                    google.script.run.withSuccessHandler(function() { loadJobList(); }).deleteJobType(parseInt(btn.getAttribute('data-row'), 10));
                  });
                });
              }).getCompFormOptions();
            }).getAllSpecialRates();
          } catch (e) {}
          }).getCompensation();
        }).getJobTypes();
      }

      function addSpecialRateRow(container, data) {
        data = data || { startDate: '', endDate: '', itemName: '', amount: '' };
        var row = document.createElement('div');
        row.className = 'row g-2 mb-2 special-rate-row';
        row.innerHTML = '<div class="col-12 col-md-3"><input type="date" class="form-control form-control-sm special-start" placeholder="対象開始日" value="' + escapeHtml(data.startDate || '') + '"></div>' +
          '<div class="col-12 col-md-3"><input type="date" class="form-control form-control-sm special-end" placeholder="対象終了日" value="' + escapeHtml(data.endDate || '') + '"></div>' +
          '<div class="col-12 col-md-3"><input type="text" class="form-control form-control-sm special-item" placeholder="項目名（例:年末年始）" value="' + escapeHtml(data.itemName || '') + '"></div>' +
          '<div class="col-10 col-md-2"><input type="number" class="form-control form-control-sm special-amount" placeholder="追加円" value="' + escapeHtml(data.amount || '') + '" min="0"></div>' +
          '<div class="col-2 col-md-1"><button type="button" class="btn btn-sm btn-outline-danger btn-remove-special" title="削除">×</button></div>';
        container.appendChild(row);
        row.querySelector('.btn-remove-special').addEventListener('click', function() { row.remove(); });
      }

      function openJobCompFormModal(jobName) {
        document.getElementById('jobCompFormJobName').value = jobName || '';
        document.getElementById('jobCompFormJobNameDisplay').textContent = jobName || '';
        document.getElementById('jobCompFormError').style.display = 'none';
        google.script.run.withSuccessHandler(function(jsonStr) {
          var r = JSON.parse(jsonStr);
          var table = document.getElementById('jobCompFormTable');
          table.innerHTML = '';
          var staffOrder = ['共通'];
          if (r.success && r.staffList) {
            r.staffList.forEach(function(s) {
              if (s.name) staffOrder.push(s.name);
            });
          }
          google.script.run.withSuccessHandler(function(compStr) {
            var comp = JSON.parse(compStr);
            var comps = {};
            if (comp.success && comp.list) {
              comp.list.forEach(function(c) {
                if (c.jobName === jobName) comps[c.staffName] = c.amount;
              });
            }
            staffOrder.forEach(function(staff) {
              var row = document.createElement('div');
              row.className = 'row g-2 mb-1';
              var inp = document.createElement('input');
              inp.type = 'number';
              inp.className = 'form-control form-control-sm job-comp-amount';
              inp.setAttribute('data-staff', staff);
              inp.placeholder = '円';
              inp.min = 0;
              inp.value = comps[staff] || '';
              row.innerHTML = '<div class="col-4 col-md-3"><label class="form-label small mb-0">' + escapeHtml(staff) + '</label></div><div class="col-6 col-md-4"></div>';
              row.querySelector('.col-6').appendChild(inp);
              table.appendChild(row);
            });
            var specContainer = document.getElementById('jobCompFormSpecialRates');
            specContainer.innerHTML = '';
            google.script.run.withSuccessHandler(function(specStr) {
              var spec = JSON.parse(specStr);
              if (spec.success && spec.list && spec.list.length) {
                spec.list.forEach(function(s) { addSpecialRateRow(specContainer, s); });
              }
              addSpecialRateRow(specContainer, {});
              new bootstrap.Modal(document.getElementById('jobCompFormModal')).show();
            }).getSpecialRatesForJob(jobName);
          }).getCompensation();
        }).getCompFormOptions();
      }

      document.getElementById('btnAddSpecialRate').addEventListener('click', function() {
        addSpecialRateRow(document.getElementById('jobCompFormSpecialRates'), {});
      });

      document.getElementById('btnSaveJobCompForm').addEventListener('click', function() {
        var btn = this;
        if (btn.disabled) return;
        var jobName = document.getElementById('jobCompFormJobName').value.trim();
        var errEl = document.getElementById('jobCompFormError');
        if (!jobName) { errEl.textContent = '仕事内容が指定されていません。'; errEl.style.display = 'block'; return; }
        var entries = [];
        document.querySelectorAll('.job-comp-amount').forEach(function(inp) {
          var staff = inp.getAttribute('data-staff');
          var amount = inp.value.trim();
          if (staff && amount) entries.push({ staffName: staff, amount: amount });
        });
        var specialEntries = [];
        document.querySelectorAll('.special-rate-row').forEach(function(row) {
          var start = (row.querySelector('.special-start') || {}).value || '';
          var end = (row.querySelector('.special-end') || {}).value || '';
          var item = (row.querySelector('.special-item') || {}).value || '';
          var amt = (row.querySelector('.special-amount') || {}).value || '';
          if (start && item && amt) specialEntries.push({ startDate: start, endDate: end || start, itemName: item, amount: amt });
        });
        errEl.style.display = 'none';
        btn.disabled = true;
        var origText = btn.textContent;
        btn.textContent = '保存中...';
        google.script.run.withSuccessHandler(function(jsonStr) {
          var r = JSON.parse(jsonStr);
          if (r.success) {
            google.script.run.withSuccessHandler(function(specStr) {
              btn.disabled = false;
              btn.textContent = origText;
              var sr = JSON.parse(specStr);
              if (sr.success) {
                bootstrap.Modal.getInstance(document.getElementById('jobCompFormModal')).hide();
                loadJobList();
              } else { errEl.textContent = sr.error || '特別料金の保存に失敗'; errEl.style.display = 'block'; }
            }).withFailureHandler(function() { btn.disabled = false; btn.textContent = origText; errEl.textContent = '特別料金の保存に失敗'; errEl.style.display = 'block'; }).saveSpecialRatesForJob(jobName, specialEntries);
          } else {
            btn.disabled = false;
            btn.textContent = origText;
            errEl.textContent = r.error || '失敗';
            errEl.style.display = 'block';
          }
        }).withFailureHandler(function() { btn.disabled = false; btn.textContent = origText; }).saveCompensationForJob(jobName, entries);
      });

      document.getElementById('btnAddJob').addEventListener('click', function() {
        document.getElementById('jobFormRowIndex').value = '';
        document.getElementById('jobFormSortOrder').value = '99';
        document.getElementById('jobFormName').value = '';
        document.getElementById('jobFormError').style.display = 'none';
        new bootstrap.Modal(document.getElementById('jobFormModal')).show();
      });

      document.getElementById('btnSaveJobForm').addEventListener('click', function() {
        var btn = this;
        if (btn.disabled) return;
        var rowIndex = document.getElementById('jobFormRowIndex').value;
        var sortOrder = document.getElementById('jobFormSortOrder').value || 99;
        var name = document.getElementById('jobFormName').value.trim();
        var errEl = document.getElementById('jobFormError');
        if (!name) { errEl.textContent = '仕事内容名を入力してください。'; errEl.style.display = 'block'; return; }
        errEl.style.display = 'none';
        btn.disabled = true;
        var origText = btn.textContent;
        btn.textContent = '保存中...';
        google.script.run.withSuccessHandler(function(jsonStr) {
          btn.disabled = false;
          btn.textContent = origText;
          var r = JSON.parse(jsonStr);
          if (r.success) {
            bootstrap.Modal.getInstance(document.getElementById('jobFormModal')).hide();
            loadJobList();
          } else { errEl.textContent = r.error || '失敗'; errEl.style.display = 'block'; }
        }).withFailureHandler(function() { btn.disabled = false; btn.textContent = origText; }).saveJobType(rowIndex ? parseInt(rowIndex, 10) : null, name, parseInt(sortOrder, 10) || 99);
      });

      function loadRecruitSettingsForm() {
        google.script.run.withSuccessHandler(function(jsonStr) {
          try {
            var r = JSON.parse(jsonStr);
            if (r.success && r.settings) {
              document.getElementById('recruitStartWeeks').value = r.settings.recruitStartWeeks || 4;
              document.getElementById('minRespondents').value = r.settings.minRespondents || 2;
              document.getElementById('reminderIntervalWeeks').value = r.settings.reminderIntervalWeeks || 1;
              document.getElementById('selectCount').value = r.settings.selectCount || 2;
            }
          } catch (e) {}
        }).getRecruitmentSettings();
      }

      document.getElementById('btnSaveRecruitSettings').addEventListener('click', function() {
        var settings = {
          recruitStartWeeks: parseInt(document.getElementById('recruitStartWeeks').value, 10) || 4,
          minRespondents: parseInt(document.getElementById('minRespondents').value, 10) || 2,
          reminderIntervalWeeks: parseInt(document.getElementById('reminderIntervalWeeks').value, 1) || 1,
          selectCount: parseInt(document.getElementById('selectCount').value, 10) || 2
        };
        google.script.run.withSuccessHandler(function(jsonStr) {
          var r = JSON.parse(jsonStr);
          alert(r.success ? '保存しました。' : (r.error || '失敗'));
        }).setRecruitmentSettings(settings);
      });

      document.getElementById('btnAddSync').addEventListener('click', function() {
        openSyncFormModal(null, '', '');
      });

      document.getElementById('btnSaveSyncForm').addEventListener('click', function() {
        var btn = this;
        if (btn.disabled) return;
        var rowIndex = document.getElementById('syncFormRowIndex').value;
        var name = document.getElementById('syncFormPlatformName').value.trim();
        var url = document.getElementById('syncFormIcalUrl').value.trim();
        var errEl = document.getElementById('syncFormError');
        if (!name) { errEl.textContent = 'プラットフォーム名を入力してください。'; errEl.style.display = 'block'; return; }
        errEl.style.display = 'none';
        btn.disabled = true;
        var origText = btn.textContent;
        btn.textContent = '保存中...';
        google.script.run.withSuccessHandler(function(j) {
          btn.disabled = false;
          btn.textContent = origText;
          var r = JSON.parse(j);
          if (r.success) {
            bootstrap.Modal.getInstance(document.getElementById('syncFormModal')).hide();
            loadSyncList();
          } else { errEl.textContent = r.error || '失敗'; errEl.style.display = 'block'; }
        }).withFailureHandler(function(e) { btn.disabled = false; btn.textContent = origText; errEl.textContent = e.message || 'エラー'; errEl.style.display = 'block'; }).setSyncSetting(rowIndex ? parseInt(rowIndex, 10) : null, name, url, 'Y');
      });

      document.getElementById('btnClearSynced').addEventListener('click', function() {
        if (!confirm('iCal同期の紐付けを一括解除します。予約行・フォーム入力は残り、プラットフォーム表示のみクリアされます。実行しますか？')) return;
        var btn = document.getElementById('btnClearSynced');
        var resEl = document.getElementById('syncResult');
        btn.disabled = true;
        resEl.style.display = 'none';
        google.script.run.withSuccessHandler(function(jsonStr) {
          try {
            var r = JSON.parse(jsonStr);
            resEl.style.display = 'block';
            resEl.className = 'small mt-2 ' + (r.success ? 'text-success' : 'text-danger');
            resEl.textContent = r.success ? (r.cleared + '件のiCal紐付けを解除しました。') : (r.error || '失敗');
            if (r.success && r.cleared > 0) loadAndRender();
          } catch (e) { resEl.textContent = 'エラー'; }
          btn.disabled = false;
        }).withFailureHandler(function(err) {
          resEl.style.display = 'block';
          resEl.className = 'small mt-2 text-danger';
          resEl.textContent = err.message || 'エラー';
          btn.disabled = false;
        }).clearSyncedBookings();
      });
      document.getElementById('btnImportSpreadsheet').addEventListener('click', function() {
        document.getElementById('importSpreadsheetUrl').value = '';
        document.getElementById('importSkipDuplicates').checked = true;
        document.getElementById('importSpreadsheetError').style.display = 'none';
        new bootstrap.Modal(document.getElementById('importSpreadsheetModal')).show();
        setTimeout(function() { document.getElementById('importSpreadsheetUrl').focus(); }, 300);
      });
      document.getElementById('btnConfirmImportSpreadsheet').addEventListener('click', function() {
        var url = document.getElementById('importSpreadsheetUrl').value.trim();
        var skipDup = document.getElementById('importSkipDuplicates').checked;
        var errEl = document.getElementById('importSpreadsheetError');
        var btn = document.getElementById('btnConfirmImportSpreadsheet');
        if (!url) { errEl.textContent = 'スプレッドシートのURLを入力してください。'; errEl.style.display = 'block'; return; }
        errEl.style.display = 'none';
        btn.disabled = true;
        btn.textContent = '読み込み中...';
        google.script.run.withSuccessHandler(function(jsonStr) {
          btn.disabled = false;
          btn.textContent = '読み込み';
          var r = JSON.parse(jsonStr);
          if (r.success) {
            bootstrap.Modal.getInstance(document.getElementById('importSpreadsheetModal')).hide();
            document.getElementById('syncResult').style.display = 'block';
            document.getElementById('syncResult').className = 'small mt-2 text-success';
            document.getElementById('syncResult').textContent = r.imported + '件を読み込みました。' + (r.skipped ? '（' + r.skipped + '件は重複のためスキップ）' : '');
            if (r.imported > 0) loadAndRender();
          } else { errEl.textContent = r.error || '読み込みに失敗しました。'; errEl.style.display = 'block'; }
        }).withFailureHandler(function(err) {
          btn.disabled = false;
          btn.textContent = '読み込み';
          errEl.textContent = err.message || 'エラーが発生しました。スプシの共有設定（閲覧可）を確認してください。';
          errEl.style.display = 'block';
        }).importFromSpreadsheet(url, skipDup);
      });
      document.getElementById('btnRunSync').addEventListener('click', function() {
        var btn = document.getElementById('btnRunSync');
        var resEl = document.getElementById('syncResult');
        btn.disabled = true;
        resEl.style.display = 'none';
        google.script.run.withSuccessHandler(function(jsonStr) {
          try {
            var r = JSON.parse(jsonStr);
            resEl.style.display = 'block';
            resEl.className = 'small mt-2 ' + (r.success ? 'text-success' : 'text-danger');
            var summary = r.success ? (r.added + '件追加' + (r.removed ? ', ' + r.removed + '件削除（キャンセル等）' : '') + 'しました。') : (r.error || '失敗');
            var html = summary;
            if (r.details && r.details.length) {
              html += '<div class="mt-1">';
              r.details.forEach(function(d) {
                var s = '<strong>' + escapeHtml(d.platform) + '</strong>: 取得' + d.fetched + '件';
                if (d.added > 0) s += ', 追加' + d.added;
                if (d.removed > 0) s += ', 削除' + d.removed;
                if (d.error) s += ' <span class="text-danger">(' + escapeHtml(d.error) + ')</span>';
                html += '<div>' + s + '</div>';
              });
              html += '</div>';
            }
            resEl.innerHTML = html;
            if (r.success) {
              if (r.added > 0 || r.removed > 0) loadAndRender();
              loadSyncList();
            }
          } catch (e) { resEl.textContent = 'エラー'; }
          btn.disabled = false;
        }).withFailureHandler(function(err) {
          resEl.style.display = 'block';
          resEl.className = 'small mt-2 text-danger';
          resEl.textContent = err.message || 'エラー';
          btn.disabled = false;
        }).syncFromICal();
      });

      function doReloadData() {
        var btnSync = document.getElementById('btnReloadDataSync');
        if (btnSync) { btnSync.disabled = true; btnSync.textContent = '読み込み中...'; }
        Promise.all([
          fetchData(),
          new Promise(function(res) {
            google.script.run.withSuccessHandler(function(j) {
              try { var r = JSON.parse(j); res(r.success ? r.map : {}); }
              catch (e) { res({}); }
            }).withFailureHandler(function() { res({}); }).getRecruitmentStatusMap();
          })
        ]).then(function(results) {
          var res = results[0];
          var recruitMap = results[1] || {};
          if (!res.success) {
            alert(res.error || 'データの取得に失敗しました。');
          } else {
            allBookings = res.data || [];
            var events = buildCalendarEvents(allBookings, recruitMap);
            if (calendar) {
              var sources = calendar.getEventSources();
              sources.forEach(function(s) { s.remove(); });
              calendar.addEventSource(events);
            }
            if (btnSync) { btnSync.textContent = 'スプシを再読み込み'; }
          }
          if (btnSync) btnSync.disabled = false;
        }).catch(function() {
          if (btnSync) { btnSync.disabled = false; btnSync.textContent = 'スプシを再読み込み'; }
        });
      }
      document.getElementById('btnReloadDataSync').addEventListener('click', doReloadData);
      document.getElementById('btnAddBooking').addEventListener('click', function() {
        document.getElementById('addBookingCheckIn').value = '';
        document.getElementById('addBookingCheckOut').value = '';
        document.getElementById('addBookingGuestName').value = '';
        document.getElementById('addBookingSite').value = '';
        document.getElementById('addBookingGuestCount').value = '';
        document.getElementById('addBookingError').style.display = 'none';
        new bootstrap.Modal(document.getElementById('addBookingModal')).show();
      });

      document.getElementById('btnConfirmAddBooking').addEventListener('click', function() {
        var checkIn = document.getElementById('addBookingCheckIn').value;
        var checkOut = document.getElementById('addBookingCheckOut').value;
        var guestName = document.getElementById('addBookingGuestName').value.trim();
        var site = document.getElementById('addBookingSite').value.trim();
        var guestCount = document.getElementById('addBookingGuestCount').value.trim();
        var errEl = document.getElementById('addBookingError');
        if (!checkIn || !checkOut) {
          errEl.textContent = 'チェックイン・チェックアウトを入力してください。';
          errEl.style.display = 'block';
          return;
        }
        errEl.style.display = 'none';
        google.script.run.withSuccessHandler(function(jsonStr) {
          try {
            var r = JSON.parse(jsonStr);
            if (r.success) {
              bootstrap.Modal.getInstance(document.getElementById('addBookingModal')).hide();
              loadAndRender();
              alert('予約を追加しました。');
            } else {
              errEl.textContent = r.error || '失敗';
              errEl.style.display = 'block';
            }
          } catch (e) {
            errEl.textContent = 'エラー';
            errEl.style.display = 'block';
          }
        }).withFailureHandler(function(err) {
          errEl.textContent = err.message || 'エラー';
          errEl.style.display = 'block';
        }).addBookingManually(checkIn, checkOut, guestName, site, guestCount);
      });

      document.getElementById('btnAddSelectStaff').addEventListener('click', function() {
        var sel = document.getElementById('recruitSelectStaffDropdown');
        var name = (sel.value || '').trim();
        if (!name) return;
        window._recruitSelectStaffNames = window._recruitSelectStaffNames || [];
        if (window._recruitSelectStaffNames.indexOf(name) >= 0) return;
        window._recruitSelectStaffNames.push(name);
        renderRecruitSelectStaffList();
      });

      document.getElementById('btnConfirmSelect').addEventListener('click', function() {
        var row = parseInt(document.getElementById('recruitSelectRowIndex').value, 10);
        var staff = (window._recruitSelectStaffNames || []).join(',').trim();
        var errEl = document.getElementById('recruitSelectError');
        if (!staff) {
          errEl.textContent = 'スタッフを1名以上選んでください。';
          errEl.style.display = 'block';
          return;
        }
        errEl.style.display = 'none';
        google.script.run.withSuccessHandler(function(jsonStr) {
          try {
            var r = JSON.parse(jsonStr);
            if (r.success) {
              bootstrap.Modal.getInstance(document.getElementById('recruitSelectModal')).hide();
              loadRecruitList();
              loadAndRender();
            } else {
              errEl.textContent = r.error || '失敗';
              errEl.style.display = 'block';
            }
          } catch (e) { errEl.style.display = 'block'; }
        }).withFailureHandler(function(err) {
          errEl.textContent = err.message || 'エラー';
          errEl.style.display = 'block';
        }).selectStaffForRecruitment(row, staff);
      });

      // 設定サブタブ
      document.querySelectorAll('[data-subtab]').forEach(function(a) {
        a.addEventListener('click', function(e) {
          e.preventDefault();
          var t = this.getAttribute('data-subtab');
          document.querySelectorAll('[data-subtab]').forEach(function(l) { l.classList.remove('active'); });
          this.classList.add('active');
          document.getElementById('settingsStaff').style.display = t === 'staff' ? 'block' : 'none';
          document.getElementById('settingsSubOwners').style.display = t === 'subOwners' ? 'block' : 'none';
          document.getElementById('settingsJobs').style.display = t === 'jobs' ? 'block' : 'none';
          document.getElementById('settingsRecruitSettings').style.display = t === 'recruitSettings' ? 'block' : 'none';
          document.getElementById('settingsSync').style.display = t === 'sync' ? 'block' : 'none';
          var notifEl = document.getElementById('settingsNotifications');
          if (notifEl) notifEl.style.display = t === 'notifications' ? 'block' : 'none';
          if (t === 'jobs') loadJobList();
          if (t === 'recruitSettings') loadRecruitSettingsForm();
          if (t === 'sync') loadSyncList();
          if (t === 'subOwners') loadSubOwnerList();
          if (t === 'notifications') loadNotificationList();
        });
      });

      // ログインユーザー情報（立候補・オーナー判定に使用）
      window.currentUserEmail = '';
      window.currentUserName = '';
      window.isOwnerUser = !window.staffMode; // デフォルト: オーナーURL→true, スタッフURL→false
      function populateStaffSelectOptions(targetId) {
        google.script.run.withSuccessHandler(function(sStr) {
          try {
            var s = JSON.parse(sStr);
            var el = document.getElementById(targetId);
            if (el && s.success && s.list && s.list.length) {
              el.innerHTML = '<option value="">-- 選択 --</option>';
              s.list.forEach(function(st) {
                var label = (st.name || st.email) + (st.email ? ' (' + st.email + ')' : '');
                el.innerHTML += '<option value="' + escapeHtml(st.name || '') + '|' + escapeHtml(st.email || '') + '">' + escapeHtml(label) + '</option>';
              });
            }
          } catch (e) {}
        }).getStaffNamesForSelection();
      }
      function applyStaffSelection(name, email) {
        window.currentUserName = (name || '').trim();
        window.currentUserEmail = (email || '').trim();
        try {
          sessionStorage.setItem('staffSelected', JSON.stringify({ name: window.currentUserName, email: window.currentUserEmail }));
        } catch (e) {}
        var badge = document.getElementById('currentAccountBadge');
        if (badge) {
          badge.textContent = window.currentUserName || (window.currentUserEmail ? window.currentUserEmail.split('@')[0] : '');
          badge.style.display = badge.textContent ? '' : 'none';
        }
        var disp = document.getElementById('staffDisplayName');
        if (disp) disp.textContent = window.currentUserName || window.currentUserEmail || '--';
      }
      function showStaffSelectOverlay() {
        if (!window.staffMode) return;
        var ov = document.getElementById('staffSelectOverlay');
        if (ov) {
          ov.style.setProperty('display', 'flex', 'important');
          populateStaffSelectOptions('staffSelectModalSelect');
          var sel = document.getElementById('staffSelectModalSelect');
          if (sel && window.currentUserName) {
            var opts = sel.querySelectorAll('option');
            for (var i = 0; i < opts.length; i++) {
              var v = (opts[i].value || '').split('|');
              if ((v[0] || '').trim() === window.currentUserName) { sel.selectedIndex = i; break; }
            }
          }
        }
      }
      function hideStaffSelectOverlay() {
        var ov = document.getElementById('staffSelectOverlay');
        if (ov) ov.style.setProperty('display', 'none', 'important');
      }
      function showStaffSelectorAndHideTabs() {
        if (!window.staffMode) return;
        window.isOwnerUser = false;
        var bar = document.getElementById('staffSelectorBar');
        if (bar) {
          bar.style.display = 'block';
          var navSet = document.getElementById('navSettings');
          var navTest = document.getElementById('navStaffTest');
          if (navSet) navSet.style.display = 'none';
          if (navTest) navTest.style.display = 'none';
          populateStaffSelectOptions('staffNameSelect');
          var disp = document.getElementById('staffDisplayName');
          if (disp) disp.textContent = window.currentUserName || window.currentUserEmail || '--';
          var saved = null;
          try { saved = JSON.parse(sessionStorage.getItem('staffSelected') || 'null'); } catch (e) {}
          if (saved && (saved.name || saved.email)) {
            applyStaffSelection(saved.name, saved.email);
          }
          if (window.staffMode && !window.currentUserName && !window.currentUserEmail) {
            showStaffSelectOverlay();
          }
          if (!document.getElementById('btnStaffChange').dataset.listen) {
            document.getElementById('btnStaffChange').dataset.listen = '1';
            document.getElementById('btnStaffChange').addEventListener('click', showStaffSelectOverlay);
          }
        }
      }
      var staffConfirmBtn = document.getElementById('staffSelectModalConfirm');
      if (staffConfirmBtn && !staffConfirmBtn.dataset.listen) {
        staffConfirmBtn.dataset.listen = '1';
        staffConfirmBtn.addEventListener('click', function() {
          var sel = document.getElementById('staffSelectModalSelect');
          var v = (sel && sel.value || '').split('|');
          if (!v[0] && !v[1]) { alert('お名前を選択してください'); return; }
          applyStaffSelection(v[0] || '', v[1] || '');
          hideStaffSelectOverlay();
          var disp = document.getElementById('staffDisplayName');
          if (disp) disp.textContent = window.currentUserName || window.currentUserEmail || '--';
        });
      }
      google.script.run.withSuccessHandler(function(jsonStr) {
        try {
          var r = JSON.parse(jsonStr);
          if (r.success) {
            if (window.staffMode) {
              showStaffSelectorAndHideTabs();
            } else if (r.email) {
              window.currentUserEmail = r.email;
              var badge = document.getElementById('currentAccountBadge');
              if (badge && (r.displayName || r.email)) {
                badge.textContent = r.displayName || (r.email ? r.email.split('@')[0] : '');
                badge.style.display = badge.textContent ? '' : 'none';
              }
            }
            // オーナーURLでメールが取得できない場合（ANYONE_ANONYMOUS）は
            // getOwnerAndSwitchUrl のコールバックでタブ表示を制御する
          }
        } catch (e) {}
      }).getCurrentUserEmail();
      google.script.run.withSuccessHandler(function(jsonStr) {
        try {
          var r = JSON.parse(jsonStr);
          if (r.success && r.name) {
            if (!window.staffMode) {
              window.currentUserName = r.name;
            } else {
              // スタッフモードでは Execute as: Me のためサーバーは常にオーナーを返す。
              // ポップアップを閉じず、ユーザー自身に選択させる。
            }
          }
        } catch (e) {}
      }).getMyStaffName();
      google.script.run.withSuccessHandler(function(jsonStr) {
        try {
          var r = JSON.parse(jsonStr);
          if (r.success && r.isOwner && !window.staffMode) window.isOwnerUser = true;
        } catch (e) {}
      }).isOwner();

      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
      } else {
        init();
      }
    })();
  </script>
</body>
</html>
