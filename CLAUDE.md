# Project Instructions

## 1. プロジェクト概要

* **プロジェクト名**: 民泊管理アプリ（minpaku-fix）
* **目的**: 民泊施設の予約管理・清掃スタッフ募集・スケジュール管理を一元化
* **対象ユーザー**:
  - オーナー: 施設オーナー。予約管理・スタッフ選定・請求書発行を行う
  - スタッフ: 清掃スタッフ。募集への回答・チェックリスト記入・スケジュール確認を行う
* **公開先**: Google Apps Script（GAS）Web App として2つの独立したデプロイ
  - メインアプリ（オーナー＋スタッフ兼用、`?staff=1` でスタッフモード切替）
  - チェックリストアプリ（スタッフ専用・モバイル最適化）
* **技術スタック**:
  - バックエンド: Google Apps Script（V8ランタイム）
  - フロントエンド: HTML5 + Bootstrap 5.3.2 + FullCalendar 6.1.10
  - データベース: Google スプレッドシート（外部DB不使用。シートがそのままDB）
  - デプロイ: Node.js + clasp CLI（`deploy-all.js`で両アプリ一括デプロイ）
  - テスト: Python（pytest）
  - タイムゾーン: Asia/Tokyo（ハードコード）

### 技術スタック選定理由
* Google Workspace エコシステム内で完結（追加インフラ不要）
* オーナーが Google スプレッドシートで直接データ確認・編集可能
* GAS の Web App 機能で認証付き公開が容易

## 2. ページ構成

### メインアプリ（`index.html` + `Code.gs`）
* **カレンダー画面** — 予約（宿泊）と清掃イベントを FullCalendar で表示。月/週/リスト切替
* **清掃詳細モーダル** — 次回予約情報、募集ステータス、スタッフ回答状況、清掃担当表示
* **予約詳細モーダル** — チェックイン/アウト、宿泊者名、人数、BBQ、駐車場、メモ
* **スタッフ募集一覧** — 募集中の清掃案件一覧。回答（◎△×）送信、告知（メール/LINE）
* **スタッフ管理** — スタッフ登録・編集・有効/無効切替
* **請求書** — スタッフ報酬の月別集計・PDF生成・メール送信
* **iCal同期** — Airbnb/Booking.com の iCal URL から予約を自動取得
* **設定画面** — オーナー情報、サブオーナー、募集設定、連携設定、セル数最適化

### チェックリストアプリ（`checklist-app/checklist.html` + `checklist-app/Code.gs`）
* モバイル最適化された清掃チェックリスト
* 写真撮影・アップロード機能
* 備品補充記録
* スタッフメモ

## 3. デザイン・トーン

* **カラー**: Bootstrap 5 のデフォルトテーマベース（カスタム CSS で微調整）
* **フォント**: システムフォント（Bootstrap デフォルト）
* **レイアウト**: モバイルファースト。スタッフは基本スマホで操作
* **トーン**: 機能優先。業務アプリとして直感的に操作できることを重視

## 4. ファイル構成

```
minpaku-fix/
├── Code.gs                     # メインアプリ バックエンド（~9,665行）
├── index.html                  # メインアプリ フロントエンド（~8,447行）
├── appsscript.json             # GAS マニフェスト（メインアプリ）
├── checklist-app/
│   ├── Code.gs                 # チェックリストアプリ バックエンド（~2,947行）
│   ├── checklist.html          # チェックリストアプリ フロントエンド（~5,788行）
│   └── appsscript.json         # GAS マニフェスト（チェックリスト）
├── deploy.js                   # メインアプリ デプロイスクリプト
├── deploy-all.js               # 両アプリ一括デプロイ
├── deploy-all.bat              # Windows バッチラッパー
├── deploy-config.json          # デプロイ設定（git ignored）
├── package.json                # Node.js 依存関係（@google/clasp）
├── CLAUDE.md                   # このファイル
├── tests/
│   └── test_app.py             # Python テストスイート
└── manual-generator/           # スクリプトドキュメント生成ツール
```

## 5. スプレッドシート構成（DB設計）

### 主要データシート
| シート名 | 用途 | 主要カラム |
|---|---|---|
| `フォームの回答 1` | 予約データ（Google Form 由来） | チェックイン/アウト, 氏名, 宿泊人数, 清掃担当, メモ |
| `募集` | 清掃スタッフ募集 | チェックアウト日, 予約行番号, ステータス(募集中/選定済/スタッフ確定済み), 選定スタッフ |
| `募集_立候補` | スタッフの回答データ | 募集ID(r行番号), スタッフ名, メール, 回答日時, メモ, ステータス(◎/△/×) |
| `清掃スタッフ` | スタッフマスタ | スタッフ名, メール, 電話, 銀行情報, 有効フラグ, 表示順 |
| `スタッフ共有用` | スタッフ向け予約詳細 | チェックイン/アウト, 人数, BBQ, 国籍, ベッド数 |

### 設定シート
| シート名 | 用途 |
|---|---|
| `設定_オーナー` | オーナーメールアドレス等 |
| `サブオーナー` | サブオーナーアクセス制御 |
| `仕事内容マスタ` | 報酬の仕事種別と料金 |
| `スタッフ報酬` | 報酬記録 |
| `特別料金` | 特別料金オーバーライド |
| `募集設定` | 募集開始週数、最少回答者数等 |
| `設定_連携` | iCal URL 等の外部連携設定 |
| `通知履歴` | 通知ログ |

### チェックリスト関連シート
| シート名 | 用途 |
|---|---|
| `チェックリストマスタ` | チェック項目テンプレート |
| `撮影箇所マスタ` | 写真撮影ポイント |
| `チェックリスト記録` | チェックリスト完了記録 |
| `チェックリスト写真` | 写真メタデータ |
| `要補充記録` | 備品補充記録 |

### 重要なデータフロー
```
ブラウザ (index.html)
  ↓ google.script.run
Code.gs (GAS バックエンド)
  ↓ SpreadsheetApp API
Google スプレッドシート (DB)
```

### キャッシュ戦略
* **サーバー側**: `CacheService`（チャンク分割、90秒TTL、100KBチャンク）
  - `getInitData()` → 起動データをキャッシュ
  - 全書き込み操作で `invalidateInitDataCache_()` を呼んで無効化
  - `getAllActiveStaff_()` → スタッフリストを 600秒キャッシュ
* **クライアント側**: `window._recruitFullMap` でページリロードまでデータ保持

### 重要な設計パターン
1. **トリガーベース自動ソート**: `onFormSubmit → mergeFormResponseToExistingBooking_ → sortFormResponses_ → checkAndCreateRecruitments`
2. **動的カラムマッピング**: `buildColumnMap()` がヘッダーからカラムインデックスを自動検出
3. **RIDベース参照**: `募集_立候補` が `r{行番号}` で `募集` シートの行を参照
4. **Upsert パターン**: `respondToRecruitment()` が既存回答を検索→あれば更新、なければ新規挿入

## 6. 設計方針・コーディング規約

* コメントは日本語
* GAS は V8 ランタイム（`const`/`let`/アロー関数使用可、ただし既存コードは `var` 混在）
* フロントエンドは Bootstrap 5 + バニラ JS（フレームワーク不使用）
* シート名は日本語定数（`SHEET_RECRUIT` = `'募集'` 等）
* 関数名は camelCase、プライベート関数は末尾 `_`（例: `invalidateInitDataCache_`）

## 7. バージョン番号の更新（必須・絶対忘れないこと）

コードを変更するたびに、以下のバージョン番号を必ず更新すること。
フォーマット: `v{MMDD}{連番アルファベット}` 例: v0218a, v0218b, ...

### 1. メインアプリ（オーナー・スタッフ共通）
- **ファイル**: `index.html`
- **場所**: `id="deployVersion"` のバッジテキスト（969行付近）
- **現在値**: `v0228a`

### 2. チェックリストアプリ
- **ファイル**: `checklist-app/checklist.html`
- **場所**: `header-title` 内の `<span>` タグ（1444行付近）
- **現在値**: `v0219f`

### 更新ルール
- 同日中の変更: アルファベットを1つ進める（例: v0218r → v0218s）
- 日付が変わった場合: 新しい日付+a（例: v0219a）
- メインアプリだけ変更した場合でもメインアプリのバージョンを更新
- チェックリストアプリだけ変更した場合でもチェックリストのバージョンを更新
- **両方変更した場合は両方更新**

## 8. Deploy Command

Every response that includes a code change MUST end with the following deploy command block:

```
cd C:\Users\yamas\minpaku-fix && git fetch origin && git checkout -f claude/review-handoff-docs-5WgKR && git reset --hard origin/claude/review-handoff-docs-5WgKR && node deploy-all.js
```

## 9. 実装ステータス（全セッション履歴）

### セッション 2026-02-28: デプロイスクリプト EPERM 耐性追加

| 項目 | ステータス | 詳細 |
|---|---|---|
| デプロイスクリプト EPERM 耐性 | ✅ 完了 | `deploy-all.js` と `deploy-checklist.js` の両方で、clasp push/deploy 成功後の `.clasprc.json` 書き込み EPERM を警告のみで続行するように修正 |

#### 修正内容

- **deploy-all.js**: `run()` 関数に EPERM 検出＋成功パターン判定を追加。push 個別チェックも追加
- **checklist-app/deploy-checklist.js**: `runCapture()` 関数に同様の EPERM 耐性を追加。push 判定も修正
- **CLAUDE.md**: 既知の課題を「対処済」に更新

---

### セッション 2026-02-27: モーダル軽量化の撤回

| 項目 | ステータス | 詳細 |
|---|---|---|
| 清掃詳細モーダル軽量化撤回 | ✅ 完了 | `getCleaningModalDataLight()` のキャッシュパスがデータ欠落の原因。常にフルAPI(`getCleaningModalData()`)を使用するように戻した |

#### 修正内容

- **index.html**: `_recruitFullMap` キャッシュによる軽量パス分岐を削除。常に `getCleaningModalData()` でフルデータ取得に統一
- **Code.gs**: 不要になった `getRecruitSupplementary_()` と `getCleaningModalDataLight()` を削除
- **残したもの**: Phase1（スタッフリストキャッシュ）、Phase2-B（getInitDataキャッシュ）は問題なく動作するため維持

---

### セッション 2026-02-26: スタッフ回答状況バグ修正

| 項目 | ステータス | 詳細 |
|---|---|---|
| スタッフ回答状況「未回答」表示バグ | ✅ 完了 | 4つのバグの連鎖が原因。すべて修正済み |
| CLAUDE.md 全面更新 | ✅ 完了 | 引き継ぎ資料テンプレートに準じて再構成 |

#### 修正したバグ（詳細）

**バグ1: `getRecruitmentStatusMap()` 重複エントリ上書き**
- 症状: 同じ予約に対して `募集` シートに重複エントリがあると、回答データのない方で上書きされ「未回答」表示になる
- 修正: 回答データ（非「未回答」）が多い方を優先保持するロジック追加

**バグ2: `checkAndCreateRecruitments()` 重複募集エントリ作成**
- 症状: ソート後に行番号が変わると、同じ予約に対する `募集` エントリが二重作成される
- 修正: チェックアウト日ベースの重複防止チェックを追加

**バグ3: `syncRecruitBookingRowsAfterSort_()` 同日複数予約非対応**
- 症状: 同日チェックアウトの予約が複数あると行番号マッピング失敗
- 修正: 配列管理 + 旧行番号近接値選択 + 使用済み追跡

**バグ4: `getLastRow()` off-by-one エラー**
- 症状: 全関数で1行余分（空行）を読み取り
- 修正: `getLastRow() - 1` に統一（13関数）

---

### セッション 2026-02-24: 請求書要請メール・通知修正

| 項目 | ステータス | 詳細 |
|---|---|---|
| 請求書要請メール機能 | ✅ 完了 | デフォルト送信無し。オーナーが任意で送信 |
| 名簿通知誤検知修正 | ✅ 完了 | 氏名列の部分一致・複数列対応・キャンセル除外 |
| スタッフ回答状況ズレ修正 | ✅ 完了 | 通知タブ表示不具合も併せて修正 |
| 請求書テスト送信の宛先指定 | ✅ 完了 | テスト送信時に宛先を指定可能に |

---

### セッション 2026-02-23: オーナーURL問題・テスト環境

| 項目 | ステータス | 詳細 |
|---|---|---|
| オーナーURL消え問題（根本修正） | ✅ 完了 | 非同期コールバック競合（レースコンディション）を5段階で修正 |
| 取消申請サイレント失敗 | ✅ 完了 | ReferenceError修正 + オーナーURL保存の堅牢化 |
| Playwright自動テストスクリプト | ✅ 完了 | Python + Excel出力の自動テスト基盤 |
| iPhone写真撮影ブラックアウト | ✅ 完了 | `capture="environment"` 属性を削除 |
| 請求書メール送信結果UI表示 | ✅ 完了 | エラー詳細を保持して表示 |

---

### セッション 2026-02-22: パフォーマンス最適化・取消申請修正

| 項目 | ステータス | 詳細 |
|---|---|---|
| CacheServiceでスタッフリストキャッシュ | ✅ 完了 | 600秒TTL |
| getInitData() 90秒キャッシュ | ✅ 完了 | チャンク分割対応（100KBチャンク） |
| モーダル最適化 | ✅ 完了 | キャッシュ活用で軽量API呼び出し |
| オーナーURL永続化（3層キャッシュ） | ✅ 完了 | ブラウザ更新後も保持 |
| 取消申請がオーナーに届かない | ✅ 完了 | フォールバック検索追加 |
| 通知パネルクラッシュ | ✅ 完了 | メール通知デフォルトONに変更 |
| iCal同期ブロック日誤認 | ✅ 完了 | 併せてオーナーURL永続化も強化 |

---

### セッション 2026-02-21: 通知改善・閲覧専用URL・ダークモード修正

| 項目 | ステータス | 詳細 |
|---|---|---|
| ensureCancelledAtColumn_ 未定義エラー | ✅ 完了 | 関数が存在しないケースを修正 |
| テキストコピー/メールURLの最新化 | ✅ 完了 | 常に最新デプロイURLを使用 |
| 宿泊者名簿未記入通知の重複・誤検知 | ✅ 完了 | 検知ロジック修正 |
| カレンダー宿泊イベント表示変更 | ✅ 完了 | 宿泊者名を削除してシンプルに |
| 予約追加通知にチェックイン日追加 | ✅ 完了 | |
| カレンダー今日枠のダークモード対応 | ✅ 完了 | box-shadow方式に変更 |
| 通知タブ期間フィルタ＋自動削除 | ✅ 完了 | 既読通知の10日自動削除 |
| 清掃詳細の備考例文をplaceholderに | ✅ 完了 | |
| 閲覧専用URL (`?view=readonly`) | ✅ 完了 | スタッフビューベース |
| 設定タブにURL一覧サブタブ新設 | ✅ 完了 | オーナーURL入力で自動生成 |

---

### セッション 2026-02-19〜20: 募集同期・通知・ダークモード

| 項目 | ステータス | 詳細 |
|---|---|---|
| ゲートウェイ直接表示方式 | ✅ 完了 | リダイレクト不要の表示方式に変更 |
| 募集シートの古い日付問題 | ✅ 完了 | ソート後の行番号同期で根本対策（危険な日付自動更新は撤回） |
| 孤立した募集エントリの自動修復 | ✅ 完了 | 遠未来日付+回答ありを検出して修復 |
| メール通知ON/OFF設定リセット問題 | ✅ 完了 | 型変換バグ修正 |
| iCalソースごとの同期ON/OFFトグル | ✅ 完了 | UIに追加 |
| 募集リマインドON/OFFバグ | ✅ 完了 | |
| 全メール重複送信防止 | ✅ 完了 | LockService + PropertiesService |
| 出勤一覧4月表示問題 | ✅ 完了 | rBookingRow優先で正しい日付取得 |
| スタッフ照合を名前+メール両方 | ✅ 完了 | 出勤一覧のスタッフ照合精度向上 |
| スタッフ名変更時の自動伝播 | ✅ 完了 | 全関連シートの名前を自動更新 |
| ダークモード見出し視認性改善 | ✅ 完了 | 確定済み・クリーニング状況見出し |
| Booking.com自動同期エラーハンドリング | ✅ 完了 | |

---

### セッション 2026-02-17〜18: 請求書機能・バージョン管理

| 項目 | ステータス | 詳細 |
|---|---|---|
| 請求書機能の独立タブ化 | ✅ 完了 | PDF生成・メール送信・履歴管理 |
| 請求書PDF品質改善 | ✅ 完了 | 金額右寄せ・罫線・日付フォーマット |
| iOS Safari対応 | ✅ 完了 | confirm()/prompt()をカスタムモーダルに置換 |
| バージョン表示の追加 | ✅ 完了 | オーナー画面・スタッフ画面・チェックリストアプリ |
| 撮影タブの折りたたみ＋一括アップロード | ✅ 完了 | |
| 要補充タブ刷新 | ✅ 完了 | 全supplyItem表示+カテゴリタグ+双方向同期 |
| 設定タブに編集ロック/アンロック機能 | ✅ 完了 | |
| カレンダードット統一 | ✅ 完了 | 募集中=赤丸 |
| deploy-all.bat自動ブランチ検出 | ✅ 完了 | `git branch --show-current` 方式 |
| 名簿リマインド判定修正 | ✅ 完了 | 部分一致・複数列対応・キャンセル除外 |
| 撮影タブ「未整理」セクション | ✅ 完了 | 一括アップロード+タグ付け振り分け |
| iCal自動同期設定UI | ✅ 完了 | 設定の予約連携タブに追加 |
| メール通知ON/OFF個別制御 | ✅ 完了 | 全8通知の個別制御に対応 |
| 清掃詳細カードスタイル統一 | ✅ 完了 | 薄い色ベースに統一 |
| スタッフ画面通知バナー | ✅ 完了 | 3種の通知追加 |

---

### セッション 2026-02-15〜16: チェックリスト並び替え・要補充・マニュアル

| 項目 | ステータス | 詳細 |
|---|---|---|
| 10Mセル上限エラー自動修復 | ✅ 完了 | ensureSheetsExist()の改善 |
| チェックリスト項目並び替え | ✅ 完了 | ドラッグハンドル長押し(600ms)方式 |
| カテゴリ並び替え | ✅ 完了 | 大カテゴリ・中カテゴリ対応 |
| 見本写真機能 | ✅ 完了 | 日付非依存のサンプル写真 |
| チェック項目の別カテゴリ移動 | ✅ 完了 | |
| UNDO機能 | ✅ 完了 | 並び替え・移動・リネームに1回UNDO |
| メモ機能追加 | ✅ 完了 | 登録ボタン方式+写真添付 |
| GAS同時実行数エラー防止 | ✅ 完了 | キュー制御 |
| 全チェック/全解除の一括化 | ✅ 完了 | 個別GAS呼び出しをバッチ化 |
| 要補充タブ改善 | ✅ 完了 | カテゴリ表示・復活バグ・双方向同期 |
| 複数スマホ同時利用同期 | ✅ 完了 | deviceId別管理 |
| スタッフ操作マニュアル生成ツール | ✅ 完了 | Puppeteerスクショ+HTML生成 |

---

### セッション 2026-02-13〜14: チェックリストUI大改修・クリーニング機能

| 項目 | ステータス | 詳細 |
|---|---|---|
| チェックリスト4階層対応 | ✅ 完了 | CSV全558項目を網羅 |
| カテゴリ見出し差別化 | ✅ 完了 | 大=濃紺、中=薄青、小=オレンジ、細=紫 |
| 全展開/全折り・カテゴリ編集・削除 | ✅ 完了 | |
| タブナビ上部配置（sticky） | ✅ 完了 | ボタン形式タブ |
| 漏れチェック統合 | ✅ 完了 | 清掃完了ボタンに統合 |
| クリーニング連絡機能 | ✅ 完了 | 出し/受取/施設戻しの3ステップ記録 |
| 清掃ステータスマーク修正 | ✅ 完了 | 確定後に即座に緑に変わる（楽観的キャッシュ更新） |
| 設定タブ大幅改修 | ✅ 完了 | |
| カレンダー色統一 | ✅ 完了 | 確定=緑、募集中=黄 |
| deploy-all.js（両アプリ一括デプロイ） | ✅ 完了 | |

---

### セッション 2026-02-10〜12: チェックリストアプリ分離・デプロイ環境

| 項目 | ステータス | 詳細 |
|---|---|---|
| チェックリストアプリを別GASプロジェクトに分離 | ✅ 完了 | |
| deploy-all.bat / deploy-all.js 作成 | ✅ 完了 | |
| デプロイID永続保存（URL固定化） | ✅ 完了 | deploy-config.json |
| 清掃募集レコード半自動作成 | ✅ 完了 | |
| 各種ボタンにスピナー追加 | ✅ 完了 | |
| 名簿リマインダー設定タブ | ✅ 完了 | |

---

### セッション 2026-02-06: 初期UI改善

| 項目 | ステータス | 詳細 |
|---|---|---|
| 清掃詳細・宿泊詳細モーダルUI全面リデザイン | ✅ 完了 | |
| メモ欄権限分離・連絡事項欄追加 | ✅ 完了 | |
| iCal予約重複排除 | ✅ 完了 | |
| デプロイ時のWebアプリ設定リセット問題修正 | ✅ 完了 | |

## 10. 既知の課題・バグ一覧

| 課題 | 優先度 | 詳細 |
|---|---|---|
| `募集` シートに既存の重複エントリが残っている可能性 | 中 | 2/26の修正で新規作成は防止したが、過去に作られた重複は残存。表示上は修正済み（回答データ優先ロジック）だが、スプシ上のデータクリーンアップは未実施 |
| 残りの `getLastRow()` off-by-one | 低 | 主要13関数は修正済みだが、補助的な関数にまだ残っている箇所がある（実害は少ない） |
| `.clasprc.json` の権限エラー | ✅ 対処済 | デプロイスクリプト(`deploy-all.js`, `deploy-checklist.js`)にEPERM耐性を追加。push/deploy成功時はEPERMを警告表示のみで続行する。根本解消は `icacls "%USERPROFILE%\.clasprc.json" /grant "%USERNAME%:F"` |
| オーナーURL消え問題（5回修正済み） | 低 | v0223c〜g で根本修正済み。レースコンディションを排除。再発時は非同期コールバック競合を疑う |

## 11. 次回セッションでやるべきことリスト

1. **デプロイ後の動作確認**: 過去の日付のスタッフ回答状況が正しく表示されるか確認
2. **`募集` シートの重複エントリクリーンアップ**: 既存の重複を検出・統合するユーティリティ関数の作成（任意）
3. **残りの `getLastRow()` off-by-one修正**: 補助関数にも展開（任意）
4. **スタッフ選択の複数端末同期テスト**: 粘着ユニオン問題の解消確認
5. **メール重複送信防止の動作確認**: トリガーセットアップボタンの動作確認、リマインドメール1通のみ届くか確認
