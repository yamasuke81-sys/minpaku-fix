<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>æ¸…æƒãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      background: #f5f5f5;
      color: #333;
      padding-bottom: 16px;
      -webkit-tap-highlight-color: transparent;
    }

    /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
    .header {
      background: #2c3e50;
      color: white;
      padding: 8px 16px;
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .header-top {
      display: flex;
      align-items: center;
      justify-content: flex-start;
      gap: 8px;
    }
    .header-title { font-size: 14px; font-weight: bold; }
    .header-date { font-size: 14px; opacity: 0.9; }
    .progress-bar {
      height: 6px;
      background: rgba(255,255,255,0.2);
      border-radius: 3px;
      margin-top: 6px;
      overflow: hidden;
    }
    .progress-fill {
      height: 100%;
      background: #27ae60;
      transition: width 0.3s;
      border-radius: 3px;
    }

    /* ã‚¹ã‚¿ãƒƒãƒ•é¸æŠï¼ˆãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆæœ¬ä½“ä¸Šéƒ¨ï¼‰ */
    .staff-selector {
      background: #f0f8ff;
      border: 2px solid #3498db;
      border-radius: 8px;
      padding: 10px 12px;
      margin: 10px 12px 4px;
    }
    .staff-selector-label {
      font-size: 12px;
      font-weight: bold;
      color: #2c3e50;
      margin-bottom: 6px;
    }
    .staff-row {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-bottom: 4px;
    }
    .staff-row:last-child { margin-bottom: 0; }
    .staff-select {
      padding: 8px 10px;
      border-radius: 6px;
      border: 1px solid #bbb;
      background: white;
      color: #333;
      font-size: 15px;
      font-weight: bold;
      flex: 1;
    }
    .staff-select option { color: #333; background: white; }
    .staff-add-btn, .staff-remove-btn {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      border: 1px solid #3498db;
      background: white;
      color: #3498db;
      font-size: 18px;
      line-height: 1;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }
    .staff-remove-btn { font-size: 14px; border-color: #e74c3c; color: #e74c3c; }

    /* ã‚¿ãƒ–ãƒŠãƒ“ï¼ˆãƒ˜ãƒƒãƒ€ãƒ¼ç›´ä¸‹ï¼‰ */
    .tab-nav {
      display: flex;
      gap: 6px;
      padding: 6px 12px;
      background: #f5f5f5;
      position: sticky;
      top: 52px;
      z-index: 99;
    }
    .tab-nav-btn {
      flex: 1;
      padding: 10px 6px;
      border: 1px solid #bdc3c7;
      background: white;
      font-size: 13px;
      font-weight: bold;
      color: #7f8c8d;
      cursor: pointer;
      border-radius: 8px;
      transition: all 0.2s;
    }
    .tab-nav-btn.active {
      color: white;
      background: #2c3e50;
      border-color: #2c3e50;
    }
    .tab-nav-btn .tab-badge {
      display: inline-block;
      padding: 1px 6px;
      border-radius: 10px;
      font-size: 11px;
      font-weight: bold;
      margin-left: 4px;
      vertical-align: middle;
    }
    .tab-badge-warning {
      background: #ffc107;
      color: #856404;
    }
    .tab-content { display: none; }
    .tab-content.active { display: block; }

    /* æ¬¡å›äºˆç´„æƒ…å ± */
    .booking-info {
      background: white;
      margin: 12px;
      padding: 16px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .booking-info h3 {
      font-size: 16px;
      color: #2c3e50;
      margin-bottom: 12px;
      padding-bottom: 8px;
      border-bottom: 2px solid #3498db;
    }
    .booking-row {
      display: flex;
      padding: 6px 0;
      font-size: 14px;
    }
    .booking-label {
      font-weight: bold;
      min-width: 100px;
      color: #555;
    }
    .booking-value {
      flex: 1;
      color: #333;
    }

    /* ã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆéƒ¨å±‹ã”ã¨ï¼‰ */
    .section {
      background: white;
      margin: 8px 12px;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 4px rgba(0,0,0,0.08);
    }
    .section-header {
      padding: 10px 16px 8px;
      background: #2c3e50;
      display: flex;
      flex-direction: column;
      cursor: pointer;
      user-select: none;
      -webkit-user-select: none;
      transition: background 0.2s;
    }
    .section-header-row1 {
      display: flex;
      align-items: center;
      width: 100%;
    }
    .section-header-row2 {
      display: flex;
      align-items: center;
      justify-content: flex-end;
      margin-top: 6px;
      gap: 12px;
    }
    .section-header:active {
      background: #1a252f;
    }
    .section-header.has-missing {
      background: #c0392b;
    }
    .section-icon {
      font-size: 20px;
      margin-right: 8px;
      transition: transform 0.3s;
      color: white;
    }
    .section-header.collapsed .section-icon {
      transform: rotate(-90deg);
    }
    .section-title {
      flex: 1;
      font-size: 13px;
      font-weight: bold;
      color: white;
      letter-spacing: 0.5px;
    }
    .section-title.missing {
      color: #ff8a80;
    }
    .section-count {
      font-size: 13px;
      color: rgba(255,255,255,0.7);
      margin-left: 8px;
    }
    .section-body {
      max-height: 100000px;
      overflow: hidden;
      transition: max-height 0.4s ease-out;
    }
    .section-body.collapsed {
      max-height: 0;
      transition: max-height 0.3s ease-in;
    }

    /* ä¸­ã‚«ãƒ†ã‚´ãƒªï¼ˆã‚µãƒ–ã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼‰ */
    .sub-section {
      margin-left: 12px;
      border-left: 3px solid #2980b9;
    }
    .sub-section > .section-header {
      padding: 10px 14px;
      background: #3498db;
      font-size: 14px;
    }
    .sub-section > .section-header:active {
      background: #2980b9;
    }
    .sub-section > .section-header.has-missing {
      background: #c0392b;
    }
    .sub-section > .section-icon {
      color: #fff;
      font-size: 16px;
    }
    .sub-section > .section-title {
      font-size: 14px;
      font-weight: 600;
      color: #fff;
      letter-spacing: 0;
    }
    .sub-section > .section-count {
      font-size: 12px;
      color: rgba(255,255,255,0.8);
    }

    /* å°ã‚«ãƒ†ã‚´ãƒªï¼ˆã‚µãƒ–ã‚µãƒ–ã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼‰ */
    .sub-sub-section {
      margin-left: 10px;
      border-left: 3px solid #d35400;
    }
    .sub-sub-section > .section-header {
      padding: 8px 12px;
      background: #e67e22;
      font-size: 13px;
    }
    .sub-sub-section > .section-header:active {
      background: #d35400;
    }
    .sub-sub-section > .section-header.has-missing {
      background: #c0392b;
    }
    .sub-sub-section > .section-icon {
      color: #fff;
      font-size: 14px;
    }
    .sub-sub-section > .section-title {
      font-size: 13px;
      font-weight: 600;
      color: #fff;
      letter-spacing: 0;
    }
    .sub-sub-section > .section-count {
      font-size: 11px;
      color: rgba(255,255,255,0.8);
    }

    /* ç´°ã‚«ãƒ†ã‚´ãƒªï¼ˆã‚µãƒ–ã‚µãƒ–ã‚µãƒ–ã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼‰ */
    .sub-sub-sub-section {
      margin-left: 8px;
      border-left: 3px solid #7d3c98;
    }
    .sub-sub-sub-section > .section-header {
      padding: 6px 10px;
      background: #9b59b6;
      font-size: 12px;
    }
    .sub-sub-sub-section > .section-header:active {
      background: #7d3c98;
    }
    .sub-sub-sub-section > .section-header.has-missing {
      background: #c0392b;
    }
    .sub-sub-sub-section > .section-icon {
      color: #fff;
      font-size: 13px;
    }
    .sub-sub-sub-section > .section-title {
      font-size: 12px;
      font-weight: 600;
      color: #fff;
      letter-spacing: 0;
    }
    .sub-sub-sub-section > .section-count {
      font-size: 11px;
      color: rgba(255,255,255,0.8);
    }

    /* ã‚»ã‚¯ã‚·ãƒ§ãƒ³ãƒ˜ãƒƒãƒ€ãƒ¼å†…ãƒœã‚¿ãƒ³ï¼ˆã‚¢ã‚¤ã‚³ãƒ³ã®ã¿ï¼‰ */
    .section-header-btn {
      padding: 4px 6px;
      border: 1px solid;
      border-radius: 4px;
      background: transparent;
      font-size: 14px;
      font-weight: bold;
      cursor: pointer;
      white-space: nowrap;
      line-height: 1;
    }
    .section-cat-edit {
      padding: 4px 6px;
      font-size: 12px;
    }
    .section-cat-delete {
      padding: 4px 6px;
      font-size: 12px;
    }
    /* å¤§ã‚«ãƒ†ã‚´ãƒª(æ¿ƒç´º)ã®ãƒœã‚¿ãƒ³ */
    .section > .section-header .section-header-btn {
      border-color: rgba(255,255,255,0.6);
      color: #fff;
      background: rgba(255,255,255,0.12);
    }
    .section > .section-header .section-header-btn:active {
      background: rgba(255,255,255,0.25);
    }
    /* ä¸­ã‚«ãƒ†ã‚´ãƒª(é’)ã®ãƒœã‚¿ãƒ³ */
    .sub-section > .section-header .section-header-btn {
      border-color: rgba(255,255,255,0.6);
      color: #fff;
      background: rgba(255,255,255,0.15);
    }
    .sub-section > .section-header .section-header-btn:active {
      background: rgba(255,255,255,0.3);
    }
    /* å°ã‚«ãƒ†ã‚´ãƒª(ã‚ªãƒ¬ãƒ³ã‚¸)ã®ãƒœã‚¿ãƒ³ */
    .sub-sub-section > .section-header .section-header-btn {
      border-color: rgba(255,255,255,0.6);
      color: #fff;
      background: rgba(0,0,0,0.12);
    }
    .sub-sub-section > .section-header .section-header-btn:active {
      background: rgba(0,0,0,0.25);
    }
    /* ç´°ã‚«ãƒ†ã‚´ãƒª(ç´«)ã®ãƒœã‚¿ãƒ³ */
    .sub-sub-sub-section > .section-header .section-header-btn {
      border-color: rgba(255,255,255,0.6);
      color: #fff;
      background: rgba(255,255,255,0.15);
    }
    .sub-sub-sub-section > .section-header .section-header-btn:active {
      background: rgba(255,255,255,0.3);
    }


    /* ãƒã‚§ãƒƒã‚¯é …ç›® */
    .checklist-item {
      padding: 12px 10px;
      border-bottom: 1px solid #ecf0f1;
      display: flex;
      align-items: flex-start;
      gap: 8px;
    }
    .checklist-item:last-child {
      border-bottom: none;
    }
    .item-checkbox {
      width: 24px;
      height: 24px;
      min-width: 24px;
      cursor: pointer;
      margin-top: 2px;
    }
    .item-content {
      flex: 1;
    }
    .item-name {
      font-size: 13px;
      color: #333;
      line-height: 1.5;
      cursor: pointer;
      -webkit-user-select: none;
      user-select: none;
    }
    .item-memo {
      font-size: 11px;
      color: #888;
      line-height: 1.4;
      margin-top: 2px;
      white-space: pre-wrap;
      word-break: break-word;
    }
    .item-edit-memo {
      width: 100%;
      min-height: 40px;
      padding: 6px 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 13px;
      resize: vertical;
      margin-top: 4px;
      box-sizing: border-box;
      font-family: inherit;
    }
    .item-name.missing {
      color: #e74c3c;
      font-weight: bold;
    }
    .supply-checkbox-container {
      margin-top: 6px;
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 13px;
      color: #7f8c8d;
    }
    .supply-checkbox {
      width: 18px;
      height: 18px;
      cursor: pointer;
    }

    /* æ’®å½±ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
    .photo-section {
      background: white;
      margin: 8px 12px;
      padding: 16px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.08);
    }
    .photo-section h3 {
      font-size: 16px;
      color: #2c3e50;
      margin-bottom: 12px;
      padding-bottom: 8px;
      border-bottom: 2px solid #e67e22;
    }
    .photo-spot {
      margin-bottom: 16px;
      padding: 12px;
      background: #fafafa;
      border-radius: 6px;
    }
    .photo-spot-name {
      font-size: 14px;
      font-weight: bold;
      margin-bottom: 8px;
      color: #2c3e50;
    }
    .photo-spot-name.missing {
      color: #e74c3c;
    }
    .photo-timing-group {
      margin-bottom: 12px;
    }
    .photo-timing-label {
      font-size: 13px;
      color: #555;
      margin-bottom: 6px;
      font-weight: bold;
    }
    .photo-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
      gap: 8px;
      margin-bottom: 8px;
    }
    .photo-thumb {
      width: 100%;
      padding-bottom: 100%;
      background-size: cover;
      background-position: center;
      border-radius: 4px;
      border: 1px solid #ddd;
    }
    .photo-upload-btn {
      padding: 8px 12px;
      background: #3498db;
      color: white;
      border: none;
      border-radius: 4px;
      font-size: 13px;
      cursor: pointer;
      width: 100%;
    }
    .photo-upload-btn:active {
      background: #2980b9;
    }

    /* è¦è£œå……ãƒªã‚¹ãƒˆï¼ˆã‚¿ãƒ–ç”¨ï¼‰ */
    .supply-tab-content {
      padding: 12px;
    }
    .supply-list-card {
      background: #fff3cd;
      padding: 16px;
      border-radius: 8px;
      border-left: 4px solid #ffc107;
    }
    .supply-list-card h3 {
      font-size: 16px;
      color: #856404;
      margin-bottom: 12px;
    }
    .supply-item {
      padding: 8px 12px;
      font-size: 14px;
      color: #856404;
      background: rgba(255,255,255,0.5);
      border-radius: 4px;
      margin-bottom: 6px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .supply-item:before {
      content: "\26A0\FE0F ";
      flex-shrink: 0;
    }
    .supply-item-category {
      font-size: 10px;
      color: #fff;
      background: #2c3e50;
      padding: 2px 6px;
      border-radius: 3px;
      flex-shrink: 1;
      min-width: 0;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      max-width: 50%;
    }
    .supply-item-name {
      flex: 1;
      min-width: 0;
    }
    .supply-item-show-btn {
      font-size: 12px;
      color: #fff;
      background: #3498db;
      border: none;
      padding: 4px 10px;
      border-radius: 4px;
      cursor: pointer;
      flex-shrink: 0;
      white-space: nowrap;
    }
    .supply-item-show-btn:active {
      background: #2980b9;
    }
    .supply-item-remove-btn {
      font-size: 12px;
      color: #fff;
      background: #e74c3c;
      border: none;
      padding: 4px 10px;
      border-radius: 4px;
      cursor: pointer;
      flex-shrink: 0;
      white-space: nowrap;
      margin-left: 4px;
    }
    .supply-item-remove-btn:active {
      background: #c0392b;
    }
    @keyframes supply-highlight {
      0% { background: #ffeaa7; }
      100% { background: transparent; }
    }
    .supply-highlight {
      animation: supply-highlight 2s ease-out;
    }
    .supply-empty {
      text-align: center;
      padding: 40px 20px;
      color: #7f8c8d;
      font-size: 14px;
    }

    /* ãƒ¡ãƒ¢ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
    .memo-section {
      background: white;
      margin: 8px 12px;
      padding: 16px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.08);
    }
    .memo-section h3 {
      font-size: 16px;
      color: #2c3e50;
      margin-bottom: 12px;
    }
    .memo-list {
      margin-bottom: 12px;
    }
    .memo-item {
      background: #f8f9fa;
      padding: 10px;
      border-radius: 4px;
      margin-bottom: 8px;
      font-size: 14px;
    }
    .memo-meta {
      font-size: 12px;
      color: #7f8c8d;
      margin-top: 4px;
    }
    .memo-input-area {
      display: flex;
      gap: 8px;
      align-items: flex-start;
    }
    .memo-input {
      flex: 1;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
    }
    .memo-photo-btn {
      width: 42px;
      height: 42px;
      border: 1px solid #ddd;
      border-radius: 4px;
      background: #f8f9fa;
      font-size: 20px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }
    .memo-photo-btn:active {
      background: #e9ecef;
    }
    .memo-photo-preview {
      margin-bottom: 8px;
      position: relative;
      display: inline-block;
    }
    .memo-photo-preview img {
      max-width: 120px;
      max-height: 120px;
      border-radius: 4px;
      border: 1px solid #ddd;
    }
    .memo-photo-preview .remove-btn {
      position: absolute;
      top: -6px;
      right: -6px;
      width: 22px;
      height: 22px;
      border-radius: 50%;
      background: #e74c3c;
      color: #fff;
      border: none;
      font-size: 14px;
      line-height: 22px;
      text-align: center;
      cursor: pointer;
    }
    .memo-photo-thumb {
      margin-top: 6px;
    }
    .memo-photo-thumb img {
      max-width: 200px;
      max-height: 150px;
      border-radius: 4px;
      border: 1px solid #ddd;
      cursor: pointer;
    }
    .memo-uploading {
      font-size: 12px;
      color: #888;
      margin-bottom: 4px;
    }

    /* æ¸…æƒå®Œäº†ã‚¨ãƒªã‚¢ */
    .complete-area {
      background: white;
      padding: 12px;
      margin: 8px 12px 16px;
      border-radius: 8px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.08);
    }
    .complete-msg {
      font-size: 13px;
      color: #e74c3c;
      margin-bottom: 8px;
      display: none;
    }
    .btn-complete {
      width: 100%;
      padding: 14px;
      border: none;
      border-radius: 6px;
      font-size: 15px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s;
      background: #27ae60;
      color: white;
    }
    .btn-complete:active {
      background: #229954;
    }

    /* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° */
    .loading {
      text-align: center;
      padding: 40px 20px;
      color: #7f8c8d;
    }

    /* å…¨ä½“æ“ä½œãƒãƒ¼ */
    .action-bar {
      display: flex;
      gap: 8px;
      margin: 12px 12px 4px;
    }
    .action-btn {
      padding: 6px 10px;
      border: 1px solid #bdc3c7;
      border-radius: 6px;
      background: white;
      font-size: 12px;
      font-weight: bold;
      color: #2c3e50;
      cursor: pointer;
      line-height: 1;
    }
    .action-btn:active { background: #ecf0f1; }
    .action-btn-check {
      border-color: #27ae60;
      color: #27ae60;
    }
    .action-btn-check.is-all-checked {
      border-color: #e74c3c;
      color: #e74c3c;
    }
    .action-btn-check:active { background: #eafaf1; }

    /* ä¿å­˜ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ */
    .save-indicator {
      position: fixed;
      top: 8px;
      right: 8px;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: bold;
      z-index: 150;
      opacity: 0;
      transition: opacity 0.3s;
      pointer-events: none;
    }
    .save-indicator.saving { background: #ffc107; color: #333; opacity: 1; }
    .save-indicator.saved { background: #27ae60; color: white; opacity: 1; }
    .save-indicator.error { background: #e74c3c; color: white; opacity: 1; }

    /* ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³æ’®å½±ç®‡æ‰€ */
    .inline-photo-spots {
      padding: 8px 12px;
      background: #fef9f0;
      border-top: 1px dashed #e67e22;
    }
    .inline-photo-add-btn {
      display: block;
      padding: 4px 10px;
      border: 1px dashed #ccc;
      border-radius: 4px;
      background: transparent;
      color: #aaa;
      font-size: 11px;
      cursor: pointer;
      margin-top: 4px;
      margin-left: auto;
      width: fit-content;
    }
    .inline-photo-add-btn:active { background: #fef5ed; }
    .inline-photo-spot {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 0;
    }
    .inline-photo-spot-name {
      font-size: 13px;
      font-weight: bold;
      color: #2c3e50;
      min-width: 40px;
      flex: 1;
    }
    .inline-photo-btn {
      padding: 4px 10px;
      border: 1px solid #3498db;
      border-radius: 4px;
      background: white;
      font-size: 11px;
      color: #3498db;
      cursor: pointer;
    }
    .inline-photo-btn.done {
      background: #d4edda;
      border-color: #27ae60;
      color: #27ae60;
    }
    .inline-photo-btn:active { background: #ebf5fb; }
    .inline-photo-btn-after {
      border-color: #e67e22;
      color: #e67e22;
    }
    .inline-photo-btn-after.done {
      background: #fef3e2;
      border-color: #27ae60;
      color: #27ae60;
    }
    .inline-photo-btn-after:active { background: #fef5ed; }
    .inline-example-btn {
      padding: 2px 6px;
      border: 1px solid #7f8c8d;
      border-radius: 4px;
      background: white;
      font-size: 11px;
      color: #7f8c8d;
      cursor: pointer;
      flex-shrink: 0;
    }
    .inline-example-btn:active { background: #ecf0f1; }
    .inline-example-thumb {
      width: 84px;
      height: 84px;
      border-radius: 6px;
      border: 1px solid #ddd;
      object-fit: cover;
      cursor: pointer;
      flex-shrink: 0;
    }

    /* æ’®å½±ç®‡æ‰€æ“ä½œãƒœã‚¿ãƒ³ */
    .inline-spot-actions {
      display: flex;
      gap: 4px;
    }
    .inline-spot-edit-btn, .inline-spot-delete-btn {
      width: 22px;
      height: 22px;
      border: none;
      background: transparent;
      font-size: 12px;
      cursor: pointer;
      padding: 0;
      line-height: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 3px;
    }
    .inline-spot-edit-btn { color: #7f8c8d; }
    .inline-spot-edit-btn:active { color: #3498db; background: #ebf5fb; }
    .inline-spot-delete-btn { color: #bdc3c7; }
    .inline-spot-delete-btn:active { color: #e74c3c; background: #fdecea; }
    .photo-delete-btn {
      position: absolute;
      top: 2px;
      right: 2px;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      border: none;
      background: rgba(231,76,60,0.8);
      color: white;
      font-size: 12px;
      line-height: 1;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .photo-thumb-wrapper {
      position: relative;
      width: 100%;
      padding-bottom: 100%;
    }

    /* ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ */
    .item-drag-handle {
      width: 20px;
      height: 28px;
      border: none;
      background: transparent;
      color: #95a5a6;
      font-size: 18px;
      cursor: grab;
      padding: 0;
      line-height: 1;
      flex-shrink: 0;
      touch-action: none;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .item-drag-handle:active { cursor: grabbing; color: #3498db; }
    .checklist-item.dragging {
      opacity: 0.4;
      background: #ebf5fb;
    }
    .checklist-item.drag-over-top {
      border-top: 3px solid #3498db;
    }
    .checklist-item.drag-over-bottom {
      border-bottom: 3px solid #3498db;
    }
    .drag-placeholder {
      height: 48px;
      background: #d4e6f1;
      border: 2px dashed #3498db;
      border-radius: 4px;
      margin: 2px 16px;
    }
    /* ã‚«ãƒ†ã‚´ãƒªä¸¦ã³æ›¿ãˆãƒãƒ³ãƒ‰ãƒ« */
    .cat-drag-handle {
      width: 20px;
      height: 28px;
      border: none;
      background: transparent;
      color: rgba(255,255,255,0.5);
      font-size: 16px;
      cursor: grab;
      padding: 0;
      line-height: 1;
      flex-shrink: 0;
      touch-action: none;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 2px;
    }
    .cat-drag-handle:active { cursor: grabbing; color: #fff; }
    /* é•·æŠ¼ã—å¾…æ©Ÿä¸­ã®ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ */
    .item-drag-handle.drag-handle-pending {
      color: #3498db;
      animation: drag-handle-pulse 0.4s ease-out forwards;
    }
    .cat-drag-handle.drag-handle-pending {
      color: #fff;
      animation: drag-handle-pulse 0.4s ease-out forwards;
    }
    @keyframes drag-handle-pulse {
      0% { transform: scale(1); }
      100% { transform: scale(1.3); }
    }
    .section.cat-dragging {
      opacity: 0.4;
    }
    .cat-drag-placeholder {
      background: #d4e6f1;
      border: 2px dashed #3498db;
      border-radius: 8px;
      margin: 4px 0;
    }
    .section-body.drag-target {
      outline: 2px dashed #e67e22;
      outline-offset: -2px;
      background: rgba(230, 126, 34, 0.06);
    }
    .section-header.cat-drop-into-target {
      outline: 3px dashed #e67e22;
      outline-offset: -3px;
      background: rgba(230, 126, 34, 0.15) !important;
    }
    .root-drop-zone {
      background: rgba(39, 174, 96, 0.1);
      border: 2px dashed #27ae60;
      border-radius: 8px;
      padding: 12px;
      text-align: center;
      color: #27ae60;
      font-weight: bold;
      font-size: 14px;
      margin-bottom: 8px;
      transition: background 0.2s;
    }
    .root-drop-zone.active {
      background: rgba(39, 174, 96, 0.25);
      border-color: #1e8449;
    }
    .item-photo-thumb {
      width: 28px;
      height: 28px;
      border-radius: 4px;
      object-fit: cover;
      cursor: pointer;
      flex-shrink: 0;
      border: 1px solid #ddd;
    }
    .item-photo-thumb:active { opacity: 0.7; }
    .item-edit-btn {
      width: 24px;
      height: 24px;
      border: none;
      background: transparent;
      color: #bdc3c7;
      font-size: 14px;
      cursor: pointer;
      padding: 0;
      line-height: 1;
      flex-shrink: 0;
    }
    .item-edit-btn:active { color: #3498db; }
    .item-delete-btn {
      width: 24px;
      height: 24px;
      border: none;
      background: transparent;
      color: #bdc3c7;
      font-size: 14px;
      cursor: pointer;
      padding: 0;
      line-height: 1;
      flex-shrink: 0;
    }
    .item-delete-btn:active { color: #e74c3c; }
    .item-edit-input {
      width: 100%;
      padding: 6px 8px;
      border: 2px solid #3498db;
      border-radius: 4px;
      font-size: 14px;
      outline: none;
    }
    .item-edit-actions {
      display: flex;
      gap: 4px;
      margin-top: 4px;
    }
    .item-edit-actions button {
      padding: 4px 10px;
      border: none;
      border-radius: 4px;
      font-size: 12px;
      cursor: pointer;
    }
    .item-edit-save { background: #3498db; color: white; }
    .item-edit-cancel { background: #ecf0f1; color: #333; }
    .section-add-btn {
      display: block;
      padding: 4px 10px;
      border: 1px dashed #ccc;
      border-radius: 4px;
      background: transparent;
      color: #aaa;
      font-size: 11px;
      cursor: pointer;
      margin: 4px 16px 4px auto;
      text-align: center;
      width: fit-content;
    }
    .section-add-btn:active { background: #ecf0f1; color: #3498db; }
    .category-add-btn {
      display: block;
      padding: 6px 12px;
      border: 1px dashed #ccc;
      border-radius: 4px;
      background: transparent;
      color: #aaa;
      font-size: 12px;
      cursor: pointer;
      margin: 6px 12px 6px auto;
      text-align: center;
      width: fit-content;
    }
    .category-add-btn:active { background: #ecf0f1; color: #3498db; }

    /* ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ */
    .hidden { display: none !important; }

    input[type="file"] {
      display: none;
    }

    /* ã‚«ãƒ†ã‚´ãƒªæ’®å½±ãƒ¢ãƒ¼ãƒ€ãƒ« */
    .photo-modal-overlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 200;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    .photo-modal {
      background: white;
      border-radius: 12px;
      width: 100%;
      max-width: 400px;
      max-height: 80vh;
      overflow-y: auto;
      padding: 20px;
    }
    .photo-modal h3 {
      font-size: 16px;
      margin-bottom: 16px;
      color: #2c3e50;
    }
    .photo-modal-close {
      padding: 10px;
      width: 100%;
      border: 1px solid #bdc3c7;
      border-radius: 6px;
      background: white;
      font-size: 14px;
      cursor: pointer;
      margin-top: 12px;
    }
    /* UNDO ãƒˆãƒ¼ã‚¹ãƒˆ */
    #undoToast {
      position: fixed;
      bottom: 24px;
      left: 50%;
      transform: translateX(-50%);
      background: #323232;
      color: #fff;
      padding: 10px 16px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      gap: 12px;
      box-shadow: 0 3px 10px rgba(0,0,0,0.3);
      z-index: 10000;
      font-size: 14px;
      animation: undoSlideUp 0.25s ease-out;
    }
    #undoToast.fade-out {
      opacity: 0;
      transition: opacity 0.3s;
    }
    #undoToast button {
      background: none;
      border: none;
      color: #4fc3f7;
      font-weight: bold;
      font-size: 14px;
      cursor: pointer;
      padding: 4px 8px;
      border-radius: 4px;
    }
    #undoToast button:active {
      background: rgba(255,255,255,0.1);
    }
    @keyframes undoSlideUp {
      from { transform: translateX(-50%) translateY(20px); opacity: 0; }
      to { transform: translateX(-50%) translateY(0); opacity: 1; }
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="header-top">
      <div class="header-title">æ¸…æƒãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ</div>
      <div class="header-date" id="headerDate"></div>
    </div>
    <div class="progress-bar">
      <div class="progress-fill" id="progressFill" style="width: 0%"></div>
    </div>
  </div>

  <!-- ã‚¿ãƒ–ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆãƒ˜ãƒƒãƒ€ãƒ¼ç›´ä¸‹ï¼‰ -->
  <div class="tab-nav" id="tabNav">
    <button class="tab-nav-btn active" data-tab="checklist" onclick="switchTab('checklist')">ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ</button>
    <button class="tab-nav-btn" data-tab="photo" onclick="switchTab('photo')">æ’®å½±</button>
    <button class="tab-nav-btn" data-tab="supply" onclick="switchTab('supply')">è¦è£œå……<span id="supplyBadge" class="tab-badge tab-badge-warning hidden">0</span></button>
    <button class="tab-nav-btn" data-tab="clSettings" onclick="switchTab('clSettings')" style="display:none;">è¨­å®š</button>
  </div>

  <div id="loadingArea" class="loading">èª­ã¿è¾¼ã¿ä¸­...</div>

  <div id="contentArea" class="hidden">
    <!-- æ¬¡å›äºˆç´„æƒ…å ± -->
    <div id="bookingInfo" class="booking-info hidden"></div>

    <!-- ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆã‚¿ãƒ– -->
    <div id="tabChecklist" class="tab-content active">
      <!-- æ‹…å½“ã‚¹ã‚¿ãƒƒãƒ•é¸æŠ -->
      <div class="staff-selector" id="staffSelector">
        <div class="staff-selector-label" id="staffSelectorLabel">æ‹…å½“ã‚¹ã‚¿ãƒƒãƒ•</div>
        <div class="staff-row">
          <select class="staff-select" id="staffSelect0"></select>
          <button class="staff-add-btn" onclick="addStaffRow()" title="ã‚¹ã‚¿ãƒƒãƒ•è¿½åŠ ">+</button>
        </div>
      </div>

      <!-- å…¨ä½“æ“ä½œãƒãƒ¼ -->
      <div class="action-bar">
        <button id="btnExpandAll" class="action-btn" onclick="toggleAllSections()" title="å…¨ã¦å±•é–‹">å…¨å±•é–‹</button>
        <button id="btnCheckAll" class="action-btn action-btn-check" onclick="checkAllItems()" title="å…¨ãƒã‚§ãƒƒã‚¯">å…¨âœ“</button>
      </div>

      <!-- ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ -->
      <div id="checklistContainer"></div>

      <!-- ãƒ¡ãƒ¢ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
      <div id="memoSection" class="memo-section">
        <h3>ğŸ“ ç‰¹è¨˜äº‹é …ãƒ»å‚™å“ä¸è¶³ãªã©</h3>
        <div id="memoList" class="memo-list"></div>
        <div id="memoPhotoPreview"></div>
        <div id="memoUploading" class="memo-uploading" style="display:none;">å†™çœŸã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­...</div>
        <div class="memo-input-area">
          <input type="text" id="memoInput" class="memo-input" placeholder="ã‚³ãƒ¡ãƒ³ãƒˆã‚’å…¥åŠ›...ï¼ˆå†™çœŸã‚‚æ·»ä»˜å¯ï¼‰">
          <button class="memo-photo-btn" onclick="openMemoPhotoUpload()" title="å†™çœŸã‚’æ·»ä»˜">ğŸ“·</button>
        </div>
      </div>

      <!-- æ¸…æƒå®Œäº†ã‚¨ãƒªã‚¢ï¼ˆæ¼ã‚Œãƒã‚§ãƒƒã‚¯çµ±åˆï¼‰ -->
      <div class="complete-area">
        <div id="completeMsg" class="complete-msg"></div>
        <button id="btnComplete" class="btn-complete" onclick="completeChecklist()">æ¸…æƒå®Œäº†</button>
      </div>
    </div>

    <!-- è¦è£œå……ã‚¿ãƒ– -->
    <div id="tabSupply" class="tab-content">
      <div class="supply-tab-content">
        <div id="supplyListContent"></div>
      </div>
    </div>

    <!-- æ’®å½±ã‚¿ãƒ– -->
    <div id="tabPhoto" class="tab-content">
      <div id="photoSection"></div>
    </div>

    <!-- è¨­å®šã‚¿ãƒ–ï¼ˆã‚ªãƒ¼ãƒŠãƒ¼ã®ã¿è¡¨ç¤ºï¼‰ -->
    <div id="tabClSettings" class="tab-content">
      <div style="padding:16px;">
        <h3 style="font-size:16px;margin-bottom:16px;color:#2c3e50;">ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆè¨­å®š</h3>

        <!-- å†™çœŸä¿å­˜ãƒ•ã‚©ãƒ«ãƒ€è¨­å®š -->
        <div style="background:#fff;border-radius:8px;padding:16px;border:1px solid #ddd;margin-bottom:16px;">
          <h4 style="font-size:14px;margin-bottom:8px;">å†™çœŸä¿å­˜ãƒ•ã‚©ãƒ«ãƒ€ï¼ˆGoogleãƒ‰ãƒ©ã‚¤ãƒ–ï¼‰</h4>
          <p style="font-size:12px;color:#666;margin-bottom:12px;">å„å†™çœŸã®ä¿å­˜å…ˆãƒ•ã‚©ãƒ«ãƒ€URLã¾ãŸã¯ãƒ•ã‚©ãƒ«ãƒ€IDã‚’æŒ‡å®šã€‚ç©ºæ¬„ã®å ´åˆã¯è‡ªå‹•ä½œæˆã•ã‚Œã¾ã™ã€‚</p>

          <div style="margin-bottom:10px;">
            <label style="font-size:12px;font-weight:bold;color:#555;">ãƒ“ãƒ•ã‚©ãƒ¼å†™çœŸãƒ•ã‚©ãƒ«ãƒ€</label>
            <div style="display:flex;gap:6px;margin-top:4px;">
              <input type="text" id="folderBeforeInput" placeholder="ãƒ•ã‚©ãƒ«ãƒ€URL or IDï¼ˆç©ºæ¬„=è‡ªå‹•ï¼‰" style="flex:1;padding:6px 8px;border:1px solid #ddd;border-radius:4px;font-size:13px;">
              <button onclick="saveSubFolder('before')" style="padding:6px 12px;background:#3498db;color:#fff;border:none;border-radius:4px;font-size:12px;white-space:nowrap;">ä¿å­˜</button>
            </div>
          </div>

          <div style="margin-bottom:10px;">
            <label style="font-size:12px;font-weight:bold;color:#555;">ã‚¢ãƒ•ã‚¿ãƒ¼å†™çœŸãƒ•ã‚©ãƒ«ãƒ€</label>
            <div style="display:flex;gap:6px;margin-top:4px;">
              <input type="text" id="folderAfterInput" placeholder="ãƒ•ã‚©ãƒ«ãƒ€URL or IDï¼ˆç©ºæ¬„=è‡ªå‹•ï¼‰" style="flex:1;padding:6px 8px;border:1px solid #ddd;border-radius:4px;font-size:13px;">
              <button onclick="saveSubFolder('after')" style="padding:6px 12px;background:#e67e22;color:#fff;border:none;border-radius:4px;font-size:12px;white-space:nowrap;">ä¿å­˜</button>
            </div>
          </div>

          <div style="margin-bottom:4px;">
            <label style="font-size:12px;font-weight:bold;color:#555;">è¦‹æœ¬å†™çœŸãƒ•ã‚©ãƒ«ãƒ€</label>
            <div style="display:flex;gap:6px;margin-top:4px;">
              <input type="text" id="folderExampleInput" placeholder="ãƒ•ã‚©ãƒ«ãƒ€URL or IDï¼ˆç©ºæ¬„=è‡ªå‹•ï¼‰" style="flex:1;padding:6px 8px;border:1px solid #ddd;border-radius:4px;font-size:13px;">
              <button onclick="saveSubFolder('example')" style="padding:6px 12px;background:#9b59b6;color:#fff;border:none;border-radius:4px;font-size:12px;white-space:nowrap;">ä¿å­˜</button>
            </div>
          </div>
          <div id="folderSaveResult" style="display:none;margin-top:8px;font-size:12px;"></div>
        </div>

        <!-- åˆæœŸãƒ‡ãƒ¼ã‚¿å†ã‚¤ãƒ³ãƒãƒ¼ãƒˆ -->
        <div style="background:#fff;border-radius:8px;padding:16px;border:1px solid #ddd;margin-bottom:16px;">
          <h4 style="font-size:14px;margin-bottom:8px;">åˆæœŸãƒ‡ãƒ¼ã‚¿å†ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</h4>
          <p style="font-size:12px;color:#666;margin-bottom:12px;">ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆé …ç›®ã¨æ’®å½±ç®‡æ‰€ã‚’åˆæœŸçŠ¶æ…‹ã«æˆ»ã—ã¾ã™ã€‚æ—¢å­˜ã®ãƒã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿ãŒä¸Šæ›¸ãã•ã‚Œã¾ã™ã€‚</p>
          <button id="btnReimportCL" style="padding:10px 20px;background:#e74c3c;color:#fff;border:none;border-radius:6px;font-size:14px;cursor:pointer;width:100%;">åˆæœŸãƒ‡ãƒ¼ã‚¿ã‚’å†ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
          <div id="reimportResult" style="display:none;margin-top:8px;font-size:13px;"></div>
        </div>
      </div>
    </div>
  </div>


  <!-- ä¿å­˜ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ -->
  <div class="save-indicator" id="saveIndicator"></div>

  <!-- éè¡¨ç¤ºã®ãƒ•ã‚¡ã‚¤ãƒ«å…¥åŠ› -->
  <input type="file" id="photoInput" accept="image/*" capture="environment">
  <input type="file" id="examplePhotoInput" accept="image/*">
  <input type="file" id="itemPhotoInput" accept="image/*">
  <input type="file" id="memoPhotoInput" accept="image/*" capture="environment">

  <script>
    // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
    var checkoutDate = '<?= checkoutDate ?>' || '';
    var staffName = '<?= staffName ?>' || '';
    var checklistData = null;
    // ãƒ­ãƒ¼ã‚«ãƒ«ã§è¦è£œå……ã‚’å¤–ã—ãŸé …ç›®ã‚’è¿½è·¡ï¼ˆãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥æ™‚ã®å¾©æ´»ã‚’é˜²æ­¢ï¼‰
    var localSupplyRemoved = {};
    var bookingData = null;
    var staffList = [];
    var staffRowCount = 1;
    var saveIndicatorTimer = null;
    // ãƒ¡ãƒ¢å†™çœŸç”¨
    var pendingMemoPhotoFileId = null;
    var pendingMemoPhotoDataUrl = null;

    // ä¿å­˜ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼
    function showSaveStatus(status) {
      var el = document.getElementById('saveIndicator');
      if (!el) return;
      el.className = 'save-indicator ' + status;
      el.textContent = status === 'saving' ? 'ä¿å­˜ä¸­...' : status === 'saved' ? 'âœ“ ä¿å­˜æ¸ˆã¿' : 'âœ• ä¿å­˜å¤±æ•—';
      if (saveIndicatorTimer) clearTimeout(saveIndicatorTimer);
      if (status !== 'saving') {
        saveIndicatorTimer = setTimeout(function() { el.className = 'save-indicator'; }, 2000);
      }
    }

    // åˆæœŸåŒ–
    window.onload = function() {
      if (!checkoutDate) {
        alert('ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆæ—¥ãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“');
        return;
      }
      // æ—¥ä»˜è¡¨ç¤ºã‚’ "2026/2/17" å½¢å¼ã«
      var dp = checkoutDate.split('-');
      document.getElementById('headerDate').textContent = dp.length === 3 ? (parseInt(dp[0]) + '/' + parseInt(dp[1]) + '/' + parseInt(dp[2])) : checkoutDate;
      loadData();
      loadStaffList();

      // å®šæœŸãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ï¼ˆ60ç§’ã”ã¨ã€2äººåŒæ™‚åˆ©ç”¨å¯¾å¿œï¼‰
      // æŠ˜ã‚ŠãŸãŸã¿çŠ¶æ…‹ã¨ã‚¿ãƒ–çŠ¶æ…‹ã‚’ä¿æŒã—ã¦ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥
      // ä»–ã®GASå‘¼ã³å‡ºã—ä¸­ã¯ã‚¹ã‚­ãƒƒãƒ—ã—ã¦ç«¶åˆã‚’å›é¿
      setInterval(function() {
        if (!checklistData) return;
        if (gasRunning > 0) return;
        callGAS('getChecklistForDate', [checkoutDate]).then(function(res) {
          if (res.success) {
            // ç¾åœ¨ã®æŠ˜ã‚ŠãŸãŸã¿çŠ¶æ…‹ã‚’ä¿å­˜
            var collapseState = saveCollapseState();
            var activeTab = getActiveTab();
            // ãƒ­ãƒ¼ã‚«ãƒ«ã§è¦è£œå……ã‚’å¤–ã—ãŸé …ç›®ã‚’ã‚µãƒ¼ãƒãƒ¼ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰é™¤å¤–ï¼ˆå¾©æ´»é˜²æ­¢ï¼‰
            if (res.supplyNeeded) {
              Object.keys(localSupplyRemoved).forEach(function(removedId) {
                delete res.supplyNeeded[removedId];
              });
            }
            checklistData = res;
            renderChecklist();
            renderPhotoSection();
            renderSupplyList();
            updateProgress();
            updateCheckAllButton();
            // æŠ˜ã‚ŠãŸãŸã¿çŠ¶æ…‹ã¨ã‚¿ãƒ–ã‚’å¾©å…ƒ
            restoreCollapseState(collapseState);
            if (activeTab) switchTab(activeTab);
          }
        }).catch(function() {});
      }, 60000);

      // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
      document.getElementById('photoInput').addEventListener('change', handlePhotoUpload);
      document.getElementById('memoPhotoInput').addEventListener('change', handleMemoPhotoSelect);
      document.getElementById('staffSelect0').addEventListener('change', function() { updateStaffLabel(); updateSettingsTabVisibility(); });

      // é …ç›®åã‚¿ãƒƒãƒã§ãƒã‚§ãƒƒã‚¯åˆ‡æ›¿ï¼ˆã‚¤ãƒ™ãƒ³ãƒˆå§”è­²ï¼‰
      document.getElementById('checklistContainer').addEventListener('click', function(e) {
        var nameEl = e.target.closest('.item-name');
        if (!nameEl) return;
        var itemEl = nameEl.closest('.checklist-item');
        if (!itemEl) return;
        var checkbox = itemEl.querySelector('.item-checkbox');
        if (checkbox) {
          checkbox.checked = !checkbox.checked;
          toggleItem(checkbox);
        }
      });

      // ãƒ¡ãƒ¢è‡ªå‹•ä¿å­˜ï¼ˆãƒ‡ãƒã‚¦ãƒ³ã‚¹ï¼‰- å†™çœŸæ·»ä»˜æ™‚ã¯ãƒ†ã‚­ã‚¹ãƒˆç©ºã§ã‚‚OK
      var memoTimer = null;
      document.getElementById('memoInput').addEventListener('input', function() {
        var input = this;
        if (memoTimer) clearTimeout(memoTimer);
        memoTimer = setTimeout(function() {
          var text = input.value.trim();
          if (!text && !pendingMemoPhotoFileId) return;
          addMemo();
        }, 1500);
      });
      document.getElementById('memoInput').addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
          if (memoTimer) clearTimeout(memoTimer);
          addMemo();
        }
      });
      document.getElementById('btnReimportCL').addEventListener('click', function() {
        if (!confirm('ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆé …ç›®ã¨æ’®å½±ç®‡æ‰€ã‚’åˆæœŸçŠ¶æ…‹ã«æˆ»ã—ã¾ã™ã€‚\næ—¢å­˜ã®ãƒã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿ãŒä¸Šæ›¸ãã•ã‚Œã¾ã™ã€‚\n\nã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) return;
        var btn = this;
        var resEl = document.getElementById('reimportResult');
        btn.disabled = true;
        btn.textContent = 'ã‚¤ãƒ³ãƒãƒ¼ãƒˆä¸­...';
        resEl.style.display = 'block';
        resEl.textContent = 'å‡¦ç†ä¸­...';
        resEl.style.color = '#666';
        callGAS('importDefaultChecklist', []).then(function(res) {
          if (res.success) {
            resEl.textContent = 'å®Œäº†: ' + (res.itemCount || 0) + 'ä»¶ã®é …ç›®ã€' + (res.spotCount || 0) + 'ä»¶ã®æ’®å½±ç®‡æ‰€ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã—ãŸã€‚';
            resEl.style.color = '#27ae60';
            // ãƒ‡ãƒ¼ã‚¿ã‚’å†èª­ã¿è¾¼ã¿
            callGAS('getChecklistForDate', [checkoutDate]).then(function(clRes) {
              if (clRes.success) {
                checklistData = clRes;
                renderChecklist();
                renderPhotoSection();
                renderSupplyList();
                updateProgress();
                updateCheckAllButton();
              }
            });
          } else {
            resEl.textContent = 'ã‚¨ãƒ©ãƒ¼: ' + (res.error || 'ä¸æ˜');
            resEl.style.color = '#e74c3c';
          }
          btn.disabled = false;
          btn.textContent = 'åˆæœŸãƒ‡ãƒ¼ã‚¿ã‚’å†ã‚¤ãƒ³ãƒãƒ¼ãƒˆ';
        }).catch(function(e) {
          resEl.textContent = 'ã‚¨ãƒ©ãƒ¼: ' + (e.message || 'é€šä¿¡å¤±æ•—');
          resEl.style.color = '#e74c3c';
          btn.disabled = false;
          btn.textContent = 'åˆæœŸãƒ‡ãƒ¼ã‚¿ã‚’å†ã‚¤ãƒ³ãƒãƒ¼ãƒˆ';
        });
      });
    };

    // === ã‚¹ã‚¿ãƒƒãƒ•é¸æŠ ===
    function loadStaffList() {
      callGAS('getCleaningStaffList', []).then(function(res) {
        if (res.success && res.list) {
          staffList = res.list;
          populateStaffSelects();
        }
      }).catch(function() {});
    }

    function populateStaffSelects() {
      var selects = document.querySelectorAll('.staff-select');
      selects.forEach(function(sel) {
        var currentVal = sel.value;
        sel.innerHTML = '<option value="">æ‹…å½“ã‚¹ã‚¿ãƒƒãƒ•ã‚’é¸æŠ</option>';
        staffList.forEach(function(name) {
          if (name === 'ã‚ªãƒ¼ãƒŠãƒ¼') return; // æœ€å¾Œã«è¿½åŠ ã™ã‚‹ã®ã§ã‚¹ã‚­ãƒƒãƒ—
          var opt = document.createElement('option');
          opt.value = name;
          opt.textContent = name;
          sel.appendChild(opt);
        });
        // ã€Œã‚ªãƒ¼ãƒŠãƒ¼ã€ã‚’å¸¸ã«æœ€å¾Œã«è¡¨ç¤º
        var ownerOpt = document.createElement('option');
        ownerOpt.value = 'ã‚ªãƒ¼ãƒŠãƒ¼';
        ownerOpt.textContent = 'ã‚ªãƒ¼ãƒŠãƒ¼';
        sel.appendChild(ownerOpt);
        // åˆæœŸé¸æŠ: URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®staffNameã«ä¸€è‡´ã™ã‚‹ã‚‚ã®ãŒã‚ã‚Œã°é¸æŠ
        if (!currentVal && staffName) {
          sel.value = staffName;
        } else if (currentVal) {
          sel.value = currentVal;
        }
      });
      // ãƒ©ãƒ™ãƒ«ã®è¡¨ç¤ºåˆ¶å¾¡: æœªé¸æŠæ™‚ã®ã¿è¡¨ç¤º
      updateStaffLabel();
      // è¨­å®šã‚¿ãƒ–ã®è¡¨ç¤ºåˆ¶å¾¡: ã‚ªãƒ¼ãƒŠãƒ¼é¸æŠæ™‚ã®ã¿è¡¨ç¤º
      updateSettingsTabVisibility();
    }

    function updateStaffLabel() {
      var label = document.getElementById('staffSelectorLabel');
      var firstSelect = document.getElementById('staffSelect0');
      if (label && firstSelect) {
        label.style.display = firstSelect.value ? 'none' : '';
      }
    }

    function updateSettingsTabVisibility() {
      var firstSelect = document.getElementById('staffSelect0');
      var isOwner = firstSelect && firstSelect.value === 'ã‚ªãƒ¼ãƒŠãƒ¼';
      var settingsBtn = document.querySelector('.tab-nav-btn[data-tab="clSettings"]');
      if (settingsBtn) settingsBtn.style.display = isOwner ? '' : 'none';
      // ã‚ªãƒ¼ãƒŠãƒ¼ã§ãªã„å ´åˆã«è¨­å®šã‚¿ãƒ–ãŒè¡¨ç¤ºä¸­ãªã‚‰åˆ‡ã‚Šæ›¿ãˆ
      if (!isOwner) {
        var settingsTab = document.getElementById('tabClSettings');
        if (settingsTab && settingsTab.classList.contains('active')) {
          switchTab('checklist');
        }
      }
    }

    function addStaffRow() {
      var container = document.getElementById('staffSelector');
      var idx = staffRowCount;
      staffRowCount++;
      var row = document.createElement('div');
      row.className = 'staff-row';
      row.id = 'staffRow' + idx;
      row.innerHTML = '<select class="staff-select" id="staffSelect' + idx + '"></select>' +
        '<button class="staff-remove-btn" onclick="removeStaffRow(' + idx + ')" title="å‰Šé™¤">âœ•</button>';
      container.appendChild(row);
      populateStaffSelects();
    }

    function removeStaffRow(idx) {
      var row = document.getElementById('staffRow' + idx);
      if (row) row.remove();
    }

    function getSelectedStaffNames() {
      var names = [];
      document.querySelectorAll('.staff-select').forEach(function(sel) {
        var v = sel.value.trim();
        if (v && names.indexOf(v) === -1) names.push(v);
      });
      return names;
    }

    // === ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ ===
    function switchTab(tabName) {
      document.querySelectorAll('.tab-nav-btn').forEach(function(btn) {
        btn.classList.toggle('active', btn.getAttribute('data-tab') === tabName);
      });
      document.querySelectorAll('.tab-content').forEach(function(tc) {
        tc.classList.remove('active');
      });
      var target = document.getElementById('tab' + tabName.charAt(0).toUpperCase() + tabName.slice(1));
      if (target) target.classList.add('active');
      if (tabName === 'clSettings') loadFolderSettings();
    }

    // ãƒ•ã‚©ãƒ«ãƒ€è¨­å®šã®èª­ã¿è¾¼ã¿
    function loadFolderSettings() {
      callGAS('getPhotoFolderSettings', []).then(function(res) {
        if (res.success) {
          var bi = document.getElementById('folderBeforeInput');
          var ai = document.getElementById('folderAfterInput');
          var ei = document.getElementById('folderExampleInput');
          if (bi && res.beforeId) bi.value = 'https://drive.google.com/drive/folders/' + res.beforeId;
          if (ai && res.afterId) ai.value = 'https://drive.google.com/drive/folders/' + res.afterId;
          if (ei && res.exampleId) ei.value = 'https://drive.google.com/drive/folders/' + res.exampleId;
        }
      });
    }

    // ãƒ•ã‚©ãƒ«ãƒ€ä¿å­˜
    function saveSubFolder(type) {
      var inputMap = { 'before': 'folderBeforeInput', 'after': 'folderAfterInput', 'example': 'folderExampleInput' };
      var input = document.getElementById(inputMap[type]);
      if (!input) return;
      var val = input.value.trim();
      // URLã‹ã‚‰ãƒ•ã‚©ãƒ«ãƒ€IDã‚’æŠ½å‡º
      var folderId = val;
      var match = val.match(/folders\/([a-zA-Z0-9_-]+)/);
      if (match) folderId = match[1];
      var resEl = document.getElementById('folderSaveResult');
      resEl.textContent = 'ä¿å­˜ä¸­...';
      resEl.style.color = '#666';
      resEl.style.display = 'block';
      callGAS('setPhotoSubFolderId', [type, folderId]).then(function(res) {
        if (res.success) {
          resEl.textContent = 'ä¿å­˜ã—ã¾ã—ãŸ';
          resEl.style.color = '#27ae60';
        } else {
          resEl.textContent = res.error || 'ä¿å­˜å¤±æ•—';
          resEl.style.color = '#e74c3c';
        }
        setTimeout(function() { resEl.style.display = 'none'; }, 3000);
      }).catch(function() {
        resEl.textContent = 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ';
        resEl.style.color = '#e74c3c';
      });
    }

    // === æŠ˜ã‚ŠãŸãŸã¿çŠ¶æ…‹ã®ä¿å­˜ãƒ»å¾©å…ƒ ===
    function getActiveTab() {
      var active = document.querySelector('.tab-nav-btn.active');
      return active ? active.getAttribute('data-tab') : 'checklist';
    }

    function saveCollapseState() {
      var state = {};
      document.querySelectorAll('#checklistContainer .section').forEach(function(section) {
        var cat = section.getAttribute('data-category');
        if (cat) {
          var header = section.querySelector('.section-header');
          state[cat] = header ? header.classList.contains('collapsed') : true;
        }
      });
      return state;
    }

    function restoreCollapseState(state) {
      document.querySelectorAll('#checklistContainer .section').forEach(function(section) {
        var cat = section.getAttribute('data-category');
        if (cat && state.hasOwnProperty(cat)) {
          var header = section.querySelector('.section-header');
          var body = section.querySelector('.section-body');
          if (header && body) {
            if (state[cat]) {
              header.classList.add('collapsed');
              body.classList.add('collapsed');
            } else {
              header.classList.remove('collapsed');
              body.classList.remove('collapsed');
            }
          }
        }
      });
    }

    // === çŠ¶æ…‹ã‚’ä¿æŒã—ãŸã¾ã¾å†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚° ===
    function reRenderWithState() {
      try {
        var collapseState = saveCollapseState();
        var activeTab = getActiveTab();
        var scrollY = window.scrollY;
        renderChecklist();
        renderPhotoSection();
        renderSupplyList();
        updateProgress();
        updateCheckAllButton();
        restoreCollapseState(collapseState);
        if (activeTab) switchTab(activeTab);
        window.scrollTo(0, scrollY);
      } catch (e) {
        console.error('reRenderWithState error:', e);
      }
    }

    // === ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ ===
    function loadData() {
      Promise.all([
        callGAS('getNextBookingDetails', [checkoutDate]),
        callGAS('getChecklistForDate', [checkoutDate])
      ]).then(function(results) {
        var bookingRes = results[0];
        var checklistRes = results[1];

        if (bookingRes.success) {
          bookingData = bookingRes.booking;
          renderBookingInfo();
        }

        if (checklistRes.success) {
          checklistData = checklistRes;
          if (checklistRes.items.length === 0 && checklistRes.totalRows > 0) {
            console.warn('ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ: ã‚·ãƒ¼ãƒˆã«' + checklistRes.totalRows + 'è¡Œã‚ã‚‹ãŒè¡¨ç¤ºå¯èƒ½ãªé …ç›®ãŒ0ä»¶');
          }
          try {
            renderChecklist();
            renderPhotoSection();
            renderMemos();
            renderSupplyList();
            updateProgress();
          } catch (e) {
            console.error('åˆæœŸãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã‚¨ãƒ©ãƒ¼:', e);
          }
        } else {
          alert('ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + checklistRes.error);
        }

        document.getElementById('loadingArea').classList.add('hidden');
        document.getElementById('contentArea').classList.remove('hidden');
      }).catch(function(err) {
        alert('ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + err);
      });
    }

    function renderBookingInfo() {
      if (!bookingData) return;
      var html = '<h3>ğŸ“… æ¬¡å›äºˆç´„è©³ç´°</h3>';
      html += '<div class="booking-row"><span class="booking-label">ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³</span><span class="booking-value">' + escapeHtml(bookingData.checkIn) + '</span></div>';
      html += '<div class="booking-row"><span class="booking-label">ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ</span><span class="booking-value">' + escapeHtml(bookingData.checkOut) + '</span></div>';
      if (bookingData.guestName) html += '<div class="booking-row"><span class="booking-label">å®¿æ³Šè€…å</span><span class="booking-value">' + escapeHtml(bookingData.guestName) + '</span></div>';
      if (bookingData.guestCount) html += '<div class="booking-row"><span class="booking-label">äººæ•°</span><span class="booking-value">' + escapeHtml(bookingData.guestCount) + 'å</span></div>';
      if (bookingData.bookingSite) html += '<div class="booking-row"><span class="booking-label">äºˆç´„ã‚µã‚¤ãƒˆ</span><span class="booking-value">' + escapeHtml(bookingData.bookingSite) + '</span></div>';
      if (bookingData.bbq) html += '<div class="booking-row"><span class="booking-label">BBQåˆ©ç”¨</span><span class="booking-value">' + escapeHtml(bookingData.bbq) + '</span></div>';
      if (bookingData.linen) html += '<div class="booking-row"><span class="booking-label">ãƒªãƒãƒ³</span><span class="booking-value">' + escapeHtml(bookingData.linen) + '</span></div>';
      if (bookingData.bed) html += '<div class="booking-row"><span class="booking-label">ãƒ™ãƒƒãƒ‰</span><span class="booking-value">' + escapeHtml(bookingData.bed) + '</span></div>';

      document.getElementById('bookingInfo').innerHTML = html;
      document.getElementById('bookingInfo').classList.remove('hidden');
    }

    // === ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ ===
    function renderChecklistItem(item, checked, supplyNeeded) {
      var isChecked = !!checked[item.id];
      var isSupplyNeeded = !!supplyNeeded[item.id];
      var html = '<div class="checklist-item" data-item-id="' + escapeHtml(item.id) + '" data-sort-order="' + item.sortOrder + '">';
      html += '<button class="item-drag-handle" title="ä¸¦ã³æ›¿ãˆ">â˜°</button>';
      html += '<input type="checkbox" class="item-checkbox" data-item-id="' + escapeHtml(item.id) + '" ' + (isChecked ? 'checked' : '') + ' onchange="toggleItem(this)">';
      html += '<div class="item-content">';
      html += '<div class="item-name" id="itemName_' + escapeHtml(item.id) + '">' + escapeHtml(item.name) + '</div>';
      if (item.memo) {
        html += '<div class="item-memo">' + escapeHtml(item.memo) + '</div>';
      }
      if (item.supplyItem) {
        html += '<div class="supply-checkbox-container">';
        html += '<input type="checkbox" class="supply-checkbox" data-item-id="' + escapeHtml(item.id) + '" data-item-name="' + escapeHtml(item.name) + '" data-item-category="' + escapeHtml(item.category || '') + '" ' + (isSupplyNeeded ? 'checked' : '') + ' onchange="toggleSupply(this)">';
        html += '<label>è¦è£œå……</label>';
        html += '</div>';
      }
      html += '</div>';
      if (item.exampleFileId) {
        html += '<img class="item-photo-thumb" src="https://drive.google.com/thumbnail?id=' + item.exampleFileId + '&sz=w56" onclick="showItemExamplePhoto(\'' + escapeHtml(item.id) + '\', \'' + item.exampleFileId + '\')" alt="è¦‹æœ¬">';
      }
      html += '<button class="item-edit-btn" onclick="editItem(\'' + escapeHtml(item.id) + '\', this)" title="ç·¨é›†">âœ</button>';
      html += '<button class="item-delete-btn" onclick="deleteItemPrompt(\'' + escapeHtml(item.id) + '\', \'' + escapeHtml(item.name).replace(/'/g, "\\'") + '\')" title="å‰Šé™¤">âœ•</button>';
      html += '</div>';
      return html;
    }

    // === ãƒ„ãƒªãƒ¼æ§‹é€ ã§ã‚«ãƒ†ã‚´ãƒªã‚’ç®¡ç†ï¼ˆ4éšå±¤å¯¾å¿œï¼‰ ===
    function buildCategoryTree(items, categoryOrder) {
      var tree = { children: {}, childOrder: [], items: [] };
      items.forEach(function(item) {
        var parts = (item.category || 'ãã®ä»–').split('ï¼š');
        var node = tree;
        for (var i = 0; i < parts.length; i++) {
          if (!parts[i]) continue;
          if (!node.children[parts[i]]) {
            node.children[parts[i]] = { children: {}, childOrder: [], items: [] };
            node.childOrder.push(parts[i]);
          }
          node = node.children[parts[i]];
        }
        node.items.push(item);
      });
      // ã‚«ãƒ†ã‚´ãƒªé †åºã‚’é©ç”¨
      if (categoryOrder && categoryOrder.length > 0) {
        applyCategoryOrder(tree, '', categoryOrder);
      }
      return tree;
    }

    function applyCategoryOrder(node, parentPath, categoryOrder) {
      if (node.childOrder.length <= 1) {
        // å­ãŒ1ã¤ä»¥ä¸‹ãªã‚‰ä¸¦ã³æ›¿ãˆä¸è¦ã€å†å¸°ã®ã¿
        node.childOrder.forEach(function(childName) {
          var childPath = parentPath ? (parentPath + 'ï¼š' + childName) : childName;
          applyCategoryOrder(node.children[childName], childPath, categoryOrder);
        });
        return;
      }
      // ä¿å­˜æ¸ˆã¿é †åºã‚’ãƒãƒƒãƒ—åŒ–
      var orderMap = {};
      categoryOrder.forEach(function(o) { orderMap[o.path] = o.sortOrder; });
      // å­ã‚«ãƒ†ã‚´ãƒªã®ãƒ•ãƒ«ãƒ‘ã‚¹ã«åŸºã¥ã„ã¦ã‚½ãƒ¼ãƒˆ
      node.childOrder.sort(function(a, b) {
        var pathA = parentPath ? (parentPath + 'ï¼š' + a) : a;
        var pathB = parentPath ? (parentPath + 'ï¼š' + b) : b;
        var orderA = orderMap[pathA] !== undefined ? orderMap[pathA] : 99999;
        var orderB = orderMap[pathB] !== undefined ? orderMap[pathB] : 99999;
        if (orderA !== orderB) return orderA - orderB;
        return 0; // åŒã˜é †åºãªã‚‰å…ƒã®é †åºã‚’ç¶­æŒ
      });
      // å­ãƒãƒ¼ãƒ‰ã«ã‚‚å†å¸°çš„ã«é©ç”¨
      node.childOrder.forEach(function(childName) {
        var childPath = parentPath ? (parentPath + 'ï¼š' + childName) : childName;
        applyCategoryOrder(node.children[childName], childPath, categoryOrder);
      });
    }

    function getAllNodeItems(node) {
      var result = node.items.slice();
      node.childOrder.forEach(function(name) {
        result = result.concat(getAllNodeItems(node.children[name]));
      });
      return result;
    }

    function renderCategoryNode(name, node, level, fullPath, checked, supplyNeeded, spots, photos) {
      var allItems = getAllNodeItems(node);
      var checkedCount = allItems.filter(function(item) { return checked[item.id]; }).length;
      var totalCount = allItems.length;
      var escapedPath = escapeHtml(fullPath).replace(/'/g, "\\'");
      var levelClass = level === 0 ? 'section' : (level === 1 ? 'section sub-section' : (level === 2 ? 'section sub-sub-section' : 'section sub-sub-sub-section'));
      var html = '<div class="' + levelClass + '" data-category="' + escapeHtml(fullPath) + '">';
      html += '<div class="section-header collapsed" onclick="toggleSection(this)">';
      html += '<div class="section-header-row1">';
      html += '<button class="cat-drag-handle" onclick="event.stopPropagation();" title="ãƒ‰ãƒ©ãƒƒã‚°ã§ä¸¦ã³æ›¿ãˆ">â˜°</button>';
      html += '<span class="section-icon">â–¼</span>';
      html += '<span class="section-title">' + escapeHtml(name) + '</span>';
      html += '<span class="section-count">(' + checkedCount + '/' + totalCount + ')</span>';
      html += '</div>';
      html += '<div class="section-header-row2">';
      html += '<button class="section-header-btn section-check-all" onclick="event.stopPropagation(); checkCategory(this)" title="å…¨ãƒã‚§ãƒƒã‚¯">å…¨âœ“</button>';
      html += '<button class="section-header-btn section-cat-edit" onclick="event.stopPropagation(); renameCategoryPrompt(\'' + escapedPath + '\', \'' + escapeHtml(name).replace(/'/g, "\\'") + '\')" title="åç§°å¤‰æ›´">âœ</button>';
      html += '<button class="section-header-btn section-cat-delete" onclick="event.stopPropagation(); deleteCategoryPrompt(\'' + escapedPath + '\')" title="å‰Šé™¤">âœ•</button>';
      html += '</div>';
      html += '</div>';
      html += '<div class="section-body collapsed">';
      // å¤§ã‚«ãƒ†ã‚´ãƒªã®ã¿ï¼šã‚¤ãƒ³ãƒ©ã‚¤ãƒ³æ’®å½±ç®‡æ‰€
      if (level === 0 && spots && photos) {
        var categorySpots = spots.filter(function(s) {
          var sc = s.category || '';
          return sc === name || s.name === name || s.name.indexOf(name) === 0;
        });
        html += '<div class="inline-photo-spots">';
        categorySpots.forEach(function(spot) {
          var spotPhotos = photos[spot.id] || { before: [], after: [] };
          var bDone = spotPhotos.before.length > 0;
          var aDone = spotPhotos.after.length > 0;
          html += '<div class="inline-photo-spot">';
          if (spot.exampleFileId) {
            html += '<img class="inline-example-thumb" src="https://drive.google.com/thumbnail?id=' + spot.exampleFileId + '&sz=w168" onclick="showExampleWithOptions(\'' + spot.id + '\', \'' + spot.exampleFileId + '\')" alt="è¦‹æœ¬">';
          } else {
            html += '<button class="inline-example-btn" onclick="uploadExamplePrompt(\'' + spot.id + '\')" title="è¦‹æœ¬å†™çœŸã‚’è¨­å®š">âŠ</button>';
          }
          html += '<button class="inline-photo-btn' + (bDone ? ' done' : '') + '" onclick="openPhotoUpload(\'' + spot.id + '\', \'ãƒ“ãƒ•ã‚©ãƒ¼\')">' + (bDone ? 'âœ“å‰' : 'ğŸ“·å‰') + '</button>';
          html += '<button class="inline-photo-btn inline-photo-btn-after' + (aDone ? ' done' : '') + '" onclick="openPhotoUpload(\'' + spot.id + '\', \'ã‚¢ãƒ•ã‚¿ãƒ¼\')">' + (aDone ? 'âœ“å¾Œ' : 'ğŸ“·å¾Œ') + '</button>';
          html += '<span class="inline-photo-spot-name">' + escapeHtml(spot.name) + '</span>';
          html += '<div class="inline-spot-actions">';
          html += '<button class="inline-spot-edit-btn" onclick="editSpotName(\'' + spot.id + '\')" title="åç§°å¤‰æ›´">âœ</button>';
          html += '<button class="inline-spot-delete-btn" onclick="deleteSpot(\'' + spot.id + '\', \'' + escapeHtml(spot.name).replace(/'/g, "\\'") + '\')" title="å‰Šé™¤">âœ•</button>';
          html += '</div></div>';
        });
        html += '<button class="inline-photo-add-btn" onclick="addPhotoSpotPrompt(\'' + escapeHtml(name).replace(/'/g, "\\'") + '\')">ï¼‹ æ’®å½±é …ç›®ã‚’è¿½åŠ </button>';
        html += '</div>';
      }
      // ç›´å±ã‚¢ã‚¤ãƒ†ãƒ ã¨å­ã‚«ãƒ†ã‚´ãƒªã‚’çµ±ä¸€sortOrderã§æ··åˆæç”»
      var catOrderMap = {};
      if (checklistData && checklistData.categoryOrder) {
        checklistData.categoryOrder.forEach(function(o) { catOrderMap[o.path] = o.sortOrder; });
      }
      var mixed = [];
      node.items.forEach(function(item) {
        mixed.push({ type: 'item', data: item, sortOrder: item.sortOrder || 0 });
      });
      node.childOrder.forEach(function(childName) {
        var childPath = fullPath + '\uff1a' + childName;
        mixed.push({ type: 'cat', name: childName, path: childPath, sortOrder: catOrderMap[childPath] !== undefined ? catOrderMap[childPath] : 99999 });
      });
      mixed.sort(function(a, b) { return a.sortOrder - b.sortOrder; });
      mixed.forEach(function(child) {
        if (child.type === 'item') {
          html += renderChecklistItem(child.data, checked, supplyNeeded);
        } else {
          html += renderCategoryNode(child.name, node.children[child.name], level + 1, child.path, checked, supplyNeeded, null, null);
        }
      });
      // è¿½åŠ ãƒœã‚¿ãƒ³
      html += '<button class="section-add-btn" onclick="addItemPrompt(\'' + escapedPath + '\')">ï¼‹ é …ç›®ã‚’è¿½åŠ </button>';
      html += '<button class="section-add-btn" onclick="addSubCategoryPrompt(\'' + escapedPath + '\')">ï¼‹ ã‚µãƒ–ã‚«ãƒ†ã‚´ãƒªã‚’è¿½åŠ </button>';
      html += '</div></div>';
      return html;
    }

    function renderChecklist() {
      try {
        var items = checklistData.items || [];
        var checked = checklistData.checked || {};
        var supplyNeeded = checklistData.supplyNeeded || {};
        var spots = checklistData.spots || [];
        var photos = checklistData.photos || {};

        // é …ç›®ãŒ0ä»¶ã®å ´åˆï¼šè¨ºæ–­ï¼†ã‚¤ãƒ³ãƒãƒ¼ãƒˆæ¡ˆå†…ã‚’è¡¨ç¤º
        if (items.length === 0) {
          document.getElementById('checklistContainer').innerHTML =
            '<div style="padding:30px 20px;text-align:center;color:#666;">' +
            '<p style="font-size:16px;margin-bottom:16px;">ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆé …ç›®ãŒã‚ã‚Šã¾ã›ã‚“</p>' +
            '<p style="font-size:13px;margin-bottom:12px;color:#999;">é …ç›®ãŒå‰Šé™¤ã•ã‚ŒãŸã‹ã€åˆæœŸãƒ‡ãƒ¼ã‚¿ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</p>' +
            '<button id="btnFindOriginal" style="padding:12px 28px;font-size:15px;border-radius:8px;border:none;background:#3498db;color:#fff;cursor:pointer;margin-bottom:12px;">å…ƒã®ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’æ¤œç´¢ã—ã¦å¾©æ—§</button>' +
            '<div id="findResult" style="margin:12px auto;max-width:360px;font-size:12px;text-align:left;display:none;background:#f8f9fa;padding:12px;border-radius:8px;"></div>' +
            '<br>' +
            '<button id="btnDiagnoseCL" style="padding:8px 18px;font-size:13px;border-radius:8px;border:1px solid #999;background:#fff;color:#666;cursor:pointer;margin-bottom:12px;">ãƒ‡ãƒ¼ã‚¿çŠ¶æ…‹ã‚’è¨ºæ–­</button>' +
            '<div id="diagResult" style="margin:12px auto;max-width:320px;font-size:12px;text-align:left;display:none;background:#f8f9fa;padding:12px;border-radius:8px;"></div>' +
            '<br>' +
            '<button id="btnReimportInline" style="padding:10px 22px;font-size:13px;border-radius:8px;border:1px solid #e74c3c;background:#fff;color:#e74c3c;cursor:pointer;">åˆæœŸãƒ‡ãƒ¼ã‚¿ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆï¼ˆãƒªã‚»ãƒƒãƒˆï¼‰</button>' +
            '<p style="font-size:11px;color:#e74c3c;margin-top:6px;">â€»ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã—ãŸé …ç›®ã¯æ¶ˆãˆã¾ã™</p>' +
            '<div id="reimportInlineMsg" style="margin-top:12px;font-size:13px;display:none;"></div>' +
            '</div>';
          document.getElementById('btnFindOriginal').addEventListener('click', function() {
            var btn = this;
            var res = document.getElementById('findResult');
            btn.disabled = true;
            btn.textContent = 'æ¤œç´¢ä¸­â€¦';
            res.style.display = 'block';
            res.textContent = 'Googleãƒ‰ãƒ©ã‚¤ãƒ–ã‚’æ¤œç´¢ä¸­â€¦';
            callGAS('findOriginalChecklistSpreadsheet', []).then(function(d) {
              if (!d.success) { res.textContent = 'ã‚¨ãƒ©ãƒ¼: ' + d.error; btn.disabled = false; btn.textContent = 'å…ƒã®ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’æ¤œç´¢ã—ã¦å¾©æ—§'; return; }
              if (!d.found || d.found.length === 0) { res.innerHTML = 'ã€Œæ¸…æƒãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆç®¡ç†ã€ã¨ã„ã†ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚'; btn.disabled = false; btn.textContent = 'å…ƒã®ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’æ¤œç´¢ã—ã¦å¾©æ—§'; return; }
              var html = '<b>è¦‹ã¤ã‹ã£ãŸã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆ:</b><br>';
              var hasCandidate = false;
              d.found.forEach(function(f, idx) {
                var isCurrent = f.isCurrent ? ' <span style="color:#e74c3c;">(ç¾åœ¨è¨­å®šä¸­ - ç©º)</span>' : '';
                var hasData = f.masterRows && f.masterRows > 1;
                html += '<div style="border:1px solid ' + (hasData ? '#27ae60' : '#ddd') + ';border-radius:6px;padding:8px;margin:8px 0;' + (hasData ? 'background:#eafaf1;' : '') + '">';
                html += '<b>' + (f.name || f.id) + '</b>' + isCurrent + '<br>';
                html += 'ID: <code style="font-size:10px;">' + f.id + '</code><br>';
                if (f.masterRows !== undefined) html += 'ãƒã‚¹ã‚¿: <b>' + (f.masterRows - 1) + 'ä»¶</b>ã®ãƒ‡ãƒ¼ã‚¿<br>';
                if (f.created) html += 'ä½œæˆ: ' + f.created.substring(0, 10) + '<br>';
                if (f.url) html += '<a href="' + f.url + '" target="_blank" style="font-size:11px;">é–‹ã</a> ';
                if (hasData && !f.isCurrent) {
                  hasCandidate = true;
                  html += '<button class="btnRestore" data-id="' + f.id + '" data-rows="' + f.masterRows + '" style="padding:6px 14px;font-size:13px;border-radius:6px;border:none;background:#27ae60;color:#fff;cursor:pointer;margin-top:4px;">ã“ã®ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«å¾©æ—§</button>';
                }
                if (f.preview && f.preview.length) {
                  html += '<div style="font-size:10px;color:#666;margin-top:4px;">ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼: ' + f.preview.map(function(r){return r.join(', ');}).join(' / ') + '</div>';
                }
                if (f.error) html += '<span style="color:#e74c3c;">' + f.error + '</span>';
                html += '</div>';
              });
              if (!hasCandidate) html += '<p style="color:#999;">ãƒ‡ãƒ¼ã‚¿ãŒå…¥ã£ãŸã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚</p>';
              res.innerHTML = html;
              btn.disabled = false;
              btn.textContent = 'å…ƒã®ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’æ¤œç´¢ã—ã¦å¾©æ—§';
              // å¾©æ—§ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆ
              var restoreBtns = res.querySelectorAll('.btnRestore');
              restoreBtns.forEach(function(rb) {
                rb.addEventListener('click', function() {
                  var restoreId = this.getAttribute('data-id');
                  if (!confirm('ã“ã®ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆ(ID: ' + restoreId + ')ã«åˆ‡ã‚Šæ›¿ãˆã¾ã™ã‹ï¼Ÿ')) return;
                  this.disabled = true;
                  this.textContent = 'å¾©æ—§ä¸­â€¦';
                  callGAS('restoreChecklistSpreadsheetId', [restoreId]).then(function(rr) {
                    if (rr.success) {
                      alert(rr.message);
                      location.reload();
                    } else {
                      alert('å¾©æ—§å¤±æ•—: ' + (rr.error || 'ä¸æ˜'));
                    }
                  }).catch(function(e) { alert('é€šä¿¡ã‚¨ãƒ©ãƒ¼: ' + (e.message || e)); });
                });
              });
            }).catch(function(e) {
              res.textContent = 'ã‚¨ãƒ©ãƒ¼: ' + (e.message || e);
              btn.disabled = false;
              btn.textContent = 'å…ƒã®ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’æ¤œç´¢ã—ã¦å¾©æ—§';
            });
          });
          document.getElementById('btnDiagnoseCL').addEventListener('click', function() {
            var btn = this;
            var res = document.getElementById('diagResult');
            btn.disabled = true;
            btn.textContent = 'è¨ºæ–­ä¸­â€¦';
            res.style.display = 'block';
            res.textContent = 'ç¢ºèªä¸­â€¦';
            callGAS('getChecklistDiagnostics', []).then(function(d) {
              var html = '';
              if (d.ssId) html += '<b>ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆID:</b> ' + d.ssId + '<br>';
              if (d.ssUrl) html += '<a href="' + d.ssUrl + '" target="_blank">ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’é–‹ã</a><br>';
              if (d.ssName) html += '<b>åå‰:</b> ' + d.ssName + '<br>';
              if (d.canOpen === false) html += '<span style="color:#e74c3c;">é–‹ã‘ã¾ã›ã‚“: ' + (d.message || '') + '</span><br>';
              if (d.sheets) {
                html += '<b>ã‚·ãƒ¼ãƒˆä¸€è¦§:</b><br>';
                d.sheets.forEach(function(s) { html += 'ãƒ»' + s.name + ': ' + s.rows + 'è¡Œ<br>'; });
              }
              if (d.masterPreview && d.masterPreview.length) {
                html += '<b>ãƒã‚¹ã‚¿ãƒ‡ãƒ¼ã‚¿(å…ˆé ­):</b><br>';
                d.masterPreview.forEach(function(row, i) { html += (i === 0 ? '<i>' : '') + row.join(' | ') + (i === 0 ? '</i>' : '') + '<br>'; });
              }
              if (d.message && !d.ssUrl) html += d.message;
              res.innerHTML = html || 'æƒ…å ±ãªã—';
              btn.disabled = false;
              btn.textContent = 'ãƒ‡ãƒ¼ã‚¿çŠ¶æ…‹ã‚’è¨ºæ–­';
            }).catch(function(e) {
              res.textContent = 'ã‚¨ãƒ©ãƒ¼: ' + (e.message || e);
              btn.disabled = false;
              btn.textContent = 'ãƒ‡ãƒ¼ã‚¿çŠ¶æ…‹ã‚’è¨ºæ–­';
            });
          });
          document.getElementById('btnReimportInline').addEventListener('click', function() {
            var btn = this;
            var msg = document.getElementById('reimportInlineMsg');
            btn.disabled = true;
            btn.textContent = 'ã‚¤ãƒ³ãƒãƒ¼ãƒˆä¸­â€¦';
            msg.style.display = 'block';
            msg.style.color = '#666';
            msg.textContent = 'å‡¦ç†ä¸­â€¦';
            callGAS('importDefaultChecklist', []).then(function(res) {
              if (res.success) {
                msg.textContent = 'å®Œäº†ï¼å†èª­ã¿è¾¼ã¿ä¸­â€¦';
                msg.style.color = '#27ae60';
                callGAS('getChecklistForDate', [checkoutDate]).then(function(clRes) {
                  if (clRes.success) {
                    checklistData = clRes;
                    renderChecklist();
                    renderPhotoSection();
                    renderSupplyList();
                    updateProgress();
                    updateCheckAllButton();
                  } else {
                    msg.textContent = 'ãƒ‡ãƒ¼ã‚¿å†èª­ã¿è¾¼ã¿å¤±æ•—: ' + (clRes.error || 'ä¸æ˜');
                    msg.style.color = '#e74c3c';
                  }
                });
              } else {
                msg.textContent = 'ã‚¤ãƒ³ãƒãƒ¼ãƒˆå¤±æ•—: ' + (res.error || 'ä¸æ˜');
                msg.style.color = '#e74c3c';
                btn.disabled = false;
                btn.textContent = 'åˆæœŸãƒ‡ãƒ¼ã‚¿ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ';
              }
            }).catch(function(e) {
              msg.textContent = 'é€šä¿¡ã‚¨ãƒ©ãƒ¼: ' + (e.message || e);
              msg.style.color = '#e74c3c';
              btn.disabled = false;
              btn.textContent = 'åˆæœŸãƒ‡ãƒ¼ã‚¿ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ';
            });
          });
          return;
        }

        var categoryOrder = checklistData.categoryOrder || [];
        var tree = buildCategoryTree(items, categoryOrder);
        var html = '';
        tree.childOrder.forEach(function(majorName) {
          html += renderCategoryNode(majorName, tree.children[majorName], 0, majorName, checked, supplyNeeded, spots, photos);
        });
        // ã‚«ãƒ†ã‚´ãƒªè¿½åŠ ãƒœã‚¿ãƒ³
        html += '<button class="category-add-btn" onclick="addCategoryPrompt()">ï¼‹ ã‚«ãƒ†ã‚´ãƒªã‚’è¿½åŠ </button>';
        document.getElementById('checklistContainer').innerHTML = html;
      } catch (e) {
        console.error('renderChecklist error:', e);
        document.getElementById('checklistContainer').innerHTML =
          '<div style="padding:20px;text-align:center;color:#c0392b;">' +
          '<p>è¡¨ç¤ºã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</p>' +
          '<button onclick="location.reload()" style="padding:10px 24px;font-size:16px;border-radius:8px;border:none;background:#3498db;color:#fff;cursor:pointer;">å†èª­ã¿è¾¼ã¿</button>' +
          '</div>';
      }
    }
    // === æ’®å½±ã‚»ã‚¯ã‚·ãƒ§ãƒ³ ===
    function renderPhotoSection() {
      var spots = checklistData.spots;
      var photos = checklistData.photos;

      if (spots.length === 0) {
        document.getElementById('photoSection').innerHTML = '<div class="supply-empty">æ’®å½±ç®‡æ‰€ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</div>';
        return;
      }

      // ã‚«ãƒ†ã‚´ãƒªã”ã¨ã«ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
      var categories = {};
      var catOrder = [];
      spots.forEach(function(spot) {
        var cat = spot.category || 'ãã®ä»–';
        if (!categories[cat]) { categories[cat] = []; catOrder.push(cat); }
        categories[cat].push(spot);
      });

      // æ’®å½±æ¸ˆã¿/æœªæ’®å½±ã®ã‚«ã‚¦ãƒ³ãƒˆ
      var totalSpots = spots.length;
      var doneSpots = spots.filter(function(s) {
        var p = photos[s.id] || { before: [], after: [] };
        return p.before.length > 0 || p.after.length > 0;
      }).length;

      var html = '<div style="padding:12px;"><div style="font-size:14px;font-weight:bold;color:#2c3e50;margin-bottom:8px;">æ’®å½±é€²æ—: ' + doneSpots + ' / ' + totalSpots + ' ç®‡æ‰€</div>';
      html += '<div style="height:6px;background:#ecf0f1;border-radius:3px;overflow:hidden;margin-bottom:16px;"><div style="height:100%;background:#e67e22;width:' + (totalSpots > 0 ? Math.round(doneSpots / totalSpots * 100) : 0) + '%;border-radius:3px;"></div></div></div>';

      catOrder.forEach(function(cat) {
        html += '<div class="photo-section"><h3>ğŸ“· ' + escapeHtml(cat) + '</h3>';
        categories[cat].forEach(function(spot) {
          var spotPhotos = photos[spot.id] || { before: [], after: [] };
          var bDone = spotPhotos.before.length > 0;
          var aDone = spotPhotos.after.length > 0;
          var spotDone = bDone || aDone;

          html += '<div class="photo-spot" style="' + (spotDone ? 'border-left:3px solid #27ae60;' : 'border-left:3px solid #e74c3c;') + '">';
          html += '<div class="photo-spot-name" style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;">';
          html += '<span>' + (spotDone ? 'âœ…' : 'â¬œ') + '</span>';
          if (spot.exampleFileId) {
            html += '<img class="inline-example-thumb" src="https://drive.google.com/thumbnail?id=' + spot.exampleFileId + '&sz=w168" onclick="showExampleWithOptions(\'' + spot.id + '\', \'' + spot.exampleFileId + '\')" alt="è¦‹æœ¬">';
          } else {
            html += '<button class="inline-example-btn" onclick="uploadExamplePrompt(\'' + spot.id + '\')" title="è¦‹æœ¬å†™çœŸã‚’è¨­å®š">âŠ</button>';
          }
          html += '<span style="flex:1;">' + escapeHtml(spot.name) + '</span>';
          html += '<div class="inline-spot-actions">';
          html += '<button class="inline-spot-edit-btn" onclick="editSpotName(\'' + spot.id + '\')" title="åç§°å¤‰æ›´">âœ</button>';
          html += '<button class="inline-spot-delete-btn" onclick="deleteSpot(\'' + spot.id + '\', \'' + escapeHtml(spot.name).replace(/'/g, "\\'") + '\')" title="å‰Šé™¤">âœ•</button>';
          html += '</div>';
          html += '</div>';

          // ãƒ“ãƒ•ã‚©ãƒ¼/ã‚¢ãƒ•ã‚¿ãƒ¼ å·¦å³é…ç½®
          html += '<div style="display:flex;gap:8px;">';

          // ãƒ“ãƒ•ã‚©ãƒ¼ï¼ˆå·¦ï¼‰
          html += '<div class="photo-timing-group" style="flex:1;">';
          html += '<button class="photo-upload-btn" onclick="openPhotoUpload(\'' + spot.id + '\', \'ãƒ“ãƒ•ã‚©ãƒ¼\')" style="margin-bottom:4px;">' + (bDone ? 'âœ“ ãƒ“ãƒ•ã‚©ãƒ¼' : 'ãƒ“ãƒ•ã‚©ãƒ¼') + '</button>';
          html += '<div style="font-size:11px;color:#888;text-align:center;">(' + spotPhotos.before.length + 'æš)</div>';
          if (spotPhotos.before.length > 0) {
            html += '<div class="photo-grid" style="margin-top:6px;">';
            spotPhotos.before.forEach(function(photo) {
              html += '<div class="photo-thumb-wrapper"><div class="photo-thumb" style="position:absolute;top:0;left:0;right:0;bottom:0;background-image:url(https://drive.google.com/thumbnail?id=' + photo.fileId + '&sz=w200)"></div>';
              html += '<button class="photo-delete-btn" onclick="deletePhoto(\'' + spot.id + '\', \'' + photo.fileId + '\')">âœ•</button></div>';
            });
            html += '</div>';
          }
          html += '</div>';

          // ã‚¢ãƒ•ã‚¿ãƒ¼ï¼ˆå³ï¼‰
          html += '<div class="photo-timing-group" style="flex:1;">';
          html += '<button class="photo-upload-btn" style="background:#e67e22;margin-bottom:4px;" onclick="openPhotoUpload(\'' + spot.id + '\', \'ã‚¢ãƒ•ã‚¿ãƒ¼\')">' + (aDone ? 'âœ“ ã‚¢ãƒ•ã‚¿ãƒ¼' : 'ã‚¢ãƒ•ã‚¿ãƒ¼') + '</button>';
          html += '<div style="font-size:11px;color:#888;text-align:center;">(' + spotPhotos.after.length + 'æš)</div>';
          if (spotPhotos.after.length > 0) {
            html += '<div class="photo-grid" style="margin-top:6px;">';
            spotPhotos.after.forEach(function(photo) {
              html += '<div class="photo-thumb-wrapper"><div class="photo-thumb" style="position:absolute;top:0;left:0;right:0;bottom:0;background-image:url(https://drive.google.com/thumbnail?id=' + photo.fileId + '&sz=w200)"></div>';
              html += '<button class="photo-delete-btn" onclick="deletePhoto(\'' + spot.id + '\', \'' + photo.fileId + '\')">âœ•</button></div>';
            });
            html += '</div>';
          }
          html += '</div>';

          html += '</div>'; // end flex row

          html += '</div>';
        });
        html += '</div>';
      });

      document.getElementById('photoSection').innerHTML = html;
    }

    function renderMemos() {
      var memos = checklistData.memos;
      var html = '';
      memos.forEach(function(memo) {
        html += '<div class="memo-item">';
        if (memo.text) html += escapeHtml(memo.text);
        if (memo.photoFileId) {
          html += '<div class="memo-photo-thumb">';
          html += '<a href="https://drive.google.com/file/d/' + memo.photoFileId + '/view" target="_blank">';
          html += '<img src="https://drive.google.com/thumbnail?id=' + memo.photoFileId + '&sz=w300" alt="memo photo">';
          html += '</a></div>';
        }
        html += '<div class="memo-meta">' + escapeHtml(memo.by) + ' - ' + formatDateTime(memo.at) + '</div>';
        html += '</div>';
      });
      document.getElementById('memoList').innerHTML = html;
    }

    // === è¦è£œå……ãƒªã‚¹ãƒˆ ===
    function renderSupplyList() {
      var supplyNeeded = checklistData.supplyNeeded;
      var keys = Object.keys(supplyNeeded);

      // ã‚¿ãƒ–ãƒãƒƒã‚¸æ›´æ–°
      var badge = document.getElementById('supplyBadge');
      if (keys.length > 0) {
        badge.textContent = keys.length;
        badge.classList.remove('hidden');
      } else {
        badge.classList.add('hidden');
      }

      // ã‚¿ãƒ–å†…ã‚³ãƒ³ãƒ†ãƒ³ãƒ„
      var el = document.getElementById('supplyListContent');
      if (keys.length === 0) {
        el.innerHTML = '<div class="supply-empty">è¦è£œå……ã®ã‚¢ã‚¤ãƒ†ãƒ ã¯ã‚ã‚Šã¾ã›ã‚“</div>';
        return;
      }

      // ã‚¢ã‚¤ãƒ†ãƒ IDã‹ã‚‰ã‚«ãƒ†ã‚´ãƒªãƒ»åå‰ã‚’æ¤œç´¢ã™ã‚‹ãƒãƒƒãƒ—ã‚’ä½œæˆ
      var itemById = {};
      var itemsByName = {};
      if (checklistData.items) {
        checklistData.items.forEach(function(item) {
          itemById[item.id] = { category: item.category || 'ãã®ä»–', name: item.name };
          // åå‰â†’ã‚«ãƒ†ã‚´ãƒªã®é€†å¼•ãï¼ˆåå‰ã§ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯æ¤œç´¢ç”¨ï¼‰
          if (!itemsByName[item.name]) {
            itemsByName[item.name] = item.category || 'ãã®ä»–';
          }
        });
      }

      // è¦è£œå……ã‚¢ã‚¤ãƒ†ãƒ ã®ã‚«ãƒ†ã‚´ãƒªã‚’æ­£ã—ãè§£æ±ºã™ã‚‹
      // ä¿å­˜æ¸ˆã¿ã‚«ãƒ†ã‚´ãƒª â†’ ãƒã‚¹ã‚¿IDä¸€è‡´ â†’ åå‰ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ ã®å„ªå…ˆé †
      function resolveSupplyCategory(itemId, itemName, storedCategory) {
        // ä¿å­˜æ¸ˆã¿ã‚«ãƒ†ã‚´ãƒªãŒã‚ã‚Œã°ãã‚Œã‚’å„ªå…ˆï¼ˆè¨˜éŒ²æ™‚ç‚¹ã®ã‚«ãƒ†ã‚´ãƒªï¼‰
        if (storedCategory) return storedCategory;
        var master = itemById[itemId];
        // IDã§è¦‹ã¤ã‹ã‚Šã€åå‰ã‚‚ä¸€è‡´ã™ã‚Œã°ç¢ºå®Ÿ
        if (master && master.name === itemName) return master.category;
        // IDãŒåˆ¥ã‚¢ã‚¤ãƒ†ãƒ ã‚’æŒ‡ã™ or è¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã€åå‰ã§æ¤œç´¢
        if (itemsByName[itemName]) return itemsByName[itemName];
        // ã©ã¡ã‚‰ã‚‚è¦‹ã¤ã‹ã‚‰ãªã„å ´åˆ
        return master ? master.category : '';
      }

      // ã‚«ãƒ†ã‚´ãƒªé †ã«ã‚½ãƒ¼ãƒˆã—ã¦åŒã˜ã‚«ãƒ†ã‚´ãƒªã®é …ç›®ã‚’ã¾ã¨ã‚ã‚‹
      keys.sort(function(a, b) {
        var catA = resolveSupplyCategory(a, supplyNeeded[a].name, supplyNeeded[a].category);
        var catB = resolveSupplyCategory(b, supplyNeeded[b].name, supplyNeeded[b].category);
        return catA.localeCompare(catB, 'ja');
      });

      var html = '<div class="supply-list-card"><h3>âš ï¸ è¦è£œå……ãƒªã‚¹ãƒˆ</h3>';
      keys.forEach(function(k) {
        var item = supplyNeeded[k];
        var category = resolveSupplyCategory(k, item.name, item.category);
        html += '<div class="supply-item">';
        if (category) {
          html += '<span class="supply-item-category">' + escapeHtml(category).replace(/ï¼š/g, ' &gt; ') + '</span>';
        }
        html += '<span class="supply-item-name">' + escapeHtml(item.name) + '</span>';
        html += '<button class="supply-item-show-btn" onclick="scrollToSupplyItem(\'' + escapeHtml(k).replace(/'/g, "\\'") + '\', \'' + escapeHtml(item.name).replace(/'/g, "\\'") + '\')">è¡¨ç¤º</button>';
        html += '<button class="supply-item-remove-btn" onclick="removeSupplyItem(\'' + escapeHtml(k).replace(/'/g, "\\'") + '\', \'' + escapeHtml(item.name).replace(/'/g, "\\'") + '\', \'' + escapeHtml(category).replace(/'/g, "\\'") + '\')">è§£é™¤</button>';
        html += '</div>';
      });
      html += '</div>';
      el.innerHTML = html;
    }

    // === è¦è£œå……ã‚¿ãƒ–ã‹ã‚‰ç›´æ¥è§£é™¤ ===
    function removeSupplyItem(itemId, itemName, category) {
      var names = getSelectedStaffNames();
      var who = names.length > 0 ? names.join(', ') : staffName;
      delete checklistData.supplyNeeded[itemId];
      localSupplyRemoved[itemId] = Date.now();
      renderSupplyList();
      // ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆå´ã®ä¾›çµ¦ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚‚é€£å‹•è§£é™¤
      var cb = document.querySelector('.supply-checkbox[data-item-id="' + itemId + '"]');
      if (cb) cb.checked = false;
      showSaveStatus('saving');
      callGAS('toggleSupplyNeeded', [checkoutDate, itemId, itemName, false, who, category]).then(function(res) {
        if (res.success) {
          showSaveStatus('saved');
          delete localSupplyRemoved[itemId];
        } else {
          showSaveStatus('error');
        }
      }).catch(function() { showSaveStatus('error'); });
    }

    // === è¦è£œå……é …ç›®ã¸ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ« ===
    function scrollToSupplyItem(itemId, itemName) {
      // ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆã‚¿ãƒ–ã«åˆ‡ã‚Šæ›¿ãˆ
      switchTab('checklist');

      // å°‘ã—å¾…ã£ã¦ã‹ã‚‰ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ï¼ˆã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆã®DOMåæ˜ å¾…ã¡ï¼‰
      setTimeout(function() {
        var target = document.querySelector('.checklist-item[data-item-id="' + itemId + '"]');
        // IDã§è¦‹ã¤ã‹ã£ãŸè¦ç´ ã®åå‰ãŒä¸€è‡´ã—ãªã„å ´åˆã€åå‰ã§å†æ¤œç´¢
        if (target && itemName) {
          var nameEl = target.querySelector('.item-name');
          if (nameEl && nameEl.textContent.trim() !== itemName) {
            target = null; // IDãšã‚Œï¼šåå‰ã§æ¢ã—ç›´ã™
          }
        }
        if (!target && itemName) {
          var allItems = document.querySelectorAll('.checklist-item');
          for (var i = 0; i < allItems.length; i++) {
            var n = allItems[i].querySelector('.item-name');
            if (n && n.textContent.trim() === itemName) {
              target = allItems[i];
              break;
            }
          }
        }
        if (!target) return;

        // è¦ªã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’å…¨ã¦å±•é–‹
        var parent = target.parentElement;
        while (parent) {
          if (parent.classList.contains('section-body') && parent.classList.contains('collapsed')) {
            parent.classList.remove('collapsed');
            var header = parent.previousElementSibling;
            if (header && header.classList.contains('section-header')) {
              header.classList.remove('collapsed');
            }
          }
          parent = parent.parentElement;
        }

        // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã—ã¦ãƒã‚¤ãƒ©ã‚¤ãƒˆ
        target.scrollIntoView({ behavior: 'smooth', block: 'center' });
        target.classList.add('supply-highlight');
        setTimeout(function() {
          target.classList.remove('supply-highlight');
        }, 2000);
      }, 100);
    }

    // === ã‚»ã‚¯ã‚·ãƒ§ãƒ³æ“ä½œ ===
    function toggleSection(header) {
      var section = header.parentElement;
      var body = section.querySelector(':scope > .section-body');
      var childHeaders = body.querySelectorAll('.section-header');
      var childBodies = body.querySelectorAll('.section-body');
      var isCollapsed = header.classList.contains('collapsed');
      if (isCollapsed) {
        // å…¨å±•é–‹ï¼šè‡ªèº«ï¼‹å­å­«ã™ã¹ã¦é–‹ã
        header.classList.remove('collapsed');
        body.classList.remove('collapsed');
        childHeaders.forEach(function(h) { h.classList.remove('collapsed'); });
        childBodies.forEach(function(b) { b.classList.remove('collapsed'); });
      } else {
        // å…¨æŠ˜ã‚Šï¼šè‡ªèº«ï¼‹å­å­«ã™ã¹ã¦é–‰ã˜ã‚‹
        header.classList.add('collapsed');
        body.classList.add('collapsed');
        childHeaders.forEach(function(h) { h.classList.add('collapsed'); });
        childBodies.forEach(function(b) { b.classList.add('collapsed'); });
      }
    }

    function renameCategoryPrompt(fullPath, currentName) {
      var newName = prompt('ã‚«ãƒ†ã‚´ãƒªåã‚’å¤‰æ›´:', currentName);
      if (!newName || newName.trim() === '' || newName.trim() === currentName) return;
      var undoSnap = captureUndoSnapshot();
      showSaveStatus('saving');
      callGAS('renameCategoryInMaster', [fullPath, newName.trim()]).then(function(res) {
        if (res.success) {
          showSaveStatus('saved');
          setUndo(undoSnap);
          reloadChecklist();
        } else {
          showSaveStatus('error');
          alert(res.error || 'åç§°å¤‰æ›´ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }
      }).catch(function() { showSaveStatus('error'); });
    }

    function deleteCategoryPrompt(fullPath) {
      var parts = fullPath.split('ï¼š');
      var catName = parts[parts.length - 1];
      var choice = prompt('ã‚«ãƒ†ã‚´ãƒªã€Œ' + catName + 'ã€ã‚’å‰Šé™¤ã—ã¾ã™ã€‚\n\n1 = ä¸­èº«ã‚‚å…¨ã¦å‰Šé™¤\n2 = ä¸­èº«ã¯è¦ªã‚«ãƒ†ã‚´ãƒªã«ç§»å‹•ã—ã¦æ®‹ã™\n\nç•ªå·ã‚’å…¥åŠ›:', '');
      if (!choice) return;
      choice = choice.trim();
      if (choice !== '1' && choice !== '2') { alert('1 ã¾ãŸã¯ 2 ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
      var deleteContents = (choice === '1');
      var confirmMsg = deleteContents
        ? 'ã‚«ãƒ†ã‚´ãƒªã€Œ' + catName + 'ã€ã¨ä¸­èº«ã®å…¨é …ç›®ã‚’å‰Šé™¤ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ'
        : 'ã‚«ãƒ†ã‚´ãƒªã€Œ' + catName + 'ã€ã‚’å‰Šé™¤ã—ã€ä¸­èº«ã¯è¦ªã‚«ãƒ†ã‚´ãƒªã«ç§»å‹•ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ';
      if (!confirm(confirmMsg)) return;
      showSaveStatus('saving');
      callGAS('deleteCategoryFromMaster', [fullPath, deleteContents]).then(function(res) {
        if (res.success) {
          showSaveStatus('saved');
          reloadChecklist();
        } else {
          showSaveStatus('error');
          alert(res.error || 'ã‚«ãƒ†ã‚´ãƒªå‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }
      }).catch(function() { showSaveStatus('error'); });
    }

    function reloadAndRender() {
      return callGAS('getChecklistForDate', [checkoutDate]).then(function(res) {
        if (res.success) {
          checklistData = res;
          reRenderWithState();
        } else {
          alert('ãƒ‡ãƒ¼ã‚¿å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (res.error || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'));
        }
      }).catch(function(err) {
        console.error('reloadAndRender error:', err);
        alert('é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚');
      });
    }

    function reloadChecklist() {
      reloadAndRender();
    }

    function toggleItem(checkbox) {
      var itemId = checkbox.getAttribute('data-item-id');
      var checked = checkbox.checked;
      var names = getSelectedStaffNames();
      var who = names.length > 0 ? names.join(', ') : staffName;

      showSaveStatus('saving');
      callGAS('toggleChecklistItem', [checkoutDate, itemId, checked, who]).then(function(res) {
        if (res.success) {
          showSaveStatus('saved');
          if (checked) {
            checklistData.checked[itemId] = { checked: true, by: who, at: new Date() };
          } else {
            delete checklistData.checked[itemId];
          }
          updateProgress();
          updateSectionCounts();
          updateCheckAllButton();
        } else {
          showSaveStatus('error');
          checkbox.checked = !checked;
        }
      }).catch(function() { showSaveStatus('error'); });
    }

    function toggleSupply(checkbox) {
      var itemId = checkbox.getAttribute('data-item-id');
      var itemName = checkbox.getAttribute('data-item-name');
      var itemCategory = checkbox.getAttribute('data-item-category') || '';
      var needed = checkbox.checked;
      var names = getSelectedStaffNames();
      var who = names.length > 0 ? names.join(', ') : staffName;

      // æ¥½è¦³çš„æ›´æ–°ï¼šGASå®Œäº†ã‚’å¾…ãŸãšã«å³åº§ã«ãƒ‡ãƒ¼ã‚¿ã¨UIã‚’æ›´æ–°
      var prevEntry = checklistData.supplyNeeded[itemId];
      if (needed) {
        checklistData.supplyNeeded[itemId] = { name: itemName, category: itemCategory, by: who, at: new Date() };
        delete localSupplyRemoved[itemId];
      } else {
        delete checklistData.supplyNeeded[itemId];
        localSupplyRemoved[itemId] = Date.now();
      }
      renderSupplyList();

      showSaveStatus('saving');
      callGAS('toggleSupplyNeeded', [checkoutDate, itemId, itemName, needed, who, itemCategory]).then(function(res) {
        if (res.success) {
          showSaveStatus('saved');
          // GASæˆåŠŸ: å‰Šé™¤ãŒç¢ºå®šã—ãŸã®ã§ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°ã‹ã‚‰å¤–ã™
          delete localSupplyRemoved[itemId];
        } else {
          // å¤±æ•—æ™‚ã¯ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯
          showSaveStatus('error');
          delete localSupplyRemoved[itemId];
          if (prevEntry) {
            checklistData.supplyNeeded[itemId] = prevEntry;
          } else {
            delete checklistData.supplyNeeded[itemId];
          }
          checkbox.checked = !needed;
          renderSupplyList();
        }
      }).catch(function() {
        // ã‚¨ãƒ©ãƒ¼æ™‚ã‚‚ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯
        showSaveStatus('error');
        delete localSupplyRemoved[itemId];
        if (prevEntry) {
          checklistData.supplyNeeded[itemId] = prevEntry;
        } else {
          delete checklistData.supplyNeeded[itemId];
        }
        checkbox.checked = !needed;
        renderSupplyList();
      });
    }

    function updateProgress() {
      var total = checklistData.totalItems;
      var checked = Object.keys(checklistData.checked).length;
      var percent = total > 0 ? Math.round((checked / total) * 100) : 0;

      document.getElementById('progressFill').style.width = percent + '%';
    }

    function updateSectionCounts() {
      var sections = document.querySelectorAll('.section');
      sections.forEach(function(section) {
        var items = section.querySelectorAll('.item-checkbox');
        var checked = Array.from(items).filter(function(cb) { return cb.checked; }).length;
        var total = items.length;
        var count = section.querySelector('.section-count');
        if (count) {
          count.textContent = '(' + checked + '/' + total + ')';
        }
      });
    }

    function highlightMissing() {
      var items = document.querySelectorAll('.checklist-item');
      items.forEach(function(item) {
        var checkbox = item.querySelector('.item-checkbox');
        var nameEl = item.querySelector('.item-name');
        if (!checkbox.checked) {
          nameEl.classList.add('missing');
        } else {
          nameEl.classList.remove('missing');
        }
      });

      // å†™çœŸæ’®å½±ã®æ¼ã‚Œãƒã‚§ãƒƒã‚¯ï¼ˆãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆã‚¿ãƒ–å†…ã®ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³æ’®å½±ç®‡æ‰€ï¼‰
      var photos = checklistData ? checklistData.photos || {} : {};
      var spots = checklistData ? checklistData.spots || [] : [];
      var photoMissing = false;
      var inlineSpots = document.querySelectorAll('.inline-photo-spot');
      inlineSpots.forEach(function(el) {
        var nameEl = el.querySelector('.inline-photo-spot-name');
        var bBtn = el.querySelector('.inline-photo-btn');
        var aBtn = el.querySelector('.inline-photo-btn-after');
        var bDone = bBtn && bBtn.classList.contains('done');
        var aDone = aBtn && aBtn.classList.contains('done');
        if (!bDone || !aDone) {
          if (nameEl) nameEl.classList.add('missing');
          photoMissing = true;
        } else {
          if (nameEl) nameEl.classList.remove('missing');
        }
      });

      var sections = document.querySelectorAll('.section');
      sections.forEach(function(section) {
        var items = section.querySelectorAll('.item-checkbox');
        var hasMissing = Array.from(items).some(function(cb) { return !cb.checked; });
        // ã“ã®å¤§ã‚«ãƒ†ã‚´ãƒªé…ä¸‹ã®ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³æ’®å½±ç®‡æ‰€ã‚‚æ¼ã‚Œãƒã‚§ãƒƒã‚¯
        var sectionSpots = section.querySelectorAll('.inline-photo-spot');
        sectionSpots.forEach(function(sp) {
          var nm = sp.querySelector('.inline-photo-spot-name');
          if (nm && nm.classList.contains('missing')) hasMissing = true;
        });
        var header = section.querySelector('.section-header');
        var title = section.querySelector('.section-title');

        if (hasMissing) {
          header.classList.add('has-missing');
          title.classList.add('missing');
        } else {
          header.classList.remove('has-missing');
          title.classList.remove('missing');
        }
      });

      // æ’®å½±ã‚¿ãƒ–å†…ã®æ’®å½±ç®‡æ‰€ï¼ˆå¾“æ¥é€šã‚Šï¼‰
      var photoSpotEls = document.querySelectorAll('.photo-spot');
      photoSpotEls.forEach(function(spot) {
        var thumbs = spot.querySelectorAll('.photo-thumb');
        var nameEl = spot.querySelector('.photo-spot-name');
        if (thumbs.length === 0) {
          if (nameEl) nameEl.classList.add('missing');
        } else {
          if (nameEl) nameEl.classList.remove('missing');
        }
      });
    }

    function clearMissingHighlight() {
      document.querySelectorAll('.missing').forEach(function(el) {
        el.classList.remove('missing');
      });
      document.querySelectorAll('.has-missing').forEach(function(el) {
        el.classList.remove('has-missing');
      });
    }

    var currentPhotoSpotId = null;
    var currentPhotoTiming = null;

    function openPhotoUpload(spotId, timing) {
      currentPhotoSpotId = spotId;
      currentPhotoTiming = timing;
      document.getElementById('photoInput').click();
    }

    function handlePhotoUpload(event) {
      var file = event.target.files[0];
      if (!file) return;
      var names = getSelectedStaffNames();
      var who = names.length > 0 ? names.join(', ') : staffName;

      var reader = new FileReader();
      reader.onload = function(e) {
        var base64 = e.target.result.split(',')[1];
        showSaveStatus('saving');

        callGAS('uploadChecklistPhoto', [checkoutDate, currentPhotoSpotId, currentPhotoTiming, base64, who]).then(function(res) {
          if (res.success) {
            showSaveStatus('saved');
            if (!checklistData.photos[currentPhotoSpotId]) {
              checklistData.photos[currentPhotoSpotId] = { before: [], after: [] };
            }
            var photoData = { fileId: res.fileId, by: who, at: new Date() };
            if (currentPhotoTiming === 'ãƒ“ãƒ•ã‚©ãƒ¼') {
              checklistData.photos[currentPhotoSpotId].before.push(photoData);
            } else {
              checklistData.photos[currentPhotoSpotId].after.push(photoData);
            }
            renderPhotoSection();
            renderChecklist();
          } else {
            showSaveStatus('error');
            alert('å†™çœŸã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + res.error);
          }
        }).catch(function() { showSaveStatus('error'); });
      };
      reader.readAsDataURL(file);
      event.target.value = '';
    }

    function addMemo() {
      var input = document.getElementById('memoInput');
      var text = input.value.trim();
      var photoId = pendingMemoPhotoFileId || '';
      if (!text && !photoId) return;
      var names = getSelectedStaffNames();
      var who = names.length > 0 ? names.join(', ') : staffName;

      callGAS('addChecklistMemo', [checkoutDate, text, who, photoId]).then(function(res) {
        if (res.success) {
          checklistData.memos.push({ text: text, by: who, at: new Date(), photoFileId: photoId });
          renderMemos();
          input.value = '';
          clearMemoPhotoPreview();
        } else {
          alert('ãƒ¡ãƒ¢ã®è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + res.error);
        }
      });
    }

    // === ãƒ¡ãƒ¢å†™çœŸ ===
    function openMemoPhotoUpload() {
      document.getElementById('memoPhotoInput').click();
    }

    function handleMemoPhotoSelect(event) {
      var file = event.target.files[0];
      if (!file) return;
      var names = getSelectedStaffNames();
      var who = names.length > 0 ? names.join(', ') : staffName;

      // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º
      var previewReader = new FileReader();
      previewReader.onload = function(e) {
        pendingMemoPhotoDataUrl = e.target.result;
        renderMemoPhotoPreview();
      };
      previewReader.readAsDataURL(file);

      // ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰é–‹å§‹
      document.getElementById('memoUploading').style.display = 'block';
      var reader = new FileReader();
      reader.onload = function(e) {
        var base64 = e.target.result.split(',')[1];
        callGAS('uploadMemoPhoto', [checkoutDate, base64, who]).then(function(res) {
          document.getElementById('memoUploading').style.display = 'none';
          if (res.success) {
            pendingMemoPhotoFileId = res.fileId;
            showSaveStatus('saved');
          } else {
            alert('å†™çœŸã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + res.error);
            clearMemoPhotoPreview();
          }
        }).catch(function() {
          document.getElementById('memoUploading').style.display = 'none';
          clearMemoPhotoPreview();
          showSaveStatus('error');
        });
      };
      reader.readAsDataURL(file);
      event.target.value = '';
    }

    function renderMemoPhotoPreview() {
      var container = document.getElementById('memoPhotoPreview');
      if (!pendingMemoPhotoDataUrl) {
        container.innerHTML = '';
        return;
      }
      container.innerHTML = '<div class="memo-photo-preview">' +
        '<img src="' + pendingMemoPhotoDataUrl + '" alt="preview">' +
        '<button class="remove-btn" onclick="clearMemoPhotoPreview()">&times;</button>' +
        '</div>';
    }

    function clearMemoPhotoPreview() {
      pendingMemoPhotoFileId = null;
      pendingMemoPhotoDataUrl = null;
      document.getElementById('memoPhotoPreview').innerHTML = '';
      document.getElementById('memoUploading').style.display = 'none';
    }

    // === å…¨ä½“æ“ä½œ ===
    var allExpanded = false;
    function toggleAllSections() {
      allExpanded = !allExpanded;
      var btn = document.getElementById('btnExpandAll');
      var headers = document.querySelectorAll('#checklistContainer .section-header');
      var bodies = document.querySelectorAll('#checklistContainer .section-body');
      if (allExpanded) {
        btn.textContent = 'å…¨æŠ˜ã‚Š';
        btn.title = 'å…¨ã¦æŠ˜ã‚ŠãŸãŸã¿';
        headers.forEach(function(h) { h.classList.remove('collapsed'); });
        bodies.forEach(function(b) { b.classList.remove('collapsed'); });
      } else {
        btn.textContent = 'å…¨å±•é–‹';
        btn.title = 'å…¨ã¦å±•é–‹';
        headers.forEach(function(h) { h.classList.add('collapsed'); });
        bodies.forEach(function(b) { b.classList.add('collapsed'); });
      }
    }

    var allChecked = false;
    function checkAllItems() {
      var btn = document.getElementById('btnCheckAll');
      if (!allChecked) {
        // å…¨ãƒã‚§ãƒƒã‚¯
        var unchecked = document.querySelectorAll('.item-checkbox:not(:checked)');
        if (unchecked.length === 0) {
          // æ—¢ã«å…¨ãƒã‚§ãƒƒã‚¯æ¸ˆã¿ â†’ ãƒˆã‚°ãƒ«ã§ã‚¢ãƒ³ãƒã‚§ãƒƒã‚¯
          if (!confirm('å…¨ã¦ã®ãƒã‚§ãƒƒã‚¯ã‚’å¤–ã—ã¾ã™ã‹ï¼Ÿ')) return;
          uncheckAllItems();
          return;
        }
        if (!confirm('å…¨é …ç›®ï¼ˆ' + unchecked.length + 'ä»¶ï¼‰ã«ãƒã‚§ãƒƒã‚¯ã‚’å…¥ã‚Œã¾ã™ã‹ï¼Ÿ')) return;
        var names = getSelectedStaffNames();
        var who = names.length > 0 ? names.join(', ') : staffName;
        // å…¨é …ç›®IDã‚’åé›†
        var allItemIds = checklistData.items.map(function(item) { return item.id; });
        // UIã‚’å³æ™‚æ›´æ–°
        unchecked.forEach(function(cb) { cb.checked = true; });
        allItemIds.forEach(function(id) {
          checklistData.checked[id] = { checked: true, by: who, at: new Date() };
        });
        allChecked = true;
        btn.textContent = 'å…¨âœ“è§£é™¤';
        btn.title = 'å…¨ãƒã‚§ãƒƒã‚¯è§£é™¤';
        btn.classList.add('is-all-checked');
        // ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã«ä¸€æ‹¬ä¿å­˜ï¼ˆ1å›ã®GASå‘¼ã³å‡ºã—ï¼‰
        showSaveStatus('saving');
        callGAS('checkAllItems', [checkoutDate, allItemIds, who]).then(function(res) {
          showSaveStatus(res.success ? 'saved' : 'error');
        }).catch(function() { showSaveStatus('error'); });
      } else {
        if (!confirm('å…¨ã¦ã®ãƒã‚§ãƒƒã‚¯ã‚’å¤–ã—ã¾ã™ã‹ï¼Ÿ')) return;
        uncheckAllItems();
      }
      updateProgress();
      updateSectionCounts();
    }

    function uncheckAllItems() {
      // UIã‚’å³æ™‚æ›´æ–°
      var checked = document.querySelectorAll('.item-checkbox:checked');
      checked.forEach(function(cb) { cb.checked = false; });
      checklistData.checked = {};
      allChecked = false;
      var btn = document.getElementById('btnCheckAll');
      btn.textContent = 'å…¨âœ“';
      btn.title = 'å…¨ãƒã‚§ãƒƒã‚¯';
      btn.classList.remove('is-all-checked');
      updateProgress();
      updateSectionCounts();
      // ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã«ä¸€æ‹¬å‰Šé™¤ï¼ˆ1å›ã®GASå‘¼ã³å‡ºã—ï¼‰
      showSaveStatus('saving');
      callGAS('uncheckAllItems', [checkoutDate]).then(function(res) {
        showSaveStatus(res.success ? 'saved' : 'error');
      }).catch(function() { showSaveStatus('error'); });
    }

    function updateCheckAllButton() {
      var total = checklistData.items.length;
      var checkedCount = Object.keys(checklistData.checked).length;
      var btn = document.getElementById('btnCheckAll');
      if (checkedCount >= total) {
        allChecked = true;
        btn.textContent = 'å…¨âœ“è§£é™¤';
        btn.title = 'å…¨ãƒã‚§ãƒƒã‚¯è§£é™¤';
        btn.classList.add('is-all-checked');
      } else {
        allChecked = false;
        btn.textContent = 'å…¨âœ“';
        btn.title = 'å…¨ãƒã‚§ãƒƒã‚¯';
        btn.classList.remove('is-all-checked');
      }
    }

    function checkCategory(btn) {
      var section = btn.closest('.section');
      if (!section) return;
      var checkboxes = section.querySelectorAll(':scope > .section-body > .checklist-item > .item-checkbox');
      // sub-sectionã®å ´åˆã¯ç›´æ¥å­è¦ç´ ã®ã¿å–å¾—
      if (checkboxes.length === 0) {
        checkboxes = section.querySelectorAll('.item-checkbox');
      }
      var unchecked = Array.from(checkboxes).filter(function(cb) { return !cb.checked; });
      var allDone = unchecked.length === 0;
      var names = getSelectedStaffNames();
      var who = names.length > 0 ? names.join(', ') : staffName;

      showSaveStatus('saving');
      if (allDone) {
        // å…¨ãƒã‚§ãƒƒã‚¯æ¸ˆã¿ â†’ è§£é™¤ï¼ˆå¯¾è±¡IDã‚’åé›†ã—ã¦ä¸€æ‹¬å‰Šé™¤ï¼‰
        var uncheckIds = [];
        Array.from(checkboxes).forEach(function(cb) {
          if (cb.checked) {
            cb.checked = false;
            var itemId = cb.getAttribute('data-item-id');
            uncheckIds.push(itemId);
            delete checklistData.checked[itemId];
          }
        });
        callGAS('uncheckItems', [checkoutDate, uncheckIds]).then(function(res) {
          showSaveStatus(res.success ? 'saved' : 'error');
        }).catch(function() { showSaveStatus('error'); });
      } else {
        var checkIds = [];
        unchecked.forEach(function(cb) {
          cb.checked = true;
          var itemId = cb.getAttribute('data-item-id');
          checkIds.push(itemId);
          checklistData.checked[itemId] = { checked: true, by: who, at: new Date() };
        });
        callGAS('checkAllItems', [checkoutDate, checkIds, who]).then(function(res) {
          showSaveStatus(res.success ? 'saved' : 'error');
        }).catch(function() { showSaveStatus('error'); });
      }
      updateProgress();
      updateSectionCounts();
      updateCheckAllButton();
    }

    // === é …ç›®ç·¨é›†ãƒ»è¿½åŠ  ===
    function editItem(itemId, btn) {
      var nameEl = document.getElementById('itemName_' + itemId);
      if (!nameEl) return;
      var currentText = nameEl.textContent;
      var container = nameEl.parentElement;
      // ç¾åœ¨ã®è¦è£œå……ãƒ•ãƒ©ã‚°ãƒ»è¦‹æœ¬å†™çœŸIDãƒ»ãƒ¡ãƒ¢ã‚’å–å¾—
      var currentSupply = false;
      var currentPhotoId = '';
      var currentMemo = '';
      if (checklistData && checklistData.items) {
        checklistData.items.forEach(function(item) {
          if (item.id === itemId) {
            currentSupply = !!item.supplyItem;
            currentPhotoId = item.exampleFileId || '';
            currentMemo = item.memo || '';
          }
        });
      }
      nameEl.style.display = 'none';
      // è¦è£œå……ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚³ãƒ³ãƒ†ãƒŠã‚‚éè¡¨ç¤ºã«ã™ã‚‹
      var supplyContainer = container.querySelector('.supply-checkbox-container');
      if (supplyContainer) supplyContainer.style.display = 'none';
      // ãƒ¡ãƒ¢è¡¨ç¤ºã‚‚éè¡¨ç¤ºã«ã™ã‚‹
      var memoDisplay = container.querySelector('.item-memo');
      if (memoDisplay) memoDisplay.style.display = 'none';
      var editDiv = document.createElement('div');
      editDiv.id = 'itemEdit_' + itemId;
      var photoHtml = '<div style="display:flex;align-items:center;gap:8px;margin:6px 0;">' +
        '<span style="font-size:13px;color:#555;">è¦‹æœ¬å†™çœŸ:</span>';
      if (currentPhotoId) {
        photoHtml += '<img src="https://drive.google.com/thumbnail?id=' + currentPhotoId + '&sz=w80" style="width:40px;height:40px;border-radius:4px;object-fit:cover;border:1px solid #ddd;">' +
          '<button type="button" onclick="changeItemPhoto(\'' + itemId + '\')" style="padding:3px 8px;border:1px solid #e67e22;background:#fff;color:#e67e22;border-radius:4px;font-size:11px;cursor:pointer;">å¤‰æ›´</button>' +
          '<button type="button" onclick="removeItemPhoto(\'' + itemId + '\')" style="padding:3px 8px;border:1px solid #e74c3c;background:#fff;color:#e74c3c;border-radius:4px;font-size:11px;cursor:pointer;">å‰Šé™¤</button>';
      } else {
        photoHtml += '<button type="button" onclick="changeItemPhoto(\'' + itemId + '\')" style="padding:3px 8px;border:1px solid #3498db;background:#fff;color:#3498db;border-radius:4px;font-size:11px;cursor:pointer;">å†™çœŸã‚’è¿½åŠ </button>';
      }
      photoHtml += '</div>';
      editDiv.innerHTML = '<input type="text" class="item-edit-input" value="' + escapeHtml(currentText) + '">' +
        '<textarea class="item-edit-memo" placeholder="ãƒ¡ãƒ¢ï¼ˆä»»æ„ï¼‰">' + escapeHtml(currentMemo) + '</textarea>' +
        '<label style="display:flex;align-items:center;gap:6px;margin:6px 0;font-size:13px;color:#555;cursor:pointer;">' +
        '<input type="checkbox" class="item-edit-supply" ' + (currentSupply ? 'checked' : '') + ' style="width:18px;height:18px;">' +
        'è¦è£œå……å¯¾è±¡</label>' +
        photoHtml +
        '<div class="item-edit-actions">' +
        '<button class="item-edit-save" onclick="saveItemEdit(\'' + itemId + '\')">ä¿å­˜</button>' +
        '<button class="item-edit-cancel" onclick="cancelItemEdit(\'' + itemId + '\')">å–æ¶ˆ</button>' +
        '</div>';
      container.insertBefore(editDiv, nameEl.nextSibling);
      var input = editDiv.querySelector('input[type="text"]');
      input.focus();
      input.select();
      input.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') saveItemEdit(itemId);
        if (e.key === 'Escape') cancelItemEdit(itemId);
      });
    }

    function saveItemEdit(itemId) {
      var editDiv = document.getElementById('itemEdit_' + itemId);
      var nameEl = document.getElementById('itemName_' + itemId);
      if (!editDiv || !nameEl) return;
      var input = editDiv.querySelector('input[type="text"]');
      var supplyCheckbox = editDiv.querySelector('.item-edit-supply');
      var memoTextarea = editDiv.querySelector('.item-edit-memo');
      var newText = input.value.trim();
      var newSupply = supplyCheckbox ? supplyCheckbox.checked : false;
      var newMemo = memoTextarea ? memoTextarea.value.trim() : '';
      if (!newText) { cancelItemEdit(itemId); return; }
      // ç¾åœ¨ã®å€¤ã‚’å–å¾—ã—ã¦å¤‰æ›´ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
      var currentSupply = false;
      var currentMemo = '';
      if (checklistData && checklistData.items) {
        checklistData.items.forEach(function(item) {
          if (item.id === itemId) {
            currentSupply = !!item.supplyItem;
            currentMemo = item.memo || '';
          }
        });
      }
      var supplyChanged = newSupply !== currentSupply;
      var memoChanged = newMemo !== currentMemo;
      showSaveStatus('saving');
      // ãƒ†ã‚­ã‚¹ãƒˆä¿å­˜
      callGAS('updateChecklistItemText', [itemId, newText]).then(function(res) {
        if (!res.success) {
          showSaveStatus('error');
          alert('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (res.error || ''));
          editDiv.remove();
          nameEl.style.display = '';
          return;
        }
        nameEl.textContent = newText;
        checklistData.items.forEach(function(item) {
          if (item.id === itemId) item.name = newText;
        });
        // ãƒ¡ãƒ¢å¤‰æ›´ãŒã‚ã‚Œã°ä¿å­˜
        var memoPromise = memoChanged
          ? callGAS('updateChecklistItemMemo', [itemId, newMemo]).then(function(res3) {
              if (res3.success) {
                checklistData.items.forEach(function(item) {
                  if (item.id === itemId) item.memo = newMemo;
                });
              }
              return res3;
            })
          : Promise.resolve({ success: true });
        // è¦è£œå……ãƒ•ãƒ©ã‚°å¤‰æ›´ãŒã‚ã‚Œã°ä¿å­˜
        var supplyPromise = supplyChanged
          ? callGAS('updateChecklistItemSupply', [itemId, newSupply]).then(function(res2) {
              if (res2.success) {
                checklistData.items.forEach(function(item) {
                  if (item.id === itemId) item.supplyItem = newSupply;
                });
                // è¦è£œå……å¯¾è±¡ã‚’å¤–ã—ãŸå ´åˆã€è¦è£œå……ãƒªã‚¹ãƒˆã‹ã‚‰ã‚‚å‰Šé™¤
                if (!newSupply && checklistData.supplyNeeded[itemId]) {
                  delete checklistData.supplyNeeded[itemId];
                  var names = getSelectedStaffNames();
                  var who = names.length > 0 ? names.join(', ') : staffName;
                  var itemCat = '';
                  checklistData.items.forEach(function(it) { if (it.id === itemId) itemCat = it.category || ''; });
                  callGAS('toggleSupplyNeeded', [checkoutDate, itemId, newText, false, who, itemCat]);
                }
              }
              return res2;
            })
          : Promise.resolve({ success: true });
        Promise.all([memoPromise, supplyPromise]).then(function(results) {
          var allOk = results.every(function(r) { return r.success; });
          showSaveStatus(allOk ? 'saved' : 'error');
          if (supplyChanged || memoChanged) {
            reRenderWithState();
          } else {
            editDiv.remove();
            nameEl.style.display = '';
            var supplyContainer = nameEl.parentElement.querySelector('.supply-checkbox-container');
            if (supplyContainer) supplyContainer.style.display = '';
          }
        }).catch(function() {
          showSaveStatus('error');
          editDiv.remove();
          nameEl.style.display = '';
        });
      }).catch(function() {
        showSaveStatus('error');
        editDiv.remove();
        nameEl.style.display = '';
      });
    }

    function cancelItemEdit(itemId) {
      var editDiv = document.getElementById('itemEdit_' + itemId);
      var nameEl = document.getElementById('itemName_' + itemId);
      if (editDiv) editDiv.remove();
      if (nameEl) {
        nameEl.style.display = '';
        var supplyContainer = nameEl.parentElement.querySelector('.supply-checkbox-container');
        if (supplyContainer) supplyContainer.style.display = '';
        var memoDisplay = nameEl.parentElement.querySelector('.item-memo');
        if (memoDisplay) memoDisplay.style.display = '';
      }
    }

    // === é …ç›®ã®è¦‹æœ¬å†™çœŸæ©Ÿèƒ½ ===
    function showItemExamplePhoto(itemId, fileId) {
      var overlay = document.createElement('div');
      overlay.className = 'photo-modal-overlay';
      overlay.onclick = function(e) { if (e.target === overlay) overlay.remove(); };
      var modal = document.createElement('div');
      modal.className = 'photo-modal';
      modal.innerHTML = '<h3>è¦‹æœ¬å†™çœŸ</h3>' +
        '<div style="text-align:center;"><img src="https://drive.google.com/thumbnail?id=' + fileId + '&sz=w800" style="max-width:100%;border-radius:8px;border:2px solid #3498db;" onerror="this.alt=\'ç”»åƒã‚’èª­ã¿è¾¼ã‚ã¾ã›ã‚“\';"></div>' +
        '<button class="photo-modal-close" onclick="this.closest(\'.photo-modal-overlay\').remove();">é–‰ã˜ã‚‹</button>';
      overlay.appendChild(modal);
      document.body.appendChild(overlay);
    }

    var currentItemPhotoId = null;
    function changeItemPhoto(itemId) {
      currentItemPhotoId = itemId;
      document.getElementById('itemPhotoInput').click();
    }

    document.addEventListener('DOMContentLoaded', function() {
      var ipInput = document.getElementById('itemPhotoInput');
      if (ipInput) {
        ipInput.addEventListener('change', function(event) {
          var file = event.target.files[0];
          if (!file || !currentItemPhotoId) return;
          var reader = new FileReader();
          reader.onload = function(e) {
            var base64 = e.target.result.split(',')[1];
            showSaveStatus('saving');
            callGAS('uploadChecklistItemPhoto', [currentItemPhotoId, base64]).then(function(res) {
              if (res.success) {
                showSaveStatus('saved');
                checklistData.items.forEach(function(item) {
                  if (item.id === currentItemPhotoId) item.exampleFileId = res.fileId;
                });
                // ç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ ã‚’é–‰ã˜ã¦ã‹ã‚‰å†æç”»
                cancelItemEdit(currentItemPhotoId);
                reRenderWithState();
              } else {
                showSaveStatus('error');
                alert('ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (res.error || ''));
              }
            }).catch(function() { showSaveStatus('error'); });
          };
          reader.readAsDataURL(file);
          event.target.value = '';
        });
      }
    });

    function removeItemPhoto(itemId) {
      if (!confirm('è¦‹æœ¬å†™çœŸã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
      showSaveStatus('saving');
      callGAS('deleteChecklistItemPhoto', [itemId]).then(function(res) {
        if (res.success) {
          showSaveStatus('saved');
          checklistData.items.forEach(function(item) {
            if (item.id === itemId) item.exampleFileId = '';
          });
          cancelItemEdit(itemId);
          reRenderWithState();
        } else {
          showSaveStatus('error');
          alert('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (res.error || ''));
        }
      }).catch(function() { showSaveStatus('error'); });
    }

    function deleteItemPrompt(itemId, itemName) {
      if (!confirm('ã€Œ' + itemName + 'ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
      showSaveStatus('saving');
      callGAS('deleteChecklistItemFromMaster', [itemId]).then(function(res) {
        if (res.success) {
          showSaveStatus('saved');
          reloadAndRender();
        } else {
          showSaveStatus('error');
          alert('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (res.error || ''));
        }
      }).catch(function() { showSaveStatus('error'); });
    }

    function addItemPrompt(category) {
      var name = prompt('è¿½åŠ ã™ã‚‹é …ç›®åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:');
      if (!name || !name.trim()) return;
      var isSupply = confirm('ã“ã®é …ç›®ã‚’ã€Œè¦è£œå……å¯¾è±¡ã€ã«ã—ã¾ã™ã‹ï¼Ÿ\n\nè¦è£œå……å¯¾è±¡ã«ã™ã‚‹ã¨ã€æ¸…æƒæ™‚ã«è£œå……ãŒå¿…è¦ã‹ãƒã‚§ãƒƒã‚¯ã§ãã¾ã™ã€‚');
      showSaveStatus('saving');
      callGAS('addChecklistItemToMaster', [category, name.trim(), isSupply]).then(function(res) {
        if (res.success) {
          showSaveStatus('saved');
          reloadAndRender();
        } else {
          showSaveStatus('error');
          alert('è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (res.error || ''));
        }
      }).catch(function() { showSaveStatus('error'); });
    }

    function addSubCategoryPrompt(parentCategory) {
      var subName = prompt('è¿½åŠ ã™ã‚‹ã‚µãƒ–ã‚«ãƒ†ã‚´ãƒªåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:');
      if (!subName || !subName.trim()) return;
      var itemName = prompt('æœ€åˆã®é …ç›®åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:');
      if (!itemName || !itemName.trim()) return;
      var fullCategory = parentCategory + '\uff1a' + subName.trim();
      showSaveStatus('saving');
      callGAS('addChecklistItemToMaster', [fullCategory, itemName.trim(), false]).then(function(res) {
        if (res.success) {
          showSaveStatus('saved');
          reloadAndRender();
        } else {
          showSaveStatus('error');
          alert('è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (res.error || ''));
        }
      }).catch(function() { showSaveStatus('error'); });
    }

    function reimportFromChecklist() {
      if (!confirm('ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆé …ç›®ã¨æ’®å½±ç®‡æ‰€ã‚’åˆæœŸçŠ¶æ…‹ã«æˆ»ã—ã¾ã™ã€‚\nã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) return;
      callGAS('importDefaultChecklist', []).then(function(res) {
        if (res.success) {
          callGAS('getChecklistForDate', [checkoutDate]).then(function(clRes) {
            if (clRes.success) {
              checklistData = clRes;
              renderChecklist();
              renderPhotoSection();
              renderSupplyList();
              updateProgress();
              updateCheckAllButton();
            }
          });
        } else {
          alert('ã‚¤ãƒ³ãƒãƒ¼ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (res.error || 'ä¸æ˜'));
        }
      }).catch(function(e) {
        alert('ã‚¤ãƒ³ãƒãƒ¼ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (e.message || 'é€šä¿¡å¤±æ•—'));
      });
    }

    function addCategoryPrompt() {
      var category = prompt('è¿½åŠ ã™ã‚‹ã‚«ãƒ†ã‚´ãƒªåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:');
      if (!category || !category.trim()) return;
      var name = prompt('æœ€åˆã®é …ç›®åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:');
      if (!name || !name.trim()) return;
      showSaveStatus('saving');
      callGAS('addChecklistItemToMaster', [category.trim(), name.trim(), false]).then(function(res) {
        if (res.success) {
          showSaveStatus('saved');
          reloadAndRender();
        } else {
          showSaveStatus('error');
          alert('è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (res.error || ''));
        }
      }).catch(function() { showSaveStatus('error'); });
    }

    function addPhotoSpotPrompt(category) {
      var name = prompt('è¿½åŠ ã™ã‚‹æ’®å½±ç®‡æ‰€åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:');
      if (!name || !name.trim()) return;
      showSaveStatus('saving');
      callGAS('addPhotoSpotToMaster', [name.trim(), 'ãƒ“ãƒ•ã‚©ãƒ¼/ã‚¢ãƒ•ã‚¿ãƒ¼', category]).then(function(res) {
        if (res.success) {
          showSaveStatus('saved');
          reloadAndRender();
        } else {
          showSaveStatus('error');
          alert('è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (res.error || ''));
        }
      }).catch(function() { showSaveStatus('error'); });
    }

    // æ’®å½±ä¾‹ã®è¡¨ç¤º
    function showExample(fileId) {
      var overlay = document.createElement('div');
      overlay.className = 'photo-modal-overlay';
      overlay.onclick = function(e) { if (e.target === overlay) overlay.remove(); };
      var modal = document.createElement('div');
      modal.className = 'photo-modal';
      modal.innerHTML = '<h3>ğŸ“Œ æ’®å½±è¦‹æœ¬</h3>' +
        '<div style="text-align:center;"><img src="https://drive.google.com/thumbnail?id=' + fileId + '&sz=w800" style="max-width:100%;border-radius:8px;border:2px solid #e67e22;" onerror="this.src=\'\';this.alt=\'ç”»åƒã‚’èª­ã¿è¾¼ã‚ã¾ã›ã‚“\';"></div>' +
        '<button class="photo-modal-close" onclick="this.closest(\'.photo-modal-overlay\').remove();">é–‰ã˜ã‚‹</button>';
      overlay.appendChild(modal);
      document.body.appendChild(overlay);
    }

    // è¦‹æœ¬å†™çœŸã‚’è¡¨ç¤ºï¼ˆå‰Šé™¤ãƒ»å¤‰æ›´ã‚ªãƒ—ã‚·ãƒ§ãƒ³ä»˜ãï¼‰
    function showExampleWithOptions(spotId, fileId) {
      var overlay = document.createElement('div');
      overlay.className = 'photo-modal-overlay';
      overlay.onclick = function(e) { if (e.target === overlay) overlay.remove(); };
      var modal = document.createElement('div');
      modal.className = 'photo-modal';
      modal.innerHTML = '<h3>ğŸ“Œ æ’®å½±è¦‹æœ¬</h3>' +
        '<div style="text-align:center;"><img src="https://drive.google.com/thumbnail?id=' + fileId + '&sz=w800" style="max-width:100%;border-radius:8px;border:2px solid #e67e22;" onerror="this.src=\'\';this.alt=\'ç”»åƒã‚’èª­ã¿è¾¼ã‚ã¾ã›ã‚“\';"></div>' +
        '<div style="display:flex;gap:8px;margin-top:12px;">' +
        '<button class="photo-modal-close" style="flex:1;background:#e67e22;color:white;border-color:#e67e22;" onclick="this.closest(\'.photo-modal-overlay\').remove();uploadExamplePrompt(\'' + spotId + '\')">å¤‰æ›´</button>' +
        '<button class="photo-modal-close" style="flex:1;background:#e74c3c;color:white;border-color:#e74c3c;" onclick="this.closest(\'.photo-modal-overlay\').remove();deleteExample(\'' + spotId + '\')">å‰Šé™¤</button>' +
        '</div>' +
        '<button class="photo-modal-close" onclick="this.closest(\'.photo-modal-overlay\').remove();">é–‰ã˜ã‚‹</button>';
      overlay.appendChild(modal);
      document.body.appendChild(overlay);
    }

    // è¦‹æœ¬å†™çœŸã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
    var currentExampleSpotId = null;
    function uploadExamplePrompt(spotId) {
      currentExampleSpotId = spotId;
      document.getElementById('examplePhotoInput').click();
    }

    document.addEventListener('DOMContentLoaded', function() {
      var exInput = document.getElementById('examplePhotoInput');
      if (exInput) {
        exInput.addEventListener('change', function(event) {
          var file = event.target.files[0];
          if (!file || !currentExampleSpotId) return;
          var reader = new FileReader();
          reader.onload = function(e) {
            var base64 = e.target.result.split(',')[1];
            showSaveStatus('saving');
            callGAS('uploadExamplePhoto', [currentExampleSpotId, base64]).then(function(res) {
              if (res.success) {
                showSaveStatus('saved');
                // ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿æ›´æ–°
                checklistData.spots.forEach(function(s) {
                  if (s.id === currentExampleSpotId) s.exampleFileId = res.fileId;
                });
                renderChecklist();
                renderPhotoSection();
              } else {
                showSaveStatus('error');
                alert('ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (res.error || ''));
              }
            }).catch(function() { showSaveStatus('error'); });
          };
          reader.readAsDataURL(file);
          event.target.value = '';
        });
      }
    });

    // è¦‹æœ¬å†™çœŸã®å‰Šé™¤
    function deleteExample(spotId) {
      if (!confirm('è¦‹æœ¬å†™çœŸã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
      showSaveStatus('saving');
      callGAS('deleteExamplePhoto', [spotId]).then(function(res) {
        if (res.success) {
          showSaveStatus('saved');
          checklistData.spots.forEach(function(s) {
            if (s.id === spotId) s.exampleFileId = '';
          });
          renderChecklist();
          renderPhotoSection();
        } else {
          showSaveStatus('error');
          alert('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (res.error || ''));
        }
      }).catch(function() { showSaveStatus('error'); });
    }

    // æ’®å½±ç®‡æ‰€ã®åç§°å¤‰æ›´
    function editSpotName(spotId) {
      var currentName = '';
      checklistData.spots.forEach(function(s) { if (s.id === spotId) currentName = s.name; });
      var newName = prompt('æ–°ã—ã„åç§°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:', currentName);
      if (!newName || !newName.trim() || newName.trim() === currentName) return;
      showSaveStatus('saving');
      callGAS('updatePhotoSpotName', [spotId, newName.trim()]).then(function(res) {
        if (res.success) {
          showSaveStatus('saved');
          checklistData.spots.forEach(function(s) {
            if (s.id === spotId) s.name = newName.trim();
          });
          renderChecklist();
          renderPhotoSection();
        } else {
          showSaveStatus('error');
          alert('å¤‰æ›´ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (res.error || ''));
        }
      }).catch(function() { showSaveStatus('error'); });
    }

    // æ’®å½±ç®‡æ‰€ã®å‰Šé™¤
    function deleteSpot(spotId, spotName) {
      if (!confirm('æ’®å½±ç®‡æ‰€ã€Œ' + spotName + 'ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
      showSaveStatus('saving');
      callGAS('deletePhotoSpot', [spotId]).then(function(res) {
        if (res.success) {
          showSaveStatus('saved');
          checklistData.spots = checklistData.spots.filter(function(s) { return s.id !== spotId; });
          renderChecklist();
          renderPhotoSection();
        } else {
          showSaveStatus('error');
          alert('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (res.error || ''));
        }
      }).catch(function() { showSaveStatus('error'); });
    }

    // æ’®å½±å†™çœŸã®å‰Šé™¤
    function deletePhoto(spotId, fileId) {
      if (!confirm('ã“ã®å†™çœŸã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
      showSaveStatus('saving');
      callGAS('deleteChecklistPhoto', [checkoutDate, spotId, fileId]).then(function(res) {
        if (res.success) {
          showSaveStatus('saved');
          var sp = checklistData.photos[spotId];
          if (sp) {
            sp.before = sp.before.filter(function(p) { return p.fileId !== fileId; });
            sp.after = sp.after.filter(function(p) { return p.fileId !== fileId; });
          }
          renderChecklist();
          renderPhotoSection();
        } else {
          showSaveStatus('error');
          alert('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (res.error || ''));
        }
      }).catch(function() { showSaveStatus('error'); });
    }

    function completeChecklist() {
      var names = getSelectedStaffNames();
      var who = names.length > 0 ? names.join(', ') : staffName;

      // æ¼ã‚Œãƒã‚§ãƒƒã‚¯å®Ÿè¡Œ
      var uncheckedItems = document.querySelectorAll('.item-checkbox:not(:checked)');
      var photos = checklistData ? checklistData.photos || {} : {};
      var spots = checklistData ? checklistData.spots || [] : [];
      var missingPhotos = spots.filter(function(s) {
        var p = photos[s.id] || { before: [], after: [] };
        return p.before.length === 0 || p.after.length === 0;
      });

      var msgEl = document.getElementById('completeMsg');

      if (uncheckedItems.length > 0 || missingPhotos.length > 0) {
        // æœªå®Œäº†é …ç›®ã‚ã‚Š â†’ ãƒã‚¤ãƒ©ã‚¤ãƒˆè¡¨ç¤º
        highlightMissing();
        var msgs = [];
        if (uncheckedItems.length > 0) msgs.push('æœªãƒã‚§ãƒƒã‚¯é …ç›®: ' + uncheckedItems.length + 'ä»¶');
        if (missingPhotos.length > 0) msgs.push('æœªæ’®å½±ç®‡æ‰€: ' + missingPhotos.length + 'ä»¶');
        msgEl.textContent = msgs.join('ã€');
        msgEl.style.display = 'block';

        // æœªå®Œäº†ã§ã‚‚ç¢ºèªã—ã¦é€ä¿¡å¯èƒ½
        if (!confirm('æœªå®Œäº†é …ç›®ãŒã‚ã‚Šã¾ã™ã€‚\n' + msgs.join('\n') + '\n\nãã‚Œã§ã‚‚æ¸…æƒå®Œäº†ã‚’é€šçŸ¥ã—ã¾ã™ã‹ï¼Ÿ')) return;
      } else {
        msgEl.style.display = 'none';
        clearMissingHighlight();
        if (!confirm('æ¸…æƒã‚’å®Œäº†ã—ã¦ã‚ªãƒ¼ãƒŠãƒ¼ã«é€šçŸ¥ã—ã¾ã™ã‹ï¼Ÿ')) return;
      }

      callGAS('notifyCleaningComplete', [checkoutDate, who]).then(function(res) {
        if (res.success) {
          alert('æ¸…æƒå®Œäº†é€šçŸ¥ã‚’é€ä¿¡ã—ã¾ã—ãŸï¼ãŠç–²ã‚Œæ§˜ã§ã—ãŸï¼');
        } else {
          alert('é€šçŸ¥ã®é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + res.error);
        }
      });
    }

    // === UNDOæ©Ÿèƒ½ ===
    var lastUndoData = null;
    var undoToastTimer = null;

    function captureUndoSnapshot() {
      if (!checklistData) return null;
      return {
        items: checklistData.items ? checklistData.items.map(function(item) {
          return { id: item.id, category: item.category, sortOrder: item.sortOrder || 0 };
        }) : [],
        categoryOrder: checklistData.categoryOrder ? checklistData.categoryOrder.map(function(o) {
          return { path: o.path, sortOrder: o.sortOrder };
        }) : []
      };
    }

    function setUndo(snapshot) {
      if (!snapshot) return;
      lastUndoData = snapshot;
      showUndoToast();
    }

    function showUndoToast() {
      var existing = document.getElementById('undoToast');
      if (existing) existing.remove();
      if (undoToastTimer) { clearTimeout(undoToastTimer); undoToastTimer = null; }
      var toast = document.createElement('div');
      toast.id = 'undoToast';
      toast.innerHTML = '<span>å¤‰æ›´ã—ã¾ã—ãŸ</span><button onclick="performUndo()">å…ƒã«æˆ»ã™</button>';
      document.body.appendChild(toast);
      undoToastTimer = setTimeout(function() {
        toast.classList.add('fade-out');
        setTimeout(function() { if (toast.parentNode) toast.remove(); lastUndoData = null; }, 300);
      }, 8000);
    }

    function performUndo() {
      if (!lastUndoData) return;
      var snapshot = lastUndoData;
      lastUndoData = null;
      var toast = document.getElementById('undoToast');
      if (toast) toast.remove();
      if (undoToastTimer) { clearTimeout(undoToastTimer); undoToastTimer = null; }
      showSaveStatus('saving');
      callGAS('restoreChecklistSnapshot', [snapshot]).then(function(res) {
        if (res.success) {
          showSaveStatus('saved');
          reloadChecklist();
        } else {
          showSaveStatus('error');
          alert('å…ƒã«æˆ»ã›ã¾ã›ã‚“ã§ã—ãŸ: ' + (res.error || ''));
        }
      }).catch(function() { showSaveStatus('error'); });
    }

    // === ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ===
    var gasRunning = 0;
    var GAS_MAX_CONCURRENT = 3;
    var gasQueue = [];

    function callGAS(functionName, args) {
      return new Promise(function(resolve, reject) {
        function execute() {
          gasRunning++;
          google.script.run
            .withSuccessHandler(function(jsonStr) {
              gasRunning--;
              drainGasQueue();
              try { resolve(JSON.parse(jsonStr)); } catch (e) { reject(e); }
            })
            .withFailureHandler(function(err) {
              gasRunning--;
              drainGasQueue();
              reject(err);
            })
            [functionName].apply(null, args);
        }
        if (gasRunning < GAS_MAX_CONCURRENT) {
          execute();
        } else {
          gasQueue.push(execute);
        }
      });
    }

    function drainGasQueue() {
      while (gasQueue.length > 0 && gasRunning < GAS_MAX_CONCURRENT) {
        var next = gasQueue.shift();
        next();
      }
    }

    function escapeHtml(text) {
      var div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function formatDateTime(dateStr) {
      if (!dateStr) return '';
      var d = new Date(dateStr);
      return d.getMonth() + 1 + '/' + d.getDate() + ' ' +
             String(d.getHours()).padStart(2, '0') + ':' +
             String(d.getMinutes()).padStart(2, '0');
    }

    // === ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—ä¸¦ã³æ›¿ãˆï¼ˆã‚¿ãƒƒãƒå¯¾å¿œãƒ»é•·æŠ¼ã—ã§ç™ºå‹•ãƒ»ã‚¯ãƒ­ã‚¹ã‚«ãƒ†ã‚´ãƒªç§»å‹•å¯¾å¿œï¼‰ ===
    (function() {
      var dragItem = null;
      var placeholder = null;
      var dragClone = null;
      var containerEl = null;
      var originalContainerEl = null;

      // é•·æŠ¼ã—æ¤œå‡ºç”¨
      var longPressTimer = null;
      var pendingItem = null;
      var pendingHandle = null;
      var pressX = 0, pressY = 0;
      var LONG_PRESS_MS = 600;
      var MOVE_THRESHOLD = 10;

      function getCategoryFromBody(sectionBody) {
        if (!sectionBody) return '';
        var section = sectionBody.parentElement;
        return (section && section.getAttribute('data-category')) || '';
      }

      // ã‚«ãƒ¼ã‚½ãƒ«ä½ç½®ã«ã‚ã‚‹æœ€ã‚‚æ·±ã„éæŠ˜ã‚ŠãŸãŸã¿ section-body ã‚’æ¢ã™
      function findTargetSectionBody(x, y) {
        var allBodies = document.querySelectorAll('#checklistContainer .section-body:not(.collapsed)');
        var best = null;
        var bestDepth = -1;
        for (var i = 0; i < allBodies.length; i++) {
          var body = allBodies[i];
          var rect = body.getBoundingClientRect();
          if (rect.height < 2) continue; // éè¡¨ç¤ºæ‰±ã„
          if (y >= rect.top && y <= rect.bottom && x >= rect.left && x <= rect.right) {
            var depth = 0;
            var p = body.parentElement;
            while (p) {
              if (p.classList && p.classList.contains('section-body')) depth++;
              p = p.parentElement;
            }
            if (depth > bestDepth) {
              bestDepth = depth;
              best = body;
            }
          }
        }
        return best;
      }

      function cancelLongPress() {
        if (longPressTimer) { clearTimeout(longPressTimer); longPressTimer = null; }
        if (pendingHandle) { pendingHandle.classList.remove('drag-handle-pending'); }
        pendingItem = null; pendingHandle = null;
        document.removeEventListener('touchmove', onWaitMove);
        document.removeEventListener('touchend', cancelLongPress);
        document.removeEventListener('touchcancel', cancelLongPress);
        document.removeEventListener('mousemove', onWaitMove);
        document.removeEventListener('mouseup', cancelLongPress);
      }

      function onWaitMove(e) {
        var touch = e.touches ? e.touches[0] : e;
        if (Math.abs(touch.clientX - pressX) > MOVE_THRESHOLD || Math.abs(touch.clientY - pressY) > MOVE_THRESHOLD) {
          cancelLongPress();
        }
      }

      function onHandlePress(e) {
        var handle = e.target.closest('.item-drag-handle');
        if (!handle) return;
        var item = handle.closest('.checklist-item');
        if (!item) return;
        e.preventDefault();
        e.stopPropagation();
        cancelLongPress();
        var touch = e.touches ? e.touches[0] : e;
        pressX = touch.clientX; pressY = touch.clientY;
        pendingItem = item; pendingHandle = handle;
        handle.classList.add('drag-handle-pending');
        longPressTimer = setTimeout(function() {
          longPressTimer = null;
          document.removeEventListener('touchmove', onWaitMove);
          document.removeEventListener('touchend', cancelLongPress);
          document.removeEventListener('touchcancel', cancelLongPress);
          document.removeEventListener('mousemove', onWaitMove);
          document.removeEventListener('mouseup', cancelLongPress);
          if (pendingHandle) pendingHandle.classList.remove('drag-handle-pending');
          if (navigator.vibrate) navigator.vibrate(30);
          activateDrag();
        }, LONG_PRESS_MS);
        document.addEventListener('touchmove', onWaitMove, { passive: true });
        document.addEventListener('touchend', cancelLongPress);
        document.addEventListener('touchcancel', cancelLongPress);
        document.addEventListener('mousemove', onWaitMove);
        document.addEventListener('mouseup', cancelLongPress);
      }

      function activateDrag() {
        dragItem = pendingItem; pendingItem = null; pendingHandle = null;
        if (!dragItem) return;
        containerEl = dragItem.parentElement;
        originalContainerEl = containerEl;

        placeholder = document.createElement('div');
        placeholder.className = 'drag-placeholder';
        placeholder.style.height = dragItem.offsetHeight + 'px';

        var rect = dragItem.getBoundingClientRect();
        dragClone = dragItem.cloneNode(true);
        dragClone.style.position = 'fixed';
        dragClone.style.left = rect.left + 'px';
        dragClone.style.top = rect.top + 'px';
        dragClone.style.width = rect.width + 'px';
        dragClone.style.zIndex = '9999';
        dragClone.style.opacity = '0.85';
        dragClone.style.boxShadow = '0 4px 16px rgba(0,0,0,0.2)';
        dragClone.style.background = '#fff';
        dragClone.style.pointerEvents = 'none';
        dragClone.style.transition = 'none';
        document.body.appendChild(dragClone);

        dragItem.classList.add('dragging');
        dragItem.parentElement.insertBefore(placeholder, dragItem);
        dragItem.style.display = 'none';

        document.addEventListener('touchmove', handleDragMove, { passive: false });
        document.addEventListener('touchend', handleDragEnd);
        document.addEventListener('mousemove', handleDragMove);
        document.addEventListener('mouseup', handleDragEnd);
      }

      function handleDragMove(e) {
        if (!dragItem || !dragClone || !placeholder) return;
        e.preventDefault();
        var touch = e.touches ? e.touches[0] : e;
        dragClone.style.top = (touch.clientY - dragClone.offsetHeight / 2) + 'px';

        // ã‚¯ãƒ­ã‚¹ã‚«ãƒ†ã‚´ãƒª: ã‚«ãƒ¼ã‚½ãƒ«ä½ç½®ã«ã‚ã‚‹ section-body ã‚’æ¢ã™
        var targetBody = findTargetSectionBody(touch.clientX, touch.clientY);
        if (targetBody && targetBody !== containerEl) {
          // ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚’åˆ‡ã‚Šæ›¿ãˆ
          if (containerEl) containerEl.classList.remove('drag-target');
          containerEl = targetBody;
          if (containerEl !== originalContainerEl) {
            containerEl.classList.add('drag-target');
          }
        }

        // containerEl ç›´ä¸‹ã® .checklist-item ã¨ .section ã‚’å–å¾—ã—ã¦æŒ¿å…¥ä½ç½®ã‚’æ±ºå®š
        var siblings = Array.prototype.slice.call(
          containerEl.querySelectorAll(':scope > .checklist-item, :scope > .section')
        ).filter(function(el) { return el !== dragItem; });
        var inserted = false;
        for (var i = 0; i < siblings.length; i++) {
          var r = siblings[i].getBoundingClientRect();
          var mid = r.top + r.height / 2;
          if (touch.clientY < mid) {
            containerEl.insertBefore(placeholder, siblings[i]);
            inserted = true;
            break;
          }
        }
        if (!inserted) {
          // æœ€å¾Œã®è¦ç´ ã®å¾Œã‚ã€è¿½åŠ ãƒœã‚¿ãƒ³ã®å‰ã«é…ç½®
          var addBtn = containerEl.querySelector(':scope > .section-add-btn');
          if (addBtn) {
            containerEl.insertBefore(placeholder, addBtn);
          } else {
            containerEl.appendChild(placeholder);
          }
        }
      }

      function handleDragEnd(e) {
        if (!dragItem || !placeholder) return;
        document.removeEventListener('touchmove', handleDragMove);
        document.removeEventListener('touchend', handleDragEnd);
        document.removeEventListener('mousemove', handleDragMove);
        document.removeEventListener('mouseup', handleDragEnd);

        // ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚’é™¤å»
        if (containerEl) containerEl.classList.remove('drag-target');

        // placeholder ã®ä½ç½®ã«å®Ÿã‚¢ã‚¤ãƒ†ãƒ ã‚’æŒ¿å…¥
        placeholder.parentElement.insertBefore(dragItem, placeholder);
        dragItem.style.display = '';
        dragItem.classList.remove('dragging');
        placeholder.remove();
        if (dragClone) { dragClone.remove(); dragClone = null; }

        // ç§»å‹•å…ˆã® section-body ã‚’å–å¾—
        var section = dragItem.closest('.section-body');
        if (!section) { dragItem = null; placeholder = null; containerEl = null; originalContainerEl = null; return; }

        var movedItemId = dragItem.getAttribute('data-item-id');
        var newCategory = getCategoryFromBody(section);
        var oldCategory = getCategoryFromBody(originalContainerEl);
        var categoryChanged = (newCategory !== oldCategory);

        // é …ç›®ï¼‹ã‚«ãƒ†ã‚´ãƒªã®çµ±ä¸€sortOrderã‚’è¨ˆç®—
        var allChildren = Array.prototype.slice.call(
          section.querySelectorAll(':scope > .checklist-item, :scope > .section')
        );
        var itemOrders = [];
        var catOrders = [];
        for (var i = 0; i < allChildren.length; i++) {
          var child = allChildren[i];
          var sortVal = i + 1;
          if (child.classList.contains('checklist-item')) {
            var cid = child.getAttribute('data-item-id');
            if (cid) {
              itemOrders.push({ id: cid, sortOrder: sortVal });
              child.setAttribute('data-sort-order', sortVal);
            }
          } else if (child.classList.contains('section')) {
            var catPath = child.getAttribute('data-category');
            if (catPath) catOrders.push({ path: catPath, sortOrder: sortVal });
          }
        }

        if (itemOrders.length > 0 || catOrders.length > 0) {
          // UNDOç”¨ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆï¼ˆãƒ­ãƒ¼ã‚«ãƒ«æ›´æ–°å‰ã«å–å¾—ï¼‰
          var undoSnap = captureUndoSnapshot();

          // ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°ï¼ˆé …ç›®ï¼‰
          var itemMap = {};
          itemOrders.forEach(function(o) { itemMap[o.id] = o.sortOrder; });
          if (checklistData && checklistData.items) {
            checklistData.items.forEach(function(item) {
              if (itemMap[item.id] !== undefined) item.sortOrder = itemMap[item.id];
              if (categoryChanged && item.id === movedItemId) item.category = newCategory;
            });
          }
          // ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°ï¼ˆã‚«ãƒ†ã‚´ãƒªé †åºï¼‰
          if (catOrders.length > 0 && checklistData) {
            if (!checklistData.categoryOrder) checklistData.categoryOrder = [];
            var existingCatMap = {};
            checklistData.categoryOrder.forEach(function(o, idx) { existingCatMap[o.path] = idx; });
            catOrders.forEach(function(o) {
              var idx = existingCatMap[o.path];
              if (idx !== undefined) checklistData.categoryOrder[idx].sortOrder = o.sortOrder;
              else checklistData.categoryOrder.push(o);
            });
          }

          showSaveStatus('saving');
          var pendingSaves = 0;
          var anyError = false;
          function onItemDragSaveDone() {
            pendingSaves--;
            if (pendingSaves <= 0) {
              showSaveStatus(anyError ? 'error' : 'saved');
              if (!anyError) setUndo(undoSnap);
              if (categoryChanged) reRenderWithState();
            }
          }

          // é …ç›®ã®ä¿å­˜
          if (categoryChanged && movedItemId) {
            pendingSaves++; gasRunning++;
            google.script.run
              .withSuccessHandler(function(json) {
                gasRunning--;
                try { var res = JSON.parse(json); if (!res.success) anyError = true; } catch (e) { anyError = true; }
                onItemDragSaveDone();
              })
              .withFailureHandler(function() { gasRunning--; anyError = true; onItemDragSaveDone(); })
              .moveItemToCategory(movedItemId, newCategory, itemOrders);
          } else if (itemOrders.length > 0) {
            pendingSaves++; gasRunning++;
            google.script.run
              .withSuccessHandler(function(json) {
                gasRunning--;
                try { var res = JSON.parse(json); if (!res.success) anyError = true; } catch (e) { anyError = true; }
                onItemDragSaveDone();
              })
              .withFailureHandler(function() { gasRunning--; anyError = true; onItemDragSaveDone(); })
              .reorderChecklistItems(itemOrders);
          }
          // ã‚«ãƒ†ã‚´ãƒªé †åºã®ä¿å­˜
          if (catOrders.length > 0) {
            pendingSaves++; gasRunning++;
            google.script.run
              .withSuccessHandler(function(json) {
                gasRunning--;
                try { var res = JSON.parse(json); if (!res.success) anyError = true; } catch (e) { anyError = true; }
                onItemDragSaveDone();
              })
              .withFailureHandler(function() { gasRunning--; anyError = true; onItemDragSaveDone(); })
              .reorderCategories(catOrders);
          }
          if (pendingSaves === 0) showSaveStatus('saved');
        }
        dragItem = null;
        placeholder = null;
        containerEl = null;
        originalContainerEl = null;
      }

      // Bind events via delegationï¼ˆé•·æŠ¼ã—é–‹å§‹ï¼‰
      document.addEventListener('touchstart', function(e) {
        if (e.target.closest('.item-drag-handle')) onHandlePress(e);
      }, { passive: false });
      document.addEventListener('mousedown', function(e) {
        if (e.target.closest('.item-drag-handle')) onHandlePress(e);
      });
    })();

    // === ã‚«ãƒ†ã‚´ãƒªä¸¦ã³æ›¿ãˆãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—ï¼ˆã‚¿ãƒƒãƒå¯¾å¿œãƒ»é•·æŠ¼ã—ã§ç™ºå‹•ãƒ»ã‚¯ãƒ­ã‚¹ã‚«ãƒ†ã‚´ãƒªç§»å‹•å¯¾å¿œï¼‰ ===
    (function() {
      var dragSection = null;
      var placeholder = null;
      var dragClone = null;
      var containerEl = null;
      var siblingSelector = null;
      var dropIntoTarget = null; // åˆ¥ã‚«ãƒ†ã‚´ãƒªã«ãƒ‰ãƒ­ãƒƒãƒ—ã™ã‚‹å…ˆ
      var rootDropZone = null;   // ãƒ«ãƒ¼ãƒˆãƒ¬ãƒ™ãƒ«ã¸ã®æ˜‡æ ¼ç”¨ãƒ‰ãƒ­ãƒƒãƒ—ã‚¾ãƒ¼ãƒ³

      // é•·æŠ¼ã—æ¤œå‡ºç”¨
      var longPressTimer = null;
      var pendingSection = null;
      var pendingHandle = null;
      var pressX = 0, pressY = 0;
      var LONG_PRESS_MS = 600;
      var MOVE_THRESHOLD = 10;

      function clearDropIntoHighlight() {
        var highlighted = document.querySelectorAll('.cat-drop-into-target');
        for (var i = 0; i < highlighted.length; i++) highlighted[i].classList.remove('cat-drop-into-target');
      }

      // ãƒ‰ãƒ­ãƒƒãƒ—å…ˆã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’æ¢ã™ï¼ˆåˆ¥ã‚«ãƒ†ã‚´ãƒªå†…ã«ç§»å‹•ç”¨ï¼‰
      function findDropIntoHeader(x, y, dragCatPath) {
        var allHeaders = document.querySelectorAll('#checklistContainer .section-header');
        for (var i = 0; i < allHeaders.length; i++) {
          var header = allHeaders[i];
          var section = header.parentElement;
          if (!section || !section.classList.contains('section')) continue;
          var catPath = section.getAttribute('data-category');
          if (!catPath) continue;
          // è‡ªåˆ†è‡ªèº«ã¯é™¤å¤–
          if (catPath === dragCatPath) continue;
          // ãƒ‰ãƒ©ãƒƒã‚°ä¸­ã‚«ãƒ†ã‚´ãƒªã®å­å­«ã¯é™¤å¤–
          if (catPath.indexOf(dragCatPath + '\uff1a') === 0) continue;
          // ç¾åœ¨ã®ç›´æ¥ã®è¦ªã¯é™¤å¤–ï¼ˆæ—¢ã«ä¸­ã«ã„ã‚‹ã®ã§ï¼‰
          var dragParts = dragCatPath.split('\uff1a');
          var parentPath = dragParts.slice(0, -1).join('\uff1a');
          if (catPath === parentPath) continue;
          var rect = header.getBoundingClientRect();
          if (y >= rect.top && y <= rect.bottom && x >= rect.left && x <= rect.right) {
            return { section: section, headerEl: header, catPath: catPath };
          }
        }
        return null;
      }

      function cancelCatLongPress() {
        if (longPressTimer) { clearTimeout(longPressTimer); longPressTimer = null; }
        if (pendingHandle) { pendingHandle.classList.remove('drag-handle-pending'); }
        pendingSection = null; pendingHandle = null;
        document.removeEventListener('touchmove', onCatWaitMove);
        document.removeEventListener('touchend', cancelCatLongPress);
        document.removeEventListener('touchcancel', cancelCatLongPress);
        document.removeEventListener('mousemove', onCatWaitMove);
        document.removeEventListener('mouseup', cancelCatLongPress);
      }

      function onCatWaitMove(e) {
        var touch = e.touches ? e.touches[0] : e;
        if (Math.abs(touch.clientX - pressX) > MOVE_THRESHOLD || Math.abs(touch.clientY - pressY) > MOVE_THRESHOLD) {
          cancelCatLongPress();
        }
      }

      function onCatHandlePress(e) {
        var handle = e.target.closest('.cat-drag-handle');
        if (!handle) return;
        var section = handle.closest('.section');
        if (!section) return;
        e.preventDefault();
        e.stopPropagation();
        cancelCatLongPress();
        var touch = e.touches ? e.touches[0] : e;
        pressX = touch.clientX; pressY = touch.clientY;
        pendingSection = section; pendingHandle = handle;
        handle.classList.add('drag-handle-pending');
        longPressTimer = setTimeout(function() {
          longPressTimer = null;
          document.removeEventListener('touchmove', onCatWaitMove);
          document.removeEventListener('touchend', cancelCatLongPress);
          document.removeEventListener('touchcancel', cancelCatLongPress);
          document.removeEventListener('mousemove', onCatWaitMove);
          document.removeEventListener('mouseup', cancelCatLongPress);
          if (pendingHandle) pendingHandle.classList.remove('drag-handle-pending');
          if (navigator.vibrate) navigator.vibrate(30);
          activateCatDrag();
        }, LONG_PRESS_MS);
        document.addEventListener('touchmove', onCatWaitMove, { passive: true });
        document.addEventListener('touchend', cancelCatLongPress);
        document.addEventListener('touchcancel', cancelCatLongPress);
        document.addEventListener('mousemove', onCatWaitMove);
        document.addEventListener('mouseup', cancelCatLongPress);
      }

      function activateCatDrag() {
        dragSection = pendingSection; pendingSection = null; pendingHandle = null;
        if (!dragSection) return;
        containerEl = dragSection.parentElement;

        // åŒãƒ¬ãƒ™ãƒ«ã®å…„å¼Ÿã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®ã‚»ãƒ¬ã‚¯ã‚¿ã‚’æ±ºå®š
        if (dragSection.classList.contains('sub-sub-sub-section')) {
          siblingSelector = ':scope > .sub-sub-sub-section';
        } else if (dragSection.classList.contains('sub-sub-section')) {
          siblingSelector = ':scope > .sub-sub-section';
        } else if (dragSection.classList.contains('sub-section')) {
          siblingSelector = ':scope > .sub-section';
        } else {
          siblingSelector = ':scope > .section:not(.sub-section):not(.sub-sub-section):not(.sub-sub-sub-section)';
        }

        placeholder = document.createElement('div');
        placeholder.className = 'cat-drag-placeholder';
        placeholder.style.height = dragSection.offsetHeight + 'px';

        var rect = dragSection.getBoundingClientRect();
        dragClone = dragSection.cloneNode(true);
        dragClone.style.position = 'fixed';
        dragClone.style.left = rect.left + 'px';
        dragClone.style.top = rect.top + 'px';
        dragClone.style.width = rect.width + 'px';
        dragClone.style.zIndex = '9999';
        dragClone.style.opacity = '0.85';
        dragClone.style.boxShadow = '0 4px 16px rgba(0,0,0,0.3)';
        dragClone.style.pointerEvents = 'none';
        dragClone.style.transition = 'none';
        document.body.appendChild(dragClone);

        dragSection.classList.add('cat-dragging');
        containerEl.insertBefore(placeholder, dragSection);
        dragSection.style.display = 'none';

        // ã‚µãƒ–ã‚«ãƒ†ã‚´ãƒªã‚’ãƒ‰ãƒ©ãƒƒã‚°ä¸­ã®å ´åˆã€ãƒ«ãƒ¼ãƒˆãƒ¬ãƒ™ãƒ«æ˜‡æ ¼ç”¨ãƒ‰ãƒ­ãƒƒãƒ—ã‚¾ãƒ¼ãƒ³ã‚’è¡¨ç¤º
        var isSubCategory = dragSection.classList.contains('sub-section')
          || dragSection.classList.contains('sub-sub-section')
          || dragSection.classList.contains('sub-sub-sub-section');
        if (isSubCategory) {
          rootDropZone = document.createElement('div');
          rootDropZone.className = 'root-drop-zone';
          rootDropZone.textContent = '\u25b2 \u5927\u30ab\u30c6\u30b4\u30ea\u3068\u3057\u3066\u79fb\u52d5';
          var clContainer = document.getElementById('checklistContainer');
          clContainer.insertBefore(rootDropZone, clContainer.firstChild);
        }

        document.addEventListener('touchmove', handleCatDragMove, { passive: false });
        document.addEventListener('touchend', handleCatDragEnd);
        document.addEventListener('mousemove', handleCatDragMove);
        document.addEventListener('mouseup', handleCatDragEnd);
      }

      function handleCatDragMove(e) {
        if (!dragSection || !dragClone || !placeholder) return;
        e.preventDefault();
        var touch = e.touches ? e.touches[0] : e;
        dragClone.style.top = (touch.clientY - dragClone.offsetHeight / 2) + 'px';

        var dragCatPath = dragSection.getAttribute('data-category') || '';

        // ãƒ«ãƒ¼ãƒˆãƒ‰ãƒ­ãƒƒãƒ—ã‚¾ãƒ¼ãƒ³ä¸Šã«ã„ã‚‹ã‹æ¤œå‡º
        if (rootDropZone) {
          var rzRect = rootDropZone.getBoundingClientRect();
          if (touch.clientY >= rzRect.top && touch.clientY <= rzRect.bottom && touch.clientX >= rzRect.left && touch.clientX <= rzRect.right) {
            rootDropZone.classList.add('active');
            clearDropIntoHighlight();
            dropIntoTarget = null;
            placeholder.style.display = 'none';
            return;
          } else {
            rootDropZone.classList.remove('active');
          }
        }

        // åˆ¥ã‚«ãƒ†ã‚´ãƒªã®ãƒ˜ãƒƒãƒ€ãƒ¼ä¸Šã«ã„ã‚‹ã‹æ¤œå‡º
        var hitHeader = findDropIntoHeader(touch.clientX, touch.clientY, dragCatPath);
        if (hitHeader) {
          // ã€Œä¸­ã«å…¥ã‚Œã‚‹ã€ãƒ¢ãƒ¼ãƒ‰
          if (!dropIntoTarget || dropIntoTarget.catPath !== hitHeader.catPath) {
            clearDropIntoHighlight();
            dropIntoTarget = hitHeader;
            hitHeader.headerEl.classList.add('cat-drop-into-target');
            placeholder.style.display = 'none';
          }
          return;
        }

        // é€šå¸¸ã®ä¸¦ã³æ›¿ãˆãƒ¢ãƒ¼ãƒ‰
        if (dropIntoTarget) {
          clearDropIntoHighlight();
          dropIntoTarget = null;
          placeholder.style.display = '';
        }

        var sections = Array.prototype.slice.call(
          containerEl.querySelectorAll(siblingSelector)
        ).filter(function(el) { return el !== dragSection; });
        var inserted = false;
        for (var i = 0; i < sections.length; i++) {
          var r = sections[i].getBoundingClientRect();
          var mid = r.top + r.height / 2;
          if (touch.clientY < mid) {
            containerEl.insertBefore(placeholder, sections[i]);
            inserted = true;
            break;
          }
        }
        if (!inserted) {
          var lastSibling = sections[sections.length - 1];
          if (lastSibling && lastSibling.nextSibling) {
            containerEl.insertBefore(placeholder, lastSibling.nextSibling);
          } else {
            var addBtn = containerEl.querySelector(':scope > .category-add-btn, :scope > .section-add-btn');
            if (addBtn) {
              containerEl.insertBefore(placeholder, addBtn);
            } else {
              containerEl.appendChild(placeholder);
            }
          }
        }
      }

      function handleCatDragEnd(e) {
        if (!dragSection || !placeholder) return;
        document.removeEventListener('touchmove', handleCatDragMove);
        document.removeEventListener('touchend', handleCatDragEnd);
        document.removeEventListener('mousemove', handleCatDragMove);
        document.removeEventListener('mouseup', handleCatDragEnd);

        clearDropIntoHighlight();
        var dragCatPath = dragSection.getAttribute('data-category') || '';
        var isRootDrop = rootDropZone && rootDropZone.classList.contains('active');

        // ãƒ«ãƒ¼ãƒˆãƒ‰ãƒ­ãƒƒãƒ—ã‚¾ãƒ¼ãƒ³ã‚’é™¤å»
        if (rootDropZone) { rootDropZone.remove(); rootDropZone = null; }

        // === ãƒ«ãƒ¼ãƒˆãƒ¬ãƒ™ãƒ«ï¼ˆå¤§ã‚«ãƒ†ã‚´ãƒªï¼‰ã«æ˜‡æ ¼ ===
        if (isRootDrop) {
          placeholder.remove();
          dragSection.style.display = '';
          dragSection.classList.remove('cat-dragging');
          if (dragClone) { dragClone.remove(); dragClone = null; }

          var undoSnap = captureUndoSnapshot();
          showSaveStatus('saving');
          gasRunning++;
          google.script.run
            .withSuccessHandler(function(json) {
              gasRunning--;
              try {
                var res = JSON.parse(json);
                if (res.success) {
                  showSaveStatus('saved');
                  setUndo(undoSnap);
                  // ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿ã®ã‚«ãƒ†ã‚´ãƒªãƒ‘ã‚¹ã‚’æ›´æ–°
                  var parts = dragCatPath.split('\uff1a');
                  var catName = parts[parts.length - 1];
                  var newPath = catName;
                  if (checklistData && checklistData.items) {
                    checklistData.items.forEach(function(item) {
                      if (item.category === dragCatPath) {
                        item.category = newPath;
                      } else if (item.category.indexOf(dragCatPath + '\uff1a') === 0) {
                        item.category = newPath + item.category.substring(dragCatPath.length);
                      }
                    });
                  }
                  if (checklistData && checklistData.categoryOrder) {
                    checklistData.categoryOrder.forEach(function(o) {
                      if (o.path === dragCatPath) {
                        o.path = newPath;
                      } else if (o.path.indexOf(dragCatPath + '\uff1a') === 0) {
                        o.path = newPath + o.path.substring(dragCatPath.length);
                      }
                    });
                  }
                  reRenderWithState();
                } else {
                  showSaveStatus('error');
                  alert('\u79fb\u52d5\u306b\u5931\u6557\u3057\u307e\u3057\u305f: ' + (res.error || ''));
                }
              } catch (ex) { showSaveStatus('error'); }
            })
            .withFailureHandler(function() { gasRunning--; showSaveStatus('error'); })
            .moveCategoryToParent(dragCatPath, '');

          dragSection = null; placeholder = null; containerEl = null;
          siblingSelector = null; dropIntoTarget = null;
          return;
        }

        // === åˆ¥ã‚«ãƒ†ã‚´ãƒªå†…ã«ãƒ‰ãƒ­ãƒƒãƒ— ===
        if (dropIntoTarget) {
          placeholder.remove();
          dragSection.style.display = '';
          dragSection.classList.remove('cat-dragging');
          if (dragClone) { dragClone.remove(); dragClone = null; }

          var undoSnap = captureUndoSnapshot();
          var newParentPath = dropIntoTarget.catPath;
          showSaveStatus('saving');
          gasRunning++;
          google.script.run
            .withSuccessHandler(function(json) {
              gasRunning--;
              try {
                var res = JSON.parse(json);
                if (res.success) {
                  showSaveStatus('saved');
                  setUndo(undoSnap);
                  // ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿ã®ã‚«ãƒ†ã‚´ãƒªãƒ‘ã‚¹ã‚’æ›´æ–°
                  var parts = dragCatPath.split('\uff1a');
                  var catName = parts[parts.length - 1];
                  var newPath = newParentPath + '\uff1a' + catName;
                  if (checklistData && checklistData.items) {
                    checklistData.items.forEach(function(item) {
                      if (item.category === dragCatPath) {
                        item.category = newPath;
                      } else if (item.category.indexOf(dragCatPath + '\uff1a') === 0) {
                        item.category = newPath + item.category.substring(dragCatPath.length);
                      }
                    });
                  }
                  if (checklistData && checklistData.categoryOrder) {
                    checklistData.categoryOrder.forEach(function(o) {
                      if (o.path === dragCatPath) {
                        o.path = newPath;
                      } else if (o.path.indexOf(dragCatPath + '\uff1a') === 0) {
                        o.path = newPath + o.path.substring(dragCatPath.length);
                      }
                    });
                  }
                  reRenderWithState();
                } else {
                  showSaveStatus('error');
                  alert('ç§»å‹•ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (res.error || ''));
                }
              } catch (ex) { showSaveStatus('error'); }
            })
            .withFailureHandler(function() { gasRunning--; showSaveStatus('error'); })
            .moveCategoryToParent(dragCatPath, newParentPath);

          dragSection = null; placeholder = null; containerEl = null;
          siblingSelector = null; dropIntoTarget = null;
          return;
        }

        // === é€šå¸¸ã®åŒãƒ¬ãƒ™ãƒ«ä¸¦ã³æ›¿ãˆ ===
        placeholder.parentElement.insertBefore(dragSection, placeholder);
        dragSection.style.display = '';
        dragSection.classList.remove('cat-dragging');
        placeholder.remove();
        if (dragClone) { dragClone.remove(); dragClone = null; }

        // å…¨å­è¦ç´ ï¼ˆé …ç›®ï¼‹ã‚«ãƒ†ã‚´ãƒªï¼‰ã®çµ±ä¸€sortOrderã‚’è¨ˆç®—
        var parentBody = dragSection.closest('.section-body') || document.getElementById('checklistContainer');
        var allChildren = Array.prototype.slice.call(
          parentBody.querySelectorAll(':scope > .checklist-item, :scope > .section')
        );
        var itemOrders = [];
        var catOrders = [];
        for (var i = 0; i < allChildren.length; i++) {
          var child = allChildren[i];
          var sortVal = i + 1;
          if (child.classList.contains('checklist-item')) {
            var itemId = child.getAttribute('data-item-id');
            if (itemId) {
              itemOrders.push({ id: itemId, sortOrder: sortVal });
              child.setAttribute('data-sort-order', sortVal);
            }
          } else if (child.classList.contains('section')) {
            var cp = child.getAttribute('data-category');
            if (cp) catOrders.push({ path: cp, sortOrder: sortVal });
          }
        }

        // UNDOç”¨ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆï¼ˆãƒ­ãƒ¼ã‚«ãƒ«æ›´æ–°å‰ã«å–å¾—ï¼‰
        var undoSnap = captureUndoSnapshot();

        // ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°
        if (checklistData) {
          if (itemOrders.length > 0 && checklistData.items) {
            var iMap = {};
            itemOrders.forEach(function(o) { iMap[o.id] = o.sortOrder; });
            checklistData.items.forEach(function(item) {
              if (iMap[item.id] !== undefined) item.sortOrder = iMap[item.id];
            });
          }
          if (catOrders.length > 0) {
            if (!checklistData.categoryOrder) checklistData.categoryOrder = [];
            var existingMap = {};
            checklistData.categoryOrder.forEach(function(o, idx) { existingMap[o.path] = idx; });
            catOrders.forEach(function(o) {
              var idx = existingMap[o.path];
              if (idx !== undefined) {
                checklistData.categoryOrder[idx].sortOrder = o.sortOrder;
              } else {
                checklistData.categoryOrder.push(o);
              }
            });
          }
        }

        // ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã«ä¿å­˜ï¼ˆé …ç›®ï¼‹ã‚«ãƒ†ã‚´ãƒªä¸¡æ–¹ï¼‰
        if (itemOrders.length > 0 || catOrders.length > 0) {
          showSaveStatus('saving');
          var catPending = 0;
          var catAnyErr = false;
          function onCatReorderDone() {
            catPending--;
            if (catPending <= 0) {
              showSaveStatus(catAnyErr ? 'error' : 'saved');
              if (!catAnyErr) setUndo(undoSnap);
            }
          }
          if (itemOrders.length > 0) {
            catPending++; gasRunning++;
            google.script.run
              .withSuccessHandler(function(json) {
                gasRunning--;
                try { var res = JSON.parse(json); if (!res.success) catAnyErr = true; } catch (e) { catAnyErr = true; }
                onCatReorderDone();
              })
              .withFailureHandler(function() { gasRunning--; catAnyErr = true; onCatReorderDone(); })
              .reorderChecklistItems(itemOrders);
          }
          if (catOrders.length > 0) {
            catPending++; gasRunning++;
            google.script.run
              .withSuccessHandler(function(json) {
                gasRunning--;
                try { var res = JSON.parse(json); if (!res.success) catAnyErr = true; } catch (e) { catAnyErr = true; }
                onCatReorderDone();
              })
              .withFailureHandler(function() { gasRunning--; catAnyErr = true; onCatReorderDone(); })
              .reorderCategories(catOrders);
          }
          if (catPending === 0) showSaveStatus('saved');
        }

        dragSection = null; placeholder = null; containerEl = null;
        siblingSelector = null; dropIntoTarget = null;
      }

      // ã‚¤ãƒ™ãƒ³ãƒˆå§”ä»»ã§ãƒã‚¤ãƒ³ãƒ‰ï¼ˆé•·æŠ¼ã—é–‹å§‹ï¼‰
      document.addEventListener('touchstart', function(e) {
        if (e.target.closest('.cat-drag-handle')) onCatHandlePress(e);
      }, { passive: false });
      document.addEventListener('mousedown', function(e) {
        if (e.target.closest('.cat-drag-handle')) onCatHandlePress(e);
      });
    })();
  </script>
</body>
</html>
