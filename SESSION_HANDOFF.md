# セッション引き継ぎファイル

> **最終更新**: 2026-02-26
> **作業ブランチ**: `claude/review-handoff-docs-5WgKR`（最新デプロイ対象）
> **最新コミット**: `7825fe8 docs: CLAUDE.md を引き継ぎ資料テンプレートに準じて全面更新`

---

## 必須ルール（全セッション共通・厳守）

### ルール1: 変更プッシュ後は毎回デプロイ手順を表示すること

コードを変更してプッシュしたら、**必ず毎回**以下のデプロイコマンドを表示する。
ブランチ名は、**現在の作業ブランチに合わせて随時書き換えること**。
チェックアプリ（`checklist-app/`）に変更がある場合も `deploy-all.js` で両方デプロイされるので同じコマンドでOK。

```
cd C:\Users\yamas\minpaku-fix && git fetch origin && git checkout -f <現在の作業ブランチ名> && git reset --hard origin/<現在の作業ブランチ名> && node deploy-all.js
```

**現時点のコマンド（これをそのままコピペ！）:**
```
cd C:\Users\yamas\minpaku-fix && git fetch origin && git checkout -f claude/review-handoff-docs-5WgKR && git reset --hard origin/claude/review-handoff-docs-5WgKR && node deploy-all.js
```

### ルール2: 会話の圧縮が必要になったら新チャットへ移行を提案すること

会話の内容を圧縮する必要が出てきた場合（コンテキストが長くなりすぎた場合）、**引き継ぎ資料を作成して新チャットへの移行を提案すること**。
移行時には以下を実行：
1. `SESSION_HANDOFF.md` を最新状態に更新（完了作業・未完了事項・コミット履歴）
2. `HANDOFF.md` も必要に応じて更新
3. コミット＆プッシュ
4. **このルールセクション（「必須ルール」全体）を新チャットの引き継ぎ資料にも必ず含めること**

### ルール3: 常に日本語で応答すること

### ルール4: 新チャット移行時にこの必須ルールを必ず引き継ぐこと

新チャットへ移行する際、`SESSION_HANDOFF.md` の **「必須ルール」セクション全体**（ルール1〜6すべて）を必ず含めること。ルールの欠落は厳禁。

### ルール5: 新チャットは引き継ぎ確認→質問→回答待ち→作業開始の順を守ること

新チャットは以下の手順を**必ず守ること**：
1. 引き継ぎ資料（`SESSION_HANDOFF.md` + `HANDOFF.md`）を読んで内容を確認する
2. 前のチャットへの質問事項があれば、**ユーザーが一括コピペできるプロンプト**を作成する
3. **ユーザーからの返答を待ってから**次の作業にとりかかること（質問がなければすぐ開始してOK）

### ルール6: 引き継ぎ資料作成時に以下の5項目を必ず含めること

チャット移行時に `SESSION_HANDOFF.md` / `HANDOFF.md` を更新する際、**以下の5項目は必須**とする。省略厳禁。

1. **現在取り組んでいるタスク・機能の説明** — 今何をやっているか、どこまで進んだか
2. **完了した作業と未完了の作業** — 完了済み一覧＋未完了タスクの具体的なリスト
3. **既知のバグや注意点** — デプロイ後に確認が必要な問題、ハマりポイント
4. **次のセッションでやるべきこと** — 優先度付きのTODOリスト
5. **コードの変更箇所のサマリー** — どのファイルのどの部分を変更したか（コミットハッシュ付き）

---

## チャット移行の手順

### 旧チャット側（移行前）がやること

1. 作業中のコードをすべてコミット＆プッシュ
2. `SESSION_HANDOFF.md` を以下の内容で更新：
   - **「必須ルール」セクション全体**（ルール1〜6）← 絶対に省略しない
   - **ルール6の必須5項目を必ず含めること**:
     1. 現在取り組んでいるタスク・機能の説明
     2. 完了した作業と未完了の作業
     3. 既知のバグや注意点
     4. 次のセッションでやるべきこと
     5. コードの変更箇所のサマリー（どのファイルのどの部分を変更したか）
   - 最新コミットハッシュとブランチ名
3. `HANDOFF.md` のコミット履歴・完了作業セクションを最新化
4. 更新をコミット＆プッシュ

### 新チャット側がやること

**ステップ1: 引き継ぎ資料を読む**
```
SESSION_HANDOFF.md を読んでください
HANDOFF.md を読んでください
```

**ステップ2: ブランチとコードの状態を確認**
```
git fetch origin <作業ブランチ>
git log origin/<作業ブランチ> --oneline -10
```

**ステップ3: 疑問点を洗い出し、前のチャットへの質問プロンプトを作成（重要）**

引き継ぎ資料を読んだ後、不明点や確認事項があれば、以下のような形式で **前のチャットに貼り付けるための質問プロンプト** を作成する。
**ユーザーがそのままコピペできる形式**にすること：

```
前のチャットで以下を確認してください：

1. 「〇〇の実装」について、△△の部分はこの理解で合っていますか？
2. □□の機能は完了していますか？テスト済みですか？
3. ××のエラーが出ていましたが、解決済みですか？
4. この部分を変更しても他に影響はありませんか？
```

ユーザーはこのプロンプトをコピーして前のチャットに貼り付け、回答を得てから新チャットに戻る。

**ステップ4: ユーザーの返答を待つ**

質問プロンプトを出した場合は、**ユーザーからの返答を待ってから**開発を開始する。
質問がない場合はその旨を伝え、すぐに開発を開始してOK。

---

## 必須デプロイコマンド（ユーザーのWindows PCで実行）

**方式A: deploy-all.bat をダブルクリック（推奨）**
- 現在のローカルブランチのコードを自動pullしてデプロイ
- 初回のみ `git checkout <ブランチ名>` が必要（以降は不要）

**方式B: コマンド1行で実行**
```
cd C:\Users\yamas\minpaku-fix && git fetch origin && git checkout -f claude/review-handoff-docs-5WgKR && git reset --hard origin/claude/review-handoff-docs-5WgKR && node deploy-all.js
```

---

## 最新セッションで完了した作業

### 2026-02-26: スタッフ回答状況バグ修正 + CLAUDE.md全面更新

1. **スタッフ回答状況「未回答」表示バグの修正** — 4つのバグの連鎖が原因
   - バグ1: `getRecruitmentStatusMap()` が重複エントリを無条件上書き → 回答データ優先ロジック追加
   - バグ2: `checkAndCreateRecruitments()` がソート後に重複募集エントリ作成 → チェックアウト日ベース重複防止
   - バグ3: `syncRecruitBookingRowsAfterSort_()` が同日複数予約に非対応 → 配列管理+使用済み追跡
   - バグ4: `getLastRow()` off-by-oneエラー → 13関数を `getLastRow() - 1` に統一
   - **コミット**: a65cd5c
2. **CLAUDE.md を引き継ぎ資料テンプレートに準じて全面再構成**
   - **コミット**: 7825fe8

### 2026-02-24: 請求書要請メール・通知修正

1. **請求書要請メール機能** — デフォルト送信無し、オーナーが任意で送信可能
   - **コミット**: 7b3ff9d
2. **名簿通知誤検知・スタッフ回答状況ズレ修正** — 通知タブ表示不具合も併せて修正、請求書テスト送信に宛先指定追加
   - **コミット**: caa4991

### 2026-02-23: オーナーURL問題・テスト環境

1. **オーナーURL消え問題の根本修正** — 非同期コールバック競合を5段階で修正（v0223c〜g）
   - **コミット**: 03a5ed3, 025d0b7, 055b743, 37588eb, 47a7053
2. **取消申請サイレント失敗修正** — ReferenceError修正 + オーナーURL保存の堅牢化
   - **コミット**: dd31746, 34cb049
3. **Playwright自動テストスクリプト** — Python + Excel出力
   - **コミット**: 63756c7
4. **iPhone写真撮影ブラックアウト修正** — `capture="environment"` 属性を削除
   - **コミット**: 07a0dc8
5. **請求書メール送信結果UI表示**
   - **コミット**: f18d0c4

### 2026-02-22: パフォーマンス最適化

1. **CacheServiceでスタッフリストキャッシュ（600秒）+ CDN事前接続**
   - **コミット**: ce4faf2
2. **getInitData() 90秒キャッシュ**（チャンク分割対応）
   - **コミット**: 553ec5d
3. **モーダル最適化** — キャッシュ活用で軽量API呼び出し
   - **コミット**: 8f0ac36
4. **オーナーURL永続化（3層キャッシュ）**
   - **コミット**: 28a38ce
5. **取消申請がオーナーに届かない問題修正**
   - **コミット**: ae650f0
6. **通知パネルクラッシュ修正 + iCal同期ブロック日誤認修正**
   - **コミット**: 06ae8ba, 59ba790

### 2026-02-21: 通知改善・閲覧専用URL

1. **テキストコピー/メールURLの最新化**、**通知タブ期間フィルタ+自動削除**
2. **閲覧専用URL (`?view=readonly`)** + **設定タブにURL一覧サブタブ新設**
3. **カレンダー今日枠のダークモード対応**（box-shadow方式）
4. **宿泊者名簿未記入通知の重複・誤検知修正**
   - **コミット**: 8ebf5e6〜e841703

### 2026-02-19〜20: 募集同期・メール重複防止・ゲートウェイ

1. **ゲートウェイデプロイメント（URL永続化）** — リダイレクト→直接表示方式に変更
2. **メール重複送信防止** — LockService + PropertiesService
3. **募集シートの行番号同期** — ソート後の行番号ズレを根本対策
4. **孤立した募集エントリの自動修復**
5. **メール通知ON/OFF設定リセット問題修正**（型変換バグ）
6. **出勤一覧4月表示問題修正** — rBookingRow優先
7. **スタッフ名変更時の全関連シート自動伝播**
8. **ダークモード見出し視認性改善**
   - **コミット**: 383c3a5〜59f2c0d

---

## 未完了・要確認事項

### 要確認（デプロイ後）

1. **スタッフ回答状況表示の確認** — 過去の日付のスタッフ回答状況が正しく表示されるか
2. **`募集` シートの重複エントリクリーンアップ** — 既存の重複を検出・統合するユーティリティ関数の作成（任意）
3. **残りの `getLastRow()` off-by-one修正** — 主要13関数は修正済み、補助関数にも展開（任意）
4. **スタッフ選択の複数端末同期テスト** — 粘着ユニオン問題の解消確認
5. **メール重複送信防止の動作確認** — トリガーセットアップボタン、リマインドメール1通のみ届くか

### 既知の課題

- **`募集` シートの既存重複エントリ** — 新規作成は防止済み。表示上は回答データ優先ロジックで修正済み
- **オーナーURL消え問題** — v0223c〜g で根本修正済み。再発時は非同期コールバック競合を疑う

### 将来の課題
- 条件分岐対応（BBQ利用あり/なし、宿泊人数による表示切替）
- 在庫管理リスト機能
- リネン洗濯フロー管理

---

## 主要ファイル構成

| ファイル | 行数（概算） | 役割 |
|----------|-------------|------|
| `Code.gs` | ~9665行 | メインアプリ（予約管理）サーバー |
| `index.html` | ~8447行 | メインアプリ フロントエンド |
| `checklist-app/Code.gs` | ~2947行 | チェックリストアプリ サーバー |
| `checklist-app/checklist.html` | ~5788行 | チェックリストアプリ フロントエンド |
| `deploy-all.js` | ~340行 | 一括デプロイスクリプト |
| `staff-manual.html` | ~884行 | スタッフ操作マニュアル |
| `CLAUDE.md` | プロジェクト全体の技術資料・引き継ぎ情報 |

---

## 技術的な注意点

### スタッフ選択の複数端末同期（最重要）
```
データフロー:
1. 端末がページ読込 → getChecklistForDate(date, deviceId) で自分の選択を取得
2. スタッフ選択/解除 → applyStaffSelection() でローカル反映 + GASにsave
3. GAS側 getStaffSelectionDetailed_() で全端末の選択をマージ
4. 60秒ポーリングで他端末の選択も反映（remoteStaffInfo表示）

粘着ユニオン問題の修正:
- 旧: 全端末の選択をunionして返す → 一度選んだスタッフが外せない
- 新: deviceId別に選択状態を管理 → 各端末の解除が正しく反映される
```

### 清掃ステータスマークの仕組み
```
カレンダーのステータスドット色:
- 赤(recruiting): 募集中で未確定
- 緑(decided): スタッフ確定済み or 選定済 or cleaningStaff設定済み

データフロー:
1. loadAndRender() → getRecruitmentStatusMap() → window._recruitFullMap
2. buildCalendarEvents() で recruitMap[b.rowNumber].status をチェック
3. 確定時に applyConfirmOptimistic() で楽観的にキャッシュ更新＋カレンダー再描画
```

### カテゴリの区切り文字
- 全角コロン `：`（U+FF1A）を使用
- 例: `テラス：次の予約がBBQ利用あり：↓セット内容↓`

### レンダリングの仕組み
- `buildCategoryTree()` が全アイテムをツリー構造に変換
- `renderCategoryNode()` が再帰的にHTMLを生成
- レベル0=`.section`（濃紺）、1=`.sub-section`（薄青）、2=`.sub-sub-section`（オレンジ）、3=`.sub-sub-sub-section`（紫）
