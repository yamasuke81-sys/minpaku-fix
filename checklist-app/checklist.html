<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>æ¸…æƒãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      background: #f5f5f5;
      color: #333;
      padding-bottom: 80px;
      -webkit-tap-highlight-color: transparent;
    }

    /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
    .header {
      background: #2c3e50;
      color: white;
      padding: 12px 16px;
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .header-top {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }
    .header-left { flex: 1; }
    .header-title { font-size: 18px; font-weight: bold; margin-bottom: 4px; }
    .header-date { font-size: 14px; opacity: 0.9; }
    .progress-bar {
      height: 6px;
      background: rgba(255,255,255,0.2);
      border-radius: 3px;
      margin-top: 8px;
      overflow: hidden;
    }
    .progress-fill {
      height: 100%;
      background: #27ae60;
      transition: width 0.3s;
      border-radius: 3px;
    }

    /* ã‚¹ã‚¿ãƒƒãƒ•é¸æŠ */
    .staff-selector {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 4px;
    }
    .staff-row {
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .staff-select {
      padding: 4px 8px;
      border-radius: 4px;
      border: 1px solid rgba(255,255,255,0.3);
      background: rgba(255,255,255,0.15);
      color: white;
      font-size: 13px;
      max-width: 120px;
    }
    .staff-select option { color: #333; background: white; }
    .staff-add-btn, .staff-remove-btn {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      border: 1px solid rgba(255,255,255,0.4);
      background: transparent;
      color: white;
      font-size: 16px;
      line-height: 1;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .staff-remove-btn { font-size: 14px; }

    /* ã‚¿ãƒ–ãƒŠãƒ“ */
    .tab-nav {
      display: flex;
      background: white;
      border-bottom: 2px solid #ecf0f1;
      position: sticky;
      top: 0;
      z-index: 90;
    }
    .tab-nav-btn {
      flex: 1;
      padding: 12px 8px;
      border: none;
      background: white;
      font-size: 14px;
      font-weight: bold;
      color: #7f8c8d;
      cursor: pointer;
      border-bottom: 3px solid transparent;
      transition: all 0.2s;
    }
    .tab-nav-btn.active {
      color: #2c3e50;
      border-bottom-color: #3498db;
    }
    .tab-nav-btn .tab-badge {
      display: inline-block;
      padding: 1px 6px;
      border-radius: 10px;
      font-size: 11px;
      font-weight: bold;
      margin-left: 4px;
      vertical-align: middle;
    }
    .tab-badge-warning {
      background: #ffc107;
      color: #856404;
    }
    .tab-content { display: none; }
    .tab-content.active { display: block; }

    /* æ¬¡å›äºˆç´„æƒ…å ± */
    .booking-info {
      background: white;
      margin: 12px;
      padding: 16px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .booking-info h3 {
      font-size: 16px;
      color: #2c3e50;
      margin-bottom: 12px;
      padding-bottom: 8px;
      border-bottom: 2px solid #3498db;
    }
    .booking-row {
      display: flex;
      padding: 6px 0;
      font-size: 14px;
    }
    .booking-label {
      font-weight: bold;
      min-width: 100px;
      color: #555;
    }
    .booking-value {
      flex: 1;
      color: #333;
    }

    /* ã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆéƒ¨å±‹ã”ã¨ï¼‰ */
    .section {
      background: white;
      margin: 8px 12px;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 4px rgba(0,0,0,0.08);
    }
    .section-header {
      padding: 14px 16px;
      background: #ecf0f1;
      display: flex;
      align-items: center;
      cursor: pointer;
      user-select: none;
      -webkit-user-select: none;
      transition: background 0.2s;
    }
    .section-header:active {
      background: #d5dbdd;
    }
    .section-header.has-missing {
      background: #ffe6e6;
    }
    .section-icon {
      font-size: 20px;
      margin-right: 8px;
      transition: transform 0.3s;
    }
    .section-header.collapsed .section-icon {
      transform: rotate(-90deg);
    }
    .section-title {
      flex: 1;
      font-size: 16px;
      font-weight: bold;
      color: #2c3e50;
    }
    .section-title.missing {
      color: #e74c3c;
    }
    .section-count {
      font-size: 13px;
      color: #7f8c8d;
      margin-left: 8px;
    }
    .section-body {
      max-height: 2000px;
      overflow: hidden;
      transition: max-height 0.3s ease-out;
    }
    .section-body.collapsed {
      max-height: 0;
    }

    /* ä¸­ã‚«ãƒ†ã‚´ãƒªï¼ˆã‚µãƒ–ã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼‰ */
    .sub-section {
      margin-left: 12px;
      border-left: 3px solid #3498db;
    }
    .sub-section .section-header {
      padding: 10px 14px;
      background: #f0f4f8;
      font-size: 14px;
    }
    .sub-section .section-header:active {
      background: #dce3ea;
    }
    .sub-section .section-header.has-missing {
      background: #fff0f0;
    }
    .sub-section .section-title {
      font-size: 14px;
      font-weight: 600;
    }
    .sub-section .section-count {
      font-size: 12px;
    }

    /* ã‚»ã‚¯ã‚·ãƒ§ãƒ³ãƒ˜ãƒƒãƒ€ãƒ¼å†…ãƒœã‚¿ãƒ³ */
    .section-header-btn {
      padding: 4px 10px;
      border: 1px solid;
      border-radius: 4px;
      background: transparent;
      font-size: 11px;
      font-weight: bold;
      cursor: pointer;
      margin-left: 6px;
      white-space: nowrap;
    }
    .section-check-all {
      border-color: #27ae60;
      color: #27ae60;
    }
    .section-check-all:active { background: #eafaf1; }
    .section-photo-btn {
      border-color: #e67e22;
      color: #e67e22;
    }
    .section-photo-btn:active { background: #fef5ed; }

    /* ãƒã‚§ãƒƒã‚¯é …ç›® */
    .checklist-item {
      padding: 12px 16px;
      border-bottom: 1px solid #ecf0f1;
      display: flex;
      align-items: flex-start;
      gap: 12px;
    }
    .checklist-item:last-child {
      border-bottom: none;
    }
    .item-checkbox {
      width: 24px;
      height: 24px;
      min-width: 24px;
      cursor: pointer;
      margin-top: 2px;
    }
    .item-content {
      flex: 1;
    }
    .item-name {
      font-size: 15px;
      color: #333;
      line-height: 1.5;
    }
    .item-name.missing {
      color: #e74c3c;
      font-weight: bold;
    }
    .supply-checkbox-container {
      margin-top: 6px;
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 13px;
      color: #7f8c8d;
    }
    .supply-checkbox {
      width: 18px;
      height: 18px;
      cursor: pointer;
    }

    /* æ’®å½±ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
    .photo-section {
      background: white;
      margin: 8px 12px;
      padding: 16px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.08);
    }
    .photo-section h3 {
      font-size: 16px;
      color: #2c3e50;
      margin-bottom: 12px;
      padding-bottom: 8px;
      border-bottom: 2px solid #e67e22;
    }
    .photo-spot {
      margin-bottom: 16px;
      padding: 12px;
      background: #fafafa;
      border-radius: 6px;
    }
    .photo-spot-name {
      font-size: 14px;
      font-weight: bold;
      margin-bottom: 8px;
      color: #2c3e50;
    }
    .photo-spot-name.missing {
      color: #e74c3c;
    }
    .photo-timing-group {
      margin-bottom: 12px;
    }
    .photo-timing-label {
      font-size: 13px;
      color: #555;
      margin-bottom: 6px;
      font-weight: bold;
    }
    .photo-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
      gap: 8px;
      margin-bottom: 8px;
    }
    .photo-thumb {
      width: 100%;
      padding-bottom: 100%;
      background-size: cover;
      background-position: center;
      border-radius: 4px;
      border: 1px solid #ddd;
    }
    .photo-upload-btn {
      padding: 8px 12px;
      background: #3498db;
      color: white;
      border: none;
      border-radius: 4px;
      font-size: 13px;
      cursor: pointer;
      width: 100%;
    }
    .photo-upload-btn:active {
      background: #2980b9;
    }

    /* è¦è£œå……ãƒªã‚¹ãƒˆï¼ˆã‚¿ãƒ–ç”¨ï¼‰ */
    .supply-tab-content {
      padding: 12px;
    }
    .supply-list-card {
      background: #fff3cd;
      padding: 16px;
      border-radius: 8px;
      border-left: 4px solid #ffc107;
    }
    .supply-list-card h3 {
      font-size: 16px;
      color: #856404;
      margin-bottom: 12px;
    }
    .supply-item {
      padding: 8px 12px;
      font-size: 14px;
      color: #856404;
      background: rgba(255,255,255,0.5);
      border-radius: 4px;
      margin-bottom: 6px;
    }
    .supply-item:before {
      content: "\26A0\FE0F ";
    }
    .supply-empty {
      text-align: center;
      padding: 40px 20px;
      color: #7f8c8d;
      font-size: 14px;
    }

    /* ãƒ¡ãƒ¢ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
    .memo-section {
      background: white;
      margin: 8px 12px;
      padding: 16px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.08);
    }
    .memo-section h3 {
      font-size: 16px;
      color: #2c3e50;
      margin-bottom: 12px;
    }
    .memo-list {
      margin-bottom: 12px;
    }
    .memo-item {
      background: #f8f9fa;
      padding: 10px;
      border-radius: 4px;
      margin-bottom: 8px;
      font-size: 14px;
    }
    .memo-meta {
      font-size: 12px;
      color: #7f8c8d;
      margin-top: 4px;
    }
    .memo-input-group {
      display: flex;
      gap: 8px;
    }
    .memo-input {
      flex: 1;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
    }
    .memo-btn {
      padding: 10px 16px;
      background: #3498db;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      white-space: nowrap;
    }

    /* ãƒœãƒˆãƒ ãƒãƒ¼ */
    .bottom-bar {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: white;
      padding: 12px;
      box-shadow: 0 -2px 8px rgba(0,0,0,0.1);
      display: flex;
      gap: 8px;
      z-index: 99;
    }
    .btn {
      flex: 1;
      padding: 14px;
      border: none;
      border-radius: 6px;
      font-size: 15px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s;
    }
    .btn-check {
      background: #e67e22;
      color: white;
    }
    .btn-check:active {
      background: #d35400;
    }
    .btn-complete {
      background: #27ae60;
      color: white;
    }
    .btn-complete:active {
      background: #229954;
    }
    .btn-complete:disabled {
      background: #95a5a6;
      cursor: not-allowed;
    }

    /* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° */
    .loading {
      text-align: center;
      padding: 40px 20px;
      color: #7f8c8d;
    }

    /* å…¨ä½“æ“ä½œãƒãƒ¼ */
    .action-bar {
      display: flex;
      gap: 8px;
      margin: 12px 12px 4px;
    }
    .action-btn {
      padding: 8px 14px;
      border: 1px solid #bdc3c7;
      border-radius: 6px;
      background: white;
      font-size: 13px;
      font-weight: bold;
      color: #2c3e50;
      cursor: pointer;
    }
    .action-btn:active { background: #ecf0f1; }
    .action-btn-check {
      border-color: #27ae60;
      color: #27ae60;
    }
    .action-btn-check.is-all-checked {
      border-color: #e74c3c;
      color: #e74c3c;
    }
    .action-btn-check:active { background: #eafaf1; }

    /* ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ */
    .hidden { display: none !important; }

    input[type="file"] {
      display: none;
    }

    /* ã‚«ãƒ†ã‚´ãƒªæ’®å½±ãƒ¢ãƒ¼ãƒ€ãƒ« */
    .photo-modal-overlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 200;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    .photo-modal {
      background: white;
      border-radius: 12px;
      width: 100%;
      max-width: 400px;
      max-height: 80vh;
      overflow-y: auto;
      padding: 20px;
    }
    .photo-modal h3 {
      font-size: 16px;
      margin-bottom: 16px;
      color: #2c3e50;
    }
    .photo-modal-close {
      padding: 10px;
      width: 100%;
      border: 1px solid #bdc3c7;
      border-radius: 6px;
      background: white;
      font-size: 14px;
      cursor: pointer;
      margin-top: 12px;
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="header-top">
      <div class="header-left">
        <div class="header-title">æ¸…æƒãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ</div>
        <div class="header-date" id="headerDate"></div>
      </div>
      <div class="staff-selector" id="staffSelector">
        <div class="staff-row">
          <select class="staff-select" id="staffSelect0"></select>
          <button class="staff-add-btn" onclick="addStaffRow()" title="ã‚¹ã‚¿ãƒƒãƒ•è¿½åŠ ">+</button>
        </div>
      </div>
    </div>
    <div class="progress-bar">
      <div class="progress-fill" id="progressFill" style="width: 0%"></div>
    </div>
  </div>

  <div id="loadingArea" class="loading">èª­ã¿è¾¼ã¿ä¸­...</div>

  <div id="contentArea" class="hidden">
    <!-- æ¬¡å›äºˆç´„æƒ…å ± -->
    <div id="bookingInfo" class="booking-info hidden"></div>

    <!-- ã‚¿ãƒ–ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
    <div class="tab-nav" id="tabNav">
      <button class="tab-nav-btn active" data-tab="checklist" onclick="switchTab('checklist')">ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ</button>
      <button class="tab-nav-btn" data-tab="supply" onclick="switchTab('supply')">è¦è£œå……<span id="supplyBadge" class="tab-badge tab-badge-warning hidden">0</span></button>
      <button class="tab-nav-btn" data-tab="photo" onclick="switchTab('photo')">æ’®å½±</button>
    </div>

    <!-- ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆã‚¿ãƒ– -->
    <div id="tabChecklist" class="tab-content active">
      <!-- å…¨ä½“æ“ä½œãƒãƒ¼ -->
      <div class="action-bar">
        <button id="btnExpandAll" class="action-btn" onclick="toggleAllSections()">å…¨ã¦å±•é–‹</button>
        <button id="btnCheckAll" class="action-btn action-btn-check" onclick="checkAllItems()">å…¨ãƒã‚§ãƒƒã‚¯</button>
      </div>

      <!-- ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ -->
      <div id="checklistContainer"></div>

      <!-- ãƒ¡ãƒ¢ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
      <div id="memoSection" class="memo-section">
        <h3>ğŸ“ ç‰¹è¨˜äº‹é …ãƒ»å‚™å“ä¸è¶³ãªã©</h3>
        <div id="memoList" class="memo-list"></div>
        <div class="memo-input-group">
          <input type="text" id="memoInput" class="memo-input" placeholder="å‚™å“ä¸è¶³ã‚„ãƒ¡ãƒ¢ã‚’å…¥åŠ›...">
          <button id="memoBtn" class="memo-btn">é€ä¿¡</button>
        </div>
      </div>
    </div>

    <!-- è¦è£œå……ã‚¿ãƒ– -->
    <div id="tabSupply" class="tab-content">
      <div class="supply-tab-content">
        <div id="supplyListContent"></div>
      </div>
    </div>

    <!-- æ’®å½±ã‚¿ãƒ– -->
    <div id="tabPhoto" class="tab-content">
      <div id="photoSection"></div>
    </div>
  </div>

  <!-- ãƒœãƒˆãƒ ãƒãƒ¼ -->
  <div class="bottom-bar">
    <button id="btnCheckMissing" class="btn btn-check">æ¼ã‚Œãƒã‚§ãƒƒã‚¯</button>
    <button id="btnComplete" class="btn btn-complete">æ¸…æƒå®Œäº†</button>
  </div>

  <!-- éè¡¨ç¤ºã®ãƒ•ã‚¡ã‚¤ãƒ«å…¥åŠ› -->
  <input type="file" id="photoInput" accept="image/*" capture="environment">

  <script>
    // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
    var checkoutDate = '<?= checkoutDate ?>' || '';
    var staffName = '<?= staffName ?>' || '';
    var checklistData = null;
    var bookingData = null;
    var missingCheckActive = false;
    var staffList = [];
    var staffRowCount = 1;

    // åˆæœŸåŒ–
    window.onload = function() {
      if (!checkoutDate) {
        alert('ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆæ—¥ãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“');
        return;
      }
      document.getElementById('headerDate').textContent = checkoutDate;
      loadData();
      loadStaffList();

      // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
      document.getElementById('btnCheckMissing').addEventListener('click', toggleMissingCheck);
      document.getElementById('btnComplete').addEventListener('click', completeChecklist);
      document.getElementById('memoBtn').addEventListener('click', addMemo);
      document.getElementById('photoInput').addEventListener('change', handlePhotoUpload);
    };

    // === ã‚¹ã‚¿ãƒƒãƒ•é¸æŠ ===
    function loadStaffList() {
      callGAS('getCleaningStaffList', []).then(function(res) {
        if (res.success && res.list) {
          staffList = res.list;
          populateStaffSelects();
        }
      }).catch(function() {});
    }

    function populateStaffSelects() {
      var selects = document.querySelectorAll('.staff-select');
      selects.forEach(function(sel) {
        var currentVal = sel.value;
        sel.innerHTML = '<option value="">-- é¸æŠ --</option>';
        staffList.forEach(function(name) {
          var opt = document.createElement('option');
          opt.value = name;
          opt.textContent = name;
          sel.appendChild(opt);
        });
        // åˆæœŸé¸æŠ: URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®staffNameã«ä¸€è‡´ã™ã‚‹ã‚‚ã®ãŒã‚ã‚Œã°é¸æŠ
        if (!currentVal && staffName) {
          sel.value = staffName;
        } else if (currentVal) {
          sel.value = currentVal;
        }
      });
    }

    function addStaffRow() {
      var container = document.getElementById('staffSelector');
      var idx = staffRowCount;
      staffRowCount++;
      var row = document.createElement('div');
      row.className = 'staff-row';
      row.id = 'staffRow' + idx;
      row.innerHTML = '<select class="staff-select" id="staffSelect' + idx + '"></select>' +
        '<button class="staff-remove-btn" onclick="removeStaffRow(' + idx + ')" title="å‰Šé™¤">âœ•</button>';
      container.appendChild(row);
      populateStaffSelects();
    }

    function removeStaffRow(idx) {
      var row = document.getElementById('staffRow' + idx);
      if (row) row.remove();
    }

    function getSelectedStaffNames() {
      var names = [];
      document.querySelectorAll('.staff-select').forEach(function(sel) {
        var v = sel.value.trim();
        if (v && names.indexOf(v) === -1) names.push(v);
      });
      return names;
    }

    // === ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ ===
    function switchTab(tabName) {
      document.querySelectorAll('.tab-nav-btn').forEach(function(btn) {
        btn.classList.toggle('active', btn.getAttribute('data-tab') === tabName);
      });
      document.querySelectorAll('.tab-content').forEach(function(tc) {
        tc.classList.remove('active');
      });
      var target = document.getElementById('tab' + tabName.charAt(0).toUpperCase() + tabName.slice(1));
      if (target) target.classList.add('active');
    }

    // === ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ ===
    function loadData() {
      Promise.all([
        callGAS('getNextBookingDetails', [checkoutDate]),
        callGAS('getChecklistForDate', [checkoutDate])
      ]).then(function(results) {
        var bookingRes = results[0];
        var checklistRes = results[1];

        if (bookingRes.success) {
          bookingData = bookingRes.booking;
          renderBookingInfo();
        }

        if (checklistRes.success) {
          checklistData = checklistRes;
          renderChecklist();
          renderPhotoSection();
          renderMemos();
          renderSupplyList();
          updateProgress();
        } else {
          alert('ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + checklistRes.error);
        }

        document.getElementById('loadingArea').classList.add('hidden');
        document.getElementById('contentArea').classList.remove('hidden');
      }).catch(function(err) {
        alert('ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + err);
      });
    }

    function renderBookingInfo() {
      if (!bookingData) return;
      var html = '<h3>ğŸ“… æ¬¡å›äºˆç´„è©³ç´°</h3>';
      html += '<div class="booking-row"><span class="booking-label">ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³</span><span class="booking-value">' + escapeHtml(bookingData.checkIn) + '</span></div>';
      html += '<div class="booking-row"><span class="booking-label">ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ</span><span class="booking-value">' + escapeHtml(bookingData.checkOut) + '</span></div>';
      if (bookingData.guestName) html += '<div class="booking-row"><span class="booking-label">å®¿æ³Šè€…å</span><span class="booking-value">' + escapeHtml(bookingData.guestName) + '</span></div>';
      if (bookingData.guestCount) html += '<div class="booking-row"><span class="booking-label">äººæ•°</span><span class="booking-value">' + escapeHtml(bookingData.guestCount) + 'å</span></div>';
      if (bookingData.bookingSite) html += '<div class="booking-row"><span class="booking-label">äºˆç´„ã‚µã‚¤ãƒˆ</span><span class="booking-value">' + escapeHtml(bookingData.bookingSite) + '</span></div>';
      if (bookingData.bbq) html += '<div class="booking-row"><span class="booking-label">BBQåˆ©ç”¨</span><span class="booking-value">' + escapeHtml(bookingData.bbq) + '</span></div>';
      if (bookingData.linen) html += '<div class="booking-row"><span class="booking-label">ãƒªãƒãƒ³</span><span class="booking-value">' + escapeHtml(bookingData.linen) + '</span></div>';
      if (bookingData.bed) html += '<div class="booking-row"><span class="booking-label">ãƒ™ãƒƒãƒ‰</span><span class="booking-value">' + escapeHtml(bookingData.bed) + '</span></div>';

      document.getElementById('bookingInfo').innerHTML = html;
      document.getElementById('bookingInfo').classList.remove('hidden');
    }

    // === ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ ===
    function renderChecklistItem(item, checked, supplyNeeded) {
      var isChecked = !!checked[item.id];
      var isSupplyNeeded = !!supplyNeeded[item.id];
      var html = '<div class="checklist-item">';
      html += '<input type="checkbox" class="item-checkbox" data-item-id="' + escapeHtml(item.id) + '" ' + (isChecked ? 'checked' : '') + ' onchange="toggleItem(this)">';
      html += '<div class="item-content">';
      html += '<div class="item-name">' + escapeHtml(item.name) + '</div>';
      if (item.supplyItem) {
        html += '<div class="supply-checkbox-container">';
        html += '<input type="checkbox" class="supply-checkbox" data-item-id="' + escapeHtml(item.id) + '" data-item-name="' + escapeHtml(item.name) + '" ' + (isSupplyNeeded ? 'checked' : '') + ' onchange="toggleSupply(this)">';
        html += '<label>è¦è£œå……</label>';
        html += '</div>';
      }
      html += '</div></div>';
      return html;
    }

    function renderChecklist() {
      var items = checklistData.items;
      var checked = checklistData.checked;
      var supplyNeeded = checklistData.supplyNeeded;

      // ã‚«ãƒ†ã‚´ãƒªã‚’å¤§ä¸­å°ã«éšå±¤åŒ–
      var majorGroups = {};
      var majorOrder = [];
      items.forEach(function(item) {
        var cat = item.category || 'ãã®ä»–';
        var sep = cat.indexOf('\uff1a');
        var majorName = sep >= 0 ? cat.substring(0, sep) : cat;
        var subName = sep >= 0 ? cat.substring(sep + 1) : null;
        if (!majorGroups[majorName]) {
          majorGroups[majorName] = { direct: [], subs: {}, subOrder: [] };
          majorOrder.push(majorName);
        }
        if (subName) {
          if (!majorGroups[majorName].subs[subName]) {
            majorGroups[majorName].subs[subName] = [];
            majorGroups[majorName].subOrder.push(subName);
          }
          majorGroups[majorName].subs[subName].push(item);
        } else {
          majorGroups[majorName].direct.push(item);
        }
      });

      var html = '';
      majorOrder.forEach(function(majorName) {
        var group = majorGroups[majorName];
        var allItems = group.direct.slice();
        group.subOrder.forEach(function(sub) { allItems = allItems.concat(group.subs[sub]); });
        var checkedInMajor = allItems.filter(function(item) { return checked[item.id]; }).length;
        var totalInMajor = allItems.length;

        html += '<div class="section" data-category="' + escapeHtml(majorName) + '">';
        html += '<div class="section-header collapsed" onclick="toggleSection(this)">';
        html += '<span class="section-icon">â–¼</span>';
        html += '<span class="section-title">' + escapeHtml(majorName) + '</span>';
        html += '<span class="section-count">(' + checkedInMajor + '/' + totalInMajor + ')</span>';
        html += '<button class="section-header-btn section-check-all" onclick="event.stopPropagation(); checkCategory(this)">å…¨ãƒã‚§ãƒƒã‚¯</button>';
        html += '<button class="section-header-btn section-photo-btn" onclick="event.stopPropagation(); openCategoryPhoto(\'' + escapeHtml(majorName).replace(/'/g, "\\'") + '\')">ğŸ“·</button>';
        html += '</div>';
        html += '<div class="section-body collapsed">';

        // ç›´å±ã‚¢ã‚¤ãƒ†ãƒ 
        group.direct.forEach(function(item) {
          html += renderChecklistItem(item, checked, supplyNeeded);
        });

        // ä¸­ã‚«ãƒ†ã‚´ãƒª
        group.subOrder.forEach(function(subName) {
          var subItems = group.subs[subName];
          var checkedInSub = subItems.filter(function(item) { return checked[item.id]; }).length;

          html += '<div class="section sub-section" data-category="' + escapeHtml(majorName + '\uff1a' + subName) + '">';
          html += '<div class="section-header collapsed" onclick="toggleSection(this)">';
          html += '<span class="section-icon">â–¼</span>';
          html += '<span class="section-title">' + escapeHtml(subName) + '</span>';
          html += '<span class="section-count">(' + checkedInSub + '/' + subItems.length + ')</span>';
          html += '<button class="section-header-btn section-check-all" onclick="event.stopPropagation(); checkCategory(this)">å…¨ãƒã‚§ãƒƒã‚¯</button>';
          html += '</div>';
          html += '<div class="section-body collapsed">';
          subItems.forEach(function(item) {
            html += renderChecklistItem(item, checked, supplyNeeded);
          });
          html += '</div></div>';
        });

        html += '</div></div>';
      });

      document.getElementById('checklistContainer').innerHTML = html;
    }

    // === æ’®å½±ã‚»ã‚¯ã‚·ãƒ§ãƒ³ ===
    function renderPhotoSection() {
      var spots = checklistData.spots;
      var photos = checklistData.photos;

      if (spots.length === 0) {
        document.getElementById('photoSection').innerHTML = '<div class="supply-empty">æ’®å½±ç®‡æ‰€ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</div>';
        return;
      }

      // ã‚«ãƒ†ã‚´ãƒªã”ã¨ã«ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
      var categories = {};
      var catOrder = [];
      spots.forEach(function(spot) {
        var cat = spot.category || 'ãã®ä»–';
        if (!categories[cat]) { categories[cat] = []; catOrder.push(cat); }
        categories[cat].push(spot);
      });

      var html = '';
      catOrder.forEach(function(cat) {
        html += '<div class="photo-section"><h3>ğŸ“· ' + escapeHtml(cat) + '</h3>';
        categories[cat].forEach(function(spot) {
          var spotPhotos = photos[spot.id] || { before: [], after: [] };
          html += '<div class="photo-spot">';
          html += '<div class="photo-spot-name">' + escapeHtml(spot.name) + '</div>';

          // ãƒ“ãƒ•ã‚©ãƒ¼
          html += '<div class="photo-timing-group">';
          html += '<div class="photo-timing-label">ãƒ“ãƒ•ã‚©ãƒ¼</div>';
          if (spotPhotos.before.length > 0) {
            html += '<div class="photo-grid">';
            spotPhotos.before.forEach(function(photo) {
              html += '<div class="photo-thumb" style="background-image: url(https://drive.google.com/uc?id=' + photo.fileId + ')"></div>';
            });
            html += '</div>';
          }
          html += '<button class="photo-upload-btn" onclick="openPhotoUpload(\'' + spot.id + '\', \'ãƒ“ãƒ•ã‚©ãƒ¼\')">ãƒ“ãƒ•ã‚©ãƒ¼å†™çœŸã‚’æ’®å½±</button>';
          html += '</div>';

          // ã‚¢ãƒ•ã‚¿ãƒ¼
          html += '<div class="photo-timing-group">';
          html += '<div class="photo-timing-label">ã‚¢ãƒ•ã‚¿ãƒ¼</div>';
          if (spotPhotos.after.length > 0) {
            html += '<div class="photo-grid">';
            spotPhotos.after.forEach(function(photo) {
              html += '<div class="photo-thumb" style="background-image: url(https://drive.google.com/uc?id=' + photo.fileId + ')"></div>';
            });
            html += '</div>';
          }
          html += '<button class="photo-upload-btn" onclick="openPhotoUpload(\'' + spot.id + '\', \'ã‚¢ãƒ•ã‚¿ãƒ¼\')">ã‚¢ãƒ•ã‚¿ãƒ¼å†™çœŸã‚’æ’®å½±</button>';
          html += '</div>';

          html += '</div>';
        });
        html += '</div>';
      });

      document.getElementById('photoSection').innerHTML = html;
    }

    // ã‚«ãƒ†ã‚´ãƒªãƒ˜ãƒƒãƒ€ãƒ¼ã®æ’®å½±ãƒœã‚¿ãƒ³ã‹ã‚‰å‘¼ã°ã‚Œã‚‹ãƒ¢ãƒ¼ãƒ€ãƒ«
    function openCategoryPhoto(majorName) {
      var spots = checklistData.spots || [];
      var photos = checklistData.photos || {};
      // ã‚«ãƒ†ã‚´ãƒªã«å±ã™ã‚‹æ’®å½±ç®‡æ‰€ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
      var matchedSpots = spots.filter(function(s) {
        var cat = s.category || 'ãã®ä»–';
        return cat === majorName || cat.indexOf(majorName) === 0;
      });

      if (matchedSpots.length === 0) {
        // æ’®å½±ç®‡æ‰€ãŒãªã„å ´åˆã€ã‚«ãƒ†ã‚´ãƒªåã‚’ã‚¹ãƒãƒƒãƒˆåã¨ã—ã¦ç›´æ¥æ’®å½±
        currentPhotoSpotId = 'cat_' + majorName;
        currentPhotoTiming = 'ã‚¢ãƒ•ã‚¿ãƒ¼';
        document.getElementById('photoInput').click();
        return;
      }

      // ãƒ¢ãƒ¼ãƒ€ãƒ«ã§æ’®å½±ç®‡æ‰€ä¸€è¦§ã‚’è¡¨ç¤º
      var overlay = document.createElement('div');
      overlay.className = 'photo-modal-overlay';
      overlay.onclick = function(e) { if (e.target === overlay) overlay.remove(); };

      var modal = document.createElement('div');
      modal.className = 'photo-modal';
      var html = '<h3>ğŸ“· ' + escapeHtml(majorName) + ' ã®æ’®å½±</h3>';
      matchedSpots.forEach(function(spot) {
        var spotPhotos = photos[spot.id] || { before: [], after: [] };
        var bCount = spotPhotos.before.length;
        var aCount = spotPhotos.after.length;
        html += '<div style="margin-bottom:12px;padding:10px;background:#fafafa;border-radius:6px;">';
        html += '<div style="font-weight:bold;margin-bottom:8px;">' + escapeHtml(spot.name) + ' <span style="font-size:12px;color:#7f8c8d;">(B:' + bCount + ' / A:' + aCount + ')</span></div>';
        html += '<div style="display:flex;gap:8px;">';
        html += '<button class="photo-upload-btn" style="flex:1;" onclick="openPhotoUpload(\'' + spot.id + '\', \'ãƒ“ãƒ•ã‚©ãƒ¼\'); this.closest(\'.photo-modal-overlay\').remove();">ãƒ“ãƒ•ã‚©ãƒ¼</button>';
        html += '<button class="photo-upload-btn" style="flex:1;background:#e67e22;" onclick="openPhotoUpload(\'' + spot.id + '\', \'ã‚¢ãƒ•ã‚¿ãƒ¼\'); this.closest(\'.photo-modal-overlay\').remove();">ã‚¢ãƒ•ã‚¿ãƒ¼</button>';
        html += '</div></div>';
      });
      html += '<button class="photo-modal-close" onclick="this.closest(\'.photo-modal-overlay\').remove();">é–‰ã˜ã‚‹</button>';
      modal.innerHTML = html;
      overlay.appendChild(modal);
      document.body.appendChild(overlay);
    }

    function renderMemos() {
      var memos = checklistData.memos;
      var html = '';
      memos.forEach(function(memo) {
        html += '<div class="memo-item">';
        html += escapeHtml(memo.text);
        html += '<div class="memo-meta">' + escapeHtml(memo.by) + ' - ' + formatDateTime(memo.at) + '</div>';
        html += '</div>';
      });
      document.getElementById('memoList').innerHTML = html;
    }

    // === è¦è£œå……ãƒªã‚¹ãƒˆ ===
    function renderSupplyList() {
      var supplyNeeded = checklistData.supplyNeeded;
      var keys = Object.keys(supplyNeeded);

      // ã‚¿ãƒ–ãƒãƒƒã‚¸æ›´æ–°
      var badge = document.getElementById('supplyBadge');
      if (keys.length > 0) {
        badge.textContent = keys.length;
        badge.classList.remove('hidden');
      } else {
        badge.classList.add('hidden');
      }

      // ã‚¿ãƒ–å†…ã‚³ãƒ³ãƒ†ãƒ³ãƒ„
      var el = document.getElementById('supplyListContent');
      if (keys.length === 0) {
        el.innerHTML = '<div class="supply-empty">è¦è£œå……ã®ã‚¢ã‚¤ãƒ†ãƒ ã¯ã‚ã‚Šã¾ã›ã‚“</div>';
        return;
      }

      var html = '<div class="supply-list-card"><h3>âš ï¸ è¦è£œå……ãƒªã‚¹ãƒˆ</h3>';
      keys.forEach(function(k) {
        var item = supplyNeeded[k];
        html += '<div class="supply-item">' + escapeHtml(item.name) + '</div>';
      });
      html += '</div>';
      el.innerHTML = html;
    }

    // === ã‚»ã‚¯ã‚·ãƒ§ãƒ³æ“ä½œ ===
    function toggleSection(header) {
      var section = header.parentElement;
      var body = section.querySelector('.section-body');
      header.classList.toggle('collapsed');
      body.classList.toggle('collapsed');
    }

    function toggleItem(checkbox) {
      var itemId = checkbox.getAttribute('data-item-id');
      var checked = checkbox.checked;
      var names = getSelectedStaffNames();
      var who = names.length > 0 ? names.join(', ') : staffName;

      callGAS('toggleChecklistItem', [checkoutDate, itemId, checked, who]).then(function(res) {
        if (res.success) {
          if (checked) {
            checklistData.checked[itemId] = { checked: true, by: who, at: new Date() };
          } else {
            delete checklistData.checked[itemId];
          }
          updateProgress();
          updateSectionCounts();
          updateCheckAllButton();
          if (missingCheckActive) highlightMissing();
        } else {
          alert('ã‚¨ãƒ©ãƒ¼: ' + res.error);
          checkbox.checked = !checked;
        }
      });
    }

    function toggleSupply(checkbox) {
      var itemId = checkbox.getAttribute('data-item-id');
      var itemName = checkbox.getAttribute('data-item-name');
      var needed = checkbox.checked;
      var names = getSelectedStaffNames();
      var who = names.length > 0 ? names.join(', ') : staffName;

      callGAS('toggleSupplyNeeded', [checkoutDate, itemId, itemName, needed, who]).then(function(res) {
        if (res.success) {
          if (needed) {
            checklistData.supplyNeeded[itemId] = { name: itemName, by: who, at: new Date() };
          } else {
            delete checklistData.supplyNeeded[itemId];
          }
          renderSupplyList();
        } else {
          alert('ã‚¨ãƒ©ãƒ¼: ' + res.error);
          checkbox.checked = !needed;
        }
      });
    }

    function updateProgress() {
      var total = checklistData.totalItems;
      var checked = Object.keys(checklistData.checked).length;
      var percent = total > 0 ? Math.round((checked / total) * 100) : 0;

      document.getElementById('progressFill').style.width = percent + '%';
      document.getElementById('btnComplete').disabled = checked < total;
    }

    function updateSectionCounts() {
      var sections = document.querySelectorAll('.section');
      sections.forEach(function(section) {
        var items = section.querySelectorAll('.item-checkbox');
        var checked = Array.from(items).filter(function(cb) { return cb.checked; }).length;
        var total = items.length;
        var count = section.querySelector('.section-count');
        if (count) {
          count.textContent = '(' + checked + '/' + total + ')';
        }
      });
    }

    function toggleMissingCheck() {
      missingCheckActive = !missingCheckActive;
      var btn = document.getElementById('btnCheckMissing');

      if (missingCheckActive) {
        btn.textContent = 'é€šå¸¸è¡¨ç¤º';
        btn.style.background = '#c0392b';
        highlightMissing();
      } else {
        btn.textContent = 'æ¼ã‚Œãƒã‚§ãƒƒã‚¯';
        btn.style.background = '#e67e22';
        clearMissingHighlight();
      }
    }

    function highlightMissing() {
      var items = document.querySelectorAll('.checklist-item');
      items.forEach(function(item) {
        var checkbox = item.querySelector('.item-checkbox');
        var nameEl = item.querySelector('.item-name');
        if (!checkbox.checked) {
          nameEl.classList.add('missing');
        } else {
          nameEl.classList.remove('missing');
        }
      });

      var sections = document.querySelectorAll('.section');
      sections.forEach(function(section) {
        var items = section.querySelectorAll('.item-checkbox');
        var hasMissing = Array.from(items).some(function(cb) { return !cb.checked; });
        var header = section.querySelector('.section-header');
        var title = section.querySelector('.section-title');

        if (hasMissing) {
          header.classList.add('has-missing');
          title.classList.add('missing');
        } else {
          header.classList.remove('has-missing');
          title.classList.remove('missing');
        }
      });

      var spots = document.querySelectorAll('.photo-spot');
      spots.forEach(function(spot) {
        var beforePhotos = spot.querySelectorAll('.photo-timing-group:nth-of-type(1) .photo-thumb');
        var afterPhotos = spot.querySelectorAll('.photo-timing-group:nth-of-type(2) .photo-thumb');
        var nameEl = spot.querySelector('.photo-spot-name');

        if (beforePhotos.length === 0 || afterPhotos.length === 0) {
          nameEl.classList.add('missing');
        } else {
          nameEl.classList.remove('missing');
        }
      });
    }

    function clearMissingHighlight() {
      document.querySelectorAll('.missing').forEach(function(el) {
        el.classList.remove('missing');
      });
      document.querySelectorAll('.has-missing').forEach(function(el) {
        el.classList.remove('has-missing');
      });
    }

    var currentPhotoSpotId = null;
    var currentPhotoTiming = null;

    function openPhotoUpload(spotId, timing) {
      currentPhotoSpotId = spotId;
      currentPhotoTiming = timing;
      document.getElementById('photoInput').click();
    }

    function handlePhotoUpload(event) {
      var file = event.target.files[0];
      if (!file) return;
      var names = getSelectedStaffNames();
      var who = names.length > 0 ? names.join(', ') : staffName;

      var reader = new FileReader();
      reader.onload = function(e) {
        var base64 = e.target.result.split(',')[1];

        callGAS('uploadChecklistPhoto', [checkoutDate, currentPhotoSpotId, currentPhotoTiming, base64, who]).then(function(res) {
          if (res.success) {
            if (!checklistData.photos[currentPhotoSpotId]) {
              checklistData.photos[currentPhotoSpotId] = { before: [], after: [] };
            }
            var photoData = { fileId: res.fileId, by: who, at: new Date() };
            if (currentPhotoTiming === 'ãƒ“ãƒ•ã‚©ãƒ¼') {
              checklistData.photos[currentPhotoSpotId].before.push(photoData);
            } else {
              checklistData.photos[currentPhotoSpotId].after.push(photoData);
            }
            renderPhotoSection();
            if (missingCheckActive) highlightMissing();
          } else {
            alert('å†™çœŸã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + res.error);
          }
        });
      };
      reader.readAsDataURL(file);
      event.target.value = '';
    }

    function addMemo() {
      var input = document.getElementById('memoInput');
      var text = input.value.trim();
      if (!text) return;
      var names = getSelectedStaffNames();
      var who = names.length > 0 ? names.join(', ') : staffName;

      callGAS('addChecklistMemo', [checkoutDate, text, who]).then(function(res) {
        if (res.success) {
          checklistData.memos.push({ text: text, by: who, at: new Date() });
          renderMemos();
          input.value = '';
        } else {
          alert('ãƒ¡ãƒ¢ã®è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + res.error);
        }
      });
    }

    // === å…¨ä½“æ“ä½œ ===
    var allExpanded = false;
    function toggleAllSections() {
      allExpanded = !allExpanded;
      var btn = document.getElementById('btnExpandAll');
      var headers = document.querySelectorAll('#checklistContainer .section-header');
      var bodies = document.querySelectorAll('#checklistContainer .section-body');
      if (allExpanded) {
        btn.textContent = 'å…¨ã¦æŠ˜ã‚ŠãŸãŸã¿';
        headers.forEach(function(h) { h.classList.remove('collapsed'); });
        bodies.forEach(function(b) { b.classList.remove('collapsed'); });
      } else {
        btn.textContent = 'å…¨ã¦å±•é–‹';
        headers.forEach(function(h) { h.classList.add('collapsed'); });
        bodies.forEach(function(b) { b.classList.add('collapsed'); });
      }
    }

    var allChecked = false;
    function checkAllItems() {
      var btn = document.getElementById('btnCheckAll');
      if (!allChecked) {
        // å…¨ãƒã‚§ãƒƒã‚¯
        var unchecked = document.querySelectorAll('.item-checkbox:not(:checked)');
        if (unchecked.length === 0) {
          // æ—¢ã«å…¨ãƒã‚§ãƒƒã‚¯æ¸ˆã¿ â†’ ãƒˆã‚°ãƒ«ã§ã‚¢ãƒ³ãƒã‚§ãƒƒã‚¯
          uncheckAllItems();
          return;
        }
        var names = getSelectedStaffNames();
        var who = names.length > 0 ? names.join(', ') : staffName;
        unchecked.forEach(function(cb) {
          cb.checked = true;
          var itemId = cb.getAttribute('data-item-id');
          callGAS('toggleChecklistItem', [checkoutDate, itemId, true, who]);
          checklistData.checked[itemId] = { checked: true, by: who, at: new Date() };
        });
        allChecked = true;
        btn.textContent = 'å…¨ãƒã‚§ãƒƒã‚¯è§£é™¤';
        btn.classList.add('is-all-checked');
      } else {
        uncheckAllItems();
      }
      updateProgress();
      updateSectionCounts();
      if (missingCheckActive) highlightMissing();
    }

    function uncheckAllItems() {
      var checked = document.querySelectorAll('.item-checkbox:checked');
      var names = getSelectedStaffNames();
      var who = names.length > 0 ? names.join(', ') : staffName;
      checked.forEach(function(cb) {
        cb.checked = false;
        var itemId = cb.getAttribute('data-item-id');
        callGAS('toggleChecklistItem', [checkoutDate, itemId, false, who]);
        delete checklistData.checked[itemId];
      });
      allChecked = false;
      var btn = document.getElementById('btnCheckAll');
      btn.textContent = 'å…¨ãƒã‚§ãƒƒã‚¯';
      btn.classList.remove('is-all-checked');
      updateProgress();
      updateSectionCounts();
      if (missingCheckActive) highlightMissing();
    }

    function updateCheckAllButton() {
      var total = checklistData.items.length;
      var checkedCount = Object.keys(checklistData.checked).length;
      var btn = document.getElementById('btnCheckAll');
      if (checkedCount >= total) {
        allChecked = true;
        btn.textContent = 'å…¨ãƒã‚§ãƒƒã‚¯è§£é™¤';
        btn.classList.add('is-all-checked');
      } else {
        allChecked = false;
        btn.textContent = 'å…¨ãƒã‚§ãƒƒã‚¯';
        btn.classList.remove('is-all-checked');
      }
    }

    function checkCategory(btn) {
      var section = btn.closest('.section');
      if (!section) return;
      var checkboxes = section.querySelectorAll(':scope > .section-body > .checklist-item > .item-checkbox');
      // sub-sectionã®å ´åˆã¯ç›´æ¥å­è¦ç´ ã®ã¿å–å¾—
      if (checkboxes.length === 0) {
        checkboxes = section.querySelectorAll('.item-checkbox');
      }
      var unchecked = Array.from(checkboxes).filter(function(cb) { return !cb.checked; });
      var allDone = unchecked.length === 0;
      var names = getSelectedStaffNames();
      var who = names.length > 0 ? names.join(', ') : staffName;

      if (allDone) {
        // å…¨ãƒã‚§ãƒƒã‚¯æ¸ˆã¿ â†’ è§£é™¤
        Array.from(checkboxes).forEach(function(cb) {
          if (cb.checked) {
            cb.checked = false;
            var itemId = cb.getAttribute('data-item-id');
            callGAS('toggleChecklistItem', [checkoutDate, itemId, false, who]);
            delete checklistData.checked[itemId];
          }
        });
      } else {
        unchecked.forEach(function(cb) {
          cb.checked = true;
          var itemId = cb.getAttribute('data-item-id');
          callGAS('toggleChecklistItem', [checkoutDate, itemId, true, who]);
          checklistData.checked[itemId] = { checked: true, by: who, at: new Date() };
        });
      }
      updateProgress();
      updateSectionCounts();
      updateCheckAllButton();
      if (missingCheckActive) highlightMissing();
    }

    function completeChecklist() {
      var names = getSelectedStaffNames();
      var who = names.length > 0 ? names.join(', ') : staffName;
      if (!confirm('æ¸…æƒã‚’å®Œäº†ã—ã¦ã‚ªãƒ¼ãƒŠãƒ¼ã«é€šçŸ¥ã—ã¾ã™ã‹ï¼Ÿ')) return;

      callGAS('notifyCleaningComplete', [checkoutDate, who]).then(function(res) {
        if (res.success) {
          alert('æ¸…æƒå®Œäº†é€šçŸ¥ã‚’é€ä¿¡ã—ã¾ã—ãŸï¼ãŠç–²ã‚Œæ§˜ã§ã—ãŸï¼');
        } else {
          alert('é€šçŸ¥ã®é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + res.error);
        }
      });
    }

    // === ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ===
    function callGAS(functionName, args) {
      return new Promise(function(resolve, reject) {
        google.script.run
          .withSuccessHandler(function(jsonStr) {
            try {
              resolve(JSON.parse(jsonStr));
            } catch (e) {
              reject(e);
            }
          })
          .withFailureHandler(reject)
          [functionName].apply(null, args);
      });
    }

    function escapeHtml(text) {
      var div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function formatDateTime(dateStr) {
      if (!dateStr) return '';
      var d = new Date(dateStr);
      return d.getMonth() + 1 + '/' + d.getDate() + ' ' +
             String(d.getHours()).padStart(2, '0') + ':' +
             String(d.getMinutes()).padStart(2, '0');
    }
  </script>
</body>
</html>
