# 民泊予約・清掃管理 Webアプリ - 開発引き継ぎ資料

## ★最重要ルール①: デバッグファースト（推測で修正しない）
**エラーや不具合が報告された場合、原因を推測していきなり修正コードを書いてはならない。**
**これはこのプロジェクトで最も重要なルールである。いかなる場合も例外なく守ること。**
必ず以下の手順を踏むこと：

1. **まずデバッグコードを追加** — 問題箇所の入力値・中間値・出力値をログ出力（Logger.log）やフロントエンド表示に追加する
2. **デプロイしてユーザーに確認依頼** — デバッグ情報を見てもらい、本当の原因を特定する
3. **原因が判明してから修正** — ログで裏付けが取れた原因に対してのみ修正コードを書く

**やってはいけないこと：**
- 「おそらくこれが原因だろう」で修正コードを書くこと
- デバッグなしで複数箇所を同時に変更すること（どの変更が効いたか分からなくなる）
- 原因不明のまま「念のため」の修正を重ねること

## ★最重要ルール②: コミット10回で新チャット移行を提案
**コード変更のコミットが10回に達したら、ユーザーに聞かれなくても自主的に新チャットへの移行を提案すること。**
**コミット数は常にカウントし、10回目のコミット完了時点で即座に移行を提案する。**
詳細は「チャット移行時の必須ルール > ルール2」を参照。

## 必須ルール: 修正後のデプロイコマンド出力
**コード修正をコミット＆プッシュした後は、必ず以下の形式でデプロイコマンドを出力すること。**
ユーザーがWindows PCのターミナルにコピペしてすぐデプロイできるようにする。

```
cd C:\Users\yamas\minpaku-fix && git fetch origin && git checkout -f <ブランチ名> && git reset --hard origin/<ブランチ名> && node deploy-all.js
```

- `<ブランチ名>` は現在の作業ブランチ名に置き換える
- 修正の説明の最後に必ずこのコマンドブロックを出力する
- ユーザーが「デプロイして」と言わなくても、コード変更をプッシュしたら毎回出す
- `deploy-all.js` は以下を自動実行する:
  1. メインアプリ: clasp push → デプロイ更新
  2. チェックリストアプリ: deploy-checklist.js を実行
  3. デプロイ完了後、オーナー用URLを通常ウィンドウ、スタッフ用URLをシークレットウィンドウで自動的にブラウザで開く

## プロジェクト概要
Google Apps Script + スプレッドシート製の民泊予約・清掃管理Webアプリ。
ファイルは `Code.gs`（サーバーサイド）と `index.html`（フロントエンド）の2つのみ。

## アーキテクチャ
- **バックエンド**: Code.gs (Google Apps Script) - スプレッドシートをDB代わりに使用
- **フロントエンド**: index.html - Bootstrap 5 + FullCalendar 6 のSPA
- **通信**: `google.script.run` でサーバー関数を呼び出し、JSON文字列で結果を返す
- **デプロイ**: Apps Script Webアプリとして2つ（オーナー用/スタッフ用）デプロイ

## 主要シート一覧
| シート名 | 用途 |
|---|---|
| `フォームの回答 1` | 予約データ本体（iCal同期含む） |
| `清掃スタッフ` | スタッフ名簿（名前・メール） |
| `スタッフ共有用` | スタッフに見せる予約情報 |
| `募集` | 清掃募集エントリ（15列: 日付, 行番号, 通知日時, ステータス, 選定スタッフ, リマインド, 作成日, BookingID, 告知方法, +次回予約キャッシュ6列） |
| `募集_立候補` | スタッフの立候補記録（7列: 募集ID, スタッフ名, メール, 日時, メモ, ステータス, 保留理由） |
| `募集設定` | 募集開始週数・最少回答者数等 |
| `設定_連携` | iCal同期URL（プラットフォーム名, URL, 有効/無効, 最終同期） |
| `キャンセル申請` | スタッフの出勤キャンセル要望 |
| `通知履歴` | 立候補・予約追加等の通知ログ |
| `サブオーナー` | サブオーナーのメール一覧 |

## 重要な関数（Code.gs）

### データ取得
- `getData()` - 予約一覧を取得（フロントエンドのメインデータソース）
- `getRecruitmentStatusMap()` - カレンダー用: 予約行番号→募集ステータス・立候補者マップ
- `getRecruitmentList()` - 募集一覧取得
- `getRecruitmentForBooking(bookingRowNumber)` - 特定予約の募集詳細

### iCal同期
- `syncFromICal()` - iCal URLから予約取得。**削除ロジック注意**（下記参照）
- `parseICal_(icalText, platformName)` - iCalテキストをパース

### 募集・立候補
- `volunteerForRecruitment(recruitId, ...)` - スタッフ立候補
- `cancelVolunteerForRecruitment(recruitId, ...)` - 立候補取消
- `holdForRecruitment(recruitId, ...)` - 保留設定

### カラムマップ
- `buildColumnMap(headers)` - フォームの回答1用（日本語ヘッダー）
- `buildColumnMapFromSource_(headers)` - スタッフ共有用シート対応

## 既知の注意点

### getLastRow() off-by-one（要修正箇所多数）
`sheet.getRange(2, 1, sheet.getLastRow(), cols)` は numRows に `getLastRow()` を渡しており、
実際には `getLastRow() - 1` が正しい。現在約50箇所に存在。
多くはガード条件で問題にならないが、syncFromICal の削除ロジックでは修正済み。

### iCal同期の削除ロジック（2026-02-28修正済み）
`syncFromICal` はiCalフィードにない既存予約を**自動削除**する。
修正で以下の安全チェックを追加:
- iCalフィードが空の場合は削除しない
- 過去の予約（チェックアウト日 < 今日）は削除対象外

### parseICal_ のキャンセルフィルタ（2026-02-28修正済み）
旧: `/cancel/i.test(sum)` → "Non-cancellable" 等を誤除外
新: `STATUS:CANCELLED` + SUMMARY完全一致のみ除外

### フロントエンド重複排除マージ（2026-02-28修正済み）
同一日付の予約をマージする際、プレースホルダ名（Not available等）より実名を優先するよう修正。

## 2026-03-01（セッション3）修正内容
1. **通知の一括操作ボタン追加**: 通知タブに「すべて既読」「すべて削除」ボタン、新着通知バナーに「すべて既読」ボタンを追加。Code.gsに`markAllNotificationsAsRead()`関数を追加
2. **スタッフ非表示機能追加**: 清掃スタッフシートに12列目「非表示」を追加。オーナー設定画面のスタッフ一覧に非表示トグルボタンを追加。非表示スタッフは`getStaffNamesForSelection()`と`getAllActiveStaff_()`から除外される（スタッフ選択肢・スタッフ回答状況に表示されなくなる）。仕事内容タブの報酬部分には非表示スタッフも引き続き表示

## 2026-03-01（後半）修正内容
1. **deploy-all.js デプロイ数チェック追加**: `countDeployments()`と`checkDeployCount()`を追加。デプロイ（上限200件）が150件超でGASデプロイ管理画面（`/deployments`）を自動起動
2. **deploy-all.js バージョン数チェックURL修正**: `checkVersionCount()`が開くURLを`/deployments`→`/edit`に変更。「プロジェクトの履歴」→「すべてのバージョンを表示」→ 選択して削除の操作手順メッセージも追加
3. **deploy-all.js 2段階チェック**: デプロイ完了後にデプロイ数チェック（上限200件）とバージョン数チェック（上限200件）の両方を実行するよう変更

## 2026-02-28 修正内容
1. **parseICal_**: SUMMARYの`/cancel/i`部分一致を厳密化（Booking.comの有効予約がキャンセル扱いになるバグ修正）
2. **syncFromICal**: iCalフィード空時の削除スキップ、過去予約の削除対象除外、off-by-one修正
3. **buildCalendarEvents**: 重複排除マージでプレースホルダ名より実名を優先
4. **HTTP 500/401/403**: エラーメッセージにURL再取得の案内を追加

## 必須ルール: バージョンバッジの更新
**コード修正をコミットするたびに、`index.html` 内のバージョンバッジを更新すること。**
- バッジ位置: `index.html` 内の `id="deployVersion"` 要素
- 命名規則: `vMMDDx`（MM=月, DD=日, x=a,b,c,...のアルファベット連番）
- 同じ日の最初のコミットは `a` から開始（例: `v0301a`）、以降 `b`, `c`, ... とインクリメント
- チェックリストアプリ（`checklist-app/checklist.html`）にも同様のバージョン表示あり。チェックリストアプリのコードを変更した場合はそちらも更新する
- コミットメッセージにもバージョンを含める（例: `fix: v0301d 〇〇を修正`）

## 必須ルール: 修正履歴の記録
**コード修正をコミットするたび、もしくは切りのいいタイミングで、このCLAUDE.mdに修正履歴を追記すること。**
- 日付セクション（`## YYYY-MM-DD 修正内容`）に何を変更したか簡潔に記録
- 既知の注意点や仕様変更があれば該当セクションも更新
- 「次回やること」も状況に応じて更新

## 2026-03-01 修正内容
1. **buildCalendarEvents 重複排除ロジック改善**: CI（チェックイン日）一致で常にマージするよう変更。旧ロジックはCO（チェックアウト日）も一致しないとマージしなかったため、宿泊者名簿のCO誤入力やiCal日付ずれで重複表示されていた
2. **CO不一致時の解決ロジック追加**: mergeBookingDataにCO不一致時の優先ルール追加（CO>CIの有効な方を採用、両方有効なら後の日付を採用）
3. **isPlaceholderName拡張**: 「Airbnb予約」「Booking.com予約」もプレースホルダ名として認識
4. **CO日不一致オーナー通知バナー追加**: 予約サイトCOと名簿COが異なる場合、カレンダー上部にオレンジ色警告バナーを表示。「宿泊者名簿と予約サイトのチェックアウト日が異なります。名簿入力内容が間違いの場合はスプシを手作業で修正してください」
5. **オーナーURL入力欄の直接設定**: getOwnerBaseUrlコールバック内で入力欄が空なら直接URLを設定する対策を追加（loadSettingsに依存しない）
6. **デバッグコード全削除**: 全てのDEBUGパネル（重複排除・オーナーURL）、console.log（ownerUrl/dedup/staffCache/invoiceAuth/invoiceSend）、_dedupDebug変数、debugMailInfoレスポンスフィールドを削除
7. **請求書パスワードポップアップにローディング表示追加**: サーバーからパスワード有無をチェック中はスピナー+「読み込み中...」を表示し、応答後にパスワード入力欄に切り替え

## 2026-03-01（セッション4）修正内容
1. **名簿未入力リマインドのテンプレート対応**: `checkRosterReminder()`のメール送信がハードコードだったのを、設定画面のテンプレート（件名・本文）を使うように修正。プレースホルダー: `{件数}`, `{未記入一覧}`。テンプレート未設定時は従来のデフォルト文面にフォールバック
2. **名簿リマインドのプレースホルダー説明修正**: フロントエンドのプレースホルダー説明を実際に使えるもの（`{件数}`, `{未記入一覧}`）に変更。旧: `{ゲスト名}`, `{チェックイン}` 等（集約メールには不適切だった）
3. **3つの通知メールにデフォルトテンプレートをプリセット**: スタッフ未決定リマインド（定期＋即時）・名簿未入力リマインド・請求書要請の件名・本文テンプレート欄に、設定が空の場合デフォルト文面を自動表示するように変更。ユーザーはそのままテキストを編集できる
4. **募集リマインドのテンプレート対応**: `checkAndSendReminders()`のメール送信がハードコードだったのを、設定画面のテンプレート（件名・本文）を使うように修正。プレースホルダー: `{チェックアウト}`, `{回答数}`, `{最少回答者数}`。デフォルト文面のプリセットも追加
5. **確定通知メール件名のテンプレート化**: `notifyStaffConfirmation()`のメール件名がハードコードだったのを、確定通知タブで編集可能に変更。デフォルト: `【民泊】スタッフ確定: {作業日}`。保存・リセット・デフォルトプリセット対応
6. **LINE通知機能追加**: LINE Messaging API経由でグループにメッセージ送信する機能を実装。メール通知と同タイミング・同内容でLINEグループにも送信。設定タブに「LINE通知」サブタブ追加（ON/OFF・チャネルアクセストークン・グループID・テスト送信）。募集設定シートに`LINE通知有効`・`LINEチャネルアクセストークン`・`LINEグループID`を保存

## 次回やること（優先度順）
1. **[高]** 請求書要請の配信日デバッグ情報確認後、デバッグコード削除
2. **[高]** 新規通知タブのテンプレート編集機能を実装（予約キャンセル、出勤キャンセル要望、キャンセル承認/却下、請求書送信、清掃完了）
3. **[中]** Airbnb iCal URLの再取得（HTTP 500 はURL期限切れの可能性大）
4. **[中]** 残りの `getLastRow()` off-by-one 修正（約50箇所）
5. **[低]** 「募集」シートの重複エントリクリーンアップ（必要に応じて）

## 現在のセッション状態
- **ブランチ**: `claude/verify-staff-response-display-bvHjT`
- **最新コミット**: `f764fe9`
- **進行中タスク**: 配信時刻Date型バグ修正完了・デプロイ待ち確認
- **デプロイ待ち**: あり（v0302m）
- **デバッグコード残存**: 請求書要請タブに `invoiceRequestDebug` 表示欄あり（確認後削除予定）

## 2026-03-02（セッション7）修正内容
1. **請求書要請テスト送信のテンプレート対応**: `sendTestNotification`の請求書要請caseがハードコードだったのを、`INVOICE_REQ_KEYS_`でシートから件名・本文テンプレートを読み込み+プレースホルダー置換するよう修正。全13通知のテスト送信vs実送信のテンプレートキー突き合わせ調査を実施
2. **請求書要請に締切日設定を追加**: `INVOICE_REQ_KEYS_`に`deadline`キーを追加。`getInvoiceRequestSettings`/`saveInvoiceRequestSettings`/`sendInvoiceRequestEmails`に締切日対応。フロントエンドに締切日select（毎月○日）を追加。未設定時は従来どおり月末日
3. **配信時刻のDate型バグ修正**: スプレッドシートが`07:00`を時刻Date型として解釈する問題。`getInvoiceRequestSettings`と`setupInvoiceRequestTrigger`でDate instanceofチェック+HH:mm変換を追加
4. **配信日デバッグ表示追加**: `loadInvoiceRequestSettings`にサーバー取得値とselect反映後の値をデバッグ表示する`invoiceRequestDebug`欄を追加（確認後削除予定）

## 2026-03-02（セッション7）コミット履歴（コミットハッシュ付き）
| コミット | 内容 |
|---|---|
| `a9274b2` | feat: v0302l 請求書要請テスト送信テンプレート対応 + 締切日設定 + 配信日デバッグ |
| `f764fe9` | fix: v0302m 配信時刻がDate型で返るバグ修正（スプレッドシート→HH:mm変換） |

### 変更ファイルと箇所（セッション7）
- **Code.gs**: `INVOICE_REQ_KEYS_`にdeadlineキー追加、`getInvoiceRequestSettings`にDate型→HH:mm変換+deadline追加、`saveInvoiceRequestSettings`にdeadline追加、`sendInvoiceRequestEmails`の締切日を設定値から取得、`setupInvoiceRequestTrigger`にDate型対応、`sendTestNotification`の請求書要請caseをテンプレート読み込み対応
- **index.html**: 請求書要請タブに締切日select追加、loadInvoiceRequestSettingsにデバッグ表示追加、save処理にdeadline追加

### テンプレートキー突き合わせ結果（セッション7で調査）
全13通知のテスト送信vs実送信のテンプレートキーを突き合わせた結果:
- 通知1-6（テンプレートあり）: すべてキー一致 ✅
- 通知7-10,12-13（ハードコード）: テスト送信・実送信ともハードコードで一致 ✅
- **通知11（請求書要請）: ミスマッチ発見→修正済み** ✅（テスト送信がハードコードだったのをテンプレート読み込みに修正）

## 2026-03-02（セッション6）修正内容
1. **各通知タブにテスト送信機能を追加**: Code.gsに`sendTestNotification(notifyKey)`関数を追加。13種類の通知すべてに対応。テンプレートがある通知はサンプルプレースホルダー値で置換、テンプレートがない通知はサンプルメッセージを自動生成。送信チャンネル設定（メール/LINE/両方）に従って送信。メールはオーナー宛に【テスト】プレフィックス付きで送信
2. **フロントエンドテスト送信ボタン**: 全12通知タブにテスト送信ボタンを追加。`.btn-test-notify`クラスの共通ハンドラーで一括管理。募集・リマインド/未決定・直前リマインドはそれぞれ2ボタン、その他は1ボタン

## 2026-03-02（セッション6）コミット履歴（コミットハッシュ付き）
| コミット | 内容 |
|---|---|
| `e1cb10b` | feat: v0302a 各通知タブにテスト送信機能を追加 |

## 2026-03-01（セッション5）修正内容
1. **LINE通知機能拡張**: LINE送信先をグループ/個人で切り替え可能に。テスト送信のデバッグ情報表示。テスト送信をトグルON/OFF無関係で実行可能に
2. **LINEミュート送信の調査と撤去**: LINE API `notificationDisabled:true` は通知パネルにも表示されないことが判明。ミュートトグルを完全撤去
3. **通知別メール/LINEチャンネル選択機能**: 13種類の通知ごとにメール/LINE/両方を選択可能に。`NOTIFY_CHANNEL_KEYS_`配列、`getNotifyChannelSettings()`、`saveNotifyChannelSettings()`、`getNotifyChannel_()`を追加。全13通知関数にチャンネル制御を追加
4. **通知設定タブの大規模再構成**: サイドバーに折りたたみ式「通知設定」グループを追加。「メール通知」タブを削除。「LINE通知」→「LINE接続設定」にリネーム。8つの新規通知タブを作成。各タブにON/OFFトグル＋チャンネル選択＋説明文を配置
5. **確定通知タブにON/OFFトグル追加漏れ修正**: 旧メール通知タブ削除時に`notifyStaffConfirm`トグルが失われた問題を修正
6. **チャンネル設定保存バグ修正**: 部分更新時に未送信キーがデフォルト値で上書きされる問題。`if (!(item.key in channels)) return;` を追加
7. **タブ統合**: 「スタッフ未決定リマインド」+「直前予約リマインド」→「未決定・直前リマインド」、「清掃スタッフ募集」+「募集リマインド」→「募集・リマインド」
8. **タブ名変更**: 「仕事内容」→「仕事内容（単価設定）」、「予約連携」→「iCal予約連携」

## 2026-03-01（セッション5）コミット履歴（コミットハッシュ付き）
| コミット | 内容 |
|---|---|
| `e48235c` | feat: v0301e LINE通知機能を追加 |
| `7639f20` | docs: CLAUDE.md にLINE通知機能の修正履歴を追記 |
| `e9e30d2` | feat: v0301f LINE通知の送信先をグループ/個人で切り替え可能に |
| `adf79b6` | fix: v0301g LINE送信先 - 両方のID欄を常時表示＋選択中をハイライト |
| `3647c4b` | debug: v0301h LINEテスト送信のデバッグ情報をフロントに表示 |
| `d169159` | debug: v0301i LINEテスト送信をトグルON/OFF無関係で実行可能に |
| `7604316` | feat: v0301j LINEミュート送信の設定トグル追加 |
| `722f0e1` | feat: v0301k 通知別メール/LINEチャンネル選択機能を追加 |
| `3221915` | feat: v0301l 通知設定タブを大規模再構成 |
| `1cef642` | fix: v0301m 確定通知タブにON/OFFトグル追加漏れを修正 |
| `da4d466` | fix: v0301n チャンネル設定が保存時にデフォルトに戻るバグ修正 |
| `fea9556` | feat: v0301o スタッフ未決定リマインドと直前予約リマインドを1タブに統合 |
| `5b5359a` | feat: v0301p 清掃スタッフ募集と募集リマインドを1タブに統合 |

### 変更ファイルと箇所（セッション5）
- **index.html**: サイドバー再構成（通知設定グループ）、8新規タブdiv追加、タブ切替JSを`_settingsPanels`マップ方式に変更、チャンネル選択auto-save、メール通知トグルauto-save(`_emailNotifyToggleMap`)、LINEミュートトグル撤去、タブ統合2件、タブ名変更2件
- **Code.gs**: `NOTIFY_CHANNEL_KEYS_`配列追加、`getNotifyChannelSettings()`/`saveNotifyChannelSettings()`/`getNotifyChannel_()`追加、全13通知関数にチャンネル制御追加、`saveEmailNotifySettings`部分更新対応、`sendLineMessage_`からミュート削除

## 通知タブ構成（セッション5完了時点）
```
▼ 通知設定（折りたたみ式）
  ├── LINE接続設定 (lineId) — トークン・グループID・個人ID
  ├── 募集・リマインド (recruitSettings) — 募集開始通知 + 募集リマインド
  ├── スタッフ確定通知 (confirmTemplate) — 確定通知テンプレート
  ├── 未決定・直前リマインド (reminderEmail) — 定期リマインド + 直前予約リマインド
  ├── 予約キャンセル通知 (notifyCancel) — iCalキャンセル検出時
  ├── 出勤キャンセル要望 (notifyCancelRequest) — スタッフ→オーナー
  ├── キャンセル承認通知 (notifyCancelApprove) — オーナー→スタッフ
  ├── キャンセル却下通知 (notifyCancelReject) — オーナー→スタッフ
  ├── 名簿未入力リマインド (rosterReminder) — オーナーへ集約通知
  ├── 請求書要請 (invoiceRequest) — スタッフへ請求書提出依頼
  ├── 請求書送信通知 (notifyInvoiceSend) — PDF送信時
  └── 清掃完了通知 (notifyCleaningDone) — チェックリスト完了時
```

## チャンネル制御の仕組み（セッション5で追加）
```
データフロー:
1. 募集設定シートに `通知CH_xxx` キーで保存（値: email/line/both）
2. getNotifyChannel_(notifyKey) → { email: true/false, line: true/false }
3. 各通知関数内で ch.email / ch.line をチェックしてメール/LINE送信を制御
4. フロントエンドの <select class="notify-channel-select" data-notify-key="xxx"> で変更
5. 変更時に即座にsaveNotifyChannelSettings()で部分更新（選択されたキーのみ）

13通知のチャンネルキー:
予約キャンセル, 請求書要請, 名簿未入力リマインド, 清掃スタッフ募集,
出勤キャンセル要望, キャンセル承認, キャンセル却下, 請求書送信,
スタッフ確定, 募集リマインド, スタッフ未決定リマインド, 直前予約リマインド, 清掃完了
```

## 2026-03-01 コミット履歴（セッション1〜4、コミットハッシュ付き）
| コミット | 内容 |
|---|---|
| `1ba351c` | fix: v0301a カレンダー重複排除ロジック修正 — CI一致で常にマージ + CO不一致解決 |
| `c16737a` | fix: v0301b CO日不一致オーナー通知 + loadSettingsデバッグ強化 |
| `7ac2f71` | fix: v0301c オーナーURL入力欄をgetOwnerBaseUrlコールバックで直接設定 |
| `b856f0d` | デバッグコードを全削除（本番クリーンアップ） |
| `b589802` | 請求書パスワードポップアップに読み込み中表示を追加 |
| `c07fb4d` | docs: CLAUDE.md にローディング表示追加の修正履歴を追記 |
| `4d92b1b` | fix: deploy-all.js にデプロイ数チェック（上限20件）を追加 |
| `e362bdf` | fix: バージョン数チェックで開くURLをGASエディタ(/edit)に修正 |

### 変更ファイルと箇所（セッション1〜4）
- **index.html**: `buildCalendarEvents`（重複排除ロジック）、`mergeBookingData`（CO不一致解決）、`isPlaceholderName`（拡張）、CO不一致バナー表示、オーナーURL直接設定、請求書パスワードローディングUI、デバッグコード全削除
- **Code.gs**: `debugMailInfo`レスポンスフィールド削除
- **deploy-all.js**: `countDeployments()`追加、`checkDeployCount()`追加（デプロイ数15件超で警告＋GASデプロイ管理画面を自動起動）、`checkVersionCount()`のURLを`/edit`に修正（プロジェクト履歴からバージョン削除する画面）
- **CLAUDE.md**: 修正履歴追記

## 2026-02-28 コミット履歴（コミットハッシュ付き）
| コミット | 内容 |
|---|---|
| `09ab193` | iCal同期の予約誤削除・Booking.comキャンセル誤判定・重複排除マージの3つのバグを修正 |
| `a2e5ab0` | feat: v0228k スタッフ名キャッシュ(localStorage)＋請求書タブのパスワード認証 |
| `296ec97` | debug: v0228m 請求書メール送信失敗のデバッグ情報追加 |
| `64c3844` | fix: v0228n スタッフ変更時に請求書タブが開いたままになるバグ修正 |
| `081a580` | fix: v0228p MailApp→GmailAppに統一して請求書メール送信の権限エラーを修正 |
| `262ccc3` | fix: v0228q タブ切替時のカレンダー表示崩れを修正 |
| `0dd9f98` | feat: v0228r 募集回答ボタンのUI改善 |
| `f2ad051` | feat: v0228s 「不可」回答時のカレンダーイベントにグレー実線ボーダー追加 |
| `721e459` | fix: v0228j isRosterAnsweredがiCal同期のプレースホルダ名を記入済みと誤判定する問題を修正 |

## 主要ファイル構成
| ファイル | 行数 | 役割 |
|----------|------|------|
| `Code.gs` | ~10170行 | メインアプリ（予約管理）サーバー |
| `index.html` | ~9395行 | メインアプリ フロントエンド |
| `checklist-app/Code.gs` | ~2947行 | チェックリストアプリ サーバー |
| `checklist-app/checklist.html` | ~5788行 | チェックリストアプリ フロントエンド |
| `deploy-all.js` | ~403行 | 一括デプロイスクリプト |
| `CLAUDE.md` | 本ファイル | 開発引き継ぎ資料 |

## チャット移行時の必須ルール

### ルール1: 変更プッシュ後は毎回デプロイ手順を表示すること
上記「必須ルール: 修正後のデプロイコマンド出力」に記載のとおり。

### ルール2: 以下の条件を満たしたら新チャットへ移行を**自主的に**提案すること

**ユーザーに聞かれなくても、以下のいずれかに該当したら自分から引き継ぎ資料を更新して新チャットへの移行を提案する。コミット数は常にカウントしておくこと：**

1. **コンテキスト圧縮が発生した場合** — システムから会話の圧縮通知が出たら即座に移行提案
2. **大きな機能・バグ修正が一段落した場合** — デプロイ＋動作確認が完了したタイミング
3. **コード変更のコミットが10回に達した場合** — 10回目のコミット完了時点で即座に移行を提案する（ユーザーの指示を待たない）
4. **デバッグ→修正のサイクルが3回以上繰り返された場合** — コンテキストが散漫になるため

移行を提案する際は以下の2点を必ずセットで出力する：
1. 移行の声かけ：「そろそろコンテキストが大きくなってきたので、引き継ぎ資料を更新して新しいチャットに移行しませんか？」
2. **新チャットへ貼り付ける最初のプロンプト**をコードブロックで出力する（ユーザーがそのままコピペできる形式）

新チャット用プロンプトのテンプレート：
```
CLAUDE.mdを読んで引き継ぎ内容を確認してください。
ブランチ: <現在のブランチ名>
前回の最終コミット: <最新コミットハッシュ>

前回の作業サマリー:
- <完了した主な作業を箇条書き>

今回やりたいこと:
- <次回やることリストから、または新しいタスク>
```

### ルール3: 常に日本語で応答すること

### ルール4: 新チャット移行時にこの必須ルールを必ず引き継ぐこと
CLAUDE.mdのルールセクション全体を次のセッションでも参照できる状態にすること。

### ルール5: 新チャットは引き継ぎ確認→質問→回答待ち→作業開始の順を守ること

**ステップ1: 引き継ぎ資料を読む**
- CLAUDE.mdを読んで内容を確認する
- `git fetch origin <作業ブランチ>` + `git log origin/<作業ブランチ> --oneline -10` でコードの状態を確認

**ステップ2: 疑問点を洗い出し、前のチャットへの質問プロンプトを作成**

引き継ぎ資料を読んだ後、不明点や確認事項があれば、以下のような形式で**前のチャットに貼り付けるための質問プロンプト**を作成する。**ユーザーがそのままコピペできる形式**にすること：

```
前のチャットで以下を確認してください：

1. 「〇〇の実装」について、△△の部分はこの理解で合っていますか？
2. □□の機能は完了していますか？テスト済みですか？
3. ××のエラーが出ていましたが、解決済みですか？
4. この部分を変更しても他に影響はありませんか？
```

ユーザーはこのプロンプトをコピーして前のチャットに貼り付け、回答を得てから新チャットに戻る。

**ステップ3: ユーザーの返答を待つ**

質問プロンプトを出した場合は、**ユーザーからの返答を待ってから**開発を開始する。
質問がない場合はその旨を伝え、すぐに開発を開始してOK。

### チャット移行の具体的手順

#### 旧チャット側（移行前）がやること
1. 作業中のコードをすべてコミット＆プッシュ
2. CLAUDE.mdを以下の内容で更新：
   - 「現在のセッション状態」を最新化（ブランチ名・最新コミットハッシュ・進行中タスク）
   - 日付別修正内容＋コミット履歴テーブルを追記
   - 「次回やること」を更新
   - **ルール6の必須5項目を必ず含めること**
3. 更新をコミット＆プッシュ

#### 新チャット側がやること
→ ルール5の手順に従う（引き継ぎ確認→質問プロンプト作成→返答待ち→作業開始）

### ルール7: 新チャットでやってはいけないこと

1. **新しいブランチを作らない** — 引き継ぎプロンプトに記載されたブランチをそのまま `git checkout` して使う。別ブランチを作ってマージする必要はない
2. **この環境でデプロイ（clasp push/deploy）を実行しない** — clasp認証情報（`~/.clasprc.json`）はこの環境に存在しない。デプロイはユーザーがWindows PCで `node deploy-all.js` を実行する。コード修正後はデプロイコマンドを出力するだけでよい
3. **npm install を実行しない** — `node_modules` は既にgit管理外で存在する。npm installすると `package-lock.json` が不要に変更される
4. **PRを勝手に作成しない** — ユーザーから指示がない限り、PRは作成しない。ブランチにプッシュするだけでよい

### ルール6: 引き継ぎ資料に以下の5項目を必ず含めること
1. **現在取り組んでいるタスク・機能の説明** — 「現在のセッション状態」セクション
2. **完了した作業と未完了の作業** — 日付別修正内容 + 「次回やること」
3. **既知のバグや注意点** — 「既知の注意点」セクション
4. **次のセッションでやるべきこと** — 「次回やること（優先度順）」
5. **コードの変更箇所のサマリー（コミットハッシュ付き）** — 日付別コミット履歴テーブル

## 技術的な注意点

### 清掃ステータスマークの仕組み
```
カレンダーのステータスドット色:
- 赤(recruiting): 募集中で未確定
- 緑(decided): スタッフ確定済み or 選定済 or cleaningStaff設定済み

データフロー:
1. loadAndRender() → getRecruitmentStatusMap() → window._recruitFullMap
2. buildCalendarEvents() で recruitMap[b.rowNumber].status をチェック
3. 確定時に applyConfirmOptimistic() で楽観的にキャッシュ更新＋カレンダー再描画
```

### スタッフ選択の複数端末同期（チェックリストアプリ）
```
データフロー:
1. 端末がページ読込 → getChecklistForDate(date, deviceId) で自分の選択を取得
2. スタッフ選択/解除 → applyStaffSelection() でローカル反映 + GASにsave
3. GAS側 getStaffSelectionDetailed_() で全端末の選択をマージ
4. 60秒ポーリングで他端末の選択も反映（remoteStaffInfo表示）

粘着ユニオン問題の修正:
- 旧: 全端末の選択をunionして返す → 一度選んだスタッフが外せない
- 新: deviceId別に選択状態を管理 → 各端末の解除が正しく反映される
```

### チェックリストアプリのデータフロー
```
[checklist.html]
    ↓ callGAS('getChecklistForDate', [date, deviceId])
[checklist-app/Code.gs]
    ↓ getChecklistForDate(date, deviceId)
[Google Sheets]
    ├── チェックリストマスタ → items（チェック項目定義）
    ├── 撮影箇所マスタ → spots（撮影箇所 + exampleFileId）
    ├── チェックリスト記録 → checked（日付別チェック状態）
    ├── チェックリスト写真 → photos（日付別撮影写真）
    ├── チェックリストメモ → memos（日付別メモ）
    └── スタッフ選択 → staffSelection（端末別スタッフ選択状態）
```

### カテゴリの区切り文字
- 全角コロン `：`（U+FF1A）を使用
- 例: `テラス：次の予約がBBQ利用あり：↓セット内容↓`

### レンダリングの仕組み（チェックリストアプリ）
- `buildCategoryTree()` が全アイテムをツリー構造に変換
- `renderCategoryNode()` が再帰的にHTMLを生成
- レベル0=`.section`（濃紺）、1=`.sub-section`（薄青）、2=`.sub-sub-section`（オレンジ）、3=`.sub-sub-sub-section`（紫）

### callGAS() の仕組み（チェックリストアプリ）
```javascript
function callGAS(functionName, args) {
  return new Promise(function(resolve, reject) {
    google.script.run
      .withSuccessHandler(function(jsonStr) { resolve(JSON.parse(jsonStr)); })
      .withFailureHandler(reject)
      [functionName].apply(null, args);
  });
}
```
- GASの `google.script.run` をPromise化。GAS側は全てJSON文字列を返す

### 写真保存構造 (Google Drive)
```
写真フォルダ/
  ├── before/    ← ビフォー写真
  ├── after/     ← アフター写真
  ├── example/   ← 見本写真（日付非依存）
  └── memo/      ← メモ添付写真
```
- サムネイルURL: `https://drive.google.com/thumbnail?id={fileId}&sz=w{size}`

## 重要な技術的制約

### GAS グローバルスコープの罠
- GASプロジェクト内の全 `.gs` ファイルは同一グローバルスコープを共有
- `const SHEET_NAME = '...'` を2つのファイルで宣言すると **SyntaxError**
- **対策**: `.claspignore` で互いのファイルを除外 + チェックリストは `CL_` 接頭辞で回避

### チェックリストアプリの変数名ルール
- `SHEET_NAME` → `CL_BOOKING_SHEET`
- `SHEET_OWNER` → `CL_OWNER_SHEET`
- `SHEET_STAFF` → `CL_STAFF_SHEET`

### GASデプロイ・バージョン上限
- **デプロイ上限**: 200個（公式ドキュメントに明記なし。旧情報の「20件上限」は誤り。実運用で200件が上限と推定）
  - deploy-all.jsは150超で警告 + GASエディタのデプロイ管理画面を自動起動
  - 削除方法: GASエディタ →「デプロイを管理」→ 古いデプロイを選択して削除
- **バージョン上限**: 200個（2024年6月以降、公式に明記）
  - deploy-all.jsは150超で警告 + GASエディタを自動起動
  - 削除方法: GASエディタ左サイドバー「プロジェクトの履歴」→ 右上メニュー「すべてのバージョンを表示」→ 削除したいバージョンを選択して削除
- **注意**: デプロイとバージョンは別概念。デプロイ=公開エンドポイント、バージョン=コードのスナップショット

### GAS CSSサニタイザー
- GASはHTMLサービスで `body` セレクタを書き換える
- **対策**: `body` の代わりに `#contentArea` セレクタを使用

### FullCalendar の注意点
- イベントソースの差し替え: 全ソース削除 → `addEventSource` → `render` のパターンが必要
- `eventSources` の直接操作は避ける

### スプレッドシートの行番号
- 「募集」シートの `currentRowNum` が予約行番号のマッピングに使われる
- 行の挿入/削除でずれる可能性あり → `getRecruitmentForBooking()` に自己修復メカニズムあり
- 行番号は1ベースで、ヘッダー行を含む

### デプロイID管理
- `deploy-config.json` にデプロイIDを永続保存（**`.gitignore` でgit追跡から除外済み**）
- deploy.js は3段階でデプロイIDを探す: 1. 保存済みID → 2. `clasp deployments` で検索 → 3. 新規作成（URLが変わる）
- `npx clasp` ではなく `node_modules/.bin/clasp` を直接実行（JSON5エラー回避）

## よくある問題と対処法
| 問題 | 原因 | 対処 |
|------|------|------|
| URL が毎回変わる | deploy-config.json がリセット | git追跡から除外済み。新規ならsampleコピー |
| SHEET_NAME SyntaxError | 同名const宣言 | .claspignoreで除外＋CL_接頭辞 |
| clasp push JSON5 エラー | npx経由のclasp | node_modules/.bin/clasp直接実行（対応済み） |
| マスタデータ読み込み失敗 | ScriptProperties未設定/OAuth未許可 | GASエディタで `diagChecklistSetup()` 実行 |
| CSSが適用されない | GAS CSSサニタイザー | bodyセレクタを#contentAreaに変更（対応済み） |
| スタッフ選択が復活する | 粘着ユニオン問題 | deviceId別管理に修正（対応済み） |

## ファイル構成（詳細）
```
minpaku-fix/
├── Code.gs                      # メインアプリ GAS コード
├── index.html                   # メインアプリ UI
├── appsscript.json              # GASマニフェスト
├── .clasp.json                  # メインアプリのclasp設定
├── .claspignore                 # メインアプリ push 時の除外ルール
├── deploy.js                    # メインアプリ デプロイスクリプト
├── deploy-all.js                # 一括デプロイ（メイン+チェックリスト）
├── deploy-all.bat               # deploy-all.jsのWindows用ラッパー
├── deploy-config.json           # デプロイID保存（git追跡対象外！）
├── deploy-config.sample.json    # deploy-config.json のテンプレート
├── package.json                 # Node.js依存（@google/clasp）
│
├── checklist-app/               # チェックリストアプリ（別GASプロジェクト）
│   ├── Code.gs                  # チェックリストアプリ GAS コード
│   ├── checklist.html           # チェックリストアプリ UI
│   ├── .clasp.json              # チェックリストアプリのclasp設定
│   ├── .claspignore             # チェックリストアプリ push 時の除外ルール
│   ├── deploy-checklist.js      # チェックリストアプリ デプロイスクリプト
│   └── appsscript.json
│
├── manual-generator/            # スタッフ操作マニュアル生成ツール
│   ├── generate-manual.js       # メインマニュアル生成
│   ├── generate-staff-manual.js # スタッフマニュアル生成
│   ├── screenshot.js            # スクリーンショット撮影（Puppeteer）
│   └── package.json
│
├── CLAUDE.md                    # 開発引き継ぎ資料（本ファイル）
└── .gitignore                   # deploy-config.json, node_modules/ を除外
```

## スプレッドシートの全シート構成
```
フォームの回答 1    ... 予約データ本体
設定_オーナー       ... オーナー設定
サブオーナー        ... サブオーナー情報
清掃スタッフ        ... 清掃スタッフ一覧
仕事内容マスタ      ... 仕事種類
スタッフ報酬        ... 報酬計算
特別料金            ... 特別料金設定
募集設定            ... 募集の設定
募集                ... 清掃募集レコード
募集_立候補         ... スタッフの立候補
キャンセル申請      ... キャンセル申請
設定_連携           ... iCal URL等の連携設定
通知履歴            ... 通知ログ
スタッフ共有用      ... スタッフ画面用
ベッド数マスタ      ... ベッド設定
チェックリストマスタ ... チェック項目のマスタデータ
撮影箇所マスタ      ... 写真撮影箇所（exampleFileIdカラムあり）
チェックリスト記録   ... チェック実績（日付別）
チェックリスト写真   ... 撮影写真（日付別）
チェックリストメモ   ... メモ（日付別）
スタッフ選択        ... 端末別スタッフ選択状態
要補充記録          ... 要補充アイテムの記録
```
