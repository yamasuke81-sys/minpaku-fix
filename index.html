<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>民泊予約・清掃管理</title>
  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Bootstrap Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
  <!-- FullCalendar -->
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.css" rel="stylesheet">
  <style>
    :root {
      --booking-color: #0d6efd;
      --booking-bg: rgba(13, 110, 253, 0.15);
      --cleaning-color: #198754;
      --cleaning-bg: rgba(25, 135, 84, 0.2);
      --invalid-color: #6c757d;
      --fc-border-color: #adb5bd;
    }
    .fc-theme-standard td, .fc-theme-standard th {
      border: 1px solid #adb5bd !important;
    }
    .fc-scrollgrid td, .fc-scrollgrid th {
      border: 1px solid #adb5bd !important;
    }
    .fc-daygrid-day {
      border: 1px solid #adb5bd !important;
    }
    .fc-col-header-cell {
      border: 1px solid #adb5bd !important;
    }
    body {
      font-size: 14px;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
    }
    .fc {
      font-size: 12px;
    }
    .fc-toolbar-title {
      font-size: 1.1rem !important;
    }
    .fc-button {
      padding: 0.35em 0.65em;
      font-size: 0.85rem;
    }
    .fc-event {
      cursor: pointer;
      border-radius: 4px;
      padding: 1px 3px;
    }
    .fc-event-booking {
      background-color: var(--booking-bg);
      border-color: var(--booking-color);
      color: var(--booking-color);
    }
    .fc-event-cleaning,
    .fc-event-cleaning-undecided,
    .fc-event-cleaning-recruiting {
      background-color: #ffc107 !important;
      color: #212529 !important;
      border: none !important;
    }
    .fc-event-cleaning-decided {
      background-color: #ffc107 !important;
      color: #212529 !important;
      border: none !important;
    }
    .fc-event-cleaning .fc-event-main,
    .fc-event-cleaning-recruiting .fc-event-main,
    .fc-event-cleaning-undecided .fc-event-main,
    .fc-event-cleaning-decided .fc-event-main {
      color: #212529 !important;
    }
    .fc-day-recruiting {
      background-color: #ffff00 !important;
    }
    @media (prefers-color-scheme: dark) {
      :root {
        --fc-border-color: #495057;
      }
      body, html {
        background-color: #000 !important;
        color: #e0e0e0 !important;
      }
      .container-fluid {
        background-color: #000 !important;
        color: #e0e0e0 !important;
      }
      h1, h2, h3, h4, h5, h6, .h1, .h2, .h3, .h4, .h5, .h6 {
        color: #fff !important;
      }
      a { color: #7eb8ff !important; }
      a:hover { color: #a8d0ff !important; }
      .text-muted { color: #adb5bd !important; }
      .fc-theme-standard td, .fc-theme-standard th,
      .fc-scrollgrid td, .fc-scrollgrid th,
      .fc-daygrid-day, .fc-col-header-cell {
        border-color: #495057 !important;
      }
      .fc-theme-standard .fc-scrollgrid {
        border-color: #495057 !important;
      }
      .fc .fc-view-harness {
        background-color: #1a1a1a !important;
      }
      .fc .fc-daygrid-day-frame {
        background-color: #1a1a1a !important;
      }
      .fc .fc-day-other .fc-daygrid-day-frame {
        background-color: #0d0d0d !important;
      }
      .fc .fc-col-header-cell-cushion,
      .fc .fc-daygrid-day-number {
        color: #e0e0e0 !important;
      }
      .fc .fc-toolbar-title { color: #fff !important; }
      .fc .fc-button {
        background-color: #2d2d2d !important;
        border-color: #495057 !important;
        color: #e0e0e0 !important;
      }
      .fc .fc-button:hover {
        background-color: #3d3d3d !important;
        border-color: #6c757d !important;
        color: #fff !important;
      }
      .fc .fc-button-active {
        background-color: #198754 !important;
        border-color: #198754 !important;
      }
      .fc-day-recruiting,
      .fc-day-recruiting .fc-daygrid-day-frame {
        background-color: #9a8a00 !important;
      }
      .fc-event-cleaning,
      .fc-event-cleaning-recruiting,
      .fc-event-cleaning-undecided {
        background-color: #ffc107 !important;
        color: #212529 !important;
      }
      .fc-event-cleaning-decided {
        background-color: #ffc107 !important;
        color: #212529 !important;
      }
      .fc-event-cleaning-volunteered-by-me,
      .fc-event-cleaning-selected-by-me {
        border-color: #dc3545 !important;
      }
      #calendarStatusLegend { color: #adb5bd !important; }
      .fc-list-event:hover td {
        background-color: rgba(255,255,255,0.08) !important;
      }
      .fc-list-event-title, .fc-list-event-time {
        color: #e0e0e0 !important;
      }
      .fc-event {
        border-color: inherit !important;
      }
      .modal-content {
        background-color: #1a1a1a !important;
        border-color: #495057 !important;
        color: #e0e0e0 !important;
      }
      .modal-header {
        background-color: #242424 !important;
        border-bottom-color: #495057 !important;
        color: #fff !important;
      }
      .modal-footer {
        background-color: #242424 !important;
        border-top-color: #495057 !important;
      }
      .modal-body {
        background-color: #1a1a1a !important;
        color: #e0e0e0 !important;
      }
      .modal .btn-close {
        filter: invert(1);
      }
      .detail-row {
        border-bottom-color: #333 !important;
      }
      .detail-label { color: #b0b0b0 !important; }
      .detail-value { color: #e0e0e0 !important; }
      .form-control, .form-select, .form-control:focus, .form-select:focus {
        background-color: #2d2d2d !important;
        border-color: #495057 !important;
        color: #e0e0e0 !important;
      }
      .form-control::placeholder {
        color: #6c757d !important;
      }
      .form-control:disabled, .form-select:disabled {
        background-color: #1f1f1f !important;
      }
      .form-label {
        color: #d0d0d0 !important;
      }
      #jobCompFormModal .form-control, #jobCompFormModal .form-select {
        border-color: #495057 !important;
      }
      .card {
        background-color: #1a1a1a !important;
        border-color: #495057 !important;
        color: #e0e0e0 !important;
      }
      .card-body { color: #e0e0e0 !important; }
      .border, .border-top, .border-bottom, .border-start, .border-end {
        border-color: #495057 !important;
      }
      .bg-light, .border.bg-light {
        background-color: #2d2d2d !important;
        border-color: #495057 !important;
        color: #e0e0e0 !important;
      }
      .nav-tabs {
        border-bottom-color: #495057 !important;
      }
      .nav-tabs .nav-link {
        background-color: transparent !important;
        border-color: transparent !important;
        color: #adb5bd !important;
      }
      .nav-tabs .nav-link:hover {
        border-color: #495057 !important;
        color: #e0e0e0 !important;
      }
      .nav-tabs .nav-link.active {
        background-color: #1a1a1a !important;
        border-color: #495057 #495057 #1a1a1a !important;
        color: #fff !important;
      }
      .alert {
        background-color: #242424 !important;
        border-color: #495057 !important;
        color: #e0e0e0 !important;
      }
      .alert-info {
        background-color: #1a2a3a !important;
        border-color: #2d4a5e !important;
      }
      .alert-warning {
        background-color: #3a3020 !important;
        border-color: #5d4e37 !important;
      }
      .alert-danger {
        background-color: #3a2020 !important;
        border-color: #5d3737 !important;
      }
      .alert-success {
        background-color: #1a2a20 !important;
        border-color: #2d4a37 !important;
      }
      .alert-link { color: #7eb8ff !important; }
      .loading-overlay {
        background: rgba(0,0,0,0.85) !important;
      }
      .loading-overlay .spinner-border {
        color: #0d6efd !important;
      }
      #staffSelectOverlay .bg-white {
        background-color: #1a1a1a !important;
        border: 1px solid #495057 !important;
        color: #e0e0e0 !important;
      }
      #staffSelectOverlay h6 { color: #fff !important; }
      .recruit-status-badge { font-size: 1rem; font-weight: 700; display: block; text-align: center; padding: 0.45rem 0.75rem; letter-spacing: 0.05em; margin: -0.75rem -0.75rem 0.5rem -0.75rem; border-radius: 10px 10px 0 0; }
      .recruit-status-badge.status-undecided { background: #dc3545; color: #fff; }
      .recruit-status-badge.status-recruiting { background: #ffc107; color: #000; }
      .recruit-status-badge.status-decided { background: #198754; color: #fff; }
      .table {
        color: #e0e0e0 !important;
      }
      .table td, .table th {
        border-color: #495057 !important;
      }
      code {
        background-color: #2d2d2d !important;
        color: #e0e0e0 !important;
        border-color: #495057 !important;
      }
      textarea.form-control {
        background-color: #2d2d2d !important;
        color: #e0e0e0 !important;
      }
      .btn-outline-primary, .btn-outline-secondary, .btn-outline-danger, .btn-outline-info, .btn-outline-success, .btn-outline-warning {
        border-color: #495057 !important;
        color: #adb5bd !important;
      }
      .btn-outline-primary:hover, .btn-outline-primary:focus {
        background-color: #0d6efd !important;
        border-color: #0d6efd !important;
        color: #fff !important;
      }
      .btn-outline-secondary:hover {
        background-color: #6c757d !important;
        border-color: #6c757d !important;
        color: #fff !important;
      }
      .btn-link.text-muted {
        color: #adb5bd !important;
      }
      .btn-link.text-muted:hover {
        color: #fff !important;
      }
      input[type="month"], input[type="date"], input[type="datetime-local"] {
        color-scheme: dark;
      }
      .form-check-input {
        background-color: #2d2d2d !important;
        border-color: #495057 !important;
      }
      .form-check-input:checked {
        background-color: #0d6efd !important;
        border-color: #0d6efd !important;
      }
      .form-check-label {
        color: #e0e0e0 !important;
      }
      .dropdown-menu {
        background-color: #1a1a1a !important;
        border-color: #495057 !important;
      }
      .dropdown-item {
        color: #e0e0e0 !important;
      }
      .dropdown-item:hover {
        background-color: #2d2d2d !important;
        color: #fff !important;
      }
      .dropdown-divider {
        border-color: #495057 !important;
      }
      label:not(.form-check-label):not(.badge) {
        color: #d0d0d0 !important;
      }
      .small, .small * {
        color: inherit;
      }
      .badge.bg-secondary {
        background-color: #495057 !important;
      }
      .modal-backdrop {
        background-color: #000 !important;
      }
      .fc .fc-popover {
        background-color: #1a1a1a !important;
        border-color: #495057 !important;
      }
      .fc .fc-popover-header {
        background-color: #242424 !important;
        color: #fff !important;
      }
      .fc .fc-more-link {
        color: #7eb8ff !important;
      }
      /* モーダル見出しグラデーション */
      .modal-header-cleaning {
        background: linear-gradient(135deg, #1a3d2a 0%, #242424 100%) !important;
        border-bottom-color: #198754 !important;
      }
      .modal-header-booking {
        background: linear-gradient(135deg, #1a2d4a 0%, #242424 100%) !important;
        border-bottom-color: #0d6efd !important;
      }
      /* モーダル日付表示 */
      .modal-prominent-date {
        color: #e0e0e0 !important;
      }
      .modal-prominent-date .bi {
        color: #adb5bd !important;
      }
      .modal-date-pair .date-item {
        background: #2d2d2d !important;
      }
      .modal-date-pair .date-item .date-label {
        color: #adb5bd !important;
      }
      .modal-date-pair .date-item .date-val {
        color: #e0e0e0 !important;
      }
      /* モーダル情報項目 */
      .modal-info-item .bi {
        color: #adb5bd !important;
      }
      .modal-info-item .info-label {
        color: #adb5bd !important;
      }
      .modal-info-item .info-value {
        color: #e0e0e0 !important;
      }
      /* モーダルバッジ */
      .modal-badge-yes {
        background: #1a3d2a !important;
        color: #a3d9b1 !important;
      }
      .modal-badge-no {
        background: #2d2d2d !important;
        color: #adb5bd !important;
      }
      /* 次回予約カード */
      .modal-next-res-card {
        background: #2d2d2d !important;
        border-color: #495057 !important;
      }
      .modal-next-res-card .card-title-sm {
        color: #e0e0e0 !important;
      }
      .modal-next-res-card #nextResHeaderStatus {
        color: #adb5bd !important;
      }
      .modal-next-res-grid .nres-label {
        color: #adb5bd !important;
      }
      .modal-next-res-grid .nres-value {
        color: #e0e0e0 !important;
      }
      /* 備考・連絡事項エリア */
      .modal-memo-area label {
        color: #adb5bd !important;
      }
      /* 区切り線 */
      .modal-section-divider {
        border-top-color: #495057 !important;
      }
      .modal-footer-redesign {
        border-top-color: #495057 !important;
      }
      /* 清掃セクション回答状況 */
      .cleaning-section-volunteers {
        color: #adb5bd !important;
      }
      .cleaning-section-volunteers strong {
        color: #e0e0e0 !important;
      }
      /* 清掃担当ラベル */
      .modal-staff-label.staff-set {
        color: #6ea8fe !important;
      }
      .modal-staff-label.staff-set #eventModalStaffDisplay {
        background: transparent !important;
      }
      .modal-staff-label.staff-unset {
        color: #ea868f !important;
      }
      .modal-staff-label.staff-unset #eventModalStaffDisplay {
        background: transparent !important;
      }
      /* 清掃担当: 個人カード（ダークモード） */
      .staff-card-item {
        background: #1a2d4a !important;
        border-color: #2c5282 !important;
        color: #6ea8fe !important;
      }
      .staff-card-unset {
        background: #3d1a1e !important;
        border-color: #6b2530 !important;
        color: #ea868f !important;
      }
      .staff-card-memo {
        color: #9ca3af !important;
      }
    }
    /* 清掃セクション: 募集状況バッジ */
    .recruit-status-badge {
      font-size: 1rem;
      font-weight: 700;
      display: block;
      text-align: center;
      padding: 0.45rem 0.75rem;
      letter-spacing: 0.05em;
      margin: -0.75rem -0.75rem 0.5rem -0.75rem;
      border-radius: 10px 10px 0 0;
    }
    .recruit-status-badge.status-undecided { background: #dc3545; color: #fff; }
    .recruit-status-badge.status-recruiting { background: #ffc107; color: #000; }
    .recruit-status-badge.status-decided { background: #198754; color: #fff; }
    /* 清掃セクション: 回答状況 */
    .cleaning-section-volunteers {
      font-size: 0.85rem;
      color: #555;
      padding: 0.15rem 0;
    }
    .cleaning-section-volunteers strong {
      color: #333;
    }
    .fc-event-invalid {
      background-color: rgba(108, 117, 125, 0.15);
      border-color: var(--invalid-color);
      color: var(--invalid-color);
    }
    .fc-event-cancelled {
      opacity: 0.45;
      text-decoration: line-through;
    }
    /* 宿泊イベント: 枠線なし（全ステータス共通） */
    .fc-event-booking,
    .fc-event-booking .fc-event-main,
    .fc-event-roster-answered,
    .fc-event-roster-answered .fc-event-main,
    .fc-event-roster-unanswered,
    .fc-event-roster-unanswered .fc-event-main {
      border: none !important;
      box-shadow: none !important;
    }
    /* フォーム未回答: 枠線・枠なし */
    .fc-event.fc-event-roster-unanswered {
      border: none !important;
      box-shadow: none !important;
      outline: none !important;
    }
    .fc-event.fc-event-roster-unanswered .fc-event-main,
    .fc-event.fc-event-roster-unanswered .fc-event-main-frame {
      border: none !important;
      box-shadow: none !important;
      outline: none !important;
    }
    /* スタッフ画面: 自分が回答した清掃＝赤破線、正式決定＝赤実線 */
    .fc-event-cleaning-volunteered-by-me {
      border-color: #dc3545 !important;
      border-style: dashed !important;
      border-width: 3px !important;
      background-clip: padding-box !important;
    }
    .fc-event-cleaning-selected-by-me {
      border-color: #dc3545 !important;
      border-style: solid !important;
      border-width: 3px !important;
      background-clip: padding-box !important;
    }
    .fc-event-status-dot {
      border: 1px solid #fff !important;
      box-shadow: 0 0 0 1px rgba(255,255,255,0.9) !important;
    }
    #calendar {
      max-width: 100%;
      overflow-x: auto;
    }
    /* スマホ: 1日の枠を縦長に（Googleカレンダー風） */
    @media (max-width: 768px) {
      .fc-daygrid-day {
        min-height: 5.5rem;
      }
      .fc-daygrid-day-frame {
        min-height: 5rem;
      }
      .fc-daygrid-day-events {
        min-height: 4rem;
      }
      .fc-daygrid-day-top {
        padding: 2px 0;
      }
      .fc .fc-toolbar {
        gap: 0.3rem;
        flex-wrap: nowrap;
      }
      .fc .fc-toolbar-title {
        font-size: 1rem !important;
      }
      .fc .fc-button {
        padding: 0.4em 0.5em;
        font-size: 0.8rem;
      }
      /* リスト表示: 縦長のイベント行 */
      .fc-list-event:hover td {
        background: rgba(0,0,0,0.04);
      }
      .fc-list-event-dot {
        margin-right: 0.5rem;
      }
    }
    .modal-content {
      border-radius: 12px;
    }
    #jobCompFormModal .form-control, #jobCompFormModal .form-select {
      border: 1px solid #adb5bd;
    }
    .modal-header {
      border-bottom: 1px solid #dee2e6;
    }
    .detail-row {
      padding: 0.5rem 0;
      border-bottom: 1px solid #f0f0f0;
      display: flex;
      gap: 0.5rem;
      align-items: flex-start;
    }
    .detail-row:last-child {
      border-bottom: none;
    }
    .detail-label {
      flex-shrink: 0;
      min-width: 6.5em;
    }
    .detail-value {
      flex: 1;
      word-break: break-word;
    }
    /* --- モーダル リデザイン --- */
    .modal-type-icon {
      font-size: 1.3rem;
      margin-right: 0.4rem;
      vertical-align: middle;
    }
    .modal-header-cleaning {
      background: linear-gradient(135deg, #d4edda 0%, #f8f9fa 100%);
      border-bottom: 2px solid #198754;
    }
    .modal-header-booking {
      background: linear-gradient(135deg, #cce5ff 0%, #f8f9fa 100%);
      border-bottom: 2px solid #0d6efd;
    }
    .modal-prominent-date {
      font-size: 1.25rem;
      font-weight: 700;
      color: #333;
      padding: 0.6rem 0 0.3rem;
    }
    .modal-prominent-date .bi {
      color: #6c757d;
      margin-right: 0.3rem;
    }
    .modal-date-pair {
      display: flex;
      gap: 0.75rem;
      padding: 0.5rem 0;
    }
    .modal-date-pair .date-item {
      flex: 1;
      background: #f8f9fa;
      border-radius: 8px;
      padding: 0.5rem 0.75rem;
      text-align: center;
    }
    .modal-date-pair .date-item .date-label {
      font-size: 0.7rem;
      color: #6c757d;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 0.15rem;
    }
    .modal-date-pair .date-item .date-val {
      font-size: 0.95rem;
      font-weight: 600;
      color: #333;
    }
    .modal-info-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 0.5rem;
      padding: 0.5rem 0;
    }
    .modal-info-item {
      display: flex;
      align-items: center;
      gap: 0.4rem;
      font-size: 0.9rem;
    }
    .modal-info-item .bi {
      color: #6c757d;
      font-size: 1rem;
    }
    .modal-info-item .info-label {
      color: #6c757d;
      font-size: 0.8rem;
    }
    .modal-info-item .info-value {
      font-weight: 600;
      color: #333;
    }
    .modal-badge-row {
      display: flex;
      gap: 0.5rem;
      padding: 0.4rem 0;
      flex-wrap: wrap;
    }
    .modal-badge {
      display: inline-flex;
      align-items: center;
      gap: 0.3rem;
      padding: 0.25rem 0.65rem;
      border-radius: 20px;
      font-size: 0.82rem;
      font-weight: 600;
    }
    .modal-badge-yes {
      background: #d4edda;
      color: #155724;
    }
    .modal-badge-no {
      background: #f0f0f0;
      color: #6c757d;
    }
    .modal-badge .bi {
      font-size: 0.9rem;
    }
    .modal-staff-label {
      display: flex;
      align-items: center;
      gap: 0.3rem;
      padding: 0.2rem 0;
      font-weight: 600;
      font-size: 0.85rem;
    }
    .modal-staff-label.staff-set {
      color: #0d6efd;
    }
    .modal-staff-label.staff-set #eventModalStaffDisplay {
      font-size: 0.95rem;
      font-weight: 700;
    }
    .modal-staff-label.staff-unset {
      color: #dc3545;
    }
    .modal-staff-label.staff-unset #eventModalStaffDisplay {
      font-size: 0.95rem;
      font-weight: 700;
    }
    /* 清掃担当: 個人カード風表示 */
    .staff-cards-wrap {
      display: flex;
      flex-direction: column;
      gap: 0.35rem;
    }
    .staff-card-item {
      display: inline-flex;
      align-items: center;
      gap: 0.2rem;
      background: #e7f1ff;
      border: 1px solid #b6d4fe;
      border-radius: 0.4rem;
      padding: 0.25rem 0.55rem;
      font-size: 0.88rem;
      font-weight: 600;
      color: #0a58ca;
    }
    .staff-card-item .bi-person-fill {
      font-size: 0.85rem;
    }
    .staff-card-memo {
      font-size: 0.75rem;
      font-weight: 400;
      color: #6c757d;
      margin-left: 0.4rem;
    }
    .staff-card-unset {
      display: inline-block;
      background: #fde8ea;
      border: 1px solid #f1aeb5;
      border-radius: 0.4rem;
      padding: 0.25rem 0.55rem;
      font-size: 0.88rem;
      font-weight: 700;
      color: #dc3545;
    }
    .modal-staff-name {
      font-size: 0.95rem;
      padding-left: 1.4rem;
      margin-bottom: 0.3rem;
    }
    .modal-next-res-card {
      background: #f8f9fa;
      border: 1px solid #e9ecef;
      border-radius: 10px;
      padding: 0.75rem;
      margin: 0.5rem 0;
    }
    .modal-next-res-card .card-title-sm {
      font-size: 0.8rem;
      font-weight: 700;
      color: #333;
      margin-bottom: 0.5rem;
      display: flex;
      align-items: center;
      gap: 0.3rem;
    }
    .next-res-toggle {
      margin-bottom: 0 !important;
    }
    .next-res-toggle:hover {
      opacity: 0.7;
    }
    .next-res-toggle .next-res-chevron {
      margin-left: auto;
    }
    .vol-resp-toggle {
      margin-bottom: 0 !important;
    }
    .vol-resp-toggle:hover {
      opacity: 0.7;
    }
    .vol-resp-toggle .vol-resp-chevron {
      margin-left: auto;
    }
    .modal-next-res-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 0.2rem;
    }
    .modal-next-res-grid .nres-item {
      display: flex;
      align-items: center;
      gap: 0.3rem;
      font-size: 0.85rem;
    }
    .modal-next-res-grid .nres-label {
      color: #6c757d;
      font-size: 0.78rem;
      min-width: 4.5em;
    }
    .modal-next-res-grid .nres-value {
      font-weight: 600;
      color: #333;
    }
    .modal-section-divider {
      border-top: 1px solid #e9ecef;
      margin: 0.5rem 0;
    }
    .modal-btn-full {
      width: 100%;
      margin-top: 0.3rem;
    }
    .modal-btn-row {
      display: flex;
      gap: 0.5rem;
      padding: 0.3rem 0;
    }
    .modal-btn-row .btn {
      flex: 1;
    }
    .btn-stacked {
      display: flex !important;
      flex-direction: column;
      align-items: center;
      min-width: 3.5rem;
      padding: 0.35rem 0.5rem !important;
      line-height: 1.2;
      gap: 0.1rem;
    }
    .btn-stacked .btn-icon {
      font-size: 1.1rem;
      line-height: 1;
    }
    .btn-stacked .btn-label {
      font-size: 0.7rem;
      line-height: 1;
    }
    .modal-memo-area {
      padding: 0.4rem 0;
    }
    .modal-memo-area label {
      font-size: 0.82rem;
      font-weight: 600;
      color: #6c757d;
      margin-bottom: 0.2rem;
    }
    .modal-footer-redesign {
      flex-direction: column;
      gap: 0.4rem;
      padding: 0.75rem 1rem;
      border-top: 1px solid #e9ecef;
    }
    .modal-footer-redesign .footer-btn-row {
      display: flex;
      gap: 0.5rem;
      width: 100%;
    }
    .modal-footer-redesign .footer-btn-row .btn {
      flex: 1;
    }
    .modal-footer-redesign .footer-center {
      display: flex;
      justify-content: center;
      width: 100%;
    }
    /* --- モーダル リデザイン END --- */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(255,255,255,0.8);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }
    .btn-edit-staff {
      margin-top: 0.5rem;
    }
    @media (max-width: 576px) {
      .fc-toolbar {
        flex-direction: row !important;
        flex-wrap: nowrap !important;
        align-items: center !important;
        gap: 0.25rem !important;
      }
      .fc-toolbar-chunk {
        display: flex;
        justify-content: center;
        align-items: center;
      }
      .fc-toolbar-title {
        font-size: 0.85rem !important;
        white-space: nowrap;
      }
    }
    /* === チェックリスト設定 === */
    .cl-settings-item { display:flex; align-items:center; gap:0.5rem; padding:0.4rem 0.5rem; border:1px solid #dee2e6; border-radius:6px; margin-bottom:0.4rem; font-size:0.85rem; }
    @media (prefers-color-scheme:dark) { .cl-settings-item { border-color:#444; } }
    .cl-settings-item .cl-si-name { flex:1; }
    .cl-settings-item .cl-si-cat { font-size:0.7rem; color:#6c757d; }
    .cl-settings-item .cl-si-order { font-size:0.7rem; color:#999; width:40px; text-align:center; }
  </style>
</head>
<body>
  <div class="container-fluid py-2 py-md-3 px-2">
<? if (staffModeStr === 'yes') { ?>
    <div id="staffSelectOverlay" class="position-fixed top-0 start-0 w-100 h-100 align-items-center justify-content-center" style="display:none !important; background:rgba(0,0,0,0.5); z-index:9999;">
      <div class="bg-white rounded shadow p-4 m-2" style="max-width:320px;">
        <h6 class="mb-3">スタッフのお名前を選択してください</h6>
        <select class="form-select mb-3" id="staffSelectModalSelect">
          <option value="">-- 選択 --</option>
        </select>
        <div id="staffPasswordArea" style="display:none;">
          <input type="password" class="form-control mb-2" id="staffPasswordInput" placeholder="パスワードを入力">
          <div id="staffPasswordMsg" class="small text-danger mb-2" style="display:none;"></div>
        </div>
        <button type="button" class="btn btn-primary w-100 mb-2" id="staffSelectModalConfirm">決定</button>
        <button type="button" class="btn btn-outline-secondary btn-sm w-100" id="staffSetPasswordBtn" style="display:none;">パスワードを変更</button>
      </div>
    </div>
<? } ?>
    <div id="staffSelectorBar" style="display:none;"></div>
    <div class="d-flex justify-content-between align-items-center mb-2 flex-wrap gap-1">
      <div class="d-flex align-items-center gap-2">
        <h5 class="mb-0">民泊予約・清掃管理</h5>
        <span class="badge bg-light text-muted" style="font-size:0.6rem;" id="deployVersion">v0219c</span>
        <span id="currentAccountBadge" class="badge bg-secondary" style="font-size:0.7rem; font-weight:normal; display:none;" title="ログイン中のアカウント"></span>
        <span id="staffDisplayName" class="small fw-bold" style="display:none;"></span>
        <button type="button" class="btn btn-sm btn-outline-secondary py-0" id="btnStaffChange" style="display:none;">変更</button>
        <select class="form-select form-select-sm" id="staffNameSelect" style="max-width:200px; display:none;">
          <option value="">-- 選択 --</option>
        </select>
      </div>
      <a href="#" id="btnAccountSwitch" class="btn btn-sm btn-link text-muted p-0" style="display:none; font-size:0.85rem;">アカウント切り替え</a>
    </div>
    <div id="notificationBanner" class="alert alert-info py-2 mb-2 small" style="display:none;">
      <div class="d-flex justify-content-between align-items-center">
        <span class="fw-bold">新着通知:</span>
        <button type="button" class="btn btn-sm btn-outline-danger py-0" id="btnClearAllNotifBanner">一括削除</button>
      </div>
      <div id="notificationBannerList" class="mt-1"></div>
      <a href="#" id="notificationBannerLink" class="alert-link mt-1 d-block">すべて見る</a>
    </div>
    <ul class="nav nav-tabs mb-2" id="mainTabs">
      <li class="nav-item"><a class="nav-link active" href="#" data-tab="calendar">カレンダー</a></li>
      <li class="nav-item" id="navRecruit" style="display:<?= staffModeStr === 'yes' ? 'none' : '' ?>;"><a class="nav-link" href="#" data-tab="recruit">清掃募集</a></li>
      <li class="nav-item" id="navStaffSchedule" style="display:<?= staffModeStr === 'yes' ? '' : 'none' ?>;"><a class="nav-link" href="#" data-tab="staffSchedule">出勤一覧</a></li>
      <li class="nav-item" id="navInvoice" style="display:<?= staffModeStr === 'yes' ? '' : 'none' ?>;"><a class="nav-link" href="#" data-tab="invoice">請求書</a></li>
      <li class="nav-item" id="navNotifications" style="display:<?= staffModeStr === 'yes' ? 'none' : '' ?>;"><a class="nav-link" href="#" data-tab="notifications">通知</a></li>
      <li class="nav-item" id="navSettings" style="display:<?= staffModeStr === 'yes' ? 'none' : '' ?>;"><a class="nav-link" href="#" data-tab="settings">設定</a></li>
    </ul>
    <div id="panelCalendar">
      <div id="calendarStatusLegend" class="small text-muted mb-2 d-flex flex-column gap-1">
        <div class="d-flex flex-wrap gap-3 align-items-center">
          <span style="background:linear-gradient(90deg,#ff5a5f 50%,#003b95 50%);color:#fff;padding:1px 8px;border-radius:4px;font-weight:bold;">宿泊</span>
          <span><span class="d-inline-block rounded-circle me-1 fc-status-dot" style="width:8px;height:8px;background:#dc3545;border:1px solid #fff;"></span>内容詳細なし</span>
          <span><span class="d-inline-block rounded-circle me-1 fc-status-dot" style="width:8px;height:8px;background:#28a745;border:1px solid #fff;"></span>内容詳細あり</span>
        </div>
        <div class="d-flex flex-wrap gap-3 align-items-center">
          <span style="background:#ffc107;color:#212529;padding:1px 8px;border-radius:4px;font-weight:bold;">清掃</span>
          <span><span class="d-inline-block me-1" style="position:relative;width:14px;height:14px;background:#ffff00;border:1px solid #ccc;vertical-align:middle;"><span style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:8px;height:8px;border-radius:50%;background:#dc3545;display:block;"></span></span>募集中</span>
          <span><span class="d-inline-block rounded-circle me-1 fc-status-dot" style="width:8px;height:8px;background:#198754;border:1px solid #fff;"></span>確定済み</span>
        </div>
      </div>
      <div id="calendarAddBookingArea" class="mb-2" style="display:<?= staffModeStr === 'yes' ? 'none' : '' ?>;"><button type="button" class="btn btn-sm btn-outline-primary" id="btnAddBooking">予約を追加</button></div>
      <div id="calendar"></div>
    </div>
    <div id="panelRecruit" style="display:none;">
      <div id="recruitList"></div>
      <div id="recruitAddListArea" class="mb-3 mt-3"></div>
      <div id="recruitAddBtnArea" class="mt-2" style="display:none;"><button type="button" class="btn btn-sm btn-outline-primary" id="btnAddRecruit">募集を手動で追加</button></div>
    </div>
    <div id="panelStaffSchedule" style="display:none;">
      <div class="mb-2"><label class="form-label small">表示月</label><input type="month" class="form-control form-control-sm" id="staffScheduleMonth" style="max-width:160px;"></div>
      <div id="staffScheduleList"></div>
    </div>
    <div id="panelInvoice" style="display:none;">
      <div class="mb-2 d-flex gap-2 align-items-end">
        <div><label class="form-label small mb-0">対象月</label><input type="month" class="form-control form-control-sm" id="invoiceMonth" style="max-width:160px;"></div>
        <span class="badge bg-secondary align-self-end" id="invoiceYmBadge"></span>
      </div>
      <div id="invoiceNotReady" class="small text-muted mb-2" style="display:none;">
        <p>請求書機能はオーナーによる設定が必要です（保存先フォルダ・テンプレート）。</p>
      </div>
      <div id="invoiceContent" style="display:none;">
        <!-- 清掃実績（自動算出） -->
        <div class="mb-3">
          <label class="form-label small fw-bold mb-1">清掃実績（自動算出） <span id="invoiceExclSaveStatus" class="small" style="display:none;"></span></label>
          <p class="text-muted mb-1" style="font-size:0.7rem;">不要な項目は×で除外できます（カレンダーには影響しません）</p>
          <div id="invoiceAutoItems" class="small"></div>
        </div>
        <!-- 追加項目 -->
        <div class="mb-3">
          <label class="form-label small fw-bold mb-1">追加項目 <span id="invoiceSaveStatus" class="small" style="display:none;"></span></label>
          <p class="text-muted mb-1" style="font-size:0.7rem;">追加した項目は自動保存されます</p>
          <div id="invoiceManualItems"></div>
          <div class="d-flex gap-1 align-items-center flex-wrap mt-1">
            <input type="date" class="form-control form-control-sm" id="invoiceAddDate" style="max-width:130px;">
            <select class="form-select form-select-sm" id="invoiceAddJobSelect" style="max-width:180px;">
              <option value="">選択...</option>
            </select>
            <input type="text" class="form-control form-control-sm" id="invoiceAddCustomName" placeholder="項目名" style="max-width:120px;display:none;">
            <input type="number" class="form-control form-control-sm" id="invoiceAddAmount" placeholder="金額" style="max-width:90px;">
            <button type="button" class="btn btn-sm btn-outline-primary py-0" id="btnInvoiceAddItem">追加</button>
          </div>
        </div>
        <!-- 備考 -->
        <div class="mb-2">
          <label class="form-label small fw-bold mb-1">備考</label>
          <textarea class="form-control form-control-sm" id="invoiceRemarks" rows="2" placeholder="備考があれば記入"></textarea>
        </div>
        <!-- 合計 -->
        <div class="border-top pt-2 mb-2 d-flex justify-content-between align-items-center">
          <span class="fw-bold">合計請求額</span>
          <span class="fw-bold fs-5" id="invoiceTotalDisplay">¥0</span>
        </div>
        <!-- 送信ボタン -->
        <div class="mb-2">
          <button type="button" class="btn btn-primary btn-sm w-100" id="btnSendInvoice">請求書を送信</button>
          <div id="invoiceSendResult" class="small mt-1" style="display:none;"></div>
        </div>
      </div>
      <!-- 送信履歴（サーバーから都度取得） -->
      <div class="mt-3 border-top pt-2">
        <label class="form-label small fw-bold mb-1">送信履歴</label>
        <div class="d-flex gap-2 align-items-end mb-1 flex-wrap">
          <div>
            <label class="form-label small mb-0">対象月</label>
            <select class="form-select form-select-sm" id="staffHistoryFilterYm" style="max-width:140px;">
              <option value="">全期間</option>
            </select>
          </div>
          <button type="button" class="btn btn-sm btn-outline-primary py-0" id="btnRefreshStaffHistory" style="font-size:0.75rem;">検索</button>
          <button type="button" class="btn btn-sm btn-outline-success py-0" id="btnStaffHistoryDownload" style="font-size:0.75rem;" disabled>選択PDFをダウンロード</button>
        </div>
        <div class="mb-1 d-flex gap-2 align-items-center">
          <label class="form-check-label small"><input type="checkbox" class="form-check-input" id="staffHistoryCheckAll"> 全選択</label>
          <span class="small text-muted" id="staffHistorySelectedCount"></span>
        </div>
        <div id="invoiceHistoryList" class="small">
          <span class="text-muted">検索ボタンを押してください。</span>
        </div>
        <div id="staffHistoryDownloadResult" class="small mt-1" style="display:none;"></div>
      </div>
    </div>
    <div id="panelNotifications" style="display:none;">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <span class="fw-bold small">通知一覧</span>
        <button type="button" class="btn btn-sm btn-outline-danger py-0" id="btnClearAllNotifList">一括削除</button>
      </div>
      <div id="notificationListMain"></div>
    </div>
    <div id="panelSettings" style="display:none;">
      <p class="small text-muted" id="settingsDescription">オーナーのみ閲覧・編集可能です。</p>
      <!-- スタッフ用URL -->
      <div id="staffUrlSection" class="mb-3 p-2 border rounded bg-light">
        <label class="form-label small fw-bold">スタッフ用URL（?staff=1付き）</label>
        <p class="small text-muted mb-1">オーナーURLから自動生成されます。コピーしてLINE等で共有できます。</p>
        <div class="d-flex gap-2 flex-wrap align-items-center">
          <input type="url" class="form-control form-control-sm flex-grow-1" id="staffDeployUrlInput" placeholder="自動生成されます" style="min-width:200px;" readonly>
          <button type="button" class="btn btn-sm btn-primary" id="btnCopyStaffUrl">コピー</button>
          <button type="button" class="btn btn-sm btn-outline-secondary" id="btnOpenStaffUrl">開く</button>
        </div>
      </div>
      <!-- チェックリスト写真保存フォルダはチェックアプリの設定タブに移動 -->
      <!-- 初回セットアップ（オーナー未設定時） -->
      <div id="ownerSetupForm" class="mb-3" style="display:none;">
        <div class="alert alert-info small">初回のみオーナー登録を行います。登録後はオーナーのみ設定画面にアクセスできます。</div>
        <div class="mb-2"><label class="form-label">オーナーメールアドレス</label><input type="email" class="form-control" id="ownerSetupEmail" placeholder="your@email.com"></div>
        <div class="mb-2"><label class="form-label">パスワード（6文字以上）</label><input type="password" class="form-control" id="ownerSetupPassword" placeholder="パスワード"></div>
        <div class="mb-2"><label class="form-label">パスワード（確認）</label><input type="password" class="form-control" id="ownerSetupPasswordConfirm" placeholder="パスワード確認"></div>
        <button type="button" class="btn btn-primary" id="btnOwnerSetup">登録</button>
        <div id="ownerSetupError" class="text-danger small mt-2" style="display:none;"></div>
      </div>
      <!-- パスワード未設定時の初回パスワード設定（オーナー登録済み・パスワード未設定） -->
      <div id="ownerPasswordSetupForm" class="mb-3" style="display:none;">
        <div class="alert alert-warning small">パスワードが未設定です。メール変更時に必要になるため、パスワードを設定してください。</div>
        <div class="mb-2"><label class="form-label">パスワード（6文字以上）</label><input type="password" class="form-control" id="ownerPasswordSetup" placeholder="パスワード"></div>
        <div class="mb-2"><label class="form-label">パスワード（確認）</label><input type="password" class="form-control" id="ownerPasswordSetupConfirm" placeholder="パスワード確認"></div>
        <button type="button" class="btn btn-primary" id="btnOwnerPasswordSetup">設定</button>
        <div id="ownerPasswordSetupError" class="text-danger small mt-2" style="display:none;"></div>
      </div>
      <!-- オーナー設定済み時のメール表示・変更 -->
      <div id="ownerEmailSection" class="mb-3" style="display:none;">
        <label class="form-label">オーナーメールアドレス</label>
        <div class="d-flex gap-2 align-items-center">
          <span id="ownerEmailDisplay" class="text-muted"></span>
          <button type="button" class="btn btn-sm btn-outline-secondary" id="btnChangeOwnerEmail">変更</button>
        </div>
      </div>
      <ul class="nav nav-tabs nav-tabs-sm mb-2" id="settingsSubTabs">
        <li class="nav-item"><a class="nav-link active" href="#" data-subtab="staff">清掃スタッフ</a></li>
        <li class="nav-item"><a class="nav-link" href="#" data-subtab="subOwners">サブオーナー</a></li>
        <li class="nav-item"><a class="nav-link" href="#" data-subtab="jobs">仕事内容</a></li>
        <li class="nav-item"><a class="nav-link" href="#" data-subtab="recruitSettings">募集設定</a></li>
        <li class="nav-item"><a class="nav-link" href="#" data-subtab="reminderEmail">スタッフ未決定リマインド</a></li>
        <li class="nav-item"><a class="nav-link" href="#" data-subtab="rosterReminder">名簿未入力リマインド</a></li>
        <li class="nav-item"><a class="nav-link" href="#" data-subtab="sync">予約連携</a></li>
        <li class="nav-item"><a class="nav-link" href="#" data-subtab="notifications">通知履歴</a></li>
        <li class="nav-item"><a class="nav-link" href="#" data-subtab="invoice">請求書</a></li>
        <li class="nav-item"><a class="nav-link" href="#" data-subtab="maintenance">メンテナンス</a></li>
      </ul>
      <div id="settingsStaff">
        <button type="button" class="btn btn-sm btn-primary mb-2" id="btnAddStaff">スタッフ追加</button>
        <div id="staffList"></div>
      </div>
      <div id="settingsSubOwners" style="display:none;">
        <p class="small text-muted mb-2">サブオーナーはオーナーと同様に設定の閲覧・編集ができます。複数追加可能。表示名はカレンダー上部に表示されます。</p>
        <button type="button" class="btn btn-sm btn-primary mb-2" id="btnAddSubOwner">サブオーナー追加</button>
        <div id="subOwnerList"></div>
      </div>
      <div id="settingsJobs" style="display:none;">
        <p class="small text-muted mb-2">仕事内容ごとに、共通またはスタッフ別の報酬を設定できます。</p>
        <button type="button" class="btn btn-sm btn-primary mb-2" id="btnAddJob">仕事内容追加</button>
        <div id="jobList"></div>
      </div>
      <div id="settingsRecruitSettings" style="display:none;">

        <div class="mb-2"><label>最少回答者数（これ未満でリマインド）</label><input type="number" class="form-control form-control-sm" id="minRespondents" min="1" value="2"></div>
        <div class="mb-2"><label>リマインド間隔（週）</label><input type="number" class="form-control form-control-sm" id="reminderIntervalWeeks" min="1" value="1"></div>
        <div class="mb-2"><label>選定人数（基本何人選ぶか）</label><input type="number" class="form-control form-control-sm" id="selectCount" min="1" value="2"></div>
        <button type="button" class="btn btn-sm btn-primary" id="btnSaveRecruitSettings">募集設定を保存</button>
      </div>
      <div id="settingsReminderEmail" style="display:none;">
        <p class="small text-muted mb-2">チェックイン前にオーナーへリマインドメールを送信します。清掃スタッフが未確定（「募集中」）の予約が対象です。最大5件設定できます。</p>
        <div class="mb-3">
          <div class="form-check form-switch mb-2">
            <input class="form-check-input" type="checkbox" id="reminderImmediate" checked>
            <label class="form-check-label small" for="reminderImmediate">iCal取り込み時に1週間以内の予約があれば即時メール送信</label>
          </div>
        </div>
        <div class="mb-3">
          <label class="form-label small fw-bold">リマインドスケジュール</label>
          <div id="reminderEntries">
            <div class="row g-2 align-items-center mb-2 reminder-entry" data-idx="0">
              <div class="col-auto"><input class="form-check-input reminder-enabled" type="checkbox"></div>
              <div class="col"><input type="number" class="form-control form-control-sm reminder-days" min="1" max="90" placeholder="日前" style="width:70px;"></div>
              <div class="col-auto small">日前</div>
              <div class="col"><select class="form-control form-control-sm reminder-time" style="width:110px;"></select></div>
              <div class="col-auto small">に送信</div>
            </div>
            <div class="row g-2 align-items-center mb-2 reminder-entry" data-idx="1">
              <div class="col-auto"><input class="form-check-input reminder-enabled" type="checkbox"></div>
              <div class="col"><input type="number" class="form-control form-control-sm reminder-days" min="1" max="90" placeholder="日前" style="width:70px;"></div>
              <div class="col-auto small">日前</div>
              <div class="col"><select class="form-control form-control-sm reminder-time" style="width:110px;"></select></div>
              <div class="col-auto small">に送信</div>
            </div>
            <div class="row g-2 align-items-center mb-2 reminder-entry" data-idx="2">
              <div class="col-auto"><input class="form-check-input reminder-enabled" type="checkbox"></div>
              <div class="col"><input type="number" class="form-control form-control-sm reminder-days" min="1" max="90" placeholder="日前" style="width:70px;"></div>
              <div class="col-auto small">日前</div>
              <div class="col"><select class="form-control form-control-sm reminder-time" style="width:110px;"></select></div>
              <div class="col-auto small">に送信</div>
            </div>
            <div class="row g-2 align-items-center mb-2 reminder-entry" data-idx="3">
              <div class="col-auto"><input class="form-check-input reminder-enabled" type="checkbox"></div>
              <div class="col"><input type="number" class="form-control form-control-sm reminder-days" min="1" max="90" placeholder="日前" style="width:70px;"></div>
              <div class="col-auto small">日前</div>
              <div class="col"><select class="form-control form-control-sm reminder-time" style="width:110px;"></select></div>
              <div class="col-auto small">に送信</div>
            </div>
            <div class="row g-2 align-items-center mb-2 reminder-entry" data-idx="4">
              <div class="col-auto"><input class="form-check-input reminder-enabled" type="checkbox"></div>
              <div class="col"><input type="number" class="form-control form-control-sm reminder-days" min="1" max="90" placeholder="日前" style="width:70px;"></div>
              <div class="col-auto small">日前</div>
              <div class="col"><select class="form-control form-control-sm reminder-time" style="width:110px;"></select></div>
              <div class="col-auto small">に送信</div>
            </div>
          </div>
        </div>
        <hr class="my-3">
        <label class="form-label small fw-bold">メール文面テンプレート（定期リマインド）</label>
        <p class="small text-muted mb-1">空欄の場合はデフォルト文面が使われます。プレースホルダー: <code>{チェックイン}</code> <code>{チェックアウト}</code> <code>{残り日数}</code> <code>{清掃詳細リンク}</code></p>
        <div class="mb-2">
          <label class="form-label small">件名</label>
          <input type="text" class="form-control form-control-sm" id="reminderSubject" placeholder="例: 【民泊】清掃スタッフ未確定のリマインド: {チェックイン}">
        </div>
        <div class="mb-3">
          <label class="form-label small">本文</label>
          <textarea class="form-control form-control-sm" id="reminderBody" rows="5" placeholder="例: 清掃スタッフがまだ確定していません。&#10;チェックイン: {チェックイン}&#10;残り日数: {残り日数}日&#10;詳細: {清掃詳細リンク}"></textarea>
        </div>
        <label class="form-label small fw-bold">メール文面テンプレート（即時リマインド）</label>
        <p class="small text-muted mb-1">iCal取り込み時の直前予約通知用。プレースホルダー: <code>{チェックイン}</code> <code>{チェックアウト}</code> <code>{プラットフォーム}</code> <code>{残り日数}</code> <code>{清掃詳細リンク}</code></p>
        <div class="mb-2">
          <label class="form-label small">件名</label>
          <input type="text" class="form-control form-control-sm" id="immediateSubject" placeholder="例: 【民泊】直前予約 - 清掃スタッフ手配が必要: {チェックイン}">
        </div>
        <div class="mb-3">
          <label class="form-label small">本文</label>
          <textarea class="form-control form-control-sm" id="immediateBody" rows="5" placeholder="例: 直前予約が追加されました。&#10;チェックイン: {チェックイン}&#10;プラットフォーム: {プラットフォーム}&#10;詳細: {清掃詳細リンク}"></textarea>
        </div>
        <button type="button" class="btn btn-sm btn-primary" id="btnSaveReminderEmail">リマインド設定を保存</button>
        <p class="small text-muted mt-2">※ 送信には時間ベースのトリガー（1時間ごと）の設定が必要です。GASエディタで <code>checkAndSendReminderEmails</code> のトリガーを追加してください。</p>
      </div>
      <div id="settingsRosterReminder" style="display:none;">
        <p class="small text-muted mb-2">チェックイン日が近い予約について、宿泊者名簿が未記入の場合にオーナー宛に通知とメールを送ります。オーナーは通知を見て、宿泊者に名簿記入を催促してください。</p>
        <div class="form-check form-switch mb-2">
          <input class="form-check-input" type="checkbox" id="rosterReminderEnabled">
          <label class="form-check-label" for="rosterReminderEnabled">名簿未入力リマインドを有効にする</label>
        </div>
        <div class="mb-2"><label class="form-label small">チェックイン何日前に通知</label><input type="number" class="form-control form-control-sm" id="rosterReminderDaysBefore" min="1" max="30" value="3" style="max-width:100px;"></div>
        <div class="mb-2"><label class="form-label small">通知時刻</label><select class="form-select form-select-sm" id="rosterReminderHour" style="max-width:120px;"></select></div>
        <button type="button" class="btn btn-sm btn-primary" id="btnSaveRosterReminder">名簿未入力リマインド設定を保存</button>
      </div>
      <div id="settingsSync" style="display:none;">
        <p class="small text-muted">Airbnb・Booking.comなどのiCal URLを登録すると、予約を自動取り込みできます。宿泊者がフォームで詳細入力すると、既存予約にマージされます。</p>
        <button type="button" class="btn btn-sm btn-outline-primary mb-2" id="btnAddSync">連携を追加</button>
        <button type="button" class="btn btn-sm btn-primary mb-2 ms-1" id="btnRunSync">今すぐ同期</button>
        <button type="button" class="btn btn-sm btn-outline-danger mb-2 ms-1" id="btnClearSynced">iCal紐付けを一括解除</button>
        <button type="button" class="btn btn-sm btn-outline-secondary mb-2 ms-1" id="btnImportSpreadsheet">別スプシから読み込み</button>
        <button type="button" class="btn btn-sm btn-outline-secondary mb-2 ms-1" id="btnReloadDataSync" title="スプシの内容を再読み込みしてカレンダーを更新">スプシを再読み込み</button>
        <div id="syncList"></div>
        <div id="syncResult" class="small mt-2" style="display:none;"></div>
        <hr class="my-3">
        <div class="mb-2">
          <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" id="autoSyncEnabled">
            <label class="form-check-label small fw-bold" for="autoSyncEnabled">自動同期を有効にする</label>
          </div>
        </div>
        <div class="mb-2">
          <label class="form-label small">同期間隔</label>
          <select class="form-select form-select-sm" id="autoSyncInterval" style="max-width:160px;">
            <option value="1">1時間ごと</option>
            <option value="2">2時間ごと</option>
            <option value="4">4時間ごと</option>
            <option value="6">6時間ごと</option>
            <option value="12">12時間ごと</option>
            <option value="24">24時間ごと</option>
          </select>
        </div>
        <button type="button" class="btn btn-sm btn-primary" id="btnSaveAutoSync">自動同期設定を保存</button>
        <div id="autoSyncSaveResult" class="small mt-1" style="display:none;"></div>
      </div>
      <div id="settingsNotifications" style="display:none;">
        <p class="small text-muted mb-2">回答・回答取消・予約追加・予約削除・フォーム回答などの通知履歴です。</p>
        <div id="notificationList"></div>
      </div>
      <div id="settingsInvoice" style="display:none;">
        <p class="small text-muted mb-2">スタッフが請求書を作成・送信するための設定です。</p>
        <div class="mb-3">
          <label class="form-label small fw-bold">保存先フォルダ</label>
          <p class="small text-muted mb-1">請求書PDFの保存先GoogleドライブフォルダのURL、またはフォルダIDを入力してください。月ごとにサブフォルダ(YYYY-MM)が自動作成されます。</p>
          <div class="d-flex gap-2 flex-wrap align-items-center">
            <input type="text" class="form-control form-control-sm" id="invoiceFolderIdInput" placeholder="URL or フォルダID" style="max-width:400px;">
            <button type="button" class="btn btn-sm btn-outline-primary" id="btnSaveInvoiceFolder">保存</button>
          </div>
          <div id="invoiceFolderSaveResult" class="small mt-1" style="display:none;"></div>
        </div>
        <div class="mb-3">
          <label class="form-label small fw-bold">テンプレートDoc</label>
          <p class="small text-muted mb-1">請求書テンプレートのGoogleドキュメントURL、またはDoc IDを入力してください。</p>
          <div class="d-flex gap-2 flex-wrap align-items-center">
            <input type="text" class="form-control form-control-sm" id="invoiceTemplateDocIdInput" placeholder="URL or Doc ID" style="max-width:400px;">
            <button type="button" class="btn btn-sm btn-outline-primary" id="btnSaveInvoiceTemplate">保存</button>
          </div>
          <div id="invoiceTemplateSaveResult" class="small mt-1" style="display:none;"></div>
        </div>
        <!-- 権限承認不要（Docs REST API使用） -->
        <hr>
        <!-- オーナー用：請求書一覧 -->
        <div class="mb-2">
          <label class="form-label small fw-bold">請求書一覧（全スタッフ）</label>
          <div class="d-flex gap-2 flex-wrap align-items-end mb-2">
            <div>
              <label class="form-label small mb-0">スタッフ</label>
              <select class="form-select form-select-sm" id="ownerInvFilterStaff" style="max-width:160px;">
                <option value="">全員</option>
              </select>
            </div>
            <div>
              <label class="form-label small mb-0">対象月</label>
              <select class="form-select form-select-sm" id="ownerInvFilterYm" style="max-width:140px;">
                <option value="">全期間</option>
              </select>
            </div>
            <button type="button" class="btn btn-sm btn-outline-primary" id="btnOwnerInvSearch">検索</button>
            <button type="button" class="btn btn-sm btn-outline-success" id="btnOwnerInvDownload" disabled>選択したPDFをダウンロード</button>
          </div>
          <div class="mb-1 d-flex gap-2 align-items-center">
            <label class="form-check-label small"><input type="checkbox" class="form-check-input" id="ownerInvCheckAll"> 全選択</label>
            <span class="small text-muted" id="ownerInvSelectedCount"></span>
          </div>
          <div id="ownerInvList" class="small">
            <span class="text-muted">検索ボタンを押してください。</span>
          </div>
          <div id="ownerInvDownloadResult" class="small mt-1" style="display:none;"></div>
        </div>
      </div>
      <div id="settingsMaintenance" style="display:none;">
        <p class="small text-muted mb-2">スプレッドシートの空白行・空白列を削除してセル数を最適化します。Google Sheetsの1000万セル上限に近づいた場合に実行してください。</p>
        <button type="button" class="btn btn-sm btn-primary mb-2" id="btnTrimSpreadsheet">スプレッドシートを最適化</button>
        <div id="trimResult" class="small mt-2" style="display:none;"></div>
      </div>
    </div>
  </div>

  <!-- 予約手動追加モーダル -->
  <div class="modal fade" id="addBookingModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header"><h6 class="modal-title">予約を追加</h6><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body">
          <p class="small text-muted">プラットフォームの予約情報を手動で登録。宿泊者がフォーム入力すると詳細が反映されます。</p>
          <div class="mb-2"><label class="form-label">チェックイン</label><input type="date" class="form-control" id="addBookingCheckIn"></div>
          <div class="mb-2"><label class="form-label">チェックアウト</label><input type="date" class="form-control" id="addBookingCheckOut"></div>
          <div class="mb-2"><label class="form-label">宿泊者名（任意）</label><input type="text" class="form-control" id="addBookingGuestName" placeholder="未入力可"></div>
          <div class="mb-2"><label class="form-label">予約サイト</label><input type="text" class="form-control" id="addBookingSite" placeholder="Airbnb, Booking.com など"></div>
          <div class="mb-2"><label class="form-label">宿泊人数（任意）</label><input type="text" class="form-control" id="addBookingGuestCount" placeholder="例: 4"></div>
          <div id="addBookingError" class="text-danger small mt-2" style="display:none;"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
          <button type="button" class="btn btn-primary" id="btnConfirmAddBooking">追加</button>
        </div>
      </div>
    </div>
  </div>

  <!-- 募集手動追加モーダル -->
  <div class="modal fade" id="addRecruitModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header"><h6 class="modal-title">募集を追加</h6><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body">
          <p class="small text-muted">募集がまだない予約から選択してください。追加後、一覧でタップして告知方法（メール/LINE）を選び送信します。</p>
          <div id="addRecruitBookingsList"></div>
          <div id="addRecruitEmpty" class="text-muted small" style="display:none;">追加できる予約はありません。（すべて募集済みか、チェックアウト日が取得できない予約のみです）</div>
          <div id="addRecruitError" class="text-danger small mt-2" style="display:none;"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">閉じる</button>
        </div>
      </div>
    </div>
  </div>

  <!-- オーナーメール変更モーダル -->
  <div class="modal fade" id="ownerEmailChangeModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header"><h6 class="modal-title">オーナーメールの変更</h6><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body">
          <div class="mb-2"><label class="form-label">新しいメールアドレス</label><input type="email" class="form-control" id="ownerEmailNew" placeholder="new@email.com"></div>
          <div class="mb-2"><label class="form-label">現在のパスワード（確認用）</label><input type="password" class="form-control" id="ownerEmailPassword" placeholder="パスワード"></div>
          <div id="ownerEmailChangeError" class="text-danger small mt-2" style="display:none;"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
          <button type="button" class="btn btn-primary" id="btnConfirmOwnerEmailChange">変更</button>
        </div>
      </div>
    </div>
  </div>

  <!-- イベント詳細モーダル -->
  <div class="modal fade" id="eventModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header" id="eventModalHeader">
          <h6 class="modal-title flex-grow-1" id="eventModalTitle">予約詳細</h6>
          <span id="checklistBtnHeaderArea" class="me-2" style="display:none;"></span>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body" id="eventModalBody"></div>
        <div class="modal-footer modal-footer-redesign" id="eventModalFooter">
          <div class="footer-btn-row" id="eventModalActionBtns"></div>
          <div id="eventModalVolunteerCenter" class="d-flex flex-wrap justify-content-center gap-1 w-100"></div>
          <div class="footer-center" id="eventModalDeleteArea" style="display:none;">
            <button type="button" class="btn btn-danger btn-sm" id="btnDeleteBooking">予約を削除</button>
          </div>
          <div class="footer-center">
            <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">閉じる</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 清掃担当編集モーダル（カレンダー用） -->
  <div class="modal fade" id="staffEditModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h6 class="modal-title">清掃担当者の編集</h6>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <p class="small text-muted mb-2">一人一行で表示。削除ボタンでその行を削除。全削除時は募集中に戻ります。</p>
          <div id="staffEditList" class="mb-2"></div>
          <div class="d-flex gap-2 align-items-center mb-2">
            <select class="form-select form-select-sm flex-grow-1" id="staffEditAddSelect" style="max-width:200px;">
              <option value="">追加するスタッフを選択</option>
            </select>
            <button type="button" class="btn btn-sm btn-outline-primary" id="btnStaffEditAdd">追加</button>
          </div>
          <div id="staffEditOtherArea" class="d-flex gap-2 align-items-center mb-2" style="display:none !important;">
            <input type="text" class="form-control form-control-sm flex-grow-1" id="staffEditOtherName" placeholder="名前を入力" style="max-width:200px;">
            <button type="button" class="btn btn-sm btn-outline-primary" id="btnStaffEditAddOther">追加</button>
          </div>
          <input type="hidden" id="staffEditRowNumber">
          <div id="staffEditError" class="text-danger small mt-2" style="display:none;"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
          <button type="button" class="btn btn-primary" id="btnSaveStaff">保存</button>
        </div>
      </div>
    </div>
  </div>

  <!-- サブオーナー編集モーダル -->
  <div class="modal fade" id="subOwnerFormModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header"><h6 class="modal-title">サブオーナー</h6><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body">
          <input type="hidden" id="subOwnerFormRowIndex">
          <div class="mb-2"><label class="form-label">メールアドレス</label><input type="email" class="form-control" id="subOwnerFormEmail" placeholder="subowner@example.com"></div>
          <div class="mb-2"><label class="form-label">表示名（任意・未入力時はメールの@前を表示）</label><input type="text" class="form-control" id="subOwnerFormDisplayName" placeholder="例: yamasuke81"></div>
          <div id="subOwnerFormError" class="text-danger small" style="display:none;"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
          <button type="button" class="btn btn-primary" id="btnSaveSubOwnerForm">保存</button>
        </div>
      </div>
    </div>
  </div>

  <!-- 仕事内容追加・編集モーダル -->
  <div class="modal fade" id="jobFormModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header"><h6 class="modal-title">仕事内容</h6><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body">
          <input type="hidden" id="jobFormRowIndex"><input type="hidden" id="jobFormSortOrder">
          <div class="mb-2"><label class="form-label">仕事内容名</label><input type="text" class="form-control" id="jobFormName" placeholder="例: 1名で清掃"></div>
          <div id="jobFormError" class="text-danger small" style="display:none;"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
          <button type="button" class="btn btn-primary" id="btnSaveJobForm">保存</button>
        </div>
      </div>
    </div>
  </div>

  <!-- 仕事内容の報酬設定モーダル -->
  <div class="modal fade" id="jobCompFormModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content">
        <div class="modal-header"><h6 class="modal-title">報酬設定</h6><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body">
          <input type="hidden" id="jobCompFormJobName">
          <div class="mb-3"><label class="form-label">仕事内容</label><div id="jobCompFormJobNameDisplay" class="fw-bold"></div></div>
          <div class="mb-2"><label class="form-label">報酬額（円）未設定は空欄、共通は全スタッフに適用</label></div>
          <div id="jobCompFormTable" class="mb-2"></div>
          <hr class="my-3">
          <div class="mb-2"><label class="form-label">特別料金（年末年始等・全員共通）対象日の作業に追加されます</label></div>
          <div id="jobCompFormSpecialRates" class="mb-2"></div>
          <button type="button" class="btn btn-sm btn-outline-secondary mb-2" id="btnAddSpecialRate">行を追加</button>
          <div id="jobCompFormError" class="text-danger small" style="display:none;"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
          <button type="button" class="btn btn-primary" id="btnSaveJobCompForm">保存</button>
        </div>
      </div>
    </div>
  </div>

  <!-- 別スプシ読み込みモーダル -->
  <div class="modal fade" id="importSpreadsheetModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header"><h6 class="modal-title">別スプシから読み込み</h6><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body">
          <p class="small text-muted">削除したフォームの回答スプシやバックアップから予約データを読み込みます。URLを貼り付けてください。</p>
          <div class="mb-2"><label class="form-label">スプレッドシートのURL</label><input type="url" class="form-control" id="importSpreadsheetUrl" placeholder="https://docs.google.com/spreadsheets/d/..."></div>
          <div class="form-check mb-2">
            <input type="checkbox" class="form-check-input" id="importSkipDuplicates" checked>
            <label class="form-check-label small" for="importSkipDuplicates">既存の同じチェックイン・チェックアウトの行はスキップ</label>
          </div>
          <div id="importSpreadsheetError" class="text-danger small mt-2" style="display:none;"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
          <button type="button" class="btn btn-primary" id="btnConfirmImportSpreadsheet">読み込み</button>
        </div>
      </div>
    </div>
  </div>

  <!-- 予約連携追加モーダル -->
  <div class="modal fade" id="syncFormModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header"><h6 class="modal-title">予約連携</h6><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body">
          <input type="hidden" id="syncFormRowIndex">
          <div class="mb-2"><label class="form-label">プラットフォーム名</label><input type="text" class="form-control" id="syncFormPlatformName" placeholder="例: Airbnb"></div>
          <div class="mb-2"><label class="form-label">iCal URL</label><input type="url" class="form-control" id="syncFormIcalUrl" placeholder="https://..."></div>
          <div id="syncFormError" class="text-danger small" style="display:none;"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
          <button type="button" class="btn btn-primary" id="btnSaveSyncForm">保存</button>
        </div>
      </div>
    </div>
  </div>

  <!-- スタッフ編集モーダル（設定用） -->
  <div class="modal fade" id="staffFormModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content">
        <div class="modal-header"><h6 class="modal-title">清掃スタッフ</h6><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body">
          <input type="hidden" id="staffFormRowIndex">
          <div class="mb-2"><label class="form-label">名前</label><input type="text" class="form-control" id="staffFormName"></div>
          <div class="mb-2"><label class="form-label">住所</label><input type="text" class="form-control" id="staffFormAddress"></div>
          <div class="mb-2"><label class="form-label">メール</label><input type="email" class="form-control" id="staffFormEmail"></div>
          <div class="mb-2"><label class="form-label">金融機関名</label><input type="text" class="form-control" id="staffFormBankName"></div>
          <div class="mb-2"><label class="form-label">支店名</label><input type="text" class="form-control" id="staffFormBankBranch"></div>
          <div class="mb-2"><label class="form-label">口座種類</label><input type="text" class="form-control" id="staffFormAccountType" placeholder="普通・当座など"></div>
          <div class="mb-2"><label class="form-label">口座番号</label><input type="text" class="form-control" id="staffFormAccountNumber"></div>
          <div class="mb-2"><label class="form-label">口座名義</label><input type="text" class="form-control" id="staffFormAccountHolder"></div>
          <div id="staffFormError" class="text-danger small" style="display:none;"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
          <button type="button" class="btn btn-primary" id="btnSaveStaffForm">保存</button>
        </div>
      </div>
    </div>
  </div>

  <!-- 予約削除確認モーダル -->
  <div class="modal fade" id="deleteBookingConfirmModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header"><h6 class="modal-title">予約の削除</h6><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body">
          <p class="mb-2">この予約を削除しますか？キャンセルや誤登録の削除に使います。</p>
          <div id="deleteBookingConfirmInfo" class="small text-muted mb-3"></div>
          <p class="small text-danger">削除すると元に戻せません。</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
          <button type="button" class="btn btn-danger" id="btnConfirmDeleteBooking">削除する</button>
        </div>
      </div>
    </div>
  </div>


  <!-- 写真プレビューモーダル -->
  <div class="modal fade" id="photoPreviewModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content">
        <div class="modal-header"><h6 class="modal-title" id="photoPreviewTitle">写真</h6><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body text-center"><img id="photoPreviewImg" src="" style="max-width:100%; max-height:70vh; border-radius:8px;"></div>
      </div>
    </div>
  </div>

  <!-- LINE用コピーテキストモーダル -->
  <div class="modal fade" id="lineCopyModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header"><h6 class="modal-title">LINE用テキスト（コピーしてLINEグループに投稿）</h6><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body">
          <textarea id="lineCopyText" class="form-control font-monospace small" rows="6"></textarea>
          <button type="button" class="btn btn-sm btn-outline-primary mt-2" id="btnCopyLineText">コピー</button>
        </div>
      </div>
    </div>
  </div>

  <!-- カスタム確認モーダル（confirm()代替） -->
  <div class="modal fade" id="customConfirmModal" tabindex="-1" data-bs-backdrop="static" style="z-index:1070;">
    <div class="modal-dialog modal-dialog-centered modal-sm">
      <div class="modal-content">
        <div class="modal-body py-4 text-center">
          <p id="customConfirmMessage" class="mb-0" style="white-space:pre-wrap;"></p>
        </div>
        <div class="modal-footer justify-content-center border-0 pt-0">
          <button type="button" class="btn btn-primary px-4" id="customConfirmOk">OK</button>
          <button type="button" class="btn btn-outline-secondary px-3" id="customConfirmCancel">キャンセル</button>
        </div>
      </div>
    </div>
  </div>
  <!-- カスタムアラートモーダル（alert()代替） -->
  <div class="modal fade" id="customAlertModal" tabindex="-1" style="z-index:1070;">
    <div class="modal-dialog modal-dialog-centered modal-sm">
      <div class="modal-content">
        <div class="modal-body py-4 text-center">
          <p id="customAlertMessage" class="mb-0" style="white-space:pre-wrap;"></p>
        </div>
        <div class="modal-footer justify-content-center border-0 pt-0">
          <button type="button" class="btn btn-primary px-4" data-bs-dismiss="modal">OK</button>
        </div>
      </div>
    </div>
  </div>

  <!-- 請求明細モーダル -->
  <div class="modal fade" id="invoiceDetailModal" tabindex="-1" style="z-index:1070;">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header py-2">
          <h6 class="modal-title" id="invoiceDetailModalTitle">明細</h6>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body p-0">
          <table class="table table-sm mb-0" id="invoiceDetailTable">
            <thead><tr><th class="ps-3" style="width:25%">日付</th><th style="width:45%">項目</th><th class="text-end pe-3" style="width:30%">金額</th></tr></thead>
            <tbody id="invoiceDetailBody"></tbody>
            <tfoot><tr class="fw-bold table-light"><td class="ps-3" colspan="2">合計</td><td class="text-end pe-3" id="invoiceDetailTotal"></td></tr></tfoot>
          </table>
        </div>
        <div class="modal-footer justify-content-center border-0 pt-0">
          <button type="button" class="btn btn-primary px-4" data-bs-dismiss="modal">OK</button>
        </div>
      </div>
    </div>
  </div>

  <!-- 募集編集モーダル -->
  <div class="modal fade" id="recruitEditModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content">
        <div class="modal-header"><h6 class="modal-title" id="recruitEditModalTitle">募集内容</h6><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body">
          <p class="small fw-bold mb-1">清掃日</p>
          <p class="small text-muted mb-2" id="recruitEditCleaningDate"></p>
          <p class="small fw-bold mb-1">次回予約</p>
          <div class="mb-2">
            <label class="form-label small">日付</label><input type="text" class="form-control form-control-sm mb-1" id="recruitEditReserveDate" placeholder="例: 2026-02-01 ～ 2026-02-05">
            <label class="form-label small">人数</label><input type="text" class="form-control form-control-sm mb-1" id="recruitEditReserveGuestCount" placeholder="例: 大人4名、3歳以下1名">
            <label class="form-label small">BBQ</label><input type="text" class="form-control form-control-sm mb-1" id="recruitEditReserveBBQ" placeholder="有/無など">
            <label class="form-label small">国籍</label><input type="text" class="form-control form-control-sm mb-1" id="recruitEditReserveNationality" placeholder="例: 日本">
            <label class="form-label small">ベッド</label><input type="text" class="form-control form-control-sm mb-1" id="recruitEditReserveBedCount" placeholder="例: 1人1台ずつ">
            <label class="form-label small">メモ</label><textarea class="form-control form-control-sm mb-1" id="recruitEditReserveMemo" rows="2" placeholder="自由記入"></textarea>
          </div>
          <p class="small mb-2" id="recruitEditStatus"></p>
          <p class="small mb-2" id="recruitEditVolunteers"></p>
          <div class="d-flex flex-wrap gap-2 mb-2">
            <button type="button" class="btn btn-sm btn-primary recruit-edit-owner-only" id="btnRecruitEditSave">保存</button>
            <button type="button" class="btn btn-sm btn-primary recruit-edit-owner-only" id="btnRecruitEditMail">メール送信</button>
            <button type="button" class="btn btn-sm btn-info text-white recruit-edit-owner-only" id="btnRecruitEditCopy">テキストコピー</button>
            <button type="button" class="btn btn-sm btn-danger" id="btnRecruitEditCancel" style="display:none;">募集取消</button>
          </div>
          <div id="recruitEditSelectArea" class="mb-2" style="display:none;"><button type="button" class="btn btn-sm btn-primary" id="btnRecruitEditSelect">選定</button></div>
          <div id="recruitEditConfirmArea" class="mb-2" style="display:none;"><button type="button" class="btn btn-sm btn-warning fw-bold" id="btnRecruitEditConfirm">確定（募集締切）</button></div>
          <div id="recruitEditVolunteerArea" class="mb-2" style="display:none;">
          </div>
          <div id="recruitEditLineCopyArea" class="mb-2 mt-2 p-2 border rounded bg-light" style="display:none;">
            <p class="small fw-bold mb-1">LINE用テキスト（コピーしてLINEグループに投稿）</p>
            <textarea id="recruitEditLineCopyText" class="form-control font-monospace small mb-2" rows="6"></textarea>
            <button type="button" class="btn btn-sm btn-primary" id="btnRecruitEditCopyToClipboard">コピー</button>
          </div>
          <div id="recruitEditError" class="text-danger small mt-2" style="display:none;"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- 募集・選定モーダル -->
  <div class="modal fade" id="recruitSelectModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header"><h6 class="modal-title" id="recruitSelectModalTitle">清掃担当を選定</h6><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body">
          <p class="small text-muted" id="recruitSelectDate"></p>
          <label class="form-label">選定スタッフ</label>
          <div id="recruitSelectStaffList" class="mb-2"></div>
          <div class="d-flex gap-2 align-items-center mb-2">
            <select class="form-select form-select-sm flex-grow-1" id="recruitSelectStaffDropdown"></select>
            <button type="button" class="btn btn-sm btn-outline-secondary" id="btnAddSelectStaff" title="追加">＋</button>
          </div>
          <div id="recruitSelectOtherArea" class="d-flex gap-2 align-items-center mb-2" style="display:none !important;">
            <input type="text" class="form-control form-control-sm flex-grow-1" id="recruitSelectOtherName" placeholder="名前を入力">
            <button type="button" class="btn btn-sm btn-outline-secondary" id="btnAddSelectOther" title="追加">＋</button>
          </div>
          <input type="hidden" id="recruitSelectRowIndex">
          <div id="recruitSelectError" class="text-danger small mt-2" style="display:none;"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
          <button type="button" class="btn btn-primary" id="btnConfirmSelect">選定して保存</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ローディング -->
  <div class="loading-overlay" id="loadingOverlay" style="display:none;">
    <div class="spinner-border text-primary mb-2" role="status"></div>
    <div class="text-muted">読み込み中…</div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/locales/ja.global.min.js"></script>
  <script>
    (function() {
      'use strict';

      // --- iOS Safari 対策: alert() をトースト通知に置き換え ---
      function _showToast(msg, type) {
        type = type || 'info';
        var colorMap = { info: '#0d6efd', success: '#198754', warning: '#ffc107', danger: '#dc3545' };
        var textColor = type === 'warning' ? '#000' : '#fff';
        var toast = document.createElement('div');
        toast.style.cssText = 'position:fixed;top:12px;left:50%;transform:translateX(-50%);z-index:99999;' +
          'background:' + (colorMap[type] || colorMap.info) + ';color:' + textColor + ';padding:10px 20px;' +
          'border-radius:8px;font-size:14px;max-width:90vw;text-align:center;box-shadow:0 4px 12px rgba(0,0,0,0.3);' +
          'opacity:0;transition:opacity 0.3s;word-break:break-word;';
        toast.textContent = msg;
        document.body.appendChild(toast);
        requestAnimationFrame(function() { toast.style.opacity = '1'; });
        setTimeout(function() {
          toast.style.opacity = '0';
          setTimeout(function() { toast.remove(); }, 400);
        }, 3500);
      }
      window._showToast = _showToast;
      // GASのiframe内ではalert()がブロックされるため、グローバルにオーバーライド
      window.alert = function(msg) { _showToast(String(msg), 'info'); };
      // iOS SafariのGASフレーム内ではconfirm()がブロックされfalseが返る
      var _origConfirm = window.confirm;
      var _isIOSGAS = /iPad|iPhone|iPod/.test(navigator.userAgent) && window !== window.top;
      window.confirm = function(msg) {
        if (_isIOSGAS) {
          _showToast(String(msg), 'warning');
          return true;
        }
        return _origConfirm.call(window, msg);
      };

      // staffModeは文字列比較で確実に判定（GASテンプレートのboolean出力問題を回避）
      window.staffMode = ('<?= staffModeStr ?>' === 'yes');
      window.appBaseUrl = <?= JSON.stringify(baseUrl) ?> || '';
      // ディープリンク: URLパラメータで指定された日付の清掃詳細を自動で開く
      window.initialCleaningDate = '<?= initialCleaningDate ?>' || '';
      // デバッグ: デプロイ確認用
      try {
        var dv = document.getElementById('deployVersion');
        var dbgQs = '<?= debugQueryString ?>';
        var dbgSp = '<?= debugStaffParam ?>';
        var dbgRaw = '<?= isStaffMode ?>';
        var dbgStr = '<?= staffModeStr ?>';
        // バージョン表示（オーナー・スタッフ共通）
        if (dv) dv.style.display = '';
      } catch(e) {}

      let calendar;
      let allBookings = [];
      const CLEANING_COLOR = '#198754';
      const INVALID_COLOR = '#6c757d';
      var PLATFORM_COLORS = {
        'booking.com': '#003b95',
        'airbnb': '#ff5a5f',
        '楽天': '#00A04A',
        '楽天トラベル': '#00A04A',
        'rakuten': '#00A04A'
      };
      var DEFAULT_BOOKING_COLOR = '#6c757d';

      function getPlatformColor(bookingSite) {
        if (!bookingSite) return DEFAULT_BOOKING_COLOR;
        var s = String(bookingSite).toLowerCase().trim();
        var icalPart = '', formPart = '';
        if (s.indexOf('（') >= 0) {
          icalPart = s.substring(0, s.indexOf('（')).trim();
          formPart = s.substring(s.indexOf('（') + 1).replace(/）$/, '').trim();
        } else {
          icalPart = s;
        }
        var forColor = (icalPart && icalPart !== '-') ? icalPart : formPart;
        if (forColor && forColor.indexOf('booking') >= 0) return PLATFORM_COLORS['booking.com'];
        if (forColor && forColor.indexOf('airbnb') >= 0) return PLATFORM_COLORS['airbnb'];
        if (forColor && (forColor.indexOf('楽天') >= 0 || forColor.indexOf('rakuten') >= 0)) return PLATFORM_COLORS['楽天'];
        return DEFAULT_BOOKING_COLOR;
      }

      function isRosterAnswered(b) {
        var name = String(b.guestName || '').trim();
        if (!name) return false;
        var lower = name.toLowerCase();
        if (/not available|reserved|closed|不明/i.test(name)) return false;
        if (lower === 'airbnb' || lower === 'booking.com') return false;
        return name.length > 0;
      }

      // BBQフラグ判定
      function getBBQFlag(bbqVal) {
        if (!bbqVal || typeof bbqVal !== 'string') return '?';
        const v = bbqVal.trim().toLowerCase();
        if (v.indexOf('yes') > -1 || v.indexOf('はい') > -1) return '有';
        if (v.indexOf('no') > -1 || v.indexOf('いいえ') > -1) return '無';
        return '?';
      }
      function getParkingFlag(parkingVal) {
        if (parkingVal == null || parkingVal === '') return '';
        const v = String(parkingVal).trim();
        if (!v) return '';
        if (v.indexOf('利用しない') > -1) return '不要';
        if (v.indexOf('2台') > -1 || v.indexOf('2台利用') > -1) return '2台';
        if (v.indexOf('1台') > -1 || v.indexOf('1台利用') > -1) return '1台';
        return '';
      }
      // BBQ あり/なし表示用
      function bbqAriNashi(val) {
        var f = getBBQFlag(val);
        return f === '有' ? 'あり' : (f === '無' ? 'なし' : f);
      }
      // 駐車場 あり/なし表示用
      function parkingAriNashi(val) {
        var f = getParkingFlag(val);
        if (f === '1台' || f === '2台') return 'あり';
        if (f === '不要') return 'なし';
        return '';
      }

      // スタッフ回答状況を表示するHTML生成
      function renderStaffResponses(volunteers, compact) {
        if (!volunteers || !volunteers.length) return 'スタッフなし';
        // 記号変換: ◎→●、△→▲、×→✖
        function toDisplaySymbol(resp) {
          if (resp === '◎') return '●';
          if (resp === '△') return '▲';
          if (resp === '×') return '✖';
          return '未回答';
        }
        if (compact) {
          // コンパクト表示（募集一覧カード用）: ●2 ▲1 ✖0 未1
          var counts = { '◎': 0, '△': 0, '×': 0, '未回答': 0 };
          volunteers.forEach(function(v) { counts[v.response || '未回答'] = (counts[v.response || '未回答'] || 0) + 1; });
          var parts = [];
          if (counts['◎']) parts.push('<span class="text-success fw-bold">●' + counts['◎'] + '</span>');
          if (counts['△']) parts.push('<span class="text-warning fw-bold">▲' + counts['△'] + '</span>');
          if (counts['×']) parts.push('<span class="text-danger fw-bold">✖' + counts['×'] + '</span>');
          if (counts['未回答']) parts.push('<span class="text-muted">未' + counts['未回答'] + '</span>');
          return parts.join(' ');
        }
        // 詳細表示（モーダル用）: 名前 → 回答 の順で表示、未回答の頭揃え
        return '<div style="display:grid; grid-template-columns: auto 1fr; gap: 2px 8px; font-size:0.85rem;">' + volunteers.map(function(v) {
          var respClass = v.response === '◎' ? 'text-success' : (v.response === '△' ? 'text-warning' : (v.response === '×' ? 'text-danger' : 'text-muted'));
          var respText = toDisplaySymbol(v.response || '未回答');
          var memoText = v.memo ? ' <small class="text-muted">(' + escapeHtml(v.memo) + ')</small>' : '';
          return '<div class="py-1">' + escapeHtml(v.staffName) + '</div><div class="py-1"><span class="' + respClass + ' fw-bold">' + respText + '</span>' + memoText + '</div>';
        }).join('') + '</div>';
      }

      // 宿泊人数表示: 大人〇名、3歳以下〇名
      function formatGuestCount(b) {
        const adults = (b.guestCountAdults != null && b.guestCountAdults !== '') ? b.guestCountAdults : '?';
        const infants = (b.guestCountInfants != null && b.guestCountInfants !== '') ? b.guestCountInfants : '?';
        return '大人' + adults + '名、3歳以下' + infants + '名';
      }

      function formatDateTimeDisplay(val) {
        if (val == null || val === '') return '-';
        var d;
        if (val instanceof Date) {
          d = val;
        } else {
          d = new Date(val);
          if (isNaN(d.getTime())) return escapeHtml(String(val));
        }
        var y = d.getFullYear();
        var m = d.getMonth() + 1;
        var day = d.getDate();
        var h = d.getHours();
        var min = d.getMinutes();
        return y + '年' + m + '月' + day + '日 ' + (h < 10 ? '0' : '') + h + ':' + (min < 10 ? '0' : '') + min;
      }
      function formatDateDisplay(val) {
        if (val == null || val === '') return '-';
        var d;
        if (val instanceof Date) {
          d = val;
        } else {
          d = new Date(val);
          if (isNaN(d.getTime())) return escapeHtml(String(val));
        }
        var dayNames = ['日','月','火','水','木','金','土'];
        return d.getFullYear() + '年' + (d.getMonth() + 1) + '月' + d.getDate() + '日（' + dayNames[d.getDay()] + '）';
      }

      // 宿泊イベントタイトル
      function formatBookingTitle(b) {
        const nights = b.nights || 0;
        const guests = formatGuestCount(b);
        const bbq = getBBQFlag(b.bbq);
        const parking = getParkingFlag(b.parking);
        const name = b.guestName || '(不明)';
        const site = b.bookingSite || '';
        var s = nights + '泊' + guests + 'BQ' + bbq;
        if (parking) s += parking;
        return s + ' ' + name + (site ? ' ' + site : '');
      }

      // 清掃イベントタイトル（スタッフ名は頭1文字ずつ）
      function formatCleaningTitle(b) {
        var raw = (b.cleaningStaff && String(b.cleaningStaff).trim()) ? String(b.cleaningStaff).trim() : '';
        if (!raw) return '掃/未定';
        var initials = raw.split(/[,、]/).map(function(s) { return s.trim().charAt(0); }).filter(Boolean).join(',');
        return '掃/' + initials;
      }

      // データ取得
      function fetchData() {
        document.getElementById('loadingOverlay').style.display = 'flex';
        return new Promise(function(resolve) {
          google.script.run
            .withSuccessHandler(function(jsonStr) {
              try {
                const res = JSON.parse(jsonStr);
                resolve(res);
              } catch (e) {
                resolve({ success: false, error: 'レスポンスの解析に失敗しました。' });
              }
            })
            .withFailureHandler(function(err) {
              resolve({ success: false, error: err.message || '通信エラー' });
            })
            .getData();
        }).finally(function() {
          document.getElementById('loadingOverlay').style.display = 'none';
        });
      }

      // FullCalendar用イベント生成
      function buildCalendarEvents(data, recruitMap) {
        const events = [];
        recruitMap = recruitMap || {};
        if (!data || !Array.isArray(data)) return events;

        // 同一予約の重複排除マージ（iCal行 + Googleフォーム行）
        // マッチ条件: チェックイン日が同じ、かつチェックアウト日が同じ or 片方が空
        var merged = [];
        var ciKeyMap = {}; // checkInParsed → merged配列のindex

        function mergeBookingData(existing, b) {
          var fields = ['guestName','bbq','guestCountAdults','guestCountInfants','cleaningStaff','parking','bedChoice','tel1','tel2','email','email2','passportUrls','carDisplay','nationality','purpose','memo','cleaningNotice'];
          fields.forEach(function(f) {
            if (!existing[f] && b[f]) existing[f] = b[f];
          });
          // checkOutが片方だけある場合は補完
          if (!existing.checkOutParsed && b.checkOutParsed) {
            existing.checkOut = b.checkOut;
            existing.checkOutParsed = b.checkOutParsed;
            existing.isValidDates = true;
            existing.nights = b.nights;
          }
          // guestCountDisplayをマージ（非空の値を優先）
          if (b.guestCountDisplay && (!existing.guestCountDisplay || existing.guestCountDisplay === '-')) {
            existing.guestCountDisplay = b.guestCountDisplay;
          }
          // bookingSiteをスマートマージ
          if (b.bookingSite && b.bookingSite !== existing.bookingSite) {
            var extractParts = function(bs) {
              var m = bs.match(/^(.+?)（(.+?)）$/);
              return m ? { ical: m[1].trim(), form: m[2].trim() } : { ical: bs, form: '-' };
            };
            var ex = extractParts(existing.bookingSite);
            var nw = extractParts(b.bookingSite);
            existing.bookingSite = ((ex.ical !== '-') ? ex.ical : nw.ical) + '（' + ((ex.form !== '-') ? ex.form : nw.form) + '）';
          }
          if (b.guestNames && b.guestNames.length && (!existing.guestNames || !existing.guestNames.length)) {
            existing.guestNames = b.guestNames;
          }
          if (!existing.cancelledAt && b.cancelledAt) existing.cancelledAt = b.cancelledAt;
          if (!existing.mergedRowNumbers) existing.mergedRowNumbers = [existing.rowNumber];
          existing.mergedRowNumbers.push(b.rowNumber);
        }

        data.forEach(function(b) {
          if (!b.checkInParsed) { merged.push(b); return; }
          var ci = b.checkInParsed;
          var co = b.checkOutParsed || '';
          // 同一チェックイン日の既存エントリを探す
          if (ciKeyMap[ci] !== undefined) {
            var existIdx = ciKeyMap[ci];
            var existing = merged[existIdx];
            var existCo = existing.checkOutParsed || '';
            // チェックアウト日が一致、または片方が空ならマージ
            if (!co || !existCo || co === existCo) {
              mergeBookingData(existing, b);
              return;
            }
          }
          ciKeyMap[ci] = merged.length;
          merged.push(b);
        });

        merged.forEach(function(b) {
          const checkIn = b.checkInParsed;
          const checkOut = b.checkOutParsed;
          const isValid = b.isValidDates;

          // 宿泊イベント（チェックイン日〜チェックアウト前日まで跨ぐ）
          var isCancelled = !!b.cancelledAt;
          if (checkIn) {
            var rosterAnswered = isRosterAnswered(b);
            var evtClasses = isValid ? ['fc-event-booking'] : ['fc-event-invalid'];
            if (isCancelled) evtClasses.push('fc-event-cancelled');
            if (rosterAnswered) evtClasses.push('fc-event-roster-answered');
            else evtClasses.push('fc-event-roster-unanswered');
            var bookingStatus = isCancelled ? 'cancelled' : (rosterAnswered ? 'form-answered' : 'form-unanswered');
            events.push({
              id: 'b-' + b.rowNumber,
              title: (isCancelled ? '[キャンセル] ' : '') + formatBookingTitle(b),
              start: checkIn,
              end: checkOut || undefined,
              allDay: true,
              order: 1,
              extendedProps: {
                type: 'booking',
                rowNumber: b.rowNumber,
                data: b,
                rosterAnswered: rosterAnswered,
                statusDot: bookingStatus
              },
              backgroundColor: isCancelled ? '#9e9e9e' : (isValid ? getPlatformColor(b.bookingSite) : INVALID_COLOR),
              borderColor: 'transparent',
              classNames: evtClasses
            });
          }

          // 清掃イベント（チェックアウト日）
          if (checkOut) {
            var rec = recruitMap[b.rowNumber] || {};
            var recStatus = rec.status || '';
            var recStaff = (rec.staff || '').trim();
            var bookStaff = (b.cleaningStaff || '').trim();
            var isConfirmed = (recStatus === 'スタッフ確定済み') || (recStatus === '選定済');
            var isRecruiting = recStatus && !isConfirmed;
            var isDecided = isConfirmed || (!!bookStaff && !isRecruiting);
            var cleaningClasses = ['fc-event-cleaning', isDecided ? 'fc-event-cleaning-decided' : isRecruiting ? 'fc-event-cleaning-recruiting' : 'fc-event-cleaning-undecided'];
            if (isCancelled) cleaningClasses.push('fc-event-cancelled');
            var curStaff = (window.currentUserName || '').trim().toLowerCase();
            var curEmail = (window.currentUserEmail || '').trim().toLowerCase();
            var volunteers = rec.volunteers || [];
            var selectedNames = (recStaff || bookStaff || '').split(/[,、]/).map(function(s) { return s.trim().toLowerCase(); }).filter(Boolean);
            var isVolunteeredByMe = curStaff && volunteers.some(function(v) {
              var isMe = (v.staffName || '').trim().toLowerCase() === curStaff || (v.email || '').trim().toLowerCase() === curEmail;
              return isMe && v.response && v.response !== '未回答' && v.response !== '×';
            });
            var isSelectedByMe = curStaff && selectedNames.some(function(s) { return s === curStaff; });
            if (window.staffMode && isVolunteeredByMe) {
              if (isSelectedByMe) {
                cleaningClasses.push('fc-event-cleaning-selected-by-me');
              } else if (!isDecided) {
                cleaningClasses.push('fc-event-cleaning-volunteered-by-me');
              }
            }
            var cleaningStatus = isCancelled ? 'cancelled' : (isDecided ? 'cleaning-decided' : (isRecruiting ? 'cleaning-recruiting' : 'cleaning-not-recruiting'));
            events.push({
              id: 'c-' + b.rowNumber,
              title: (isCancelled ? '[キャンセル] ' : '') + formatCleaningTitle(b),
              start: checkOut,
              allDay: true,
              order: 0,
              extendedProps: {
                type: 'cleaning',
                rowNumber: b.rowNumber,
                data: b,
                recruitStatus: recStatus,
                statusDot: cleaningStatus
              },
              backgroundColor: isCancelled ? '#9e9e9e' : '#ffc107',
              borderColor: 'transparent',
              classNames: cleaningClasses
            });
          }
        });

        return events;
      }

      // 次回予約の折りたたみトグル（windowに公開してonclickから呼べるようにする）
      window.toggleNextRes = function() {
        var wrapper = document.getElementById('eventModalStaffNextResWrapper');
        var chevron = document.querySelector('.next-res-chevron');
        if (!wrapper) return;
        var isCollapsed = wrapper.style.gridTemplateRows === '0fr' || !wrapper.style.gridTemplateRows;
        wrapper.style.gridTemplateRows = isCollapsed ? '1fr' : '0fr';
        if (chevron) chevron.style.transform = isCollapsed ? 'rotate(90deg)' : '';
      };

      window.toggleVolResponses = function() {
        var wrapper = document.getElementById('eventModalVolunteersWrapper');
        var chevron = document.querySelector('.vol-resp-chevron');
        if (!wrapper) return;
        var isCollapsed = wrapper.style.gridTemplateRows === '0fr' || !wrapper.style.gridTemplateRows;
        wrapper.style.gridTemplateRows = isCollapsed ? '1fr' : '0fr';
        if (chevron) chevron.style.transform = isCollapsed ? 'rotate(90deg)' : '';
      };

      // 清掃担当表示: 名前ごとに個別カード風の枠で表示
      window.formatStaffDisplayHtml = function(staffStr, volunteers) {
        if (!staffStr) return '<span class="staff-card-unset">(未設定)</span>';
        var names = staffStr.split(/[,、]/).map(function(n) { return n.trim(); }).filter(Boolean);
        if (!names.length) return '<span class="staff-card-unset">(未設定)</span>';
        var memoMap = {};
        if (volunteers && volunteers.length) {
          volunteers.forEach(function(v) {
            if (v.memo) memoMap[v.staffName] = v.memo;
          });
        }
        return '<div class="staff-cards-wrap">' + names.map(function(name) {
          var memo = memoMap[name] || '';
          var html = '<div class="staff-card-item"><i class="bi bi-person-fill"></i> ' + escapeHtml(name);
          if (memo) html += '<span class="staff-card-memo">(' + escapeHtml(memo) + ')</span>';
          html += '</div>';
          return html;
        }).join('') + '</div>';
      };

      // イベント詳細モーダル表示
      function showEventModal(event) {
        const props = event.extendedProps;
        const d = props.data;
        const type = props.type;
        const title = type === 'booking' ? '宿泊詳細' : '清掃詳細';
        var titleIcon = type === 'booking' ? '<i class="bi bi-house-door-fill modal-type-icon"></i>' : '<i class="bi bi-brush-fill modal-type-icon"></i>';
        // ステータスドット（カレンダー凡例と同じ色）
        var sd = props.statusDot || '';
        var dotColor = '';
        if (sd === 'form-answered') dotColor = '#28a745';
        else if (sd === 'form-unanswered') dotColor = '#dc3545';
        else if (sd === 'cleaning-decided') dotColor = '#198754';
        else if (sd === 'cleaning-recruiting') dotColor = '#dc3545';
        else if (sd === 'cleaning-not-recruiting') dotColor = '';
        var dotHtml = dotColor ? '<span class="d-inline-block rounded-circle me-1" style="width:8px;height:8px;background:' + dotColor + ';vertical-align:middle;"></span>' : '';
        var headerEl = document.getElementById('eventModalHeader');
        document.getElementById('eventModalTitle').innerHTML = titleIcon + dotHtml + escapeHtml(title);
        headerEl.className = 'modal-header ' + (type === 'cleaning' ? 'modal-header-cleaning' : 'modal-header-booking');
        var clHeaderArea = document.getElementById('checklistBtnHeaderArea');
        if (clHeaderArea) { clHeaderArea.innerHTML = ''; clHeaderArea.style.display = 'none'; }

        // 非同期コールバックの競合防止用世代ID
        var modalGen = (window._eventModalGen = (window._eventModalGen || 0) + 1);

        function fmt(val) { var s = (val != null && val !== '') ? String(val) : '-'; return escapeHtml(s); }
        // 日付表示ヘルパー: "2026-02-13 ～ 2026-02-15" → "2026/2/13 ～ 2026/2/15"
        // メモ保存（宿泊詳細）
        window.saveBookingMemoUI = function() {
          var ta = document.getElementById('bookingMemoTextarea');
          if (!ta) return;
          var btn = document.getElementById('btnSaveMemo');
          if (btn) { btn.disabled = true; btn.textContent = '保存中...'; }
          google.script.run.withSuccessHandler(function(res) {
            var r = JSON.parse(res);
            if (r.success) {
              if (btn) { btn.textContent = '保存しました'; btn.classList.replace('btn-primary', 'btn-success'); }
              setTimeout(function() { if (btn) { btn.disabled = false; btn.textContent = 'メモを保存'; btn.classList.replace('btn-success', 'btn-primary'); } }, 2000);
            } else {
              alert(r.error || '保存に失敗しました。');
              if (btn) { btn.disabled = false; btn.textContent = 'メモを保存'; }
            }
          }).withFailureHandler(function(e) {
            alert('保存に失敗しました: ' + e.message);
            if (btn) { btn.disabled = false; btn.textContent = 'メモを保存'; }
          }).saveBookingMemo(parseInt(ta.dataset.row), ta.value);
        };

        // 連絡事項保存（清掃詳細）
        window.saveCleaningNoticeUI = function() {
          var ta = document.getElementById('cleaningNoticeTextarea');
          if (!ta) return;
          var btn = document.getElementById('btnSaveNotice');
          if (btn) { btn.disabled = true; btn.textContent = '保存中...'; }
          google.script.run.withSuccessHandler(function(res) {
            var r = JSON.parse(res);
            if (r.success) {
              if (btn) { btn.textContent = '保存しました'; btn.classList.replace('btn-primary', 'btn-success'); }
              setTimeout(function() { if (btn) { btn.disabled = false; btn.textContent = '連絡事項を保存'; btn.classList.replace('btn-success', 'btn-primary'); } }, 2000);
            } else {
              alert(r.error || '保存に失敗しました。');
              if (btn) { btn.disabled = false; btn.textContent = '連絡事項を保存'; }
            }
          }).withFailureHandler(function(e) {
            alert('保存に失敗しました: ' + e.message);
            if (btn) { btn.disabled = false; btn.textContent = '連絡事項を保存'; }
          }).saveCleaningNotice(parseInt(ta.dataset.row), ta.value);
        };

        // 宿泊人数編集トグル
        window.toggleGuestCountEdit = function() {
          var area = document.getElementById('guestCountEditArea');
          if (!area) return;
          area.style.display = area.style.display === 'none' ? 'block' : 'none';
        };

        // 宿泊人数保存
        window.saveGuestCountUI = function() {
          var btn = document.getElementById('btnSaveGuestCount');
          if (!btn) return;
          var rowNumber = parseInt(btn.dataset.row);
          var adults = document.getElementById('guestCountAdultsInput').value;
          var infants = document.getElementById('guestCountInfantsInput').value;
          btn.disabled = true; btn.textContent = '保存中...';
          google.script.run.withSuccessHandler(function(res) {
            var r = JSON.parse(res);
            if (r.success) {
              btn.textContent = '保存しました'; btn.classList.replace('btn-primary', 'btn-success');
              // 表示を即時更新
              var disp = document.getElementById('guestCountDisplay');
              if (disp) {
                var parts = [];
                if (adults) parts.push('大人' + adults + '名');
                if (infants) parts.push('3歳以下' + infants + '名');
                disp.textContent = parts.length ? parts.join('、') : '-';
              }
              setTimeout(function() {
                btn.disabled = false; btn.textContent = '保存'; btn.classList.replace('btn-success', 'btn-primary');
                var area = document.getElementById('guestCountEditArea');
                if (area) area.style.display = 'none';
              }, 1500);
            } else {
              alert(r.error || '保存に失敗しました。');
              btn.disabled = false; btn.textContent = '保存';
            }
          }).withFailureHandler(function(e) {
            alert('保存に失敗しました: ' + e.message);
            btn.disabled = false; btn.textContent = '保存';
          }).saveGuestCount(rowNumber, adults, infants);
        };

        function fmtDateRange(raw) {
          if (!raw) return '-';
          var s = String(raw);
          return s.replace(/(\d{4})-(\d{1,2})-(\d{1,2})/g, function(_, y, m, d) {
            return y + '/' + parseInt(m, 10) + '/' + parseInt(d, 10);
          }) || s;
        }
        var staffBarEl = document.getElementById('staffSelectorBar');
        var staffBarVisible = staffBarEl && staffBarEl.style.display !== 'none';
        var isStaffView = window.staffMode || !window.isOwnerUser || staffBarVisible;
        var hideForStaff = (type === 'cleaning' && isStaffView);
        var hideGuestInfoForStaff = isStaffView;
        var hideForOwnerCleaning = (type === 'cleaning' && !isStaffView);

        // BBQバッジ判定（炎マーク＋あり/なし）
        function bbqBadge(val) {
          var disp = bbqAriNashi(val);
          if (disp === 'あり') return '<span class="modal-badge modal-badge-yes"><i class="bi bi-fire"></i>BBQ あり</span>';
          if (disp === 'なし') return '<span class="modal-badge modal-badge-no"><i class="bi bi-fire"></i>BBQ なし</span>';
          return '<span class="modal-badge modal-badge-no"><i class="bi bi-fire"></i>BBQ ' + fmt(val) + '</span>';
        }
        // 駐車場バッジ判定（丸P＋あり/なし）
        function parkingBadge(val) {
          var disp = parkingAriNashi(val);
          if (disp === 'あり') return '<span class="modal-badge modal-badge-yes"><i class="bi bi-p-circle"></i>有料駐車場 あり</span>';
          if (disp === 'なし') return '<span class="modal-badge modal-badge-no"><i class="bi bi-p-circle"></i>有料駐車場 なし</span>';
          if (val) return '<span class="modal-badge modal-badge-no"><i class="bi bi-p-circle"></i>有料駐車場 ' + fmt(val) + '</span>';
          return '';
        }

        let html = '';
        if (d) {
          // === 清掃詳細 ===
          if (type === 'cleaning') {
            // チェックアウト日（目立つ表示）
            html += '<div class="modal-prominent-date"><i class="bi bi-calendar-event"></i>' + formatDateDisplay(d.checkOut) + '</div>';

            // 人数
            var guestDisp = d.guestCountDisplay != null ? d.guestCountDisplay : formatGuestCount(d);
            html += '<div class="detail-row"><span class="detail-label"><strong><i class="bi bi-people-fill"></i> 宿泊人数:</strong></span><span class="detail-value">' + fmt(guestDisp) + '</span></div>';

            // BBQ・駐車場（宿泊詳細と同じ縦並びレイアウト）
            html += '<div class="detail-row"><span class="detail-label"><strong><i class="bi bi-fire"></i> BBQ:</strong></span><span class="detail-value">' + fmt(bbqAriNashi(d.bbq) || '-') + '</span></div>';
            var parkDisp = parkingAriNashi(d.parking);
            if (d.parking || parkDisp) {
              html += '<div class="detail-row"><span class="detail-label"><strong><i class="bi bi-p-circle"></i> 有料駐車場:</strong></span><span class="detail-value">' + fmt(parkDisp || '-') + '</span></div>';
            }

            // 連絡事項（次回予約の上）- ラベルは枠内placeholder表示
            var staffVal = (d.cleaningStaff || '').trim();
            var staffUndecided = !staffVal;
            html += '<div class="modal-memo-area mt-2 mb-2">';
            if (!isStaffView) {
              var noticeVal = (d.cleaningNotice || '').trim();
              html += '<textarea id="cleaningNoticeTextarea" class="form-control form-control-sm" rows="3" placeholder="連絡事項を入力…" data-row="' + props.rowNumber + '">' + (noticeVal ? escapeHtml(noticeVal) : '') + '</textarea>';
              html += '<div class="text-end mt-1"><button id="btnSaveNotice" class="btn btn-sm btn-primary" onclick="saveCleaningNoticeUI()">連絡事項を保存</button></div>';
            } else {
              var noticeText = (d.cleaningNotice || '').trim();
              if (noticeText) {
                html += '<div class="form-control form-control-sm" style="min-height:2.5rem;background:#f8f9fa;white-space:pre-wrap;">' + escapeHtml(noticeText) + '</div>';
              } else {
                html += '<div class="form-control form-control-sm" style="min-height:2.5rem;background:#f8f9fa;white-space:pre-wrap;color:#adb5bd;">連絡事項なし</div>';
              }
            }
            html += '</div>';

            // 次回予約の情報カード（折りたたみ式、デフォルト閉じ）
            html += '<div id="eventModalStaffNextResArea" class="modal-next-res-card">';
            html += '<div class="card-title-sm next-res-toggle" onclick="toggleNextRes()" style="cursor:pointer;user-select:none;"><i class="bi bi-info-circle"></i>次回予約<span id="nextResHeaderStatus" class="ms-2" style="font-weight:normal;font-size:0.75rem;color:#6c757d;"><span class="spinner-border spinner-border-sm me-1" style="width:0.75rem;height:0.75rem;border-width:0.13em;vertical-align:middle;" role="status"></span>読み込み中…</span><i class="bi bi-chevron-right ms-auto next-res-chevron" style="transition:transform 0.2s;font-size:0.7rem;"></i></div>';
            html += '<div id="eventModalStaffNextResWrapper" style="display:grid; grid-template-rows:0fr; transition:grid-template-rows 0.3s ease-out;"><div class="modal-next-res-grid" id="eventModalStaffNextResContent" style="overflow:hidden;"><div class="nres-item" style="grid-column:1/-1; text-align:center; padding:0.5rem 0;"><span class="spinner-border spinner-border-sm text-secondary me-2" role="status"></span><span class="text-muted">読み込み中…</span></div></div></div>';
            html += '</div>';

            // 清掃募集状況カード: 募集状況→清掃担当→ボタン/アクション→回答状況
            html += '<div class="modal-next-res-card" style="margin-top:0.5rem;">';
            // 1. 募集状況（バッジ内に編集ボタンエリアを含む）
            html += '<span id="eventModalStaffRecruitStatus" class="recruit-status-badge text-muted" style="background:#e9ecef;position:relative;">読み込み中…<span id="eventModalEditStaffBtnArea" style="position:absolute;right:0.5rem;top:50%;transform:translateY(-50%);"></span></span>';
            // 1b. ステータス見出し直下のボタンエリア
            html += '<div id="eventModalStatusBtnArea" class="mt-1"></div>';
            // 2. 清掃担当
            html += '<div class="modal-staff-label mt-1 ' + (staffUndecided ? 'staff-unset' : 'staff-set') + '" style="display:flex; align-items:flex-start;">';
            html += '<div style="flex-shrink:0;"><span style="white-space:nowrap;"><i class="bi bi-person-badge"></i> 清掃担当:&nbsp;</span><div id="eventModalEditStaffArea"></div></div>';
            html += '<span id="eventModalStaffDisplay">' + formatStaffDisplayHtml(staffVal, null) + '</span><span id="eventModalCancelBtnArea" style="flex-shrink:0;display:flex;align-items:center;margin-left:0.5rem;"></span></div>';
            // 3. ボタン/アクションエリア（メール送信・対応可ボタンなど、JSで動的に追加）
            html += '<div id="eventModalVolunteerBodyArea" class="mt-2"><div class="text-muted small" id="volBodyLoading"><span class="spinner-border spinner-border-sm text-secondary me-1" style="width:0.7rem;height:0.7rem;border-width:0.12em;" role="status"></span>読み込み中…</div></div>';
            // 4. 回答状況（折りたたみ式、デフォルト閉じ）
            html += '<div id="eventModalVolunteersArea" class="cleaning-section-volunteers mt-2">';
            html += '<div class="card-title-sm vol-resp-toggle" onclick="toggleVolResponses()" style="cursor:pointer;user-select:none;font-size:0.8rem;font-weight:700;display:flex;align-items:center;margin-bottom:0;"><i class="bi bi-people"></i>&nbsp;スタッフ回答状況<i class="bi bi-chevron-right ms-auto vol-resp-chevron" style="transition:transform 0.2s;font-size:0.7rem;"></i></div>';
            html += '<div id="eventModalVolunteersWrapper" style="display:grid; grid-template-rows:0fr; transition:grid-template-rows 0.3s ease-out;"><div id="eventModalVolunteersList" style="overflow:hidden;"><div class="text-muted small" style="padding:0.3rem 0;"><span class="spinner-border spinner-border-sm text-secondary me-1" style="width:0.7rem;height:0.7rem;border-width:0.12em;" role="status"></span>読み込み中…</div></div></div>';
            html += '</div>';
            html += '</div>';

            // チェックリストボタンはヘッダーに表示（checklistBtnHeaderArea）

            // クリーニング連絡カード
            html += '<div class="mt-2 mb-2" id="laundryCardArea"></div>';

            // LINE用テキスト（オーナーのみ）
            if (!isStaffView) {
              html += '<div id="eventModalLineCopyArea" class="mb-2 mt-2 p-2 border rounded bg-light" style="display:none;"><p class="small fw-bold mb-1">LINE用テキスト（コピーしてLINEグループに投稿）</p><textarea id="eventModalLineCopyText" class="form-control font-monospace small mb-2" rows="6"></textarea><button type="button" class="btn btn-sm btn-primary" id="eventModalCopyToClipboard">コピー</button></div>';
            }
          }

          // === キャンセルバナー ===
          if (d.cancelledAt) {
            html += '<div class="alert alert-secondary py-2 mb-2"><i class="bi bi-x-circle-fill me-1"></i><strong>この予約はキャンセルされました</strong><br><small>キャンセル日時: ' + escapeHtml(d.cancelledAt) + '</small></div>';
          }

          // === 宿泊詳細 ===
          if (type === 'booking') {
            // チェックイン・チェックアウト 横並び
            html += '<div class="modal-date-pair">';
            html += '<div class="date-item"><div class="date-label"><i class="bi bi-box-arrow-in-right"></i> チェックイン</div><div class="date-val">' + formatDateTimeDisplay(d.checkIn) + '</div></div>';
            html += '<div class="date-item"><div class="date-label"><i class="bi bi-box-arrow-right"></i> チェックアウト</div><div class="date-val">' + formatDateTimeDisplay(d.checkOut) + '</div></div>';
            html += '</div>';

            // 宿泊者名（折りたたみ表示、代表者は常時表示）
            if (!hideGuestInfoForStaff) {
              var gnList = d.guestNames && d.guestNames.length ? d.guestNames : (d.guestName ? [{ name: d.guestName, age: '' }] : []);
              if (gnList.length > 0) {
                var rep = gnList[0];
                var repDisp = fmt(rep.name) + (rep.age ? ' <span class="text-muted small">(' + fmt(rep.age) + ')</span>' : '');
                html += '<div class="detail-row"><span class="detail-label"><strong><i class="bi bi-person"></i> 宿泊者名:</strong></span><span class="detail-value">' + repDisp;
                if (gnList.length > 1) {
                  html += ' <a href="#" class="small text-decoration-none" data-bs-toggle="collapse" data-bs-target="#guestListCollapse" role="button">...他' + (gnList.length - 1) + '名 <i class="bi bi-chevron-down"></i></a>';
                  html += '<div class="collapse mt-1" id="guestListCollapse">';
                  for (var gni = 1; gni < gnList.length; gni++) {
                    html += '<div>' + fmt(gnList[gni].name) + (gnList[gni].age ? ' <span class="text-muted small">(' + fmt(gnList[gni].age) + ')</span>' : '') + '</div>';
                  }
                  html += '</div>';
                }
                html += '</span></div>';
              }
            }

            // 人数（オーナーのみ編集ボタン付き）
            var guestDisp = d.guestCountDisplay != null ? d.guestCountDisplay : formatGuestCount(d);
            html += '<div class="detail-row"><span class="detail-label"><strong><i class="bi bi-people-fill"></i> 宿泊人数:</strong></span><span class="detail-value">';
            html += '<span id="guestCountDisplay">' + fmt(guestDisp) + '</span>';
            if (!isStaffView) {
              html += ' <button class="btn btn-sm btn-outline-secondary py-0 px-1 ms-1" style="font-size:0.75rem;" onclick="toggleGuestCountEdit()" id="btnEditGuestCount"><i class="bi bi-pencil-fill"></i></button>';
            }
            html += '</span></div>';
            // 人数編集フォーム（オーナーのみ、非表示で配置）
            if (!isStaffView) {
              var curAdults = d.guestCountAdults || '';
              var curInfants = d.guestCountInfants || '';
              html += '<div id="guestCountEditArea" style="display:none; margin: 4px 0 8px 0; padding: 8px; background: #f8f9fa; border-radius: 6px; border: 1px solid #dee2e6;">';
              html += '<div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">';
              html += '<label style="font-size:0.85rem; white-space:nowrap;">大人</label>';
              html += '<input type="number" id="guestCountAdultsInput" class="form-control form-control-sm" style="width:70px;" min="0" value="' + escapeHtml(curAdults) + '" placeholder="0">';
              html += '<label style="font-size:0.85rem; white-space:nowrap;">3歳以下</label>';
              html += '<input type="number" id="guestCountInfantsInput" class="form-control form-control-sm" style="width:70px;" min="0" value="' + escapeHtml(curInfants) + '" placeholder="0">';
              html += '<button class="btn btn-sm btn-primary py-0 px-2" onclick="saveGuestCountUI()" id="btnSaveGuestCount" data-row="' + props.rowNumber + '">保存</button>';
              html += '<button class="btn btn-sm btn-outline-secondary py-0 px-2" onclick="toggleGuestCountEdit()">取消</button>';
              html += '</div>';
              html += '<div class="text-muted mt-1" style="font-size:0.7rem;">※ 宿泊者がGoogleフォームに入力すると、フォームの内容で上書きされます</div>';
              html += '</div>';
            }
            // ベッド（2名の場合のみ）
            var totalGuests = (parseInt(d.guestCountAdults, 10) || 0) + (parseInt(d.guestCountInfants, 10) || 0);
            if (totalGuests === 2 && d.bedChoice && !hideForStaff && !hideForOwnerCleaning) {
              html += '<div class="detail-row"><span class="detail-label"><strong><i class="bi bi-lamp"></i> ベッド:</strong></span><span class="detail-value">' + fmt(d.bedChoice) + '</span></div>';
            }

            // 予約サイト（オーナーのみ）
            if (!isStaffView) {
              html += '<div class="detail-row"><span class="detail-label"><strong><i class="bi bi-globe2"></i> 予約サイト:</strong></span><span class="detail-value">' + fmt(d.bookingSite) + '</span></div>';
            }

            // 交通手段
            var carValAll = (d.carDisplay || '-').toString().split('\n').map(function(p){ return escapeHtml(p); }).join('<br>');
            html += '<div class="detail-row"><span class="detail-label"><strong><i class="bi bi-car-front"></i> 交通手段:</strong></span><span class="detail-value">' + (carValAll || '-') + '</span></div>';

            // 国籍
            html += '<div class="detail-row"><span class="detail-label"><strong><i class="bi bi-globe"></i> 国籍:</strong></span><span class="detail-value">' + fmt(d.nationality || '日本') + '</span></div>';

            // BBQ・有料駐車場（国籍の下・あり/なし表記）
            html += '<div class="detail-row"><span class="detail-label"><strong><i class="bi bi-fire"></i> BBQ:</strong></span><span class="detail-value">' + fmt(bbqAriNashi(d.bbq) || '-') + '</span></div>';
            var parkDisp = parkingAriNashi(d.parking);
            if (d.parking || parkDisp) {
              html += '<div class="detail-row"><span class="detail-label"><strong><i class="bi bi-p-circle"></i> 有料駐車場:</strong></span><span class="detail-value">' + fmt(parkDisp || '-') + '</span></div>';
            }

            // 連絡先情報（オーナーのみ）
            if (!isStaffView) {
              if (d.tel1 || d.tel2) {
                html += '<div class="modal-section-divider"></div>';
                if (d.tel1) html += '<div class="detail-row"><span class="detail-label"><strong><i class="bi bi-telephone"></i> TEL1:</strong></span><span class="detail-value" style="padding-left:0.5rem;">' + fmt(d.tel1) + '</span></div>';
                if (d.tel2) html += '<div class="detail-row"><span class="detail-label"><strong><i class="bi bi-telephone"></i> TEL2:</strong></span><span class="detail-value" style="padding-left:0.5rem;">' + fmt(d.tel2) + '</span></div>';
              }
              var emailVal = (d.email || d.email2 || '').trim();
              html += '<div class="detail-row"><span class="detail-label"><strong><i class="bi bi-envelope"></i> メール:</strong></span><span class="detail-value">' + fmt(emailVal || '-') + '</span></div>';
            }

            // 目的（オーナーのみ）
            if (!isStaffView && d.purpose) {
              html += '<div class="detail-row"><span class="detail-label"><strong><i class="bi bi-signpost-2"></i> 目的:</strong></span><span class="detail-value">' + fmt(d.purpose) + '</span></div>';
            }

            // パスポート（オーナーのみ）
            if (!isStaffView && d.passportUrls && d.passportUrls.length) {
              html += '<div class="detail-row"><span class="detail-label"><strong><i class="bi bi-card-image"></i> パスポート:</strong></span><span class="detail-value">';
              d.passportUrls.forEach(function(url, idx) {
                if (url) html += '<a href="' + escapeHtml(url) + '" target="_blank" rel="noopener">写真' + (idx + 1) + '</a> ';
              });
              html += '</span></div>';
            }

            // メモ（オーナー: 編集可, スタッフ: 閲覧のみ）
            if (d.memo || !isStaffView) {
              html += '<div class="modal-memo-area"><label><i class="bi bi-journal-text"></i> メモ</label>';
              if (!isStaffView) {
                html += '<textarea id="bookingMemoTextarea" class="form-control form-control-sm" rows="3" data-row="' + props.rowNumber + '">' + fmt(d.memo || '') + '</textarea>';
                html += '<div class="text-end mt-1"><button id="btnSaveMemo" class="btn btn-sm btn-primary" onclick="saveBookingMemoUI()">メモを保存</button></div>';
              } else {
                html += '<div class="form-control form-control-sm" style="min-height:2.5rem;background:#f8f9fa;white-space:pre-wrap;">' + fmt(d.memo || '') + '</div>';
              }
              html += '</div>';
            }

            // 予約削除ボタン（オーナーのみ、body内に配置）
            if (!isStaffView) {
              html += '<div id="eventModalBookingActions" class="mt-3"></div>';
            }
          }
        }
        document.getElementById('eventModalBody').innerHTML = html || '<p>データがありません。</p>';

        var isStaff = isStaffView;
        // フッターボタン設定
        var actionBtns = document.getElementById('eventModalActionBtns');
        if (actionBtns) { actionBtns.innerHTML = ''; actionBtns.style.display = 'none'; }
        // フッターの削除ボタン・アクションボタンは常に非表示（body内に移動済み）
        var deleteArea = document.getElementById('eventModalDeleteArea');
        if (deleteArea) deleteArea.style.display = 'none';
        var centerArea = document.getElementById('eventModalVolunteerCenter');
        if (centerArea) { centerArea.innerHTML = ''; centerArea.style.display = 'none'; }

        // 宿泊詳細: 予約削除ボタンをbody内に配置（既存の確認モーダルを使用）
        if (type === 'booking' && !isStaffView) {
          var bookingActionsArea = document.getElementById('eventModalBookingActions');
          if (bookingActionsArea) {
            var btnDel = document.createElement('button');
            btnDel.type = 'button';
            btnDel.className = 'btn btn-sm btn-danger w-100';
            btnDel.textContent = '予約を削除';
            btnDel.onclick = function() {
              document.getElementById('deleteBookingConfirmInfo').innerHTML = 'チェックイン: ' + escapeHtml((d.checkIn || '').toString()) + '<br>チェックアウト: ' + escapeHtml((d.checkOut || '').toString()) + (d.guestName ? '<br>宿泊者: ' + escapeHtml(d.guestName) : '');
              document.getElementById('btnConfirmDeleteBooking').dataset.rowNumber = props.rowNumber;
              bootstrap.Modal.getInstance(document.getElementById('eventModal')).hide();
              new bootstrap.Modal(document.getElementById('deleteBookingConfirmModal')).show();
            };
            bookingActionsArea.appendChild(btnDel);
          }
        }

        // チェックリストボタンをヘッダーに追加（キャッシュ利用で2回目以降はAPI不要）
        if (type === 'cleaning') {
          var clBtnArea = document.getElementById('checklistBtnHeaderArea');
          if (clBtnArea) {
            var _createChecklistBtn = function(area, url) {
              var btnCl = document.createElement('button');
              btnCl.type = 'button';
              btnCl.className = 'btn btn-warning';
              btnCl.style.cssText = 'font-size:0.85rem;white-space:nowrap;padding:0.3rem 0.75rem;color:#000;font-weight:600;';
              btnCl.innerHTML = '<i class="bi bi-check2-square"></i> 清掃チェックリスト';
              btnCl.onclick = function() {
                var checkoutDate = (d && d.checkOut) ? (d.checkOutParsed || String(d.checkOut).slice(0,10)) : '';
                var staffName = (d && d.cleaningStaff) ? String(d.cleaningStaff).split(/[,、]/)[0].trim() : '';
                if (checkoutDate) {
                  window.open(url + '?date=' + encodeURIComponent(checkoutDate) + '&staff=' + encodeURIComponent(staffName || 'スタッフ'), '_blank');
                } else {
                  alert('チェックアウト日が取得できません');
                }
              };
              area.appendChild(btnCl);
              area.style.display = '';
            };
            if (window._checklistAppUrl) {
              _createChecklistBtn(clBtnArea, window._checklistAppUrl);
            } else {
              google.script.run
                .withSuccessHandler(function(resStr) {
                  try {
                    var res = JSON.parse(resStr);
                    if (res.success && res.url) {
                      window._checklistAppUrl = res.url;
                      _createChecklistBtn(clBtnArea, res.url);
                    }
                  } catch (e) { console.error('checklist button error:', e); }
                })
                .withFailureHandler(function(e) { console.error('getChecklistAppUrl failed:', e); })
                .getChecklistAppUrl();
            }
          }
        }

        // クリーニング状況 + 募集データをバッチ読み込み（2 API → 1 API）
        if (type === 'cleaning') {
          var _batchCheckoutDate = (d && d.checkOut) ? (d.checkOutParsed || String(d.checkOut).slice(0,10)) : '';
          var _batchLaundryArea = document.getElementById('laundryCardArea');
          if (_batchLaundryArea) {
            _batchLaundryArea.innerHTML = '<div class="modal-next-res-card" style="margin-top:0.5rem;"><div class="text-muted small text-center"><span class="spinner-border spinner-border-sm me-1" style="width:0.7rem;height:0.7rem;border-width:0.12em;" role="status"></span>読み込み中…</div></div>';
          }
          google.script.run
            .withSuccessHandler(function(batchStr) {
              if (modalGen !== window._eventModalGen) return;
              try {
                var batch = JSON.parse(batchStr);
                if (!batch.success) return;
                var bData = batch.data;
                // クリーニング状況カード
                if (_batchLaundryArea) {
                  if (bData.laundry && bData.laundry.success) {
                    buildLaundryCardHtml(_batchLaundryArea, _batchCheckoutDate, bData.laundry.data, isStaffView);
                  } else {
                    _batchLaundryArea.innerHTML = '';
                  }
                }
                // 募集データをハンドラに渡す
                if (window._batchRecruitHandler) {
                  window._batchRecruitHandler(JSON.stringify(bData.recruitment || {}));
                }
              } catch (e) { console.error('batch modal error:', e); }
            })
            .withFailureHandler(function(e) {
              if (modalGen !== window._eventModalGen) return;
              if (_batchLaundryArea) _batchLaundryArea.innerHTML = '';
              if (window._batchRecruitFailHandler) window._batchRecruitFailHandler();
            })
            .getCleaningModalData(_batchCheckoutDate, props.rowNumber);
        }

        const modal = new bootstrap.Modal(document.getElementById('eventModal'));
        modal.show();

        // ヘッダーの「読み込み中…」を更新するヘルパー
        function updateNextResHeader(text, loading) {
          var hdr = document.getElementById('nextResHeaderStatus');
          if (!hdr) return;
          if (loading) {
            hdr.innerHTML = '<span class="spinner-border spinner-border-sm me-1" style="width:0.75rem;height:0.75rem;border-width:0.13em;vertical-align:middle;" role="status"></span>読み込み中…';
          } else {
            hdr.innerHTML = '';
          }
        }

        // キャッシュから次回予約情報を即時表示（サーバー応答を待たずに表示）
        if (type === 'cleaning') {
          var cachedRec = (window._recruitFullMap || {})[props.rowNumber];
          var cachedNextRes = cachedRec ? cachedRec.nextReservation : ((window._nextResCache || {})[props.rowNumber] || null);
          if (cachedNextRes || cachedRec) {
            var nextEl = document.getElementById('eventModalStaffNextResContent');
            var statusEl = document.getElementById('eventModalStaffRecruitStatus');
            var volArea = document.getElementById('eventModalVolunteersArea');
            var volList = document.getElementById('eventModalVolunteersList');
            if (nextEl && cachedNextRes) {
              var nr = cachedNextRes;
              var dateDisp = fmtDateRange(nr.date);
              nextEl.innerHTML = '<div class="nres-item"><span class="nres-label">日付:</span><span class="nres-value">' + escapeHtml(dateDisp) + '</span></div><div class="nres-item"><span class="nres-label">人数:</span><span class="nres-value">' + fmt(nr.guestCount) + '</span></div><div class="nres-item"><span class="nres-label">ベッド:</span><span class="nres-value">' + fmt(nr.bedCount) + '</span></div><div class="nres-item"><span class="nres-label">BBQ:</span><span class="nres-value">' + fmt(bbqAriNashi(nr.bbq)) + '</span></div><div class="nres-item"><span class="nres-label">国籍:</span><span class="nres-value">' + fmt(nr.nationality || '日本') + '</span></div>';
              updateNextResHeader(dateDisp);
            }
            if (statusEl && cachedRec) {
              var cStatus = cachedRec.status || '';
              var cIsConfirmed = (cStatus === 'スタッフ確定済み' || cStatus === '選定済');
              statusEl.textContent = cIsConfirmed ? 'スタッフ確定済み' : 'スタッフ募集中';
              statusEl.className = 'recruit-status-badge ' + (cIsConfirmed ? 'status-decided' : 'status-recruiting');
              statusEl.removeAttribute('style');
            }
            if (volArea && volList && cachedRec && cachedRec.volunteers) {
              volArea.style.display = 'block';
              volList.innerHTML = renderStaffResponses(cachedRec.volunteers);
            }
          }
          // キャッシュに次回予約データがない場合、セクションを展開して読み込み中を見せる
          if (!cachedNextRes) {
            var wrapper = document.getElementById('eventModalStaffNextResWrapper');
            var chevron = document.querySelector('.next-res-chevron');
            if (wrapper) wrapper.style.gridTemplateRows = '1fr';
            if (chevron) chevron.style.transform = 'rotate(90deg)';
          }
        }

        if (isStaff && type === 'cleaning') {
          window._batchRecruitHandler = function(rStr) {
            if (modalGen !== window._eventModalGen) return; // 古いコールバックを無視
            try {
              var r = JSON.parse(rStr);
              var nextEl = document.getElementById('eventModalStaffNextResContent');
              var statusEl = document.getElementById('eventModalStaffRecruitStatus');
              var volArea = document.getElementById('eventModalVolunteersArea');
              var volList = document.getElementById('eventModalVolunteersList');
              if (nextEl && r.success) {
                var nr = r.nextReservation || {};
                if (nr.date) {
                  var dateDisp = fmtDateRange(nr.date);
                  nextEl.innerHTML = '<div class="nres-item"><span class="nres-label">日付:</span><span class="nres-value">' + escapeHtml(dateDisp) + '</span></div><div class="nres-item"><span class="nres-label">人数:</span><span class="nres-value">' + fmt(nr.guestCount) + '</span></div><div class="nres-item"><span class="nres-label">ベッド:</span><span class="nres-value">' + fmt(nr.bedCount) + '</span></div><div class="nres-item"><span class="nres-label">BBQ:</span><span class="nres-value">' + fmt(bbqAriNashi(nr.bbq)) + '</span></div><div class="nres-item"><span class="nres-label">国籍:</span><span class="nres-value">' + fmt(nr.nationality || '日本') + '</span></div>';
                  updateNextResHeader(dateDisp);
                } else {
                  nextEl.innerHTML = '<div class="nres-item" style="grid-column:1/-1;"><span class="text-muted">次回予約なし</span></div>';
                  updateNextResHeader('なし');
                }
              } else if (nextEl) {
                nextEl.innerHTML = '<div class="nres-item" style="grid-column:1/-1;"><span class="text-muted">取得できませんでした</span></div>';
                updateNextResHeader(null);
              }
              var volBodyArea = document.getElementById('eventModalVolunteerBodyArea');
              if (volBodyArea) { var _bl = document.getElementById('volBodyLoading'); if (_bl) _bl.remove(); }
              var staffDisplayEl = document.getElementById('eventModalStaffDisplay');
              var staffAssigned = (d.cleaningStaff || '').trim();
              // 募集データの選定スタッフ or カレンダーデータの清掃担当を使用
              var resolvedStaff = staffAssigned || (r.selectedStaff || '').trim();
              if (staffDisplayEl && r.success) {
                staffDisplayEl.innerHTML = formatStaffDisplayHtml(resolvedStaff, r.volunteers);
                var staffLabel = staffDisplayEl.closest('.modal-staff-label');
                if (staffLabel) {
                  staffLabel.classList.remove('staff-set', 'staff-unset');
                  staffLabel.classList.add(resolvedStaff ? 'staff-set' : 'staff-unset');
                }
              }
              // 募集レコードの実際のステータスを使用（募集フロー経由の確定のみ反映）
              var effectiveStatus = r.status;
              var isEffConfirmed = (effectiveStatus === 'スタッフ確定済み' || effectiveStatus === '選定済');
              if (statusEl && r.success) {
                statusEl.textContent = isEffConfirmed ? 'スタッフ確定済み' : 'スタッフ募集中';
                statusEl.className = 'recruit-status-badge ' + (isEffConfirmed ? 'status-decided' : 'status-recruiting');
                statusEl.removeAttribute('style');
              }
              if (volArea && volList) {
                if (r.success) {
                  volArea.style.display = 'block';
                  volList.innerHTML = renderStaffResponses(r.volunteers);
                } else {
                  volArea.style.display = 'none';
                  volList.innerHTML = '';
                }
              }
              // 取り消し申請: cleaningStaffが設定済みかつ自分が担当の場合に清掃担当者名の右側に表示
              var cancelBtnArea = document.getElementById('eventModalCancelBtnArea');
              if (r.success && r.recruitRowIndex && resolvedStaff && cancelBtnArea) {
                var assignedStaff = resolvedStaff;
                var curName2 = (window.currentUserName || '').trim();
                var curEmail2 = (window.currentUserEmail || '').trim().toLowerCase();
                var selectedParts = (assignedStaff || '').split(/[,、]/).map(function(s) { return s.trim(); }).filter(Boolean);
                var isSelected = selectedParts.some(function(part) {
                  var p = part.toLowerCase();
                  return (curName2 && curName2.toLowerCase() === p) || (curEmail2 && p.indexOf('@') >= 0 && p === curEmail2);
                });
                if (isSelected) {
                  // キャンセル否認チェック
                  var wasRejected = r.cancelRejected && r.cancelRejected.some(function(cr) {
                    return (curName2 && cr.staffName === curName2) || (curEmail2 && cr.email === curEmail2);
                  });
                  // 既にキャンセル申請済みかチェック
                  var alreadyRequested = r.cancelRequested && r.cancelRequested.some(function(cr) {
                    return (curName2 && cr.staffName === curName2) || (curEmail2 && cr.email === curEmail2);
                  });
                  if (wasRejected) {
                    // 否認通知 + 確認ボタン → 確認後にキャンセル申請ボタン復活
                    var rejWrap = document.createElement('div');
                    rejWrap.className = 'mb-0';
                    var rejBadge = document.createElement('div');
                    rejBadge.className = 'alert alert-danger py-0 px-2 small mb-0';
                    rejBadge.style.fontSize = '0.7rem';
                    rejBadge.style.lineHeight = '1.5';
                    rejBadge.innerHTML = '<i class="bi bi-x-circle"></i> 否認';
                    rejWrap.appendChild(rejBadge);
                    var rejConfirmBtn = document.createElement('button');
                    rejConfirmBtn.type = 'button';
                    rejConfirmBtn.className = 'btn btn-sm btn-outline-secondary ms-1';
                    rejConfirmBtn.style.fontSize = '0.7rem';
                    rejConfirmBtn.style.padding = '0.1rem 0.4rem';
                    rejConfirmBtn.textContent = '確認';
                    rejConfirmBtn.onclick = function() {
                      rejConfirmBtn.disabled = true;
                      rejConfirmBtn.textContent = '処理中...';
                      google.script.run.withSuccessHandler(function(j) {
                        bootstrap.Modal.getInstance(document.getElementById('eventModal')).hide();
                        loadAndRender();
                        if (window.staffMode) loadStaffSchedule();
                      }).withFailureHandler(function(e) {
                        rejConfirmBtn.disabled = false;
                        rejConfirmBtn.textContent = '確認';
                      }).clearCancelRejection(r.recruitRowIndex, window.currentUserName || '', window.currentUserEmail || '');
                    };
                    rejWrap.appendChild(rejConfirmBtn);
                    cancelBtnArea.appendChild(rejWrap);
                  } else if (alreadyRequested) {
                    var pendingBadge = document.createElement('span');
                    pendingBadge.className = 'badge bg-warning text-dark';
                    pendingBadge.style.fontSize = '0.7rem';
                    pendingBadge.innerHTML = '<i class="bi bi-hourglass-split"></i> 取消申請中';
                    cancelBtnArea.appendChild(pendingBadge);
                  } else {
                    var cancelReqBtn = document.createElement('button');
                    cancelReqBtn.type = 'button';
                    cancelReqBtn.className = 'btn btn-sm btn-danger';
                    cancelReqBtn.style.fontSize = '0.7rem';
                    cancelReqBtn.style.padding = '0.15rem 0.5rem';
                    cancelReqBtn.style.whiteSpace = 'nowrap';
                    cancelReqBtn.textContent = '取消申請';
                    cancelReqBtn.onclick = function() {
                      customConfirm('出勤の取り消し申請を提出します。\nオーナーの承認後に取り消しが反映されます。\n\nよろしいですか？').then(function(ok) {
                        if (!ok) return;
                        cancelReqBtn.disabled = true;
                        cancelReqBtn.textContent = '申請中...';
                        cancelReqBtn.className = 'btn btn-sm btn-secondary';
                        google.script.run.withSuccessHandler(function(j) {
                          var res = JSON.parse(j);
                          if (res.success) {
                            bootstrap.Modal.getInstance(document.getElementById('eventModal')).hide();
                            loadAndRender();
                            if (window.staffMode) loadStaffSchedule();
                          } else { alert(res.error || '失敗'); cancelReqBtn.disabled = false; cancelReqBtn.textContent = '取消申請'; cancelReqBtn.className = 'btn btn-sm btn-danger'; }
                        }).withFailureHandler(function(e) { alert(e.message); cancelReqBtn.disabled = false; cancelReqBtn.textContent = '取消申請'; cancelReqBtn.className = 'btn btn-sm btn-danger'; }).submitStaffCancelRequest(r.recruitRowIndex, props.rowNumber, checkoutDate || r.checkoutDate || '', window.currentUserName || '', window.currentUserEmail || '');
                      });
                    };
                    cancelBtnArea.appendChild(cancelReqBtn);
                  }
                }
              }
              var isEventConfirmed = r.success && r.recruitRowIndex && (r.status === 'スタッフ確定済み' || r.status === '選定済');
              if (r.success && r.recruitRowIndex && !staffAssigned) {
                var curName = (window.currentUserName || '').trim().toLowerCase();
                var curEmail = (window.currentUserEmail || '').trim().toLowerCase();
                var myResponse = '';
                var myMemo = '';
                if (r.volunteers) {
                  r.volunteers.forEach(function(v) {
                    if ((v.staffName || '').trim().toLowerCase() === curName || (v.email || '').trim().toLowerCase() === curEmail) {
                      myResponse = v.response || '未回答';
                      myMemo = v.memo || '';
                    }
                  });
                }
                if (volBodyArea && isEventConfirmed) {
                  // スタッフ確定済み: 回答変更不可、変更要請ボタンのみ
                  var confirmNotice = document.createElement('div');
                  confirmNotice.className = 'small text-muted mb-2 text-center';
                  confirmNotice.textContent = 'スタッフ確定済みのため回答変更はできません';
                  volBodyArea.appendChild(confirmNotice);
                  if (myResponse && myResponse !== '未回答') {
                    var curBadge = document.createElement('div');
                    curBadge.className = 'small mb-2 text-center';
                    curBadge.innerHTML = '現在の回答: <strong>' + escapeHtml(myResponse) + '</strong>' + (myMemo ? '（' + escapeHtml(myMemo) + '）' : '');
                    volBodyArea.appendChild(curBadge);
                  }
                  var changeBtnRow = document.createElement('div');
                  changeBtnRow.className = 'd-flex gap-1 justify-content-center flex-wrap';
                  var changeOpts = [
                    { val: '◎', icon: '●', text: '対応可\n要請', cls: 'outline-warning' },
                    { val: '△', icon: '▲', text: '条件付\n要請', cls: 'outline-warning' },
                    { val: '×', icon: '✖', text: '不可\n要請', cls: 'outline-warning' }
                  ];
                  changeOpts.forEach(function(opt) {
                    var b = document.createElement('button');
                    b.type = 'button';
                    b.className = 'btn btn-sm btn-' + opt.cls + ' fw-bold btn-stacked';
                    b.innerHTML = '<span class="btn-icon">' + opt.icon + '</span><span class="btn-label" style="white-space:pre-line;">' + opt.text + '</span>';
                    b.onclick = function() {
                      var memoEl = document.getElementById('eventModalChangeMemo');
                      var memoVal = (memoEl && memoEl.value) ? String(memoEl.value).trim() : '';
                      if (!memoVal) { alert('変更理由を入力してください。'); return; }
                      setButtonLoading(b, true);
                      google.script.run.withSuccessHandler(function(j) {
                        var res = JSON.parse(j);
                        if (res.success) {
                          alert('回答変更要請を送信しました。オーナーの承認をお待ちください。');
                          bootstrap.Modal.getInstance(document.getElementById('eventModal')).hide();
                          loadAndRender();
                          if (window.staffMode) loadStaffSchedule();
                          loadRecruitList();
                        } else { alert(res.error || '失敗'); setButtonLoading(b, false); }
                      }).withFailureHandler(function(e) { alert(e.message); setButtonLoading(b, false); }).requestResponseChange('r' + r.recruitRowIndex, window.currentUserName || '', window.currentUserEmail || '', opt.val, memoVal);
                    };
                    changeBtnRow.appendChild(b);
                  });
                  volBodyArea.appendChild(changeBtnRow);
                  var changeMemoWrap = document.createElement('div');
                  changeMemoWrap.className = 'mt-2 mb-1';
                  changeMemoWrap.innerHTML = '<label class="form-label small fw-bold">変更理由</label><input type="text" class="form-control form-control-sm" id="eventModalChangeMemo" placeholder="変更理由を記入">';
                  volBodyArea.appendChild(changeMemoWrap);
                } else if (volBodyArea && !isEventConfirmed) {
                  // 募集中（確定済み以外）: 回答ボタン → 備考入力欄の順
                  if (myResponse && myResponse !== '未回答') {
                    var curBadge = document.createElement('div');
                    curBadge.className = 'small text-muted mb-1 text-center';
                    curBadge.textContent = '現在の回答: ' + myResponse + (myMemo ? '（' + myMemo + '）' : '');
                    volBodyArea.appendChild(curBadge);
                  }
                  var btnRow = document.createElement('div');
                  btnRow.className = 'd-flex gap-2 justify-content-center flex-wrap';
                  var responses = [
                    { val: '◎', icon: '●', text: '対応可', cls: 'success' },
                    { val: '△', icon: '▲', text: '条件付', cls: 'warning' },
                    { val: '×', icon: '✖', text: '不可', cls: 'danger' }
                  ];
                  responses.forEach(function(opt) {
                    var b = document.createElement('button');
                    b.type = 'button';
                    b.className = 'btn btn-sm btn-' + (myResponse === opt.val ? '' : 'outline-') + opt.cls + ' fw-bold btn-stacked';
                    b.innerHTML = '<span class="btn-icon">' + opt.icon + '</span><span class="btn-label">' + opt.text + '</span>';
                    b.onclick = function() {
                      var memoEl = document.getElementById('eventModalResponseMemo');
                      var memoVal = (memoEl && memoEl.value) ? String(memoEl.value).trim() : '';
                      setButtonLoading(b, true);
                      google.script.run.withSuccessHandler(function(j) {
                        var res = JSON.parse(j);
                        if (res.success) {
                          bootstrap.Modal.getInstance(document.getElementById('eventModal')).hide();
                          loadAndRender();
                          if (window.staffMode) loadStaffSchedule();
                          loadRecruitList();
                        } else { alert(res.error || '失敗'); setButtonLoading(b, false); }
                      }).withFailureHandler(function(e) { alert(e.message); setButtonLoading(b, false); }).respondToRecruitment('r' + r.recruitRowIndex, window.currentUserName || '', window.currentUserEmail || '', opt.val, memoVal);
                    };
                    btnRow.appendChild(b);
                  });
                  // 回答済みの場合「回答削除」ボタンを同じ行に追加
                  if (myResponse) {
                    var delBtn = document.createElement('button');
                    delBtn.type = 'button';
                    delBtn.className = 'btn btn-sm btn-outline-secondary fw-bold btn-stacked';
                    delBtn.innerHTML = '<span class="btn-icon" style="font-size:0.8rem;">回答</span><span class="btn-label">削除</span>';
                    delBtn.onclick = function() {
                      customConfirm('回答を削除しますか？').then(function(ok) {
                        if (!ok) return;
                        setButtonLoading(delBtn, true);
                        google.script.run.withSuccessHandler(function(j) {
                          var res = JSON.parse(j);
                          if (res.success) {
                            bootstrap.Modal.getInstance(document.getElementById('eventModal')).hide();
                            loadAndRender();
                            if (window.staffMode) loadStaffSchedule();
                            loadRecruitList();
                          } else { alert(res.error || '失敗'); setButtonLoading(delBtn, false); }
                        }).withFailureHandler(function(e) { alert(e.message); setButtonLoading(delBtn, false); }).cancelVolunteerForRecruitment('r' + r.recruitRowIndex, window.currentUserName || '', window.currentUserEmail || '');
                      });
                    };
                    btnRow.appendChild(delBtn);
                  }
                  volBodyArea.appendChild(btnRow);
                  var memoWrap = document.createElement('div');
                  memoWrap.className = 'mt-2 mb-1';
                  memoWrap.innerHTML = '<label class="form-label small fw-bold">備考（例：14時以降なら対応可能）</label><input type="text" class="form-control form-control-sm" id="eventModalResponseMemo" placeholder="何時からなら対応可能、など">';
                  var memoInput = memoWrap.querySelector('input');
                  if (memoInput && myMemo) memoInput.value = myMemo;
                  volBodyArea.appendChild(memoWrap);
                }
              }
            } catch (e) {}
          };
          window._batchRecruitFailHandler = function() {
            if (modalGen !== window._eventModalGen) return;
            var nEl = document.getElementById('eventModalStaffNextResContent');
            if (nEl) nEl.innerHTML = '<div class="nres-item" style="grid-column:1/-1;"><span class="text-muted">取得できませんでした</span></div>';
            updateNextResHeader(null);
            var sEl = document.getElementById('eventModalStaffRecruitStatus');
            if (sEl) { sEl.textContent = '－'; sEl.className = 'recruit-status-badge status-undecided'; sEl.removeAttribute('style'); }
            var _bl2 = document.getElementById('volBodyLoading'); if (_bl2) _bl2.remove();
            var vA = document.getElementById('eventModalVolunteersArea'); if (vA) vA.style.display = 'none';
            var vL = document.getElementById('eventModalVolunteersList'); if (vL) vL.innerHTML = '';
          };
        }

        if (type === 'cleaning' && !isStaff) {
          window._batchRecruitHandler = function(rStr) {
            if (modalGen !== window._eventModalGen) return; // 古いコールバックを無視
            try {
              var r = JSON.parse(rStr);
              var nextEl = document.getElementById('eventModalStaffNextResContent');
              var statusEl = document.getElementById('eventModalStaffRecruitStatus');
              var volArea = document.getElementById('eventModalVolunteersArea');
              var volList = document.getElementById('eventModalVolunteersList');
              var ownerCenterArea = document.getElementById('eventModalVolunteerBodyArea');
              var statusBtnArea = document.getElementById('eventModalStatusBtnArea');
              if (nextEl && r.success) {
                var nr = r.nextReservation || {};
                if (nr.date) {
                  var dateDisp = fmtDateRange(nr.date);
                  nextEl.innerHTML = '<div class="nres-item"><span class="nres-label">日付:</span><span class="nres-value">' + escapeHtml(dateDisp) + '</span></div><div class="nres-item"><span class="nres-label">人数:</span><span class="nres-value">' + fmt(nr.guestCount) + '</span></div><div class="nres-item"><span class="nres-label">ベッド:</span><span class="nres-value">' + fmt(nr.bedCount) + '</span></div><div class="nres-item"><span class="nres-label">BBQ:</span><span class="nres-value">' + fmt(bbqAriNashi(nr.bbq)) + '</span></div><div class="nres-item"><span class="nres-label">国籍:</span><span class="nres-value">' + fmt(nr.nationality || '日本') + '</span></div>';
                  updateNextResHeader(dateDisp);
                } else {
                  nextEl.innerHTML = '<div class="nres-item" style="grid-column:1/-1;"><span class="text-muted">次回予約なし</span></div>';
                  updateNextResHeader('なし');
                }
              } else if (nextEl) {
                nextEl.innerHTML = '<div class="nres-item" style="grid-column:1/-1;"><span class="text-muted">取得できませんでした</span></div>';
                updateNextResHeader(null);
              }
              var ownerStaffAssigned = (d.cleaningStaff || '').trim();
              var ownerResolvedStaff = ownerStaffAssigned || (r.selectedStaff || '').trim();
              // 清掃担当表示を最新の選定結果で更新
              var ownerStaffDisplayEl = document.getElementById('eventModalStaffDisplay');
              if (ownerStaffDisplayEl && r.success) {
                ownerStaffDisplayEl.innerHTML = formatStaffDisplayHtml(ownerResolvedStaff, r.volunteers);
                var ownerStaffLabel = ownerStaffDisplayEl.closest('.modal-staff-label');
                if (ownerStaffLabel) {
                  ownerStaffLabel.classList.remove('staff-set', 'staff-unset');
                  ownerStaffLabel.classList.add(ownerResolvedStaff ? 'staff-set' : 'staff-unset');
                }
              }
              var ownerEffectiveStatus = r.status;
              var isOwnerConfirmed = (ownerEffectiveStatus === 'スタッフ確定済み' || ownerEffectiveStatus === '選定済');
              // ステータス更新（editBtnAreaを含めてinnerHTMLで再構築）
              if (statusEl && r.success) {
                var editBtnHtml = '<span id="eventModalEditStaffBtnArea" style="position:absolute;right:0.5rem;top:50%;transform:translateY(-50%);"></span>';
                statusEl.innerHTML = (isOwnerConfirmed ? 'スタッフ確定済み' : 'スタッフ募集中') + editBtnHtml;
                statusEl.className = 'recruit-status-badge ' + (isOwnerConfirmed ? 'status-decided' : 'status-recruiting');
                statusEl.style.position = 'relative';
              }
              // 編集ボタンをステータスバッジ内右側に配置（確定済み＋担当者ありの場合のみ）
              var editBtnArea = document.getElementById('eventModalEditStaffBtnArea');
              if (editBtnArea && isOwnerConfirmed && (d.cleaningStaff || '').trim()) {
                var btnEditStaff = document.createElement('button');
                btnEditStaff.type = 'button';
                btnEditStaff.className = 'btn btn-sm';
                btnEditStaff.style.cssText = 'font-size:0.7rem;padding:0.15rem 0.5rem;background:rgba(255,255,255,0.25);color:#fff;border:1px solid rgba(255,255,255,0.6);';
                btnEditStaff.innerHTML = '<i class="bi bi-pencil-square"></i> 編集';
                btnEditStaff.onmouseenter = function() { this.style.background = 'rgba(255,255,255,0.45)'; };
                btnEditStaff.onmouseleave = function() { this.style.background = 'rgba(255,255,255,0.25)'; };
                btnEditStaff.onclick = function() {
                  bootstrap.Modal.getInstance(document.getElementById('eventModal')).hide();
                  openStaffEditModal(props.rowNumber, (d.cleaningStaff || '').trim(), r.volunteers || []);
                };
                editBtnArea.appendChild(btnEditStaff);
              }
              if (volArea && volList) {
                if (r.success) {
                  volArea.style.display = 'block';
                  volList.innerHTML = renderStaffResponses(r.volunteers);
                } else {
                  volArea.style.display = 'none';
                  volList.innerHTML = '';
                }
              }
              if (ownerCenterArea) { var _bl3 = document.getElementById('volBodyLoading'); if (_bl3) _bl3.remove(); }
              if (!ownerStaffAssigned && statusBtnArea && r.success) {
                var rowNum = props.rowNumber;
                var checkoutDate = (d && d.checkOut) ? (d.checkOutParsed || String(d.checkOut).slice(0,10)) : '';
                if (!r.recruitRowIndex) {
                  // 募集レコードが未作成→自動作成（ボタン不要）
                  statusBtnArea.innerHTML = '<small class="text-muted">募集レコード作成中...</small>';
                  var detail = { date:'', guestCount:'', bbq:'', nationality:'日本', memo:'', cleaningStaff:'', notifyMethod:'メール' };
                  (function(oca, cd, rn, dt) {
                    google.script.run.withSuccessHandler(function(j) {
                      var res = JSON.parse(j);
                      if (res.success && res.rowIndex) {
                        oca.innerHTML = '';
                        var emPopMail = document.createElement('button');
                        emPopMail.type = 'button';
                        emPopMail.className = 'btn btn-sm btn-primary me-1';
                        emPopMail.textContent = 'メール送信';
                        emPopMail.onclick = function() {
                          customConfirm('登録者全員に一斉送信します。よろしいですか？').then(function(ok) {
                            if (!ok) return;
                            google.script.run.withSuccessHandler(function(a) {
                              var ann = JSON.parse(a);
                              if (ann.success) { alert('募集を開始しました。メールで送信しました。'); bootstrap.Modal.getInstance(document.getElementById('eventModal')).hide(); loadAndRender(); loadRecruitList(); }
                              else alert(ann.error || '失敗');
                            }).announceRecruitment(res.rowIndex);
                          });
                        };
                        var emPopCopy = document.createElement('button');
                        emPopCopy.type = 'button';
                        emPopCopy.className = 'btn btn-sm btn-info text-white me-1';
                        emPopCopy.textContent = 'テキストコピー';
                        emPopCopy.onclick = function() {
                          google.script.run.withSuccessHandler(function(t) {
                            var jt = JSON.parse(t);
                            var lineArea = document.getElementById('eventModalLineCopyArea');
                            var txtEl = document.getElementById('eventModalLineCopyText');
                            var btnCopy = document.getElementById('eventModalCopyToClipboard');
                            if (jt.success && jt.copyText && lineArea && txtEl) {
                              txtEl.value = jt.copyText;
                              lineArea.style.display = 'block';
                              lineArea.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                              if (btnCopy) btnCopy.onclick = function() {
                                if (navigator.clipboard && navigator.clipboard.writeText) {
                                  navigator.clipboard.writeText(jt.copyText).then(function() {
                                    bootstrap.Modal.getInstance(document.getElementById('eventModal')).hide();
                                    loadAndRender();
                                    loadRecruitList();
                                  }).catch(function() { txtEl.select(); document.execCommand('copy'); bootstrap.Modal.getInstance(document.getElementById('eventModal')).hide(); loadAndRender(); loadRecruitList(); });
                                } else {
                                  txtEl.select();
                                  document.execCommand('copy');
                                  bootstrap.Modal.getInstance(document.getElementById('eventModal')).hide();
                                  loadAndRender();
                                  loadRecruitList();
                                }
                              };
                            } else if (!jt.success) alert(jt.error || 'コピーに失敗しました');
                          }).getRecruitmentCopyText(cd, rn, dt);
                        };
                        var popBtnRow = document.createElement('div');
                        popBtnRow.className = 'd-flex flex-wrap justify-content-center gap-1 mt-2';
                        popBtnRow.appendChild(emPopMail);
                        popBtnRow.appendChild(emPopCopy);
                        oca.appendChild(popBtnRow);
                      } else {
                        oca.innerHTML = '';
                      }
                    }).withFailureHandler(function() {
                      oca.innerHTML = '';
                    }).saveRecruitmentDetail(null, rn, cd, dt);
                  })(statusBtnArea, checkoutDate, rowNum, detail);
                } else {
                  var hasVol = r.volunteers && r.volunteers.length > 0;
                  var emBtnMail = document.createElement('button');
                  emBtnMail.type = 'button';
                  emBtnMail.className = 'btn btn-sm btn-primary';
                  emBtnMail.textContent = 'メール送信';
                  emBtnMail.onclick = function() {
                    customConfirm('登録者全員に一斉送信します。よろしいですか？').then(function(ok) {
                      if (!ok) return;
                      setButtonLoading(emBtnMail, true);
                      google.script.run.withSuccessHandler(function(a) {
                        setButtonLoading(emBtnMail, false);
                        var ann = JSON.parse(a);
                        if (ann.success) { alert('メールで送信しました。'); bootstrap.Modal.getInstance(document.getElementById('eventModal')).hide(); loadAndRender(); loadRecruitList(); }
                        else alert(ann.error || '失敗');
                      }).withFailureHandler(function(e) {
                        setButtonLoading(emBtnMail, false);
                        alert(e.message || 'エラー');
                      }).announceRecruitment(r.recruitRowIndex);
                    });
                  };
                  var emBtnCopy = document.createElement('button');
                  emBtnCopy.type = 'button';
                  emBtnCopy.className = 'btn btn-sm btn-info text-white';
                  emBtnCopy.textContent = 'テキストコピー';
                  emBtnCopy.onclick = function() {
                    google.script.run.withSuccessHandler(function(t) {
                      var jt = JSON.parse(t);
                      var lineArea = document.getElementById('eventModalLineCopyArea');
                      var txtEl = document.getElementById('eventModalLineCopyText');
                      var btnCopy = document.getElementById('eventModalCopyToClipboard');
                      if (jt.success && jt.copyText && lineArea && txtEl) {
                        txtEl.value = jt.copyText;
                        lineArea.style.display = 'block';
                        lineArea.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                        if (btnCopy) {
                          btnCopy.onclick = function() {
                            if (navigator.clipboard && navigator.clipboard.writeText) navigator.clipboard.writeText(jt.copyText).then(function() { alert('コピーしました。LINEに貼り付けてください。'); }).catch(function() { txtEl.select(); document.execCommand('copy'); alert('コピーしました。'); });
                            else { txtEl.select(); document.execCommand('copy'); alert('コピーしました。'); }
                          };
                        }
                      } else if (!jt.success) alert(jt.error || 'コピーに失敗しました');
                    }).getRecruitmentCopyText(checkoutDate || r.checkoutDate, rowNum, { date:'', guestCount:'', bbq:'', nationality:'日本', memo:'' });
                  };
                  var emBtnCancel = document.createElement('button');
                  emBtnCancel.type = 'button';
                  emBtnCancel.className = 'btn btn-sm btn-danger';
                  emBtnCancel.textContent = '募集取消';
                  emBtnCancel.onclick = function() {
                    var volCount = r.volunteers && r.volunteers.length ? r.volunteers.length : 0;
                    var confirmMsg = volCount > 0 ? '回答済みスタッフが' + volCount + '名います。募集を取消しますか？' : '募集を取消しますか？';
                    customConfirm(confirmMsg).then(function(ok) {
                      if (!ok) return;
                      setButtonLoading(emBtnCancel, true);
                      google.script.run.withSuccessHandler(function(j) {
                        setButtonLoading(emBtnCancel, false);
                        var res = JSON.parse(j);
                        if (res.success) { bootstrap.Modal.getInstance(document.getElementById('eventModal')).hide(); loadAndRender(); loadRecruitList(); }
                        else alert(res.error);
                      }).withFailureHandler(function(e) {
                        setButtonLoading(emBtnCancel, false);
                        alert(e.message || 'エラー');
                      }).deleteRecruitment(r.recruitRowIndex);
                    });
                  };
                  var btnRow = document.createElement('div');
                  btnRow.className = 'd-flex flex-wrap justify-content-center gap-1 mt-2';
                  btnRow.appendChild(emBtnMail);
                  btnRow.appendChild(emBtnCopy);
                  var emBtnSelect = document.createElement('button');
                  emBtnSelect.type = 'button';
                  emBtnSelect.className = 'btn btn-sm btn-success';
                  emBtnSelect.textContent = 'スタッフ選定';
                  emBtnSelect.onclick = function() {
                    bootstrap.Modal.getInstance(document.getElementById('eventModal')).hide();
                    openRecruitSelectModal({ rowIndex: r.recruitRowIndex, bookingRowNumber: props.rowNumber, volunteers: r.volunteers || [], checkoutDate: checkoutDate || r.checkoutDate, selectedStaff: r.selectedStaff || (d.cleaningStaff || '') });
                  };
                  btnRow.appendChild(emBtnSelect);
                  // 確定（募集締切）ボタン: スタッフ選定済み + ステータスが募集中の場合のみ表示
                  var hasSelectedStaff = (r.selectedStaff || '').trim() || (d.cleaningStaff || '').trim();
                  if (hasSelectedStaff && !isOwnerConfirmed) {
                    var emBtnConfirm = document.createElement('button');
                    emBtnConfirm.type = 'button';
                    emBtnConfirm.className = 'btn btn-sm btn-warning fw-bold';
                    emBtnConfirm.textContent = '確定（募集締切）';
                    emBtnConfirm.onclick = function() {
                      customConfirm('スタッフを確定し、募集を締め切りますか？').then(function(ok) {
                        if (!ok) return;
                        emBtnConfirm.disabled = true;
                        emBtnConfirm.textContent = '処理中...';
                        google.script.run.withSuccessHandler(function(j) {
                          var res = JSON.parse(j);
                          if (res.success) {
                            applyConfirmOptimistic(r.recruitRowIndex, props.rowNumber, (r.selectedStaff || d.cleaningStaff || '').trim());
                            loadAndRender(); loadRecruitList();
                            showConfirmationNotifyUI(ownerCenterArea, r.recruitRowIndex, 'eventModal');
                          }
                          else { alert(res.error); emBtnConfirm.disabled = false; emBtnConfirm.textContent = '確定（募集締切）'; }
                        }).withFailureHandler(function(e) { alert(e.message); emBtnConfirm.disabled = false; emBtnConfirm.textContent = '確定（募集締切）'; }).confirmRecruitment(r.recruitRowIndex);
                      });
                    };
                    btnRow.appendChild(emBtnConfirm);
                  }
                  btnRow.appendChild(emBtnCancel);
                  statusBtnArea.appendChild(btnRow);
                }
              }
              // 編集ボタンはカード右上（eventModalEditStaffBtnArea）に移動済み
              // 取り消し申請がある場合、承認ボタンを表示
              if (r.cancelRequested && r.cancelRequested.length && r.recruitRowIndex && ownerCenterArea) {
                r.cancelRequested.forEach(function(cr) {
                  var approveWrap = document.createElement('div');
                  approveWrap.className = 'w-100 mt-2 p-2 border border-warning rounded bg-warning bg-opacity-10';
                  approveWrap.innerHTML = '<div class="small fw-bold text-warning mb-1"><i class="bi bi-exclamation-triangle"></i> 取り消し申請: ' + escapeHtml(cr.staffName) + '</div>';
                  var btnApprove = document.createElement('button');
                  btnApprove.type = 'button';
                  btnApprove.className = 'btn btn-sm btn-warning me-1';
                  btnApprove.textContent = '取り消し承認';
                  btnApprove.onclick = function() {
                    customConfirm(cr.staffName + ' の取り消しを承認しますか？\n\n承認すると清掃担当が解除され、再度募集状態に戻ります。').then(function(ok) {
                      if (!ok) return;
                      btnApprove.disabled = true;
                      btnApprove.textContent = '処理中...';
                      google.script.run.withSuccessHandler(function(j) {
                        var res = JSON.parse(j);
                        if (res.success) {
                          alert('取り消しを承認しました。清掃担当が解除され、募集状態に戻りました。');
                          bootstrap.Modal.getInstance(document.getElementById('eventModal')).hide();
                          loadAndRender();
                          loadRecruitList();
                        } else {
                          alert(res.error || '失敗');
                          btnApprove.disabled = false;
                          btnApprove.textContent = '取り消し承認';
                        }
                      }).withFailureHandler(function(e) {
                        alert(e.message);
                        btnApprove.disabled = false;
                        btnApprove.textContent = '取り消し承認';
                      }).approveCancelRequest(r.recruitRowIndex, cr.staffName, cr.email);
                    });
                  };
                  var btnReject = document.createElement('button');
                  btnReject.type = 'button';
                  btnReject.className = 'btn btn-sm btn-outline-secondary';
                  btnReject.textContent = '却下';
                  btnReject.onclick = function() {
                    customConfirm(cr.staffName + ' の取り消し申請を却下しますか？').then(function(ok) {
                      if (!ok) return;
                      google.script.run.withSuccessHandler(function(j) {
                        var res = JSON.parse(j);
                        if (res.success) {
                          approveWrap.remove();
                          loadAndRender();
                        } else alert(res.error || '失敗');
                      }).withFailureHandler(function(e) { alert(e.message); }).rejectCancelRequest(r.recruitRowIndex, cr.staffName, cr.email);
                    });
                  };
                  approveWrap.appendChild(btnApprove);
                  approveWrap.appendChild(btnReject);
                  ownerCenterArea.appendChild(approveWrap);
                });
              }
              // 回答変更要請がある場合、承認/否認ボタンを表示
              if (r.responseChangeRequests && r.responseChangeRequests.length && ownerCenterArea) {
                r.responseChangeRequests.forEach(function(rcr) {
                  var rcWrap = document.createElement('div');
                  rcWrap.className = 'w-100 mt-2 p-2 border border-info rounded bg-info bg-opacity-10';
                  rcWrap.innerHTML = '<div class="small fw-bold text-info mb-1">回答変更要請: ' + escapeHtml(rcr.staffName) + ' → ' + escapeHtml(rcr.newResponse) + (rcr.memo ? '（' + escapeHtml(rcr.memo) + '）' : '') + '</div>';
                  var btnRcApprove = document.createElement('button');
                  btnRcApprove.type = 'button';
                  btnRcApprove.className = 'btn btn-sm btn-info me-1';
                  btnRcApprove.textContent = '承認';
                  btnRcApprove.onclick = function() {
                    customConfirm(rcr.staffName + ' の回答変更（→' + rcr.newResponse + '）を承認しますか？').then(function(ok) {
                      if (!ok) return;
                      btnRcApprove.disabled = true;
                      btnRcApprove.textContent = '処理中...';
                      google.script.run.withSuccessHandler(function(j) {
                        var res = JSON.parse(j);
                        if (res.success) {
                          alert('回答変更を承認しました。');
                          bootstrap.Modal.getInstance(document.getElementById('eventModal')).hide();
                          loadAndRender(); loadRecruitList();
                        } else { alert(res.error || '失敗'); btnRcApprove.disabled = false; btnRcApprove.textContent = '承認'; }
                      }).withFailureHandler(function(e) { alert(e.message); btnRcApprove.disabled = false; btnRcApprove.textContent = '承認'; }).approveResponseChange(rcr.rowIndex);
                    });
                  };
                  var btnRcReject = document.createElement('button');
                  btnRcReject.type = 'button';
                  btnRcReject.className = 'btn btn-sm btn-outline-secondary';
                  btnRcReject.textContent = '否認';
                  btnRcReject.onclick = function() {
                    customConfirm(rcr.staffName + ' の回答変更要請を否認しますか？').then(function(ok) {
                      if (!ok) return;
                      google.script.run.withSuccessHandler(function(j) {
                        var res = JSON.parse(j);
                        if (res.success) { rcWrap.remove(); loadAndRender(); }
                        else alert(res.error || '失敗');
                      }).withFailureHandler(function(e) { alert(e.message); }).rejectResponseChange(rcr.rowIndex);
                    });
                  };
                  rcWrap.appendChild(btnRcApprove);
                  rcWrap.appendChild(btnRcReject);
                  ownerCenterArea.appendChild(rcWrap);
                });
              }
            } catch (e) {}
          };
          window._batchRecruitFailHandler = function() {
            if (modalGen !== window._eventModalGen) return;
            var nEl = document.getElementById('eventModalStaffNextResContent');
            if (nEl) nEl.innerHTML = '<div class="nres-item" style="grid-column:1/-1;"><span class="text-muted">取得できませんでした</span></div>';
            updateNextResHeader(null);
            var sEl = document.getElementById('eventModalStaffRecruitStatus');
            if (sEl) { sEl.textContent = '－'; sEl.className = 'recruit-status-badge status-undecided'; sEl.removeAttribute('style'); }
            var _bl2 = document.getElementById('volBodyLoading'); if (_bl2) _bl2.remove();
            var vA = document.getElementById('eventModalVolunteersArea'); if (vA) vA.style.display = 'none';
            var vL = document.getElementById('eventModalVolunteersList'); if (vL) vL.innerHTML = '';
          };
          setTimeout(function() {
            var addBtn = document.getElementById('eventModalAddStaff');
            var confirmBtn = document.getElementById('eventModalConfirmSelect');
            function renderSelList() {
              var listEl = document.getElementById('eventModalStaffSelectedList');
              if (!listEl) return;
              var names = window._eventModalSelectNames || [];
              listEl.innerHTML = names.map(function(n, i) {
                return '<span class="badge bg-secondary me-1 mb-1 d-inline-flex align-items-center">' + escapeHtml(n) + ' <button type="button" class="btn btn-link btn-sm p-0 ms-1 text-white event-modal-staff-rm" data-i="' + i + '">×</button></span>';
              }).join('');
              listEl.querySelectorAll('.event-modal-staff-rm').forEach(function(b) {
                b.onclick = function() {
                  var i = parseInt(this.getAttribute('data-i'), 10);
                  window._eventModalSelectNames.splice(i, 1);
                  renderSelList();
                };
              });
            }
            if (addBtn) addBtn.onclick = function() {
              var sel = document.getElementById('eventModalStaffDropdown');
              var v = (sel && sel.value || '').trim();
              if (!v) return;
              window._eventModalSelectNames = window._eventModalSelectNames || [];
              if (window._eventModalSelectNames.indexOf(v) < 0) window._eventModalSelectNames.push(v);
              renderSelList();
            };
            if (confirmBtn) confirmBtn.onclick = function() {
              var names = window._eventModalSelectNames || [];
              var staffStr = names.join(', ');
              var errEl = document.getElementById('eventModalSelectError');
              if (!staffStr) { if (errEl) { errEl.textContent = 'スタッフを選択してください。'; errEl.style.display = 'block'; } return; }
              if (errEl) errEl.style.display = 'none';
              confirmBtn.disabled = true;
              var rowNum = window._eventModalRowNumber;
              var recruitIdx = window._eventModalRecruitRowIndex || 0;
              function onOk() {
                bootstrap.Modal.getInstance(document.getElementById('eventModal')).hide();
                loadAndRender();
              }
              if (recruitIdx > 0) {
                google.script.run.withSuccessHandler(function(j) {
                  var r = JSON.parse(j);
                  if (r.success) onOk(); else { if (errEl) { errEl.textContent = r.error || '失敗'; errEl.style.display = 'block'; } }
                  confirmBtn.disabled = false;
                }).withFailureHandler(function(e) { if (errEl) { errEl.textContent = e.message; errEl.style.display = 'block'; } confirmBtn.disabled = false; }).selectStaffForRecruitment(recruitIdx, staffStr);
              } else {
                google.script.run.withSuccessHandler(function(j) {
                  var r = JSON.parse(j);
                  if (r.success) onOk(); else { if (errEl) { errEl.textContent = r.error || '失敗'; errEl.style.display = 'block'; } }
                  confirmBtn.disabled = false;
                }).withFailureHandler(function(e) { if (errEl) { errEl.textContent = e.message; errEl.style.display = 'block'; } confirmBtn.disabled = false; }).updateCleaningStaff(rowNum, staffStr);
              }
            };
          }, 100);
        }
      }

      // --- カスタムダイアログ（GAS URL非表示） ---
      // backdrop の z-index を調整して最前面に表示
      function _fixDialogBackdrop(modalEl) {
        setTimeout(function() {
          var backdrops = document.querySelectorAll('.modal-backdrop');
          if (backdrops.length > 0) {
            var last = backdrops[backdrops.length - 1];
            last.style.zIndex = '1065';
          }
        }, 10);
      }
      function customConfirm(msg) {
        return new Promise(function(resolve) {
          var modal = document.getElementById('customConfirmModal');
          var msgEl = document.getElementById('customConfirmMessage');
          var okBtn = document.getElementById('customConfirmOk');
          var cancelBtn = document.getElementById('customConfirmCancel');
          msgEl.textContent = msg;
          var bsModal = bootstrap.Modal.getInstance(modal);
          if (bsModal) bsModal.dispose();
          bsModal = new bootstrap.Modal(modal);
          var resolved = false;
          function cleanup() { okBtn.onclick = null; cancelBtn.onclick = null; modal.removeEventListener('hidden.bs.modal', onHidden); }
          function onOk() { if (resolved) return; resolved = true; cleanup(); bsModal.hide(); resolve(true); }
          function onCancel() { if (resolved) return; resolved = true; cleanup(); bsModal.hide(); resolve(false); }
          function onHidden() { if (!resolved) { resolved = true; cleanup(); resolve(false); } }
          okBtn.onclick = onOk;
          cancelBtn.onclick = onCancel;
          modal.addEventListener('hidden.bs.modal', onHidden);
          _fixDialogBackdrop(modal);
          bsModal.show();
          _fixDialogBackdrop(modal);
        });
      }
      function customAlert(msg) {
        var modal = document.getElementById('customAlertModal');
        var msgEl = document.getElementById('customAlertMessage');
        if (modal && msgEl) {
          msgEl.textContent = msg;
          var bsModal = bootstrap.Modal.getInstance(modal);
          if (bsModal) bsModal.dispose();
          bsModal = new bootstrap.Modal(modal);
          _fixDialogBackdrop(modal);
          bsModal.show();
          _fixDialogBackdrop(modal);
        }
      }
      window.alert = function(msg) { customAlert(String(msg || '')); };

      function escapeHtml(s) {
        if (s == null) return '';
        const div = document.createElement('div');
        div.textContent = s;
        return div.innerHTML;
      }

      function setButtonLoading(btn, isLoading) {
        if (!btn) return;
        if (isLoading) {
          btn.disabled = true;
          if (!btn._origHTML) btn._origHTML = btn.innerHTML;
          btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1" role="status"></span>' + (btn._origHTML || '');
        } else {
          btn.disabled = false;
          if (btn._origHTML) btn.innerHTML = btn._origHTML;
          btn._origHTML = null;
        }
      }

      // 清掃担当編集モーダルを開く
      function openStaffEditModal(rowNumber, currentStaff, volunteers) {
        document.getElementById('staffEditRowNumber').value = rowNumber;
        document.getElementById('staffEditError').style.display = 'none';
        document.getElementById('staffEditError').textContent = '';
        var names = (currentStaff || '').split(/[,、]/).map(function(s) { return s.trim(); }).filter(Boolean);
        window._staffEditNames = names;
        renderStaffEditList();
        var sel = document.getElementById('staffEditAddSelect');
        var otherArea = document.getElementById('staffEditOtherArea');
        var otherInput = document.getElementById('staffEditOtherName');
        if (sel) {
          sel.innerHTML = '<option value="">追加するスタッフを選択</option>';
          var volList = volunteers || [];
          volList.forEach(function(v) {
            var name = (v.staffName || '').trim();
            var resp = (v.response || '').trim();
            if (name && (resp === '◎' || resp === '△')) {
              var respLabel = resp === '◎' ? ' [対応可]' : ' [条件付]';
              sel.innerHTML += '<option value="' + escapeHtml(name) + '">' + escapeHtml(name) + respLabel + '</option>';
            }
          });
          sel.innerHTML += '<option value="__other__">その他（手入力）</option>';
        }
        if (otherArea) otherArea.style.setProperty('display', 'none', 'important');
        if (otherInput) otherInput.value = '';
        if (sel && !sel.dataset.listen) {
          sel.dataset.listen = '1';
          sel.addEventListener('change', function() {
            if (sel.value === '__other__') {
              if (otherArea) otherArea.style.setProperty('display', 'flex', 'important');
              if (otherInput) otherInput.focus();
            } else {
              if (otherArea) otherArea.style.setProperty('display', 'none', 'important');
            }
          });
        }
        var addBtn = document.getElementById('btnStaffEditAdd');
        if (addBtn && !addBtn.dataset.listen) {
          addBtn.dataset.listen = '1';
          addBtn.onclick = function() {
            var v = (sel && sel.value || '').trim();
            if (!v || v === '__other__') return;
            if (!window._staffEditNames) window._staffEditNames = [];
            if (window._staffEditNames.indexOf(v) >= 0) return;
            window._staffEditNames.push(v);
            renderStaffEditList();
          };
        }
        var addOtherBtn = document.getElementById('btnStaffEditAddOther');
        if (addOtherBtn && !addOtherBtn.dataset.listen) {
          addOtherBtn.dataset.listen = '1';
          addOtherBtn.onclick = function() {
            var v = (otherInput && otherInput.value || '').trim();
            if (!v) return;
            if (!window._staffEditNames) window._staffEditNames = [];
            if (window._staffEditNames.indexOf(v) >= 0) return;
            window._staffEditNames.push(v);
            renderStaffEditList();
            if (otherInput) otherInput.value = '';
          };
        }
        new bootstrap.Modal(document.getElementById('staffEditModal')).show();
      }
      function renderStaffEditList() {
        var list = document.getElementById('staffEditList');
        if (!list) return;
        var names = window._staffEditNames || [];
        list.innerHTML = names.map(function(n, i) {
          return '<div class="d-flex align-items-center gap-2 mb-1"><span class="flex-grow-1">' + escapeHtml(n) + '</span><button type="button" class="btn btn-sm btn-outline-danger py-0" data-index="' + i + '">削除</button></div>';
        }).join('');
        list.querySelectorAll('[data-index]').forEach(function(btn) {
          btn.onclick = function() {
            var i = parseInt(this.getAttribute('data-index'), 10);
            window._staffEditNames.splice(i, 1);
            renderStaffEditList();
          };
        });
      }

      // 清掃担当を保存
      function saveCleaningStaff() {
        const rowNumber = parseInt(document.getElementById('staffEditRowNumber').value, 10);
        const staffName = (window._staffEditNames || []).join(', ');
        const errEl = document.getElementById('staffEditError');

        if (isNaN(rowNumber) || rowNumber < 2) {
          errEl.textContent = '無効な行番号です。';
          errEl.style.display = 'block';
          return;
        }

        document.getElementById('btnSaveStaff').disabled = true;
        errEl.style.display = 'none';

        google.script.run
          .withSuccessHandler(function(jsonStr) {
            try {
              const res = JSON.parse(jsonStr);
              if (res.success) {
                // --- Optimistic cache update: 即座にローカル状態を更新 ---
                var updatedRow = res.rowNumber;
                var updatedStaff = (res.cleaningStaff || '').trim();
                var newStatus = updatedStaff ? 'スタッフ確定済み' : '募集中';

                // recruitFullMap を更新
                if (window._recruitFullMap) {
                  if (window._recruitFullMap[updatedRow]) {
                    window._recruitFullMap[updatedRow].status = newStatus;
                    window._recruitFullMap[updatedRow].staff = updatedStaff;
                    window._recruitFullMap[updatedRow].selectedStaff = updatedStaff;
                  } else {
                    window._recruitFullMap[updatedRow] = { status: newStatus, staff: updatedStaff, selectedStaff: updatedStaff, volunteers: [] };
                  }
                }

                // allBookings の cleaningStaff を更新（同一チェックイン日の重複行も含む）
                if (typeof allBookings !== 'undefined') {
                  var targetCheckIn = null;
                  allBookings.forEach(function(b) { if (b.rowNumber === updatedRow && b.checkInParsed) targetCheckIn = b.checkInParsed; });
                  allBookings.forEach(function(b) {
                    if (b.rowNumber === updatedRow || (targetCheckIn && b.checkInParsed === targetCheckIn)) b.cleaningStaff = updatedStaff;
                  });
                }

                // recruitDates を再構築しカレンダーを即座に再描画
                if (typeof allBookings !== 'undefined' && window._recruitFullMap && calendar) {
                  var staffSetDates = {};
                  allBookings.forEach(function(b) {
                    var rec = window._recruitFullMap[b.rowNumber] || {};
                    var isCnf = (rec.status === '選定済') || (rec.status === 'スタッフ確定済み');
                    var hasDirectStaff = !!(b.cleaningStaff && String(b.cleaningStaff).trim());
                    if ((isCnf || hasDirectStaff) && b.checkOutParsed) {
                      var d2 = new Date(b.checkOutParsed);
                      staffSetDates[d2.getFullYear() + '-' + (d2.getMonth()+1) + '-' + d2.getDate()] = true;
                    }
                  });
                  var recruitDates = {};
                  allBookings.forEach(function(b) {
                    var rec = window._recruitFullMap[b.rowNumber] || {};
                    if ((rec.status || '') === '募集中' && b.checkOutParsed) {
                      var d = new Date(b.checkOutParsed);
                      var key = d.getFullYear() + '-' + (d.getMonth()+1) + '-' + d.getDate();
                      if (!staffSetDates[key]) recruitDates[key] = true;
                    }
                  });
                  window._recruitDates = recruitDates;
                  var evts = buildCalendarEvents(allBookings, window._recruitFullMap);
                  var sources = calendar.getEventSources();
                  sources.forEach(function(s) { s.remove(); });
                  calendar.addEventSource(evts);
                  calendar.render();
                }
                // --- End optimistic update ---

                bootstrap.Modal.getInstance(document.getElementById('staffEditModal')).hide();
                loadAndRender();
                loadRecruitList();
              } else {
                errEl.textContent = res.error || '保存に失敗しました。';
                errEl.style.display = 'block';
              }
            } catch (e) {
              errEl.textContent = 'レスポンスの解析に失敗しました。';
              errEl.style.display = 'block';
            }
            document.getElementById('btnSaveStaff').disabled = false;
          })
          .withFailureHandler(function(err) {
            errEl.textContent = err.message || '通信エラー';
            errEl.style.display = 'block';
            document.getElementById('btnSaveStaff').disabled = false;
          })
          .updateCleaningStaff(rowNumber, staffName);
      }

      function loadAndRender() {
        document.getElementById('loadingOverlay').style.display = 'flex';
        new Promise(function(resolve) {
          google.script.run
            .withSuccessHandler(function(jsonStr) {
              try { resolve(JSON.parse(jsonStr)); }
              catch (e) { resolve({ success: false, error: 'レスポンスの解析に失敗しました。' }); }
            })
            .withFailureHandler(function(err) {
              resolve({ success: false, error: err.message || '通信エラー' });
            })
            .getInitData();
        }).then(function(initResult) {
          document.getElementById('loadingOverlay').style.display = 'none';
          var res = initResult;
          var recruitMap = initResult.recruitMap || {};
          if (!res.success) {
            alert(res.error || 'データの取得に失敗しました。');
            return;
          }
          allBookings = res.data || [];
          // 拡張された recruitMap をグローバルにキャッシュ（nextReservation含む）
          window._recruitFullMap = recruitMap;
          // 先にリセットして古いデータが残らないようにする
          window._recruitDates = {};
          // スタッフ確定済み（募集フロー確定 or 直接割当済み）のチェックアウト日を収集
          var staffSetDates = {};
          (res.data || []).forEach(function(b) {
            var rec = recruitMap[b.rowNumber] || {};
            var isConfirmed = (rec.status === '選定済') || (rec.status === 'スタッフ確定済み');
            var hasDirectStaff = !!(b.cleaningStaff && String(b.cleaningStaff).trim());
            if ((isConfirmed || hasDirectStaff) && b.checkOutParsed) {
              var d2 = new Date(b.checkOutParsed);
              staffSetDates[d2.getFullYear() + '-' + (d2.getMonth()+1) + '-' + d2.getDate()] = true;
            }
          });
          var recruitDates = {};
          (res.data || []).forEach(function(b) {
            var rec = recruitMap[b.rowNumber] || {};
            if ((rec.status || '') === '募集中' && b.checkOutParsed) {
              var d = new Date(b.checkOutParsed);
              var key = d.getFullYear() + '-' + (d.getMonth()+1) + '-' + d.getDate();
              if (!staffSetDates[key]) recruitDates[key] = true;
            }
          });
          window._recruitDates = recruitDates;
          const events = buildCalendarEvents(allBookings, recruitMap);
          if (calendar) {
            const sources = calendar.getEventSources();
            sources.forEach(function(s) { s.remove(); });
            calendar.addEventSource(events);
            calendar.render();
          }
          updateNotificationBanner();

          // 募集エントリのない清掃イベントの次回予約を一括プリロード
          var nonRecruitRows = [];
          (res.data || []).forEach(function(b) {
            if (b.checkOutParsed && !recruitMap[b.rowNumber]) {
              nonRecruitRows.push(b.rowNumber);
            }
          });
          if (nonRecruitRows.length > 0) {
            if (!window._nextResCache) window._nextResCache = {};
            google.script.run.withSuccessHandler(function(j) {
              try {
                var r = JSON.parse(j);
                if (r.success && r.map) {
                  for (var rn in r.map) {
                    window._nextResCache[rn] = r.map[rn];
                  }
                }
              } catch (e) {}
            }).getNextReservationsForRows(nonRecruitRows);
          }
          // ディープリンク: 初期日付が指定されている場合、該当清掃イベントのモーダルを自動で開く
          if (window.initialCleaningDate) {
            var targetDate = window.initialCleaningDate;
            window.initialCleaningDate = ''; // 2回目以降は開かない
            if (window.staffMode && !window.currentUserName && !window.currentUserEmail) {
              // スタッフ未選択の場合は選択後に開く
              window._pendingDeepLinkDate = targetDate;
            } else {
              openCleaningModalByDate(targetDate);
            }
          }
        });
      }

      /**
       * 募集確定時の楽観的キャッシュ更新＋カレンダー即座再描画
       * confirmRecruitment() 成功後に呼び出し、loadAndRender() 完了を待たずにUIを更新する
       */
      function applyConfirmOptimistic(recruitRowIdx, bookingRowNum, staffName) {
        if (!window._recruitFullMap) window._recruitFullMap = {};
        var updated = false;
        // 1. recruitRowIndex で既存エントリを検索して更新
        for (var key in window._recruitFullMap) {
          if (window._recruitFullMap[key].recruitRowIndex === recruitRowIdx) {
            window._recruitFullMap[key].status = 'スタッフ確定済み';
            if (staffName) {
              window._recruitFullMap[key].staff = staffName;
              window._recruitFullMap[key].selectedStaff = staffName;
            }
            updated = true;
            break;
          }
        }
        // 2. 見つからない場合、bookingRowNum で直接エントリを作成/更新
        if (!updated && bookingRowNum) {
          if (window._recruitFullMap[bookingRowNum]) {
            window._recruitFullMap[bookingRowNum].status = 'スタッフ確定済み';
            if (staffName) {
              window._recruitFullMap[bookingRowNum].staff = staffName;
              window._recruitFullMap[bookingRowNum].selectedStaff = staffName;
            }
          } else {
            window._recruitFullMap[bookingRowNum] = {
              status: 'スタッフ確定済み',
              staff: staffName || '',
              selectedStaff: staffName || '',
              volunteers: [],
              recruitRowIndex: recruitRowIdx
            };
          }
        }
        // 3. allBookings の cleaningStaff も更新（マージ行含む）
        if (staffName && typeof allBookings !== 'undefined' && bookingRowNum) {
          var targetCi = null;
          allBookings.forEach(function(b) { if (b.rowNumber === bookingRowNum) targetCi = b.checkInParsed; });
          allBookings.forEach(function(b) {
            if (b.rowNumber === bookingRowNum || (targetCi && b.checkInParsed === targetCi)) {
              b.cleaningStaff = staffName;
            }
          });
        }
        // 4. カレンダーを即座に再描画
        if (typeof allBookings !== 'undefined' && window._recruitFullMap && calendar) {
          var staffSetDates = {};
          allBookings.forEach(function(b) {
            var rec = window._recruitFullMap[b.rowNumber] || {};
            var isCnf = (rec.status === '選定済') || (rec.status === 'スタッフ確定済み');
            var hasDirectStaff = !!(b.cleaningStaff && String(b.cleaningStaff).trim());
            if ((isCnf || hasDirectStaff) && b.checkOutParsed) {
              var d2 = new Date(b.checkOutParsed);
              staffSetDates[d2.getFullYear() + '-' + (d2.getMonth()+1) + '-' + d2.getDate()] = true;
            }
          });
          var recruitDates = {};
          allBookings.forEach(function(b) {
            var rec = window._recruitFullMap[b.rowNumber] || {};
            if ((rec.status || '') === '募集中' && b.checkOutParsed) {
              var d = new Date(b.checkOutParsed);
              var rKey = d.getFullYear() + '-' + (d.getMonth()+1) + '-' + d.getDate();
              if (!staffSetDates[rKey]) recruitDates[rKey] = true;
            }
          });
          window._recruitDates = recruitDates;
          var evts = buildCalendarEvents(allBookings, window._recruitFullMap);
          var sources = calendar.getEventSources();
          sources.forEach(function(s) { s.remove(); });
          calendar.addEventSource(evts);
          calendar.render();
        }
      }

      /**
       * スタッフ確定後の通知UI（メール送信 / テキストコピー）
       */
      function showConfirmationNotifyUI(parentEl, recruitRowIndex, modalId) {
        if (!parentEl) return;
        parentEl.innerHTML = '<div class="alert alert-success py-2 mb-2"><i class="bi bi-check-circle-fill"></i> スタッフを確定しました</div>';
        var btnRow = document.createElement('div');
        btnRow.className = 'd-flex flex-wrap justify-content-center gap-1 mb-2';

        var mailBtn = document.createElement('button');
        mailBtn.type = 'button';
        mailBtn.className = 'btn btn-sm btn-primary';
        mailBtn.textContent = '確定メール送信';
        mailBtn.onclick = function() {
          customConfirm('登録者全員にスタッフ確定メールを送信します。よろしいですか？').then(function(ok) {
            if (!ok) return;
            mailBtn.disabled = true;
            mailBtn.textContent = '送信中...';
            google.script.run.withSuccessHandler(function(j) {
              var res = JSON.parse(j);
              if (res.success) {
                alert('スタッフ確定メールを送信しました。');
                bootstrap.Modal.getInstance(document.getElementById(modalId)).hide();
              } else {
                alert(res.error || '送信に失敗しました');
                mailBtn.disabled = false;
                mailBtn.textContent = '確定メール送信';
              }
            }).withFailureHandler(function(e) {
              alert(e.message || 'エラー');
              mailBtn.disabled = false;
              mailBtn.textContent = '確定メール送信';
            }).notifyStaffConfirmation(recruitRowIndex);
          });
        };

        var copyBtn = document.createElement('button');
        copyBtn.type = 'button';
        copyBtn.className = 'btn btn-sm btn-info text-white';
        copyBtn.textContent = 'テキストコピー';
        copyBtn.onclick = function() {
          copyBtn.disabled = true;
          copyBtn.textContent = '取得中...';
          google.script.run.withSuccessHandler(function(j) {
            var res = JSON.parse(j);
            copyBtn.disabled = false;
            copyBtn.textContent = 'テキストコピー';
            if (res.success && res.copyText) {
              // テキストエリアを表示
              var ta = parentEl.querySelector('.confirm-copy-area');
              if (!ta) {
                var wrap = document.createElement('div');
                wrap.className = 'confirm-copy-area mt-2 p-2 border rounded bg-light';
                wrap.innerHTML = '<p class="small fw-bold mb-1">LINE用テキスト（コピーしてLINEグループに投稿）</p>';
                var textarea = document.createElement('textarea');
                textarea.className = 'form-control font-monospace small mb-2';
                textarea.rows = 10;
                textarea.value = res.copyText;
                wrap.appendChild(textarea);
                var clipBtn = document.createElement('button');
                clipBtn.type = 'button';
                clipBtn.className = 'btn btn-sm btn-primary';
                clipBtn.textContent = 'コピー';
                clipBtn.onclick = function() {
                  if (navigator.clipboard && navigator.clipboard.writeText) {
                    navigator.clipboard.writeText(res.copyText).then(function() {
                      alert('コピーしました。LINEに貼り付けて投稿してください。');
                      bootstrap.Modal.getInstance(document.getElementById(modalId)).hide();
                    }).catch(function() { textarea.select(); document.execCommand('copy'); alert('コピーしました。'); });
                  } else {
                    textarea.select(); document.execCommand('copy'); alert('コピーしました。');
                  }
                };
                wrap.appendChild(clipBtn);
                parentEl.appendChild(wrap);
              }
            } else {
              alert(res.error || 'テキスト取得に失敗しました');
            }
          }).withFailureHandler(function(e) {
            copyBtn.disabled = false;
            copyBtn.textContent = 'テキストコピー';
            alert(e.message || 'エラー');
          }).getConfirmationCopyText(recruitRowIndex);
        };

        var closeBtn = document.createElement('button');
        closeBtn.type = 'button';
        closeBtn.className = 'btn btn-sm btn-outline-secondary';
        closeBtn.textContent = '閉じる';
        closeBtn.onclick = function() {
          bootstrap.Modal.getInstance(document.getElementById(modalId)).hide();
          loadAndRender();
        };

        btnRow.appendChild(mailBtn);
        btnRow.appendChild(copyBtn);
        btnRow.appendChild(closeBtn);
        parentEl.appendChild(btnRow);
      }

      function openCleaningModalByDate(dateStr) {
        if (!calendar || !dateStr) return;
        var events = calendar.getEvents();
        for (var i = 0; i < events.length; i++) {
          var ev = events[i];
          var props = ev.extendedProps;
          if (props && props.type === 'cleaning' && ev.start) {
            var s = ev.start;
            var key = s.getFullYear() + '-' + ('0' + (s.getMonth()+1)).slice(-2) + '-' + ('0' + s.getDate()).slice(-2);
            if (key === dateStr) {
              calendar.gotoDate(s);
              showEventModal(ev);
              return;
            }
          }
        }
      }

      function init() {
        // タブ表示をwindow.staffModeで即時設定（非同期コールバックに依存しない）
        // オーナーURL = staffMode false → オーナータブ表示、スタッフURL = staffMode true → スタッフタブ表示
        if (!window.staffMode) {
          // オーナーモード: オーナータブを表示、スタッフ専用タブを非表示
          window.isOwnerUser = true;
          var ns = document.getElementById('navSettings');
          if (ns) ns.style.display = '';
          var nn = document.getElementById('navNotifications');
          if (nn) nn.style.display = '';
          var nst = document.getElementById('navStaffTest');
          if (nst) nst.style.display = '';
          var nss = document.getElementById('navStaffSchedule');
          if (nss) nss.style.display = 'none';
          var ninv = document.getElementById('navInvoice');
          if (ninv) ninv.style.display = 'none';
          var nr = document.getElementById('navRecruit');
          if (nr) nr.style.display = '';
        } else {
          // スタッフモード: スタッフタブを表示、オーナー専用タブを非表示
          window.isOwnerUser = false;
          var ns2 = document.getElementById('navSettings');
          if (ns2) ns2.style.display = 'none';
          var nn2 = document.getElementById('navNotifications');
          if (nn2) nn2.style.display = 'none';
          var nst2 = document.getElementById('navStaffTest');
          if (nst2) nst2.style.display = 'none';
          var nss2 = document.getElementById('navStaffSchedule');
          if (nss2) nss2.style.display = '';
          var ninv2 = document.getElementById('navInvoice');
          if (ninv2) ninv2.style.display = '';
          var nr2 = document.getElementById('navRecruit');
          if (nr2) nr2.style.display = 'none';
        }
        if (window.staffMode) {
          var bar = document.getElementById('staffSelectorBar');
          if (bar) bar.style.display = 'block';
          var changeBtn = document.getElementById('btnStaffChange');
          if (changeBtn) {
            changeBtn.style.display = '';
            if (!changeBtn.dataset.listen) {
              changeBtn.dataset.listen = '1';
              changeBtn.addEventListener('click', showStaffSelectOverlay);
            }
          }
          var saved = null;
          try { saved = JSON.parse(sessionStorage.getItem('staffSelected') || 'null'); } catch (e) {}
          if (saved && (saved.name || saved.email)) {
            applyStaffSelection(saved.name, saved.email);
            loadStaffSchedule();
            loadInvoiceData();
          } else {
            showStaffSelectOverlay();
          }
        }
        const calendarEl = document.getElementById('calendar');
        var isMobile = window.innerWidth <= 768;
        calendar = new FullCalendar.Calendar(calendarEl, {
          locale: 'ja',
          initialView: 'dayGridMonth',
          headerToolbar: {
            left: 'prev listWeek,dayGridMonth',
            center: 'title',
            right: 'today next'
          },
          buttonText: {
            today: '今日',
            listWeek: '週',
            dayGridMonth: '月'
          },
          height: 'auto',
          contentHeight: isMobile ? 480 : 'auto',
          eventOrder: 'order,start,-duration,allDay,title',
          events: [],
          dayCellClassNames: function(arg) {
            var ds = window._recruitDates || {};
            var d = arg.date;
            var key = d.getFullYear() + '-' + (d.getMonth()+1) + '-' + d.getDate();
            return ds[key] ? ['fc-day-recruiting'] : [];
          },
          eventClick: function(info) {
            info.jsEvent.preventDefault();
            showEventModal(info.event);
          },
          eventDidMount: function(arg) {
            arg.el.style.boxShadow = 'none';
            var main = arg.el.querySelector('.fc-event-main');
            if (main) { main.style.border = 'none'; main.style.boxShadow = 'none'; }
            // スタッフ回答済み/確定済みの赤枠を明示的に設定（CSS !important との競合回避）
            if (arg.el.classList.contains('fc-event-cleaning-selected-by-me')) {
              arg.el.style.border = '3px solid #dc3545';
            } else if (arg.el.classList.contains('fc-event-cleaning-volunteered-by-me')) {
              arg.el.style.border = '3px dashed #dc3545';
            } else {
              arg.el.style.border = 'none';
            }
            var sd = arg.event.extendedProps && arg.event.extendedProps.statusDot;
            var dotColor = sd === 'form-answered' ? '#28a745' : sd === 'form-unanswered' ? '#dc3545' : sd === 'cleaning-recruiting' ? '#dc3545' : sd === 'cleaning-decided' ? '#198754' : null;
            if (dotColor) {
              var dot = document.createElement('span');
              dot.className = 'fc-event-status-dot';
              dot.style.cssText = 'display:inline-block;width:9px;height:9px;border-radius:50%;background:' + dotColor + ';border:1px solid #fff;box-shadow:0 0 0 1px rgba(255,255,255,0.8);margin-right:4px;flex-shrink:0;';
              var titleEl = arg.el.querySelector('.fc-event-title') || arg.el.querySelector('.fc-event-main');
              if (titleEl) {
                if (titleEl.firstChild) titleEl.insertBefore(dot, titleEl.firstChild);
                else titleEl.appendChild(dot);
              }
            }
            // 募集中の清掃イベントがある日付セルの背景を黄色に
            if (sd === 'cleaning-recruiting') {
              var dateStr = arg.event.startStr;
              var dayCell = document.querySelector('.fc-day[data-date="' + dateStr + '"]');
              if (dayCell) dayCell.classList.add('fc-day-recruiting');
            }
          },
          windowResize: function() {}
        });
        calendar.render();

        document.getElementById('btnDeleteBooking').addEventListener('click', function() {
          var row = this.dataset.rowNumber;
          var checkIn = this.dataset.checkIn || '';
          var checkOut = this.dataset.checkOut || '';
          var guestName = this.dataset.guestName || '';
          document.getElementById('deleteBookingConfirmInfo').innerHTML = 'チェックイン: ' + escapeHtml(checkIn) + '<br>チェックアウト: ' + escapeHtml(checkOut) + (guestName ? '<br>宿泊者: ' + escapeHtml(guestName) : '');
          document.getElementById('btnConfirmDeleteBooking').dataset.rowNumber = row;
          bootstrap.Modal.getInstance(document.getElementById('eventModal')).hide();
          new bootstrap.Modal(document.getElementById('deleteBookingConfirmModal')).show();
        });
        document.getElementById('btnConfirmDeleteBooking').addEventListener('click', function() {
          var row = this.dataset.rowNumber;
          bootstrap.Modal.getInstance(document.getElementById('deleteBookingConfirmModal')).hide();
          google.script.run.withSuccessHandler(function(jsonStr) {
            var r = JSON.parse(jsonStr);
            if (r.success) loadAndRender();
            else alert(r.error || '削除に失敗しました。');
          }).withFailureHandler(function(e) { alert(e.message || 'エラー'); }).deleteBooking(row);
        });

        document.getElementById('btnSaveStaff').addEventListener('click', saveCleaningStaff);

        document.getElementById('btnCopyLineText').addEventListener('click', function() {
          var ta = document.getElementById('lineCopyText');
          var text = ta.value || '';
          if (navigator.clipboard && navigator.clipboard.writeText) {
            navigator.clipboard.writeText(text).then(function() { alert('コピーしました。LINEに貼り付けて投稿してください。'); }).catch(function() { ta.select(); document.execCommand('copy'); alert('コピーしました。LINEに貼り付けて投稿してください。'); });
          } else {
            ta.select();
            document.execCommand('copy');
            ta.blur();
            alert('コピーしました。LINEに貼り付けて投稿してください。');
          }
        });

        // タブ切り替え
        document.querySelectorAll('#mainTabs [data-tab]').forEach(function(a) {
          a.addEventListener('click', function(e) {
            e.preventDefault();
            var tab = this.getAttribute('data-tab');
            document.querySelectorAll('#mainTabs .nav-link').forEach(function(l) { l.classList.remove('active'); });
            this.classList.add('active');
            document.getElementById('panelCalendar').style.display = tab === 'calendar' ? 'block' : 'none';
            document.getElementById('panelRecruit').style.display = tab === 'recruit' ? 'block' : 'none';
            document.getElementById('panelStaffSchedule').style.display = tab === 'staffSchedule' ? 'block' : 'none';
            document.getElementById('panelInvoice').style.display = tab === 'invoice' ? 'block' : 'none';
            document.getElementById('panelNotifications').style.display = tab === 'notifications' ? 'block' : 'none';
            document.getElementById('panelSettings').style.display = tab === 'settings' ? 'block' : 'none';
            document.getElementById('panelStaffTest').style.display = tab === 'staffTest' ? 'block' : 'none';
            if (tab === 'calendar') {
              setTimeout(function() { if (calendar) calendar.updateSize(); }, 50);
            }
            if (tab === 'recruit') loadRecruitList();
            if (tab === 'staffSchedule') loadStaffSchedule();
            if (tab === 'invoice') loadInvoiceData();
            if (tab === 'notifications') loadNotificationListMain();
            if (tab === 'settings') loadSettings();
          });
        });


        // オーナー判定＋アカウント切り替えボタン（設定タブ表示・切り替えURL）
        google.script.run.withSuccessHandler(function(jsonStr) {
          try {
            var r = JSON.parse(jsonStr);
            if (r.success) {
              var staffBar = document.getElementById('staffSelectorBar');
              var staffBarVisible = staffBar && staffBar.style.display !== 'none';
              // オーナーURL（ANYONE_ANONYMOUS）ではSession.getActiveUser()が空のためisOwner()がfalseを返す
              // オーナーURLではURLそのものが認証の役割を果たすため、非スタッフモードなら常にオーナーとして扱う
              var effectiveOwner = r.isOwner || (!window.staffMode && !staffBarVisible);
              if (window.staffMode || staffBarVisible) {
                window.isOwnerUser = false;
              } else {
                window.isOwnerUser = effectiveOwner;
              }
              window.ownerNotSet = r.ownerNotSet;
              var showOwnerTabs = effectiveOwner && !staffBarVisible;
              var navSettings = document.getElementById('navSettings');
              if (navSettings) navSettings.style.display = showOwnerTabs ? '' : 'none';
              var navNotif = document.getElementById('navNotifications');
              if (navNotif) navNotif.style.display = showOwnerTabs ? '' : 'none';
              var navStaffTest = document.getElementById('navStaffTest');
              if (navStaffTest) navStaffTest.style.display = showOwnerTabs ? '' : 'none';
              var navStaffSched = document.getElementById('navStaffSchedule');
              if (navStaffSched) navStaffSched.style.display = (window.staffMode || staffBarVisible) ? '' : 'none';
              var navInvoiceTab = document.getElementById('navInvoice');
              if (navInvoiceTab) navInvoiceTab.style.display = (window.staffMode || staffBarVisible) ? '' : 'none';
              var navRecruit = document.getElementById('navRecruit');
              if (navRecruit) navRecruit.style.display = (window.staffMode || staffBarVisible) ? 'none' : '';
              var btnSwitch = document.getElementById('btnAccountSwitch');
              if (btnSwitch && r.switchUrl && effectiveOwner && !window.staffMode) {
                btnSwitch.href = r.switchUrl;
                btnSwitch.textContent = '別のアカウントに切り替える';
                btnSwitch.style.display = '';
              } else if (btnSwitch) btnSwitch.style.display = 'none';
              var addBookingArea = document.getElementById('calendarAddBookingArea');
              if (addBookingArea) addBookingArea.style.display = (effectiveOwner && !window.staffMode) ? '' : 'none';
              updateNotificationBanner();
              var badge = document.getElementById('currentAccountBadge');
              if (badge && r.currentAccountName) {
                badge.textContent = r.currentAccountName;
                badge.style.display = '';
              }
            }
          } catch (e) {}
        }).withFailureHandler(function() {}).getOwnerAndSwitchUrl();

        loadAndRender();

        var bannerLink = document.getElementById('notificationBannerLink');
        if (bannerLink) bannerLink.addEventListener('click', function(e) {
          e.preventDefault();
          document.querySelectorAll('#mainTabs .nav-link').forEach(function(l) { l.classList.remove('active'); });
          var notifTab = document.querySelector('#mainTabs [data-tab="notifications"]');
          if (notifTab) {
            notifTab.classList.add('active');
            document.getElementById('panelCalendar').style.display = 'none';
            document.getElementById('panelRecruit').style.display = 'none';
            if (document.getElementById('panelStaffSchedule')) document.getElementById('panelStaffSchedule').style.display = 'none';
            document.getElementById('panelInvoice').style.display = 'none';
            document.getElementById('panelNotifications').style.display = 'block';
            document.getElementById('panelSettings').style.display = 'none';
            document.getElementById('panelStaffTest').style.display = 'none';
            loadNotificationListMain();
          }
        });
      }

      window.recruitAddSortOrder = window.recruitAddSortOrder || 'desc';
      function loadRecruitList() {
        document.getElementById('loadingOverlay').style.display = 'flex';
        var addBtnArea = document.getElementById('recruitAddBtnArea');
        if (addBtnArea) addBtnArea.style.display = window.isOwnerUser ? '' : 'none';
        var addListArea = document.getElementById('recruitAddListArea');
        var sortOrder = window.recruitAddSortOrder || 'desc';
        google.script.run.withSuccessHandler(function(jsonStr) {
          try {
            var res = JSON.parse(jsonStr);
            var today = new Date().toISOString().slice(0, 10);
            var hidePast = window.hidePastRecruitments !== false;
            var list = (res.success && res.list && res.list.length) ? res.list : [];
            var pastCount = list.filter(function(r) { return (r.checkoutDate || '') < today; }).length;
            var html = '<div class="d-flex justify-content-between align-items-center mb-2 flex-wrap gap-1">';
            html += '<p class="small fw-bold mb-0">募集一覧（タップで' + (window.isOwnerUser ? '内容編集' : '詳細・回答') + '）</p>';
            if (pastCount > 0) {
              html += '<button type="button" class="btn btn-sm btn-outline-secondary" id="btnTogglePastRecruit">' + (hidePast ? '経過済みを表示' : '経過済みを非表示') + '</button>';
            }
            html += '</div>';
            if (list.length) {
              var shownCount = 0;
              list.forEach(function(r) {
                var isPast = (r.checkoutDate || '') < today;
                if (hidePast && isPast) return;
                shownCount++;
                html += '<div class="card mb-2 recruit-card" style="cursor:pointer;" data-row="' + r.rowIndex + '" data-id="' + escapeHtml(r.id) + '" data-date="' + escapeHtml(r.checkoutDate) + '" data-booking="' + r.bookingRowNumber + '" data-status="' + escapeHtml(r.status) + '" data-staff="' + escapeHtml(r.selectedStaff) + '" data-notify="' + escapeHtml(r.notifyMethod || 'メール') + '" data-volunteers="' + escapeHtml(JSON.stringify(r.volunteers || [])) + '" data-reserve-date="' + escapeHtml(r.reserveDate || '') + '" data-reserve-guest="' + escapeHtml(r.reserveGuestCount || '') + '" data-reserve-bbq="' + escapeHtml(r.reserveBBQ || '') + '" data-reserve-nationality="' + escapeHtml(r.reserveNationality || '') + '" data-reserve-bed="' + escapeHtml(r.reserveBedCount || '') + '" data-reserve-memo="' + escapeHtml(r.reserveMemo || '') + '">';
                html += '<div class="card-body py-2">';
                html += '<strong>' + escapeHtml(r.checkoutDate) + '</strong>';
                if (isPast) html += ' <span class="badge bg-secondary">経過済</span>';
                html += ' 予約行' + r.bookingRowNumber + ' ';
                html += (r.status === '選定済' || r.status === 'スタッフ確定済み') ? '<span class="badge bg-success">確定済</span> ' + formatStaffDisplayHtml(r.selectedStaff, r.volunteers) : '<span class="badge bg-warning">募集中</span>';
                html += '<br><small>回答: ' + renderStaffResponses(r.volunteers, true) + '</small>';
                html += '</div></div>';
              });
              if (shownCount === 0) html += '<p class="text-muted small">経過済み以外の案件はありません。</p>';
            } else {
              html += '<p class="text-muted">募集中の案件はありません。</p>';
            }
            document.getElementById('recruitList').innerHTML = html;
            var btnTogglePast = document.getElementById('btnTogglePastRecruit');
            if (btnTogglePast) btnTogglePast.onclick = function() { window.hidePastRecruitments = !window.hidePastRecruitments; loadRecruitList(); };
            document.querySelectorAll('.recruit-card').forEach(function(card) {
              card.addEventListener('click', function() {
                var volStr = this.getAttribute('data-volunteers') || '[]';
                var volunteers = [];
                try { volunteers = JSON.parse(volStr); } catch(e) {}
                var r = {
                  rowIndex: parseInt(this.getAttribute('data-row'), 10),
                  id: this.getAttribute('data-id') || '',
                  checkoutDate: this.getAttribute('data-date') || '',
                  bookingRowNumber: parseInt(this.getAttribute('data-booking'), 10) || 0,
                  status: this.getAttribute('data-status') || '募集中',
                  selectedStaff: this.getAttribute('data-staff') || '',
                  notifyMethod: this.getAttribute('data-notify') || 'メール',
                  volunteers: volunteers,
                  reserveDate: this.getAttribute('data-reserve-date') || '',
                  reserveGuestCount: this.getAttribute('data-reserve-guest') || '',
                  reserveBBQ: this.getAttribute('data-reserve-bbq') || '',
                  reserveNationality: this.getAttribute('data-reserve-nationality') || '',
                  reserveBedCount: this.getAttribute('data-reserve-bed') || '',
                  reserveMemo: this.getAttribute('data-reserve-memo') || '',
                  isNew: false
                };
                openRecruitEditModal(r);
              });
            });
          } catch (e) {
            document.getElementById('recruitList').innerHTML = '<p class="text-danger">読み込みに失敗しました。</p>';
          }
          document.getElementById('loadingOverlay').style.display = 'none';
        }).withFailureHandler(function() {
          document.getElementById('loadingOverlay').style.display = 'none';
        }).getRecruitmentList();
        if (window.isOwnerUser && !window.staffMode) {
        google.script.run.withSuccessHandler(function(addJsonStr) {
          try {
            var addRes = JSON.parse(addJsonStr);
            var addHtml = '';
            if (addRes.success && addRes.list && addRes.list.length && window.isOwnerUser) {
              var addToday = new Date().toISOString().slice(0, 10);
              var addHidePast = window.hidePastAddRecruit !== false;
              var addList = addRes.list;
              var addPastCount = addList.filter(function(b) { return (b.checkoutDate || '') < addToday; }).length;
              addHtml = '<div class="d-flex justify-content-between align-items-center mb-2 flex-wrap gap-1">';
              addHtml += '<p class="small fw-bold mb-0">追加できる予約（タップで内容編集）</p>';
              addHtml += '<div class="d-flex gap-1 align-items-center">';
              if (addPastCount > 0) {
                addHtml += '<button type="button" class="btn btn-sm btn-outline-secondary" id="btnTogglePastAddRecruit">' + (addHidePast ? '経過済みを表示' : '経過済みを非表示') + '</button>';
              }
              addHtml += '<select class="form-select form-select-sm" id="recruitAddSortOrder" style="width:auto;"><option value="desc"' + (sortOrder==='desc'?' selected':'') + '>日付降順</option><option value="asc"' + (sortOrder==='asc'?' selected':'') + '>日付昇順</option></select></div></div>';
              var addShownCount = 0;
              addList.forEach(function(b) {
                var addIsPast = (b.checkoutDate || '') < addToday;
                if (addHidePast && addIsPast) return;
                addShownCount++;
                addHtml += '<div class="card mb-2 recruit-add-card" style="cursor:pointer;" data-row="' + b.rowNumber + '" data-date="' + escapeHtml(b.checkoutDate) + '" data-name="' + escapeHtml(b.guestName || '') + '" data-reserve-date="' + escapeHtml(b.reserveDate || '') + '" data-reserve-guest="' + escapeHtml(b.reserveGuestCount || '') + '" data-reserve-bbq="' + escapeHtml(b.reserveBBQ || '') + '" data-reserve-nationality="' + escapeHtml(b.reserveNationality || '') + '" data-reserve-bed="' + escapeHtml(b.reserveBedCount || '') + '">';
                addHtml += '<div class="card-body py-2"><strong>' + escapeHtml(b.checkoutDate) + '</strong>';
                if (addIsPast) addHtml += ' <span class="badge bg-secondary">経過済</span>';
                addHtml += ' 予約行' + b.rowNumber + ' ' + escapeHtml(b.guestName || '') + '</div></div>';
              });
              if (addShownCount === 0) addHtml += '<p class="text-muted small">経過済み以外の予約はありません。</p>';
            } else if (addRes.success && (!addRes.list || !addRes.list.length) && window.isOwnerUser) {
              addHtml = '<p class="small text-muted mb-2">追加できる予約はありません。</p>';
            }
            if (addListArea) addListArea.innerHTML = addHtml || '';
            var btnTogglePastAdd = document.getElementById('btnTogglePastAddRecruit');
            if (btnTogglePastAdd) btnTogglePastAdd.onclick = function() { window.hidePastAddRecruit = !window.hidePastAddRecruit; loadRecruitList(); };
            var sortEl = document.getElementById('recruitAddSortOrder');
            if (sortEl) sortEl.addEventListener('change', function() { window.recruitAddSortOrder = this.value; loadRecruitList(); });
            document.querySelectorAll('.recruit-add-card').forEach(function(card) {
              card.addEventListener('click', function() {
                var b = {
                  rowNumber: parseInt(this.getAttribute('data-row'), 10),
                  checkoutDate: this.getAttribute('data-date'),
                  guestName: this.getAttribute('data-name'),
                  reserveDate: this.getAttribute('data-reserve-date') || '',
                  reserveGuestCount: this.getAttribute('data-reserve-guest') || '',
                  reserveBBQ: this.getAttribute('data-reserve-bbq') || '',
                  reserveNationality: this.getAttribute('data-reserve-nationality') || ''
                };
                openRecruitEditModal({ bookingRowNumber: b.rowNumber, checkoutDate: b.checkoutDate, isNew: true, reserveDate: b.reserveDate, reserveGuestCount: b.reserveGuestCount, reserveBBQ: b.reserveBBQ, reserveNationality: b.reserveNationality, reserveBedCount: b.reserveBedCount || '' });
              });
            });
          } catch (e) {}
        }).withFailureHandler(function() {}).getBookingsWithoutRecruitment(sortOrder);
        } else {
          if (addListArea) addListArea.innerHTML = '';
        }
        var addRecruitBtn = document.getElementById('btnAddRecruit');
        if (addRecruitBtn && !addRecruitBtn._bound) {
          addRecruitBtn._bound = true;
          addRecruitBtn.addEventListener('click', openAddRecruitModal);
        }
      }

      function loadRecruitListStaffTest() {
        var container = document.getElementById('recruitListStaffTest');
        if (!container) return;
        document.getElementById('loadingOverlay').style.display = 'flex';
        var today = new Date().toISOString().slice(0, 10);
        var hidePast = window.hidePastRecruitments !== false;
        google.script.run.withSuccessHandler(function(jsonStr) {
          try {
            var res = JSON.parse(jsonStr);
            var list = (res.success && res.list && res.list.length) ? res.list : [];
            var pastCount = list.filter(function(r) { return (r.checkoutDate || '') < today; }).length;
            var html = '<div class="d-flex justify-content-between align-items-center mb-2 flex-wrap gap-1">';
            html += '<p class="small fw-bold mb-0">募集一覧（タップで詳細・回答）</p>';
            if (pastCount > 0) {
              html += '<button type="button" class="btn btn-sm btn-outline-secondary" id="btnTogglePastRecruitStaffTest">' + (hidePast ? '経過済みを表示' : '経過済みを非表示') + '</button>';
            }
            html += '</div>';
            if (list.length) {
              var shownCount = 0;
              list.forEach(function(r) {
                var isPast = (r.checkoutDate || '') < today;
                if (hidePast && isPast) return;
                shownCount++;
                html += '<div class="card mb-2 recruit-card-staff-test" style="cursor:pointer;" data-row="' + r.rowIndex + '" data-id="' + escapeHtml(r.id) + '" data-date="' + escapeHtml(r.checkoutDate) + '" data-booking="' + r.bookingRowNumber + '" data-status="' + escapeHtml(r.status) + '" data-staff="' + escapeHtml(r.selectedStaff) + '" data-notify="' + escapeHtml(r.notifyMethod || 'メール') + '" data-volunteers="' + escapeHtml(JSON.stringify(r.volunteers || [])) + '" data-reserve-date="' + escapeHtml(r.reserveDate || '') + '" data-reserve-guest="' + escapeHtml(r.reserveGuestCount || '') + '" data-reserve-bbq="' + escapeHtml(r.reserveBBQ || '') + '" data-reserve-nationality="' + escapeHtml(r.reserveNationality || '') + '" data-reserve-bed="' + escapeHtml(r.reserveBedCount || '') + '" data-reserve-memo="' + escapeHtml(r.reserveMemo || '') + '">';
                html += '<div class="card-body py-2">';
                html += '<strong>' + escapeHtml(r.checkoutDate) + '</strong>';
                if (isPast) html += ' <span class="badge bg-secondary">経過済</span>';
                html += ' 予約行' + r.bookingRowNumber + ' ';
                html += (r.status === '選定済' || r.status === 'スタッフ確定済み') ? '<span class="badge bg-success">確定済</span> ' + formatStaffDisplayHtml(r.selectedStaff, r.volunteers) : '<span class="badge bg-warning">募集中</span>';
                html += '<br><small>回答: ' + renderStaffResponses(r.volunteers, true) + '</small>';
                html += '</div></div>';
              });
              if (shownCount === 0) html += '<p class="text-muted small">経過済み以外の案件はありません。</p>';
            } else {
              html += '<p class="text-muted">募集中の案件はありません。</p>';
            }
            container.innerHTML = html;
            var btnToggle = document.getElementById('btnTogglePastRecruitStaffTest');
            if (btnToggle) btnToggle.onclick = function() { window.hidePastRecruitments = !window.hidePastRecruitments; loadRecruitListStaffTest(); };
            container.querySelectorAll('.recruit-card-staff-test').forEach(function(card) {
              card.addEventListener('click', function() {
                var volStr = this.getAttribute('data-volunteers') || '[]';
                var volunteers = [];
                try { volunteers = JSON.parse(volStr); } catch(e) {}
                var r = {
                  rowIndex: parseInt(this.getAttribute('data-row'), 10),
                  id: this.getAttribute('data-id') || '',
                  checkoutDate: this.getAttribute('data-date') || '',
                  bookingRowNumber: parseInt(this.getAttribute('data-booking'), 10) || 0,
                  status: this.getAttribute('data-status') || '募集中',
                  selectedStaff: this.getAttribute('data-staff') || '',
                  notifyMethod: this.getAttribute('data-notify') || 'メール',
                  volunteers: volunteers,
                  reserveDate: this.getAttribute('data-reserve-date') || '',
                  reserveGuestCount: this.getAttribute('data-reserve-guest') || '',
                  reserveBBQ: this.getAttribute('data-reserve-bbq') || '',
                  reserveNationality: this.getAttribute('data-reserve-nationality') || '',
                  reserveMemo: this.getAttribute('data-reserve-memo') || '',
                  isNew: false,
                  asStaffTest: true
                };
                openRecruitEditModal(r);
              });
            });
          } catch (e) {
            container.innerHTML = '<p class="text-danger">読み込みに失敗しました。</p>';
          }
          document.getElementById('loadingOverlay').style.display = 'none';
        }).withFailureHandler(function() {
          document.getElementById('loadingOverlay').style.display = 'none';
          if (container) container.innerHTML = '<p class="text-danger">読み込みに失敗しました。</p>';
        }).getRecruitmentList();
      }

      function openRecruitEditModal(r) {
        r.isNew = r.isNew || false;
        var lineCopyArea = document.getElementById('recruitEditLineCopyArea');
        if (lineCopyArea) lineCopyArea.style.display = 'none';
        document.getElementById('recruitEditModalTitle').textContent = r.isNew ? '募集内容（新規）' : '募集内容';
        var btnSave = document.getElementById('btnRecruitEditSave');
        if (btnSave) btnSave.textContent = r.isNew ? '募集開始' : '保存';
        document.getElementById('recruitEditCleaningDate').textContent = r.checkoutDate || '－';
        document.getElementById('recruitEditReserveDate').value = r.reserveDate || '';
        document.getElementById('recruitEditReserveGuestCount').value = r.reserveGuestCount || '';
        document.getElementById('recruitEditReserveBBQ').value = r.reserveBBQ || '';
        document.getElementById('recruitEditReserveNationality').value = r.reserveNationality || '';
        document.getElementById('recruitEditReserveMemo').value = r.reserveMemo || '';
        window._recruitEditStaffNames = (r.selectedStaff || r.cleaningStaff || '').split(/[,、]/).map(function(s) { return s.trim(); }).filter(Boolean);
        document.getElementById('recruitEditStatus').innerHTML = ((r.status === '選定済' || r.status === 'スタッフ確定済み') ? 'スタッフ確定済み: ' + formatStaffDisplayHtml(r.selectedStaff || '', r.volunteers) : '募集中');
        document.getElementById('recruitEditVolunteers').innerHTML = '<strong>回答状況:</strong><div class="mt-1">' + renderStaffResponses(r.volunteers) + '</div>';
        document.getElementById('recruitEditError').style.display = 'none';
        var staffBar = document.getElementById('staffSelectorBar');
        var staffBarVisible = staffBar && staffBar.style.display !== 'none';
        var asStaff = r.asStaffTest || !window.isOwnerUser || window.staffMode || staffBarVisible;
        document.querySelectorAll('#recruitEditModal .recruit-edit-owner-only').forEach(function(el) { el.style.display = asStaff ? 'none' : ''; });
        ['recruitEditReserveDate','recruitEditReserveGuestCount','recruitEditReserveBBQ','recruitEditReserveNationality','recruitEditReserveBedCount','recruitEditReserveMemo'].forEach(function(id) {
          var el = document.getElementById(id);
          if (el) el.readOnly = asStaff;
        });
        document.getElementById('btnRecruitEditCancel').style.display = (r.isNew || asStaff ? 'none' : (window.isOwnerUser ? '' : 'none'));
        var selectArea = document.getElementById('recruitEditSelectArea');
        selectArea.style.display = ((r.status === '募集中' || r.status === '選定済' || r.status === 'スタッフ確定済み') && !asStaff && !r.isNew && !r.asStaffTest) ? 'block' : 'none';
        // 確定（募集締切）ボタン: スタッフ選定済み + ステータスが募集中の場合のみ表示
        var confirmArea = document.getElementById('recruitEditConfirmArea');
        var hasStaffSelected = (r.selectedStaff || r.cleaningStaff || '').trim();
        if (confirmArea) {
          var isEditConfirmed = (r.status === 'スタッフ確定済み' || r.status === '選定済');
          confirmArea.style.display = (hasStaffSelected && !isEditConfirmed && !asStaff && !r.isNew) ? 'block' : 'none';
        }
        document.getElementById('btnRecruitEditConfirm').onclick = function() {
          customConfirm('スタッフを確定し、募集を締め切りますか？').then(function(ok) {
            if (!ok) return;
            var btn = document.getElementById('btnRecruitEditConfirm');
            btn.disabled = true;
            btn.textContent = '処理中...';
            google.script.run.withSuccessHandler(function(j) {
              var res = JSON.parse(j);
              if (res.success) {
                applyConfirmOptimistic(r.rowIndex, r.bookingRowNumber || 0, (r.selectedStaff || '').trim());
                loadRecruitList();
                loadAndRender();
                var parentArea = document.getElementById('recruitEditConfirmArea');
                showConfirmationNotifyUI(parentArea, r.rowIndex, 'recruitEditModal');
              } else {
                alert(res.error);
                btn.disabled = false;
                btn.textContent = '確定（募集締切）';
              }
            }).withFailureHandler(function(e) {
              alert(e.message);
              btn.disabled = false;
              btn.textContent = '確定（募集締切）';
            }).confirmRecruitment(r.rowIndex);
          });
        };
        var volunteerArea = document.getElementById('recruitEditVolunteerArea');
        if (volunteerArea) {
          var isConfirmedStatus = (r.status === 'スタッフ確定済み' || r.status === '選定済');
          if (r.status && asStaff && !r.isNew) {
            volunteerArea.style.display = 'block';
            var curName = (window.currentUserName || '').trim().toLowerCase();
            var curEmail = (window.currentUserEmail || '').trim().toLowerCase();
            var myResp = '未回答';
            var myMemo = '';
            if (r.volunteers) r.volunteers.forEach(function(v) {
              if ((v.staffName || '').trim().toLowerCase() === curName || (v.email || '').trim().toLowerCase() === curEmail) {
                myResp = v.response || '未回答';
                myMemo = v.memo || '';
              }
            });
            if (isConfirmedStatus) {
              // スタッフ確定済み: 回答変更不可、変更要請ボタンを表示
              volunteerArea.innerHTML = '<div class="small text-muted mb-2 text-center">スタッフ確定済みのため回答変更はできません</div>' +
                (myResp !== '未回答' ? '<div class="small mb-2 text-center">現在の回答: <strong>' + myResp + '</strong>' + (myMemo ? '（' + escapeHtml(myMemo) + '）' : '') + '</div>' : '') +
                '<div class="mb-2"><label class="form-label small fw-bold">変更後の回答と備考</label><input type="text" class="form-control form-control-sm mb-1" id="recruitEditChangeMemo" placeholder="変更理由を記入"></div>' +
                '<div class="d-flex gap-2 justify-content-center">' +
                '<button type="button" class="btn btn-sm btn-outline-warning fw-bold btn-stacked" data-change-resp="◎"><span class="btn-icon">●</span><span class="btn-label" style="white-space:pre-line;">対応可\n要請</span></button>' +
                '<button type="button" class="btn btn-sm btn-outline-warning fw-bold btn-stacked" data-change-resp="△"><span class="btn-icon">▲</span><span class="btn-label" style="white-space:pre-line;">条件付\n要請</span></button>' +
                '<button type="button" class="btn btn-sm btn-outline-warning fw-bold btn-stacked" data-change-resp="×"><span class="btn-icon">✖</span><span class="btn-label" style="white-space:pre-line;">不可\n要請</span></button>' +
                '</div>';
              volunteerArea.querySelectorAll('[data-change-resp]').forEach(function(btn) {
                btn.onclick = function() {
                  var resp = btn.getAttribute('data-change-resp');
                  var memoEl = document.getElementById('recruitEditChangeMemo');
                  var memoVal = memoEl ? memoEl.value.trim() : '';
                  if (!memoVal) { alert('変更理由を入力してください。'); return; }
                  setButtonLoading(btn, true);
                  google.script.run.withSuccessHandler(function(j) {
                    var res = JSON.parse(j);
                    if (res.success) {
                      alert('回答変更要請を送信しました。オーナーの承認をお待ちください。');
                      bootstrap.Modal.getInstance(document.getElementById('recruitEditModal')).hide();
                      loadAndRender(); loadRecruitList();
                      if (r.asStaffTest) loadRecruitListStaffTest();
                    } else { alert(res.error || '失敗'); setButtonLoading(btn, false); }
                  }).withFailureHandler(function(e) { alert(e.message); setButtonLoading(btn, false); }).requestResponseChange(r.id, window.currentUserName || '', window.currentUserEmail || '', resp, memoVal);
                };
              });
            } else {
              // 募集中: 通常の回答ボタン
              volunteerArea.innerHTML = '<div class="mb-2"><label class="form-label small fw-bold">備考</label><input type="text" class="form-control form-control-sm" id="recruitEditResponseMemo" placeholder="何時からなら対応可能、など" value="' + escapeHtml(myMemo) + '"></div>' +
                (myResp !== '未回答' ? '<div class="small text-muted mb-1 text-center">現在の回答: ' + myResp + '</div>' : '') +
                '<div class="d-flex gap-2 justify-content-center">' +
                '<button type="button" class="btn btn-sm btn-' + (myResp === '◎' ? '' : 'outline-') + 'success fw-bold btn-stacked" data-resp="◎"><span class="btn-icon">●</span><span class="btn-label">対応可</span></button>' +
                '<button type="button" class="btn btn-sm btn-' + (myResp === '△' ? '' : 'outline-') + 'warning fw-bold btn-stacked" data-resp="△"><span class="btn-icon">▲</span><span class="btn-label">条件付</span></button>' +
                '<button type="button" class="btn btn-sm btn-' + (myResp === '×' ? '' : 'outline-') + 'danger fw-bold btn-stacked" data-resp="×"><span class="btn-icon">✖</span><span class="btn-label">不可</span></button>' +
                '</div>';
              volunteerArea.querySelectorAll('[data-resp]').forEach(function(btn) {
                btn.onclick = function() {
                  var resp = btn.getAttribute('data-resp');
                  var memoEl = document.getElementById('recruitEditResponseMemo');
                  var memoVal = memoEl ? memoEl.value.trim() : '';
                  setButtonLoading(btn, true);
                  google.script.run.withSuccessHandler(function(j) {
                    var res = JSON.parse(j);
                    if (res.success) {
                      bootstrap.Modal.getInstance(document.getElementById('recruitEditModal')).hide();
                      loadAndRender(); loadRecruitList();
                      if (r.asStaffTest) loadRecruitListStaffTest();
                    } else { alert(res.error || '失敗'); setButtonLoading(btn, false); }
                  }).withFailureHandler(function(e) { alert(e.message); setButtonLoading(btn, false); }).respondToRecruitment(r.id, window.currentUserName || '', window.currentUserEmail || '', resp, memoVal);
                };
              });
            }
          } else {
            volunteerArea.style.display = 'none';
          }
        }
        window._recruitEditCurrent = r;
        if (!r.isNew) {
          google.script.run.withSuccessHandler(function(jsonStr) {
            try {
              var det = JSON.parse(jsonStr);
              if (det.success) {
                document.getElementById('recruitEditCleaningDate').textContent = det.cleaningDate || '－';
                var nr = det.nextReservation || {};
                if (!r.reserveDate) document.getElementById('recruitEditReserveDate').value = nr.date || '';
                if (!r.reserveGuestCount) document.getElementById('recruitEditReserveGuestCount').value = nr.guestCount || '';
                if (!r.reserveBBQ) document.getElementById('recruitEditReserveBBQ').value = nr.bbq || '';
                if (!r.reserveNationality) document.getElementById('recruitEditReserveNationality').value = nr.nationality || '';
                if (!r.reserveBedCount) document.getElementById('recruitEditReserveBedCount').value = nr.bedCount || '';
                if (!r.reserveMemo) document.getElementById('recruitEditReserveMemo').value = nr.memo || '';
                if (det.cleaningStaff) window._recruitEditStaffNames = (det.cleaningStaff || '').split(/[,、]/).map(function(s) { return s.trim(); }).filter(Boolean);
              }
            } catch (e) {}
          }).getBookingDetailsForRecruit(r.bookingRowNumber, r.rowIndex);
        } else {
          if (r.reserveDate) document.getElementById('recruitEditReserveDate').value = r.reserveDate;
          if (r.reserveGuestCount) document.getElementById('recruitEditReserveGuestCount').value = r.reserveGuestCount;
          if (r.reserveBBQ) document.getElementById('recruitEditReserveBBQ').value = r.reserveBBQ;
          if (r.reserveNationality) document.getElementById('recruitEditReserveNationality').value = r.reserveNationality;
          if (r.reserveBedCount) document.getElementById('recruitEditReserveBedCount').value = r.reserveBedCount;
          google.script.run.withSuccessHandler(function(jsonStr) {
            try {
              var det = JSON.parse(jsonStr);
              if (det.success) {
                document.getElementById('recruitEditCleaningDate').textContent = det.cleaningDate || r.checkoutDate || '－';
                var nr = det.nextReservation || {};
                if (nr.date) document.getElementById('recruitEditReserveDate').value = nr.date;
                if (nr.guestCount) document.getElementById('recruitEditReserveGuestCount').value = nr.guestCount;
                if (nr.bbq) document.getElementById('recruitEditReserveBBQ').value = nr.bbq;
                if (nr.nationality) document.getElementById('recruitEditReserveNationality').value = nr.nationality;
                if (nr.memo) document.getElementById('recruitEditReserveMemo').value = nr.memo;
                if (det.cleaningStaff) window._recruitEditStaffNames = (det.cleaningStaff || '').split(/[,、]/).map(function(s) { return s.trim(); }).filter(Boolean);
              }
            } catch (e) {}
          }).getBookingDetailsForRecruit(r.bookingRowNumber);
        }
        function collectDetail() {
          return {
            date: document.getElementById('recruitEditReserveDate').value.trim(),
            guestCount: document.getElementById('recruitEditReserveGuestCount').value.trim(),
            bbq: document.getElementById('recruitEditReserveBBQ').value.trim(),
            nationality: document.getElementById('recruitEditReserveNationality').value.trim() || '日本',
            bedCount: document.getElementById('recruitEditReserveBedCount').value.trim(),
            memo: document.getElementById('recruitEditReserveMemo').value.trim(),
            cleaningStaff: (window._recruitEditStaffNames || []).join(', '),
            notifyMethod: 'メール'
          };
        }
        var btnSaveEl = document.getElementById('btnRecruitEditSave');
        btnSaveEl.onclick = function() {
          document.getElementById('recruitEditError').style.display = 'none';
          var detail = collectDetail();
          setButtonLoading(btnSaveEl, true);
          if (r.isNew) {
            google.script.run.withSuccessHandler(function(resStr) {
              setButtonLoading(btnSaveEl, false);
              var ok = JSON.parse(resStr);
              if (ok.success && !ok.alreadyExists && ok.rowIndex) {
                var popupArea = document.getElementById('recruitEditLineCopyArea');
                if (popupArea) {
                  popupArea.innerHTML = '<p class="small fw-bold mb-2">スタッフに共有してください</p><button type="button" class="btn btn-sm btn-primary me-1" id="recNewMail">メール送信</button><button type="button" class="btn btn-sm btn-info text-white" id="recNewCopy">テキストコピー</button><div id="recNewCopyArea" class="mt-2" style="display:none;"><p class="small fw-bold mb-1">LINE用テキスト（コピーしてLINEグループに投稿）</p><textarea id="recNewCopyText" class="form-control font-monospace small mb-2" rows="6"></textarea><button type="button" class="btn btn-sm btn-primary" id="recNewCopyBtn">コピー</button></div>';
                  popupArea.style.display = 'block';
                  document.getElementById('recNewMail').onclick = function() {
                    customConfirm('登録者全員に一斉送信します。よろしいですか？').then(function(confirmed) {
                      if (!confirmed) return;
                      google.script.run.withSuccessHandler(function(a) {
                        var ann = JSON.parse(a);
                        if (ann.success) { alert('募集を開始しました。メールで送信しました。'); bootstrap.Modal.getInstance(document.getElementById('recruitEditModal')).hide(); loadRecruitList(); loadAndRender(); }
                        else document.getElementById('recruitEditError').textContent = ann.error || '失敗';
                      }).announceRecruitment(ok.rowIndex);
                    });
                  };
                  document.getElementById('recNewCopy').onclick = function() {
                    google.script.run.withSuccessHandler(function(t) {
                      var jt = JSON.parse(t);
                      if (jt.success && jt.copyText) {
                        var copyArea = document.getElementById('recNewCopyArea');
                        var txtEl = document.getElementById('recNewCopyText');
                        var btnEl = document.getElementById('recNewCopyBtn');
                        if (copyArea) copyArea.style.display = 'block';
                        if (txtEl) txtEl.value = jt.copyText;
                        if (btnEl) btnEl.onclick = function() {
                          if (navigator.clipboard && navigator.clipboard.writeText) navigator.clipboard.writeText(jt.copyText).then(function() { alert('コピーしました。'); }).catch(function() { if (txtEl) { txtEl.select(); document.execCommand('copy'); alert('コピーしました。'); } });
                          else if (txtEl && document.execCommand) { txtEl.select(); document.execCommand('copy'); alert('コピーしました。'); }
                        };
                        alert('募集を開始しました。下記テキストをコピーしてLINEなどで共有してください。');
                      }
                    }).getRecruitmentCopyText(r.checkoutDate, r.bookingRowNumber, detail);
                  };
                } else {
                  bootstrap.Modal.getInstance(document.getElementById('recruitEditModal')).hide();
                  loadRecruitList();
                  loadAndRender();
                }
              } else if (ok.alreadyExists) {
                document.getElementById('recruitEditError').textContent = 'この予約は既に募集済みです。';
                document.getElementById('recruitEditError').style.display = 'block';
              } else {
                document.getElementById('recruitEditError').textContent = ok.error || '失敗';
                document.getElementById('recruitEditError').style.display = 'block';
              }
            }).withFailureHandler(function(err) {
              setButtonLoading(btnSaveEl, false);
              document.getElementById('recruitEditError').textContent = err.message || 'エラー';
              document.getElementById('recruitEditError').style.display = 'block';
            }).saveRecruitmentDetail(null, r.bookingRowNumber, r.checkoutDate, detail);
          } else {
            google.script.run.withSuccessHandler(function(resStr) {
              setButtonLoading(btnSaveEl, false);
              var ok = JSON.parse(resStr);
              if (ok.success) {
                alert('保存しました。');
                bootstrap.Modal.getInstance(document.getElementById('recruitEditModal')).hide();
                loadRecruitList();
                loadAndRender();
              } else {
                document.getElementById('recruitEditError').textContent = ok.error || '失敗';
                document.getElementById('recruitEditError').style.display = 'block';
              }
            }).withFailureHandler(function(err) {
              setButtonLoading(btnSaveEl, false);
              document.getElementById('recruitEditError').textContent = err.message || 'エラー';
              document.getElementById('recruitEditError').style.display = 'block';
            }).saveRecruitmentDetail(r.rowIndex, r.bookingRowNumber, r.checkoutDate, detail);
          }
        };
        var btnMailEl = document.getElementById('btnRecruitEditMail');
        btnMailEl.onclick = function() {
          customConfirm('登録者全員に一斉送信します。よろしいですか？').then(function(ok) {
            if (!ok) return;
            document.getElementById('recruitEditError').style.display = 'none';
            var detail = collectDetail();
            detail.notifyMethod = 'メール';
            setButtonLoading(btnMailEl, true);
            function doAnnounce(rowIdx) {
              google.script.run.withSuccessHandler(function(annStr) {
                setButtonLoading(btnMailEl, false);
                var ann = JSON.parse(annStr);
                if (ann.success) {
                  alert('メールで送信しました。');
                  bootstrap.Modal.getInstance(document.getElementById('recruitEditModal')).hide();
                  loadRecruitList();
                } else {
                  document.getElementById('recruitEditError').textContent = ann.error || '失敗';
                  document.getElementById('recruitEditError').style.display = 'block';
                }
              }).withFailureHandler(function(err) {
                setButtonLoading(btnMailEl, false);
                document.getElementById('recruitEditError').textContent = err.message || 'エラー';
                document.getElementById('recruitEditError').style.display = 'block';
              }).announceRecruitment(rowIdx);
            }
            if (r.isNew) {
              google.script.run.withSuccessHandler(function(resStr) {
                var res = JSON.parse(resStr);
                if (res.success && res.rowIndex) {
                  if (res.alreadyExists) {
                    google.script.run.withSuccessHandler(function() { doAnnounce(res.rowIndex); }).saveRecruitmentDetail(res.rowIndex, r.bookingRowNumber, r.checkoutDate, detail);
                  } else {
                    doAnnounce(res.rowIndex);
                  }
                }
              }).saveRecruitmentDetail(null, r.bookingRowNumber, r.checkoutDate, detail);
            } else {
              google.script.run.withSuccessHandler(function(resStr) {
                var res = JSON.parse(resStr);
                if (res.success) doAnnounce(r.rowIndex);
              }).saveRecruitmentDetail(r.rowIndex, r.bookingRowNumber, r.checkoutDate, detail);
            }
          });
        };
        document.getElementById('btnRecruitEditCopy').onclick = function() {
          document.getElementById('recruitEditError').style.display = 'none';
          var lineArea = document.getElementById('recruitEditLineCopyArea');
          var detail = collectDetail();
          var nextRes = { date: detail.date, guestCount: detail.guestCount, bbq: detail.bbq, nationality: detail.nationality, memo: detail.memo };
          function showCopyText(copyText) {
            var txtEl = document.getElementById('recruitEditLineCopyText');
            var btnEl = document.getElementById('btnRecruitEditCopyToClipboard');
            if (txtEl) txtEl.value = copyText;
            if (lineArea) lineArea.style.display = 'block';
            if (lineArea) lineArea.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            function doCopy() {
              if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(copyText).catch(function() {});
              } else if (txtEl && document.execCommand) {
                txtEl.select();
                document.execCommand('copy');
              }
            }
            doCopy();
            if (btnEl) btnEl.onclick = function() { doCopy(); };
          }
          google.script.run.withSuccessHandler(function(txtStr) {
            var j = JSON.parse(txtStr);
            if (j.success && j.copyText) showCopyText(j.copyText);
          }).getRecruitmentCopyText(r.checkoutDate, r.bookingRowNumber, nextRes);
        };
        var btnCancelEl = document.getElementById('btnRecruitEditCancel');
        btnCancelEl.onclick = function() {
          if (!r.isNew && r.rowIndex) {
            var volCount = r.volunteers && r.volunteers.length ? r.volunteers.length : 0;
            var msg = volCount > 0 ? '回答済みスタッフが' + volCount + '名います。募集を取消しますか？' : '募集を取消しますか？';
            customConfirm(msg).then(function(ok) {
              if (!ok) return;
              setButtonLoading(btnCancelEl, true);
              google.script.run.withSuccessHandler(function(resStr) {
                setButtonLoading(btnCancelEl, false);
                var res = JSON.parse(resStr);
                if (res.success) {
                  bootstrap.Modal.getInstance(document.getElementById('recruitEditModal')).hide();
                  loadRecruitList();
                  loadAndRender();
                } else alert(res.error || '失敗');
              }).withFailureHandler(function(err) {
                setButtonLoading(btnCancelEl, false);
                alert(err.message || 'エラー');
              }).deleteRecruitment(r.rowIndex);
            });
            return;
          }
          if (r.isNew) {
            bootstrap.Modal.getInstance(document.getElementById('recruitEditModal')).hide();
          }
        };
        document.getElementById('btnRecruitEditSelect').onclick = function() {
          bootstrap.Modal.getInstance(document.getElementById('recruitEditModal')).hide();
          openRecruitSelectModal(r);
        };
        new bootstrap.Modal(document.getElementById('recruitEditModal')).show();
      }

      function openRecruitSelectModal(r) {
        var volList = (r.volunteers || []);
        document.getElementById('recruitSelectRowIndex').value = r.rowIndex;
        window._recruitSelectBookingRow = r.bookingRowNumber || 0;
        document.getElementById('recruitSelectModalTitle').textContent = '清掃担当を選定';
        document.getElementById('recruitSelectDate').textContent = 'チェックアウト日: ' + (r.checkoutDate || '');
        window._recruitSelectStaffNames = (r.selectedStaff || '').split(/[,、]/).map(function(s) { return s.trim(); }).filter(Boolean);
        document.getElementById('recruitSelectStaffList').innerHTML = '';
        document.getElementById('recruitSelectError').style.display = 'none';
        var sel = document.getElementById('recruitSelectStaffDropdown');
        sel.innerHTML = '<option value="">スタッフを選択</option>';
        volList.forEach(function(v) {
          var name = (v.staffName || v.email || '').trim();
          var resp = (v.response || '').trim();
          if (name && (resp === '◎' || resp === '△')) {
            var respLabel = resp === '◎' ? ' [対応可]' : ' [条件付]';
            sel.innerHTML += '<option value="' + escapeHtml(name) + '">' + escapeHtml(name) + respLabel + '</option>';
          }
        });
        sel.innerHTML += '<option value="__other__">その他（手入力）</option>';
        var rsOtherArea = document.getElementById('recruitSelectOtherArea');
        var rsOtherInput = document.getElementById('recruitSelectOtherName');
        if (rsOtherArea) rsOtherArea.style.setProperty('display', 'none', 'important');
        if (rsOtherInput) rsOtherInput.value = '';
        if (!sel.dataset.listen) {
          sel.dataset.listen = '1';
          sel.addEventListener('change', function() {
            if (sel.value === '__other__') {
              if (rsOtherArea) rsOtherArea.style.setProperty('display', 'flex', 'important');
              if (rsOtherInput) rsOtherInput.focus();
            } else {
              if (rsOtherArea) rsOtherArea.style.setProperty('display', 'none', 'important');
            }
          });
        }
        renderRecruitSelectStaffList();
        new bootstrap.Modal(document.getElementById('recruitSelectModal')).show();
      }

      function renderRecruitSelectStaffList() {
        var list = document.getElementById('recruitSelectStaffList');
        var names = window._recruitSelectStaffNames || [];
        list.innerHTML = names.map(function(n, i) {
          return '<span class="badge bg-secondary me-1 mb-1 d-inline-flex align-items-center">' + escapeHtml(n) + ' <button type="button" class="btn btn-link btn-sm p-0 ms-1 text-white" data-index="' + i + '" style="font-size:0.9em;">×</button></span>';
        }).join('');
        list.querySelectorAll('[data-index]').forEach(function(btn) {
          btn.addEventListener('click', function() {
            var i = parseInt(this.getAttribute('data-index'), 10);
            window._recruitSelectStaffNames.splice(i, 1);
            renderRecruitSelectStaffList();
          });
        });
      }

      function openAddRecruitModal() {
        document.getElementById('addRecruitBookingsList').innerHTML = '';
        document.getElementById('addRecruitEmpty').style.display = 'none';
        document.getElementById('addRecruitError').style.display = 'none';
        document.getElementById('loadingOverlay').style.display = 'flex';
        google.script.run.withSuccessHandler(function(jsonStr) {
          try {
            var res = JSON.parse(jsonStr);
            var listEl = document.getElementById('addRecruitBookingsList');
            var emptyEl = document.getElementById('addRecruitEmpty');
            if (res.success && res.list && res.list.length) {
              res.list.forEach(function(b) {
                var div = document.createElement('div');
                div.className = 'border rounded p-2 mb-2';
                div.innerHTML = '<strong>' + escapeHtml(b.checkoutDate) + '</strong> 予約行' + b.rowNumber + ' ' + escapeHtml(b.guestName || '') + ' <button type="button" class="btn btn-sm btn-primary ms-2 btnAddRecruitItem" data-row="' + b.rowNumber + '" data-date="' + escapeHtml(b.checkoutDate) + '" data-reserve-date="' + escapeHtml(b.reserveDate || '') + '" data-reserve-guest="' + escapeHtml(b.reserveGuestCount || '') + '" data-reserve-bbq="' + escapeHtml(b.reserveBBQ || '') + '" data-reserve-nationality="' + escapeHtml(b.reserveNationality || '') + '">追加</button>';
                listEl.appendChild(div);
              });
              listEl.querySelectorAll('.btnAddRecruitItem').forEach(function(btn) {
                btn.addEventListener('click', function() {
                  bootstrap.Modal.getInstance(document.getElementById('addRecruitModal')).hide();
                  openRecruitEditModal({
                    bookingRowNumber: parseInt(this.getAttribute('data-row'), 10),
                    checkoutDate: this.getAttribute('data-date'),
                    isNew: true,
                    reserveDate: this.getAttribute('data-reserve-date') || '',
                    reserveGuestCount: this.getAttribute('data-reserve-guest') || '',
                    reserveBBQ: this.getAttribute('data-reserve-bbq') || '',
                    reserveNationality: this.getAttribute('data-reserve-nationality') || ''
                  });
                });
              });
              emptyEl.style.display = 'none';
            } else {
              listEl.innerHTML = '';
              emptyEl.style.display = 'block';
            }
          } catch (e) {
            document.getElementById('addRecruitError').textContent = e.message || '読み込みに失敗しました。';
            document.getElementById('addRecruitError').style.display = 'block';
          }
          document.getElementById('loadingOverlay').style.display = 'none';
        }).withFailureHandler(function(err) {
          document.getElementById('addRecruitError').textContent = err.message || 'エラー';
          document.getElementById('addRecruitError').style.display = 'block';
          document.getElementById('loadingOverlay').style.display = 'none';
        }).getBookingsWithoutRecruitment();
        new bootstrap.Modal(document.getElementById('addRecruitModal')).show();
      }

      function addRecruitmentManually(rowNumber, checkoutDate) {
        document.getElementById('addRecruitError').style.display = 'none';
        google.script.run.withSuccessHandler(function(jsonStr) {
          try {
            var r = JSON.parse(jsonStr);
            if (r.success) {
              bootstrap.Modal.getInstance(document.getElementById('addRecruitModal')).hide();
              loadRecruitList();
              loadAndRender();
              if (r.alreadyExists) {
                alert('この予約は既に募集済みです。');
              } else {
                alert('募集を追加しました。一覧でタップして告知方法を選び送信してください。');
              }
            } else {
              document.getElementById('addRecruitError').textContent = r.error || '失敗';
              document.getElementById('addRecruitError').style.display = 'block';
            }
          } catch (e) {
            document.getElementById('addRecruitError').textContent = 'エラー';
            document.getElementById('addRecruitError').style.display = 'block';
          }
        }).withFailureHandler(function(err) {
          document.getElementById('addRecruitError').textContent = err.message || 'エラー';
          document.getElementById('addRecruitError').style.display = 'block';
        }).addRecruitmentManually(rowNumber, checkoutDate);
      }

      // 旧互換: volunteer() → respondToRecruitment('◎')
      function volunteer(recruitId, memoToSend) {
        var nameToSend = window.currentUserName || '';
        var emailToSend = window.currentUserEmail || '';
        if (!nameToSend && !emailToSend) {
          alert('回答するには、お名前を選択するかログインしてください。');
          return;
        }
        var memo = (memoToSend != null) ? String(memoToSend).trim() : '';
        google.script.run.withSuccessHandler(function(jsonStr) {
          try {
            var r = JSON.parse(jsonStr);
            if (r.success) { loadRecruitList(); loadAndRender(); }
            else alert(r.error || '失敗しました。');
          } catch (e) { alert('エラー'); }
        }).withFailureHandler(function(err) { alert(err.message || 'エラー'); }).respondToRecruitment(recruitId, nameToSend, emailToSend, '◎', memo);
      }

      function loadSyncList() {
        var _syncList = document.getElementById('syncList');
        if (_syncList) _syncList.innerHTML = '<div class="text-center py-2"><span class="spinner-border spinner-border-sm text-primary"></span><span class="text-muted small ms-2">読み込み中…</span></div>';
        google.script.run.withSuccessHandler(function(jsonStr) {
          try {
            var res = JSON.parse(jsonStr);
            var html = '';
            if (res.success && res.list && res.list.length) {
              res.list.forEach(function(s) {
                html += '<div class="border rounded p-2 mb-2"><div class="d-flex justify-content-between align-items-start">';
                html += '<div><strong>' + escapeHtml(s.platformName) + '</strong><br><small class="text-muted">' + escapeHtml(s.icalUrl || '(未設定)') + '</small>';
                if (s.lastSync) html += '<br><small class="text-success">' + escapeHtml(s.lastSync) + '</small>';
                html += '</div>';
                html += '<div><button type="button" class="btn btn-sm btn-outline-secondary btnEditSync" data-row="' + s.rowIndex + '" data-name="' + escapeHtml(s.platformName) + '" data-url="' + escapeHtml(s.icalUrl) + '">編集</button> ';
                html += '<button type="button" class="btn btn-sm btn-outline-danger btnDelSync" data-row="' + s.rowIndex + '">削除</button></div></div></div>';
              });
            } else {
              html = '<p class="text-muted small">連携がありません。「連携を追加」でiCal URLを登録してください。</p>';
            }
            document.getElementById('syncList').innerHTML = html;
            document.getElementById('syncResult').style.display = 'none';
            document.querySelectorAll('.btnEditSync').forEach(function(btn) {
              btn.addEventListener('click', function() {
                var row = parseInt(this.getAttribute('data-row'), 10);
                var name = this.getAttribute('data-name');
                var url = this.getAttribute('data-url');
                openSyncFormModal(row, name, url);
              });
            });
            document.querySelectorAll('.btnDelSync').forEach(function(btn) {
              btn.addEventListener('click', function() {
                var row = parseInt(this.getAttribute('data-row'), 10);
                customConfirm('この連携を削除しますか？').then(function(ok) {
                  if (!ok) return;
                  google.script.run.withSuccessHandler(function(j) {
                    var r = JSON.parse(j);
                    if (r.success) loadSyncList(); else alert(r.error);
                  }).withFailureHandler(function(e) { alert(e.message); }).deleteSyncSetting(row);
                });
              });
            });
          } catch (e) { document.getElementById('syncList').innerHTML = '<p class="text-danger">読み込み失敗</p>'; }
        }).withFailureHandler(function() { document.getElementById('syncList').innerHTML = '<p class="text-danger">エラー</p>'; }).getSyncSettings();
      }

      function formatNotificationDate(atStr) {
        if (!atStr || typeof atStr !== 'string') return atStr || '';
        var m = atStr.match(/(\d{4})-(\d{1,2})-(\d{1,2})[T\s]+(\d{1,2}):(\d{1,2})/);
        if (!m) {
          var d = new Date(atStr);
          if (!isNaN(d.getTime())) {
            return d.getFullYear() + '/' + (d.getMonth()+1) + '/' + d.getDate() + ' ' + d.getHours() + ':' + String(d.getMinutes()).padStart(2,'0');
          }
          return atStr;
        }
        return m[1] + '/' + parseInt(m[2],10) + '/' + parseInt(m[3],10) + ' ' + parseInt(m[4],10) + ':' + m[5].padStart(2,'0');
      }
      function loadNotificationList() {
        var _notifList = document.getElementById('notificationList');
        if (_notifList) _notifList.innerHTML = '<div class="text-center py-2"><span class="spinner-border spinner-border-sm text-primary"></span><span class="text-muted small ms-2">読み込み中…</span></div>';
        var el = document.getElementById('notificationList');
        if (!el) return;
        google.script.run.withSuccessHandler(function(jsonStr) {
          try {
            var r = JSON.parse(jsonStr);
            if (r.success && r.list && r.list.length) {
              var html = r.list.map(function(n, idx) {
                var kindClass = (n.kind === '回答') ? 'primary' : (n.kind === '回答取消') ? 'warning' : (n.kind === '予約追加') ? 'success' : (n.kind === '予約削除') ? 'danger' : (n.kind === '予約キャンセル') ? 'danger' : (n.kind === '予約復活') ? 'success' : (n.kind === '出勤キャンセル要望') ? 'danger' : (n.kind === 'キャンセル承認') ? 'info' : (n.kind === 'キャンセル却下') ? 'secondary' : 'secondary';
                var actionHtml = '';
                if (!isStaffMode && n.kind === '出勤キャンセル要望' && n.data && n.data.recruitRowIndex) {
                  actionHtml = '<div class="mt-1"><button class="btn btn-sm btn-warning me-1 notif-approve" data-idx="' + idx + '">承認</button><button class="btn btn-sm btn-outline-secondary notif-reject" data-idx="' + idx + '">却下</button></div>';
                }
                return '<div class="border rounded p-2 mb-2 small" data-notif-idx="' + idx + '"><span class="badge bg-' + kindClass + ' me-2">' + escapeHtml(n.kind) + '</span><span class="text-muted">' + escapeHtml(formatNotificationDate(n.at)) + '</span> ' + escapeHtml(n.message) + actionHtml + '</div>';
              }).join('');
              el.innerHTML = html;
              // キャンセル承認/却下ボタンのイベント
              var notifList = r.list;
              el.querySelectorAll('.notif-approve').forEach(function(btn) {
                btn.onclick = function() {
                  var ni = parseInt(this.getAttribute('data-idx'), 10);
                  var nd = notifList[ni] && notifList[ni].data;
                  if (!nd) return;
                  var thisBtn = this;
                  customConfirm(nd.staffName + ' の取り消しを承認しますか？\n\n承認すると清掃担当が解除され、再度募集状態に戻ります。').then(function(ok) {
                    if (!ok) return;
                    thisBtn.disabled = true; thisBtn.textContent = '処理中...';
                    var actionDiv = thisBtn.closest('.mt-1');
                    google.script.run.withSuccessHandler(function(j) {
                      var res = JSON.parse(j);
                      if (res.success) { if (actionDiv) actionDiv.innerHTML = '<span class="badge bg-info">承認済</span>'; loadAndRender(); }
                      else { alert(res.error || '失敗'); thisBtn.disabled = false; thisBtn.textContent = '承認'; }
                    }).withFailureHandler(function(e) { alert(e.message); thisBtn.disabled = false; thisBtn.textContent = '承認'; }).approveCancelRequest(nd.recruitRowIndex, nd.staffName, nd.staffEmail);
                  });
                };
              });
              el.querySelectorAll('.notif-reject').forEach(function(btn) {
                btn.onclick = function() {
                  var ni = parseInt(this.getAttribute('data-idx'), 10);
                  var nd = notifList[ni] && notifList[ni].data;
                  if (!nd) return;
                  var thisBtn = this;
                  customConfirm(nd.staffName + ' の取り消し申請を却下しますか？').then(function(ok) {
                    if (!ok) return;
                    thisBtn.disabled = true; thisBtn.textContent = '処理中...';
                    var actionDiv = thisBtn.closest('.mt-1');
                    google.script.run.withSuccessHandler(function(j) {
                      var res = JSON.parse(j);
                      if (res.success) { if (actionDiv) actionDiv.innerHTML = '<span class="badge bg-secondary">却下済</span>'; loadAndRender(); }
                      else { alert(res.error || '失敗'); thisBtn.disabled = false; thisBtn.textContent = '却下'; }
                    }).withFailureHandler(function(e) { alert(e.message); thisBtn.disabled = false; thisBtn.textContent = '却下'; }).rejectCancelRequest(nd.recruitRowIndex, nd.staffName, nd.staffEmail);
                  });
                };
              });
            } else {
              el.innerHTML = '<p class="text-muted small">通知はまだありません。</p>';
            }
          } catch (e) { el.innerHTML = '<p class="text-danger small">読み込み失敗</p>'; }
        }).withFailureHandler(function() { if (el) el.innerHTML = '<p class="text-danger small">エラー</p>'; }).getNotifications();
      }
      function loadStaffSchedule() {
        var el = document.getElementById('staffScheduleList');
        var monthInp = document.getElementById('staffScheduleMonth');
        if (!el) return;
        if (monthInp && !monthInp.dataset.init) {
          monthInp.dataset.init = '1';
          var d = new Date();
          monthInp.value = d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0');
          monthInp.addEventListener('change', function() { loadStaffSchedule(); });
        }
        var staffId = (window.currentUserName || window.currentUserEmail || '').trim();
        if (!staffId) {
          el.innerHTML = '<p class="text-muted small">スタッフを選択してください。</p>';
          return;
        }
        var ym = monthInp && monthInp.value ? monthInp.value : (function() {
          var d = new Date();
          return d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0');
        })();
        el.innerHTML = '<div class="text-center py-3"><div class="spinner-border spinner-border-sm text-primary" role="status"></div><span class="text-muted small ms-2">読み込み中…</span></div>';
        google.script.run.withSuccessHandler(function(jsonStr) {
          try {
            var r = JSON.parse(jsonStr);
            if (r.success && r.list && r.list.length) {
              var myName = (window.currentUserName || '').trim();
              el.innerHTML = r.list.map(function(item) {
                var isConfirmed = item.confirmed !== false;
                var partnersHtml = '';
                var selfHtml = '';
                var statusHtml = '';
                if (isConfirmed) {
                  partnersHtml = (item.partners || []).length ? '<span class="text-muted">' + item.partners.map(function(p) { return escapeHtml(p); }).join('、') + '</span>、' : '';
                  selfHtml = '<span class="fw-bold">' + escapeHtml(myName || 'あなた') + '</span>';
                  statusHtml = item.cancelPending ? ' <span class="badge bg-warning text-dark">申請中</span>' : ' <span class="badge bg-success">確定</span>';
                } else {
                  var volLabel = item.volunteerStatus === '◎' ? '対応可' : '条件付';
                  var volBadgeClass = item.volunteerStatus === '◎' ? 'bg-info text-dark' : 'bg-secondary';
                  statusHtml = ' <span class="badge ' + volBadgeClass + '">' + escapeHtml(item.volunteerStatus) + ' ' + volLabel + '</span>';
                }
                var btnHtml = '<button type="button" class="btn btn-sm btn-outline-primary py-0 flex-shrink-0 btn-open-cleaning" data-row="' + item.rowNumber + '" data-checkout="' + escapeHtml(item.checkoutDate || '') + '" data-recruit-row="' + (item.recruitRowIndex || 0) + '">詳細</button>';
                var borderClass = isConfirmed ? 'border' : 'border border-dashed';
                var bgStyle = isConfirmed ? '' : ' style="background:#f8f9fa;"';
                return '<div class="' + borderClass + ' rounded p-2 mb-2 small d-flex justify-content-between align-items-center gap-2"' + bgStyle + '><div><strong>' + escapeHtml(item.checkoutDisplay) + '</strong> ' + partnersHtml + selfHtml + statusHtml + '</div>' + btnHtml + '</div>';
              }).join('');
              el.querySelectorAll('.btn-open-cleaning').forEach(function(btn) {
                btn.onclick = function() {
                  var rowNum = parseInt(this.getAttribute('data-row'), 10);
                  var checkout = this.getAttribute('data-checkout');
                  if (calendar) {
                    // まず行番号で検索
                    var calEvent = rowNum ? calendar.getEventById('c-' + rowNum) : null;
                    // 行番号で見つからない場合、日付で清掃イベントを検索
                    if (!calEvent && checkout) {
                      var allEvents = calendar.getEvents();
                      for (var ei = 0; ei < allEvents.length; ei++) {
                        var ev = allEvents[ei];
                        if (ev.id && ev.id.indexOf('c-') === 0 && ev.startStr === checkout) {
                          calEvent = ev;
                          break;
                        }
                      }
                    }
                    if (calEvent) {
                      if (checkout) calendar.gotoDate(checkout);
                      showEventModal(calEvent);
                      return;
                    }
                  }
                  alert('カレンダーにこの清掃データが見つかりません。カレンダータブから直接お探しください。');
                };
              });
            } else {
              el.innerHTML = '<p class="text-muted small">' + ym + ' の出勤予定・回答済みの予定はありません。</p>';
            }
          } catch (e) { el.innerHTML = '<p class="text-danger small">読み込み失敗</p>'; }
        }).withFailureHandler(function() { el.innerHTML = '<p class="text-danger small">エラー</p>'; }).getStaffSchedule(staffId, ym);
      }
      function loadNotificationListMain() {
        var el = document.getElementById('notificationListMain');
        if (!el) return;
        var clearListBtn = document.getElementById('btnClearAllNotifList');
        if (clearListBtn) {
          clearListBtn.onclick = function() {
            customConfirm('全ての通知を削除しますか？').then(function(ok) {
              if (!ok) return;
              clearListBtn.disabled = true;
              clearListBtn.textContent = '削除中...';
              google.script.run.withSuccessHandler(function(j) {
                var res = JSON.parse(j);
                clearListBtn.disabled = false;
                clearListBtn.textContent = '一括削除';
                if (res.success) { loadNotificationListMain(); updateNotificationBanner(); }
              }).withFailureHandler(function() { clearListBtn.disabled = false; clearListBtn.textContent = '一括削除'; }).clearAllNotifications();
            });
          };
        }
        google.script.run.withSuccessHandler(function(jsonStr) {
          try {
            var r = JSON.parse(jsonStr);
            if (r.success && r.list && r.list.length) {
              var notifItems = r.list;
              // スタッフモード: 自分が行ったアクションの通知を除外
              if (window.staffMode) {
                var myNameNotif = (window.currentUserName || '').trim();
                var selfKinds = ['回答', '回答取消', '出勤キャンセル要望', '保留', '回答変更要請'];
                if (myNameNotif) {
                  notifItems = notifItems.filter(function(n) {
                    return !(selfKinds.indexOf(n.kind) >= 0 && (n.message || '').indexOf(myNameNotif + ' が') === 0);
                  });
                }
              }
              if (!notifItems.length) { el.innerHTML = '<p class="text-muted small">通知はまだありません。</p>'; return; }
              var html = notifItems.map(function(n) {
                var kindClass = (n.kind === '回答') ? 'primary' : (n.kind === '回答取消') ? 'warning' : (n.kind === '予約追加') ? 'success' : (n.kind === '予約削除') ? 'danger' : 'secondary';
                var readBtn = n.read ? '' : '<button type="button" class="btn btn-sm btn-outline-secondary py-0 flex-shrink-0 btn-notif-read" data-row="' + n.rowIndex + '">既読</button>';
                return '<div class="border rounded p-2 mb-2 small d-flex justify-content-between align-items-center gap-2"><div><span class="badge bg-' + kindClass + ' me-2">' + escapeHtml(n.kind) + '</span><span class="text-muted">' + escapeHtml(formatNotificationDate(n.at)) + '</span>\u3000' + escapeHtml(n.message) + '</div>' + readBtn + '</div>';
              }).join('');
              el.innerHTML = html;
              el.querySelectorAll('.btn-notif-read').forEach(function(btn) {
                btn.onclick = function() {
                  var row = parseInt(this.getAttribute('data-row'), 10);
                  google.script.run.withSuccessHandler(function(j) {
                    var res = JSON.parse(j);
                    if (res.success) { loadNotificationListMain(); updateNotificationBanner(); }
                  }).withFailureHandler(function() {}).markNotificationAsRead(row);
                };
              });
            } else {
              var errMsg = (r && r.error) ? '<p class="text-danger small">エラー: ' + escapeHtml(r.error) + '</p>' : '<p class="text-muted small">通知はまだありません。</p>';
              el.innerHTML = errMsg;
            }
          } catch (e) { el.innerHTML = '<p class="text-danger small">読み込み失敗: ' + escapeHtml(String(e)) + '</p>'; }
        }).withFailureHandler(function(e) { if (el) el.innerHTML = '<p class="text-danger small">通信エラー: ' + escapeHtml(String(e)) + '</p>'; }).getNotifications(false);
      }
      function updateNotificationBanner() {
        google.script.run.withSuccessHandler(function(jsonStr) {
          try {
            var r = JSON.parse(jsonStr);
            var banner = document.getElementById('notificationBanner');
            var listEl = document.getElementById('notificationBannerList');
            if (!banner || !listEl) return;
            if (r.success && r.list && r.list.length) {
              var filtered = r.list.filter(function(n) { return (n.message || '').trim() !== ''; });
              // スタッフモード: 自分に関係ある通知のみ表示（自分が行ったアクションは除外）
              if (window.staffMode) {
                var myName = (window.currentUserName || '').trim();
                var myEmail = (window.currentUserEmail || '').trim().toLowerCase();
                var bannerSelfKinds = ['回答', '回答取消', '出勤キャンセル要望', '保留', '回答変更要請'];
                filtered = filtered.filter(function(n) {
                  var msg = (n.message || '');
                  var kind = (n.kind || '');
                  // 自分が行ったアクションは除外
                  if (myName && bannerSelfKinds.indexOf(kind) >= 0 && msg.indexOf(myName + ' が') === 0) return false;
                  // 清掃募集開始は全スタッフに表示
                  if (kind === '清掃募集開始') return true;
                  // 清掃変更は自分の名前が含まれる場合のみ表示
                  if (kind === '清掃変更' && myName && msg.indexOf(myName) >= 0) return true;
                  // 自分の名前が含まれる通知を表示
                  if (myName && msg.indexOf(myName) >= 0) return true;
                  return false;
                });
              }
              if (filtered.length === 0) { listEl.innerHTML = ''; banner.style.display = 'none'; return; }
              listEl.innerHTML = filtered.map(function(n) {
                var line = '<div class="d-flex align-items-center justify-content-between gap-2 mb-1 notif-banner-row">';
                line += '<span>' + escapeHtml(formatNotificationDate(n.at)) + '\u3000' + escapeHtml(n.message) + '</span>';
                line += '<span class="d-flex gap-1 flex-shrink-0">';
                if (n.data && n.data.bookingRowNumber) {
                  line += '<button type="button" class="btn btn-sm btn-outline-primary py-0 btn-notif-open" data-brn="' + n.data.bookingRowNumber + '" data-codate="' + escapeHtml(n.data.checkoutDate || '') + '">開く</button>';
                }
                line += '<button type="button" class="btn btn-sm btn-outline-secondary py-0 btn-notif-banner-read" data-row="' + n.rowIndex + '">既読</button>';
                line += '</span></div>';
                return line;
              }).join('');
              listEl.querySelectorAll('.btn-notif-open').forEach(function(btn) {
                btn.onclick = function() {
                  var brn = parseInt(this.getAttribute('data-brn'), 10);
                  var coDate = this.getAttribute('data-codate') || '';
                  // カレンダーイベントから該当する清掃イベントを探して開く
                  var found = false;
                  if (calendar) {
                    var allEvents = calendar.getEvents();
                    for (var ei = 0; ei < allEvents.length; ei++) {
                      var ev = allEvents[ei];
                      var ep = ev.extendedProps || {};
                      if (ep.type === 'cleaning' && ep.data) {
                        var rn = ep.data.rowNumber;
                        var mrn = ep.data.mergedRowNumbers || [];
                        if (rn === brn || mrn.indexOf(brn) >= 0) {
                          showEventModal(ev);
                          found = true;
                          break;
                        }
                      }
                    }
                  }
                  if (!found) alert('該当する清掃イベントが見つかりません。カレンダーを確認してください。');
                };
              });
              listEl.querySelectorAll('.btn-notif-banner-read').forEach(function(btn) {
                btn.onclick = function() {
                  var row = parseInt(this.getAttribute('data-row'), 10);
                  google.script.run.withSuccessHandler(function(j) {
                    var res = JSON.parse(j);
                    if (res.success) updateNotificationBanner();
                  }).withFailureHandler(function() {}).markNotificationAsRead(row);
                };
              });
              banner.style.display = 'block';
              var clearBtn = document.getElementById('btnClearAllNotifBanner');
              if (clearBtn) {
                clearBtn.onclick = function() {
                  customConfirm('全ての通知を削除しますか？').then(function(ok) {
                    if (!ok) return;
                    clearBtn.disabled = true;
                    clearBtn.textContent = '削除中...';
                    google.script.run.withSuccessHandler(function(j) {
                      var res = JSON.parse(j);
                      if (res.success) { updateNotificationBanner(); loadNotificationListMain(); }
                      else { clearBtn.disabled = false; clearBtn.textContent = '一括削除'; }
                    }).withFailureHandler(function() { clearBtn.disabled = false; clearBtn.textContent = '一括削除'; }).clearAllNotifications();
                  });
                };
              }
            } else {
              listEl.innerHTML = '';
              banner.style.display = 'none';
            }
          } catch (e) {}
        }).withFailureHandler(function() {}).getNotifications(true);
      }

      function openSyncFormModal(rowIndex, platformName, icalUrl) {
        document.getElementById('syncFormRowIndex').value = rowIndex || '';
        document.getElementById('syncFormPlatformName').value = platformName || '';
        document.getElementById('syncFormIcalUrl').value = icalUrl || '';
        document.getElementById('syncFormError').style.display = 'none';
        document.getElementById('btnSaveSyncForm').textContent = rowIndex ? '保存' : '追加';
        new bootstrap.Modal(document.getElementById('syncFormModal')).show();
      }

      // 請求書設定（フォルダID・テンプレートDocID）を読み込む
      // === オーナー請求書管理 ===
      var _ownerInvData = []; // 現在表示中の請求書一覧

      function loadInvoiceSettings_() {
        var folderInp = document.getElementById('invoiceFolderIdInput');
        var templateInp = document.getElementById('invoiceTemplateDocIdInput');
        // まずlocalStorageキャッシュで即座に表示
        try {
          var cachedFolder = localStorage.getItem('invoiceFolderIdCache') || '';
          var cachedTemplate = localStorage.getItem('invoiceTemplateDocIdCache') || '';
          if (folderInp && cachedFolder && !folderInp.value) folderInp.value = cachedFolder;
          if (templateInp && cachedTemplate && !templateInp.value) templateInp.value = cachedTemplate;
        } catch (e) {}
        // サーバーから最新値を取得
        google.script.run.withSuccessHandler(function(jsonStr) {
          try {
            var r = JSON.parse(jsonStr);
            if (folderInp && r.success && r.folderId) {
              folderInp.value = r.folderId;
              try { localStorage.setItem('invoiceFolderIdCache', r.folderId); } catch (e) {}
            }
          } catch (e) {}
        }).withFailureHandler(function(err) {
          console.warn('getInvoiceFolderId failed:', err);
        }).getInvoiceFolderId();
        google.script.run.withSuccessHandler(function(jsonStr) {
          try {
            var r = JSON.parse(jsonStr);
            if (templateInp && r.success && r.templateDocId) {
              templateInp.value = r.templateDocId;
              try { localStorage.setItem('invoiceTemplateDocIdCache', r.templateDocId); } catch (e) {}
            }
          } catch (e) {}
        }).withFailureHandler(function(err) {
          console.warn('getInvoiceTemplateDocId failed:', err);
        }).getInvoiceTemplateDocId();
        // フィルタ用のスタッフ名・年月を取得
        loadOwnerInvoiceFilters_();
      }

      function loadOwnerInvoiceFilters_() {
        google.script.run.withSuccessHandler(function(jsonStr) {
          try {
            var r = JSON.parse(jsonStr);
            if (!r.success) return;
            var staffSel = document.getElementById('ownerInvFilterStaff');
            var ymSel = document.getElementById('ownerInvFilterYm');
            if (staffSel) {
              var curVal = staffSel.value;
              staffSel.innerHTML = '<option value="">全員</option>';
              (r.staffNames || []).forEach(function(n) {
                var o = document.createElement('option');
                o.value = n; o.textContent = n;
                if (n === curVal) o.selected = true;
                staffSel.appendChild(o);
              });
            }
            if (ymSel) {
              var curYm = ymSel.value;
              ymSel.innerHTML = '<option value="">全期間</option>';
              (r.yearMonths || []).forEach(function(ym) {
                var o = document.createElement('option');
                o.value = ym;
                var p = ym.split('-');
                o.textContent = p[0] + '年' + parseInt(p[1], 10) + '月';
                if (ym === curYm) o.selected = true;
                ymSel.appendChild(o);
              });
            }
          } catch (e) {}
        }).getAllInvoiceHistory('', '');
      }

      function searchOwnerInvoices_() {
        var staffVal = (document.getElementById('ownerInvFilterStaff') || {}).value || '';
        var ymVal = (document.getElementById('ownerInvFilterYm') || {}).value || '';
        var listEl = document.getElementById('ownerInvList');
        if (listEl) listEl.innerHTML = '<span class="text-muted">読み込み中...</span>';
        var checkAll = document.getElementById('ownerInvCheckAll');
        if (checkAll) checkAll.checked = false;
        updateOwnerInvSelection_();

        google.script.run.withSuccessHandler(function(jsonStr) {
          try {
            var r = JSON.parse(jsonStr);
            if (!r.success) {
              if (listEl) listEl.innerHTML = '<span class="text-danger">' + escapeHtml(r.error || 'エラー') + '</span>';
              return;
            }
            _ownerInvData = r.list || [];
            renderOwnerInvoiceList_();
          } catch (e) {
            if (listEl) listEl.innerHTML = '<span class="text-danger">読み込みエラー</span>';
          }
        }).withFailureHandler(function(err) {
          if (listEl) listEl.innerHTML = '<span class="text-danger">通信エラー</span>';
        }).getAllInvoiceHistory(staffVal, ymVal);
      }

      function renderOwnerInvoiceList_() {
        var listEl = document.getElementById('ownerInvList');
        if (!listEl) return;
        if (_ownerInvData.length === 0) {
          listEl.innerHTML = '<span class="text-muted">該当する請求書がありません。</span>';
          return;
        }
        // 新しい順にソート（送信日時の降順）
        _ownerInvData.sort(function(a, b) {
          return (b.sentAt || '').localeCompare(a.sentAt || '');
        });
        var html = '<table class="table table-sm table-bordered mb-0" style="font-size:0.85rem;">' +
          '<thead class="table-light"><tr>' +
          '<th style="width:30px;"><input type="checkbox" class="form-check-input" id="ownerInvCheckAllInner"></th>' +
          '<th>スタッフ</th><th>対象月</th><th>合計</th><th>送信日時</th><th>明細</th><th>PDF</th>' +
          '</tr></thead><tbody>';
        _ownerInvData.forEach(function(inv, idx) {
          var ymParts = (inv.yearMonth || '').split('-');
          var ymDisplay = ymParts.length === 2 ? ymParts[0] + '年' + parseInt(ymParts[1], 10) + '月' : inv.yearMonth;
          var detailHtml = '';
          try {
            var items = JSON.parse(inv.itemsJson || '[]');
            if (items.length > 0) {
              detailHtml = '<button type="button" class="btn btn-sm btn-outline-secondary py-0 px-1 btn-inv-detail" data-idx="' + idx + '" style="font-size:0.75rem;">明細</button>';
            }
          } catch (e) {}
          var pdfHtml = inv.pdfUrl ? '<a href="' + escapeHtml(inv.pdfUrl) + '" target="_blank" class="btn btn-sm btn-outline-primary py-0 px-1" style="font-size:0.75rem;">PDF</a>' : '-';
          var hasPdf = !!(inv.pdfFileId && inv.pdfUrl);
          html += '<tr>' +
            '<td class="text-center"><input type="checkbox" class="form-check-input ownerInvCheck" data-idx="' + idx + '" data-fileid="' + escapeHtml(inv.pdfFileId || '') + '"' + (hasPdf ? '' : ' disabled') + '></td>' +
            '<td>' + escapeHtml(inv.staffName) + '</td>' +
            '<td>' + escapeHtml(ymDisplay) + '</td>' +
            '<td class="text-end">¥' + (inv.total || 0).toLocaleString() + '</td>' +
            '<td>' + escapeHtml(inv.sentAt || '') + '</td>' +
            '<td class="text-center">' + detailHtml + '</td>' +
            '<td class="text-center">' + pdfHtml + '</td>' +
            '</tr>';
        });
        html += '</tbody></table>';
        listEl.innerHTML = html;

        // チェックボックスイベント
        listEl.querySelectorAll('.ownerInvCheck').forEach(function(cb) {
          cb.addEventListener('change', updateOwnerInvSelection_);
        });
        var innerAll = document.getElementById('ownerInvCheckAllInner');
        if (innerAll) {
          innerAll.addEventListener('change', function() {
            var checked = this.checked;
            listEl.querySelectorAll('.ownerInvCheck:not(:disabled)').forEach(function(cb) { cb.checked = checked; });
            var outerAll = document.getElementById('ownerInvCheckAll');
            if (outerAll) outerAll.checked = checked;
            updateOwnerInvSelection_();
          });
        }

        // 明細ボタン
        listEl.querySelectorAll('.btn-inv-detail').forEach(function(btn) {
          btn.addEventListener('click', function() {
            var idx = parseInt(this.getAttribute('data-idx'), 10);
            var inv = _ownerInvData[idx];
            if (!inv) return;
            showInvoiceDetailModal_(inv.staffName + ' ' + inv.yearMonth, inv.itemsJson, inv.total);
          });
        });
      }

      function showInvoiceDetailModal_(title, itemsJson, total) {
        try {
          var items = JSON.parse(itemsJson || '[]');
          var titleEl = document.getElementById('invoiceDetailModalTitle');
          var bodyEl = document.getElementById('invoiceDetailBody');
          var totalEl = document.getElementById('invoiceDetailTotal');
          titleEl.textContent = '【' + title + '】';
          bodyEl.innerHTML = '';
          if (items.length === 0) {
            bodyEl.innerHTML = '<tr><td colspan="3" class="text-center text-muted ps-3">明細なし</td></tr>';
          } else {
            items.forEach(function(it) {
              var tr = document.createElement('tr');
              tr.innerHTML = '<td class="ps-3">' + (it.d || '') + '</td><td>' + (it.n || '') + '</td><td class="text-end pe-3">¥' + (it.a || 0).toLocaleString() + '</td>';
              bodyEl.appendChild(tr);
            });
          }
          totalEl.textContent = '¥' + (total || 0).toLocaleString();
          var modal = new bootstrap.Modal(document.getElementById('invoiceDetailModal'));
          modal.show();
        } catch (e) { alert('明細の読み込みに失敗しました'); }
      }

      function updateOwnerInvSelection_() {
        var checks = document.querySelectorAll('.ownerInvCheck:checked');
        var countEl = document.getElementById('ownerInvSelectedCount');
        var dlBtn = document.getElementById('btnOwnerInvDownload');
        var cnt = checks.length;
        if (countEl) countEl.textContent = cnt > 0 ? cnt + '件選択中' : '';
        if (dlBtn) dlBtn.disabled = cnt === 0;
      }

      function loadSettings() {
        // スタッフ用URLはオーナーURLから自動生成
        var staffInp = document.getElementById('staffDeployUrlInput');
        if (staffInp) {
          // まずテンプレートのappBaseUrlで表示
          var base = window.appBaseUrl || '';
          if (base) {
            staffInp.value = base + (base.indexOf('?') >= 0 ? '&staff=1' : '?staff=1');
          }
          // バックエンドから確実に取得（ScriptApp + プロパティ + デプロイID全て試行）
          google.script.run.withSuccessHandler(function(jsonStr) {
            try {
              var r = JSON.parse(jsonStr);
              if (r.success && r.url) staffInp.value = r.url;
            } catch (e) {}
          }).getStaffDeployUrl();
        }
        loadInvoiceSettings_();
        google.script.run.withSuccessHandler(function(jsonStr) {
          try {
            var r = JSON.parse(jsonStr);
            if (!r.success) return;
            var setupForm = document.getElementById('ownerSetupForm');
            var emailSection = document.getElementById('ownerEmailSection');
            var subTabs = document.getElementById('settingsSubTabs');
            var desc = document.getElementById('settingsDescription');
            var pwdSetupForm = document.getElementById('ownerPasswordSetupForm');
            if (r.ownerNotSet) {
              if (setupForm) setupForm.style.display = 'block';
              if (pwdSetupForm) pwdSetupForm.style.display = 'none';
              if (emailSection) emailSection.style.display = 'none';
              if (subTabs) subTabs.style.display = 'none';
              if (desc) desc.textContent = '初回のみオーナー登録を行ってください。登録後はオーナーのみ設定画面にアクセスできます。';
            } else {
              if (setupForm) setupForm.style.display = 'none';
              if (!r.hasPassword) {
                if (pwdSetupForm) pwdSetupForm.style.display = 'block';
                if (emailSection) emailSection.style.display = 'block';
                if (subTabs) subTabs.style.display = 'none';
              } else {
                if (pwdSetupForm) pwdSetupForm.style.display = 'none';
                if (emailSection) emailSection.style.display = 'block';
                if (subTabs) subTabs.style.display = '';
                loadStaffList();
                loadSubOwnerList();
              }
              var disp = document.getElementById('ownerEmailDisplay');
              if (disp) disp.textContent = r.email || '(未設定)';
              if (desc) desc.textContent = 'オーナーのみ閲覧・編集可能です。';
            }
          } catch (e) {}
        }).getOwnerStatus();
      }

      document.getElementById('btnOwnerSetup').addEventListener('click', function() {
        var email = document.getElementById('ownerSetupEmail').value.trim();
        var pw = document.getElementById('ownerSetupPassword').value;
        var pw2 = document.getElementById('ownerSetupPasswordConfirm').value;
        var errEl = document.getElementById('ownerSetupError');
        if (!email) { errEl.textContent = 'メールアドレスを入力してください。'; errEl.style.display = 'block'; return; }
        if (pw.length < 6) { errEl.textContent = 'パスワードは6文字以上で入力してください。'; errEl.style.display = 'block'; return; }
        if (pw !== pw2) { errEl.textContent = 'パスワードが一致しません。'; errEl.style.display = 'block'; return; }
        errEl.style.display = 'none';
        google.script.run.withSuccessHandler(function(jsonStr) {
          var r = JSON.parse(jsonStr);
          if (r.success) { alert('登録しました。'); window.isOwnerUser = true; window.ownerNotSet = false; loadSettings(); }
          else { errEl.textContent = r.error || '失敗'; errEl.style.display = 'block'; }
        }).withFailureHandler(function(err) { errEl.textContent = err.message || 'エラー'; errEl.style.display = 'block'; }).setOwnerWithPassword(email, pw);
      });

      document.getElementById('btnOwnerPasswordSetup').addEventListener('click', function() {
        var pw = document.getElementById('ownerPasswordSetup').value;
        var pw2 = document.getElementById('ownerPasswordSetupConfirm').value;
        var errEl = document.getElementById('ownerPasswordSetupError');
        if (pw.length < 6) { errEl.textContent = 'パスワードは6文字以上で入力してください。'; errEl.style.display = 'block'; return; }
        if (pw !== pw2) { errEl.textContent = 'パスワードが一致しません。'; errEl.style.display = 'block'; return; }
        errEl.style.display = 'none';
        google.script.run.withSuccessHandler(function(jsonStr) {
          var r = JSON.parse(jsonStr);
          if (r.success) { alert('設定しました。'); loadSettings(); }
          else { errEl.textContent = r.error || '失敗'; errEl.style.display = 'block'; }
        }).withFailureHandler(function(err) { errEl.textContent = err.message || 'エラー'; errEl.style.display = 'block'; }).setInitialPassword(pw);
      });

      // === URL/IDからIDだけ抽出するヘルパー ===
      function extractDriveId(input) {
        var s = (input || '').trim();
        // GoogleドライブフォルダURL: /folders/XXXXX
        var m = s.match(/\/folders\/([a-zA-Z0-9_-]{10,})/);
        if (m) return m[1];
        // GoogleドキュメントURL: /d/XXXXX/
        m = s.match(/\/d\/([a-zA-Z0-9_-]{10,})/);
        if (m) return m[1];
        // ID部分（20文字以上の英数字ハイフンアンダーバー）
        m = s.match(/^([a-zA-Z0-9_-]{10,})$/);
        if (m) return m[1];
        // URLの中にそれっぽいID
        m = s.match(/[a-zA-Z0-9_-]{20,}/);
        if (m) return m[0];
        return s;
      }

      // === 請求書設定：フォルダID保存 ===
      document.getElementById('btnSaveInvoiceFolder').addEventListener('click', function() {
        var raw = document.getElementById('invoiceFolderIdInput').value.trim();
        var folderId = extractDriveId(raw);
        var resEl = document.getElementById('invoiceFolderSaveResult');
        google.script.run.withSuccessHandler(function(jsonStr) {
          try {
            var r = JSON.parse(jsonStr);
            if (r.success) {
              document.getElementById('invoiceFolderIdInput').value = folderId;
              try { localStorage.setItem('invoiceFolderIdCache', folderId); } catch (e2) {}
              resEl.textContent = '保存しました。';
              resEl.className = 'small mt-1 text-success';
              resEl.style.display = 'block';
              setTimeout(function() { resEl.style.display = 'none'; }, 2000);
            } else {
              resEl.textContent = r.error || '失敗';
              resEl.className = 'small mt-1 text-danger';
              resEl.style.display = 'block';
            }
          } catch (e) { resEl.textContent = 'エラー'; resEl.className = 'small mt-1 text-danger'; resEl.style.display = 'block'; }
        }).withFailureHandler(function(err) {
          resEl.textContent = err.message || 'エラー';
          resEl.className = 'small mt-1 text-danger';
          resEl.style.display = 'block';
        }).setInvoiceFolderId(folderId);
      });
      // === 請求書設定：テンプレートDoc ID保存 ===
      document.getElementById('btnSaveInvoiceTemplate').addEventListener('click', function() {
        var raw = document.getElementById('invoiceTemplateDocIdInput').value.trim();
        var docId = extractDriveId(raw);
        var resEl = document.getElementById('invoiceTemplateSaveResult');
        google.script.run.withSuccessHandler(function(jsonStr) {
          try {
            var r = JSON.parse(jsonStr);
            if (r.success) {
              document.getElementById('invoiceTemplateDocIdInput').value = docId;
              try { localStorage.setItem('invoiceTemplateDocIdCache', docId); } catch (e2) {}
              resEl.textContent = '保存しました。';
              resEl.className = 'small mt-1 text-success';
              resEl.style.display = 'block';
              setTimeout(function() { resEl.style.display = 'none'; }, 2000);
            } else {
              resEl.textContent = r.error || '失敗';
              resEl.className = 'small mt-1 text-danger';
              resEl.style.display = 'block';
            }
          } catch (e) { resEl.textContent = 'エラー'; resEl.className = 'small mt-1 text-danger'; resEl.style.display = 'block'; }
        }).withFailureHandler(function(err) {
          resEl.textContent = err.message || 'エラー';
          resEl.className = 'small mt-1 text-danger';
          resEl.style.display = 'block';
        }).setInvoiceTemplateDocId(docId);
      });

      // === オーナー請求書一覧：イベントハンドラ ===
      document.getElementById('btnOwnerInvSearch').addEventListener('click', function() {
        searchOwnerInvoices_();
      });

      document.getElementById('ownerInvCheckAll').addEventListener('change', function() {
        var checked = this.checked;
        document.querySelectorAll('.ownerInvCheck:not(:disabled)').forEach(function(cb) { cb.checked = checked; });
        var innerAll = document.getElementById('ownerInvCheckAllInner');
        if (innerAll) innerAll.checked = checked;
        updateOwnerInvSelection_();
      });

      document.getElementById('btnOwnerInvDownload').addEventListener('click', function() {
        var btn = this;
        var checks = document.querySelectorAll('.ownerInvCheck:checked');
        var fileIds = [];
        checks.forEach(function(cb) {
          var fid = cb.getAttribute('data-fileid');
          if (fid) fileIds.push(fid);
        });
        if (fileIds.length === 0) { alert('PDFを選択してください。'); return; }
        var resEl = document.getElementById('ownerInvDownloadResult');
        btn.disabled = true;
        btn.textContent = fileIds.length + '件のPDFを準備中...';
        if (resEl) { resEl.style.display = 'none'; }

        google.script.run.withSuccessHandler(function(jsonStr) {
          btn.disabled = false;
          btn.textContent = '選択したPDFをダウンロード';
          updateOwnerInvSelection_();
          try {
            var r = JSON.parse(jsonStr);
            if (r.success && r.url) {
              if (resEl) {
                resEl.innerHTML = '<a href="' + escapeHtml(r.url) + '" target="_blank" class="text-success">' + r.count + '件の' + (r.count > 1 ? 'ZIP' : 'PDF') + 'を開く</a>';
                resEl.style.display = 'block';
              }
              window.open(r.url, '_blank');
            } else {
              if (resEl) { resEl.textContent = r.error || '失敗'; resEl.className = 'small mt-1 text-danger'; resEl.style.display = 'block'; }
            }
          } catch (e) {
            if (resEl) { resEl.textContent = 'エラー'; resEl.className = 'small mt-1 text-danger'; resEl.style.display = 'block'; }
          }
        }).withFailureHandler(function(err) {
          btn.disabled = false;
          btn.textContent = '選択したPDFをダウンロード';
          updateOwnerInvSelection_();
          if (resEl) { resEl.textContent = err.message || 'エラー'; resEl.className = 'small mt-1 text-danger'; resEl.style.display = 'block'; }
        }).createInvoiceZipDownload(fileIds);
      });

      // === 請求書機能（スタッフ画面・独立タブ） ===
      var invoiceManualItemsList = []; // 手動追加項目リスト（シートに永続化）
      var invoiceExcludedAuto = [];    // 除外した清掃実績のcheckoutDate配列（UI上のみ）
      var invoiceJobOptions = [];      // 仕事内容マスタの選択肢キャッシュ
      var _invoiceSaving = false;      // 保存中フラグ

      function getInvoiceYm() {
        var monthInp = document.getElementById('invoiceMonth');
        return monthInp && monthInp.value ? monthInp.value : (function() {
          var d = new Date();
          return d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0');
        })();
      }

      // 月セレクタ初期化
      (function() {
        var monthInp = document.getElementById('invoiceMonth');
        if (monthInp && !monthInp.dataset.init) {
          monthInp.dataset.init = '1';
          var d = new Date();
          monthInp.value = d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0');
          monthInp.addEventListener('change', function() { loadInvoiceData(); });
        }
      })();

      // sessionStorage キャッシュヘルパー
      function _invoiceCacheKey(type, ym) { return 'inv_' + type + '_' + (window.currentUserName || '') + '_' + ym; }
      function _invoiceSaveCache(type, ym, data) {
        try { sessionStorage.setItem(_invoiceCacheKey(type, ym), JSON.stringify(data)); } catch(e) {}
      }
      function _invoiceLoadCache(type, ym) {
        try { return JSON.parse(sessionStorage.getItem(_invoiceCacheKey(type, ym)) || '[]'); } catch(e) { return []; }
      }

      function loadInvoiceData() {
        if (!window.staffMode) return;

        var staffId = (window.currentUserName || window.currentUserEmail || '').trim();
        if (!staffId) return;

        var ym = getInvoiceYm();
        var ymParts = ym.split('-');
        var ymBadge = document.getElementById('invoiceYmBadge');
        if (ymBadge) ymBadge.textContent = ymParts[0] + '年' + parseInt(ymParts[1], 10) + '月分';

        var content = document.getElementById('invoiceContent');
        var notReady = document.getElementById('invoiceNotReady');
        var autoEl = document.getElementById('invoiceAutoItems');
        if (autoEl) autoEl.innerHTML = '<span class="text-muted">読み込み中...</span>';

        // sessionStorage から除外・追加項目を復元（サーバー応答前に即時表示）
        invoiceExcludedAuto = _invoiceLoadCache('excluded', ym);
        invoiceManualItemsList = _invoiceLoadCache('extra', ym);
        renderInvoiceManualItems();
        updateInvoiceTotal();

        // 送信履歴を独立してサーバーから取得（getInvoiceDataの成否に依存しない）
        loadStaffInvoiceHistory_();

        google.script.run.withSuccessHandler(function(jsonStr) {
          try {
            var r = JSON.parse(jsonStr);
            if (!r.success) {
              if (autoEl) autoEl.innerHTML = '<span class="text-danger">' + escapeHtml(r.error || 'エラー') + '</span>';
              return;
            }
            if (!r.hasFolder || !r.hasTemplate) {
              if (notReady) notReady.style.display = 'block';
              if (content) content.style.display = 'none';
            } else {
              if (notReady) notReady.style.display = 'none';
              if (content) content.style.display = 'block';
            }

            // 自動明細の表示（削除ボタン付き）
            window._invoiceAutoItems = r.autoItems || [];
            renderInvoiceAutoItems();

            // 仕事内容プルダウン（清掃系含む全項目）
            invoiceJobOptions = r.allJobOptions || r.jobOptions || [];
            var sel = document.getElementById('invoiceAddJobSelect');
            if (sel) {
              sel.innerHTML = '<option value="">選択...</option>';
              invoiceJobOptions.forEach(function(opt) {
                var o = document.createElement('option');
                o.value = opt.name;
                o.textContent = opt.name + (opt.defaultAmount ? ' (¥' + opt.defaultAmount.toLocaleString() + ')' : '');
                o.dataset.amount = opt.defaultAmount || 0;
                sel.appendChild(o);
              });
              var customOpt = document.createElement('option');
              customOpt.value = '__custom__';
              customOpt.textContent = '手入力';
              sel.appendChild(customOpt);
            }

            // 追加項目（サーバーを正とする：再デプロイ後もサーバーから復元）
            invoiceManualItemsList = r.extraItems || [];
            _invoiceSaveCache('extra', ym, invoiceManualItemsList);
            renderInvoiceManualItems();

            // 除外項目（サーバーを正とする：再デプロイ後もサーバーから復元）
            invoiceExcludedAuto = r.excludedAuto || [];
            _invoiceSaveCache('excluded', ym, invoiceExcludedAuto);
            renderInvoiceAutoItems();

            updateInvoiceTotal();
          } catch (e) {
            if (autoEl) autoEl.innerHTML = '<span class="text-danger">読み込みエラー</span>';
          }
        }).withFailureHandler(function(err) {
          if (autoEl) autoEl.innerHTML = '<span class="text-danger">通信エラー</span>';
        }).getInvoiceData(ym, staffId);
      }

      // 自動明細の表示（除外ボタン付き）
      function renderInvoiceAutoItems() {
        var autoEl = document.getElementById('invoiceAutoItems');
        if (!autoEl) return;
        var items = window._invoiceAutoItems || [];
        if (items.length === 0) {
          autoEl.innerHTML = '<span class="text-muted">この月の清掃実績はありません。</span>';
          return;
        }
        autoEl.innerHTML = items.map(function(item, idx) {
          var excluded = invoiceExcludedAuto.indexOf(item.date) !== -1;
          var amtStr = item.amount > 0 ? '¥' + item.amount.toLocaleString() : '<span class="text-danger">未設定</span>';
          var specialHtml = '';
          if (!excluded && item.specialItems && item.specialItems.length > 0) {
            specialHtml = item.specialItems.map(function(sp) {
              return '<div class="ms-3 text-muted"><small>+ ' + escapeHtml(sp.name) + ' ¥' + sp.amount.toLocaleString() + '</small></div>';
            }).join('');
          }
          var rowClass = excluded ? 'border rounded p-1 px-2 mb-1 d-flex justify-content-between align-items-center bg-light text-decoration-line-through text-muted' :
                                    'border rounded p-1 px-2 mb-1 d-flex justify-content-between align-items-center';
          var btnHtml = excluded
            ? '<button type="button" class="btn btn-sm btn-outline-success py-0 px-1 ms-1 btn-restore-auto" data-date="' + escapeHtml(item.date) + '" style="font-size:0.7em;">戻す</button>'
            : '<button type="button" class="btn btn-sm btn-outline-danger py-0 px-1 ms-1 btn-exclude-auto" data-date="' + escapeHtml(item.date) + '" style="font-size:0.7em;">×</button>';
          return '<div class="' + rowClass + '">' +
            '<div><strong>' + escapeHtml(item.dateDisplay) + '</strong> ' + escapeHtml(item.jobName) +
            (item.partners && item.partners.length ? ' <span class="text-muted">(' + item.partners.map(function(p) { return escapeHtml(p); }).join(', ') + ')</span>' : '') +
            '</div><div>' + (excluded ? '<s>' + amtStr + '</s>' : amtStr) + ' ' + btnHtml + '</div></div>' + specialHtml;
        }).join('');

        autoEl.querySelectorAll('.btn-exclude-auto').forEach(function(btn) {
          btn.onclick = function() {
            var dt = this.getAttribute('data-date');
            if (invoiceExcludedAuto.indexOf(dt) === -1) invoiceExcludedAuto.push(dt);
            _invoiceSaveCache('excluded', getInvoiceYm(), invoiceExcludedAuto);
            _saveExcludedToServer();
            renderInvoiceAutoItems();
            updateInvoiceTotal();
          };
        });
        autoEl.querySelectorAll('.btn-restore-auto').forEach(function(btn) {
          btn.onclick = function() {
            var dt = this.getAttribute('data-date');
            invoiceExcludedAuto = invoiceExcludedAuto.filter(function(d) { return d !== dt; });
            _invoiceSaveCache('excluded', getInvoiceYm(), invoiceExcludedAuto);
            _saveExcludedToServer();
            renderInvoiceAutoItems();
            updateInvoiceTotal();
          };
        });
      }

      // 手動項目の表示
      function renderInvoiceManualItems() {
        var el = document.getElementById('invoiceManualItems');
        if (!el) return;
        if (invoiceManualItemsList.length === 0) {
          el.innerHTML = '';
          return;
        }
        el.innerHTML = invoiceManualItemsList.map(function(item, idx) {
          var dateStr = item.date || '';
          if (dateStr) {
            var dp = dateStr.split('-');
            if (dp.length === 3) dateStr = parseInt(dp[1], 10) + '/' + parseInt(dp[2], 10);
          }
          return '<div class="border rounded p-1 px-2 mb-1 d-flex justify-content-between align-items-center">' +
            '<div>' + (dateStr ? '<strong>' + escapeHtml(dateStr) + '</strong> ' : '') + escapeHtml(item.name) + '</div>' +
            '<div>¥' + item.amount.toLocaleString() + ' <button type="button" class="btn btn-sm btn-outline-danger py-0 px-1 ms-1 btn-remove-manual-item" data-idx="' + idx + '" style="font-size:0.7em;">×</button></div></div>';
        }).join('');
        el.querySelectorAll('.btn-remove-manual-item').forEach(function(btn) {
          btn.onclick = function() {
            var idx = parseInt(this.getAttribute('data-idx'), 10);
            invoiceManualItemsList.splice(idx, 1);
            _invoiceSaveCache('extra', getInvoiceYm(), invoiceManualItemsList);
            renderInvoiceManualItems();
            updateInvoiceTotal();
            saveInvoiceExtraItemsToSheet();
          };
        });
      }

      // 追加項目をシートに保存
      function saveInvoiceExtraItemsToSheet() {
        var staffId = (window.currentUserName || window.currentUserEmail || '').trim();
        var ym = getInvoiceYm();
        if (!staffId || !ym) return;
        // JSON文字列化して渡す（google.script.runの配列シリアライズ問題を回避）
        var itemsToSave = invoiceManualItemsList.map(function(it) {
          return { date: String(it.date || ''), name: String(it.name || ''), amount: Number(it.amount || 0) };
        });
        var itemsJson = JSON.stringify(itemsToSave);
        var saveStatusEl = document.getElementById('invoiceSaveStatus');
        if (saveStatusEl) { saveStatusEl.textContent = '保存中...'; saveStatusEl.className = 'small text-muted'; saveStatusEl.style.display = 'inline'; }
        google.script.run.withSuccessHandler(function(jsonStr) {
          try {
            var r = JSON.parse(jsonStr);
            if (r.success) {
              if (saveStatusEl) { saveStatusEl.textContent = '保存済み'; saveStatusEl.className = 'small text-success'; saveStatusEl.style.display = 'inline'; }
            } else {
              if (saveStatusEl) { saveStatusEl.textContent = '保存失敗: ' + (r.error || ''); saveStatusEl.className = 'small text-danger'; saveStatusEl.style.display = 'inline'; }
            }
          } catch (e) {
            if (saveStatusEl) { saveStatusEl.textContent = '保存エラー'; saveStatusEl.className = 'small text-danger'; saveStatusEl.style.display = 'inline'; }
          }
          setTimeout(function() { if (saveStatusEl) saveStatusEl.style.display = 'none'; }, 3000);
        }).withFailureHandler(function(err) {
          if (saveStatusEl) { saveStatusEl.textContent = '通信エラー: ' + (err.message || err); saveStatusEl.className = 'small text-danger'; saveStatusEl.style.display = 'inline'; }
        }).saveInvoiceExtraItems(ym, staffId, itemsJson);
      }

      // 除外項目をサーバーに保存（保存結果フィードバック付き）
      function _saveExcludedToServer() {
        var staffId = (window.currentUserName || window.currentUserEmail || '').trim();
        var ym = getInvoiceYm();
        if (!staffId || !ym) return;
        var exclStatusEl = document.getElementById('invoiceExclSaveStatus');
        if (exclStatusEl) { exclStatusEl.textContent = '保存中...'; exclStatusEl.className = 'small text-muted'; exclStatusEl.style.display = 'inline'; }
        google.script.run.withSuccessHandler(function(jsonStr) {
          try {
            var r = JSON.parse(jsonStr);
            if (r.success) {
              if (exclStatusEl) { exclStatusEl.textContent = '保存済み'; exclStatusEl.className = 'small text-success'; exclStatusEl.style.display = 'inline'; }
            } else {
              if (exclStatusEl) { exclStatusEl.textContent = '保存失敗'; exclStatusEl.className = 'small text-danger'; exclStatusEl.style.display = 'inline'; }
            }
          } catch (e) {
            if (exclStatusEl) { exclStatusEl.textContent = '保存エラー'; exclStatusEl.className = 'small text-danger'; exclStatusEl.style.display = 'inline'; }
          }
          setTimeout(function() { if (exclStatusEl) exclStatusEl.style.display = 'none'; }, 3000);
        }).withFailureHandler(function(err) {
          if (exclStatusEl) { exclStatusEl.textContent = '通信エラー'; exclStatusEl.className = 'small text-danger'; exclStatusEl.style.display = 'inline'; }
        }).saveInvoiceExcludedAuto(ym, staffId, JSON.stringify(invoiceExcludedAuto));
      }

      // 合計金額の計算・表示
      function updateInvoiceTotal() {
        var items = window._invoiceAutoItems || [];
        var total = 0;
        items.forEach(function(item) {
          if (invoiceExcludedAuto.indexOf(item.date) !== -1) return;
          total += (item.amount || 0);
          if (item.specialItems) {
            item.specialItems.forEach(function(sp) { total += (sp.amount || 0); });
          }
        });
        invoiceManualItemsList.forEach(function(item) { total += (item.amount || 0); });
        var el = document.getElementById('invoiceTotalDisplay');
        if (el) el.textContent = '¥' + total.toLocaleString();
      }

      // 送信履歴をサーバーから独立取得（オーナー請求書一覧と同じ関数を使用）
      function loadStaffInvoiceHistory_() {
        var staffId = (window.currentUserName || window.currentUserEmail || '').trim();
        var ymSel = document.getElementById('staffHistoryFilterYm');
        var filterYm = ymSel ? ymSel.value : '';
        console.log('[履歴] getAllInvoiceHistory呼出 staffId=[' + staffId + '] filterYm=[' + filterYm + ']');
        if (!staffId) { console.warn('[履歴] staffIdが空のためスキップ'); return; }
        var el = document.getElementById('invoiceHistoryList');
        if (el) el.innerHTML = '<span class="text-muted">読み込み中...</span>';
        google.script.run.withSuccessHandler(function(jsonStr) {
          console.log('[履歴] サーバー応答:', jsonStr ? jsonStr.substring(0, 300) : '(empty)');
          try {
            var r = JSON.parse(jsonStr);
            if (!r.success) {
              if (el) el.innerHTML = '<span class="text-danger">' + escapeHtml(r.error || 'エラー') + '</span>';
              return;
            }
            // 対象月プルダウンを更新（サーバーから返る全期間リスト）
            if (r.yearMonths && ymSel) {
              var curVal = ymSel.value;
              ymSel.innerHTML = '<option value="">全期間</option>';
              r.yearMonths.forEach(function(ym) {
                var o = document.createElement('option');
                o.value = ym;
                var p = ym.split('-');
                o.textContent = p[0] + '年' + parseInt(p[1], 10) + '月';
                if (ym === curVal) o.selected = true;
                ymSel.appendChild(o);
              });
            }
            console.log('[履歴] 件数:', (r.list || []).length);
            renderStaffInvoiceHistory_(r.list || []);
          } catch (e) {
            console.error('[履歴] パースエラー:', e);
            if (el) el.innerHTML = '<span class="text-danger">読み込みエラー</span>';
          }
        }).withFailureHandler(function(err) {
          console.error('[履歴] 通信エラー:', err);
          if (el) el.innerHTML = '<span class="text-danger">通信エラー: ' + escapeHtml(err.message || String(err)) + '</span>';
        }).getAllInvoiceHistory(staffId, filterYm);
      }

      // 送信履歴テーブル表示（チェックボックス+PDF DL対応）
      function renderStaffInvoiceHistory_(list) {
        var el = document.getElementById('invoiceHistoryList');
        if (!el) return;
        var checkAll = document.getElementById('staffHistoryCheckAll');
        if (checkAll) checkAll.checked = false;
        updateStaffHistorySelection_();
        if (!list || list.length === 0) {
          el.innerHTML = '<span class="text-muted">送信履歴はありません。</span>';
          return;
        }
        var sorted = list.slice().sort(function(a, b) {
          return (b.sentAt || '').localeCompare(a.sentAt || '');
        });
        var html = '<table class="table table-sm table-bordered mb-0" style="font-size:0.85rem;">' +
          '<thead class="table-light"><tr>' +
          '<th style="width:28px;"><input type="checkbox" class="form-check-input" id="staffHistoryCheckAllInner"></th>' +
          '<th>対象月</th><th>合計</th><th>送信日時</th><th>明細</th><th>PDF</th></tr></thead><tbody>';
        sorted.forEach(function(h, idx) {
          var hasPdf = !!(h.pdfFileId && h.pdfUrl);
          var pdfHtml = h.pdfUrl ? '<a href="' + escapeHtml(h.pdfUrl) + '" target="_blank" class="btn btn-sm btn-outline-primary py-0 px-1" style="font-size:0.75rem;">PDF</a>' : '-';
          var ymParts = (h.yearMonth || '').split('-');
          var ymDisplay = ymParts.length === 2 ? ymParts[0] + '年' + parseInt(ymParts[1], 10) + '月' : h.yearMonth || '';
          var detailHtml = '';
          try {
            var items = JSON.parse(h.itemsJson || '[]');
            if (items.length > 0) {
              detailHtml = '<button type="button" class="btn btn-sm btn-outline-secondary py-0 px-1 btn-staff-hist-detail" data-idx="' + idx + '" style="font-size:0.75rem;">明細</button>';
            }
          } catch (e) {}
          html += '<tr>' +
            '<td class="text-center"><input type="checkbox" class="form-check-input staffHistoryCheck" data-fileid="' + escapeHtml(h.pdfFileId || '') + '"' + (hasPdf ? '' : ' disabled') + '></td>' +
            '<td>' + escapeHtml(ymDisplay) + '</td>' +
            '<td class="text-end">¥' + (h.total || 0).toLocaleString() + '</td>' +
            '<td>' + escapeHtml(h.sentAt || '') + '</td>' +
            '<td class="text-center">' + detailHtml + '</td>' +
            '<td class="text-center">' + pdfHtml + '</td>' +
            '</tr>';
        });
        html += '</tbody></table>';
        el.innerHTML = html;
        // チェックボックスイベント
        el.querySelectorAll('.staffHistoryCheck').forEach(function(cb) {
          cb.addEventListener('change', updateStaffHistorySelection_);
        });
        var innerAll = document.getElementById('staffHistoryCheckAllInner');
        if (innerAll) {
          innerAll.addEventListener('change', function() {
            var checked = this.checked;
            el.querySelectorAll('.staffHistoryCheck:not(:disabled)').forEach(function(cb) { cb.checked = checked; });
            if (checkAll) checkAll.checked = checked;
            updateStaffHistorySelection_();
          });
        }
        // 明細ボタン
        el.querySelectorAll('.btn-staff-hist-detail').forEach(function(btn) {
          btn.addEventListener('click', function() {
            var idx = parseInt(this.getAttribute('data-idx'), 10);
            var h = sorted[idx];
            if (!h) return;
            showInvoiceDetailModal_(h.yearMonth || '', h.itemsJson, h.total);
          });
        });
      }

      // スタッフ履歴の選択件数・DLボタン更新
      function updateStaffHistorySelection_() {
        var checks = document.querySelectorAll('.staffHistoryCheck:checked');
        var countEl = document.getElementById('staffHistorySelectedCount');
        var dlBtn = document.getElementById('btnStaffHistoryDownload');
        var cnt = checks.length;
        if (countEl) countEl.textContent = cnt > 0 ? cnt + '件選択中' : '';
        if (dlBtn) dlBtn.disabled = cnt === 0;
      }

      // 追加項目のプルダウン変更時
      document.getElementById('invoiceAddJobSelect').addEventListener('change', function() {
        var customNameInp = document.getElementById('invoiceAddCustomName');
        var amtInp = document.getElementById('invoiceAddAmount');
        if (this.value === '__custom__') {
          if (customNameInp) customNameInp.style.display = '';
          if (amtInp) amtInp.value = '';
        } else {
          if (customNameInp) customNameInp.style.display = 'none';
          var opt = this.options[this.selectedIndex];
          if (opt && opt.dataset.amount && Number(opt.dataset.amount) > 0) {
            if (amtInp) amtInp.value = opt.dataset.amount;
          } else {
            if (amtInp) amtInp.value = '';
          }
        }
      });

      // 追加ボタン
      document.getElementById('btnInvoiceAddItem').addEventListener('click', function() {
        var sel = document.getElementById('invoiceAddJobSelect');
        var customInp = document.getElementById('invoiceAddCustomName');
        var amtInp = document.getElementById('invoiceAddAmount');
        var dateInp = document.getElementById('invoiceAddDate');

        var name = '';
        if (sel.value === '__custom__') {
          name = (customInp ? customInp.value.trim() : '');
        } else {
          name = sel.value;
        }
        var amt = parseInt(amtInp ? amtInp.value : 0, 10);
        if (!name) { alert('項目名を選択または入力してください。'); return; }
        if (!amt || !isFinite(amt)) { alert('金額を入力してください。'); return; }

        invoiceManualItemsList.push({
          date: dateInp ? dateInp.value : '',
          name: name,
          amount: amt
        });
        _invoiceSaveCache('extra', getInvoiceYm(), invoiceManualItemsList);
        renderInvoiceManualItems();
        updateInvoiceTotal();
        saveInvoiceExtraItemsToSheet();

        if (sel) sel.value = '';
        if (customInp) { customInp.value = ''; customInp.style.display = 'none'; }
        if (amtInp) amtInp.value = '';
        if (dateInp) dateInp.value = '';
      });

      // 送信履歴の検索ボタン
      document.getElementById('btnRefreshStaffHistory').addEventListener('click', function() {
        loadStaffInvoiceHistory_();
      });

      // 送信履歴の全選択チェックボックス
      document.getElementById('staffHistoryCheckAll').addEventListener('change', function() {
        var checked = this.checked;
        document.querySelectorAll('.staffHistoryCheck:not(:disabled)').forEach(function(cb) { cb.checked = checked; });
        var innerAll = document.getElementById('staffHistoryCheckAllInner');
        if (innerAll) innerAll.checked = checked;
        updateStaffHistorySelection_();
      });

      // 送信履歴のPDFダウンロードボタン
      document.getElementById('btnStaffHistoryDownload').addEventListener('click', function() {
        var btn = this;
        var checks = document.querySelectorAll('.staffHistoryCheck:checked');
        var fileIds = [];
        checks.forEach(function(cb) {
          var fid = cb.getAttribute('data-fileid');
          if (fid) fileIds.push(fid);
        });
        if (fileIds.length === 0) { alert('PDFを選択してください。'); return; }
        var resEl = document.getElementById('staffHistoryDownloadResult');
        btn.disabled = true;
        btn.textContent = fileIds.length + '件のPDFを準備中...';
        if (resEl) { resEl.style.display = 'none'; }

        google.script.run.withSuccessHandler(function(jsonStr) {
          btn.disabled = false;
          btn.textContent = '選択PDFをダウンロード';
          updateStaffHistorySelection_();
          try {
            var r = JSON.parse(jsonStr);
            if (r.success && r.url) {
              if (resEl) {
                resEl.innerHTML = '<a href="' + escapeHtml(r.url) + '" target="_blank" class="text-success">' + r.count + '件の' + (r.count > 1 ? 'ZIP' : 'PDF') + 'を開く</a>';
                resEl.className = 'small mt-1';
                resEl.style.display = 'block';
              }
              window.open(r.url, '_blank');
            } else {
              if (resEl) { resEl.textContent = r.error || '失敗'; resEl.className = 'small mt-1 text-danger'; resEl.style.display = 'block'; }
            }
          } catch (e) {
            if (resEl) { resEl.textContent = 'エラー'; resEl.className = 'small mt-1 text-danger'; resEl.style.display = 'block'; }
          }
        }).withFailureHandler(function(err) {
          btn.disabled = false;
          btn.textContent = '選択PDFをダウンロード';
          updateStaffHistorySelection_();
          if (resEl) { resEl.textContent = err.message || 'エラー'; resEl.className = 'small mt-1 text-danger'; resEl.style.display = 'block'; }
        }).createInvoiceZipDownload(fileIds);
      });

      // 送信ボタン
      document.getElementById('btnSendInvoice').addEventListener('click', function() {
        var staffId = (window.currentUserName || window.currentUserEmail || '').trim();
        var ym = getInvoiceYm();
        var remarks = (document.getElementById('invoiceRemarks') || {}).value || '';
        var resEl = document.getElementById('invoiceSendResult');
        var btn = this;

        if (!staffId) { alert('スタッフを選択してください。'); return; }
        // confirm()はiOS Safariでブロックされるため2タップ方式
        if (!btn._confirmReady) {
          btn._confirmReady = true;
          btn._origText = btn.textContent;
          btn.textContent = '本当に送信？もう一度タップ';
          btn.classList.remove('btn-primary');
          btn.classList.add('btn-danger');
          setTimeout(function() {
            if (btn._confirmReady) {
              btn._confirmReady = false;
              btn.textContent = btn._origText;
              btn.classList.remove('btn-danger');
              btn.classList.add('btn-primary');
            }
          }, 5000);
          return;
        }
        btn._confirmReady = false;

        btn.disabled = true;
        btn.textContent = '送信中...';
        if (resEl) { resEl.textContent = ''; resEl.style.display = 'none'; }

        google.script.run.withSuccessHandler(function(jsonStr) {
          btn.disabled = false;
          btn.textContent = '請求書を送信';
          try {
            var r = JSON.parse(jsonStr);
            if (r.success) {
              if (resEl) {
                resEl.textContent = '送信完了（合計: ¥' + (r.total || 0).toLocaleString() + '）';
                resEl.className = 'small mt-1 text-success';
                resEl.style.display = 'block';
              }
              // 送信後、履歴をサーバーから再取得
              setTimeout(function() { loadStaffInvoiceHistory_(); }, 500);
            } else {
              if (resEl) {
                resEl.textContent = r.error || '送信失敗';
                resEl.className = 'small mt-1 text-danger';
                resEl.style.display = 'block';
              }
            }
          } catch (e) {
            if (resEl) { resEl.textContent = 'エラー'; resEl.className = 'small mt-1 text-danger'; resEl.style.display = 'block'; }
          }
        }).withFailureHandler(function(err) {
          btn.disabled = false;
          btn.textContent = '請求書を送信';
          if (resEl) { resEl.textContent = err.message || 'エラー'; resEl.className = 'small mt-1 text-danger'; resEl.style.display = 'block'; }
        }).createAndSendInvoice(ym, staffId, JSON.stringify(invoiceManualItemsList.map(function(it) { return { date: String(it.date || ''), name: String(it.name || ''), amount: Number(it.amount || 0) }; })), remarks, JSON.stringify(invoiceExcludedAuto.slice()));
      });
      document.getElementById('btnOpenStaffUrl').addEventListener('click', function() {
        var url = document.getElementById('staffDeployUrlInput').value.trim();
        if (!url) { alert('スタッフ用URLがまだ設定されていません。'); return; }
        window.open(url, '_blank');
      });
      document.getElementById('btnCopyStaffUrl').addEventListener('click', function() {
        var url = document.getElementById('staffDeployUrlInput').value.trim();
        if (!url) { alert('URLが入力されていません。スタッフ用デプロイのURLを入力して保存してください。'); return; }
        if (navigator.clipboard && navigator.clipboard.writeText) {
          navigator.clipboard.writeText(url).then(function() { alert('コピーしました。'); }).catch(function() {});
        } else {
          var inp = document.getElementById('staffDeployUrlInput');
          inp.select();
          if (document.execCommand) document.execCommand('copy');
          alert('コピーしました。');
        }
      });
      // btnSaveStaffUrl は廃止（自動生成のため）
      document.getElementById('btnChangeOwnerEmail').addEventListener('click', function() {
        document.getElementById('ownerEmailNew').value = '';
        document.getElementById('ownerEmailPassword').value = '';
        document.getElementById('ownerEmailChangeError').style.display = 'none';
        new bootstrap.Modal(document.getElementById('ownerEmailChangeModal')).show();
      });

      document.getElementById('btnConfirmOwnerEmailChange').addEventListener('click', function() {
        var newEmail = document.getElementById('ownerEmailNew').value.trim();
        var pw = document.getElementById('ownerEmailPassword').value;
        var errEl = document.getElementById('ownerEmailChangeError');
        if (!newEmail) { errEl.textContent = '新しいメールアドレスを入力してください。'; errEl.style.display = 'block'; return; }
        if (!pw) { errEl.textContent = 'パスワードを入力してください。'; errEl.style.display = 'block'; return; }
        errEl.style.display = 'none';
        google.script.run.withSuccessHandler(function(jsonStr) {
          var r = JSON.parse(jsonStr);
          if (r.success) { bootstrap.Modal.getInstance(document.getElementById('ownerEmailChangeModal')).hide(); loadSettings(); alert('変更しました。'); }
          else { errEl.textContent = r.error || '失敗'; errEl.style.display = 'block'; }
        }).withFailureHandler(function(err) { errEl.textContent = err.message || 'エラー'; errEl.style.display = 'block'; }).changeOwnerEmail(newEmail, pw);
      });

      function loadStaffList() {
        var _staffList = document.getElementById('staffList');
        if (_staffList) _staffList.innerHTML = '<div class="text-center py-2"><span class="spinner-border spinner-border-sm text-primary"></span><span class="text-muted small ms-2">読み込み中…</span></div>';
        google.script.run.withSuccessHandler(function(jsonStr) {
          try {
            var res = JSON.parse(jsonStr);
            var html = '';
            if (res.success && res.list && res.list.length) {
              res.list.forEach(function(s) {
                html += '<div class="border rounded p-2 mb-2"><strong>' + escapeHtml(s.name) + '</strong> ' + escapeHtml(s.email);
                html += ' <button type="button" class="btn btn-sm btn-outline-secondary btnEditStaff" data-row="' + s.rowIndex + '" data-name="' + escapeHtml(s.name) + '" data-address="' + escapeHtml(s.address) + '" data-email="' + escapeHtml(s.email) + '" data-bank="' + escapeHtml(s.bankName) + '" data-branch="' + escapeHtml(s.bankBranch) + '" data-atype="' + escapeHtml(s.accountType) + '" data-anum="' + escapeHtml(s.accountNumber) + '" data-holder="' + escapeHtml(s.accountHolder) + '">編集</button>';
                html += ' <button type="button" class="btn btn-sm btn-outline-danger btnDelStaff" data-row="' + s.rowIndex + '">削除</button>';
                if (s.hasPassword) html += ' <button type="button" class="btn btn-sm btn-outline-warning btnResetPw" data-name="' + escapeHtml(s.name) + '">PW\u30EA\u30BB\u30C3\u30C8</button>';
                html += '</div>';
              });
            }
            document.getElementById('staffList').innerHTML = html || '<p class="text-muted">スタッフがいません。</p>';
            document.querySelectorAll('.btnEditStaff').forEach(function(btn) {
              btn.addEventListener('click', function() {
                document.getElementById('staffFormRowIndex').value = this.getAttribute('data-row');
                document.getElementById('staffFormName').value = this.getAttribute('data-name') || '';
                document.getElementById('staffFormAddress').value = this.getAttribute('data-address') || '';
                document.getElementById('staffFormEmail').value = this.getAttribute('data-email') || '';
                document.getElementById('staffFormBankName').value = this.getAttribute('data-bank') || '';
                document.getElementById('staffFormBankBranch').value = this.getAttribute('data-branch') || '';
                document.getElementById('staffFormAccountType').value = this.getAttribute('data-atype') || '';
                document.getElementById('staffFormAccountNumber').value = this.getAttribute('data-anum') || '';
                document.getElementById('staffFormAccountHolder').value = this.getAttribute('data-holder') || '';
                new bootstrap.Modal(document.getElementById('staffFormModal')).show();
              });
            });
            document.querySelectorAll('.btnDelStaff').forEach(function(btn) {
              btn.addEventListener('click', function() {
                var row = parseInt(this.getAttribute('data-row'), 10);
                customConfirm('このスタッフを削除しますか？').then(function(ok) {
                  if (!ok) return;
                  google.script.run.withSuccessHandler(function(jsonStr) {
                    var r = JSON.parse(jsonStr);
                    if (r.success) loadStaffList();
                  }).deleteStaff(row);
                });
              });
            });
            document.querySelectorAll('.btnResetPw').forEach(function(btn) {
              btn.addEventListener('click', function() {
                var staffName = this.getAttribute('data-name');
                customConfirm(staffName + ' のパスワードをリセットしますか？\n次回ログイン時にパスワードなしでログインできるようになります。').then(function(ok) {
                  if (!ok) return;
                  google.script.run.withSuccessHandler(function(j) {
                    var r = JSON.parse(j);
                    if (r.success) { customAlert(staffName + ' のパスワードをリセットしました。'); loadStaffList(); }
                    else customAlert(r.error || '失敗');
                  }).resetStaffPassword(staffName);
                });
              });
            });
          } catch (e) {}
        }).getStaffList();
      }

      document.getElementById('btnAddStaff').addEventListener('click', function() {
        document.getElementById('staffFormRowIndex').value = '';
        document.getElementById('staffFormName').value = '';
        document.getElementById('staffFormAddress').value = '';
        document.getElementById('staffFormEmail').value = '';
        document.getElementById('staffFormBankName').value = '';
        document.getElementById('staffFormBankBranch').value = '';
        document.getElementById('staffFormAccountType').value = '';
        document.getElementById('staffFormAccountNumber').value = '';
        document.getElementById('staffFormAccountHolder').value = '';
        new bootstrap.Modal(document.getElementById('staffFormModal')).show();
      });

      document.getElementById('btnSaveStaffForm').addEventListener('click', function() {
        var btn = this;
        if (btn.disabled) return;
        var row = document.getElementById('staffFormRowIndex').value;
        var data = {
          name: document.getElementById('staffFormName').value.trim(),
          address: document.getElementById('staffFormAddress').value.trim(),
          email: document.getElementById('staffFormEmail').value.trim(),
          bankName: document.getElementById('staffFormBankName').value.trim(),
          bankBranch: document.getElementById('staffFormBankBranch').value.trim(),
          accountType: document.getElementById('staffFormAccountType').value.trim(),
          accountNumber: document.getElementById('staffFormAccountNumber').value.trim(),
          accountHolder: document.getElementById('staffFormAccountHolder').value.trim()
        };
        btn.disabled = true;
        google.script.run.withSuccessHandler(function(jsonStr) {
          btn.disabled = false;
          var r = JSON.parse(jsonStr);
          if (r.success) { bootstrap.Modal.getInstance(document.getElementById('staffFormModal')).hide(); loadStaffList(); }
          else { document.getElementById('staffFormError').textContent = r.error || '失敗'; document.getElementById('staffFormError').style.display = 'block'; }
        }).withFailureHandler(function() { btn.disabled = false; }).saveStaff(row ? parseInt(row, 10) : null, data);
      });

      function loadSubOwnerList() {
        var _soList = document.getElementById('subOwnerList');
        if (_soList) _soList.innerHTML = '<div class="text-center py-2"><span class="spinner-border spinner-border-sm text-primary"></span><span class="text-muted small ms-2">読み込み中…</span></div>';
        google.script.run.withSuccessHandler(function(jsonStr) {
          try {
            var res = JSON.parse(jsonStr);
            var html = '';
            if (res.success && res.list && res.list.length) {
              res.list.forEach(function(s) {
                html += '<div class="border rounded p-2 mb-2"><strong>' + escapeHtml(s.displayName) + '</strong> <small class="text-muted">' + escapeHtml(s.email) + '</small>';
                html += ' <button type="button" class="btn btn-sm btn-outline-secondary btnEditSubOwner" data-row="' + s.rowIndex + '" data-email="' + escapeHtml(s.email) + '" data-display="' + escapeHtml(s.displayName) + '">編集</button>';
                html += ' <button type="button" class="btn btn-sm btn-outline-danger btnDelSubOwner" data-row="' + s.rowIndex + '">削除</button></div>';
              });
            }
            document.getElementById('subOwnerList').innerHTML = html || '<p class="text-muted">サブオーナーがいません。</p>';
            document.querySelectorAll('.btnEditSubOwner').forEach(function(btn) {
              btn.addEventListener('click', function() {
                document.getElementById('subOwnerFormRowIndex').value = this.getAttribute('data-row');
                document.getElementById('subOwnerFormEmail').value = this.getAttribute('data-email') || '';
                document.getElementById('subOwnerFormDisplayName').value = this.getAttribute('data-display') || '';
                document.getElementById('subOwnerFormError').style.display = 'none';
                new bootstrap.Modal(document.getElementById('subOwnerFormModal')).show();
              });
            });
            document.querySelectorAll('.btnDelSubOwner').forEach(function(btn) {
              btn.addEventListener('click', function() {
                var row = parseInt(this.getAttribute('data-row'), 10);
                customConfirm('このサブオーナーを削除しますか？').then(function(ok) {
                  if (!ok) return;
                  google.script.run.withSuccessHandler(function(jsonStr) {
                    var r = JSON.parse(jsonStr);
                    if (r.success) loadSubOwnerList();
                  }).deleteSubOwner(row);
                });
              });
            });
          } catch (e) {}
        }).getSubOwnerList();
      }

      document.getElementById('btnAddSubOwner').addEventListener('click', function() {
        document.getElementById('subOwnerFormRowIndex').value = '';
        document.getElementById('subOwnerFormEmail').value = '';
        document.getElementById('subOwnerFormDisplayName').value = '';
        document.getElementById('subOwnerFormError').style.display = 'none';
        new bootstrap.Modal(document.getElementById('subOwnerFormModal')).show();
      });

      document.getElementById('btnSaveSubOwnerForm').addEventListener('click', function() {
        var btn = this;
        if (btn.disabled) return;
        var row = document.getElementById('subOwnerFormRowIndex').value;
        var email = document.getElementById('subOwnerFormEmail').value.trim();
        var displayName = document.getElementById('subOwnerFormDisplayName').value.trim();
        var errEl = document.getElementById('subOwnerFormError');
        if (!email) { errEl.textContent = 'メールアドレスを入力してください。'; errEl.style.display = 'block'; return; }
        errEl.style.display = 'none';
        btn.disabled = true;
        google.script.run.withSuccessHandler(function(jsonStr) {
          btn.disabled = false;
          var r = JSON.parse(jsonStr);
          if (r.success) {
            bootstrap.Modal.getInstance(document.getElementById('subOwnerFormModal')).hide();
            loadSubOwnerList();
          } else {
            errEl.textContent = r.error || '失敗';
            errEl.style.display = 'block';
          }
        }).withFailureHandler(function(err) {
          btn.disabled = false;
          errEl.textContent = err.message || 'エラー';
          errEl.style.display = 'block';
        }).saveSubOwner(row ? parseInt(row, 10) : null, email, displayName);
      });

      function loadJobList() {
        var _jobList = document.getElementById('jobList');
        if (_jobList) _jobList.innerHTML = '<div class="text-center py-2"><span class="spinner-border spinner-border-sm text-primary"></span><span class="text-muted small ms-2">読み込み中…</span></div>';
        function showJobError(msg) {
          var el = document.getElementById('jobList');
          if (el) el.innerHTML = '<p class="text-danger small">読み込みエラー: ' + escapeHtml(msg) + '</p>';
        }
        google.script.run
          .withSuccessHandler(function(jobStr) {
            try {
              var jobRes = JSON.parse(jobStr);
            } catch (e) { showJobError('仕事内容のパース失敗'); return; }
            if (!jobRes.success || !jobRes.list) {
              document.getElementById('jobList').innerHTML = '<p class="text-muted">仕事内容がありません。' + (jobRes.error ? ' (' + escapeHtml(jobRes.error) + ')' : '') + '</p>';
              return;
            }
            google.script.run
              .withSuccessHandler(function(compStr) {
                try {
                  var compRes = JSON.parse(compStr);
                  var byJob = {};
                  if (compRes.success && compRes.list) {
                    compRes.list.forEach(function(c) {
                      if (!byJob[c.jobName]) byJob[c.jobName] = {};
                      byJob[c.jobName][c.staffName] = c.amount;
                    });
                  }
                  google.script.run
                    .withSuccessHandler(function(specStr) {
                      try {
                        var specRes = JSON.parse(specStr);
                      } catch (e) { showJobError('特別レートのパース失敗'); return; }
                      var specialByJob = (specRes.success && specRes.byJob) ? specRes.byJob : {};
                      google.script.run
                        .withSuccessHandler(function(optStr) {
                          try {
                            var opt = JSON.parse(optStr);
                          } catch (e) { showJobError('オプションのパース失敗'); return; }
                          var staffOrder = ['共通'];
                          if (opt.success && opt.staffList) {
                            opt.staffList.forEach(function(s) {
                              if (s.name) staffOrder.push(s.name);
                            });
                          }
                          var html = '';
                          var jobIdx = 0;
                          jobRes.list.forEach(function(j) {
                            var comps = byJob[j.name] || {};
                            var specials = specialByJob[j.name] || [];
                            var jid = 'jb_' + jobIdx++;
                            html += '<div class="border rounded mb-3" data-job-name="' + escapeHtml(j.name) + '">';
                            // ヘッダー: 折りたたみ見出し + 鉛筆 + 削除
                            html += '<div class="d-flex align-items-center px-3 py-2 bg-light" style="cursor:pointer;" onclick="var b=this.nextElementSibling;var a=this.querySelector(\'.jb-arrow\');if(b.style.display===\'none\'){b.style.display=\'block\';a.style.transform=\'rotate(90deg)\';}else{b.style.display=\'none\';a.style.transform=\'rotate(0deg)\';}">';
                            html += '<small class="jb-arrow" style="width:14px;color:#888;transition:transform 0.15s;display:inline-block;">&#9654;</small>';
                            html += '<strong class="flex-grow-1 ms-1" id="' + jid + '_name">' + escapeHtml(j.name) + '</strong>';
                            html += '<button type="button" class="btn btn-sm btn-link p-0 me-2 btnRenameJob" data-jid="' + jid + '" data-row="' + j.rowIndex + '" data-name="' + escapeHtml(j.name) + '" data-sort="' + (j.sortOrder || 99) + '" title="名称変更" style="font-size:16px;text-decoration:none;line-height:1;" onclick="event.stopPropagation();">✎</button>';
                            html += '<button type="button" class="btn btn-sm btn-link text-danger p-0 btnDelJob" data-row="' + j.rowIndex + '" title="削除" style="font-size:14px;text-decoration:none;line-height:1;" onclick="event.stopPropagation();">✕</button>';
                            html += '</div>';
                            // 報酬セクション（見出しタッチで展開、初期非表示）
                            html += '<div class="px-3 py-2 border-top" style="display:none;">';
                            staffOrder.forEach(function(staff) {
                              var amt = comps[staff] || '';
                              html += '<div class="d-flex align-items-center py-1 border-bottom">';
                              html += '<small class="fw-bold" style="min-width:80px;">' + escapeHtml(staff) + '</small>';
                              html += '<input type="number" class="form-control form-control-sm jobCompInlineAmt ms-2" data-job="' + escapeHtml(j.name) + '" data-staff="' + escapeHtml(staff) + '" value="' + escapeHtml(String(amt)) + '" placeholder="金額" min="0" style="width:100px;">';
                              html += '<span class="small ms-1">円</span>';
                              html += '</div>';
                            });
                            // 保存ボタン（一括）
                            html += '<div class="d-flex justify-content-end pt-2">';
                            html += '<button type="button" class="btn btn-sm btn-primary btnSaveJobCompInline" data-job="' + escapeHtml(j.name) + '">保存</button>';
                            html += '</div>';
                            // 特別料金セクション（折りたたみ）
                            html += '<div class="py-1 mt-1">';
                            html += '<div class="d-flex align-items-center" style="cursor:pointer;" onclick="var t=this.nextElementSibling;var a=this.querySelector(\'.sp-arrow\');if(t.style.display===\'none\'){t.style.display=\'block\';a.style.transform=\'rotate(90deg)\';}else{t.style.display=\'none\';a.style.transform=\'rotate(0deg)\';}">';
                            html += '<small class="sp-arrow" style="width:14px;color:#888;transition:transform 0.15s;display:inline-block;">&#9654;</small>';
                            html += '<small class="fw-bold ms-1">特別料金</small>';
                            html += '<small class="text-muted ms-auto">' + (specials.length ? specials.length + '件' : 'なし') + '</small>';
                            html += '</div>';
                            html += '<div class="ps-3 py-1 small text-muted" style="display:none;">';
                            if (specials.length) {
                              specials.forEach(function(s) {
                                var range = s.startDate === (s.endDate || s.startDate) ? s.startDate : s.startDate + '～' + (s.endDate || s.startDate);
                                html += '<div>' + escapeHtml(s.itemName) + ' ' + range + ' +' + escapeHtml(String(s.amount)) + '円</div>';
                              });
                            }
                            html += '<button type="button" class="btn btn-sm btn-outline-primary mt-1 btnEditJobComp" data-name="' + escapeHtml(j.name) + '">' + (specials.length ? '特別料金を編集' : '特別料金を設定') + '</button>';
                            html += '</div></div>';
                            html += '</div></div>';
                          });
                          document.getElementById('jobList').innerHTML = html || '<p class="text-muted">仕事内容がありません。</p>';
                          // 名称変更（鉛筆アイコン）
                          document.querySelectorAll('.btnRenameJob').forEach(function(btn) {
                            btn.addEventListener('click', function() {
                              var jid = this.getAttribute('data-jid');
                              var row = this.getAttribute('data-row');
                              var sort = this.getAttribute('data-sort');
                              var nameEl = document.getElementById(jid + '_name');
                              if (!nameEl) return;
                              var currentName = nameEl.textContent;
                              nameEl.innerHTML = '<div class="d-flex align-items-center gap-1"><input type="text" class="form-control form-control-sm" id="' + jid + '_input" value="' + escapeHtml(currentName) + '" style="max-width:200px;">' +
                                '<button type="button" class="btn btn-sm btn-primary" id="' + jid + '_save">保存</button>' +
                                '<button type="button" class="btn btn-sm btn-secondary" id="' + jid + '_cancel">取消</button></div>';
                              var inp = document.getElementById(jid + '_input');
                              inp.focus(); inp.select();
                              document.getElementById(jid + '_cancel').addEventListener('click', function() {
                                nameEl.innerHTML = ''; nameEl.textContent = currentName;
                              });
                              document.getElementById(jid + '_save').addEventListener('click', function() {
                                var newName = inp.value.trim();
                                if (!newName) { alert('名称を入力してください。'); return; }
                                google.script.run.withSuccessHandler(function(jsonStr) {
                                  var r = JSON.parse(jsonStr);
                                  if (r.success) loadJobList();
                                  else alert(r.error || '失敗');
                                }).saveJobType(parseInt(row, 10), newName, parseInt(sort, 10) || 99);
                              });
                            });
                          });
                          // 報酬インライン保存
                          document.querySelectorAll('.btnSaveJobCompInline').forEach(function(btn) {
                            btn.addEventListener('click', function() {
                              var jobName = this.getAttribute('data-job');
                              var card = this.closest('[data-job-name]');
                              var entries = [];
                              card.querySelectorAll('.jobCompInlineAmt').forEach(function(inp) {
                                var staff = inp.getAttribute('data-staff');
                                var amount = inp.value.trim();
                                if (staff && amount) entries.push({ staffName: staff, amount: amount });
                              });
                              var saveBtn = this;
                              saveBtn.disabled = true; saveBtn.textContent = '...';
                              google.script.run.withSuccessHandler(function(jsonStr) {
                                saveBtn.disabled = false; saveBtn.textContent = '保存';
                                var r = JSON.parse(jsonStr);
                                if (r.success) loadJobList();
                                else alert(r.error || '失敗');
                              }).withFailureHandler(function() {
                                saveBtn.disabled = false; saveBtn.textContent = '保存';
                              }).saveCompensationForJob(jobName, entries);
                            });
                          });
                          // 特別料金編集
                          document.querySelectorAll('.btnEditJobComp').forEach(function(btn) {
                            btn.addEventListener('click', function() {
                              openJobCompFormModal(this.getAttribute('data-name'));
                            });
                          });
                          // 削除
                          document.querySelectorAll('.btnDelJob').forEach(function(btn) {
                            btn.addEventListener('click', function() {
                              var rowToDelete = parseInt(btn.getAttribute('data-row'), 10);
                              customConfirm('削除しますか？').then(function(ok) {
                                if (!ok) return;
                                google.script.run.withSuccessHandler(function() { loadJobList(); }).deleteJobType(rowToDelete);
                              });
                            });
                          });
                        })
                        .withFailureHandler(function(e) { showJobError('getCompFormOptions: ' + (e.message || e)); })
                        .getCompFormOptions();
                    })
                    .withFailureHandler(function(e) { showJobError('getAllSpecialRates: ' + (e.message || e)); })
                    .getAllSpecialRates();
                } catch (e) {
                  showJobError('報酬データ処理中: ' + String(e));
                }
              })
              .withFailureHandler(function(e) { showJobError('getCompensation: ' + (e.message || e)); })
              .getCompensation();
          })
          .withFailureHandler(function(e) { showJobError('getJobTypes: ' + (e.message || e)); })
          .getJobTypes();
      }

      function addSpecialRateRow(container, data) {
        data = data || { startDate: '', endDate: '', itemName: '', amount: '' };
        var row = document.createElement('div');
        row.className = 'row g-2 mb-2 special-rate-row';
        row.innerHTML = '<div class="col-12 col-md-3"><input type="date" class="form-control form-control-sm special-start" placeholder="対象開始日" value="' + escapeHtml(data.startDate || '') + '"></div>' +
          '<div class="col-12 col-md-3"><input type="date" class="form-control form-control-sm special-end" placeholder="対象終了日" value="' + escapeHtml(data.endDate || '') + '"></div>' +
          '<div class="col-12 col-md-3"><input type="text" class="form-control form-control-sm special-item" placeholder="項目名（例:年末年始）" value="' + escapeHtml(data.itemName || '') + '"></div>' +
          '<div class="col-10 col-md-2"><input type="number" class="form-control form-control-sm special-amount" placeholder="追加円" value="' + escapeHtml(data.amount || '') + '" min="0"></div>' +
          '<div class="col-2 col-md-1"><button type="button" class="btn btn-sm btn-outline-danger btn-remove-special" title="削除">×</button></div>';
        container.appendChild(row);
        row.querySelector('.btn-remove-special').addEventListener('click', function() { row.remove(); });
      }

      function openJobCompFormModal(jobName) {
        document.getElementById('jobCompFormJobName').value = jobName || '';
        document.getElementById('jobCompFormJobNameDisplay').textContent = jobName || '';
        document.getElementById('jobCompFormError').style.display = 'none';
        google.script.run.withSuccessHandler(function(jsonStr) {
          var r = JSON.parse(jsonStr);
          var table = document.getElementById('jobCompFormTable');
          table.innerHTML = '';
          var staffOrder = ['共通'];
          if (r.success && r.staffList) {
            r.staffList.forEach(function(s) {
              if (s.name) staffOrder.push(s.name);
            });
          }
          google.script.run.withSuccessHandler(function(compStr) {
            var comp = JSON.parse(compStr);
            var comps = {};
            if (comp.success && comp.list) {
              comp.list.forEach(function(c) {
                if (c.jobName === jobName) comps[c.staffName] = c.amount;
              });
            }
            staffOrder.forEach(function(staff) {
              var row = document.createElement('div');
              row.className = 'row g-2 mb-1';
              var inp = document.createElement('input');
              inp.type = 'number';
              inp.className = 'form-control form-control-sm job-comp-amount';
              inp.setAttribute('data-staff', staff);
              inp.placeholder = '円';
              inp.min = 0;
              inp.value = comps[staff] || '';
              row.innerHTML = '<div class="col-4 col-md-3"><label class="form-label small mb-0">' + escapeHtml(staff) + '</label></div><div class="col-6 col-md-4"></div>';
              row.querySelector('.col-6').appendChild(inp);
              table.appendChild(row);
            });
            var specContainer = document.getElementById('jobCompFormSpecialRates');
            specContainer.innerHTML = '';
            google.script.run.withSuccessHandler(function(specStr) {
              var spec = JSON.parse(specStr);
              if (spec.success && spec.list && spec.list.length) {
                spec.list.forEach(function(s) { addSpecialRateRow(specContainer, s); });
              }
              addSpecialRateRow(specContainer, {});
              new bootstrap.Modal(document.getElementById('jobCompFormModal')).show();
            }).getSpecialRatesForJob(jobName);
          }).getCompensation();
        }).getCompFormOptions();
      }

      document.getElementById('btnAddSpecialRate').addEventListener('click', function() {
        addSpecialRateRow(document.getElementById('jobCompFormSpecialRates'), {});
      });

      document.getElementById('btnSaveJobCompForm').addEventListener('click', function() {
        var btn = this;
        if (btn.disabled) return;
        var jobName = document.getElementById('jobCompFormJobName').value.trim();
        var errEl = document.getElementById('jobCompFormError');
        if (!jobName) { errEl.textContent = '仕事内容が指定されていません。'; errEl.style.display = 'block'; return; }
        var entries = [];
        document.querySelectorAll('.job-comp-amount').forEach(function(inp) {
          var staff = inp.getAttribute('data-staff');
          var amount = inp.value.trim();
          if (staff && amount) entries.push({ staffName: staff, amount: amount });
        });
        var specialEntries = [];
        document.querySelectorAll('.special-rate-row').forEach(function(row) {
          var start = (row.querySelector('.special-start') || {}).value || '';
          var end = (row.querySelector('.special-end') || {}).value || '';
          var item = (row.querySelector('.special-item') || {}).value || '';
          var amt = (row.querySelector('.special-amount') || {}).value || '';
          if (start && item && amt) specialEntries.push({ startDate: start, endDate: end || start, itemName: item, amount: amt });
        });
        errEl.style.display = 'none';
        btn.disabled = true;
        var origText = btn.textContent;
        btn.textContent = '保存中...';
        google.script.run.withSuccessHandler(function(jsonStr) {
          var r = JSON.parse(jsonStr);
          if (r.success) {
            google.script.run.withSuccessHandler(function(specStr) {
              btn.disabled = false;
              btn.textContent = origText;
              var sr = JSON.parse(specStr);
              if (sr.success) {
                bootstrap.Modal.getInstance(document.getElementById('jobCompFormModal')).hide();
                loadJobList();
              } else { errEl.textContent = sr.error || '特別料金の保存に失敗'; errEl.style.display = 'block'; }
            }).withFailureHandler(function() { btn.disabled = false; btn.textContent = origText; errEl.textContent = '特別料金の保存に失敗'; errEl.style.display = 'block'; }).saveSpecialRatesForJob(jobName, specialEntries);
          } else {
            btn.disabled = false;
            btn.textContent = origText;
            errEl.textContent = r.error || '失敗';
            errEl.style.display = 'block';
          }
        }).withFailureHandler(function() { btn.disabled = false; btn.textContent = origText; }).saveCompensationForJob(jobName, entries);
      });

      document.getElementById('btnAddJob').addEventListener('click', function() {
        document.getElementById('jobFormRowIndex').value = '';
        document.getElementById('jobFormSortOrder').value = '99';
        document.getElementById('jobFormName').value = '';
        document.getElementById('jobFormError').style.display = 'none';
        new bootstrap.Modal(document.getElementById('jobFormModal')).show();
      });

      document.getElementById('btnSaveJobForm').addEventListener('click', function() {
        var btn = this;
        if (btn.disabled) return;
        var rowIndex = document.getElementById('jobFormRowIndex').value;
        var sortOrder = document.getElementById('jobFormSortOrder').value || 99;
        var name = document.getElementById('jobFormName').value.trim();
        var errEl = document.getElementById('jobFormError');
        if (!name) { errEl.textContent = '仕事内容名を入力してください。'; errEl.style.display = 'block'; return; }
        errEl.style.display = 'none';
        btn.disabled = true;
        var origText = btn.textContent;
        btn.textContent = '保存中...';
        google.script.run.withSuccessHandler(function(jsonStr) {
          btn.disabled = false;
          btn.textContent = origText;
          var r = JSON.parse(jsonStr);
          if (r.success) {
            bootstrap.Modal.getInstance(document.getElementById('jobFormModal')).hide();
            loadJobList();
          } else { errEl.textContent = r.error || '失敗'; errEl.style.display = 'block'; }
        }).withFailureHandler(function() { btn.disabled = false; btn.textContent = origText; }).saveJobType(rowIndex ? parseInt(rowIndex, 10) : null, name, parseInt(sortOrder, 10) || 99);
      });

      function loadRecruitSettingsForm() {
        google.script.run.withSuccessHandler(function(jsonStr) {
          try {
            var r = JSON.parse(jsonStr);
            if (r.success && r.settings) {
              document.getElementById('minRespondents').value = r.settings.minRespondents || 2;
              document.getElementById('reminderIntervalWeeks').value = r.settings.reminderIntervalWeeks || 1;
              document.getElementById('selectCount').value = r.settings.selectCount || 2;
            }
          } catch (e) {}
        }).getRecruitmentSettings();
      }

      document.getElementById('btnSaveRecruitSettings').addEventListener('click', function() {
        var settings = {
          minRespondents: parseInt(document.getElementById('minRespondents').value, 10) || 2,
          reminderIntervalWeeks: parseInt(document.getElementById('reminderIntervalWeeks').value, 1) || 1,
          selectCount: parseInt(document.getElementById('selectCount').value, 10) || 2
        };
        google.script.run.withSuccessHandler(function(jsonStr) {
          var r = JSON.parse(jsonStr);
          alert(r.success ? '保存しました。' : (r.error || '失敗'));
        }).setRecruitmentSettings(settings);
      });

      // 名簿リマインダー設定
      (function() {
        var sel = document.getElementById('rosterReminderHour');
        if (sel) {
          for (var h = 0; h <= 23; h++) {
            var opt = document.createElement('option');
            opt.value = h;
            opt.textContent = h + '時';
            if (h === 9) opt.selected = true;
            sel.appendChild(opt);
          }
        }
      })();

      function loadRosterReminderSettings() {
        google.script.run.withSuccessHandler(function(jsonStr) {
          try {
            var r = JSON.parse(jsonStr);
            if (r.success && r.settings) {
              document.getElementById('rosterReminderEnabled').checked = !!r.settings.rosterReminderEnabled;
              document.getElementById('rosterReminderDaysBefore').value = r.settings.rosterReminderDaysBefore || 3;
              document.getElementById('rosterReminderHour').value = r.settings.rosterReminderHour != null ? r.settings.rosterReminderHour : 9;
            }
          } catch (e) {}
        }).getRosterReminderSettings();
      }

      document.getElementById('btnSaveRosterReminder').addEventListener('click', function() {
        var btn = this;
        setButtonLoading(btn, true);
        var settings = {
          rosterReminderEnabled: document.getElementById('rosterReminderEnabled').checked,
          rosterReminderDaysBefore: parseInt(document.getElementById('rosterReminderDaysBefore').value, 10) || 3,
          rosterReminderHour: parseInt(document.getElementById('rosterReminderHour').value, 10) || 9
        };
        google.script.run.withSuccessHandler(function(jsonStr) {
          setButtonLoading(btn, false);
          var r = JSON.parse(jsonStr);
          alert(r.success ? '保存しました。' : (r.error || '失敗'));
        }).withFailureHandler(function(e) {
          setButtonLoading(btn, false);
          alert(e.message);
        }).saveRosterReminderSettings(settings);
      });

      // リマインド時刻selectに0〜23時のオプションを生成
      (function() {
        document.querySelectorAll('select.reminder-time').forEach(function(sel) {
          for (var h = 0; h <= 23; h++) {
            var opt = document.createElement('option');
            opt.value = ('0' + h).slice(-2) + ':00';
            opt.textContent = h + '時';
            sel.appendChild(opt);
          }
          sel.value = '09:00';
        });
      })();

      function loadReminderEmailSettings() {
        google.script.run.withSuccessHandler(function(jsonStr) {
          try {
            var r = JSON.parse(jsonStr);
            if (r.success) {
              var imEl = document.getElementById('reminderImmediate');
              if (imEl) imEl.checked = (r.immediateNotify !== 'no');
              var entries = document.querySelectorAll('.reminder-entry');
              (r.reminders || []).forEach(function(rem, idx) {
                if (idx >= entries.length) return;
                var entry = entries[idx];
                entry.querySelector('.reminder-enabled').checked = !!rem.enabled;
                entry.querySelector('.reminder-days').value = rem.daysBefore || '';
                // 既存データ "HH:MM" → "HH:00" に正規化してselectに反映
                var t = rem.time || '09:00';
                var hour = ('0' + parseInt(t.split(':')[0], 10)).slice(-2);
                entry.querySelector('.reminder-time').value = hour + ':00';
              });
              // テンプレートフィールド
              document.getElementById('reminderSubject').value = r.reminderSubject || '';
              document.getElementById('reminderBody').value = r.reminderBody || '';
              document.getElementById('immediateSubject').value = r.immediateSubject || '';
              document.getElementById('immediateBody').value = r.immediateBody || '';
            }
          } catch (e) {}
        }).getReminderEmailSettings();
      }

      document.getElementById('btnSaveReminderEmail').addEventListener('click', function() {
        var btn = this;
        if (btn.disabled) return;
        var reminders = [];
        document.querySelectorAll('.reminder-entry').forEach(function(entry) {
          reminders.push({
            enabled: entry.querySelector('.reminder-enabled').checked,
            daysBefore: parseInt(entry.querySelector('.reminder-days').value, 10) || 0,
            time: entry.querySelector('.reminder-time').value || '09:00'
          });
        });
        var immediateNotify = document.getElementById('reminderImmediate').checked ? 'yes' : 'no';
        var templates = {
          reminderSubject: document.getElementById('reminderSubject').value,
          reminderBody: document.getElementById('reminderBody').value,
          immediateSubject: document.getElementById('immediateSubject').value,
          immediateBody: document.getElementById('immediateBody').value
        };
        btn.disabled = true;
        var origText = btn.textContent;
        btn.textContent = '保存中...';
        google.script.run.withSuccessHandler(function(jsonStr) {
          btn.disabled = false;
          btn.textContent = origText;
          var r = JSON.parse(jsonStr);
          alert(r.success ? '保存しました。' : (r.error || '失敗'));
        }).withFailureHandler(function() {
          btn.disabled = false;
          btn.textContent = origText;
          alert('保存に失敗しました。');
        }).setReminderEmailSettings(reminders, immediateNotify, templates);
      });

      document.getElementById('btnAddSync').addEventListener('click', function() {
        openSyncFormModal(null, '', '');
      });

      document.getElementById('btnSaveSyncForm').addEventListener('click', function() {
        var btn = this;
        if (btn.disabled) return;
        var rowIndex = document.getElementById('syncFormRowIndex').value;
        var name = document.getElementById('syncFormPlatformName').value.trim();
        var url = document.getElementById('syncFormIcalUrl').value.trim();
        var errEl = document.getElementById('syncFormError');
        if (!name) { errEl.textContent = 'プラットフォーム名を入力してください。'; errEl.style.display = 'block'; return; }
        errEl.style.display = 'none';
        btn.disabled = true;
        var origText = btn.textContent;
        btn.textContent = '保存中...';
        google.script.run.withSuccessHandler(function(j) {
          btn.disabled = false;
          btn.textContent = origText;
          var r = JSON.parse(j);
          if (r.success) {
            bootstrap.Modal.getInstance(document.getElementById('syncFormModal')).hide();
            loadSyncList();
          } else { errEl.textContent = r.error || '失敗'; errEl.style.display = 'block'; }
        }).withFailureHandler(function(e) { btn.disabled = false; btn.textContent = origText; errEl.textContent = e.message || 'エラー'; errEl.style.display = 'block'; }).setSyncSetting(rowIndex ? parseInt(rowIndex, 10) : null, name, url, 'Y');
      });

      document.getElementById('btnClearSynced').addEventListener('click', function() {
        customConfirm('iCal同期の紐付けを一括解除します。予約行・フォーム入力は残り、プラットフォーム表示のみクリアされます。実行しますか？').then(function(ok) {
          if (!ok) return;
          var btn = document.getElementById('btnClearSynced');
          var resEl = document.getElementById('syncResult');
          btn.disabled = true;
          resEl.style.display = 'none';
          google.script.run.withSuccessHandler(function(jsonStr) {
            try {
              var r = JSON.parse(jsonStr);
              resEl.style.display = 'block';
              resEl.className = 'small mt-2 ' + (r.success ? 'text-success' : 'text-danger');
              resEl.textContent = r.success ? (r.cleared + '件のiCal紐付けを解除しました。') : (r.error || '失敗');
              if (r.success && r.cleared > 0) loadAndRender();
            } catch (e) { resEl.textContent = 'エラー'; }
            btn.disabled = false;
          }).withFailureHandler(function(err) {
            resEl.style.display = 'block';
            resEl.className = 'small mt-2 text-danger';
            resEl.textContent = err.message || 'エラー';
            btn.disabled = false;
          }).clearSyncedBookings();
        });
      });
      document.getElementById('btnImportSpreadsheet').addEventListener('click', function() {
        document.getElementById('importSpreadsheetUrl').value = '';
        document.getElementById('importSkipDuplicates').checked = true;
        document.getElementById('importSpreadsheetError').style.display = 'none';
        new bootstrap.Modal(document.getElementById('importSpreadsheetModal')).show();
        setTimeout(function() { document.getElementById('importSpreadsheetUrl').focus(); }, 300);
      });
      document.getElementById('btnConfirmImportSpreadsheet').addEventListener('click', function() {
        var url = document.getElementById('importSpreadsheetUrl').value.trim();
        var skipDup = document.getElementById('importSkipDuplicates').checked;
        var errEl = document.getElementById('importSpreadsheetError');
        var btn = document.getElementById('btnConfirmImportSpreadsheet');
        if (!url) { errEl.textContent = 'スプレッドシートのURLを入力してください。'; errEl.style.display = 'block'; return; }
        errEl.style.display = 'none';
        btn.disabled = true;
        btn.textContent = '読み込み中...';
        google.script.run.withSuccessHandler(function(jsonStr) {
          btn.disabled = false;
          btn.textContent = '読み込み';
          var r = JSON.parse(jsonStr);
          if (r.success) {
            bootstrap.Modal.getInstance(document.getElementById('importSpreadsheetModal')).hide();
            document.getElementById('syncResult').style.display = 'block';
            document.getElementById('syncResult').className = 'small mt-2 text-success';
            document.getElementById('syncResult').textContent = r.imported + '件を読み込みました。' + (r.skipped ? '（' + r.skipped + '件は重複のためスキップ）' : '');
            if (r.imported > 0) loadAndRender();
          } else { errEl.textContent = r.error || '読み込みに失敗しました。'; errEl.style.display = 'block'; }
        }).withFailureHandler(function(err) {
          btn.disabled = false;
          btn.textContent = '読み込み';
          errEl.textContent = err.message || 'エラーが発生しました。スプシの共有設定（閲覧可）を確認してください。';
          errEl.style.display = 'block';
        }).importFromSpreadsheet(url, skipDup);
      });
      document.getElementById('btnRunSync').addEventListener('click', function() {
        var btn = document.getElementById('btnRunSync');
        var resEl = document.getElementById('syncResult');
        btn.disabled = true;
        resEl.style.display = 'none';
        google.script.run.withSuccessHandler(function(jsonStr) {
          try {
            var r = JSON.parse(jsonStr);
            resEl.style.display = 'block';
            resEl.className = 'small mt-2 ' + (r.success ? 'text-success' : 'text-danger');
            var summary = r.success ? (r.added + '件追加' + (r.removed ? ', ' + r.removed + '件削除（キャンセル等）' : '') + 'しました。') : (r.error || '失敗');
            var html = summary;
            if (r.details && r.details.length) {
              html += '<div class="mt-1">';
              r.details.forEach(function(d) {
                var s = '<strong>' + escapeHtml(d.platform) + '</strong>: 取得' + d.fetched + '件';
                if (d.added > 0) s += ', 追加' + d.added;
                if (d.removed > 0) s += ', 削除' + d.removed;
                if (d.error) s += ' <span class="text-danger">(' + escapeHtml(d.error) + ')</span>';
                html += '<div>' + s + '</div>';
              });
              html += '</div>';
            }
            resEl.innerHTML = html;
            if (r.success) {
              if (r.added > 0 || r.removed > 0) loadAndRender();
              loadSyncList();
            }
          } catch (e) { resEl.textContent = 'エラー'; }
          btn.disabled = false;
        }).withFailureHandler(function(err) {
          resEl.style.display = 'block';
          resEl.className = 'small mt-2 text-danger';
          resEl.textContent = err.message || 'エラー';
          btn.disabled = false;
        }).syncFromICal();
      });

      // 自動同期設定の読み込み・保存
      function loadAutoSyncSettings() {
        google.script.run.withSuccessHandler(function(jsonStr) {
          try {
            var r = JSON.parse(jsonStr);
            if (r.success) {
              document.getElementById('autoSyncEnabled').checked = !!r.enabled;
              document.getElementById('autoSyncInterval').value = String(r.intervalHours || 1);
            }
          } catch (e) {}
        }).getAutoSyncSettings();
      }

      document.getElementById('btnSaveAutoSync').addEventListener('click', function() {
        var btn = this;
        var resEl = document.getElementById('autoSyncSaveResult');
        var enabled = document.getElementById('autoSyncEnabled').checked;
        var interval = parseInt(document.getElementById('autoSyncInterval').value, 10) || 1;
        btn.disabled = true;
        resEl.style.display = 'none';
        google.script.run.withSuccessHandler(function(jsonStr) {
          var r = JSON.parse(jsonStr);
          resEl.style.display = 'block';
          resEl.className = 'small mt-1 ' + (r.success ? 'text-success' : 'text-danger');
          resEl.textContent = r.success ? (enabled ? interval + '時間ごとの自動同期を設定しました' : '自動同期を無効にしました') : (r.error || '保存に失敗しました');
          btn.disabled = false;
          setTimeout(function() { resEl.style.display = 'none'; }, 3000);
        }).withFailureHandler(function(err) {
          resEl.style.display = 'block';
          resEl.className = 'small mt-1 text-danger';
          resEl.textContent = err.message || '保存に失敗しました';
          btn.disabled = false;
        }).saveAutoSyncSettings(enabled, interval);
      });

      function doReloadData() {
        var btnSync = document.getElementById('btnReloadDataSync');
        if (btnSync) { btnSync.disabled = true; btnSync.textContent = '読み込み中...'; }
        new Promise(function(resolve) {
          google.script.run
            .withSuccessHandler(function(jsonStr) {
              try { resolve(JSON.parse(jsonStr)); }
              catch (e) { resolve({ success: false, error: 'レスポンスの解析に失敗しました。' }); }
            })
            .withFailureHandler(function(err) {
              resolve({ success: false, error: err.message || '通信エラー' });
            })
            .getInitData();
        }).then(function(res) {
          var recruitMap = res.recruitMap || {};
          if (!res.success) {
            alert(res.error || 'データの取得に失敗しました。');
          } else {
            allBookings = res.data || [];
            var events = buildCalendarEvents(allBookings, recruitMap);
            if (calendar) {
              var sources = calendar.getEventSources();
              sources.forEach(function(s) { s.remove(); });
              calendar.addEventSource(events);
            }
            if (btnSync) { btnSync.textContent = 'スプシを再読み込み'; }
          }
          if (btnSync) btnSync.disabled = false;
        }).catch(function() {
          if (btnSync) { btnSync.disabled = false; btnSync.textContent = 'スプシを再読み込み'; }
        });
      }
      document.getElementById('btnReloadDataSync').addEventListener('click', doReloadData);
      var btnTrim = document.getElementById('btnTrimSpreadsheet');
      if (btnTrim) {
        btnTrim.addEventListener('click', function() {
          var btn = this;
          var resEl = document.getElementById('trimResult');
          btn.disabled = true;
          btn.textContent = '最適化中…';
          resEl.style.display = 'block';
          resEl.textContent = '処理中…';
          resEl.style.color = '#666';
          google.script.run
            .withSuccessHandler(function(str) {
              var res = JSON.parse(str);
              if (res.success) {
                resEl.textContent = '完了: 約' + res.freedCells.toLocaleString() + 'セルを削減しました。';
                resEl.style.color = '#27ae60';
              } else {
                resEl.textContent = 'エラー: ' + (res.error || '不明');
                resEl.style.color = '#e74c3c';
              }
              btn.disabled = false;
              btn.textContent = 'スプレッドシートを最適化';
            })
            .withFailureHandler(function(e) {
              resEl.textContent = 'エラー: ' + (e.message || e);
              resEl.style.color = '#e74c3c';
              btn.disabled = false;
              btn.textContent = 'スプレッドシートを最適化';
            })
            .trimSpreadsheet();
        });
      }
      document.getElementById('btnAddBooking').addEventListener('click', function() {
        document.getElementById('addBookingCheckIn').value = '';
        document.getElementById('addBookingCheckOut').value = '';
        document.getElementById('addBookingGuestName').value = '';
        document.getElementById('addBookingSite').value = '';
        document.getElementById('addBookingGuestCount').value = '';
        document.getElementById('addBookingError').style.display = 'none';
        new bootstrap.Modal(document.getElementById('addBookingModal')).show();
      });

      document.getElementById('btnConfirmAddBooking').addEventListener('click', function() {
        var checkIn = document.getElementById('addBookingCheckIn').value;
        var checkOut = document.getElementById('addBookingCheckOut').value;
        var guestName = document.getElementById('addBookingGuestName').value.trim();
        var site = document.getElementById('addBookingSite').value.trim();
        var guestCount = document.getElementById('addBookingGuestCount').value.trim();
        var errEl = document.getElementById('addBookingError');
        if (!checkIn || !checkOut) {
          errEl.textContent = 'チェックイン・チェックアウトを入力してください。';
          errEl.style.display = 'block';
          return;
        }
        errEl.style.display = 'none';
        google.script.run.withSuccessHandler(function(jsonStr) {
          try {
            var r = JSON.parse(jsonStr);
            if (r.success) {
              bootstrap.Modal.getInstance(document.getElementById('addBookingModal')).hide();
              loadAndRender();
              alert('予約を追加しました。');
            } else {
              errEl.textContent = r.error || '失敗';
              errEl.style.display = 'block';
            }
          } catch (e) {
            errEl.textContent = 'エラー';
            errEl.style.display = 'block';
          }
        }).withFailureHandler(function(err) {
          errEl.textContent = err.message || 'エラー';
          errEl.style.display = 'block';
        }).addBookingManually(checkIn, checkOut, guestName, site, guestCount);
      });

      document.getElementById('btnAddSelectStaff').addEventListener('click', function() {
        var sel = document.getElementById('recruitSelectStaffDropdown');
        var name = (sel.value || '').trim();
        if (!name || name === '__other__') return;
        window._recruitSelectStaffNames = window._recruitSelectStaffNames || [];
        if (window._recruitSelectStaffNames.indexOf(name) >= 0) return;
        window._recruitSelectStaffNames.push(name);
        renderRecruitSelectStaffList();
      });
      document.getElementById('btnAddSelectOther').addEventListener('click', function() {
        var input = document.getElementById('recruitSelectOtherName');
        var name = (input && input.value || '').trim();
        if (!name) return;
        window._recruitSelectStaffNames = window._recruitSelectStaffNames || [];
        if (window._recruitSelectStaffNames.indexOf(name) >= 0) return;
        window._recruitSelectStaffNames.push(name);
        renderRecruitSelectStaffList();
        if (input) input.value = '';
      });

      var btnConfirmSelectEl = document.getElementById('btnConfirmSelect');
      btnConfirmSelectEl.addEventListener('click', function() {
        var row = parseInt(document.getElementById('recruitSelectRowIndex').value, 10);
        var staff = (window._recruitSelectStaffNames || []).join(',').trim();
        var errEl = document.getElementById('recruitSelectError');
        if (!staff) {
          errEl.textContent = 'スタッフを1名以上選んでください。';
          errEl.style.display = 'block';
          return;
        }
        errEl.style.display = 'none';
        setButtonLoading(btnConfirmSelectEl, true);
        google.script.run.withSuccessHandler(function(jsonStr) {
          setButtonLoading(btnConfirmSelectEl, false);
          try {
            var r = JSON.parse(jsonStr);
            if (r.success) {
              // スタッフ選定成功 → 確定するか確認
              customConfirm('スタッフを選定しました。\n続けて募集を締め切り、確定しますか？\n\n「OK」→ 確定（募集締切）\n「キャンセル」→ 後で確定').then(function(ok) {
                if (ok) {
                  google.script.run.withSuccessHandler(function(cj) {
                    var cr = JSON.parse(cj);
                    if (cr.success) applyConfirmOptimistic(row, window._recruitSelectBookingRow || 0, staff);
                    loadRecruitList();
                    loadAndRender();
                    if (cr.success) {
                      var modalBody = document.querySelector('#recruitSelectModal .modal-body');
                      showConfirmationNotifyUI(modalBody, row, 'recruitSelectModal');
                    } else {
                      bootstrap.Modal.getInstance(document.getElementById('recruitSelectModal')).hide();
                      alert('確定に失敗しました: ' + (cr.error || ''));
                    }
                  }).withFailureHandler(function(ce) {
                    bootstrap.Modal.getInstance(document.getElementById('recruitSelectModal')).hide();
                    loadRecruitList();
                    loadAndRender();
                    alert('確定に失敗しました: ' + ce.message);
                  }).confirmRecruitment(row);
                } else {
                  bootstrap.Modal.getInstance(document.getElementById('recruitSelectModal')).hide();
                  loadRecruitList();
                  loadAndRender();
                }
              });
            } else {
              errEl.textContent = r.error || '失敗';
              errEl.style.display = 'block';
            }
          } catch (e) { errEl.style.display = 'block'; }
        }).withFailureHandler(function(err) {
          setButtonLoading(btnConfirmSelectEl, false);
          errEl.textContent = err.message || 'エラー';
          errEl.style.display = 'block';
        }).selectStaffForRecruitment(row, staff);
      });

      // 設定サブタブ
      document.querySelectorAll('[data-subtab]').forEach(function(a) {
        a.addEventListener('click', function(e) {
          e.preventDefault();
          var t = this.getAttribute('data-subtab');
          document.querySelectorAll('[data-subtab]').forEach(function(l) { l.classList.remove('active'); });
          this.classList.add('active');
          document.getElementById('settingsStaff').style.display = t === 'staff' ? 'block' : 'none';
          document.getElementById('settingsSubOwners').style.display = t === 'subOwners' ? 'block' : 'none';
          document.getElementById('settingsJobs').style.display = t === 'jobs' ? 'block' : 'none';
          document.getElementById('settingsRecruitSettings').style.display = t === 'recruitSettings' ? 'block' : 'none';
          var reminderEl = document.getElementById('settingsReminderEmail');
          if (reminderEl) reminderEl.style.display = t === 'reminderEmail' ? 'block' : 'none';
          var rrEl = document.getElementById('settingsRosterReminder');
          if (rrEl) rrEl.style.display = t === 'rosterReminder' ? 'block' : 'none';
          document.getElementById('settingsSync').style.display = t === 'sync' ? 'block' : 'none';
          var notifEl = document.getElementById('settingsNotifications');
          if (notifEl) notifEl.style.display = t === 'notifications' ? 'block' : 'none';
          var invoiceEl = document.getElementById('settingsInvoice');
          if (invoiceEl) invoiceEl.style.display = t === 'invoice' ? 'block' : 'none';
          var maintEl = document.getElementById('settingsMaintenance');
          if (maintEl) maintEl.style.display = t === 'maintenance' ? 'block' : 'none';
          if (t === 'staff') loadStaffList();
          if (t === 'jobs') loadJobList();
          if (t === 'recruitSettings') loadRecruitSettingsForm();
          if (t === 'reminderEmail') loadReminderEmailSettings();
          if (t === 'rosterReminder') loadRosterReminderSettings();
          if (t === 'sync') { loadSyncList(); loadAutoSyncSettings(); }
          if (t === 'subOwners') loadSubOwnerList();
          if (t === 'notifications') loadNotificationList();
          if (t === 'invoice') loadInvoiceSettings_();
        });
      });

      // ログインユーザー情報（回答・オーナー判定に使用）
      window.currentUserEmail = '';
      window.currentUserName = '';
      window.isOwnerUser = !window.staffMode; // デフォルト: オーナーURL→true, スタッフURL→false
      function populateStaffSelectOptions(targetId) {
        google.script.run
          .withSuccessHandler(function(sStr) {
            try {
              var s = JSON.parse(sStr);
              var el = document.getElementById(targetId);
              if (!el) return;
              if (s.success && s.list && s.list.length) {
                el.innerHTML = '<option value="">-- 選択 --</option>';
                s.list.forEach(function(st) {
                  var label = st.name || st.email;
                  el.innerHTML += '<option value="' + escapeHtml(st.name || '') + '|' + escapeHtml(st.email || '') + '" data-has-pw="' + (st.hasPassword ? '1' : '0') + '">' + escapeHtml(label) + '</option>';
                });
              } else if (s.success && (!s.list || s.list.length === 0)) {
                el.innerHTML = '<option value="">（スタッフ未登録）</option>';
                console.warn('スタッフリスト: 登録データが0件です');
              } else {
                el.innerHTML = '<option value="">（読み込み失敗: ' + escapeHtml(s.error || '原因不明') + '）</option>';
                console.error('スタッフリスト読み込みエラー:', s.error);
              }
            } catch (e) {
              console.error('スタッフリストのパースエラー:', e);
              var el = document.getElementById(targetId);
              if (el) el.innerHTML = '<option value="">（パースエラー: ' + escapeHtml(String(e)) + '）</option>';
            }
          })
          .withFailureHandler(function(err) {
            console.error('スタッフリスト取得失敗:', err);
            var el = document.getElementById(targetId);
            if (el) el.innerHTML = '<option value="">（サーバーエラー: ' + escapeHtml(String(err.message || err)) + '）</option>';
          })
          .getStaffNamesForSelection();
      }
      function applyStaffSelection(name, email) {
        window.currentUserName = (name || '').trim();
        window.currentUserEmail = (email || '').trim();
        try {
          sessionStorage.setItem('staffSelected', JSON.stringify({ name: window.currentUserName, email: window.currentUserEmail }));
        } catch (e) {}
        var disp = document.getElementById('staffDisplayName');
        var badge = document.getElementById('currentAccountBadge');
        if (disp && disp.style.display !== 'none') {
          disp.textContent = window.currentUserName || window.currentUserEmail || '--';
          if (badge) badge.style.display = 'none';
        } else if (badge) {
          badge.textContent = window.currentUserName || (window.currentUserEmail ? window.currentUserEmail.split('@')[0] : '');
          badge.style.display = badge.textContent ? '' : 'none';
        }
        // カレンダーの赤枠（応募状況）を反映するためイベントを再構築
        if (typeof calendar !== 'undefined' && calendar && typeof allBookings !== 'undefined' && allBookings && allBookings.length) {
          var sources = calendar.getEventSources();
          sources.forEach(function(s) { s.remove(); });
          var newEvents = buildCalendarEvents(allBookings, window._recruitFullMap || {});
          calendar.addEventSource(newEvents);
          calendar.render();
        }
      }
      function showStaffSelectOverlay() {
        if (!window.staffMode) return;
        var ov = document.getElementById('staffSelectOverlay');
        if (ov) {
          ov.style.setProperty('display', 'flex', 'important');
          populateStaffSelectOptions('staffSelectModalSelect');
          var sel = document.getElementById('staffSelectModalSelect');
          if (sel && window.currentUserName) {
            var opts = sel.querySelectorAll('option');
            for (var i = 0; i < opts.length; i++) {
              var v = (opts[i].value || '').split('|');
              if ((v[0] || '').trim() === window.currentUserName) { sel.selectedIndex = i; break; }
            }
          }
        }
      }
      function hideStaffSelectOverlay() {
        var ov = document.getElementById('staffSelectOverlay');
        if (ov) ov.style.setProperty('display', 'none', 'important');
      }
      function showStaffSelectorAndHideTabs() {
        if (!window.staffMode) return;
        window.isOwnerUser = false;
        var bar = document.getElementById('staffSelectorBar');
        if (bar) bar.style.display = 'block';
        var navSet = document.getElementById('navSettings');
        var navTest = document.getElementById('navStaffTest');
        if (navSet) navSet.style.display = 'none';
        if (navTest) navTest.style.display = 'none';
        populateStaffSelectOptions('staffNameSelect');
        var disp = document.getElementById('staffDisplayName');
        if (disp) {
          disp.textContent = window.currentUserName || window.currentUserEmail || '--';
          disp.style.display = '';
        }
        var changeBtn = document.getElementById('btnStaffChange');
        if (changeBtn) changeBtn.style.display = '';
        var saved = null;
        try { saved = JSON.parse(sessionStorage.getItem('staffSelected') || 'null'); } catch (e) {}
        if (saved && (saved.name || saved.email)) {
          applyStaffSelection(saved.name, saved.email);
        }
        if (window.staffMode && !window.currentUserName && !window.currentUserEmail) {
          showStaffSelectOverlay();
        }
        if (changeBtn && !changeBtn.dataset.listen) {
          changeBtn.dataset.listen = '1';
          changeBtn.addEventListener('click', showStaffSelectOverlay);
        }
      }
      // スタッフ選択時にパスワード欄の表示切り替え
      var staffModalSelect = document.getElementById('staffSelectModalSelect');
      if (staffModalSelect) {
        staffModalSelect.addEventListener('change', function() {
          var pwArea = document.getElementById('staffPasswordArea');
          var pwInput = document.getElementById('staffPasswordInput');
          var pwMsg = document.getElementById('staffPasswordMsg');
          var setPwBtn = document.getElementById('staffSetPasswordBtn');
          if (!pwArea) return;
          var opt = this.options[this.selectedIndex];
          var hasPw = opt && opt.dataset.hasPw === '1';
          // パスワード機能一時無効化（将来的にオーナー設定で切り替え予定）
          pwArea.style.display = 'none';
          if (setPwBtn) setPwBtn.style.display = 'none';
          if (pwInput) { pwInput.value = ''; pwInput.placeholder = hasPw ? 'パスワードを入力' : '新しいパスワードを設定（4文字以上）'; }
          if (pwMsg) pwMsg.style.display = 'none';
        });
      }
      var staffConfirmBtn = document.getElementById('staffSelectModalConfirm');
      if (staffConfirmBtn && !staffConfirmBtn.dataset.listen) {
        staffConfirmBtn.dataset.listen = '1';
        staffConfirmBtn.addEventListener('click', function() {
          var sel = document.getElementById('staffSelectModalSelect');
          var v = (sel && sel.value || '').split('|');
          if (!v[0] && !v[1]) { alert('お名前を選択してください'); return; }
          var opt = sel.options[sel.selectedIndex];
          // パスワード機能一時無効化（将来的にオーナー設定で切り替え予定）
          // パスワードなしで続行
          applyStaffSelection(v[0] || '', v[1] || '');
          hideStaffSelectOverlay();
          var disp = document.getElementById('staffDisplayName');
          if (disp) disp.textContent = window.currentUserName || window.currentUserEmail || '--';
          loadStaffSchedule();
          loadInvoiceData();
          // ディープリンク: スタッフ選択後にペンディングのモーダルを開く
          if (window._pendingDeepLinkDate) {
            var dd = window._pendingDeepLinkDate;
            window._pendingDeepLinkDate = null;
            setTimeout(function() { openCleaningModalByDate(dd); }, 300);
          }
        });
      }
      // パスワード変更ボタン
      var setPwBtn = document.getElementById('staffSetPasswordBtn');
      if (setPwBtn) {
        setPwBtn.addEventListener('click', function() {
          var sel = document.getElementById('staffSelectModalSelect');
          var v = (sel && sel.value || '').split('|');
          if (!v[0]) { alert('まず名前を選択してください'); return; }
          var opt = sel.options[sel.selectedIndex];
          var hasPw = opt && opt.dataset.hasPw === '1';
          var oldPw = hasPw ? prompt('現在のパスワードを入力してください') : '';
          if (hasPw && oldPw === null) return;
          var newPw = prompt('新しいパスワードを入力してください（4文字以上）');
          if (!newPw) return;
          if (newPw.length < 4) { alert('パスワードは4文字以上で設定してください'); return; }
          google.script.run.withSuccessHandler(function(j) {
            var res = JSON.parse(j);
            if (res.success) { alert('パスワードを変更しました'); if (opt) opt.dataset.hasPw = '1'; }
            else alert(res.error || '失敗');
          }).withFailureHandler(function(e) { alert(e.message); }).setStaffPassword(v[0] || '', v[1] || '', oldPw || '', newPw);
        });
      }
      google.script.run.withSuccessHandler(function(jsonStr) {
        try {
          var r = JSON.parse(jsonStr);
          if (r.success) {
            if (window.staffMode) {
              showStaffSelectorAndHideTabs();
            } else if (r.email) {
              window.currentUserEmail = r.email;
              var badge = document.getElementById('currentAccountBadge');
              if (badge && (r.displayName || r.email)) {
                badge.textContent = r.displayName || (r.email ? r.email.split('@')[0] : '');
                badge.style.display = badge.textContent ? '' : 'none';
              }
            }
            // オーナーURLでメールが取得できない場合（ANYONE_ANONYMOUS）は
            // getOwnerAndSwitchUrl のコールバックでタブ表示を制御する
          }
        } catch (e) {}
      }).getCurrentUserEmail();
      google.script.run.withSuccessHandler(function(jsonStr) {
        try {
          var r = JSON.parse(jsonStr);
          if (r.success && r.name) {
            if (!window.staffMode) {
              window.currentUserName = r.name;
            } else {
              // スタッフモードでは Execute as: Me のためサーバーは常にオーナーを返す。
              // ポップアップを閉じず、ユーザー自身に選択させる。
            }
          }
        } catch (e) {}
      }).getMyStaffName();
      google.script.run.withSuccessHandler(function(jsonStr) {
        try {
          var r = JSON.parse(jsonStr);
          if (r.success && r.isOwner && !window.staffMode) window.isOwnerUser = true;
        } catch (e) {}
      }).isOwner();


      // ==========================================
      // クリーニング連絡カード
      // ==========================================
      function renderCleaningLaundryCard(container, checkoutDate, isStaffView) {
        container.innerHTML = '<div class="modal-next-res-card" style="margin-top:0.5rem;"><span class="recruit-status-badge" style="background:#6c757d;color:#fff;"><i class="bi bi-basket2"></i> クリーニング状況</span><div class="text-muted small text-center"><span class="spinner-border spinner-border-sm me-1" style="width:0.7rem;height:0.7rem;border-width:0.12em;" role="status"></span>読み込み中…</div></div>';
        google.script.run
          .withSuccessHandler(function(resStr) {
            try {
              var res = JSON.parse(resStr);
              if (!res.success) { container.innerHTML = ''; return; }
              buildLaundryCardHtml(container, checkoutDate, res.data, isStaffView);
            } catch (e) { container.innerHTML = ''; console.error('laundry card error:', e); }
          })
          .withFailureHandler(function(e) { container.innerHTML = ''; console.error('getCleaningLaundryStatus failed:', e); })
          .getCleaningLaundryStatus(checkoutDate);
      }

      function buildLaundryCardHtml(container, checkoutDate, data, isStaffView) {
        var d = data || {};
        var hasSent = !!d.sentBy;
        var hasReceived = !!d.receivedBy;
        var hasReturned = !!d.returnedBy;

        var html = '<div class="modal-next-res-card" style="margin-top:0.5rem;">';
        html += '<span class="recruit-status-badge" style="background:#6c757d;color:#fff;"><i class="bi bi-basket2"></i> クリーニング状況</span>';

        // 最後に完了したステップを判定（そのステップのみ取消可能）
        var lastCompletedStep = hasReturned ? 'returned' : (hasReceived ? 'received' : (hasSent ? 'sent' : null));

        // ステップ1: 出す
        html += '<div class="mt-2" style="display:flex;align-items:center;gap:0.5rem;min-height:2rem;">';
        html += '<span class="badge ' + (hasSent ? 'bg-success' : 'bg-secondary') + '" style="width:1.5rem;height:1.5rem;display:inline-flex;align-items:center;justify-content:center;border-radius:50%;font-size:0.75rem;">' + (hasSent ? '<i class="bi bi-check"></i>' : '1') + '</span>';
        if (hasSent) {
          html += '<span class="small flex-grow-1">' + formatLaundryTime(d.sentAt) + '　' + escapeHtml(d.sentBy) + '</span>';
          if (lastCompletedStep === 'sent') {
            html += '<button type="button" class="btn btn-sm btn-outline-secondary py-0 px-1" style="font-size:0.7rem;" onclick="cancelLaundryStep(\'' + escapeHtml(checkoutDate) + '\', \'sent\', this)">取消</button>';
          }
        } else {
          html += '<button type="button" class="btn btn-sm btn-warning flex-grow-1" id="btnLaundrySent" style="color:#000;font-weight:600;" onclick="confirmLaundryStep(\'' + escapeHtml(checkoutDate) + '\', \'sent\', this)"><i class="bi bi-box-arrow-up-right me-1"></i>クリーニングに出した</button>';
        }
        html += '</div>';

        // ステップ2: 受取
        html += '<div class="mt-1" style="display:flex;align-items:center;gap:0.5rem;min-height:2rem;">';
        html += '<span class="badge ' + (hasReceived ? 'bg-success' : 'bg-secondary') + '" style="width:1.5rem;height:1.5rem;display:inline-flex;align-items:center;justify-content:center;border-radius:50%;font-size:0.75rem;">' + (hasReceived ? '<i class="bi bi-check"></i>' : '2') + '</span>';
        if (hasReceived) {
          html += '<span class="small flex-grow-1">' + formatLaundryTime(d.receivedAt) + '　' + escapeHtml(d.receivedBy) + '</span>';
          if (lastCompletedStep === 'received') {
            html += '<button type="button" class="btn btn-sm btn-outline-secondary py-0 px-1" style="font-size:0.7rem;" onclick="cancelLaundryStep(\'' + escapeHtml(checkoutDate) + '\', \'received\', this)">取消</button>';
          }
        } else if (hasSent) {
          html += '<button type="button" class="btn btn-sm btn-warning flex-grow-1" id="btnLaundryReceived" style="color:#000;font-weight:600;" onclick="confirmLaundryStep(\'' + escapeHtml(checkoutDate) + '\', \'received\', this)"><i class="bi bi-box-arrow-in-down me-1"></i>受け取った</button>';
        } else {
          html += '<span class="small text-muted">受け取り（出した後に有効）</span>';
        }
        html += '</div>';

        // ステップ3: 施設に戻す
        html += '<div class="mt-1" style="display:flex;align-items:center;gap:0.5rem;min-height:2rem;">';
        html += '<span class="badge ' + (hasReturned ? 'bg-success' : 'bg-secondary') + '" style="width:1.5rem;height:1.5rem;display:inline-flex;align-items:center;justify-content:center;border-radius:50%;font-size:0.75rem;">' + (hasReturned ? '<i class="bi bi-check"></i>' : '3') + '</span>';
        if (hasReturned) {
          html += '<span class="small flex-grow-1">' + formatLaundryTime(d.returnedAt) + '　' + escapeHtml(d.returnedBy) + '</span>';
          if (lastCompletedStep === 'returned') {
            html += '<button type="button" class="btn btn-sm btn-outline-secondary py-0 px-1" style="font-size:0.7rem;" onclick="cancelLaundryStep(\'' + escapeHtml(checkoutDate) + '\', \'returned\', this)">取消</button>';
          }
        } else if (hasReceived) {
          html += '<button type="button" class="btn btn-sm btn-warning flex-grow-1" id="btnLaundryReturned" style="color:#000;font-weight:600;" onclick="confirmLaundryStep(\'' + escapeHtml(checkoutDate) + '\', \'returned\', this)"><i class="bi bi-house-check me-1"></i>施設に戻した</button>';
        } else {
          html += '<span class="small text-muted">施設に戻す（受取後に有効）</span>';
        }
        html += '</div>';

        html += '</div>';
        container.innerHTML = html;
      }

      function formatLaundryTime(dtStr) {
        if (!dtStr) return '';
        var days = ['日','月','火','水','木','金','土'];
        // "2026-02-15 11:30" → "2026/2/15(日)11:30"
        var m = String(dtStr).match(/(\d{4})-(\d{1,2})-(\d{1,2})\s+(\d{1,2}:\d{2})/);
        if (m) {
          var dt = new Date(parseInt(m[1],10), parseInt(m[2],10)-1, parseInt(m[3],10));
          var dow = days[dt.getDay()];
          return m[1] + '/' + parseInt(m[2],10) + '/' + parseInt(m[3],10) + '(' + dow + ')' + m[4];
        }
        // フォールバック: Date文字列をパース
        var d = new Date(dtStr);
        if (!isNaN(d.getTime())) {
          var dow = days[d.getDay()];
          return d.getFullYear() + '/' + (d.getMonth()+1) + '/' + d.getDate() + '(' + dow + ')' + d.getHours() + ':' + String(d.getMinutes()).padStart(2,'0');
        }
        return dtStr;
      }

      window.confirmLaundryStep = function(checkoutDate, step, btn) {
        var staffName = window.currentUserName || '';
        if (!staffName) {
          // alert()もiOS Safariでブロックされる可能性があるためUI表示に変更
          var area = document.getElementById('laundryCardArea');
          if (area) {
            var msg = document.createElement('div');
            msg.className = 'alert alert-warning small py-1 mt-1';
            msg.textContent = 'スタッフ名が取得できません。画面を再読み込みしてください。';
            area.appendChild(msg);
            setTimeout(function() { msg.remove(); }, 4000);
          }
          return;
        }
        var labels = { sent: 'クリーニングに出した', received: '受け取った', returned: '施設に戻した' };
        // confirm()はiOS SafariのGASフレーム内でブロックされることがあるため
        // 1回目タップで確認表示、2回目で実行する方式に変更
        if (!btn._confirmReady) {
          btn._confirmReady = true;
          btn._origText = btn.innerHTML;
          btn._origColor = btn.style.color;
          btn.innerHTML = '<i class="bi bi-exclamation-triangle me-1"></i>' + staffName + 'として記録？もう一度タップ';
          btn.classList.remove('btn-warning');
          btn.classList.add('btn-danger');
          btn.style.color = '#fff';
          setTimeout(function() {
            if (btn._confirmReady) {
              btn._confirmReady = false;
              btn.innerHTML = btn._origText;
              btn.classList.remove('btn-danger');
              btn.classList.add('btn-warning');
              btn.style.color = btn._origColor || '#000';
            }
          }, 5000);
          return;
        }
        btn._confirmReady = false;
        setButtonLoading(btn, true);
        google.script.run
          .withSuccessHandler(function(resStr) {
            try {
              var res = JSON.parse(resStr);
              if (res.success) {
                var area = document.getElementById('laundryCardArea');
                if (area) renderCleaningLaundryCard(area, checkoutDate, window.staffMode);
              } else {
                btn.textContent = 'エラー: ' + (res.error || '不明なエラー');
                btn.classList.add('btn-danger');
                setButtonLoading(btn, false);
              }
            } catch (e) { btn.textContent = 'エラーが発生しました'; setButtonLoading(btn, false); }
          })
          .withFailureHandler(function(e) { btn.textContent = '通信エラー'; setButtonLoading(btn, false); })
          .recordCleaningLaundryStep(checkoutDate, step, staffName);
      };

      window.resetLaundry = function(checkoutDate, btn) {
        if (!btn._confirmReady) {
          btn._confirmReady = true;
          btn._origText = btn.innerHTML;
          btn.innerHTML = '本当にリセット？もう一度タップ';
          btn.classList.remove('btn-outline-secondary');
          btn.classList.add('btn-danger');
          setTimeout(function() {
            if (btn._confirmReady) {
              btn._confirmReady = false;
              btn.innerHTML = btn._origText;
              btn.classList.remove('btn-danger');
              btn.classList.add('btn-outline-secondary');
            }
          }, 5000);
          return;
        }
        btn._confirmReady = false;
        setButtonLoading(btn, true);
        google.script.run
          .withSuccessHandler(function(resStr) {
            try {
              var res = JSON.parse(resStr);
              if (res.success) {
                var area = document.getElementById('laundryCardArea');
                if (area) renderCleaningLaundryCard(area, checkoutDate, window.staffMode);
              } else {
                btn.textContent = 'エラー: ' + (res.error || '');
                setButtonLoading(btn, false);
              }
            } catch (e) { btn.textContent = 'エラーが発生しました'; setButtonLoading(btn, false); }
          })
          .withFailureHandler(function(e) { btn.textContent = '通信エラー'; setButtonLoading(btn, false); })
          .resetCleaningLaundry(checkoutDate);
      };

      window.cancelLaundryStep = function(checkoutDate, step, btn) {
        var labels = { sent: 'クリーニングに出した', received: '受け取った', returned: '施設に戻した' };
        if (!btn._confirmReady) {
          btn._confirmReady = true;
          btn._origText = btn.innerHTML;
          btn.textContent = '「' + labels[step] + '」を取消？もう一度タップ';
          btn.classList.remove('btn-outline-secondary');
          btn.classList.add('btn-danger');
          setTimeout(function() {
            if (btn._confirmReady) {
              btn._confirmReady = false;
              btn.innerHTML = btn._origText;
              btn.classList.remove('btn-danger');
              btn.classList.add('btn-outline-secondary');
            }
          }, 5000);
          return;
        }
        btn._confirmReady = false;
        setButtonLoading(btn, true);
        google.script.run
          .withSuccessHandler(function(resStr) {
            try {
              var res = JSON.parse(resStr);
              if (res.success) {
                var area = document.getElementById('laundryCardArea');
                if (area) renderCleaningLaundryCard(area, checkoutDate, window.staffMode);
              } else {
                btn.textContent = 'エラー: ' + (res.error || '不明なエラー');
                setButtonLoading(btn, false);
              }
            } catch (e) { btn.textContent = 'エラーが発生しました'; setButtonLoading(btn, false); }
          })
          .withFailureHandler(function(e) { btn.textContent = '通信エラー'; setButtonLoading(btn, false); })
          .cancelCleaningLaundryStep(checkoutDate, step);
      };

      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
      } else {
        init();
      }
    })();
  </script>
</body>
</html>
