<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>æ¸…æƒãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      background: #f5f5f5;
      color: #333;
      padding-bottom: 120px;
      -webkit-tap-highlight-color: transparent;
    }

    /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
    .header {
      background: #2c3e50;
      color: white;
      padding: 12px 16px;
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .header-top {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }
    .header-left { flex: 1; }
    .header-title { font-size: 18px; font-weight: bold; margin-bottom: 4px; }
    .header-date { font-size: 14px; opacity: 0.9; }
    .progress-bar {
      height: 6px;
      background: rgba(255,255,255,0.2);
      border-radius: 3px;
      margin-top: 8px;
      overflow: hidden;
    }
    .progress-fill {
      height: 100%;
      background: #27ae60;
      transition: width 0.3s;
      border-radius: 3px;
    }

    /* ã‚¹ã‚¿ãƒƒãƒ•é¸æŠ */
    .staff-selector {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 4px;
    }
    .staff-selector-label {
      font-size: 11px;
      opacity: 0.8;
      text-align: right;
      margin-bottom: 2px;
      letter-spacing: 0.5px;
    }
    .staff-row {
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .staff-select {
      padding: 6px 10px;
      border-radius: 6px;
      border: 2px solid rgba(255,255,255,0.5);
      background: rgba(255,255,255,0.2);
      color: white;
      font-size: 14px;
      font-weight: bold;
      min-width: 140px;
    }
    .staff-select option { color: #333; background: white; }
    .staff-add-btn, .staff-remove-btn {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      border: 2px solid rgba(255,255,255,0.5);
      background: rgba(255,255,255,0.15);
      color: white;
      font-size: 16px;
      line-height: 1;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .staff-remove-btn { font-size: 14px; }

    /* ã‚¿ãƒ–ãƒŠãƒ“ï¼ˆç”»é¢ä¸‹éƒ¨å›ºå®šï¼‰ */
    .tab-nav {
      display: flex;
      background: white;
      border-top: 2px solid #ecf0f1;
      position: fixed;
      bottom: 52px;
      left: 0;
      right: 0;
      z-index: 100;
      box-shadow: 0 -2px 8px rgba(0,0,0,0.1);
    }
    .tab-nav-btn {
      flex: 1;
      padding: 12px 8px;
      border: none;
      background: white;
      font-size: 14px;
      font-weight: bold;
      color: #7f8c8d;
      cursor: pointer;
      border-top: 3px solid transparent;
      transition: all 0.2s;
    }
    .tab-nav-btn.active {
      color: #2c3e50;
      border-top-color: #3498db;
    }
    .tab-nav-btn .tab-badge {
      display: inline-block;
      padding: 1px 6px;
      border-radius: 10px;
      font-size: 11px;
      font-weight: bold;
      margin-left: 4px;
      vertical-align: middle;
    }
    .tab-badge-warning {
      background: #ffc107;
      color: #856404;
    }
    .tab-content { display: none; }
    .tab-content.active { display: block; }

    /* æ¬¡å›äºˆç´„æƒ…å ± */
    .booking-info {
      background: white;
      margin: 12px;
      padding: 16px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .booking-info h3 {
      font-size: 16px;
      color: #2c3e50;
      margin-bottom: 12px;
      padding-bottom: 8px;
      border-bottom: 2px solid #3498db;
    }
    .booking-row {
      display: flex;
      padding: 6px 0;
      font-size: 14px;
    }
    .booking-label {
      font-weight: bold;
      min-width: 100px;
      color: #555;
    }
    .booking-value {
      flex: 1;
      color: #333;
    }

    /* ã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆéƒ¨å±‹ã”ã¨ï¼‰ */
    .section {
      background: white;
      margin: 8px 12px;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 4px rgba(0,0,0,0.08);
    }
    .section-header {
      padding: 14px 16px;
      background: #ecf0f1;
      display: flex;
      align-items: center;
      cursor: pointer;
      user-select: none;
      -webkit-user-select: none;
      transition: background 0.2s;
    }
    .section-header:active {
      background: #d5dbdd;
    }
    .section-header.has-missing {
      background: #ffe6e6;
    }
    .section-icon {
      font-size: 20px;
      margin-right: 8px;
      transition: transform 0.3s;
    }
    .section-header.collapsed .section-icon {
      transform: rotate(-90deg);
    }
    .section-title {
      flex: 1;
      font-size: 16px;
      font-weight: bold;
      color: #2c3e50;
    }
    .section-title.missing {
      color: #e74c3c;
    }
    .section-count {
      font-size: 13px;
      color: #7f8c8d;
      margin-left: 8px;
    }
    .section-body {
      max-height: 2000px;
      overflow: hidden;
      transition: max-height 0.3s ease-out;
    }
    .section-body.collapsed {
      max-height: 0;
    }

    /* ä¸­ã‚«ãƒ†ã‚´ãƒªï¼ˆã‚µãƒ–ã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼‰ */
    .sub-section {
      margin-left: 12px;
      border-left: 3px solid #3498db;
    }
    .sub-section .section-header {
      padding: 10px 14px;
      background: #f0f4f8;
      font-size: 14px;
    }
    .sub-section .section-header:active {
      background: #dce3ea;
    }
    .sub-section .section-header.has-missing {
      background: #fff0f0;
    }
    .sub-section .section-title {
      font-size: 14px;
      font-weight: 600;
    }
    .sub-section .section-count {
      font-size: 12px;
    }

    /* ã‚»ã‚¯ã‚·ãƒ§ãƒ³ãƒ˜ãƒƒãƒ€ãƒ¼å†…ãƒœã‚¿ãƒ³ */
    .section-header-btn {
      padding: 4px 10px;
      border: 1px solid;
      border-radius: 4px;
      background: transparent;
      font-size: 11px;
      font-weight: bold;
      cursor: pointer;
      margin-left: 6px;
      white-space: nowrap;
    }
    .section-check-all {
      border-color: #27ae60;
      color: #27ae60;
    }
    .section-check-all:active { background: #eafaf1; }


    /* ãƒã‚§ãƒƒã‚¯é …ç›® */
    .checklist-item {
      padding: 12px 16px;
      border-bottom: 1px solid #ecf0f1;
      display: flex;
      align-items: flex-start;
      gap: 12px;
    }
    .checklist-item:last-child {
      border-bottom: none;
    }
    .item-checkbox {
      width: 24px;
      height: 24px;
      min-width: 24px;
      cursor: pointer;
      margin-top: 2px;
    }
    .item-content {
      flex: 1;
    }
    .item-name {
      font-size: 15px;
      color: #333;
      line-height: 1.5;
    }
    .item-name.missing {
      color: #e74c3c;
      font-weight: bold;
    }
    .supply-checkbox-container {
      margin-top: 6px;
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 13px;
      color: #7f8c8d;
    }
    .supply-checkbox {
      width: 18px;
      height: 18px;
      cursor: pointer;
    }

    /* æ’®å½±ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
    .photo-section {
      background: white;
      margin: 8px 12px;
      padding: 16px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.08);
    }
    .photo-section h3 {
      font-size: 16px;
      color: #2c3e50;
      margin-bottom: 12px;
      padding-bottom: 8px;
      border-bottom: 2px solid #e67e22;
    }
    .photo-spot {
      margin-bottom: 16px;
      padding: 12px;
      background: #fafafa;
      border-radius: 6px;
    }
    .photo-spot-name {
      font-size: 14px;
      font-weight: bold;
      margin-bottom: 8px;
      color: #2c3e50;
    }
    .photo-spot-name.missing {
      color: #e74c3c;
    }
    .photo-timing-group {
      margin-bottom: 12px;
    }
    .photo-timing-label {
      font-size: 13px;
      color: #555;
      margin-bottom: 6px;
      font-weight: bold;
    }
    .photo-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
      gap: 8px;
      margin-bottom: 8px;
    }
    .photo-thumb {
      width: 100%;
      padding-bottom: 100%;
      background-size: cover;
      background-position: center;
      border-radius: 4px;
      border: 1px solid #ddd;
    }
    .photo-upload-btn {
      padding: 8px 12px;
      background: #3498db;
      color: white;
      border: none;
      border-radius: 4px;
      font-size: 13px;
      cursor: pointer;
      width: 100%;
    }
    .photo-upload-btn:active {
      background: #2980b9;
    }

    /* è¦è£œå……ãƒªã‚¹ãƒˆï¼ˆã‚¿ãƒ–ç”¨ï¼‰ */
    .supply-tab-content {
      padding: 12px;
    }
    .supply-list-card {
      background: #fff3cd;
      padding: 16px;
      border-radius: 8px;
      border-left: 4px solid #ffc107;
    }
    .supply-list-card h3 {
      font-size: 16px;
      color: #856404;
      margin-bottom: 12px;
    }
    .supply-item {
      padding: 8px 12px;
      font-size: 14px;
      color: #856404;
      background: rgba(255,255,255,0.5);
      border-radius: 4px;
      margin-bottom: 6px;
    }
    .supply-item:before {
      content: "\26A0\FE0F ";
    }
    .supply-empty {
      text-align: center;
      padding: 40px 20px;
      color: #7f8c8d;
      font-size: 14px;
    }

    /* ãƒ¡ãƒ¢ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
    .memo-section {
      background: white;
      margin: 8px 12px;
      padding: 16px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.08);
    }
    .memo-section h3 {
      font-size: 16px;
      color: #2c3e50;
      margin-bottom: 12px;
    }
    .memo-list {
      margin-bottom: 12px;
    }
    .memo-item {
      background: #f8f9fa;
      padding: 10px;
      border-radius: 4px;
      margin-bottom: 8px;
      font-size: 14px;
    }
    .memo-meta {
      font-size: 12px;
      color: #7f8c8d;
      margin-top: 4px;
    }
    .memo-input-group {
      display: flex;
      gap: 8px;
    }
    .memo-input {
      flex: 1;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
    }
    .memo-btn {
      padding: 10px 16px;
      background: #3498db;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      white-space: nowrap;
    }

    /* ãƒœãƒˆãƒ ãƒãƒ¼ï¼ˆæœ€ä¸‹éƒ¨å›ºå®šï¼‰ */
    .bottom-bar {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: white;
      padding: 8px 12px;
      box-shadow: 0 -1px 4px rgba(0,0,0,0.08);
      display: flex;
      gap: 8px;
      z-index: 101;
    }
    .btn {
      flex: 1;
      padding: 14px;
      border: none;
      border-radius: 6px;
      font-size: 15px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s;
    }
    .btn-check {
      background: #e67e22;
      color: white;
    }
    .btn-check:active {
      background: #d35400;
    }
    .btn-complete {
      background: #27ae60;
      color: white;
    }
    .btn-complete:active {
      background: #229954;
    }
    .btn-complete:disabled {
      background: #95a5a6;
      cursor: not-allowed;
    }

    /* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° */
    .loading {
      text-align: center;
      padding: 40px 20px;
      color: #7f8c8d;
    }

    /* å…¨ä½“æ“ä½œãƒãƒ¼ */
    .action-bar {
      display: flex;
      gap: 8px;
      margin: 12px 12px 4px;
    }
    .action-btn {
      padding: 8px 14px;
      border: 1px solid #bdc3c7;
      border-radius: 6px;
      background: white;
      font-size: 13px;
      font-weight: bold;
      color: #2c3e50;
      cursor: pointer;
    }
    .action-btn:active { background: #ecf0f1; }
    .action-btn-check {
      border-color: #27ae60;
      color: #27ae60;
    }
    .action-btn-check.is-all-checked {
      border-color: #e74c3c;
      color: #e74c3c;
    }
    .action-btn-check:active { background: #eafaf1; }

    /* ä¿å­˜ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ */
    .save-indicator {
      position: fixed;
      top: 8px;
      right: 8px;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: bold;
      z-index: 150;
      opacity: 0;
      transition: opacity 0.3s;
      pointer-events: none;
    }
    .save-indicator.saving { background: #ffc107; color: #333; opacity: 1; }
    .save-indicator.saved { background: #27ae60; color: white; opacity: 1; }
    .save-indicator.error { background: #e74c3c; color: white; opacity: 1; }

    /* ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³æ’®å½±ç®‡æ‰€ */
    .inline-photo-spots {
      padding: 8px 12px;
      background: #fef9f0;
      border-top: 1px dashed #e67e22;
    }
    .inline-photo-add-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 6px;
      border: 1px dashed #e67e22;
      border-radius: 4px;
      background: transparent;
      color: #e67e22;
      font-size: 12px;
      cursor: pointer;
      width: 100%;
      margin-top: 4px;
    }
    .inline-photo-add-btn:active { background: #fef5ed; }
    .inline-photo-spot {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 0;
    }
    .inline-photo-spot-name {
      font-size: 13px;
      font-weight: bold;
      color: #2c3e50;
      min-width: 60px;
    }
    .inline-photo-btn {
      padding: 4px 10px;
      border: 1px solid #3498db;
      border-radius: 4px;
      background: white;
      font-size: 11px;
      color: #3498db;
      cursor: pointer;
    }
    .inline-photo-btn.done {
      background: #d4edda;
      border-color: #27ae60;
      color: #27ae60;
    }
    .inline-photo-btn:active { background: #ebf5fb; }
    .inline-photo-btn-after {
      border-color: #e67e22;
      color: #e67e22;
    }
    .inline-photo-btn-after.done {
      background: #fef3e2;
      border-color: #27ae60;
      color: #27ae60;
    }
    .inline-photo-btn-after:active { background: #fef5ed; }
    .inline-example-btn {
      padding: 4px 8px;
      border: 1px solid #7f8c8d;
      border-radius: 4px;
      background: white;
      font-size: 11px;
      color: #7f8c8d;
      cursor: pointer;
    }
    .inline-example-btn:active { background: #ecf0f1; }

    /* æ’®å½±ç®‡æ‰€æ“ä½œãƒœã‚¿ãƒ³ */
    .inline-spot-actions {
      display: flex;
      gap: 4px;
      margin-left: auto;
    }
    .inline-spot-edit-btn, .inline-spot-delete-btn {
      width: 22px;
      height: 22px;
      border: none;
      background: transparent;
      font-size: 12px;
      cursor: pointer;
      padding: 0;
      line-height: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 3px;
    }
    .inline-spot-edit-btn { color: #7f8c8d; }
    .inline-spot-edit-btn:active { color: #3498db; background: #ebf5fb; }
    .inline-spot-delete-btn { color: #bdc3c7; }
    .inline-spot-delete-btn:active { color: #e74c3c; background: #fdecea; }
    .photo-delete-btn {
      position: absolute;
      top: 2px;
      right: 2px;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      border: none;
      background: rgba(231,76,60,0.8);
      color: white;
      font-size: 12px;
      line-height: 1;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .photo-thumb-wrapper {
      position: relative;
      width: 100%;
      padding-bottom: 100%;
    }

    /* ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ */
    .item-edit-btn {
      width: 24px;
      height: 24px;
      border: none;
      background: transparent;
      color: #bdc3c7;
      font-size: 14px;
      cursor: pointer;
      padding: 0;
      line-height: 1;
      flex-shrink: 0;
    }
    .item-edit-btn:active { color: #3498db; }
    .item-edit-input {
      width: 100%;
      padding: 6px 8px;
      border: 2px solid #3498db;
      border-radius: 4px;
      font-size: 14px;
      outline: none;
    }
    .item-edit-actions {
      display: flex;
      gap: 4px;
      margin-top: 4px;
    }
    .item-edit-actions button {
      padding: 4px 10px;
      border: none;
      border-radius: 4px;
      font-size: 12px;
      cursor: pointer;
    }
    .item-edit-save { background: #3498db; color: white; }
    .item-edit-cancel { background: #ecf0f1; color: #333; }
    .section-add-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 8px;
      border: 2px dashed #bdc3c7;
      border-radius: 4px;
      background: transparent;
      color: #7f8c8d;
      font-size: 13px;
      cursor: pointer;
      width: calc(100% - 32px);
      margin: 8px 16px;
    }
    .section-add-btn:active { background: #ecf0f1; border-color: #3498db; color: #3498db; }
    .category-add-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 12px;
      border: 2px dashed #bdc3c7;
      border-radius: 8px;
      background: white;
      color: #7f8c8d;
      font-size: 14px;
      font-weight: bold;
      cursor: pointer;
      margin: 8px 12px;
    }
    .category-add-btn:active { background: #ecf0f1; border-color: #3498db; color: #3498db; }

    /* ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ */
    .hidden { display: none !important; }

    input[type="file"] {
      display: none;
    }

    /* ã‚«ãƒ†ã‚´ãƒªæ’®å½±ãƒ¢ãƒ¼ãƒ€ãƒ« */
    .photo-modal-overlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 200;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    .photo-modal {
      background: white;
      border-radius: 12px;
      width: 100%;
      max-width: 400px;
      max-height: 80vh;
      overflow-y: auto;
      padding: 20px;
    }
    .photo-modal h3 {
      font-size: 16px;
      margin-bottom: 16px;
      color: #2c3e50;
    }
    .photo-modal-close {
      padding: 10px;
      width: 100%;
      border: 1px solid #bdc3c7;
      border-radius: 6px;
      background: white;
      font-size: 14px;
      cursor: pointer;
      margin-top: 12px;
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="header-top">
      <div class="header-left">
        <div class="header-title">æ¸…æƒãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ</div>
        <div class="header-date" id="headerDate"></div>
      </div>
      <div class="staff-selector" id="staffSelector">
        <div class="staff-selector-label">æ‹…å½“ã‚¹ã‚¿ãƒƒãƒ•</div>
        <div class="staff-row">
          <select class="staff-select" id="staffSelect0"></select>
          <button class="staff-add-btn" onclick="addStaffRow()" title="ã‚¹ã‚¿ãƒƒãƒ•è¿½åŠ ">+</button>
        </div>
      </div>
    </div>
    <div class="progress-bar">
      <div class="progress-fill" id="progressFill" style="width: 0%"></div>
    </div>
  </div>

  <div id="loadingArea" class="loading">èª­ã¿è¾¼ã¿ä¸­...</div>

  <div id="contentArea" class="hidden">
    <!-- æ¬¡å›äºˆç´„æƒ…å ± -->
    <div id="bookingInfo" class="booking-info hidden"></div>

    <!-- ã‚¿ãƒ–ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆç”»é¢ä¸‹éƒ¨ã«è¡¨ç¤ºï¼‰ -->

    <!-- ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆã‚¿ãƒ– -->
    <div id="tabChecklist" class="tab-content active">
      <!-- å…¨ä½“æ“ä½œãƒãƒ¼ -->
      <div class="action-bar">
        <button id="btnExpandAll" class="action-btn" onclick="toggleAllSections()">å…¨ã¦å±•é–‹</button>
        <button id="btnCheckAll" class="action-btn action-btn-check" onclick="checkAllItems()">å…¨ãƒã‚§ãƒƒã‚¯</button>
      </div>

      <!-- ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ -->
      <div id="checklistContainer"></div>

      <!-- ãƒ¡ãƒ¢ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
      <div id="memoSection" class="memo-section">
        <h3>ğŸ“ ç‰¹è¨˜äº‹é …ãƒ»å‚™å“ä¸è¶³ãªã©</h3>
        <div id="memoList" class="memo-list"></div>
        <div class="memo-input-group">
          <input type="text" id="memoInput" class="memo-input" placeholder="å‚™å“ä¸è¶³ã‚„ãƒ¡ãƒ¢ã‚’å…¥åŠ›...">
          <button id="memoBtn" class="memo-btn">é€ä¿¡</button>
        </div>
      </div>
    </div>

    <!-- è¦è£œå……ã‚¿ãƒ– -->
    <div id="tabSupply" class="tab-content">
      <div class="supply-tab-content">
        <div id="supplyListContent"></div>
      </div>
    </div>

    <!-- æ’®å½±ã‚¿ãƒ– -->
    <div id="tabPhoto" class="tab-content">
      <div id="photoSection"></div>
    </div>

    <!-- è¨­å®šã‚¿ãƒ–ï¼ˆã‚ªãƒ¼ãƒŠãƒ¼ã®ã¿è¡¨ç¤ºï¼‰ -->
    <div id="tabClSettings" class="tab-content">
      <div style="padding:16px;">
        <h3 style="font-size:16px;margin-bottom:16px;color:#2c3e50;">ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆè¨­å®š</h3>

        <!-- å†™çœŸä¿å­˜ãƒ•ã‚©ãƒ«ãƒ€è¨­å®š -->
        <div style="background:#fff;border-radius:8px;padding:16px;border:1px solid #ddd;margin-bottom:16px;">
          <h4 style="font-size:14px;margin-bottom:8px;">å†™çœŸä¿å­˜ãƒ•ã‚©ãƒ«ãƒ€ï¼ˆGoogleãƒ‰ãƒ©ã‚¤ãƒ–ï¼‰</h4>
          <p style="font-size:12px;color:#666;margin-bottom:12px;">å„å†™çœŸã®ä¿å­˜å…ˆãƒ•ã‚©ãƒ«ãƒ€URLã¾ãŸã¯ãƒ•ã‚©ãƒ«ãƒ€IDã‚’æŒ‡å®šã€‚ç©ºæ¬„ã®å ´åˆã¯è‡ªå‹•ä½œæˆã•ã‚Œã¾ã™ã€‚</p>

          <div style="margin-bottom:10px;">
            <label style="font-size:12px;font-weight:bold;color:#555;">ãƒ“ãƒ•ã‚©ãƒ¼å†™çœŸãƒ•ã‚©ãƒ«ãƒ€</label>
            <div style="display:flex;gap:6px;margin-top:4px;">
              <input type="text" id="folderBeforeInput" placeholder="ãƒ•ã‚©ãƒ«ãƒ€URL or IDï¼ˆç©ºæ¬„=è‡ªå‹•ï¼‰" style="flex:1;padding:6px 8px;border:1px solid #ddd;border-radius:4px;font-size:13px;">
              <button onclick="saveSubFolder('before')" style="padding:6px 12px;background:#3498db;color:#fff;border:none;border-radius:4px;font-size:12px;white-space:nowrap;">ä¿å­˜</button>
            </div>
          </div>

          <div style="margin-bottom:10px;">
            <label style="font-size:12px;font-weight:bold;color:#555;">ã‚¢ãƒ•ã‚¿ãƒ¼å†™çœŸãƒ•ã‚©ãƒ«ãƒ€</label>
            <div style="display:flex;gap:6px;margin-top:4px;">
              <input type="text" id="folderAfterInput" placeholder="ãƒ•ã‚©ãƒ«ãƒ€URL or IDï¼ˆç©ºæ¬„=è‡ªå‹•ï¼‰" style="flex:1;padding:6px 8px;border:1px solid #ddd;border-radius:4px;font-size:13px;">
              <button onclick="saveSubFolder('after')" style="padding:6px 12px;background:#e67e22;color:#fff;border:none;border-radius:4px;font-size:12px;white-space:nowrap;">ä¿å­˜</button>
            </div>
          </div>

          <div style="margin-bottom:4px;">
            <label style="font-size:12px;font-weight:bold;color:#555;">è¦‹æœ¬å†™çœŸãƒ•ã‚©ãƒ«ãƒ€</label>
            <div style="display:flex;gap:6px;margin-top:4px;">
              <input type="text" id="folderExampleInput" placeholder="ãƒ•ã‚©ãƒ«ãƒ€URL or IDï¼ˆç©ºæ¬„=è‡ªå‹•ï¼‰" style="flex:1;padding:6px 8px;border:1px solid #ddd;border-radius:4px;font-size:13px;">
              <button onclick="saveSubFolder('example')" style="padding:6px 12px;background:#9b59b6;color:#fff;border:none;border-radius:4px;font-size:12px;white-space:nowrap;">ä¿å­˜</button>
            </div>
          </div>
          <div id="folderSaveResult" style="display:none;margin-top:8px;font-size:12px;"></div>
        </div>

        <!-- åˆæœŸãƒ‡ãƒ¼ã‚¿å†ã‚¤ãƒ³ãƒãƒ¼ãƒˆ -->
        <div style="background:#fff;border-radius:8px;padding:16px;border:1px solid #ddd;margin-bottom:16px;">
          <h4 style="font-size:14px;margin-bottom:8px;">åˆæœŸãƒ‡ãƒ¼ã‚¿å†ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</h4>
          <p style="font-size:12px;color:#666;margin-bottom:12px;">ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆé …ç›®ã¨æ’®å½±ç®‡æ‰€ã‚’åˆæœŸçŠ¶æ…‹ã«æˆ»ã—ã¾ã™ã€‚æ—¢å­˜ã®ãƒã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿ãŒä¸Šæ›¸ãã•ã‚Œã¾ã™ã€‚</p>
          <button id="btnReimportCL" style="padding:10px 20px;background:#e74c3c;color:#fff;border:none;border-radius:6px;font-size:14px;cursor:pointer;width:100%;">åˆæœŸãƒ‡ãƒ¼ã‚¿ã‚’å†ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
          <div id="reimportResult" style="display:none;margin-top:8px;font-size:13px;"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- ã‚¿ãƒ–ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆãƒœã‚¿ãƒ³ã®ä¸Šã«å›ºå®šï¼‰ -->
  <div class="tab-nav" id="tabNav">
    <button class="tab-nav-btn active" data-tab="checklist" onclick="switchTab('checklist')">ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ</button>
    <button class="tab-nav-btn" data-tab="photo" onclick="switchTab('photo')">æ’®å½±</button>
    <button class="tab-nav-btn" data-tab="supply" onclick="switchTab('supply')">è¦è£œå……<span id="supplyBadge" class="tab-badge tab-badge-warning hidden">0</span></button>
    <button class="tab-nav-btn" data-tab="clSettings" onclick="switchTab('clSettings')" style="display:none;">è¨­å®š</button>
  </div>

  <!-- ãƒœãƒˆãƒ ãƒãƒ¼ï¼ˆæœ€ä¸‹éƒ¨å›ºå®šï¼‰ -->
  <div class="bottom-bar">
    <button id="btnCheckMissing" class="btn btn-check">æ¼ã‚Œãƒã‚§ãƒƒã‚¯</button>
    <button id="btnComplete" class="btn btn-complete">æ¸…æƒå®Œäº†</button>
  </div>

  <!-- ä¿å­˜ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ -->
  <div class="save-indicator" id="saveIndicator"></div>

  <!-- éè¡¨ç¤ºã®ãƒ•ã‚¡ã‚¤ãƒ«å…¥åŠ› -->
  <input type="file" id="photoInput" accept="image/*" capture="environment">
  <input type="file" id="examplePhotoInput" accept="image/*">

  <script>
    // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
    var checkoutDate = '<?= checkoutDate ?>' || '';
    var staffName = '<?= staffName ?>' || '';
    var checklistData = null;
    var bookingData = null;
    var missingCheckActive = false;
    var staffList = [];
    var staffRowCount = 1;
    var saveIndicatorTimer = null;

    // ä¿å­˜ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼
    function showSaveStatus(status) {
      var el = document.getElementById('saveIndicator');
      if (!el) return;
      el.className = 'save-indicator ' + status;
      el.textContent = status === 'saving' ? 'ä¿å­˜ä¸­...' : status === 'saved' ? 'âœ“ ä¿å­˜æ¸ˆã¿' : 'âœ• ä¿å­˜å¤±æ•—';
      if (saveIndicatorTimer) clearTimeout(saveIndicatorTimer);
      if (status !== 'saving') {
        saveIndicatorTimer = setTimeout(function() { el.className = 'save-indicator'; }, 2000);
      }
    }

    // åˆæœŸåŒ–
    window.onload = function() {
      if (!checkoutDate) {
        alert('ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆæ—¥ãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“');
        return;
      }
      document.getElementById('headerDate').textContent = checkoutDate;
      loadData();
      loadStaffList();

      // å®šæœŸãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ï¼ˆ60ç§’ã”ã¨ã€2äººåŒæ™‚åˆ©ç”¨å¯¾å¿œï¼‰
      // æŠ˜ã‚ŠãŸãŸã¿çŠ¶æ…‹ã¨ã‚¿ãƒ–çŠ¶æ…‹ã‚’ä¿æŒã—ã¦ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥
      setInterval(function() {
        if (!checklistData) return;
        callGAS('getChecklistForDate', [checkoutDate]).then(function(res) {
          if (res.success) {
            // ç¾åœ¨ã®æŠ˜ã‚ŠãŸãŸã¿çŠ¶æ…‹ã‚’ä¿å­˜
            var collapseState = saveCollapseState();
            var activeTab = getActiveTab();
            checklistData = res;
            renderChecklist();
            renderPhotoSection();
            renderSupplyList();
            updateProgress();
            updateCheckAllButton();
            // æŠ˜ã‚ŠãŸãŸã¿çŠ¶æ…‹ã¨ã‚¿ãƒ–ã‚’å¾©å…ƒ
            restoreCollapseState(collapseState);
            if (activeTab) switchTab(activeTab);
          }
        }).catch(function() {});
      }, 60000);

      // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
      document.getElementById('btnCheckMissing').addEventListener('click', toggleMissingCheck);
      document.getElementById('btnComplete').addEventListener('click', completeChecklist);
      document.getElementById('memoBtn').addEventListener('click', addMemo);
      document.getElementById('photoInput').addEventListener('change', handlePhotoUpload);
      document.getElementById('staffSelect0').addEventListener('change', updateSettingsTabVisibility);
      document.getElementById('btnReimportCL').addEventListener('click', function() {
        if (!confirm('ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆé …ç›®ã¨æ’®å½±ç®‡æ‰€ã‚’åˆæœŸçŠ¶æ…‹ã«æˆ»ã—ã¾ã™ã€‚\næ—¢å­˜ã®ãƒã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿ãŒä¸Šæ›¸ãã•ã‚Œã¾ã™ã€‚\n\nã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) return;
        var btn = this;
        var resEl = document.getElementById('reimportResult');
        btn.disabled = true;
        btn.textContent = 'ã‚¤ãƒ³ãƒãƒ¼ãƒˆä¸­...';
        resEl.style.display = 'block';
        resEl.textContent = 'å‡¦ç†ä¸­...';
        resEl.style.color = '#666';
        callGAS('importDefaultChecklist', []).then(function(res) {
          if (res.success) {
            resEl.textContent = 'å®Œäº†: ' + (res.itemCount || 0) + 'ä»¶ã®é …ç›®ã€' + (res.spotCount || 0) + 'ä»¶ã®æ’®å½±ç®‡æ‰€ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã—ãŸã€‚';
            resEl.style.color = '#27ae60';
            // ãƒ‡ãƒ¼ã‚¿ã‚’å†èª­ã¿è¾¼ã¿
            callGAS('getChecklistForDate', [checkoutDate]).then(function(clRes) {
              if (clRes.success) {
                checklistData = clRes;
                renderChecklist();
                renderPhotoSection();
                renderSupplyList();
                updateProgress();
                updateCheckAllButton();
              }
            });
          } else {
            resEl.textContent = 'ã‚¨ãƒ©ãƒ¼: ' + (res.error || 'ä¸æ˜');
            resEl.style.color = '#e74c3c';
          }
          btn.disabled = false;
          btn.textContent = 'åˆæœŸãƒ‡ãƒ¼ã‚¿ã‚’å†ã‚¤ãƒ³ãƒãƒ¼ãƒˆ';
        }).catch(function(e) {
          resEl.textContent = 'ã‚¨ãƒ©ãƒ¼: ' + (e.message || 'é€šä¿¡å¤±æ•—');
          resEl.style.color = '#e74c3c';
          btn.disabled = false;
          btn.textContent = 'åˆæœŸãƒ‡ãƒ¼ã‚¿ã‚’å†ã‚¤ãƒ³ãƒãƒ¼ãƒˆ';
        });
      });
    };

    // === ã‚¹ã‚¿ãƒƒãƒ•é¸æŠ ===
    function loadStaffList() {
      callGAS('getCleaningStaffList', []).then(function(res) {
        if (res.success && res.list) {
          staffList = res.list;
          populateStaffSelects();
        }
      }).catch(function() {});
    }

    function populateStaffSelects() {
      var selects = document.querySelectorAll('.staff-select');
      selects.forEach(function(sel) {
        var currentVal = sel.value;
        sel.innerHTML = '<option value="">ğŸ§¹ ã‚¹ã‚¿ãƒƒãƒ•é¸æŠ</option>';
        staffList.forEach(function(name) {
          if (name === 'ã‚ªãƒ¼ãƒŠãƒ¼') return; // æœ€å¾Œã«è¿½åŠ ã™ã‚‹ã®ã§ã‚¹ã‚­ãƒƒãƒ—
          var opt = document.createElement('option');
          opt.value = name;
          opt.textContent = name;
          sel.appendChild(opt);
        });
        // ã€Œã‚ªãƒ¼ãƒŠãƒ¼ã€ã‚’å¸¸ã«æœ€å¾Œã«è¡¨ç¤º
        var ownerOpt = document.createElement('option');
        ownerOpt.value = 'ã‚ªãƒ¼ãƒŠãƒ¼';
        ownerOpt.textContent = 'ã‚ªãƒ¼ãƒŠãƒ¼';
        sel.appendChild(ownerOpt);
        // åˆæœŸé¸æŠ: URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®staffNameã«ä¸€è‡´ã™ã‚‹ã‚‚ã®ãŒã‚ã‚Œã°é¸æŠ
        if (!currentVal && staffName) {
          sel.value = staffName;
        } else if (currentVal) {
          sel.value = currentVal;
        }
      });
      // è¨­å®šã‚¿ãƒ–ã®è¡¨ç¤ºåˆ¶å¾¡: ã‚ªãƒ¼ãƒŠãƒ¼é¸æŠæ™‚ã®ã¿è¡¨ç¤º
      updateSettingsTabVisibility();
    }

    function updateSettingsTabVisibility() {
      var firstSelect = document.getElementById('staffSelect0');
      var isOwner = firstSelect && firstSelect.value === 'ã‚ªãƒ¼ãƒŠãƒ¼';
      var settingsBtn = document.querySelector('.tab-nav-btn[data-tab="clSettings"]');
      if (settingsBtn) settingsBtn.style.display = isOwner ? '' : 'none';
      // ã‚ªãƒ¼ãƒŠãƒ¼ã§ãªã„å ´åˆã«è¨­å®šã‚¿ãƒ–ãŒè¡¨ç¤ºä¸­ãªã‚‰åˆ‡ã‚Šæ›¿ãˆ
      if (!isOwner) {
        var settingsTab = document.getElementById('tabClSettings');
        if (settingsTab && settingsTab.classList.contains('active')) {
          switchTab('checklist');
        }
      }
    }

    function addStaffRow() {
      var container = document.getElementById('staffSelector');
      var idx = staffRowCount;
      staffRowCount++;
      var row = document.createElement('div');
      row.className = 'staff-row';
      row.id = 'staffRow' + idx;
      row.innerHTML = '<select class="staff-select" id="staffSelect' + idx + '"></select>' +
        '<button class="staff-remove-btn" onclick="removeStaffRow(' + idx + ')" title="å‰Šé™¤">âœ•</button>';
      container.appendChild(row);
      populateStaffSelects();
    }

    function removeStaffRow(idx) {
      var row = document.getElementById('staffRow' + idx);
      if (row) row.remove();
    }

    function getSelectedStaffNames() {
      var names = [];
      document.querySelectorAll('.staff-select').forEach(function(sel) {
        var v = sel.value.trim();
        if (v && names.indexOf(v) === -1) names.push(v);
      });
      return names;
    }

    // === ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ ===
    function switchTab(tabName) {
      document.querySelectorAll('.tab-nav-btn').forEach(function(btn) {
        btn.classList.toggle('active', btn.getAttribute('data-tab') === tabName);
      });
      document.querySelectorAll('.tab-content').forEach(function(tc) {
        tc.classList.remove('active');
      });
      var target = document.getElementById('tab' + tabName.charAt(0).toUpperCase() + tabName.slice(1));
      if (target) target.classList.add('active');
      if (tabName === 'clSettings') loadFolderSettings();
    }

    // ãƒ•ã‚©ãƒ«ãƒ€è¨­å®šã®èª­ã¿è¾¼ã¿
    function loadFolderSettings() {
      callGAS('getPhotoFolderSettings', []).then(function(res) {
        if (res.success) {
          var bi = document.getElementById('folderBeforeInput');
          var ai = document.getElementById('folderAfterInput');
          var ei = document.getElementById('folderExampleInput');
          if (bi && res.beforeId) bi.value = 'https://drive.google.com/drive/folders/' + res.beforeId;
          if (ai && res.afterId) ai.value = 'https://drive.google.com/drive/folders/' + res.afterId;
          if (ei && res.exampleId) ei.value = 'https://drive.google.com/drive/folders/' + res.exampleId;
        }
      });
    }

    // ãƒ•ã‚©ãƒ«ãƒ€ä¿å­˜
    function saveSubFolder(type) {
      var inputMap = { 'before': 'folderBeforeInput', 'after': 'folderAfterInput', 'example': 'folderExampleInput' };
      var input = document.getElementById(inputMap[type]);
      if (!input) return;
      var val = input.value.trim();
      // URLã‹ã‚‰ãƒ•ã‚©ãƒ«ãƒ€IDã‚’æŠ½å‡º
      var folderId = val;
      var match = val.match(/folders\/([a-zA-Z0-9_-]+)/);
      if (match) folderId = match[1];
      var resEl = document.getElementById('folderSaveResult');
      resEl.textContent = 'ä¿å­˜ä¸­...';
      resEl.style.color = '#666';
      resEl.style.display = 'block';
      callGAS('setPhotoSubFolderId', [type, folderId]).then(function(res) {
        if (res.success) {
          resEl.textContent = 'ä¿å­˜ã—ã¾ã—ãŸ';
          resEl.style.color = '#27ae60';
        } else {
          resEl.textContent = res.error || 'ä¿å­˜å¤±æ•—';
          resEl.style.color = '#e74c3c';
        }
        setTimeout(function() { resEl.style.display = 'none'; }, 3000);
      }).catch(function() {
        resEl.textContent = 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ';
        resEl.style.color = '#e74c3c';
      });
    }

    // === æŠ˜ã‚ŠãŸãŸã¿çŠ¶æ…‹ã®ä¿å­˜ãƒ»å¾©å…ƒ ===
    function getActiveTab() {
      var active = document.querySelector('.tab-nav-btn.active');
      return active ? active.getAttribute('data-tab') : 'checklist';
    }

    function saveCollapseState() {
      var state = {};
      document.querySelectorAll('#checklistContainer .section').forEach(function(section) {
        var cat = section.getAttribute('data-category');
        if (cat) {
          var header = section.querySelector('.section-header');
          state[cat] = header ? header.classList.contains('collapsed') : true;
        }
      });
      return state;
    }

    function restoreCollapseState(state) {
      document.querySelectorAll('#checklistContainer .section').forEach(function(section) {
        var cat = section.getAttribute('data-category');
        if (cat && state.hasOwnProperty(cat)) {
          var header = section.querySelector('.section-header');
          var body = section.querySelector('.section-body');
          if (header && body) {
            if (state[cat]) {
              header.classList.add('collapsed');
              body.classList.add('collapsed');
            } else {
              header.classList.remove('collapsed');
              body.classList.remove('collapsed');
            }
          }
        }
      });
    }

    // === ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ ===
    function loadData() {
      Promise.all([
        callGAS('getNextBookingDetails', [checkoutDate]),
        callGAS('getChecklistForDate', [checkoutDate])
      ]).then(function(results) {
        var bookingRes = results[0];
        var checklistRes = results[1];

        if (bookingRes.success) {
          bookingData = bookingRes.booking;
          renderBookingInfo();
        }

        if (checklistRes.success) {
          checklistData = checklistRes;
          renderChecklist();
          renderPhotoSection();
          renderMemos();
          renderSupplyList();
          updateProgress();
        } else {
          alert('ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + checklistRes.error);
        }

        document.getElementById('loadingArea').classList.add('hidden');
        document.getElementById('contentArea').classList.remove('hidden');
      }).catch(function(err) {
        alert('ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + err);
      });
    }

    function renderBookingInfo() {
      if (!bookingData) return;
      var html = '<h3>ğŸ“… æ¬¡å›äºˆç´„è©³ç´°</h3>';
      html += '<div class="booking-row"><span class="booking-label">ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³</span><span class="booking-value">' + escapeHtml(bookingData.checkIn) + '</span></div>';
      html += '<div class="booking-row"><span class="booking-label">ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ</span><span class="booking-value">' + escapeHtml(bookingData.checkOut) + '</span></div>';
      if (bookingData.guestName) html += '<div class="booking-row"><span class="booking-label">å®¿æ³Šè€…å</span><span class="booking-value">' + escapeHtml(bookingData.guestName) + '</span></div>';
      if (bookingData.guestCount) html += '<div class="booking-row"><span class="booking-label">äººæ•°</span><span class="booking-value">' + escapeHtml(bookingData.guestCount) + 'å</span></div>';
      if (bookingData.bookingSite) html += '<div class="booking-row"><span class="booking-label">äºˆç´„ã‚µã‚¤ãƒˆ</span><span class="booking-value">' + escapeHtml(bookingData.bookingSite) + '</span></div>';
      if (bookingData.bbq) html += '<div class="booking-row"><span class="booking-label">BBQåˆ©ç”¨</span><span class="booking-value">' + escapeHtml(bookingData.bbq) + '</span></div>';
      if (bookingData.linen) html += '<div class="booking-row"><span class="booking-label">ãƒªãƒãƒ³</span><span class="booking-value">' + escapeHtml(bookingData.linen) + '</span></div>';
      if (bookingData.bed) html += '<div class="booking-row"><span class="booking-label">ãƒ™ãƒƒãƒ‰</span><span class="booking-value">' + escapeHtml(bookingData.bed) + '</span></div>';

      document.getElementById('bookingInfo').innerHTML = html;
      document.getElementById('bookingInfo').classList.remove('hidden');
    }

    // === ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ ===
    function renderChecklistItem(item, checked, supplyNeeded) {
      var isChecked = !!checked[item.id];
      var isSupplyNeeded = !!supplyNeeded[item.id];
      var html = '<div class="checklist-item">';
      html += '<input type="checkbox" class="item-checkbox" data-item-id="' + escapeHtml(item.id) + '" ' + (isChecked ? 'checked' : '') + ' onchange="toggleItem(this)">';
      html += '<div class="item-content">';
      html += '<div class="item-name" id="itemName_' + escapeHtml(item.id) + '">' + escapeHtml(item.name) + '</div>';
      if (item.supplyItem) {
        html += '<div class="supply-checkbox-container">';
        html += '<input type="checkbox" class="supply-checkbox" data-item-id="' + escapeHtml(item.id) + '" data-item-name="' + escapeHtml(item.name) + '" ' + (isSupplyNeeded ? 'checked' : '') + ' onchange="toggleSupply(this)">';
        html += '<label>è¦è£œå……</label>';
        html += '</div>';
      }
      html += '</div>';
      html += '<button class="item-edit-btn" onclick="editItem(\'' + escapeHtml(item.id) + '\', this)" title="ç·¨é›†">âœ</button>';
      html += '</div>';
      return html;
    }

    function renderChecklist() {
      var items = checklistData.items;
      var checked = checklistData.checked;
      var supplyNeeded = checklistData.supplyNeeded;
      var spots = checklistData.spots || [];
      var photos = checklistData.photos || {};

      // ã‚«ãƒ†ã‚´ãƒªã‚’å¤§ä¸­å°ã«éšå±¤åŒ–
      var majorGroups = {};
      var majorOrder = [];
      items.forEach(function(item) {
        var cat = item.category || 'ãã®ä»–';
        var sep = cat.indexOf('\uff1a');
        var majorName = sep >= 0 ? cat.substring(0, sep) : cat;
        var subName = sep >= 0 ? cat.substring(sep + 1) : null;
        if (!majorGroups[majorName]) {
          majorGroups[majorName] = { direct: [], subs: {}, subOrder: [] };
          majorOrder.push(majorName);
        }
        if (subName) {
          if (!majorGroups[majorName].subs[subName]) {
            majorGroups[majorName].subs[subName] = [];
            majorGroups[majorName].subOrder.push(subName);
          }
          majorGroups[majorName].subs[subName].push(item);
        } else {
          majorGroups[majorName].direct.push(item);
        }
      });

      var html = '';
      majorOrder.forEach(function(majorName) {
        var group = majorGroups[majorName];
        var allItems = group.direct.slice();
        group.subOrder.forEach(function(sub) { allItems = allItems.concat(group.subs[sub]); });
        var checkedInMajor = allItems.filter(function(item) { return checked[item.id]; }).length;
        var totalInMajor = allItems.length;

        // ã‚«ãƒ†ã‚´ãƒªã«å±ã™ã‚‹æ’®å½±ç®‡æ‰€ã‚’å–å¾—
        var categorySpots = spots.filter(function(s) {
          var sc = s.category || '';
          return sc === majorName || s.name === majorName || s.name.indexOf(majorName) === 0;
        });

        html += '<div class="section" data-category="' + escapeHtml(majorName) + '">';
        html += '<div class="section-header collapsed" onclick="toggleSection(this)">';
        html += '<span class="section-icon">â–¼</span>';
        html += '<span class="section-title">' + escapeHtml(majorName) + '</span>';
        html += '<span class="section-count">(' + checkedInMajor + '/' + totalInMajor + ')</span>';
        html += '<button class="section-header-btn section-check-all" onclick="event.stopPropagation(); checkCategory(this)">å…¨ãƒã‚§ãƒƒã‚¯</button>';
        html += '</div>';
        html += '<div class="section-body collapsed">';

        // ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³æ’®å½±ç®‡æ‰€ï¼ˆå¤§ã‚«ãƒ†ã‚´ãƒªæŠ˜ã‚ŠãŸãŸã¿ç›´ä¸‹ï¼‰
        html += '<div class="inline-photo-spots">';
        categorySpots.forEach(function(spot) {
          var spotPhotos = photos[spot.id] || { before: [], after: [] };
          var bDone = spotPhotos.before.length > 0;
          var aDone = spotPhotos.after.length > 0;
          html += '<div class="inline-photo-spot">';
          html += '<span class="inline-photo-spot-name">' + escapeHtml(spot.name) + '</span>';
          html += '<button class="inline-photo-btn' + (bDone ? ' done' : '') + '" onclick="openPhotoUpload(\'' + spot.id + '\', \'ãƒ“ãƒ•ã‚©ãƒ¼\')">' + (bDone ? 'âœ“B' : 'B') + '</button>';
          html += '<button class="inline-photo-btn inline-photo-btn-after' + (aDone ? ' done' : '') + '" onclick="openPhotoUpload(\'' + spot.id + '\', \'ã‚¢ãƒ•ã‚¿ãƒ¼\')">' + (aDone ? 'âœ“A' : 'A') + '</button>';
          // è¦‹æœ¬ãƒœã‚¿ãƒ³: å¸¸ã«è¡¨ç¤ºï¼ˆå†™çœŸã‚ã‚Šâ†’ã€Œè¦‹æœ¬ã€ã€ãªã—â†’ã€ŒâŠã€ï¼‰
          if (spot.exampleFileId) {
            html += '<button class="inline-example-btn" onclick="showExampleWithOptions(\'' + spot.id + '\', \'' + spot.exampleFileId + '\')">è¦‹æœ¬</button>';
          } else {
            html += '<button class="inline-example-btn" onclick="uploadExamplePrompt(\'' + spot.id + '\')" title="è¦‹æœ¬å†™çœŸã‚’è¨­å®š">âŠ</button>';
          }
          html += '<div class="inline-spot-actions">';
          html += '<button class="inline-spot-edit-btn" onclick="editSpotName(\'' + spot.id + '\')" title="åç§°å¤‰æ›´">âœ</button>';
          html += '<button class="inline-spot-delete-btn" onclick="deleteSpot(\'' + spot.id + '\', \'' + escapeHtml(spot.name).replace(/'/g, "\\'") + '\')" title="å‰Šé™¤">âœ•</button>';
          html += '</div>';
          html += '</div>';
        });
        html += '<button class="inline-photo-add-btn" onclick="addPhotoSpotPrompt(\'' + escapeHtml(majorName).replace(/'/g, "\\'") + '\')">ï¼‹ æ’®å½±é …ç›®ã‚’è¿½åŠ </button>';
        html += '</div>';

        // ç›´å±ã‚¢ã‚¤ãƒ†ãƒ 
        group.direct.forEach(function(item) {
          html += renderChecklistItem(item, checked, supplyNeeded);
        });

        // ä¸­ã‚«ãƒ†ã‚´ãƒª
        group.subOrder.forEach(function(subName) {
          var subItems = group.subs[subName];
          var checkedInSub = subItems.filter(function(item) { return checked[item.id]; }).length;

          html += '<div class="section sub-section" data-category="' + escapeHtml(majorName + '\uff1a' + subName) + '">';
          html += '<div class="section-header collapsed" onclick="toggleSection(this)">';
          html += '<span class="section-icon">â–¼</span>';
          html += '<span class="section-title">' + escapeHtml(subName) + '</span>';
          html += '<span class="section-count">(' + checkedInSub + '/' + subItems.length + ')</span>';
          html += '<button class="section-header-btn section-check-all" onclick="event.stopPropagation(); checkCategory(this)">å…¨ãƒã‚§ãƒƒã‚¯</button>';
          html += '</div>';
          html += '<div class="section-body collapsed">';
          subItems.forEach(function(item) {
            html += renderChecklistItem(item, checked, supplyNeeded);
          });
          // ã‚µãƒ–ã‚«ãƒ†ã‚´ãƒªå†…ã®é …ç›®è¿½åŠ ãƒœã‚¿ãƒ³
          html += '<button class="section-add-btn" onclick="addItemPrompt(\'' + escapeHtml(majorName + '\uff1a' + subName).replace(/'/g, "\\'") + '\')">ï¼‹ é …ç›®ã‚’è¿½åŠ </button>';
          html += '</div></div>';
        });

        // å¤§ã‚«ãƒ†ã‚´ãƒªç›´å±ã®é …ç›®è¿½åŠ ãƒœã‚¿ãƒ³
        html += '<button class="section-add-btn" onclick="addItemPrompt(\'' + escapeHtml(majorName).replace(/'/g, "\\'") + '\')">ï¼‹ é …ç›®ã‚’è¿½åŠ </button>';

        html += '</div></div>';
      });

      // ã‚«ãƒ†ã‚´ãƒªè¿½åŠ ãƒœã‚¿ãƒ³
      html += '<button class="category-add-btn" onclick="addCategoryPrompt()">ï¼‹ ã‚«ãƒ†ã‚´ãƒªã‚’è¿½åŠ </button>';

      document.getElementById('checklistContainer').innerHTML = html;
    }

    // === æ’®å½±ã‚»ã‚¯ã‚·ãƒ§ãƒ³ ===
    function renderPhotoSection() {
      var spots = checklistData.spots;
      var photos = checklistData.photos;

      if (spots.length === 0) {
        document.getElementById('photoSection').innerHTML = '<div class="supply-empty">æ’®å½±ç®‡æ‰€ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</div>';
        return;
      }

      // ã‚«ãƒ†ã‚´ãƒªã”ã¨ã«ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
      var categories = {};
      var catOrder = [];
      spots.forEach(function(spot) {
        var cat = spot.category || 'ãã®ä»–';
        if (!categories[cat]) { categories[cat] = []; catOrder.push(cat); }
        categories[cat].push(spot);
      });

      // æ’®å½±æ¸ˆã¿/æœªæ’®å½±ã®ã‚«ã‚¦ãƒ³ãƒˆ
      var totalSpots = spots.length;
      var doneSpots = spots.filter(function(s) {
        var p = photos[s.id] || { before: [], after: [] };
        return p.before.length > 0 || p.after.length > 0;
      }).length;

      var html = '<div style="padding:12px;"><div style="font-size:14px;font-weight:bold;color:#2c3e50;margin-bottom:8px;">æ’®å½±é€²æ—: ' + doneSpots + ' / ' + totalSpots + ' ç®‡æ‰€</div>';
      html += '<div style="height:6px;background:#ecf0f1;border-radius:3px;overflow:hidden;margin-bottom:16px;"><div style="height:100%;background:#e67e22;width:' + (totalSpots > 0 ? Math.round(doneSpots / totalSpots * 100) : 0) + '%;border-radius:3px;"></div></div></div>';

      catOrder.forEach(function(cat) {
        html += '<div class="photo-section"><h3>ğŸ“· ' + escapeHtml(cat) + '</h3>';
        categories[cat].forEach(function(spot) {
          var spotPhotos = photos[spot.id] || { before: [], after: [] };
          var bDone = spotPhotos.before.length > 0;
          var aDone = spotPhotos.after.length > 0;
          var spotDone = bDone || aDone;

          html += '<div class="photo-spot" style="' + (spotDone ? 'border-left:3px solid #27ae60;' : 'border-left:3px solid #e74c3c;') + '">';
          html += '<div class="photo-spot-name" style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;">';
          html += '<span>' + (spotDone ? 'âœ…' : 'â¬œ') + '</span>';
          html += '<span>' + escapeHtml(spot.name) + '</span>';
          if (spot.exampleFileId) {
            html += '<button class="inline-example-btn" onclick="showExampleWithOptions(\'' + spot.id + '\', \'' + spot.exampleFileId + '\')">è¦‹æœ¬</button>';
          } else {
            html += '<button class="inline-example-btn" onclick="uploadExamplePrompt(\'' + spot.id + '\')" title="è¦‹æœ¬å†™çœŸã‚’è¨­å®š">âŠ</button>';
          }
          html += '<button class="inline-spot-edit-btn" onclick="editSpotName(\'' + spot.id + '\')" title="åç§°å¤‰æ›´">âœ</button>';
          html += '<button class="inline-spot-delete-btn" onclick="deleteSpot(\'' + spot.id + '\', \'' + escapeHtml(spot.name).replace(/'/g, "\\'") + '\')" title="å‰Šé™¤">âœ•</button>';
          html += '</div>';

          // ãƒ“ãƒ•ã‚©ãƒ¼/ã‚¢ãƒ•ã‚¿ãƒ¼ å·¦å³é…ç½®
          html += '<div style="display:flex;gap:8px;">';

          // ãƒ“ãƒ•ã‚©ãƒ¼ï¼ˆå·¦ï¼‰
          html += '<div class="photo-timing-group" style="flex:1;">';
          html += '<button class="photo-upload-btn" onclick="openPhotoUpload(\'' + spot.id + '\', \'ãƒ“ãƒ•ã‚©ãƒ¼\')" style="margin-bottom:4px;">' + (bDone ? 'âœ“ ãƒ“ãƒ•ã‚©ãƒ¼' : 'ãƒ“ãƒ•ã‚©ãƒ¼') + '</button>';
          html += '<div style="font-size:11px;color:#888;text-align:center;">(' + spotPhotos.before.length + 'æš)</div>';
          if (spotPhotos.before.length > 0) {
            html += '<div class="photo-grid" style="margin-top:6px;">';
            spotPhotos.before.forEach(function(photo) {
              html += '<div class="photo-thumb-wrapper"><div class="photo-thumb" style="position:absolute;top:0;left:0;right:0;bottom:0;background-image:url(https://drive.google.com/thumbnail?id=' + photo.fileId + '&sz=w200)"></div>';
              html += '<button class="photo-delete-btn" onclick="deletePhoto(\'' + spot.id + '\', \'' + photo.fileId + '\')">âœ•</button></div>';
            });
            html += '</div>';
          }
          html += '</div>';

          // ã‚¢ãƒ•ã‚¿ãƒ¼ï¼ˆå³ï¼‰
          html += '<div class="photo-timing-group" style="flex:1;">';
          html += '<button class="photo-upload-btn" style="background:#e67e22;margin-bottom:4px;" onclick="openPhotoUpload(\'' + spot.id + '\', \'ã‚¢ãƒ•ã‚¿ãƒ¼\')">' + (aDone ? 'âœ“ ã‚¢ãƒ•ã‚¿ãƒ¼' : 'ã‚¢ãƒ•ã‚¿ãƒ¼') + '</button>';
          html += '<div style="font-size:11px;color:#888;text-align:center;">(' + spotPhotos.after.length + 'æš)</div>';
          if (spotPhotos.after.length > 0) {
            html += '<div class="photo-grid" style="margin-top:6px;">';
            spotPhotos.after.forEach(function(photo) {
              html += '<div class="photo-thumb-wrapper"><div class="photo-thumb" style="position:absolute;top:0;left:0;right:0;bottom:0;background-image:url(https://drive.google.com/thumbnail?id=' + photo.fileId + '&sz=w200)"></div>';
              html += '<button class="photo-delete-btn" onclick="deletePhoto(\'' + spot.id + '\', \'' + photo.fileId + '\')">âœ•</button></div>';
            });
            html += '</div>';
          }
          html += '</div>';

          html += '</div>'; // end flex row

          html += '</div>';
        });
        html += '</div>';
      });

      document.getElementById('photoSection').innerHTML = html;
    }

    function renderMemos() {
      var memos = checklistData.memos;
      var html = '';
      memos.forEach(function(memo) {
        html += '<div class="memo-item">';
        html += escapeHtml(memo.text);
        html += '<div class="memo-meta">' + escapeHtml(memo.by) + ' - ' + formatDateTime(memo.at) + '</div>';
        html += '</div>';
      });
      document.getElementById('memoList').innerHTML = html;
    }

    // === è¦è£œå……ãƒªã‚¹ãƒˆ ===
    function renderSupplyList() {
      var supplyNeeded = checklistData.supplyNeeded;
      var keys = Object.keys(supplyNeeded);

      // ã‚¿ãƒ–ãƒãƒƒã‚¸æ›´æ–°
      var badge = document.getElementById('supplyBadge');
      if (keys.length > 0) {
        badge.textContent = keys.length;
        badge.classList.remove('hidden');
      } else {
        badge.classList.add('hidden');
      }

      // ã‚¿ãƒ–å†…ã‚³ãƒ³ãƒ†ãƒ³ãƒ„
      var el = document.getElementById('supplyListContent');
      if (keys.length === 0) {
        el.innerHTML = '<div class="supply-empty">è¦è£œå……ã®ã‚¢ã‚¤ãƒ†ãƒ ã¯ã‚ã‚Šã¾ã›ã‚“</div>';
        return;
      }

      var html = '<div class="supply-list-card"><h3>âš ï¸ è¦è£œå……ãƒªã‚¹ãƒˆ</h3>';
      keys.forEach(function(k) {
        var item = supplyNeeded[k];
        html += '<div class="supply-item">' + escapeHtml(item.name) + '</div>';
      });
      html += '</div>';
      el.innerHTML = html;
    }

    // === ã‚»ã‚¯ã‚·ãƒ§ãƒ³æ“ä½œ ===
    function toggleSection(header) {
      var section = header.parentElement;
      var body = section.querySelector('.section-body');
      header.classList.toggle('collapsed');
      body.classList.toggle('collapsed');
    }

    function toggleItem(checkbox) {
      var itemId = checkbox.getAttribute('data-item-id');
      var checked = checkbox.checked;
      var names = getSelectedStaffNames();
      var who = names.length > 0 ? names.join(', ') : staffName;

      showSaveStatus('saving');
      callGAS('toggleChecklistItem', [checkoutDate, itemId, checked, who]).then(function(res) {
        if (res.success) {
          showSaveStatus('saved');
          if (checked) {
            checklistData.checked[itemId] = { checked: true, by: who, at: new Date() };
          } else {
            delete checklistData.checked[itemId];
          }
          updateProgress();
          updateSectionCounts();
          updateCheckAllButton();
          if (missingCheckActive) highlightMissing();
        } else {
          showSaveStatus('error');
          checkbox.checked = !checked;
        }
      }).catch(function() { showSaveStatus('error'); });
    }

    function toggleSupply(checkbox) {
      var itemId = checkbox.getAttribute('data-item-id');
      var itemName = checkbox.getAttribute('data-item-name');
      var needed = checkbox.checked;
      var names = getSelectedStaffNames();
      var who = names.length > 0 ? names.join(', ') : staffName;

      showSaveStatus('saving');
      callGAS('toggleSupplyNeeded', [checkoutDate, itemId, itemName, needed, who]).then(function(res) {
        if (res.success) {
          showSaveStatus('saved');
          if (needed) {
            checklistData.supplyNeeded[itemId] = { name: itemName, by: who, at: new Date() };
          } else {
            delete checklistData.supplyNeeded[itemId];
          }
          renderSupplyList();
        } else {
          showSaveStatus('error');
          checkbox.checked = !needed;
        }
      }).catch(function() { showSaveStatus('error'); });
    }

    function updateProgress() {
      var total = checklistData.totalItems;
      var checked = Object.keys(checklistData.checked).length;
      var percent = total > 0 ? Math.round((checked / total) * 100) : 0;

      document.getElementById('progressFill').style.width = percent + '%';
      document.getElementById('btnComplete').disabled = checked < total;
    }

    function updateSectionCounts() {
      var sections = document.querySelectorAll('.section');
      sections.forEach(function(section) {
        var items = section.querySelectorAll('.item-checkbox');
        var checked = Array.from(items).filter(function(cb) { return cb.checked; }).length;
        var total = items.length;
        var count = section.querySelector('.section-count');
        if (count) {
          count.textContent = '(' + checked + '/' + total + ')';
        }
      });
    }

    function toggleMissingCheck() {
      missingCheckActive = !missingCheckActive;
      var btn = document.getElementById('btnCheckMissing');

      if (missingCheckActive) {
        btn.textContent = 'é€šå¸¸è¡¨ç¤º';
        btn.style.background = '#c0392b';
        highlightMissing();
      } else {
        btn.textContent = 'æ¼ã‚Œãƒã‚§ãƒƒã‚¯';
        btn.style.background = '#e67e22';
        clearMissingHighlight();
      }
    }

    function highlightMissing() {
      var items = document.querySelectorAll('.checklist-item');
      items.forEach(function(item) {
        var checkbox = item.querySelector('.item-checkbox');
        var nameEl = item.querySelector('.item-name');
        if (!checkbox.checked) {
          nameEl.classList.add('missing');
        } else {
          nameEl.classList.remove('missing');
        }
      });

      var sections = document.querySelectorAll('.section');
      sections.forEach(function(section) {
        var items = section.querySelectorAll('.item-checkbox');
        var hasMissing = Array.from(items).some(function(cb) { return !cb.checked; });
        var header = section.querySelector('.section-header');
        var title = section.querySelector('.section-title');

        if (hasMissing) {
          header.classList.add('has-missing');
          title.classList.add('missing');
        } else {
          header.classList.remove('has-missing');
          title.classList.remove('missing');
        }
      });

      var spots = document.querySelectorAll('.photo-spot');
      spots.forEach(function(spot) {
        var beforePhotos = spot.querySelectorAll('.photo-timing-group:nth-of-type(1) .photo-thumb');
        var afterPhotos = spot.querySelectorAll('.photo-timing-group:nth-of-type(2) .photo-thumb');
        var nameEl = spot.querySelector('.photo-spot-name');

        if (beforePhotos.length === 0 || afterPhotos.length === 0) {
          nameEl.classList.add('missing');
        } else {
          nameEl.classList.remove('missing');
        }
      });
    }

    function clearMissingHighlight() {
      document.querySelectorAll('.missing').forEach(function(el) {
        el.classList.remove('missing');
      });
      document.querySelectorAll('.has-missing').forEach(function(el) {
        el.classList.remove('has-missing');
      });
    }

    var currentPhotoSpotId = null;
    var currentPhotoTiming = null;

    function openPhotoUpload(spotId, timing) {
      currentPhotoSpotId = spotId;
      currentPhotoTiming = timing;
      document.getElementById('photoInput').click();
    }

    function handlePhotoUpload(event) {
      var file = event.target.files[0];
      if (!file) return;
      var names = getSelectedStaffNames();
      var who = names.length > 0 ? names.join(', ') : staffName;

      var reader = new FileReader();
      reader.onload = function(e) {
        var base64 = e.target.result.split(',')[1];
        showSaveStatus('saving');

        callGAS('uploadChecklistPhoto', [checkoutDate, currentPhotoSpotId, currentPhotoTiming, base64, who]).then(function(res) {
          if (res.success) {
            showSaveStatus('saved');
            if (!checklistData.photos[currentPhotoSpotId]) {
              checklistData.photos[currentPhotoSpotId] = { before: [], after: [] };
            }
            var photoData = { fileId: res.fileId, by: who, at: new Date() };
            if (currentPhotoTiming === 'ãƒ“ãƒ•ã‚©ãƒ¼') {
              checklistData.photos[currentPhotoSpotId].before.push(photoData);
            } else {
              checklistData.photos[currentPhotoSpotId].after.push(photoData);
            }
            renderPhotoSection();
            renderChecklist();
            if (missingCheckActive) highlightMissing();
          } else {
            showSaveStatus('error');
            alert('å†™çœŸã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + res.error);
          }
        }).catch(function() { showSaveStatus('error'); });
      };
      reader.readAsDataURL(file);
      event.target.value = '';
    }

    function addMemo() {
      var input = document.getElementById('memoInput');
      var text = input.value.trim();
      if (!text) return;
      var names = getSelectedStaffNames();
      var who = names.length > 0 ? names.join(', ') : staffName;

      callGAS('addChecklistMemo', [checkoutDate, text, who]).then(function(res) {
        if (res.success) {
          checklistData.memos.push({ text: text, by: who, at: new Date() });
          renderMemos();
          input.value = '';
        } else {
          alert('ãƒ¡ãƒ¢ã®è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + res.error);
        }
      });
    }

    // === å…¨ä½“æ“ä½œ ===
    var allExpanded = false;
    function toggleAllSections() {
      allExpanded = !allExpanded;
      var btn = document.getElementById('btnExpandAll');
      var headers = document.querySelectorAll('#checklistContainer .section-header');
      var bodies = document.querySelectorAll('#checklistContainer .section-body');
      if (allExpanded) {
        btn.textContent = 'å…¨ã¦æŠ˜ã‚ŠãŸãŸã¿';
        headers.forEach(function(h) { h.classList.remove('collapsed'); });
        bodies.forEach(function(b) { b.classList.remove('collapsed'); });
      } else {
        btn.textContent = 'å…¨ã¦å±•é–‹';
        headers.forEach(function(h) { h.classList.add('collapsed'); });
        bodies.forEach(function(b) { b.classList.add('collapsed'); });
      }
    }

    var allChecked = false;
    function checkAllItems() {
      var btn = document.getElementById('btnCheckAll');
      if (!allChecked) {
        // å…¨ãƒã‚§ãƒƒã‚¯
        var unchecked = document.querySelectorAll('.item-checkbox:not(:checked)');
        if (unchecked.length === 0) {
          // æ—¢ã«å…¨ãƒã‚§ãƒƒã‚¯æ¸ˆã¿ â†’ ãƒˆã‚°ãƒ«ã§ã‚¢ãƒ³ãƒã‚§ãƒƒã‚¯
          if (!confirm('å…¨ã¦ã®ãƒã‚§ãƒƒã‚¯ã‚’å¤–ã—ã¾ã™ã‹ï¼Ÿ')) return;
          uncheckAllItems();
          return;
        }
        if (!confirm('å…¨é …ç›®ï¼ˆ' + unchecked.length + 'ä»¶ï¼‰ã«ãƒã‚§ãƒƒã‚¯ã‚’å…¥ã‚Œã¾ã™ã‹ï¼Ÿ')) return;
        var names = getSelectedStaffNames();
        var who = names.length > 0 ? names.join(', ') : staffName;
        unchecked.forEach(function(cb) {
          cb.checked = true;
          var itemId = cb.getAttribute('data-item-id');
          callGAS('toggleChecklistItem', [checkoutDate, itemId, true, who]);
          checklistData.checked[itemId] = { checked: true, by: who, at: new Date() };
        });
        allChecked = true;
        btn.textContent = 'å…¨ãƒã‚§ãƒƒã‚¯è§£é™¤';
        btn.classList.add('is-all-checked');
      } else {
        if (!confirm('å…¨ã¦ã®ãƒã‚§ãƒƒã‚¯ã‚’å¤–ã—ã¾ã™ã‹ï¼Ÿ')) return;
        uncheckAllItems();
      }
      updateProgress();
      updateSectionCounts();
      if (missingCheckActive) highlightMissing();
    }

    function uncheckAllItems() {
      var checked = document.querySelectorAll('.item-checkbox:checked');
      var names = getSelectedStaffNames();
      var who = names.length > 0 ? names.join(', ') : staffName;
      checked.forEach(function(cb) {
        cb.checked = false;
        var itemId = cb.getAttribute('data-item-id');
        callGAS('toggleChecklistItem', [checkoutDate, itemId, false, who]);
        delete checklistData.checked[itemId];
      });
      allChecked = false;
      var btn = document.getElementById('btnCheckAll');
      btn.textContent = 'å…¨ãƒã‚§ãƒƒã‚¯';
      btn.classList.remove('is-all-checked');
      updateProgress();
      updateSectionCounts();
      if (missingCheckActive) highlightMissing();
    }

    function updateCheckAllButton() {
      var total = checklistData.items.length;
      var checkedCount = Object.keys(checklistData.checked).length;
      var btn = document.getElementById('btnCheckAll');
      if (checkedCount >= total) {
        allChecked = true;
        btn.textContent = 'å…¨ãƒã‚§ãƒƒã‚¯è§£é™¤';
        btn.classList.add('is-all-checked');
      } else {
        allChecked = false;
        btn.textContent = 'å…¨ãƒã‚§ãƒƒã‚¯';
        btn.classList.remove('is-all-checked');
      }
    }

    function checkCategory(btn) {
      var section = btn.closest('.section');
      if (!section) return;
      var checkboxes = section.querySelectorAll(':scope > .section-body > .checklist-item > .item-checkbox');
      // sub-sectionã®å ´åˆã¯ç›´æ¥å­è¦ç´ ã®ã¿å–å¾—
      if (checkboxes.length === 0) {
        checkboxes = section.querySelectorAll('.item-checkbox');
      }
      var unchecked = Array.from(checkboxes).filter(function(cb) { return !cb.checked; });
      var allDone = unchecked.length === 0;
      var names = getSelectedStaffNames();
      var who = names.length > 0 ? names.join(', ') : staffName;

      if (allDone) {
        // å…¨ãƒã‚§ãƒƒã‚¯æ¸ˆã¿ â†’ è§£é™¤
        Array.from(checkboxes).forEach(function(cb) {
          if (cb.checked) {
            cb.checked = false;
            var itemId = cb.getAttribute('data-item-id');
            callGAS('toggleChecklistItem', [checkoutDate, itemId, false, who]);
            delete checklistData.checked[itemId];
          }
        });
      } else {
        unchecked.forEach(function(cb) {
          cb.checked = true;
          var itemId = cb.getAttribute('data-item-id');
          callGAS('toggleChecklistItem', [checkoutDate, itemId, true, who]);
          checklistData.checked[itemId] = { checked: true, by: who, at: new Date() };
        });
      }
      updateProgress();
      updateSectionCounts();
      updateCheckAllButton();
      if (missingCheckActive) highlightMissing();
    }

    // === é …ç›®ç·¨é›†ãƒ»è¿½åŠ  ===
    function editItem(itemId, btn) {
      var nameEl = document.getElementById('itemName_' + itemId);
      if (!nameEl) return;
      var currentText = nameEl.textContent;
      var container = nameEl.parentElement;
      nameEl.style.display = 'none';
      var editDiv = document.createElement('div');
      editDiv.id = 'itemEdit_' + itemId;
      editDiv.innerHTML = '<input type="text" class="item-edit-input" value="' + escapeHtml(currentText) + '">' +
        '<div class="item-edit-actions">' +
        '<button class="item-edit-save" onclick="saveItemEdit(\'' + itemId + '\')">ä¿å­˜</button>' +
        '<button class="item-edit-cancel" onclick="cancelItemEdit(\'' + itemId + '\')">å–æ¶ˆ</button>' +
        '</div>';
      container.insertBefore(editDiv, nameEl.nextSibling);
      var input = editDiv.querySelector('input');
      input.focus();
      input.select();
      input.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') saveItemEdit(itemId);
        if (e.key === 'Escape') cancelItemEdit(itemId);
      });
    }

    function saveItemEdit(itemId) {
      var editDiv = document.getElementById('itemEdit_' + itemId);
      var nameEl = document.getElementById('itemName_' + itemId);
      if (!editDiv || !nameEl) return;
      var input = editDiv.querySelector('input');
      var newText = input.value.trim();
      if (!newText) { cancelItemEdit(itemId); return; }
      showSaveStatus('saving');
      callGAS('updateChecklistItemText', [itemId, newText]).then(function(res) {
        if (res.success) {
          showSaveStatus('saved');
          nameEl.textContent = newText;
          // ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚‚æ›´æ–°
          checklistData.items.forEach(function(item) {
            if (item.id === itemId) item.name = newText;
          });
        } else {
          showSaveStatus('error');
          alert('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (res.error || ''));
        }
        editDiv.remove();
        nameEl.style.display = '';
      }).catch(function() {
        showSaveStatus('error');
        editDiv.remove();
        nameEl.style.display = '';
      });
    }

    function cancelItemEdit(itemId) {
      var editDiv = document.getElementById('itemEdit_' + itemId);
      var nameEl = document.getElementById('itemName_' + itemId);
      if (editDiv) editDiv.remove();
      if (nameEl) nameEl.style.display = '';
    }

    function addItemPrompt(category) {
      var name = prompt('è¿½åŠ ã™ã‚‹é …ç›®åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:');
      if (!name || !name.trim()) return;
      showSaveStatus('saving');
      callGAS('addChecklistItemToMaster', [category, name.trim(), false]).then(function(res) {
        if (res.success) {
          showSaveStatus('saved');
          // ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆã‚’å†å–å¾—
          callGAS('getChecklistForDate', [checkoutDate]).then(function(clRes) {
            if (clRes.success) {
              checklistData = clRes;
              renderChecklist();
              renderPhotoSection();
              renderSupplyList();
              updateProgress();
              updateCheckAllButton();
            }
          });
        } else {
          showSaveStatus('error');
          alert('è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (res.error || ''));
        }
      }).catch(function() { showSaveStatus('error'); });
    }

    function addCategoryPrompt() {
      var category = prompt('è¿½åŠ ã™ã‚‹ã‚«ãƒ†ã‚´ãƒªåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:\nï¼ˆã‚µãƒ–ã‚«ãƒ†ã‚´ãƒªã®å ´åˆã¯ã€Œå¤§ã‚«ãƒ†ã‚´ãƒªï¼šã‚µãƒ–ã‚«ãƒ†ã‚´ãƒªã€å½¢å¼ï¼‰');
      if (!category || !category.trim()) return;
      var name = prompt('æœ€åˆã®é …ç›®åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:');
      if (!name || !name.trim()) return;
      showSaveStatus('saving');
      callGAS('addChecklistItemToMaster', [category.trim(), name.trim(), false]).then(function(res) {
        if (res.success) {
          showSaveStatus('saved');
          callGAS('getChecklistForDate', [checkoutDate]).then(function(clRes) {
            if (clRes.success) {
              checklistData = clRes;
              renderChecklist();
              renderPhotoSection();
              renderSupplyList();
              updateProgress();
              updateCheckAllButton();
            }
          });
        } else {
          showSaveStatus('error');
          alert('è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (res.error || ''));
        }
      }).catch(function() { showSaveStatus('error'); });
    }

    function addPhotoSpotPrompt(category) {
      var name = prompt('è¿½åŠ ã™ã‚‹æ’®å½±ç®‡æ‰€åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:');
      if (!name || !name.trim()) return;
      showSaveStatus('saving');
      callGAS('addPhotoSpotToMaster', [name.trim(), 'ãƒ“ãƒ•ã‚©ãƒ¼/ã‚¢ãƒ•ã‚¿ãƒ¼', category]).then(function(res) {
        if (res.success) {
          showSaveStatus('saved');
          callGAS('getChecklistForDate', [checkoutDate]).then(function(clRes) {
            if (clRes.success) {
              checklistData = clRes;
              renderChecklist();
              renderPhotoSection();
            }
          });
        } else {
          showSaveStatus('error');
          alert('è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (res.error || ''));
        }
      }).catch(function() { showSaveStatus('error'); });
    }

    // æ’®å½±ä¾‹ã®è¡¨ç¤º
    function showExample(fileId) {
      var overlay = document.createElement('div');
      overlay.className = 'photo-modal-overlay';
      overlay.onclick = function(e) { if (e.target === overlay) overlay.remove(); };
      var modal = document.createElement('div');
      modal.className = 'photo-modal';
      modal.innerHTML = '<h3>ğŸ“Œ æ’®å½±è¦‹æœ¬</h3>' +
        '<div style="text-align:center;"><img src="https://drive.google.com/thumbnail?id=' + fileId + '&sz=w800" style="max-width:100%;border-radius:8px;border:2px solid #e67e22;" onerror="this.src=\'\';this.alt=\'ç”»åƒã‚’èª­ã¿è¾¼ã‚ã¾ã›ã‚“\';"></div>' +
        '<button class="photo-modal-close" onclick="this.closest(\'.photo-modal-overlay\').remove();">é–‰ã˜ã‚‹</button>';
      overlay.appendChild(modal);
      document.body.appendChild(overlay);
    }

    // è¦‹æœ¬å†™çœŸã‚’è¡¨ç¤ºï¼ˆå‰Šé™¤ãƒ»å¤‰æ›´ã‚ªãƒ—ã‚·ãƒ§ãƒ³ä»˜ãï¼‰
    function showExampleWithOptions(spotId, fileId) {
      var overlay = document.createElement('div');
      overlay.className = 'photo-modal-overlay';
      overlay.onclick = function(e) { if (e.target === overlay) overlay.remove(); };
      var modal = document.createElement('div');
      modal.className = 'photo-modal';
      modal.innerHTML = '<h3>ğŸ“Œ æ’®å½±è¦‹æœ¬</h3>' +
        '<div style="text-align:center;"><img src="https://drive.google.com/thumbnail?id=' + fileId + '&sz=w800" style="max-width:100%;border-radius:8px;border:2px solid #e67e22;" onerror="this.src=\'\';this.alt=\'ç”»åƒã‚’èª­ã¿è¾¼ã‚ã¾ã›ã‚“\';"></div>' +
        '<div style="display:flex;gap:8px;margin-top:12px;">' +
        '<button class="photo-modal-close" style="flex:1;background:#e67e22;color:white;border-color:#e67e22;" onclick="this.closest(\'.photo-modal-overlay\').remove();uploadExamplePrompt(\'' + spotId + '\')">å¤‰æ›´</button>' +
        '<button class="photo-modal-close" style="flex:1;background:#e74c3c;color:white;border-color:#e74c3c;" onclick="this.closest(\'.photo-modal-overlay\').remove();deleteExample(\'' + spotId + '\')">å‰Šé™¤</button>' +
        '</div>' +
        '<button class="photo-modal-close" onclick="this.closest(\'.photo-modal-overlay\').remove();">é–‰ã˜ã‚‹</button>';
      overlay.appendChild(modal);
      document.body.appendChild(overlay);
    }

    // è¦‹æœ¬å†™çœŸã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
    var currentExampleSpotId = null;
    function uploadExamplePrompt(spotId) {
      currentExampleSpotId = spotId;
      document.getElementById('examplePhotoInput').click();
    }

    document.addEventListener('DOMContentLoaded', function() {
      var exInput = document.getElementById('examplePhotoInput');
      if (exInput) {
        exInput.addEventListener('change', function(event) {
          var file = event.target.files[0];
          if (!file || !currentExampleSpotId) return;
          var reader = new FileReader();
          reader.onload = function(e) {
            var base64 = e.target.result.split(',')[1];
            showSaveStatus('saving');
            callGAS('uploadExamplePhoto', [currentExampleSpotId, base64]).then(function(res) {
              if (res.success) {
                showSaveStatus('saved');
                // ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿æ›´æ–°
                checklistData.spots.forEach(function(s) {
                  if (s.id === currentExampleSpotId) s.exampleFileId = res.fileId;
                });
                renderChecklist();
                renderPhotoSection();
              } else {
                showSaveStatus('error');
                alert('ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (res.error || ''));
              }
            }).catch(function() { showSaveStatus('error'); });
          };
          reader.readAsDataURL(file);
          event.target.value = '';
        });
      }
    });

    // è¦‹æœ¬å†™çœŸã®å‰Šé™¤
    function deleteExample(spotId) {
      if (!confirm('è¦‹æœ¬å†™çœŸã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
      showSaveStatus('saving');
      callGAS('deleteExamplePhoto', [spotId]).then(function(res) {
        if (res.success) {
          showSaveStatus('saved');
          checklistData.spots.forEach(function(s) {
            if (s.id === spotId) s.exampleFileId = '';
          });
          renderChecklist();
          renderPhotoSection();
        } else {
          showSaveStatus('error');
          alert('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (res.error || ''));
        }
      }).catch(function() { showSaveStatus('error'); });
    }

    // æ’®å½±ç®‡æ‰€ã®åç§°å¤‰æ›´
    function editSpotName(spotId) {
      var currentName = '';
      checklistData.spots.forEach(function(s) { if (s.id === spotId) currentName = s.name; });
      var newName = prompt('æ–°ã—ã„åç§°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:', currentName);
      if (!newName || !newName.trim() || newName.trim() === currentName) return;
      showSaveStatus('saving');
      callGAS('updatePhotoSpotName', [spotId, newName.trim()]).then(function(res) {
        if (res.success) {
          showSaveStatus('saved');
          checklistData.spots.forEach(function(s) {
            if (s.id === spotId) s.name = newName.trim();
          });
          renderChecklist();
          renderPhotoSection();
        } else {
          showSaveStatus('error');
          alert('å¤‰æ›´ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (res.error || ''));
        }
      }).catch(function() { showSaveStatus('error'); });
    }

    // æ’®å½±ç®‡æ‰€ã®å‰Šé™¤
    function deleteSpot(spotId, spotName) {
      if (!confirm('æ’®å½±ç®‡æ‰€ã€Œ' + spotName + 'ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
      showSaveStatus('saving');
      callGAS('deletePhotoSpot', [spotId]).then(function(res) {
        if (res.success) {
          showSaveStatus('saved');
          checklistData.spots = checklistData.spots.filter(function(s) { return s.id !== spotId; });
          renderChecklist();
          renderPhotoSection();
        } else {
          showSaveStatus('error');
          alert('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (res.error || ''));
        }
      }).catch(function() { showSaveStatus('error'); });
    }

    // æ’®å½±å†™çœŸã®å‰Šé™¤
    function deletePhoto(spotId, fileId) {
      if (!confirm('ã“ã®å†™çœŸã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
      showSaveStatus('saving');
      callGAS('deleteChecklistPhoto', [checkoutDate, spotId, fileId]).then(function(res) {
        if (res.success) {
          showSaveStatus('saved');
          var sp = checklistData.photos[spotId];
          if (sp) {
            sp.before = sp.before.filter(function(p) { return p.fileId !== fileId; });
            sp.after = sp.after.filter(function(p) { return p.fileId !== fileId; });
          }
          renderChecklist();
          renderPhotoSection();
        } else {
          showSaveStatus('error');
          alert('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (res.error || ''));
        }
      }).catch(function() { showSaveStatus('error'); });
    }

    function completeChecklist() {
      var names = getSelectedStaffNames();
      var who = names.length > 0 ? names.join(', ') : staffName;
      if (!confirm('æ¸…æƒã‚’å®Œäº†ã—ã¦ã‚ªãƒ¼ãƒŠãƒ¼ã«é€šçŸ¥ã—ã¾ã™ã‹ï¼Ÿ')) return;

      callGAS('notifyCleaningComplete', [checkoutDate, who]).then(function(res) {
        if (res.success) {
          alert('æ¸…æƒå®Œäº†é€šçŸ¥ã‚’é€ä¿¡ã—ã¾ã—ãŸï¼ãŠç–²ã‚Œæ§˜ã§ã—ãŸï¼');
        } else {
          alert('é€šçŸ¥ã®é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + res.error);
        }
      });
    }

    // === ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ===
    function callGAS(functionName, args) {
      return new Promise(function(resolve, reject) {
        google.script.run
          .withSuccessHandler(function(jsonStr) {
            try {
              resolve(JSON.parse(jsonStr));
            } catch (e) {
              reject(e);
            }
          })
          .withFailureHandler(reject)
          [functionName].apply(null, args);
      });
    }

    function escapeHtml(text) {
      var div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function formatDateTime(dateStr) {
      if (!dateStr) return '';
      var d = new Date(dateStr);
      return d.getMonth() + 1 + '/' + d.getDate() + ' ' +
             String(d.getHours()).padStart(2, '0') + ':' +
             String(d.getMinutes()).padStart(2, '0');
    }
  </script>
</body>
</html>
