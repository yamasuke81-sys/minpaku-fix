# セッション引き継ぎファイル

> **最終更新**: 2026-02-17
> **作業ブランチ**: `claude/update-handoff-docs-897D8`
> **最新コミット**: `00e40bb docs: 引き継ぎルールを強化（質問→返答待ち→作業開始、ルール引き継ぎ必須化）`

---

## 必須ルール（全セッション共通・厳守）

### ルール1: 変更プッシュ後は毎回デプロイ手順を表示すること

コードを変更してプッシュしたら、**必ず毎回**以下のデプロイコマンドを表示する。
ブランチ名は、**現在の作業ブランチに合わせて随時書き換えること**。
チェックアプリ（`checklist-app/`）に変更がある場合も `deploy-all.js` で両方デプロイされるので同じコマンドでOK。

```
cd C:\Users\yamas\minpaku-fix && git fetch origin && git checkout -f <現在の作業ブランチ名> && git reset --hard origin/<現在の作業ブランチ名> && node deploy-all.js
```

**現時点のコマンド:**
```
cd C:\Users\yamas\minpaku-fix && git fetch origin && git checkout -f claude/update-handoff-docs-897D8 && git reset --hard origin/claude/update-handoff-docs-897D8 && node deploy-all.js
```

### ルール2: 会話の圧縮が必要になったら新チャットへ移行を提案すること

会話の内容を圧縮する必要が出てきた場合（コンテキストが長くなりすぎた場合）、**引き継ぎ資料を作成して新チャットへの移行を提案すること**。
移行時には以下を実行：
1. `SESSION_HANDOFF.md` を最新状態に更新（完了作業・未完了事項・コミット履歴）
2. `HANDOFF.md` も必要に応じて更新
3. コミット＆プッシュ
4. **このルールセクション（「必須ルール」全体）を新チャットの引き継ぎ資料にも必ず含めること**

### ルール3: 常に日本語で応答すること

### ルール4: 新チャット移行時にこの必須ルールを必ず引き継ぐこと

新チャットへ移行する際、`SESSION_HANDOFF.md` の **「必須ルール」セクション全体**（ルール1〜6すべて）を必ず含めること。ルールの欠落は厳禁。

### ルール5: 新チャットは引き継ぎ確認→質問→回答待ち→作業開始の順を守ること

新チャットは以下の手順を**必ず守ること**：
1. 引き継ぎ資料（`SESSION_HANDOFF.md` + `HANDOFF.md`）を読んで内容を確認する
2. 前のチャットへの質問事項があれば、**ユーザーが一括コピペできるプロンプト**を作成する
3. **ユーザーからの返答を待ってから**次の作業にとりかかること（質問がなければすぐ開始してOK）

### ルール6: 引き継ぎ資料作成時に以下の5項目を必ず含めること

チャット移行時に `SESSION_HANDOFF.md` / `HANDOFF.md` を更新する際、**以下の5項目は必須**とする。省略厳禁。

1. **現在取り組んでいるタスク・機能の説明** — 今何をやっているか、どこまで進んだか
2. **完了した作業と未完了の作業** — 完了済み一覧＋未完了タスクの具体的なリスト
3. **既知のバグや注意点** — デプロイ後に確認が必要な問題、ハマりポイント
4. **次のセッションでやるべきこと** — 優先度付きのTODOリスト
5. **コードの変更箇所のサマリー** — どのファイルのどの部分を変更したか（コミットハッシュ付き）

---

## チャット移行の手順

### 旧チャット側（移行前）がやること

1. 作業中のコードをすべてコミット＆プッシュ
2. `SESSION_HANDOFF.md` を以下の内容で更新：
   - **「必須ルール」セクション全体**（ルール1〜6）← 絶対に省略しない
   - **ルール6の必須5項目を必ず含めること**:
     1. 現在取り組んでいるタスク・機能の説明
     2. 完了した作業と未完了の作業
     3. 既知のバグや注意点
     4. 次のセッションでやるべきこと
     5. コードの変更箇所のサマリー（どのファイルのどの部分を変更したか）
   - 最新コミットハッシュとブランチ名
3. `HANDOFF.md` のコミット履歴・完了作業セクションを最新化
4. 更新をコミット＆プッシュ

### 新チャット側がやること

**ステップ1: 引き継ぎ資料を読む**
```
SESSION_HANDOFF.md を読んでください
HANDOFF.md を読んでください
```

**ステップ2: ブランチとコードの状態を確認**
```
git fetch origin <作業ブランチ>
git log origin/<作業ブランチ> --oneline -10
```

**ステップ3: 疑問点を洗い出し、前のチャットへの質問プロンプトを作成（重要）**

引き継ぎ資料を読んだ後、不明点や確認事項があれば、以下のような形式で **前のチャットに貼り付けるための質問プロンプト** を作成する。
**ユーザーがそのままコピペできる形式**にすること：

```
前のチャットで以下を確認してください：

1. 「〇〇の実装」について、△△の部分はこの理解で合っていますか？
2. □□の機能は完了していますか？テスト済みですか？
3. ××のエラーが出ていましたが、解決済みですか？
4. この部分を変更しても他に影響はありませんか？
```

ユーザーはこのプロンプトをコピーして前のチャットに貼り付け、回答を得てから新チャットに戻る。

**ステップ4: ユーザーの返答を待つ**

質問プロンプトを出した場合は、**ユーザーからの返答を待ってから**開発を開始する。
質問がない場合はその旨を伝え、すぐに開発を開始してOK。

---

## 必須デプロイコマンド（ユーザーのWindows PCで実行）

```
cd C:\Users\yamas\minpaku-fix && git fetch origin && git checkout -f claude/update-handoff-docs-897D8 && git reset --hard origin/claude/update-handoff-docs-897D8 && node deploy-all.js
```

---

## 今回のセッションで完了した作業

### チェックリストアプリ — 大規模機能追加

#### 1. スタッフ選択の複数端末同期（重要）
- **機能**: 複数スマホから同時にスタッフ選択が可能。各端末の選択をマージしてGASに保存
- **問題→修正**: 「粘着ユニオン問題」— 端末Aで外したスタッフが端末Bの同期で復活する
  - **修正**: `getStaffSelectionDetailed_()` で端末ごとの選択状態をGAS側で保持。`deviceId`パラメータでローカル→リモート分離
  - `remoteStaffInfo` 要素で「他の端末で〇〇さんが選択済み」を表示
- **コミット**: 56c8a9a, 54fc0bd, f9e50f5, 4308e4c

#### 2. メモ機能の全面改修
- メモを「登録」ボタン方式に変更（自動保存を廃止）
- メモ削除機能を追加
- メモに写真添付機能を追加（メモ写真フォルダはDriveに自動作成）
- **コミット**: f76b93b, 2e359df

#### 3. 要補充リストのバグ修正（5段階の修正）
- 要補充チェック解除が復活するバグを楽観的更新で修正
- 要補充リストのカテゴリ表示をフルパスに修正
- カテゴリ表示のアイテムIDずれ問題を修正
- 要補充記録にカテゴリを保存し重複行の復活バグを修正
- 要補充アイテムの復活問題を3方向から最終修正
- **コミット**: c0341b6, 13ec221, fca1ae7, 836d7b9, f80fa45

#### 4. カテゴリ移動機能
- 中カテゴリを大カテゴリ（ルートレベル）に昇格できる機能を追加
- **コミット**: 6497c56

#### 5. 古いデータの自動クリーンアップ
- 設定タブの「保管期間」に基づいて古い写真・チェック記録・メモを自動削除
- **コミット**: fa63079

#### 6. 仕事内容タブUI改善
- 折りたたみ見出し＋インライン金額入力に変更
- **コミット**: 9d5a184

#### 7. 写真保管期間設定UI追加 & コインランドリー位置変更
- 設定タブに写真保管期間の設定UIを追加
- コインランドリーの位置をカテゴリ内で変更
- **コミット**: 3cb4775

#### 8. チェックリスト多機能強化
- チェック解除(uncheck)処理をdeleteRowからバッチ方式に変更（パフォーマンス改善）
- 撮影タブのカテゴリ順をチェックリストタブに合わせる
- **コミット**: 1749c45, 23a8948, fc73fd4

#### 9. 清掃完了日時の表示フォーマット修正
- **コミット**: 2568864

#### 10. チェックリスト設定タブにメモ写真フォルダの設定を追加
- **コミット**: 648659c

### メインアプリ (index.html)

#### 11. 清掃担当UIの改善
- 「清掃担当を編集」ボタンを清掃担当ラベル直下に配置
- クリーニング状況の見出しをスタッフ確定済みと同じバナー形式に変更
- **コミット**: b5fc594, bbace51, 63915fc, 12aa4a0

#### 12. スタッフ選択済み日付でドロップダウンが消えるバグ修正
- **コミット**: e15f4e9

#### 13. スタッフ入力欄のつぶれ対策
- インラインスタイル追加（CSS破損対策）
- **コミット**: 6ed4ee5, 861c78d

#### 14. オーナー専用編集制限 → 撤廃
- チェックリストの編集機能をオーナー専用に制限する機能を追加したが、不具合多発のためrevert
- **コミット**: 6f16931 → 86929f5 (revert)

### デプロイ・インフラ

#### 15. deploy-all.js の改善
- デプロイID1つ前提にシンプル化
- スタッフURL自動反映のHTTPリクエストを廃止
- チェックリストアプリのバージョンを明示作成
- **コミット**: f9c327e, b4d31bd, c3c5084

#### 16. スタッフ用URL改善
- スタッフ用URLをオーナー用URL+?staff=1から自動生成
- シークレットウィンドウ/Brave対応
- **コミット**: 91244fe, c995604, d96d760

#### 17. スタッフ操作マニュアル生成ツール
- Puppeteerによるスクリーンショット自動撮影＋HTMLマニュアル生成
- `manual-generator/` ディレクトリに一式配置
- `generate-staff-manual.bat` でワンクリック実行
- **コミット**: d3f269d, 0c9a4d1, c4021ca, bf29ab4, 51ffef8 他

#### 18. GAS CSSサニタイザー対策
- bodyセレクタを`#contentArea`に変更
- **コミット**: 8c5285b

---

## 未完了・要確認事項

### 要テスト（デプロイ後）

1. **スタッフ選択の複数端末同期**
   - 端末A/Bで別々にスタッフ選択→マージが正しく動作するか
   - 「粘着ユニオン問題」が解消されているか（端末Aで外したスタッフが復活しないか）
   - `getStaffSelectionDetailed_()` のdeviceId別管理が正しく動くか

2. **清掃ステータスマーク修正の実機テスト**
   - 特に「スタッフ一覧にない名前を手入力」→「スタッフ確定」のフロー
   - カレンダーのドットが即座に赤→緑に変わるか

3. **要補充リストの動作確認**
   - チェック解除→復活しないか
   - カテゴリ表示が正しいか

### 未解決の既存問題

4. **2/23 日付の黄色背景問題** - スプレッドシートのデータ問題の可能性

### 将来の課題
- 条件分岐対応（BBQ利用あり/なし、宿泊人数による表示切替）
- 在庫管理リスト機能
- リネン洗濯フロー管理

---

## 主要ファイル構成

| ファイル | 行数（概算） | 役割 |
|----------|-------------|------|
| `Code.gs` | ~6927行 | メインアプリ（予約管理）サーバー |
| `index.html` | ~6537行 | メインアプリ フロントエンド |
| `checklist-app/Code.gs` | ~2888行 | チェックリストアプリ サーバー |
| `checklist-app/checklist.html` | ~4718行 | チェックリストアプリ フロントエンド |
| `deploy-all.js` | ~340行 | 一括デプロイスクリプト |
| `staff-manual.html` | ~884行 | スタッフ操作マニュアル |
| `HANDOFF.md` | ~500行 | プロジェクト全体の技術資料 |

---

## 技術的な注意点

### スタッフ選択の複数端末同期（最重要）
```
データフロー:
1. 端末がページ読込 → getChecklistForDate(date, deviceId) で自分の選択を取得
2. スタッフ選択/解除 → applyStaffSelection() でローカル反映 + GASにsave
3. GAS側 getStaffSelectionDetailed_() で全端末の選択をマージ
4. 60秒ポーリングで他端末の選択も反映（remoteStaffInfo表示）

粘着ユニオン問題の修正:
- 旧: 全端末の選択をunionして返す → 一度選んだスタッフが外せない
- 新: deviceId別に選択状態を管理 → 各端末の解除が正しく反映される
```

### 清掃ステータスマークの仕組み
```
カレンダーのステータスドット色:
- 赤(recruiting): 募集中で未確定
- 緑(decided): スタッフ確定済み or 選定済 or cleaningStaff設定済み

データフロー:
1. loadAndRender() → getRecruitmentStatusMap() → window._recruitFullMap
2. buildCalendarEvents() で recruitMap[b.rowNumber].status をチェック
3. 確定時に applyConfirmOptimistic() で楽観的にキャッシュ更新＋カレンダー再描画
```

### カテゴリの区切り文字
- 全角コロン `：`（U+FF1A）を使用
- 例: `テラス：次の予約がBBQ利用あり：↓セット内容↓`

### レンダリングの仕組み
- `buildCategoryTree()` が全アイテムをツリー構造に変換
- `renderCategoryNode()` が再帰的にHTMLを生成
- レベル0=`.section`（濃紺）、1=`.sub-section`（薄青）、2=`.sub-sub-section`（オレンジ）、3=`.sub-sub-sub-section`（紫）
